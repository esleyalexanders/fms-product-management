<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Quote - FMS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<body class="min-h-screen bg-gray-50">
    
    <div class="p-4">
        <div class="max-w-7xl mx-auto">
            
            <!-- Header -->
            <div class="bg-white rounded-lg shadow-sm p-4 mb-4">
                <div class="flex justify-between items-center">
                    <div>
                        <div class="flex items-center gap-3 mb-1">
                            <h1 class="text-2xl font-bold text-gray-900">Edit Quote</h1>
                            <span id="quoteIdBadge" class="px-3 py-1 bg-gray-100 text-gray-700 rounded-lg text-sm font-medium">Q-2024-001</span>
                        </div>
                        <div class="flex items-center gap-3">
                            <p class="text-gray-600 font-medium">Sunshine Tutoring - Melbourne East</p>
                            <span class="text-xs text-gray-500">• Created: Oct 20, 2024</span>
                            <span class="text-xs text-blue-600 bg-blue-50 px-2 py-0.5 rounded">⏳ Waiting for Approval</span>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button 
                            onclick="window.location.href='quote_list.html'"
                            class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 flex items-center gap-2"
                        >
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                            </svg>
                            Back to Quotes
                        </button>
                        <button 
                            id="saveChangesBtn"
                            class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50"
                        >
                            Save Changes
                        </button>
                        <button 
                            id="previewBtn"
                            class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center gap-2"
                        >
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            Preview
                        </button>
                    </div>
                </div>
            </div>

            <!-- Changes Alert (shown when there are unsaved changes) -->
            <div id="unsavedChangesAlert" class="hidden bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-4 rounded">
                <div class="flex items-center gap-3">
                    <svg class="w-5 h-5 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                    </svg>
                    <div class="flex-1">
                        <p class="text-sm font-medium text-yellow-800">You have unsaved changes</p>
                        <p class="text-xs text-yellow-700 mt-1">Don't forget to save your changes before leaving</p>
                    </div>
                    <button id="dismissAlertBtn" class="text-yellow-600 hover:text-yellow-800 text-sm">Dismiss</button>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                
                <!-- Left Column - Customer & Services -->
                <div class="lg:col-span-2 space-y-4">
                    
                    <!-- Customer Section -->
                    <div class="bg-white rounded-lg shadow-sm p-4">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-lg font-semibold text-gray-900">Customer Information</h2>
                        </div>

                        <!-- Selected Customer -->
                        <div id="selectedCustomerCard" class="border border-gray-200 rounded-lg p-3 bg-blue-50">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="font-semibold text-gray-900" id="selectedCustomerName">Sarah Johnson</p>
                                    <p class="text-sm text-gray-600 mt-1" id="selectedCustomerEmail">sarah.j@email.com</p>
                                    <p class="text-sm text-gray-600" id="selectedCustomerPhone">0412 345 678</p>
                                    <p class="text-sm text-gray-600" id="selectedCustomerAddress">123 Main St, Melbourne</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Services Catalog -->
                    <div class="bg-white rounded-lg shadow-sm p-4">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-lg font-semibold text-gray-900">Services & Products Catalog</h2>
                            <div class="text-sm text-gray-500">
                                Showing <span id="servicesCount">0</span> items
                            </div>
                        </div>
                        
                        <!-- Search and Filter -->
                        <div class="flex items-center gap-3 mb-4">
                            <div class="flex-1 relative">
                                <svg class="absolute left-3 top-3 text-gray-400 w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                </svg>
                                <input 
                                    type="text" 
                                    id="catalogSearchInput"
                                    placeholder="Search by name, code, or tag..."
                                    class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"
                                />
                            </div>
                            <select 
                                id="catalogFilterType"
                                class="px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                            >
                                <option value="">All types</option>
                                <option value="service">Service</option>
                                <option value="product">Product</option>
                            </select>
                            <select 
                                id="catalogFilterTag"
                                class="px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                            >
                                <option value="">All tags</option>
                            </select>
                        </div>
                        
                        <div id="emptyCatalog" class="hidden text-center py-12 text-gray-400">
                            <svg class="mx-auto mb-3 text-gray-300 w-12 h-12" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                            <p class="text-sm">No items found. Try adjusting your filters.</p>
                        </div>
                        
                        <div id="servicesCatalog" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 max-h-96 overflow-y-auto custom-scrollbar">
                            <!-- Services cards will be populated here -->
                        </div>
                    </div>

                    <!-- Quote Items Table -->
                    <div class="bg-white rounded-lg shadow-sm p-4">
                        <h2 class="text-lg font-semibold text-gray-900 mb-4">Quote Line Items</h2>
                        
                        <div id="emptyQuoteState" class="hidden text-center py-8 text-gray-500">
                            <svg class="mx-auto mb-2 text-gray-400 w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                            </svg>
                            <p class="text-sm">No items added yet. Select services from the catalog above.</p>
                        </div>

                        <div id="quoteItemsTable" class="hidden overflow-x-auto">
                            <table class="w-full text-sm">
                                <thead class="bg-gray-50 border-b border-gray-200">
                                    <tr>
                                        <th class="text-left p-2 font-medium text-gray-700">Service/Product</th>
                                        <th class="text-left p-2 font-medium text-gray-700">Type</th>
                                        <th class="text-center p-2 font-medium text-gray-700">Qty</th>
                                        <th class="text-right p-2 font-medium text-gray-700">Unit Price</th>
                                        <th class="text-right p-2 font-medium text-gray-700">Total</th>
                                        <th class="w-10"></th>
                                    </tr>
                                </thead>
                                <tbody id="quoteItemsBody">
                                    <!-- Quote items will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Right Column - Summary & Actions -->
                <div class="space-y-4">
                    
                    <!-- Pricing Summary -->
                    <div class="bg-white rounded-lg shadow-sm p-4 sticky top-4">
                        <h2 class="text-lg font-semibold text-gray-900 mb-4">Quote Summary</h2>
                        
                        <div class="space-y-3 mb-4">
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-600">Subtotal</span>
                                <span class="font-medium" id="subtotalAmount">$270.00</span>
                            </div>

                            <div class="border-t border-gray-200 pt-3">
                                <div class="flex justify-between items-center mb-2">
                                    <span class="text-sm text-gray-600">Discount</span>
                                    <div class="flex items-center gap-2">
                                        <select 
                                            id="discountType"
                                            class="px-2 py-1 border border-gray-300 rounded text-xs"
                                        >
                                            <option value="percentage">%</option>
                                            <option value="fixed">$</option>
                                        </select>
                                        <input 
                                            type="number"
                                            id="discountValue"
                                            value="0"
                                            class="w-20 px-2 py-1 border border-gray-300 rounded text-sm text-right"
                                            min="0"
                                            step="1"
                                        />
                                    </div>
                                </div>
                                <div class="flex justify-end">
                                    <span class="text-sm font-medium text-red-600" id="discountAmount">-$0.00</span>
                                </div>
                            </div>

                            <div class="border-t border-gray-200 pt-3">
                                <div class="text-xs text-gray-600 mb-2">Tax Breakdown:</div>
                                <div id="taxBreakdown" class="space-y-1 text-xs">
                                    <div class="flex justify-between"><span>GST (10%):</span><span>$27.00</span></div>
                                </div>
                                <div class="flex justify-between items-center mt-2 pt-2 border-t border-gray-100">
                                    <span class="text-sm text-gray-600">Total Tax</span>
                                    <span class="text-sm font-medium" id="taxAmount">$27.00</span>
                                </div>
                            </div>

                            <div class="border-t-2 border-gray-300 pt-3">
                                <div class="flex justify-between">
                                    <span class="font-bold text-gray-900 text-lg">Total</span>
                                    <span class="font-bold text-gray-900 text-lg" id="totalAmount">$297.00</span>
                                </div>
                            </div>
                        </div>

                        <!-- Quote Details -->
                        <div class="border-t border-gray-200 pt-4 space-y-3">
                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-1">Valid Until</label>
                                <input 
                                    type="date" 
                                    id="validUntilDate"
                                    value="2024-11-03"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                                />
                            </div>

                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-1">Notes for Customer</label>
                                <textarea 
                                    id="customerNotes"
                                    rows="3"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    placeholder="Terms, conditions, or special notes..."
                                >Thank you for your interest in our services.</textarea>
                            </div>

                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-1">Internal Notes</label>
                                <textarea 
                                    id="internalNotes"
                                    rows="2"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    placeholder="Private notes (not visible to customer)..."
                                >Customer requested follow-up within 24 hours</textarea>
                            </div>
                        </div>

                        <!-- Send Options -->
                        <div class="border-t border-gray-200 pt-4 mt-4">
                            <label class="block text-xs font-medium text-gray-700 mb-2">Send Method (multiple selection)</label>
                            <div class="space-y-2">
                                <label class="flex items-center gap-2 text-sm">
                                    <input type="checkbox" name="sendMethod" value="email" />
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                                    </svg>
                                    <span>Email</span>
                                </label>
                                <label class="flex items-center gap-2 text-sm">
                                    <input type="checkbox" name="sendMethod" value="sms" />
                                    <span>Whatsapp with Portal Link</span>
                                </label>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="mt-4 space-y-2">
                            <div class="grid grid-cols-2 gap-2">
                                <button 
                                    id="printQuoteBtn"
                                    class="bg-gray-600 text-white py-2 rounded-lg hover:bg-gray-700 text-sm font-medium flex items-center justify-center gap-2"
                                >
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path>
                                    </svg>
                                    Print/Manual
                                </button>
                                <button 
                                    id="sendUpdatedQuoteBtn"
                                    class="bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 text-sm font-medium flex items-center justify-center gap-2"
                                >
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                                    </svg>
                                    Send Updated Quote
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Price Modification Modal -->
    <div id="priceModModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
            <div class="p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-900">Modify Price</h3>
                    <button id="closePriceModModal" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                
                <div class="mb-4">
                    <div class="flex items-center gap-2 mb-2">
                        <p class="text-sm font-medium text-gray-900" id="priceModItemName"></p>
                        <span id="priceModItemType"></span>
                    </div>
                    <div class="flex items-center gap-2 text-sm">
                        <span class="text-gray-600">Original Price:</span>
                        <span class="font-medium" id="priceModOriginal"></span>
                    </div>
                    <div class="flex items-center gap-2 text-sm mt-1">
                        <span class="text-gray-600">New Price:</span>
                        <span class="font-semibold text-blue-600" id="priceModNew"></span>
                    </div>
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Reason for modification <span class="text-red-600">*</span></label>
                    <textarea 
                        id="priceModComment"
                        rows="3"
                        placeholder="Enter reason for price modification (required for approval)"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                    ></textarea>
                </div>
                
                <div class="flex gap-3">
                    <button id="cancelPriceModBtn" class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 text-sm font-medium">
                        Cancel
                    </button>
                    <button id="savePriceModBtn" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm font-medium">
                        Save Changes
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Quote Preview Modal (PDF-like) -->
    <div id="previewModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto custom-scrollbar">
            <div class="p-6">
                <div class="flex items-center justify-between mb-4 sticky top-0 bg-white pb-4 border-b">
                    <h3 class="text-lg font-semibold text-gray-900">Quote Preview</h3>
                    <div class="flex gap-2">
                        <button id="downloadPreviewBtn" class="px-3 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 text-sm flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                            </svg>
                            Download PDF
                        </button>
                        <button id="closePreviewBtn" class="px-3 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 text-sm">
                            Close
                        </button>
                    </div>
                </div>
                
                <div id="previewContent" class="bg-white p-8" style="font-family: 'Helvetica', 'Arial', sans-serif;">
                    <!-- PDF-like content will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // State management - pre-populated with existing quote data
        const state = {
            businessType: 'tutoring',
            selectedCustomer: {
                id: 1,
                name: 'Sarah Johnson',
                email: 'sarah.j@email.com',
                phone: '0412 345 678',
                address: '123 Main St, Melbourne'
            },
            showNewCustomerForm: false,
            quoteItems: [
                { id: 't1', name: 'One-on-One Tutoring - Math', tag: 'Tutoring', type: 'service', price: 75, customPrice: 75, originalPrice: 75, pricingType: 'per_hour', unit: 'hour', taxCategory: 'taxable_gst', quantity: 2, priceModified: false, priceModificationComment: '', notes: '' },
                { id: 't4', name: 'Assessment & Report', tag: 'Assessment', type: 'service', price: 120, customPrice: 120, originalPrice: 120, pricingType: 'fixed', unit: 'each', taxCategory: 'taxable_gst', quantity: 1, priceModified: false, priceModificationComment: '', notes: '' }
            ],
            discount: 0,
            discountType: 'percentage',
            approvalRequired: false,
            hasUnsavedChanges: false,
            currentPriceModIndex: null,
            currentPriceModNewValue: null
        };

        // Sample data
        const tutoringServices = [
            // Services with GST (10% tax)
            { id: 't1', name: 'One-on-One Tutoring - Math', tag: 'Tutoring', type: 'service', price: 75, pricingType: 'per_hour', unit: 'hour', taxCategory: 'taxable_gst' },
            { id: 't2', name: 'One-on-One Tutoring - English', tag: 'Tutoring', type: 'service', price: 75, pricingType: 'per_hour', unit: 'hour', taxCategory: 'taxable_gst' },
            { id: 't3', name: 'Small Group (2-4 students)', tag: 'Group', type: 'service', price: 50, pricingType: 'per_hour', unit: 'hour', taxCategory: 'taxable_gst' },
            { id: 't4', name: 'Assessment & Report', tag: 'Assessment', type: 'service', price: 120, pricingType: 'fixed', unit: 'each', taxCategory: 'taxable_gst' },
            
            // Services GST-Free (0% tax)
            { id: 't5', name: 'Educational Counseling Service', tag: 'Support', type: 'service', price: 80, pricingType: 'per_hour', unit: 'hour', taxCategory: 'gst_free' },
            { id: 't6', name: 'Learning Disability Assessment', tag: 'Assessment', type: 'service', price: 150, pricingType: 'fixed', unit: 'each', taxCategory: 'gst_free' },
            
            // Services Input-Taxed (0% tax)
            { id: 't7', name: 'Tutoring Consultation Fee', tag: 'Consultation', type: 'service', price: 60, pricingType: 'fixed', unit: 'each', taxCategory: 'input_taxed' },
            
            // Products with GST (10% tax)
            { id: 'p1', name: 'Study Materials Package', tag: 'Materials', type: 'product', price: 45, pricingType: 'per_unit', unit: 'each', taxCategory: 'taxable_gst' },
            { id: 'p2', name: 'Textbook Bundle', tag: 'Materials', type: 'product', price: 120, pricingType: 'per_unit', unit: 'each', taxCategory: 'taxable_gst' },
            { id: 'p3', name: 'Practice Test Series', tag: 'Materials', type: 'product', price: 35, pricingType: 'per_unit', unit: 'each', taxCategory: 'taxable_gst' },
            
            // Products GST-Free (0% tax)
            { id: 'p4', name: 'Educational Books', tag: 'Materials', type: 'product', price: 25, pricingType: 'per_unit', unit: 'each', taxCategory: 'gst_free' },
            { id: 'p5', name: 'Basic Learning Materials', tag: 'Materials', type: 'product', price: 15, pricingType: 'per_unit', unit: 'each', taxCategory: 'gst_free' },
        ];

        // Helper functions
        function getServices() {
            return tutoringServices;
        }
        
        function updateTagFilter() {
            const services = getServices();
            const tags = [...new Set(services.map(s => s.tag))].sort();
            const tagSelect = document.getElementById('catalogFilterTag');
            
            // Keep "All tags" option
            tagSelect.innerHTML = '<option value="">All tags</option>';
            
            // Add unique tags
            tags.forEach(tag => {
                const option = document.createElement('option');
                option.value = tag;
                option.textContent = tag;
                tagSelect.appendChild(option);
            });
        }

        function getPricingIcon(type) {
            const icons = {
                'per_hour': `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`,
                'per_sqm': `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 5a1 1 0 011-1h4a1 1 0 011 1v7a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM14 5a1 1 0 011-1h4a1 1 0 011 1v7a1 1 0 01-1 1h-4a1 1 0 01-1-1V5zM4 16a1 1 0 011-1h4a1 1 0 011 1v3a1 1 0 01-1 1H5a1 1 0 01-1-1v-3zM14 16a1 1 0 011-1h4a1 1 0 011 1v3a1 1 0 01-1 1h-4a1 1 0 01-1-1v-3z"></path></svg>`,
                'per_unit': `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path></svg>`,
                'fixed': `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`
            };
            return icons[type] || icons['fixed'];
        }

        function getTypeIndicator(type) {
            if (type === 'product') {
                return '<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800">🟢 Product</span>';
            }
            return '<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800">🔵 Service</span>';
        }

        // Tax rate lookup based on tax category
        function getTaxRate(taxCategory) {
            const taxRates = {
                'taxable_gst': 0.10,    // 10% GST
                'gst_free': 0.00,       // 0% GST-free
                'input_taxed': 0.00     // 0% Input-taxed (no GST on output, but special reporting)
            };
            return taxRates[taxCategory] || 0.10; // Default to 10% if category not found
        }

        function getTaxCategoryLabel(taxCategory) {
            const labels = {
                'taxable_gst': 'Taxable (10% GST)',
                'gst_free': 'GST-Free (0%)',
                'input_taxed': 'Input-Taxed (0%)'
            };
            return labels[taxCategory] || 'Standard (10%)';
        }

        // Calculate tax for each line item based on its tax category
        function calculateLineItemTax(item) {
            const taxRate = getTaxRate(item.taxCategory);
            const lineTotal = item.customPrice * item.quantity;
            return lineTotal * taxRate;
        }

        // Calculation functions
        function calculateSubtotal() {
            return state.quoteItems.reduce((sum, item) => sum + (item.customPrice * item.quantity), 0);
        }

        function calculateDiscount() {
            const subtotal = calculateSubtotal();
            if (state.discountType === 'percentage') {
                return subtotal * (state.discount / 100);
            }
            return state.discount;
        }

        function calculateTax() {
            // Calculate tax per line item based on their tax categories
            return state.quoteItems.reduce((sum, item) => {
                return sum + calculateLineItemTax(item);
            }, 0);
        }

        function calculateTotal() {
            return calculateSubtotal() - calculateDiscount() + calculateTax();
        }
        
        // Get tax breakdown by category
        function getTaxBreakdown() {
            const breakdown = {
                taxable_gst: 0,
                gst_free: 0,
                input_taxed: 0
            };
            
            state.quoteItems.forEach(item => {
                const taxAmount = calculateLineItemTax(item);
                if (item.taxCategory && breakdown.hasOwnProperty(item.taxCategory)) {
                    breakdown[item.taxCategory] += taxAmount;
                } else {
                    breakdown.taxable_gst += taxAmount; // Default
                }
            });
            
            return breakdown;
        }

        function updateSummary() {
            document.getElementById('subtotalAmount').textContent = `$${calculateSubtotal().toFixed(2)}`;
            document.getElementById('discountAmount').textContent = `-$${calculateDiscount().toFixed(2)}`;
            document.getElementById('totalAmount').textContent = `$${calculateTotal().toFixed(2)}`;

            // Calculate and display tax breakdown by category
            const taxBreakdown = getTaxBreakdown();
            const taxBreakdownContainer = document.getElementById('taxBreakdown');
            
            let taxBreakdownHTML = '';
            if (taxBreakdown.taxable_gst > 0) {
                taxBreakdownHTML += `<div class="flex justify-between"><span>GST (10%):</span><span>$${taxBreakdown.taxable_gst.toFixed(2)}</span></div>`;
            }
            if (taxBreakdown.gst_free > 0) {
                taxBreakdownHTML += `<div class="flex justify-between text-gray-500"><span>GST-Free:</span><span>$0.00</span></div>`;
            }
            if (taxBreakdown.input_taxed > 0) {
                taxBreakdownHTML += `<div class="flex justify-between text-gray-500"><span>Input-Taxed:</span><span>$0.00</span></div>`;
            }
            
            taxBreakdownContainer.innerHTML = taxBreakdownHTML || '<div class="text-gray-400">No taxable items</div>';
            
            // Total tax
            const totalTax = calculateTax();
            document.getElementById('taxAmount').textContent = `$${totalTax.toFixed(2)}`;

            // Check approval requirement
            const discountAmount = calculateDiscount();
            const discountPercent = (discountAmount / calculateSubtotal()) * 100;
            state.approvalRequired = discountPercent > 20;
            
            updateSendButton();
        }

        function updateSendButton() {
            const sendBtn = document.getElementById('sendUpdatedQuoteBtn');
            const printBtn = document.getElementById('printQuoteBtn');
            const canSend = state.quoteItems.length > 0;
            sendBtn.disabled = !canSend;
            printBtn.disabled = !canSend;
        }

        // Function to show/hide unsaved changes alert
        function showUnsavedChangesAlert() {
            state.hasUnsavedChanges = true;
            document.getElementById('unsavedChangesAlert').classList.remove('hidden');
        }

        function hideUnsavedChangesAlert() {
            state.hasUnsavedChanges = false;
            document.getElementById('unsavedChangesAlert').classList.add('hidden');
        }

        // Render functions
        function renderServicesCatalog() {
            const catalog = document.getElementById('servicesCatalog');
            const searchTerm = document.getElementById('catalogSearchInput').value.toLowerCase();
            const typeFilter = document.getElementById('catalogFilterType').value;
            const tagFilter = document.getElementById('catalogFilterTag').value;
            
            const services = getServices().filter(service => {
                // Filter out services already in quote items
                const alreadyInQuote = state.quoteItems.some(item => item.id === service.id);
                if (alreadyInQuote) return false;
                
                // Search filter
                if (searchTerm && 
                    !service.name.toLowerCase().includes(searchTerm) && 
                    !service.id.toLowerCase().includes(searchTerm) &&
                    !service.tag.toLowerCase().includes(searchTerm)) {
                    return false;
                }
                // Type filter
                if (typeFilter && service.type !== typeFilter) {
                    return false;
                }
                // Tag filter
                if (tagFilter && service.tag !== tagFilter) {
                    return false;
                }
                return true;
            });
            
            // Update count
            document.getElementById('servicesCount').textContent = services.length;
            
            // Show/hide empty state
            const emptyState = document.getElementById('emptyCatalog');
            if (services.length === 0) {
                emptyState.classList.remove('hidden');
                catalog.innerHTML = '';
                return;
            }
            emptyState.classList.add('hidden');
            
            // Render as cards
            catalog.innerHTML = services.map(service => `
                <div class="border border-gray-200 rounded-lg p-3 hover:border-blue-500 transition-all">
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-2">
                                ${getTypeIndicator(service.type)}
                                <span class="text-xs bg-gray-100 text-gray-700 px-2 py-1 rounded">${service.tag}</span>
                            </div>
                            <h3 class="font-medium text-gray-900 text-sm mb-1">${service.name}</h3>
                            <p class="text-xs text-gray-500">${service.id}</p>
                        </div>
                    </div>
                    
                    <div class="mt-3 pt-3 border-t border-gray-100">
                        <div class="flex justify-between items-center mb-2">
                            <div class="flex items-center gap-1 text-gray-600">
                                ${getPricingIcon(service.pricingType)}
                                <span class="text-sm font-semibold">$${service.price}</span>
                                <span class="text-xs">/ ${service.unit}</span>
                            </div>
                        </div>
                        <div class="text-xs text-gray-600 mb-2">
                            Tax: ${getTaxCategoryLabel(service.taxCategory || 'taxable_gst')}
                        </div>
                        <button 
                            onclick="addQuoteItem('${service.id}')"
                            class="w-full bg-blue-600 text-white px-3 py-2 rounded text-sm hover:bg-blue-700 flex items-center justify-center gap-1"
                        >
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                            </svg>
                            Add to Quote
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function renderQuoteItems() {
            const emptyState = document.getElementById('emptyQuoteState');
            const table = document.getElementById('quoteItemsTable');
            const tbody = document.getElementById('quoteItemsBody');
            
            if (state.quoteItems.length === 0) {
                emptyState.classList.remove('hidden');
                table.classList.add('hidden');
                return;
            }
            
            emptyState.classList.add('hidden');
            table.classList.remove('hidden');
            
            tbody.innerHTML = state.quoteItems.map((item, index) => {
                // Show tax category
                let taxBadge = '';
                if (item.taxCategory) {
                    const taxLabels = {
                        'taxable_gst': '<span class="inline-flex items-center px-1.5 py-0.5 rounded text-xs bg-blue-50 text-blue-700">📋 GST (10%)</span>',
                        'gst_free': '<span class="inline-flex items-center px-1.5 py-0.5 rounded text-xs bg-gray-50 text-gray-600">GST-Free</span>',
                        'input_taxed': '<span class="inline-flex items-center px-1.5 py-0.5 rounded text-xs bg-gray-50 text-gray-600">Input-Taxed</span>'
                    };
                    taxBadge = taxLabels[item.taxCategory] || '';
                }
                
                return `
                <tr class="border-b border-gray-100">
                    <td class="p-2">
                        <p class="font-medium text-gray-900">${item.name}</p>
                        <div class="mt-1 flex items-center gap-2">
                            ${getTypeIndicator(item.type)}
                            ${taxBadge}
                        </div>
                        ${item.priceModificationComment ? `
                            <div class="mt-1 text-xs text-yellow-700 bg-yellow-50 px-2 py-0.5 rounded">
                                💬 ${item.priceModificationComment}
                            </div>
                        ` : ''}
                    </td>
                    <td class="p-2">
                        <div class="flex items-center gap-1 text-gray-600">
                            ${getPricingIcon(item.pricingType)}
                            <span class="text-xs">${item.unit}</span>
                        </div>
                    </td>
                    <td class="p-2 text-center">
                        <input 
                            type="number"
                            value="${item.quantity}"
                            onchange="updateItemQuantity(${index}, this.value)"
                            class="w-16 px-2 py-1 border border-gray-300 rounded text-center"
                            min="1"
                        />
                    </td>
                    <td class="p-2 text-right">
                        <div class="flex flex-col items-end gap-1">
                            <input 
                                type="number"
                                value="${item.customPrice}"
                                onchange="updateItemPrice(${index}, this.value)"
                                class="w-20 px-2 py-1 border ${item.priceModified ? 'border-yellow-500 bg-yellow-50' : 'border-gray-300'} rounded text-right"
                                min="0"
                                step="0.01"
                            />
                            ${item.priceModified ? `<span class="text-xs text-yellow-600">Modified</span>` : ''}
                        </div>
                    </td>
                    <td class="p-2 text-right font-semibold">
                        $${(item.quantity * item.customPrice).toFixed(2)}
                    </td>
                    <td class="p-2">
                        <button 
                            onclick="removeQuoteItem(${index})"
                            class="text-red-600 hover:text-red-800"
                        >
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </td>
                </tr>
                <tr class="border-b border-gray-200">
                    <td colspan="6" class="p-2 pb-3">
                        <input 
                            type="text"
                            value="${item.notes || ''}"
                            onchange="updateItemNotes(${index}, this.value)"
                            placeholder="Add notes for this line item..."
                            class="w-full px-2 py-1 border border-gray-200 rounded text-xs text-gray-600"
                        />
                    </td>
                </tr>
            `;
            }).join('');
            
            // Re-render catalog to update availability
            renderServicesCatalog();
        }

        // Event handlers
        function addQuoteItem(serviceId) {
            const services = getServices();
            const service = services.find(s => s.id === serviceId);
            
            if (!service) return;
            
            const newItem = {
                ...service,
                quantity: 1,
                customPrice: service.price,
                originalPrice: service.price,
                priceModified: false,
                priceModificationComment: '',
                notes: ''
            };
            
            state.quoteItems.push(newItem);
            renderQuoteItems();
            updateSummary();
            showUnsavedChangesAlert();
        }

        function removeQuoteItem(index) {
            state.quoteItems.splice(index, 1);
            renderQuoteItems();
            updateSummary();
            showUnsavedChangesAlert();
        }

        function updateItemQuantity(index, value) {
            state.quoteItems[index].quantity = Number(value);
            renderQuoteItems();
            updateSummary();
            showUnsavedChangesAlert();
        }

        function updateItemNotes(index, value) {
            state.quoteItems[index].notes = value;
            showUnsavedChangesAlert();
        }

        function updateItemPrice(index, value) {
            const item = state.quoteItems[index];
            const newPrice = Number(value);
            
            item.customPrice = newPrice;
            renderQuoteItems();
            updateSummary();
            showUnsavedChangesAlert();
        }

        // Preview function
        function showPreview() {
            if (state.quoteItems.length === 0) {
                alert('Please add items to the quote first.');
                return;
            }

            const validUntil = document.getElementById('validUntilDate').value;
            const customerNotes = document.getElementById('customerNotes').value;
            const internalNotes = document.getElementById('internalNotes').value;

            // Get current date
            const currentDate = new Date().toLocaleDateString('en-AU', { day: 'numeric', month: 'long', year: 'numeric' });
            
            // Build line items HTML
            const lineItemsHTML = state.quoteItems.map(item => `
                <tr class="border-b border-gray-200">
                    <td class="py-2 px-1" style="width: 35%;">
                        <div class="font-medium text-gray-900">${item.name}</div>
                        <div class="text-xs text-gray-600 mt-1">${item.id}</div>
                        ${item.notes ? `<div class="text-xs text-gray-500 italic mt-1">${item.notes}</div>` : ''}
                    </td>
                    <td class="py-2 px-1 text-center text-gray-700">${item.quantity} ${item.unit}</td>
                    <td class="py-2 px-1 text-right text-gray-700">$${item.customPrice.toFixed(2)}</td>
                    <td class="py-2 px-1 text-right font-medium">$${(item.customPrice * item.quantity).toFixed(2)}</td>
                </tr>
            `).join('');

            // Format tax breakdown
            const taxBreakdown = getTaxBreakdown();
            const taxBreakdownHTML = `
                ${taxBreakdown.taxable_gst > 0 ? `<div class="flex justify-between text-sm py-1"><span>GST (10%):</span><span>$${taxBreakdown.taxable_gst.toFixed(2)}</span></div>` : ''}
                ${taxBreakdown.gst_free > 0 ? `<div class="flex justify-between text-xs text-gray-500 py-1"><span>GST-Free Items:</span><span>$${state.quoteItems.filter(i => i.taxCategory === 'gst_free').reduce((sum, i) => sum + i.customPrice * i.quantity, 0).toFixed(2)}</span></div>` : ''}
                ${taxBreakdown.input_taxed > 0 ? `<div class="flex justify-between text-xs text-gray-500 py-1"><span>Input-Taxed Items:</span><span>$${state.quoteItems.filter(i => i.taxCategory === 'input_taxed').reduce((sum, i) => sum + i.customPrice * i.quantity, 0).toFixed(2)}</span></div>` : ''}
            `;

            // Build preview HTML
            const previewHTML = `
                <!-- Company Header -->
                <div class="border-b-2 border-gray-800 pb-4 mb-6">
                    <div class="flex items-center justify-between mb-4">
                        <div>
                            <h1 class="text-3xl font-bold text-gray-900 mb-1">SUNSHINE TUTORING</h1>
                            <p class="text-sm text-gray-600">Tutoring Excellence Since 2015</p>
                        </div>
                        <div class="text-right">
                            <p class="text-lg font-bold">QUOTE</p>
                            <p class="text-sm text-gray-600">Date: ${currentDate}</p>
                        </div>
                    </div>
                </div>

                <!-- Customer Details -->
                <div class="grid grid-cols-2 gap-6 mb-6">
                    <div>
                        <h3 class="font-semibold text-gray-900 mb-2 text-sm uppercase tracking-wide">Bill To:</h3>
                        <div class="text-sm text-gray-700">
                            <p class="font-medium">${state.selectedCustomer.name}</p>
                            <p>${state.selectedCustomer.email}</p>
                            <p>${state.selectedCustomer.phone}</p>
                            ${state.selectedCustomer.address ? `<p class="mt-2">${state.selectedCustomer.address}</p>` : ''}
                        </div>
                    </div>
                    <div>
                        <h3 class="font-semibold text-gray-900 mb-2 text-sm uppercase tracking-wide">Quote Details:</h3>
                        <div class="text-sm text-gray-700">
                            <p><span class="font-medium">Quote ID:</span> Q-2024-001</p>
                            <p><span class="font-medium">Valid Until:</span> ${validUntil ? new Date(validUntil).toLocaleDateString('en-AU', { day: 'numeric', month: 'long', year: 'numeric' }) : 'N/A'}</p>
                            <p class="mt-2 text-xs text-gray-500">Melbourne East Branch</p>
                        </div>
                    </div>
                </div>

                <!-- Line Items Table -->
                <div class="mb-6">
                    <table class="w-full text-sm" style="min-width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr class="bg-gray-100 border-b-2 border-gray-800">
                                <th class="text-left py-2 px-1 font-semibold text-gray-900" style="width: 35%;">Description</th>
                                <th class="text-center py-2 px-1 font-semibold text-gray-900" style="width: 20%;">Quantity</th>
                                <th class="text-right py-2 px-1 font-semibold text-gray-900" style="width: 20%;">Unit Price</th>
                                <th class="text-right py-2 px-1 font-semibold text-gray-900" style="width: 25%;">Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${lineItemsHTML}
                        </tbody>
                    </table>
                </div>

                <!-- Summary -->
                <div class="flex justify-end mb-6">
                    <div class="w-64">
                        <div class="border-t border-gray-300 pt-3">
                            <div class="flex justify-between text-sm py-1">
                                <span class="text-gray-700">Subtotal:</span>
                                <span class="font-medium">$${calculateSubtotal().toFixed(2)}</span>
                            </div>
                            ${calculateDiscount() > 0 ? `
                                <div class="flex justify-between text-sm py-1">
                                    <span class="text-gray-700">Discount:</span>
                                    <span class="text-red-600">-$${calculateDiscount().toFixed(2)}</span>
                                </div>
                            ` : ''}
                            <div class="border-t border-gray-300 mt-2 pt-2">
                                ${taxBreakdownHTML}
                                <div class="flex justify-between items-center mt-2 pt-2 border-t border-gray-800">
                                    <span class="text-sm font-semibold">Total Tax:</span>
                                    <span class="text-sm font-semibold">$${calculateTax().toFixed(2)}</span>
                                </div>
                            </div>
                            <div class="border-t-2 border-gray-800 mt-2 pt-2">
                                <div class="flex justify-between">
                                    <span class="text-lg font-bold text-gray-900">TOTAL:</span>
                                    <span class="text-lg font-bold text-gray-900">$${calculateTotal().toFixed(2)}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Notes -->
                ${customerNotes ? `
                    <div class="border-t border-gray-300 pt-4 mb-4">
                        <h4 class="font-semibold text-gray-900 mb-2 text-sm uppercase tracking-wide">Notes:</h4>
                        <p class="text-sm text-gray-700 whitespace-pre-wrap">${customerNotes}</p>
                    </div>
                ` : ''}

                <!-- Footer -->
                <div class="border-t-2 border-gray-800 pt-4 mt-6">
                    <div class="grid grid-cols-2 gap-6 text-xs text-gray-600">
                        <div>
                            <p class="font-semibold text-gray-900 mb-1">Sunshine Tutoring - Melbourne East</p>
                            <p>123 Education Street, Melbourne VIC 3000</p>
                            <p>Phone: (03) 1234 5678</p>
                            <p>Email: melbourne@sunshinetutoring.com.au</p>
                        </div>
                        <div>
                            <p class="font-semibold text-gray-900 mb-1">Payment Information</p>
                            <p>ABN: 12 345 678 901</p>
                            <p>Valid for 30 days from date of issue</p>
                            <p class="mt-2 text-gray-500">Terms and conditions apply</p>
                        </div>
                    </div>
                </div>

                ${internalNotes ? `
                    <div class="mt-6 pt-4 border-t-2 border-dashed border-red-300 bg-red-50 p-3 rounded">
                        <p class="text-xs font-semibold text-red-700 mb-1">INTERNAL NOTES (Not visible to customer):</p>
                        <p class="text-xs text-red-600 whitespace-pre-wrap">${internalNotes}</p>
                    </div>
                ` : ''}
            `;

            document.getElementById('previewContent').innerHTML = previewHTML;
            document.getElementById('previewModal').classList.remove('hidden');
        }

        function hidePreview() {
            document.getElementById('previewModal').classList.add('hidden');
        }

        function downloadPreviewPDF() {
            alert('PDF download functionality would be implemented here');
            // In a real implementation, this would generate and download a PDF
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Catalog search and filters
            document.getElementById('catalogSearchInput').addEventListener('input', renderServicesCatalog);
            document.getElementById('catalogFilterType').addEventListener('change', renderServicesCatalog);
            document.getElementById('catalogFilterTag').addEventListener('change', renderServicesCatalog);

            // Dismiss alert button
            document.getElementById('dismissAlertBtn').addEventListener('click', hideUnsavedChangesAlert);

            // Save changes button
            document.getElementById('saveChangesBtn').addEventListener('click', function() {
                console.log('Saving quote changes:', state);
                hideUnsavedChangesAlert();
                alert('Quote updated successfully!');
            });

            // Send updated quote button
            document.getElementById('sendUpdatedQuoteBtn').addEventListener('click', function() {
                if (state.quoteItems.length === 0) {
                    alert('Please add at least one item to the quote');
                    return;
                }
                
                // Get all selected send methods
                const selectedMethods = Array.from(document.querySelectorAll('input[name="sendMethod"]:checked')).map(cb => cb.value);
                
                if (selectedMethods.length === 0) {
                    alert('Please select at least one send method');
                    return;
                }
                
                console.log('Sending updated quote:', state);
                hideUnsavedChangesAlert();
                alert(`Updated quote sent successfully via ${selectedMethods.join(', ')}!`);
            });

            // Print quote button
            document.getElementById('printQuoteBtn').addEventListener('click', function() {
                console.log('Printing quote:', state);
                alert('Opening print dialog...');
                window.print();
            });

            // Preview button
            document.getElementById('previewBtn').addEventListener('click', showPreview);
            
            // Preview modal buttons
            document.getElementById('closePreviewBtn').addEventListener('click', hidePreview);
            document.getElementById('downloadPreviewBtn').addEventListener('click', downloadPreviewPDF);

            // Detect changes to trigger unsaved changes alert
            const inputs = document.querySelectorAll('input, textarea, select');
            inputs.forEach(input => {
                input.addEventListener('change', showUnsavedChangesAlert);
            });

            // Initial render
            updateTagFilter(); // Initialize tag dropdown
            renderServicesCatalog();
            renderQuoteItems();
            updateSummary();
        });
    </script>
</body>
</html>