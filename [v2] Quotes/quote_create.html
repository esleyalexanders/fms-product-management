<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Quote - FMS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<body class="min-h-screen bg-gray-50">
    
    <div class="p-4">
        <div class="max-w-7xl mx-auto">
            
            <!-- Header -->
            <div class="bg-white rounded-lg shadow-sm p-4 mb-4">
                <div class="flex justify-between items-center">
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900">Create Quote</h1>
                        <p class="text-gray-600 mt-1 font-medium">Sunshine Tutoring - Melbourne East</p>
                    </div>
                    <div class="flex gap-2">
                        <button 
                            id="saveDraftBtn"
                            class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50"
                        >
                            Save Draft
                        </button>
                        <button 
                            id="previewBtn"
                            class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center gap-2"
                        >
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            Preview
                        </button>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                
                <!-- Left Column - Customer & Services -->
                <div class="lg:col-span-2 space-y-4">
                    
                    <!-- Customer Section -->
                    <div class="bg-white rounded-lg shadow-sm p-4">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-lg font-semibold text-gray-900">Customer Information</h2>
                            <button 
                                id="toggleNewCustomerBtn"
                                class="text-blue-600 text-sm hover:underline flex items-center gap-1"
                            >
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                                </svg>
                                New Customer
                            </button>
                        </div>

                        <!-- Customer Search -->
                        <div id="customerSearchSection">
                            <div class="relative mb-3">
                                <svg class="absolute left-3 top-3 text-gray-400 w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                </svg>
                                <input
                                    type="text"
                                    id="customerSearchInput"
                                    placeholder="Search customer by name, email, or phone..."
                                    class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"
                                />
                            </div>
                            <div id="customerResultsList" class="space-y-2 max-h-40 overflow-y-auto custom-scrollbar">
                                <!-- Customer results will be populated here -->
                            </div>
                        </div>

                        <!-- Selected Customer -->
                        <div id="selectedCustomerCard" class="hidden border border-gray-200 rounded-lg p-3 bg-blue-50">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="font-semibold text-gray-900" id="selectedCustomerName"></p>
                                    <p class="text-sm text-gray-600 mt-1" id="selectedCustomerEmail"></p>
                                    <p class="text-sm text-gray-600" id="selectedCustomerPhone"></p>
                                    <p class="text-sm text-gray-600" id="selectedCustomerAddress"></p>
                                </div>
                                <button 
                                    id="clearCustomerBtn"
                                    class="text-gray-500 hover:text-gray-700"
                                >
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>

                        <!-- New Customer Form -->
                        <div id="newCustomerForm" class="hidden space-y-3">
                            <!-- Name Fields -->
                            <div class="grid grid-cols-2 gap-3">
                                <div class="form-group">
                                    <label for="newCustomerFirstName" class="block text-sm font-medium text-gray-700 mb-1">First Name *</label>
                                    <input type="text" id="newCustomerFirstName" placeholder="John" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" required />
                                </div>
                                <div class="form-group">
                                    <label for="newCustomerLastName" class="block text-sm font-medium text-gray-700 mb-1">Last Name *</label>
                                    <input type="text" id="newCustomerLastName" placeholder="Doe" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" required />
                                </div>
                            </div>
                            
                            <!-- Company -->
                            <div class="form-group">
                                <label for="newCustomerCompany" class="block text-sm font-medium text-gray-700 mb-1">Company</label>
                                <input type="text" id="newCustomerCompany" placeholder="ABC Corp" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" />
                            </div>
                            
                            <!-- Contact Information -->
                            <div class="border-t border-gray-200 pt-3">
                                <h3 class="text-sm font-medium text-gray-700 mb-3">Contact Information</h3>
                                <div class="form-group">
                                    <label for="newCustomerEmail" class="block text-sm font-medium text-gray-700 mb-1">Email *</label>
                                    <input type="email" id="newCustomerEmail" placeholder="john@example.com" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" required />
                                </div>
                                <div class="form-group mt-3">
                                    <label for="newCustomerPhone" class="block text-sm font-medium text-gray-700 mb-1">Phone</label>
                                    <input type="tel" id="newCustomerPhone" placeholder="+1 234 567 8900" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" />
                                </div>
                                <div class="form-group mt-3">
                                    <label for="newCustomerPreferredContact" class="block text-sm font-medium text-gray-700 mb-1">Preferred Contact Method</label>
                                    <select id="newCustomerPreferredContact" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="email">Email</option>
                                        <option value="phone">Phone</option>
                                        <option value="whatsapp">WhatsApp</option>
                                        <option value="none">None</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Address -->
                            <div class="border-t border-gray-200 pt-3">
                                <h3 class="text-sm font-medium text-gray-700 mb-3">Address</h3>
                                <div class="form-group">
                                    <label for="newCustomerStreet" class="block text-sm font-medium text-gray-700 mb-1">Street</label>
                                    <input type="text" id="newCustomerStreet" placeholder="123 Main St" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" />
                                </div>
                                <div class="grid grid-cols-2 gap-3 mt-3">
                                    <div class="form-group">
                                        <label for="newCustomerCity" class="block text-sm font-medium text-gray-700 mb-1">City</label>
                                        <input type="text" id="newCustomerCity" placeholder="New York" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" />
                                    </div>
                                    <div class="form-group">
                                        <label for="newCustomerState" class="block text-sm font-medium text-gray-700 mb-1">State</label>
                                        <input type="text" id="newCustomerState" placeholder="NY" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" />
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-3 mt-3">
                                    <div class="form-group">
                                        <label for="newCustomerPostalCode" class="block text-sm font-medium text-gray-700 mb-1">Postal Code</label>
                                        <input type="text" id="newCustomerPostalCode" placeholder="10001" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" />
                                    </div>
                                    <div class="form-group">
                                        <label for="newCustomerCountry" class="block text-sm font-medium text-gray-700 mb-1">Country</label>
                                        <input type="text" id="newCustomerCountry" placeholder="Australia" value="Australia" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" />
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Notes -->
                            <div class="border-t border-gray-200 pt-3">
                                <h3 class="text-sm font-medium text-gray-700 mb-3">Notes</h3>
                                <textarea id="newCustomerNotes" placeholder="Additional notes about the customer" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                            </div>
                            
                            <!-- Actions -->
                            <div class="flex gap-2 border-t border-gray-200 pt-3">
                                <button 
                                    id="cancelNewCustomerBtn"
                                    class="flex-1 px-3 py-2 border border-gray-300 text-gray-700 rounded-lg text-sm hover:bg-gray-50"
                                >
                                    Cancel
                                </button>
                                <button 
                                    id="createCustomerBtn"
                                    class="flex-1 px-3 py-2 bg-blue-600 text-white rounded-lg text-sm hover:bg-blue-700"
                                >
                                    Create & Select
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Services Catalog -->
                    <div class="bg-white rounded-lg shadow-sm p-4">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-lg font-semibold text-gray-900">Services & Products Catalog</h2>
                            <div class="text-sm text-gray-500">
                                Showing <span id="servicesCount">0</span> items
                            </div>
                        </div>
                        
                        <!-- Search and Filter -->
                        <div class="flex items-center gap-3 mb-4">
                            <div class="flex-1 relative">
                                <svg class="absolute left-3 top-3 text-gray-400 w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                </svg>
                                <input 
                                    type="text" 
                                    id="catalogSearchInput"
                                    placeholder="Search by name, code, or category..."
                                    class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"
                                />
                            </div>
                            <select 
                                id="catalogFilterType"
                                class="px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                            >
                                <option value="">All types</option>
                                <option value="service">Service</option>
                                <option value="product">Product</option>
                            </select>
                            <select 
                                id="catalogFilterCategory"
                                class="px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                            >
                                <option value="">All categories</option>
                            </select>
                        </div>
                        
                        <div id="emptyCatalog" class="hidden text-center py-12 text-gray-400">
                            <svg class="mx-auto mb-3 text-gray-300 w-12 h-12" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                            <p class="text-sm">No items found. Try adjusting your filters.</p>
                        </div>
                        
                        <div id="servicesCatalog" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 max-h-96 overflow-y-auto custom-scrollbar">
                            <!-- Services cards will be populated here -->
                        </div>
                    </div>

                    <!-- Quote Items Table -->
                    <div class="bg-white rounded-lg shadow-sm p-4">
                        <h2 class="text-lg font-semibold text-gray-900 mb-4">Quote Line Items</h2>
                        
                        <div id="emptyQuoteState" class="text-center py-8 text-gray-500">
                            <svg class="mx-auto mb-2 text-gray-400 w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                            </svg>
                            <p class="text-sm">No items added yet. Select services from the catalog above.</p>
                        </div>

                        <div id="quoteItemsTable" class="hidden overflow-x-auto">
                            <table class="w-full text-sm">
                                <thead class="bg-gray-50 border-b border-gray-200">
                                    <tr>
                                        <th class="text-left p-2 font-medium text-gray-700">Service/Product</th>
                                        <th class="text-left p-2 font-medium text-gray-700">Type</th>
                                        <th class="text-center p-2 font-medium text-gray-700">Qty</th>
                                        <th class="text-right p-2 font-medium text-gray-700">Unit Price</th>
                                        <th class="text-right p-2 font-medium text-gray-700">Total</th>
                                        <th class="w-10"></th>
                                    </tr>
                                </thead>
                                <tbody id="quoteItemsBody">
                                    <!-- Quote items will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Right Column - Summary & Actions -->
                <div class="space-y-4">
                    
                    <!-- Pricing Summary -->
                    <div class="bg-white rounded-lg shadow-sm p-4 sticky top-4">
                        <h2 class="text-lg font-semibold text-gray-900 mb-4">Quote Summary</h2>
                        
                        <div class="space-y-3 mb-4">
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-600">Subtotal</span>
                                <span class="font-medium" id="subtotalAmount">$0.00</span>
                            </div>

                            <div class="border-t border-gray-200 pt-3">
                                <div class="flex justify-between items-center mb-2">
                                    <span class="text-sm text-gray-600">Discount</span>
                                    <div class="flex items-center gap-2">
                                        <select 
                                            id="discountType"
                                            class="px-2 py-1 border border-gray-300 rounded text-xs"
                                        >
                                            <option value="percentage">%</option>
                                            <option value="fixed">$</option>
                                        </select>
                                        <input 
                                            type="number"
                                            id="discountValue"
                                            value="0"
                                            class="w-20 px-2 py-1 border border-gray-300 rounded text-sm text-right"
                                            min="0"
                                            step="1"
                                        />
                                    </div>
                                </div>
                                <div class="flex justify-end">
                                    <span class="text-sm font-medium text-red-600" id="discountAmount">-$0.00</span>
                                </div>
                            </div>

                            <div id="approvalWarning" class="hidden bg-yellow-50 border border-yellow-200 rounded p-2 flex items-start gap-2">
                                <svg class="w-4 h-4 text-yellow-600 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                                </svg>
                                <p class="text-xs text-yellow-800">Manager approval required (discount >20%)</p>
                            </div>

                            <!-- Tax Breakdown by Category -->
                            <div class="border-t border-gray-200 pt-3">
                                <div class="text-xs text-gray-600 mb-2">Tax Breakdown:</div>
                                <div id="taxBreakdown" class="space-y-1 text-xs">
                                    <!-- Tax breakdown will be populated here -->
                                </div>
                                <div class="flex justify-between items-center mt-2 pt-2 border-t border-gray-100">
                                    <span class="text-sm text-gray-600">Total Tax</span>
                                    <span class="text-sm font-medium" id="taxAmount">$0.00</span>
                                </div>
                            </div>

                            <div class="border-t-2 border-gray-300 pt-3">
                                <div class="flex justify-between">
                                    <span class="font-bold text-gray-900 text-lg">Total</span>
                                    <span class="font-bold text-gray-900 text-lg" id="totalAmount">$0.00</span>
                                </div>
                            </div>
                        </div>

                        <!-- Quote Details -->
                        <div class="border-t border-gray-200 pt-4 space-y-3">
                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-1">Valid Until</label>
                                <input 
                                    type="date" 
                                    id="validUntilDate"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                                />
                            </div>

                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-1">Payment Terms</label>
                                <select id="paymentTerms" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option>Due on acceptance</option>
                                    <option>Net 7 days</option>
                                    <option>Net 14 days</option>
                                    <option>Net 30 days</option>
                                    <option>50% deposit, 50% on completion</option>
                                </select>
                            </div>

                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-1">Notes for Customer</label>
                                <textarea 
                                    id="customerNotes"
                                    rows="3"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    placeholder="Terms, conditions, or special notes..."
                                ></textarea>
                            </div>

                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-1">Internal Notes</label>
                                <textarea 
                                    id="internalNotes"
                                    rows="2"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    placeholder="Private notes (not visible to customer)..."
                                ></textarea>
                            </div>
                        </div>

                        <!-- Send Options -->
                        <div class="border-t border-gray-200 pt-4 mt-4">
                            <label class="block text-xs font-medium text-gray-700 mb-2">Send Method (multiple selection)</label>
                            <div class="space-y-2">
                                <label class="flex items-center gap-2 text-sm">
                                    <input type="checkbox" name="sendMethod" value="email" checked />
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                                    </svg>
                                    <span>Email</span>
                                </label>
                                <label class="flex items-center gap-2 text-sm">
                                    <input type="checkbox" name="sendMethod" value="sms" />
                                    <span>SMS with Portal Link</span>
                                </label>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="mt-4 space-y-2">
                            <button 
                                id="submitApprovalBtn"
                                class="hidden w-full bg-yellow-600 text-white py-2 rounded-lg hover:bg-yellow-700 text-sm font-medium"
                            >
                                Submit for Approval
                            </button>
                            <div class="grid grid-cols-2 gap-2">
                                <button 
                                    id="printQuoteBtn"
                                    class="bg-gray-600 text-white py-2 rounded-lg hover:bg-gray-700 disabled:bg-gray-300 disabled:cursor-not-allowed text-sm font-medium flex items-center justify-center gap-2"
                                >
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path>
                                    </svg>
                                    Print/Manual
                                </button>
                                <button 
                                    id="sendQuoteBtn"
                                    class="bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 disabled:bg-gray-300 disabled:cursor-not-allowed text-sm font-medium flex items-center justify-center gap-2"
                                >
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                                    </svg>
                                    Send Quote
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // State management
        const state = {
            businessType: 'tutoring',
            selectedCustomer: null,
            showNewCustomerForm: false,
            quoteItems: [],
            discount: 0,
            discountType: 'percentage',
            approvalRequired: false
        };

        // Sample data
        const customers = [
            { id: 1, name: 'Sarah Johnson', email: 'sarah.j@email.com', phone: '0412 345 678', address: '123 Main St, Melbourne', previousQuotes: 2 },
            { id: 2, name: 'Michael Chen', email: 'm.chen@email.com', phone: '0423 456 789', address: '456 Park Ave, Melbourne', previousQuotes: 5 },
            { id: 3, name: 'Emma Wilson', email: 'emma.w@email.com', phone: '0434 567 890', address: '789 Oak Rd, Melbourne', previousQuotes: 0 }
        ];

        const tutoringServices = [
            { id: 't1', name: 'One-on-One Tutoring - Math', category: 'Tutoring', type: 'service', price: 75, pricingType: 'per_hour', unit: 'hour', taxCategory: 'taxable_gst' },
            { id: 't2', name: 'One-on-One Tutoring - English', category: 'Tutoring', type: 'service', price: 75, pricingType: 'per_hour', unit: 'hour', taxCategory: 'taxable_gst' },
            { id: 't3', name: 'Small Group (2-4 students)', category: 'Group', type: 'service', price: 50, pricingType: 'per_hour_per_student', unit: 'hour/student', taxCategory: 'taxable_gst' },
            { id: 't4', name: 'Assessment & Report', category: 'Assessment', type: 'service', price: 120, pricingType: 'fixed', unit: 'one-time', taxCategory: 'taxable_gst' },
            { id: 't5', name: 'Study Materials Package', category: 'Materials', type: 'product', price: 45, pricingType: 'per_unit', unit: 'package', taxCategory: 'taxable_gst' },
        ];

        // Helper functions
        function getServices() {
            return tutoringServices;
        }
        
        function updateCategoryFilter() {
            const services = getServices();
            const categories = [...new Set(services.map(s => s.category))].sort();
            const categorySelect = document.getElementById('catalogFilterCategory');
            
            // Keep "All categories" option
            categorySelect.innerHTML = '<option value="">All categories</option>';
            
            // Add unique categories
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                categorySelect.appendChild(option);
            });
        }

        function getPricingIcon(type) {
            const icons = {
                'per_hour': `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`,
                'per_sqm': `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 5a1 1 0 011-1h4a1 1 0 011 1v7a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM14 5a1 1 0 011-1h4a1 1 0 011 1v7a1 1 0 01-1 1h-4a1 1 0 01-1-1V5zM4 16a1 1 0 011-1h4a1 1 0 011 1v3a1 1 0 01-1 1H5a1 1 0 01-1-1v-3zM14 16a1 1 0 011-1h4a1 1 0 011 1v3a1 1 0 01-1 1h-4a1 1 0 01-1-1v-3z"></path></svg>`,
                'per_unit': `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path></svg>`,
                'fixed': `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`
            };
            return icons[type] || icons['fixed'];
        }

        function getTypeIndicator(type) {
            if (type === 'product') {
                return '<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800">ðŸŸ¢ Product</span>';
            }
            return '<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800">ðŸ”µ Service</span>';
        }

        // Tax rate lookup based on tax category
        function getTaxRate(taxCategory) {
            const taxRates = {
                'taxable_gst': 0.10,    // 10% GST
                'gst_free': 0.00,       // 0% GST-free
                'input_taxed': 0.00     // 0% Input-taxed (no GST on output, but special reporting)
            };
            return taxRates[taxCategory] || 0.10; // Default to 10% if category not found
        }

        function getTaxCategoryLabel(taxCategory) {
            const labels = {
                'taxable_gst': 'Taxable (10% GST)',
                'gst_free': 'GST-Free (0%)',
                'input_taxed': 'Input-Taxed (0%)'
            };
            return labels[taxCategory] || 'Standard (10%)';
        }

        // Calculate tax for each line item based on its tax category
        function calculateLineItemTax(item) {
            const taxRate = getTaxRate(item.taxCategory);
            const lineTotal = item.customPrice * item.quantity;
            return lineTotal * taxRate;
        }

        // Calculation functions
        function calculateSubtotal() {
            return state.quoteItems.reduce((sum, item) => sum + (item.customPrice * item.quantity), 0);
        }

        function calculateDiscount() {
            const subtotal = calculateSubtotal();
            if (state.discountType === 'percentage') {
                return subtotal * (state.discount / 100);
            }
            return state.discount;
        }

        function calculateTax() {
            // Calculate tax per line item based on their tax categories
            return state.quoteItems.reduce((sum, item) => {
                return sum + calculateLineItemTax(item);
            }, 0);
        }

        function calculateTotal() {
            return calculateSubtotal() - calculateDiscount() + calculateTax();
        }
        
        // Get tax breakdown by category
        function getTaxBreakdown() {
            const breakdown = {
                taxable_gst: 0,
                gst_free: 0,
                input_taxed: 0
            };
            
            state.quoteItems.forEach(item => {
                const taxAmount = calculateLineItemTax(item);
                if (item.taxCategory && breakdown.hasOwnProperty(item.taxCategory)) {
                    breakdown[item.taxCategory] += taxAmount;
                } else {
                    breakdown.taxable_gst += taxAmount; // Default
                }
            });
            
            return breakdown;
        }

        function updateSummary() {
            document.getElementById('subtotalAmount').textContent = `$${calculateSubtotal().toFixed(2)}`;
            document.getElementById('discountAmount').textContent = `-$${calculateDiscount().toFixed(2)}`;
            document.getElementById('totalAmount').textContent = `$${calculateTotal().toFixed(2)}`;

            // Calculate and display tax breakdown by category
            const taxBreakdown = getTaxBreakdown();
            const taxBreakdownContainer = document.getElementById('taxBreakdown');
            
            let taxBreakdownHTML = '';
            if (taxBreakdown.taxable_gst > 0) {
                taxBreakdownHTML += `<div class="flex justify-between"><span>GST (10%):</span><span>$${taxBreakdown.taxable_gst.toFixed(2)}</span></div>`;
            }
            if (taxBreakdown.gst_free > 0) {
                taxBreakdownHTML += `<div class="flex justify-between text-gray-500"><span>GST-Free:</span><span>$0.00</span></div>`;
            }
            if (taxBreakdown.input_taxed > 0) {
                taxBreakdownHTML += `<div class="flex justify-between text-gray-500"><span>Input-Taxed:</span><span>$0.00</span></div>`;
            }
            
            taxBreakdownContainer.innerHTML = taxBreakdownHTML || '<div class="text-gray-400">No taxable items</div>';
            
            // Total tax
            const totalTax = calculateTax();
            document.getElementById('taxAmount').textContent = `$${totalTax.toFixed(2)}`;

            // Check approval requirement
            const discountAmount = calculateDiscount();
            const discountPercent = (discountAmount / calculateSubtotal()) * 100;
            state.approvalRequired = discountPercent > 20;
            
            document.getElementById('approvalWarning').classList.toggle('hidden', !state.approvalRequired);
            document.getElementById('submitApprovalBtn').classList.toggle('hidden', !state.approvalRequired);
            
            updateSendButton();
        }

        function updateSendButton() {
            const sendBtn = document.getElementById('sendQuoteBtn');
            const printBtn = document.getElementById('printQuoteBtn');
            const canSend = state.quoteItems.length > 0 && state.selectedCustomer !== null;
            sendBtn.disabled = !canSend;
            printBtn.disabled = !canSend;
        }

        // Render functions
        function renderCustomerResults(searchTerm = '') {
            const resultsList = document.getElementById('customerResultsList');
            const filtered = customers.filter(c => 
                c.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                c.email.toLowerCase().includes(searchTerm.toLowerCase()) ||
                c.phone.includes(searchTerm)
            );

            resultsList.innerHTML = filtered.map(customer => `
                <div 
                    class="border border-gray-200 rounded p-3 hover:border-blue-500 cursor-pointer text-sm"
                    onclick="selectCustomer(${customer.id})"
                >
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="font-medium text-gray-900">${customer.name}</p>
                            <p class="text-xs text-gray-600">${customer.email} â€¢ ${customer.phone}</p>
                        </div>
                        ${customer.previousQuotes > 0 ? `
                            <button class="text-xs text-blue-600 flex items-center gap-1">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                </svg>
                                Clone
                            </button>
                        ` : ''}
                    </div>
                </div>
            `).join('');
        }

        function renderServicesCatalog() {
            const catalog = document.getElementById('servicesCatalog');
            const searchTerm = document.getElementById('catalogSearchInput').value.toLowerCase();
            const typeFilter = document.getElementById('catalogFilterType').value;
            const categoryFilter = document.getElementById('catalogFilterCategory').value;
            
            const services = getServices().filter(service => {
                // Search filter
                if (searchTerm && 
                    !service.name.toLowerCase().includes(searchTerm) && 
                    !service.id.toLowerCase().includes(searchTerm) &&
                    !service.category.toLowerCase().includes(searchTerm)) {
                    return false;
                }
                // Type filter
                if (typeFilter && service.type !== typeFilter) {
                    return false;
                }
                // Category filter
                if (categoryFilter && service.category !== categoryFilter) {
                    return false;
                }
                return true;
            });
            
            // Update count
            document.getElementById('servicesCount').textContent = services.length;
            
            // Show/hide empty state
            const emptyState = document.getElementById('emptyCatalog');
            if (services.length === 0) {
                emptyState.classList.remove('hidden');
                catalog.innerHTML = '';
                return;
            }
            emptyState.classList.add('hidden');
            
            // Render as cards
            catalog.innerHTML = services.map(service => `
                <div class="border border-gray-200 rounded-lg p-3 hover:border-blue-500 transition-all">
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-2">
                                ${getTypeIndicator(service.type)}
                                <span class="text-xs bg-gray-100 text-gray-700 px-2 py-1 rounded">${service.category}</span>
                            </div>
                            <h3 class="font-medium text-gray-900 text-sm mb-1">${service.name}</h3>
                            <p class="text-xs text-gray-500">${service.id}</p>
                        </div>
                    </div>
                    
                    <div class="mt-3 pt-3 border-t border-gray-100">
                        <div class="flex justify-between items-center mb-2">
                            <div class="flex items-center gap-1 text-gray-600">
                                ${getPricingIcon(service.pricingType)}
                                <span class="text-sm font-semibold">$${service.price}</span>
                                <span class="text-xs">/ ${service.unit}</span>
                            </div>
                        </div>
                        <div class="text-xs text-gray-600 mb-2">
                            Tax: ${getTaxCategoryLabel(service.taxCategory || 'taxable_gst')}
                        </div>
                        <button 
                            onclick="addQuoteItem('${service.id}')"
                            class="w-full bg-blue-600 text-white px-3 py-2 rounded text-sm hover:bg-blue-700 flex items-center justify-center gap-1"
                        >
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                            </svg>
                            Add to Quote
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function renderQuoteItems() {
            const emptyState = document.getElementById('emptyQuoteState');
            const table = document.getElementById('quoteItemsTable');
            const tbody = document.getElementById('quoteItemsBody');
            
            if (state.quoteItems.length === 0) {
                emptyState.classList.remove('hidden');
                table.classList.add('hidden');
                return;
            }
            
            emptyState.classList.add('hidden');
            table.classList.remove('hidden');
            
            tbody.innerHTML = state.quoteItems.map((item, index) => {
                // Show tax category
                let taxBadge = '';
                if (item.taxCategory) {
                    const taxLabels = {
                        'taxable_gst': '<span class="inline-flex items-center px-1.5 py-0.5 rounded text-xs bg-blue-50 text-blue-700">ðŸ“‹ GST (10%)</span>',
                        'gst_free': '<span class="inline-flex items-center px-1.5 py-0.5 rounded text-xs bg-gray-50 text-gray-600">GST-Free</span>',
                        'input_taxed': '<span class="inline-flex items-center px-1.5 py-0.5 rounded text-xs bg-gray-50 text-gray-600">Input-Taxed</span>'
                    };
                    taxBadge = taxLabels[item.taxCategory] || '';
                }
                
                return `
                <tr class="border-b border-gray-100">
                    <td class="p-2">
                        <p class="font-medium text-gray-900">${item.name}</p>
                        <div class="mt-1 flex items-center gap-2">
                            ${getTypeIndicator(item.type)}
                            ${taxBadge}
                        </div>
                    </td>
                    <td class="p-2">
                        <div class="flex items-center gap-1 text-gray-600">
                            ${getPricingIcon(item.pricingType)}
                            <span class="text-xs">${item.unit}</span>
                        </div>
                    </td>
                    <td class="p-2 text-center">
                        <input 
                            type="number"
                            value="${item.quantity}"
                            onchange="updateItemQuantity(${index}, this.value)"
                            class="w-16 px-2 py-1 border border-gray-300 rounded text-center"
                            min="1"
                        />
                    </td>
                    <td class="p-2 text-right">
                        <input 
                            type="number"
                            value="${item.customPrice}"
                            onchange="updateItemPrice(${index}, this.value)"
                            class="w-20 px-2 py-1 border border-gray-300 rounded text-right"
                            min="0"
                            step="0.01"
                        />
                    </td>
                    <td class="p-2 text-right font-semibold">
                        $${(item.quantity * item.customPrice).toFixed(2)}
                    </td>
                    <td class="p-2">
                        <button 
                            onclick="removeQuoteItem(${index})"
                            class="text-red-600 hover:text-red-800"
                        >
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </td>
                </tr>
                <tr class="border-b border-gray-200">
                    <td colspan="6" class="p-2 pb-3">
                        <input 
                            type="text"
                            value="${item.notes || ''}"
                            onchange="updateItemNotes(${index}, this.value)"
                            placeholder="Add notes for this line item..."
                            class="w-full px-2 py-1 border border-gray-200 rounded text-xs text-gray-600"
                        />
                    </td>
                </tr>
            `;
            }).join('');
        }

        // Event handlers
        function selectCustomer(customerId) {
            const customer = customers.find(c => c.id === customerId);
            state.selectedCustomer = customer;
            
            document.getElementById('customerSearchSection').classList.add('hidden');
            document.getElementById('selectedCustomerCard').classList.remove('hidden');
            document.getElementById('selectedCustomerName').textContent = customer.name;
            document.getElementById('selectedCustomerEmail').textContent = customer.email;
            document.getElementById('selectedCustomerPhone').textContent = customer.phone;
            document.getElementById('selectedCustomerAddress').textContent = customer.address;
            
            updateSendButton();
        }

        function addQuoteItem(serviceId) {
            const services = getServices();
            const service = services.find(s => s.id === serviceId);
            
            if (!service) return;
            
            const newItem = {
                ...service,
                quantity: 1,
                customPrice: service.price,
                notes: ''
            };
            
            state.quoteItems.push(newItem);
            renderQuoteItems();
            updateSummary();
        }

        function removeQuoteItem(index) {
            state.quoteItems.splice(index, 1);
            renderQuoteItems();
            updateSummary();
        }

        function updateItemQuantity(index, value) {
            state.quoteItems[index].quantity = Number(value);
            renderQuoteItems();
            updateSummary();
        }

        function updateItemPrice(index, value) {
            state.quoteItems[index].customPrice = Number(value);
            renderQuoteItems();
            updateSummary();
        }

        function updateItemNotes(index, value) {
            state.quoteItems[index].notes = value;
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Set default valid until date (14 days from now)
            const validUntil = new Date();
            validUntil.setDate(validUntil.getDate() + 14);
            document.getElementById('validUntilDate').valueAsDate = validUntil;
            
            // Catalog search and filters
            document.getElementById('catalogSearchInput').addEventListener('input', renderServicesCatalog);
            document.getElementById('catalogFilterType').addEventListener('change', renderServicesCatalog);
            document.getElementById('catalogFilterCategory').addEventListener('change', renderServicesCatalog);
            
            // Customer search
            document.getElementById('customerSearchInput').addEventListener('input', function(e) {
                renderCustomerResults(e.target.value);
            });
            
            // Toggle new customer form
            document.getElementById('toggleNewCustomerBtn').addEventListener('click', function() {
                state.showNewCustomerForm = !state.showNewCustomerForm;
                document.getElementById('newCustomerForm').classList.toggle('hidden');
                document.getElementById('customerSearchSection').classList.toggle('hidden');
            });
            
            // Cancel new customer
            document.getElementById('cancelNewCustomerBtn').addEventListener('click', function() {
                state.showNewCustomerForm = false;
                document.getElementById('newCustomerForm').classList.add('hidden');
                document.getElementById('customerSearchSection').classList.remove('hidden');
            });
            
            // Create customer
            document.getElementById('createCustomerBtn').addEventListener('click', function() {
                const firstName = document.getElementById('newCustomerFirstName').value.trim();
                const lastName = document.getElementById('newCustomerLastName').value.trim();
                const company = document.getElementById('newCustomerCompany').value.trim();
                const email = document.getElementById('newCustomerEmail').value.trim();
                const phone = document.getElementById('newCustomerPhone').value.trim();
                const preferredContactMethod = document.getElementById('newCustomerPreferredContact').value;
                const street = document.getElementById('newCustomerStreet').value.trim();
                const city = document.getElementById('newCustomerCity').value.trim();
                const state = document.getElementById('newCustomerState').value.trim();
                const postalCode = document.getElementById('newCustomerPostalCode').value.trim();
                const country = document.getElementById('newCustomerCountry').value.trim();
                const notes = document.getElementById('newCustomerNotes').value.trim();
                
                // Validation
                if (!firstName || !lastName || !email) {
                    alert('Please fill in all required fields (First Name, Last Name, Email)');
                    return;
                }
                
                // Build address
                const addressParts = [street, city, state, postalCode, country].filter(p => p);
                const address = addressParts.join(', ') || '';
                
                const newCustomer = {
                    id: customers.length + 1,
                    name: `${firstName} ${lastName}`,
                    firstName: firstName,
                    lastName: lastName,
                    company: company,
                    email,
                    phone,
                    preferredContactMethod: preferredContactMethod,
                    address: address,
                    addressDetails: {
                        street: street,
                        city: city,
                        state: state,
                        postalCode: postalCode,
                        country: country
                    },
                    notes: notes,
                    previousQuotes: 0
                };
                
                customers.push(newCustomer);
                selectCustomer(newCustomer.id);
                
                state.showNewCustomerForm = false;
                document.getElementById('newCustomerForm').classList.add('hidden');
                
                // Clear form
                document.getElementById('newCustomerFirstName').value = '';
                document.getElementById('newCustomerLastName').value = '';
                document.getElementById('newCustomerCompany').value = '';
                document.getElementById('newCustomerEmail').value = '';
                document.getElementById('newCustomerPhone').value = '';
                document.getElementById('newCustomerPreferredContact').value = 'email';
                document.getElementById('newCustomerStreet').value = '';
                document.getElementById('newCustomerCity').value = '';
                document.getElementById('newCustomerState').value = '';
                document.getElementById('newCustomerPostalCode').value = '';
                document.getElementById('newCustomerCountry').value = 'Australia';
                document.getElementById('newCustomerNotes').value = '';
            });
            
            // Clear customer
            document.getElementById('clearCustomerBtn').addEventListener('click', function() {
                state.selectedCustomer = null;
                document.getElementById('selectedCustomerCard').classList.add('hidden');
                document.getElementById('customerSearchSection').classList.remove('hidden');
                updateSendButton();
            });
            
            // Discount changes
            document.getElementById('discountType').addEventListener('change', function(e) {
                state.discountType = e.target.value;
                document.getElementById('discountValue').step = e.target.value === 'percentage' ? '1' : '0.01';
                updateSummary();
            });
            
            document.getElementById('discountValue').addEventListener('input', function(e) {
                state.discount = Number(e.target.value);
                updateSummary();
            });
            
            // Send quote button
            document.getElementById('sendQuoteBtn').addEventListener('click', function() {
                if (!state.selectedCustomer) {
                    alert('Please select a customer');
                    return;
                }
                
                if (state.quoteItems.length === 0) {
                    alert('Please add at least one item to the quote');
                    return;
                }
                
                // Get all selected send methods
                const selectedMethods = Array.from(document.querySelectorAll('input[name="sendMethod"]:checked')).map(cb => cb.value);
                
                if (selectedMethods.length === 0) {
                    alert('Please select at least one send method');
                    return;
                }
                
                // Here you would normally send the quote data to the server
                console.log('Sending quote:', {
                    customer: state.selectedCustomer,
                    items: state.quoteItems,
                    discount: state.discount,
                    discountType: state.discountType,
                    total: calculateTotal(),
                    sendMethods: selectedMethods,
                    validUntil: document.getElementById('validUntilDate').value,
                    paymentTerms: document.getElementById('paymentTerms').value,
                    customerNotes: document.getElementById('customerNotes').value,
                    internalNotes: document.getElementById('internalNotes').value
                });
                
                alert(`Quote sent to ${state.selectedCustomer.name} via ${selectedMethods.join(', ')}!`);
            });
            
            // Print quote button
            document.getElementById('printQuoteBtn').addEventListener('click', function() {
                if (!state.selectedCustomer) {
                    alert('Please select a customer');
                    return;
                }
                
                if (state.quoteItems.length === 0) {
                    alert('Please add at least one item to the quote');
                    return;
                }
                
                console.log('Printing quote:', {
                    customer: state.selectedCustomer,
                    items: state.quoteItems,
                    discount: state.discount,
                    discountType: state.discountType,
                    total: calculateTotal(),
                    validUntil: document.getElementById('validUntilDate').value,
                    paymentTerms: document.getElementById('paymentTerms').value,
                    customerNotes: document.getElementById('customerNotes').value
                });
                
                alert('Opening print dialog...');
                // In a real implementation, this would trigger the browser's print dialog
                window.print();
            });
            
            // Save draft button
            document.getElementById('saveDraftBtn').addEventListener('click', function() {
                console.log('Saving draft:', state);
                alert('Quote saved as draft!');
            });
            
            // Preview button
            document.getElementById('previewBtn').addEventListener('click', function() {
                console.log('Preview quote:', state);
                alert('Preview functionality would open a modal or new window');
            });
            
            // Submit for approval
            document.getElementById('submitApprovalBtn').addEventListener('click', function() {
                console.log('Submitting for approval:', state);
                alert('Quote submitted for manager approval!');
            });
            
            // Initial render
            updateCategoryFilter(); // Initialize category dropdown
            renderCustomerResults();
            renderServicesCatalog();
            renderQuoteItems();
            updateSummary();
        });
    </script>
</body>
</html>

