<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invoice Details - Simplified - FMS</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen bg-gray-50">
    <div class="p-4">
        <div class="max-w-5xl mx-auto">
            <!-- Header -->
            <div class="bg-white rounded-lg shadow-sm p-6 mb-4">
                <div class="flex justify-between items-start">
                    <div class="flex-1">
                        <div class="flex items-center gap-3 mb-3">
                            <button onclick="window.location.href='invoice_list_simple.html'" class="p-2 hover:bg-gray-100 rounded-lg">
                                <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                                </svg>
                            </button>
                            <h1 class="text-3xl font-bold">Invoice Details</h1>
                            <span id="invoiceNumber" class="px-3 py-1.5 text-sm font-medium rounded-full bg-purple-100 text-purple-700">INV-2024-001</span>
                            <span id="statusBadge" class="px-3 py-1.5 text-sm font-medium rounded-full bg-yellow-100 text-yellow-700">Unpaid</span>
                        </div>
                    </div>
                    <button id="downloadPdfBtn" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                        </svg>
                        Download PDF
                    </button>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                <!-- Invoice Details -->
                <div class="lg:col-span-2 space-y-4">
                    <div class="bg-white rounded-lg shadow-sm p-6">
                        <h2 class="text-lg font-semibold mb-4">Invoice Information</h2>
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div>
                                <div class="text-xs text-gray-500">Invoice Date</div>
                                <div class="text-sm font-medium" id="invoiceDate">Nov 10, 2024</div>
                            </div>
                            <div>
                                <div class="text-xs text-gray-500">Due Date</div>
                                <div class="text-sm font-medium" id="dueDate">Dec 10, 2024</div>
                            </div>
                            <div>
                                <div class="text-xs text-gray-500">Payment Terms</div>
                                <div class="text-sm font-medium" id="paymentTermsDisplay">Net 30 Days</div>
                            </div>
                            <div>
                                <div class="text-xs text-gray-500">Amount Due</div>
                                <div class="text-sm font-bold text-purple-600" id="amountDue">$0.00</div>
                            </div>
                        </div>
                        
                        <!-- Quote Reference -->
                        <div class="mb-4 p-3 bg-blue-50 rounded-lg border border-blue-200">
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="text-xs text-blue-600 font-medium">Related Quote</div>
                                    <div class="text-sm font-semibold text-blue-800" id="relatedQuote">Q-2024-001</div>
                                </div>
                                <button 
                                    onclick="viewQuote()"
                                    class="px-3 py-1.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-xs font-medium"
                                >
                                    View Quote
                                </button>
                            </div>
                        </div>
                        
                        <!-- Payment Model -->
                        <div class="border-t border-gray-200 pt-4 mb-4">
                            <h3 class="text-sm font-semibold text-gray-900 mb-3">Payment Model</h3>
                            <div id="paymentModelInfo">
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="px-3 py-1.5 bg-purple-100 text-purple-700 rounded-lg text-sm font-medium" id="paymentModelBadge">Full Payment</span>
                                </div>
                                <div id="depositDetails" class="hidden p-3 bg-blue-50 rounded-lg space-y-1">
                                    <div class="flex justify-between text-sm">
                                        <span class="text-gray-700">Deposit Paid:</span>
                                        <span class="font-semibold text-gray-900" id="depositPaidAmount">$0.00</span>
                                    </div>
                                    <div class="flex justify-between text-sm">
                                        <span class="text-gray-700">Remaining Balance:</span>
                                        <span class="font-semibold text-orange-600" id="remainingBalanceAmount">$0.00</span>
                                    </div>
                                    <div class="text-xs text-gray-600 mt-2">
                                        ðŸ’¡ Remaining balance due after service completion
                                    </div>
                                </div>
                                <div id="subscriptionDetails" class="hidden p-3 bg-green-50 rounded-lg space-y-2">
                                    <div class="flex justify-between text-sm">
                                        <span class="text-gray-700">Billing Frequency:</span>
                                        <span class="font-semibold text-gray-900" id="billingFrequencyDisplay">Monthly</span>
                                    </div>
                                    <div class="flex justify-between text-sm">
                                        <span class="text-gray-700">Next Invoice:</span>
                                        <span class="font-semibold text-green-700" id="nextInvoiceDisplay">Dec 10, 2024</span>
                                    </div>
                                    <div class="flex justify-between text-sm">
                                        <span class="text-gray-700">Auto-charge:</span>
                                        <span class="font-semibold" id="autoChargeDisplay">
                                            <span class="text-green-600">âœ“ Enabled</span>
                                        </span>
                                    </div>
                                    <div id="subscriptionEndInfo" class="text-xs text-gray-600 mt-2 pt-2 border-t border-green-200">
                                        ðŸ“… <span id="subscriptionEndText">Ongoing subscription</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Accepted Payment Methods -->
                        <div class="border-t border-gray-200 pt-4">
                            <h3 class="text-sm font-semibold text-gray-900 mb-3">Accepted Payment Methods</h3>
                            <div class="flex flex-wrap gap-2" id="paymentMethodsDisplay">
                                <!-- Payment methods will be populated dynamically -->
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg shadow-sm p-6">
                        <h2 class="text-lg font-semibold mb-4">Line Items</h2>
                        <div id="lineItemsContainer" class="space-y-3"></div>
                        <div class="border-t mt-4 pt-4 space-y-2">
                            <div class="flex justify-between text-sm"><span>Subtotal (before discounts)</span><span id="subtotalBeforeDiscount">$0.00</span></div>
                            <div class="flex justify-between text-sm text-green-600" id="lineItemDiscountsRow" style="display: none;">
                                <span>Line Item Discounts</span>
                                <span id="lineItemDiscounts">-$0.00</span>
                            </div>
                            <div class="flex justify-between text-sm font-medium border-t pt-2">
                                <span>Subtotal</span>
                                <span id="subtotal">$0.00</span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span>Tax (GST 10%)</span>
                                <span id="tax">$0.00</span>
                            </div>
                            <div class="flex justify-between text-lg font-bold border-t-2 pt-2">
                                <span>Total Amount</span>
                                <span class="text-purple-600" id="total">$0.00</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Actions -->
                <div class="space-y-4">
                    <div class="bg-white rounded-lg shadow-sm p-4 sticky top-4">
                        <h2 class="text-lg font-semibold mb-4">Payment Status</h2>
                        <div class="p-4 bg-yellow-50 rounded-lg border border-yellow-200 mb-4">
                            <div class="text-xs text-yellow-600">Current Status</div>
                            <div class="text-xl font-bold text-yellow-700" id="currentStatus">Unpaid</div>
                        </div>
                        
                        <div id="unpaidActions" class="space-y-2">
                            <button id="sendPaymentLinkBtn" class="w-full bg-purple-600 text-white py-2.5 rounded-lg hover:bg-purple-700 flex items-center justify-center gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                                </svg>
                                Send Payment reminder
                            </button>
                            
                            <!-- Stripe Payment Status Check (shown only for Stripe invoices) -->
                            <div id="stripePaymentSection" class="hidden space-y-2">
                                <button id="checkStripePaymentBtn" class="w-full bg-blue-600 text-white py-2.5 rounded-lg hover:bg-blue-700 flex items-center justify-center gap-2">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                    </svg>
                                    Check Stripe Payment Status
                                </button>
                                <div id="stripePaymentStatus" class="hidden p-3 bg-blue-50 rounded-lg border border-blue-200 text-xs text-blue-700">
                                    <div class="flex items-center gap-2">
                                        <svg class="w-4 h-4 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                        </svg>
                                        <span>Checking payment status with Stripe...</span>
                                    </div>
                                </div>
                            </div>
                            
                            <button id="markAsPaidBtn" class="w-full bg-green-600 text-white py-2.5 rounded-lg hover:bg-green-700 flex items-center justify-center gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                </svg>
                                Mark as Paid (Manual)
                            </button>
                        </div>
                        
                        <div id="paidState" class="hidden p-4 bg-green-50 rounded-lg border border-green-200 text-center">
                            <svg class="w-12 h-12 text-green-600 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <div class="text-sm font-semibold text-green-700">Fully Paid</div>
                        </div>
                        
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mark as Paid Modal -->
    <div id="markPaidModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4 p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Mark Invoice as Paid</h3>
            
            <div class="space-y-4 mb-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Payment Date <span class="text-red-500">*</span></label>
                    <input type="date" id="paymentDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500" />
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Payment Method <span class="text-red-500">*</span></label>
                    <select id="paymentMethod" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                        <option value="">Select payment method...</option>
                        <option value="stripe">Stripe</option>
                        <option value="cash">Cash</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Transaction Reference</label>
                    <input type="text" id="transactionRef" placeholder="Transaction ID, check number, etc." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500" />
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Notes</label>
                    <textarea id="paymentNotes" rows="2" placeholder="Additional payment notes..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"></textarea>
                </div>
            </div>
            
            <div class="flex gap-3">
                <button onclick="closeMarkPaidModal()" class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
                    Cancel
                </button>
                <button onclick="confirmMarkAsPaid()" class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                    Mark as Paid
                </button>
            </div>
        </div>
    </div>

    <script>
        const invoiceData = {
            id: 'INV-2024-001',
            quoteId: 'Q-2024-001',
            status: 'unpaid',
            invoiceDate: '2024-11-10',
            dueDate: '2024-12-10',
            paymentModel: 'deposit', // 'full', 'deposit', or 'subscription'
            paymentMethod: 'stripe', // Single payment method selected (matches quote_edit_simple.html)
            paymentTerms: 'net_30',
            items: [
                { 
                    name: 'One-on-One Tutoring - Math', 
                    description: 'Grade 10 tutoring - 4 sessions',
                    type: 'service',
                    quantity: 4, 
                    unitPrice: 75.00, 
                    discount: 10, // 10% discount
                    discountType: 'percentage',
                    taxCategory: 'taxable_gst',
                    total: 270.00 // After discount
                },
                { 
                    name: 'Study Materials Package', 
                    description: 'Complete study materials for Grade 10',
                    type: 'product',
                    quantity: 1, 
                    unitPrice: 45.00,
                    discount: 0,
                    discountType: 'percentage',
                    taxCategory: 'taxable_gst',
                    total: 45.00
                }
            ],
            subtotal: 315.00,
            lineItemDiscounts: 30.00,
            subtotalAfterDiscount: 285.00,
            tax: 28.50, // 10% GST on taxable items
            total: 313.50,
            depositAmount: 156.75, // 50% deposit
            remainingBalance: 156.75,
            // Subscription details (if applicable)
            subscription: {
                frequency: 'monthly',
                startDate: '2024-11-10',
                nextInvoiceDate: '2024-12-10',
                autoCharge: true,
                endType: 'ongoing' // 'ongoing', 'after_cycles', 'end_date'
            }
        };

        // Payment method display configuration
        const paymentMethodConfig = {
            stripe: {
                name: 'Stripe',
                color: 'purple',
                icon: 'M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z'
            },
            paypal: {
                name: 'PayPal',
                color: 'blue',
                icon: 'M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z'
            },
            google_wallet: {
                name: 'Google Wallet',
                color: 'green',
                icon: 'M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9'
            },
            apple_pay: {
                name: 'Apple Pay',
                color: 'gray',
                icon: 'M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z'
            },
            cash: {
                name: 'Cash',
                color: 'yellow',
                icon: 'M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z'
            }
        };

        function initializePage() {
            const itemsContainer = document.getElementById('lineItemsContainer');
            itemsContainer.innerHTML = invoiceData.items.map(item => {
                const typeIndicator = item.type === 'product' 
                    ? '<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800">ðŸŸ¢ Product</span>'
                    : '<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800">ðŸ”µ Service</span>';
                
                const taxLabels = {
                    'taxable_gst': '<span class="inline-flex items-center px-1.5 py-0.5 rounded text-xs bg-blue-50 text-blue-700">ðŸ“‹ GST (10%)</span>',
                    'gst_free': '<span class="inline-flex items-center px-1.5 py-0.5 rounded text-xs bg-gray-50 text-gray-600">GST-Free</span>',
                    'input_taxed': '<span class="inline-flex items-center px-1.5 py-0.5 rounded text-xs bg-gray-50 text-gray-600">Input-Taxed</span>'
                };
                const taxBadge = taxLabels[item.taxCategory] || '';
                
                const lineTotal = item.quantity * item.unitPrice;
                const discountAmount = item.discountType === 'percentage' 
                    ? lineTotal * (item.discount / 100)
                    : item.discount;
                    
                return `
                    <div class="border border-gray-200 rounded-lg p-4 bg-gray-50">
                        <div class="flex justify-between items-start mb-2">
                            <div class="flex-1">
                                <div class="font-semibold text-sm text-gray-900 mb-1">${item.name}</div>
                                <div class="flex items-center gap-2 mb-1">
                                    ${typeIndicator}
                                    ${taxBadge}
                                </div>
                                <div class="text-xs text-gray-600">${item.description}</div>
                            </div>
                            <div class="text-right">
                                <div class="text-lg font-bold text-gray-900">$${item.total.toFixed(2)}</div>
                                ${item.discount > 0 ? `<div class="text-xs text-green-600">-$${discountAmount.toFixed(2)} discount</div>` : ''}
                            </div>
                        </div>
                        <div class="flex justify-between items-center text-xs text-gray-500 mt-2 pt-2 border-t border-gray-300">
                            <span>Qty: ${item.quantity} Ã— $${item.unitPrice.toFixed(2)}</span>
                            ${item.discount > 0 ? `<span class="text-green-600 font-medium">${item.discountType === 'percentage' ? item.discount + '% off' : '$' + item.discount.toFixed(2) + ' off'}</span>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
            
            // Display single selected payment method (read-only, matches payment configuration)
            const paymentMethodsContainer = document.getElementById('paymentMethodsDisplay');
            if (invoiceData.paymentMethod && paymentMethodConfig[invoiceData.paymentMethod]) {
                const config = paymentMethodConfig[invoiceData.paymentMethod];
                paymentMethodsContainer.innerHTML = `
                    <span class="inline-flex items-center gap-1.5 px-3 py-1.5 bg-${config.color}-50 text-${config.color}-700 rounded-lg text-xs font-medium">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${config.icon}"></path>
                        </svg>
                        ${config.name}
                    </span>
                `;
                
                // Show Stripe payment status check button if payment method is Stripe
                if (invoiceData.paymentMethod === 'stripe') {
                    document.getElementById('stripePaymentSection').classList.remove('hidden');
                }
            } else {
                paymentMethodsContainer.innerHTML = '<span class="text-xs text-gray-500">No payment method selected</span>';
            }
            
            // Display payment terms
            const termsMap = {
                'due_on_receipt': 'Due on Receipt',
                'net_7': 'Net 7 Days',
                'net_15': 'Net 15 Days',
                'net_30': 'Net 30 Days',
                'net_60': 'Net 60 Days'
            };
            document.getElementById('paymentTermsDisplay').textContent = termsMap[invoiceData.paymentTerms] || 'Net 30 Days';
            
            // Display payment model
            const paymentModelBadge = document.getElementById('paymentModelBadge');
            const depositDetails = document.getElementById('depositDetails');
            const subscriptionDetails = document.getElementById('subscriptionDetails');
            
            if (invoiceData.paymentModel === 'deposit') {
                paymentModelBadge.textContent = 'Down Payment (Deposit)';
                paymentModelBadge.className = 'px-3 py-1.5 bg-orange-100 text-orange-700 rounded-lg text-sm font-medium';
                depositDetails.classList.remove('hidden');
                document.getElementById('depositPaidAmount').textContent = `$${invoiceData.depositAmount.toFixed(2)}`;
                document.getElementById('remainingBalanceAmount').textContent = `$${invoiceData.remainingBalance.toFixed(2)}`;
            } else if (invoiceData.paymentModel === 'subscription') {
                paymentModelBadge.textContent = 'Subscription (Recurring)';
                paymentModelBadge.className = 'px-3 py-1.5 bg-green-100 text-green-700 rounded-lg text-sm font-medium';
                subscriptionDetails.classList.remove('hidden');
                
                // Display subscription info
                const frequencyMap = {
                    'weekly': 'Weekly',
                    'biweekly': 'Bi-weekly',
                    'monthly': 'Monthly',
                    'quarterly': 'Quarterly',
                    'yearly': 'Yearly'
                };
                document.getElementById('billingFrequencyDisplay').textContent = frequencyMap[invoiceData.subscription?.frequency] || 'Monthly';
                document.getElementById('nextInvoiceDisplay').textContent = invoiceData.subscription?.nextInvoiceDate 
                    ? new Date(invoiceData.subscription.nextInvoiceDate).toLocaleDateString() 
                    : 'TBD';
                
                if (invoiceData.subscription?.autoCharge) {
                    document.getElementById('autoChargeDisplay').innerHTML = '<span class="text-green-600">âœ“ Enabled</span>';
                } else {
                    document.getElementById('autoChargeDisplay').innerHTML = '<span class="text-gray-600">âœ— Disabled</span>';
                }
                
                // Display end info
                if (invoiceData.subscription?.endType === 'ongoing') {
                    document.getElementById('subscriptionEndText').textContent = 'Ongoing subscription (no end date)';
                } else if (invoiceData.subscription?.endType === 'after_cycles') {
                    document.getElementById('subscriptionEndText').textContent = `Ends after ${invoiceData.subscription.billingCycles} cycles`;
                } else if (invoiceData.subscription?.endDate) {
                    document.getElementById('subscriptionEndText').textContent = `Ends on ${new Date(invoiceData.subscription.endDate).toLocaleDateString()}`;
                }
            } else {
                paymentModelBadge.textContent = 'Full Payment (Upfront)';
                paymentModelBadge.className = 'px-3 py-1.5 bg-purple-100 text-purple-700 rounded-lg text-sm font-medium';
            }
            
            // Set today's date as default payment date
            document.getElementById('paymentDate').value = new Date().toISOString().split('T')[0];
            
            // Update all invoice summary values from invoiceData
            document.getElementById('amountDue').textContent = `$${invoiceData.total.toFixed(2)}`;
            document.getElementById('relatedQuote').textContent = invoiceData.quoteId || 'N/A';
            document.getElementById('subtotalBeforeDiscount').textContent = `$${invoiceData.subtotal.toFixed(2)}`;
            document.getElementById('lineItemDiscounts').textContent = `-$${invoiceData.lineItemDiscounts.toFixed(2)}`;
            document.getElementById('subtotal').textContent = `$${invoiceData.subtotalAfterDiscount.toFixed(2)}`;
            document.getElementById('tax').textContent = `$${invoiceData.tax.toFixed(2)}`;
            document.getElementById('total').textContent = `$${invoiceData.total.toFixed(2)}`;
            
            // Show/hide discount row based on actual discount amount
            const discountRow = document.getElementById('lineItemDiscountsRow');
            if (invoiceData.lineItemDiscounts > 0) {
                discountRow.style.display = 'flex';
            } else {
                discountRow.style.display = 'none';
            }
            
            // Update invoice date and due date if available
            if (invoiceData.invoiceDate) {
                document.getElementById('invoiceDate').textContent = new Date(invoiceData.invoiceDate).toLocaleDateString();
            }
            if (invoiceData.dueDate) {
                document.getElementById('dueDate').textContent = new Date(invoiceData.dueDate).toLocaleDateString();
            }
            
            // Update invoice number and status badge
            if (invoiceData.id) {
                document.getElementById('invoiceNumber').textContent = invoiceData.id;
            }
            if (invoiceData.status) {
                const statusBadge = document.getElementById('statusBadge');
                const statusColors = {
                    'paid': 'bg-green-100 text-green-700',
                    'unpaid': 'bg-yellow-100 text-yellow-700',
                    'cancelled': 'bg-gray-100 text-gray-700'
                };
                const statusText = invoiceData.status.charAt(0).toUpperCase() + invoiceData.status.slice(1);
                statusBadge.textContent = statusText;
                statusBadge.className = `px-3 py-1.5 text-sm font-medium rounded-full ${statusColors[invoiceData.status] || 'bg-gray-100 text-gray-700'}`;
                
                // Update current status display
                const currentStatus = document.getElementById('currentStatus');
                currentStatus.textContent = statusText;
                if (invoiceData.status === 'paid') {
                    currentStatus.className = 'text-xl font-bold text-green-700';
                    document.getElementById('unpaidActions').classList.add('hidden');
                    document.getElementById('paidState').classList.remove('hidden');
                } else {
                    currentStatus.className = 'text-xl font-bold text-yellow-700';
                }
            }
        }

        document.getElementById('sendPaymentLinkBtn').addEventListener('click', () => {
            alert('Payment link sent to customer via email!');
        });

        document.getElementById('markAsPaidBtn').addEventListener('click', () => {
            document.getElementById('markPaidModal').classList.remove('hidden');
        });

        // Stripe payment status check
        document.getElementById('checkStripePaymentBtn').addEventListener('click', () => {
            checkStripePaymentStatus();
        });

        function closeMarkPaidModal() {
            document.getElementById('markPaidModal').classList.add('hidden');
        }

        function confirmMarkAsPaid() {
            const paymentDate = document.getElementById('paymentDate').value;
            const paymentMethod = document.getElementById('paymentMethod').value;
            const transactionRef = document.getElementById('transactionRef').value;
            const notes = document.getElementById('paymentNotes').value;
            
            if (!paymentDate || !paymentMethod) {
                alert('Please fill in payment date and payment method');
                return;
            }
            
            // Create payment record
            const paymentRecord = {
                invoiceId: invoiceData.id,
                paymentDate: paymentDate,
                paymentMethod: paymentMethod,
                transactionRef: transactionRef,
                amount: invoiceData.total,
                notes: notes,
                recordedAt: new Date().toISOString()
            };
            
            console.log('Payment recorded:', paymentRecord);
            
            // Update UI
            document.getElementById('statusBadge').className = 'px-3 py-1.5 text-sm font-medium rounded-full bg-green-100 text-green-700';
            document.getElementById('statusBadge').textContent = 'Paid';
            document.getElementById('currentStatus').textContent = 'Paid';
            document.getElementById('unpaidActions').classList.add('hidden');
            document.getElementById('paidState').classList.remove('hidden');
            
            closeMarkPaidModal();
            alert('Invoice marked as paid successfully!');
        }

        // Check Stripe payment status (simulates webhook or API call)
        function checkStripePaymentStatus() {
            const statusDiv = document.getElementById('stripePaymentStatus');
            const checkBtn = document.getElementById('checkStripePaymentBtn');
            
            // Show loading state
            statusDiv.classList.remove('hidden');
            checkBtn.disabled = true;
            checkBtn.classList.add('opacity-50', 'cursor-not-allowed');
            
            // Simulate API call to Stripe to check payment status
            // In real implementation, this would call your backend API which queries Stripe
            setTimeout(() => {
                // Simulate checking payment status with Stripe
                // In production, this would be: fetch('/api/check-stripe-payment', { invoiceId: invoiceData.id })
                const mockStripeResponse = {
                    paid: Math.random() > 0.7, // 30% chance of being paid (for demo)
                    paymentIntentId: 'pi_' + Math.random().toString(36).substr(2, 9),
                    amount: invoiceData.total,
                    currency: 'usd',
                    status: 'succeeded' // or 'pending', 'failed', 'canceled'
                };
                
                if (mockStripeResponse.paid && mockStripeResponse.status === 'succeeded') {
                    // Payment confirmed by Stripe - automatically mark as paid
                    markInvoiceAsPaidFromStripe(mockStripeResponse);
                } else {
                    // Payment not found or not completed
                    statusDiv.innerHTML = `
                        <div class="flex items-center gap-2 text-yellow-700">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                            </svg>
                            <span>No successful payment found. Payment may still be pending or not completed.</span>
                        </div>
                    `;
                    checkBtn.disabled = false;
                    checkBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                }
            }, 1500); // Simulate 1.5 second API call
        }
        
        // Automatically mark invoice as paid when Stripe confirms payment
        function markInvoiceAsPaidFromStripe(stripeResponse) {
            const paymentDate = new Date().toISOString().split('T')[0];
            
            // Create payment record from Stripe response
            const paymentRecord = {
                invoiceId: invoiceData.id,
                paymentDate: paymentDate,
                paymentMethod: 'stripe',
                transactionRef: stripeResponse.paymentIntentId,
                amount: stripeResponse.amount,
                notes: `Automatically confirmed via Stripe payment intent ${stripeResponse.paymentIntentId}`,
                recordedAt: new Date().toISOString(),
                source: 'stripe_automatic' // Mark as automatically confirmed
            };
            
            console.log('Payment confirmed by Stripe:', paymentRecord);
            
            // Update invoice data
            invoiceData.status = 'paid';
            invoiceData.paidAmount = invoiceData.total;
            invoiceData.paymentDate = paymentDate;
            invoiceData.stripePaymentIntentId = stripeResponse.paymentIntentId;
            
            // Update UI
            document.getElementById('statusBadge').className = 'px-3 py-1.5 text-sm font-medium rounded-full bg-green-100 text-green-700';
            document.getElementById('statusBadge').textContent = 'Paid';
            document.getElementById('currentStatus').textContent = 'Paid';
            document.getElementById('currentStatus').className = 'text-xl font-bold text-green-700';
            document.getElementById('unpaidActions').classList.add('hidden');
            document.getElementById('paidState').classList.remove('hidden');
            document.getElementById('stripePaymentSection').classList.add('hidden');
            
            // Show success message
            const statusDiv = document.getElementById('stripePaymentStatus');
            statusDiv.innerHTML = `
                <div class="flex items-center gap-2 text-green-700">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                    <span>Payment confirmed! Invoice automatically marked as paid.</span>
                </div>
            `;
            
            // In production, this would also:
            // 1. Send receipt email to customer
            // 2. Update database
            // 3. Trigger any post-payment workflows
            // 4. Log the payment event
            
            alert(`âœ… Payment confirmed by Stripe!\n\nPayment Intent: ${stripeResponse.paymentIntentId}\nAmount: $${stripeResponse.amount.toFixed(2)}\n\nInvoice has been automatically marked as paid.`);
        }
        
        // Simulate Stripe webhook handler (for automatic payment confirmation)
        // In production, this would be called by your backend when Stripe sends a webhook
        function handleStripeWebhook(webhookData) {
            // This function would be called by your backend when Stripe sends a payment.succeeded webhook
            if (webhookData.type === 'payment_intent.succeeded' && 
                webhookData.data.object.metadata.invoiceId === invoiceData.id) {
                
                const stripeResponse = {
                    paid: true,
                    paymentIntentId: webhookData.data.object.id,
                    amount: webhookData.data.object.amount / 100, // Convert from cents
                    currency: webhookData.data.object.currency,
                    status: 'succeeded'
                };
                
                markInvoiceAsPaidFromStripe(stripeResponse);
            }
        }

        // Navigation functions
        function viewQuote() {
            const quoteId = invoiceData.quoteId || getQuoteId();
            window.location.href = `quote_edit_simple.html?id=${quoteId}`;
        }
        
        function getInvoiceId() {
            // Get from URL or page data
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('id') || 'INV-2024-001'; // Mock for now
        }

        function getQuoteId() {
            // Get from invoice data or URL
            return invoiceData?.quoteId || 'Q-2024-001'; // Mock for now
        }

        document.addEventListener('DOMContentLoaded', initializePage);
    </script>
</body>
</html>
