<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Quote - FMS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        /* Custom scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<body class="min-h-screen bg-gray-50">
    
    <div class="p-4">
        <div class="max-w-7xl mx-auto">
            
            <!-- Header -->
            <div class="bg-white rounded-lg shadow-sm p-4 mb-4">
                <div class="flex justify-between items-center">
                    <div>
                        <div class="flex items-center gap-3 mb-1">
                            <h1 class="text-2xl font-bold text-gray-900">Edit Quote</h1>
                            <span id="quoteIdBadge" class="px-3 py-1 bg-blue-100 text-blue-700 rounded-lg text-sm font-medium">Q-2024-001</span>
                            <span id="quoteStatusBadge" class="px-2 py-1 text-xs rounded bg-yellow-100 text-yellow-700">Draft</span>
                        </div>
                        <p class="text-gray-600 font-medium">Sunshine Tutoring - Melbourne East</p>
                    </div>
                    <div id="headerActions" class="flex gap-2">
                        <button 
                            onclick="window.location.href='quote_list_simple.html'"
                            class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 flex items-center gap-2"
                        >
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                            </svg>
                            Back to Quotes
                        </button>
                        <!-- Dynamic action buttons will be inserted here -->
                    </div>
                </div>
            </div>

            <!-- Status Information Banner (for non-editable statuses) -->
            <div id="statusInfoBanner" class="hidden mb-4"></div>

            <!-- Tab Navigation -->
            <div class="bg-white rounded-lg shadow-sm mb-4">
                <div class="border-b border-gray-200">
                    <nav class="flex space-x-8 px-6" aria-label="Tabs">
                        <button 
                            id="quoteDetailsTab"
                            class="tab-button active py-4 px-1 border-b-2 border-blue-500 font-medium text-sm text-blue-600"
                            onclick="switchTab('quoteDetails')"
                        >
                            Quote Details
                        </button>
                        <button 
                            id="paymentConfigTab"
                            class="tab-button py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300"
                            onclick="switchTab('paymentConfig')"
                        >
                            Payment Configuration
                        </button>
                        <button 
                            id="invoicesTab"
                            class="tab-button py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300"
                            onclick="switchTab('invoices')"
                        >
                            Invoices
                        </button>
                    </nav>
                </div>
            </div>

            <!-- Quote Details Tab Content -->
            <div id="quoteDetailsContent" class="tab-content">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                
                <!-- Left Column - Customer & Services -->
                <div class="lg:col-span-2 space-y-4">
                    
                    <!-- Customer Section -->
                    <div class="bg-white rounded-lg shadow-sm p-4">
                        <div class="mb-4">
                            <h2 class="text-lg font-semibold text-gray-900">Customer Information</h2>
                        </div>

                        <!-- Customer Search with Autocomplete -->
                        <div id="customerSearchSection" class="hidden">
                            <div class="relative">
                                <svg class="absolute left-3 top-3 text-gray-400 w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                </svg>
                                <input
                                    type="text"
                                    id="customerSearchInput"
                                    placeholder="Type to search customer by name, email, or phone... (Required)"
                                    class="w-full pl-10 pr-10 py-2 border border-red-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"
                                    autocomplete="off"
                                    required
                                />
                                <button id="clearSearchBtn" class="hidden absolute right-3 top-3 text-gray-400 hover:text-gray-600">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                </button>
                                <!-- Autocomplete Dropdown -->
                                <div id="customerAutocomplete" class="hidden absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto custom-scrollbar">
                                    <!-- Autocomplete results will be populated here -->
                                </div>
                            </div>
                        </div>

                        <!-- Selected Customer Card -->
                        <div id="selectedCustomerCard">
                            <div class="border border-blue-300 rounded-lg p-3 bg-blue-50">
                                <div class="flex justify-between items-start mb-3">
                                    <div class="flex-1">
                                        <div class="flex items-center gap-2">
                                            <p class="font-semibold text-gray-900" id="selectedCustomerName"></p>
                                            <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800">Selected</span>
                                        </div>
                                        <p class="text-sm text-gray-600 mt-1" id="selectedCustomerEmail"></p>
                                        <p class="text-sm text-gray-600" id="selectedCustomerPhone"></p>
                                    </div>
                                            <button 
                                        id="clearCustomerBtn"
                                        class="p-2 text-red-600 hover:text-red-700 hover:bg-red-50 rounded-lg transition-colors"
                                        title="Remove customer and select again"
                                    >
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                                </svg>
                                            </button>
                                </div>
                                
                                <!-- Quote Contact Selector (if secondary contacts exist) -->
                                <div id="quoteContactSelector" class="hidden border-t border-blue-200 pt-3 mt-3">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Quote Contact</label>
                                    <select id="quoteContactSelect" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white">
                                        <!-- Options populated dynamically -->
                                    </select>
                                    <p class="text-xs text-gray-500 mt-1">Select who should receive this quote</p>
                                </div>
                                
                                <!-- Service Address Section -->
                                <div class="border-t border-blue-200 pt-3 mt-3">
                                    <div class="flex items-center justify-between mb-2">
                                        <h3 class="text-sm font-medium text-gray-700">Service Address</h3>
                                        <label class="flex items-center gap-2 text-xs text-gray-600">
                                            <input type="checkbox" id="sameAsBilling" checked class="rounded" />
                                            <span>Same as customer address</span>
                                        </label>
                                    </div>
                                    <div id="serviceAddressFields" class="hidden space-y-2">
                                        <div>
                                            <label class="block text-xs text-gray-600 mb-1">Service Location</label>
                                            <input type="text" id="serviceStreet" placeholder="Enter service address" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" />
                                        </div>
                                        <div>
                                            <label class="block text-xs text-gray-600 mb-1">Access Instructions</label>
                                            <textarea id="serviceAddressNotes" rows="2" placeholder="Gate codes, parking info, entry instructions, etc." class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                                        </div>
                                    </div>
                                    <div id="serviceAddressDisplay" class="text-sm text-gray-600" style="display: block;">
                                        <span id="displayServiceAddress"></span>
                                    </div>
                                </div>

                            </div>
                        </div>

                        <!-- New Customer Form (Hidden in edit mode) -->
                        <div id="newCustomerForm" class="hidden" style="display: none;">
                            <!-- Name Fields -->
                            <div class="grid grid-cols-2 gap-3">
                                <div class="form-group">
                                    <label for="newCustomerFirstName" class="block text-sm font-medium text-gray-700 mb-1">First Name *</label>
                                    <input type="text" id="newCustomerFirstName" placeholder="John" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" required />
                                </div>
                                <div class="form-group">
                                    <label for="newCustomerLastName" class="block text-sm font-medium text-gray-700 mb-1">Last Name *</label>
                                    <input type="text" id="newCustomerLastName" placeholder="Doe" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" required />
                                </div>
                            </div>
                            
                            <!-- Company -->
                            <div class="form-group">
                                <label for="newCustomerCompany" class="block text-sm font-medium text-gray-700 mb-1">Company</label>
                                <input type="text" id="newCustomerCompany" placeholder="ABC Corp" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" />
                            </div>
                            
                            <!-- Contact Information -->
                            <div class="border-t border-gray-200 pt-3">
                                <h3 class="text-sm font-medium text-gray-700 mb-3">Contact Information</h3>
                                <div class="form-group">
                                    <label for="newCustomerEmail" class="block text-sm font-medium text-gray-700 mb-1">Email *</label>
                                    <input type="email" id="newCustomerEmail" placeholder="john@example.com" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" required />
                                </div>
                                <div class="form-group mt-3">
                                    <label for="newCustomerPhone" class="block text-sm font-medium text-gray-700 mb-1">Phone</label>
                                    <input type="tel" id="newCustomerPhone" placeholder="+1 234 567 8900" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" />
                                </div>
                                <div class="form-group mt-3">
                                    <label for="newCustomerWhatsApp" class="block text-sm font-medium text-gray-700 mb-1">
                                        WhatsApp Number
                                        <span class="text-xs text-gray-500">(for quote delivery)</span>
                                    </label>
                                    <input type="tel" id="newCustomerWhatsApp" placeholder="+61 412 345 678" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" />
                                </div>
                                <div class="form-group mt-3">
                                    <label for="newCustomerPreferredContact" class="block text-sm font-medium text-gray-700 mb-1">Preferred Contact Method</label>
                                    <select id="newCustomerPreferredContact" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="email">Email</option>
                                        <option value="phone">Phone</option>
                                        <option value="whatsapp">WhatsApp</option>
                                        <option value="none">None</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Address -->
                            <div class="border-t border-gray-200 pt-3">
                                <h3 class="text-sm font-medium text-gray-700 mb-3">Address</h3>
                                <div class="form-group">
                                    <label for="newCustomerStreet" class="block text-sm font-medium text-gray-700 mb-1">Street</label>
                                    <input type="text" id="newCustomerStreet" placeholder="123 Main St" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" />
                                </div>
                                <div class="grid grid-cols-2 gap-3 mt-3">
                                    <div class="form-group">
                                        <label for="newCustomerCity" class="block text-sm font-medium text-gray-700 mb-1">City</label>
                                        <input type="text" id="newCustomerCity" placeholder="New York" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" />
                                    </div>
                                    <div class="form-group">
                                        <label for="newCustomerState" class="block text-sm font-medium text-gray-700 mb-1">State</label>
                                        <input type="text" id="newCustomerState" placeholder="NY" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" />
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-3 mt-3">
                                    <div class="form-group">
                                        <label for="newCustomerPostalCode" class="block text-sm font-medium text-gray-700 mb-1">Postal Code</label>
                                        <input type="text" id="newCustomerPostalCode" placeholder="10001" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" />
                                    </div>
                                    <div class="form-group">
                                        <label for="newCustomerCountry" class="block text-sm font-medium text-gray-700 mb-1">Country</label>
                                        <input type="text" id="newCustomerCountry" placeholder="Australia" value="Australia" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" />
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Notes -->
                            <div class="border-t border-gray-200 pt-3">
                                <h3 class="text-sm font-medium text-gray-700 mb-3">Notes</h3>
                                <textarea id="newCustomerNotes" placeholder="Additional notes about the customer" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                            </div>
                            
                            <!-- Actions -->
                            <div class="flex gap-2 border-t border-gray-200 pt-3">
                                <button 
                                    id="cancelNewCustomerBtn"
                                    class="flex-1 px-3 py-2 border border-gray-300 text-gray-700 rounded-lg text-sm hover:bg-gray-50"
                                >
                                    Cancel
                                </button>
                                <button 
                                    id="createCustomerBtn"
                                    class="flex-1 px-3 py-2 bg-blue-600 text-white rounded-lg text-sm hover:bg-blue-700"
                                >
                                    Create & Select
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Quote Line Items -->
                    <div class="bg-white rounded-lg shadow-sm p-4">
                        <h2 class="text-lg font-semibold text-gray-900 mb-4">Quote Line Items <span class="text-red-500">*</span></h2>
                        
                        <!-- Add Service/Product Search -->
                        <div class="mb-4">
                            <div class="relative">
                                <svg class="absolute left-3 top-3 text-gray-400 w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                </svg>
                                <input 
                                    type="text" 
                                    id="catalogSearchInput"
                                    placeholder="Type to search and add services or products..."
                                    class="w-full pl-10 pr-10 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"
                                    autocomplete="off"
                                />
                                <button id="clearCatalogSearchBtn" class="hidden absolute right-3 top-3 text-gray-400 hover:text-gray-600">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                </button>
                                <!-- Autocomplete Dropdown -->
                                <div id="catalogAutocomplete" class="hidden absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-80 overflow-y-auto custom-scrollbar">
                                    <!-- Autocomplete results will be populated here -->
                                </div>
                            </div>
                        </div>
                        
                        <div id="emptyQuoteState" class="text-center py-12 text-gray-500 bg-gray-50 rounded-lg border-2 border-dashed border-gray-300">
                            <svg class="mx-auto mb-3 text-gray-400 w-12 h-12" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                            </svg>
                            <p class="text-sm font-medium text-gray-700 mb-1">No items added yet</p>
                            <p class="text-xs text-gray-500">Search and add services or products above to build your quote</p>
                        </div>

                        <!-- Card-based Quote Items Container -->
                        <div id="quoteItemsContainer" class="hidden space-y-3">
                            <!-- Quote item cards will be populated here -->
                        </div>
                    </div>
                </div>

                <!-- Right Column - Summary & Actions -->
                <div class="space-y-4">
                    
                    <!-- Pricing Summary -->
                    <div class="bg-white rounded-lg shadow-sm p-4 sticky top-4">
                        <h2 class="text-lg font-semibold text-gray-900 mb-4">Quote Summary</h2>
                        
                        <div class="space-y-3 mb-4">
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-600">Subtotal</span>
                                <span class="font-medium" id="subtotalAmount">$0.00</span>
                            </div>

                            <!-- Line Item Discounts Summary -->
                            <div id="lineItemDiscountSection" class="hidden">
                                <div class="flex justify-between text-sm">
                                    <span class="text-sm text-gray-600">Line Item Discounts</span>
                                    <span class="text-sm font-medium text-red-600" id="lineItemDiscountAmount">-$0.00</span>
                                </div>
                            </div>

                            <!-- Tax Breakdown by Category -->
                            <div class="border-t border-gray-200 pt-3">
                                <div class="text-xs text-gray-600 mb-2">Tax Breakdown:</div>
                                <div id="taxBreakdown" class="space-y-1 text-xs">
                                    <!-- Tax breakdown will be populated here -->
                                </div>
                                <div class="flex justify-between items-center mt-2 pt-2 border-t border-gray-100">
                                    <span class="text-sm text-gray-600">Total Tax</span>
                                    <span class="text-sm font-medium" id="taxAmount">$0.00</span>
                                </div>
                            </div>

                            <div class="border-t-2 border-gray-300 pt-3">
                                <div class="flex justify-between">
                                    <span class="font-bold text-gray-900 text-lg">Total</span>
                                    <span class="font-bold text-gray-900 text-lg" id="totalAmount">$0.00</span>
                                </div>
                            </div>
                        </div>

                        <!-- Quote Details -->
                        <div class="border-t border-gray-200 pt-4 space-y-3">
                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-1">Valid Until</label>
                                <input 
                                    type="date" 
                                    id="validUntilDate"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                                />
                            </div>

                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-1">Notes for Customer</label>
                                <textarea 
                                    id="customerNotes"
                                    rows="3"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    placeholder="Terms, conditions, or special notes..."
                                ></textarea>
                            </div>

                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-1">Internal Notes</label>
                                <textarea 
                                    id="internalNotes"
                                    rows="2"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    placeholder="Private notes (not visible to customer)..."
                                ></textarea>
                            </div>
                        </div>
                        <!-- Action Buttons (Dynamic based on status) -->
                        <div id="sidebarActions" class="mt-4 space-y-2">
                            <!-- Buttons will be dynamically populated based on status -->
                        </div>
                    </div>
                </div>
            </div>
            </div>

            <!-- Payment Configuration Tab Content -->
            <div id="paymentConfigContent" class="tab-content hidden">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                    
                    <!-- Left Column - Payment Configuration -->
                    <div class="lg:col-span-2 space-y-4">
                        
                        <!-- Payment Model Section -->
                        <div class="bg-white rounded-lg shadow-sm p-6">
                            <h2 class="text-lg font-semibold text-gray-900 mb-4">Payment Model</h2>
                            
                            <div class="space-y-3">
                                <label class="flex items-start gap-3 p-3 border-2 border-purple-300 bg-purple-50 rounded-lg cursor-pointer">
                                    <input type="radio" name="paymentModel" value="full" checked class="mt-1" onchange="updatePaymentModel()" />
                                    <div class="flex-1">
                                        <div class="font-semibold text-gray-900">Full Payment (Upfront)</div>
                                        <div class="text-xs text-gray-600 mt-1">Customer pays entire amount upfront before service begins</div>
                                    </div>
                                </label>
                                <label class="flex items-start gap-3 p-3 border-2 border-gray-200 rounded-lg cursor-pointer hover:border-purple-300 hover:bg-purple-50">
                                    <input type="radio" name="paymentModel" value="deposit" class="mt-1" onchange="updatePaymentModel()" />
                                    <div class="flex-1">
                                        <div class="font-semibold text-gray-900">Down Payment (Deposit)</div>
                                        <div class="text-xs text-gray-600 mt-1">Customer pays deposit now, remaining balance later</div>
                                    </div>
                                </label>
                                <label class="flex items-start gap-3 p-3 border-2 border-gray-200 rounded-lg cursor-pointer hover:border-purple-300 hover:bg-purple-50">
                                    <input type="radio" name="paymentModel" value="subscription" class="mt-1" onchange="updatePaymentModel()" />
                                    <div class="flex-1">
                                        <div class="font-semibold text-gray-900">Subscription (Recurring)</div>
                                        <div class="text-xs text-gray-600 mt-1">Automatic recurring invoices at regular intervals</div>
                                    </div>
                                </label>
                            </div>

                            <!-- Subscription Settings (shown when subscription selected) -->
                            <div id="subscriptionSection" class="hidden mt-4 p-4 bg-gray-50 rounded-lg">
                                <h3 class="text-sm font-medium text-gray-700 mb-3">Subscription Settings</h3>
                                <div class="space-y-3">
                                    <div>
                                        <label class="block text-xs text-gray-600 mb-1">Billing Frequency</label>
                                        <select id="billingFrequency" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                                            <option value="weekly">Weekly</option>
                                            <option value="biweekly">Bi-weekly (Every 2 weeks)</option>
                                            <option value="monthly" selected>Monthly</option>
                                            <option value="quarterly">Quarterly (Every 3 months)</option>
                                            <option value="yearly">Yearly</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-xs text-gray-600 mb-1">Subscription Start Date</label>
                                        <input type="date" id="subscriptionStartDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500" />
                                    </div>
                                    <div>
                                        <label class="block text-xs text-gray-600 mb-1">Subscription End (Optional)</label>
                                        <select id="subscriptionEnd" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500" onchange="toggleEndDate()">
                                            <option value="ongoing">Ongoing (No end date)</option>
                                            <option value="after_cycles">After specific number of cycles</option>
                                            <option value="end_date">Specific end date</option>
                                        </select>
                                    </div>
                                    <div id="cyclesInput" class="hidden">
                                        <label class="block text-xs text-gray-600 mb-1">Number of Billing Cycles</label>
                                        <input type="number" id="billingCycles" min="1" placeholder="e.g., 12" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500" />
                                    </div>
                                    <div id="endDateInput" class="hidden">
                                        <label class="block text-xs text-gray-600 mb-1">End Date</label>
                                        <input type="date" id="subscriptionEndDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500" />
                                    </div>
                                    <div class="flex items-center gap-2 p-2 bg-green-50 rounded">
                                        <input type="checkbox" id="autoCharge" checked class="rounded text-green-600" />
                                        <label for="autoCharge" class="text-xs text-green-800">
                                            <strong>Auto-charge enabled</strong> - Automatically charge customer on billing date
                                        </label>
                                    </div>
                                    <div class="p-2 bg-blue-50 rounded text-xs text-blue-800">
                                        <strong>Next Invoice:</strong> <span id="nextInvoiceDate">-</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Deposit Amount (shown when deposit selected) -->
                            <div id="paymentDepositSection" class="hidden mt-4 p-4 bg-gray-50 rounded-lg">
                                <h3 class="text-sm font-medium text-gray-700 mb-3">Deposit Amount</h3>
                                <div class="space-y-2">
                                    <div class="flex gap-2">
                                        <div class="flex-1">
                                            <div class="relative">
                                                <span class="absolute left-3 top-2.5 text-gray-500">$</span>
                                                <input 
                                                    type="number" 
                                                    id="depositAmount"
                                                    placeholder="0.00"
                                                    min="0"
                                                    step="0.01"
                                                    class="w-full pl-7 pr-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                                                    oninput="updateDepositCalculation()"
                                                />
                                            </div>
                                        </div>
                                        <div class="flex-1">
                                            <div class="relative">
                                                <input 
                                                    type="number" 
                                                    id="depositPercentage"
                                                    placeholder="0"
                                                    min="0"
                                                    max="100"
                                                    step="1"
                                                    class="w-full pr-8 pl-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                                                    oninput="updateDepositFromPercentage()"
                                                />
                                                <span class="absolute right-3 top-2.5 text-gray-500">%</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="flex gap-2">
                                        <button type="button" onclick="setDepositPercentage(25)" class="flex-1 px-3 py-1.5 text-xs border border-gray-300 rounded hover:bg-gray-50">25%</button>
                                        <button type="button" onclick="setDepositPercentage(50)" class="flex-1 px-3 py-1.5 text-xs border border-gray-300 rounded hover:bg-gray-50">50%</button>
                                        <button type="button" onclick="setDepositPercentage(75)" class="flex-1 px-3 py-1.5 text-xs border border-gray-300 rounded hover:bg-gray-50">75%</button>
                                    </div>
                                    <div class="p-2 bg-blue-50 rounded text-xs text-blue-800">
                                        <strong>Remaining Balance:</strong> <span id="remainingBalance">$0.00</span> (due after service completion)
                                    </div>
                                </div>
                            </div>

                        </div>

                        <!-- Accepted Payment Methods Section -->
                        <div class="bg-white rounded-lg shadow-sm p-6">
                            <h2 class="text-lg font-semibold text-gray-900 mb-4">Accepted Payment Methods</h2>
                            
                            <div id="paymentMethodsContainer" class="space-y-2">
                                <label class="flex items-center gap-2 p-2 border-2 border-purple-300 bg-purple-50 rounded hover:bg-purple-100 cursor-pointer">
                                    <input type="radio" name="paymentMethod" id="paymentStripe" value="stripe" checked class="text-purple-600" onchange="updatePaymentMethodsDisplay()" />
                                    <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path>
                                    </svg>
                                    <span class="text-sm font-medium">Stripe</span>
                                </label>
                                <label class="flex items-center gap-2 p-2 border border-gray-200 rounded hover:bg-gray-50 cursor-pointer">
                                    <input type="radio" name="paymentMethod" id="paymentCash" value="cash" class="text-purple-600" onchange="updatePaymentMethodsDisplay()" />
                                    <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path>
                                    </svg>
                                    <span class="text-sm font-medium">Cash</span>
                                </label>
                            </div>
                            <p class="text-xs text-gray-500 mt-2" id="paymentMethodHint">Select one payment method</p>
                        </div>

                        <!-- Payment Terms Section -->
                        <div class="bg-white rounded-lg shadow-sm p-6">
                            <h2 class="text-lg font-semibold text-gray-900 mb-4">Payment Terms</h2>
                            
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Default Payment Terms</label>
                                    <select 
                                        id="defaultPaymentTerms"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                                    >
                                        <option value="due_on_receipt">Due on Receipt</option>
                                        <option value="net_7">Net 7 Days</option>
                                        <option value="net_15">Net 15 Days</option>
                                        <option value="net_30" selected>Net 30 Days</option>
                                        <option value="net_60">Net 60 Days</option>
                                    </select>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Payment Instructions</label>
                                    <textarea 
                                        id="paymentInstructions"
                                        rows="3"
                                        placeholder="Payment instructions, terms, or special notes..."
                                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                                    ></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- Invoice Distribution Section (Moved to Invoice Preview Modal) -->
                        <div class="bg-white rounded-lg shadow-sm p-6 hidden">
                            <div class="mb-4">
                                <h2 class="text-lg font-semibold text-gray-900 mb-2">Invoice Distribution</h2>
                                <div class="text-xs text-gray-500">
                                    Configure how invoices are distributed among multiple payers. This applies to your selected payment model.
                                </div>
                            </div>

                            <!-- Invoice Distribution Table -->
                            <div class="space-y-4">
                                <!-- Add Payer Section -->
                                <div class="flex items-center justify-between">
                                    <label class="text-sm font-medium text-gray-700">Payers</label>
                                    <div class="flex items-center gap-2">
                                        <select id="contactSelector" class="px-3 py-1 border border-gray-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-purple-500">
                                            <option value="">Select contact to add...</option>
                                            <option value="contact1">John Smith - john@company.com</option>
                                            <option value="contact2">Sarah Johnson - sarah@business.com</option>
                                            <option value="contact3">Mike Wilson - mike@corp.com</option>
                                            <option value="quick-add">+ Quick Add New Contact</option>
                                        </select>
                                        <button 
                                            id="addSelectedPayerBtn"
                                            class="px-3 py-1 bg-purple-600 text-white text-sm rounded hover:bg-purple-700 transition-colors"
                                        >
                                            Add
                                        </button>
                                    </div>
                                </div>

                                <!-- Payers Table -->
                                <div class="border border-gray-200 rounded-lg overflow-hidden">
                                    <table class="w-full">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Contact</th>
                                                <th class="px-4 py-2 text-center text-xs font-medium text-gray-700 uppercase tracking-wider">Percentage</th>
                                                <th class="px-4 py-2 text-center text-xs font-medium text-gray-700 uppercase tracking-wider">Amount</th>
                                                <th class="px-4 py-2 text-center text-xs font-medium text-gray-700 uppercase tracking-wider">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="payersTableBody" class="bg-white divide-y divide-gray-200">
                                            <!-- Default Primary Contact Row -->
                                            <tr id="primaryPayerRow">
                                                <td class="px-4 py-3">
                                                    <div class="flex items-center">
                                                        <div class="w-8 h-8 bg-purple-100 rounded-full flex items-center justify-center mr-3">
                                                            <svg class="w-4 h-4 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                                            </svg>
                                                        </div>
                                                        <div>
                                                            <div class="text-sm font-medium text-gray-900">Primary Contact</div>
                                                            <div class="text-xs text-gray-500">contact@company.com</div>
                                                        </div>
                                                    </div>
                                                </td>
                                                <td class="px-4 py-3 text-center">
                                                    <input 
                                                        type="number" 
                                                        value="100" 
                                                        min="0" 
                                                        max="100" 
                                                        class="w-16 px-2 py-1 text-center border border-gray-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-purple-500"
                                                        onchange="updatePayerCalculations()"
                                                    />
                                                    <span class="text-xs text-gray-500 ml-1">%</span>
                                                </td>
                                                <td class="px-4 py-3 text-right">
                                                    <span class="text-sm font-medium text-gray-900" id="primaryPayerAmount">$2,500.00</span>
                                                </td>
                                                <td class="px-4 py-3 text-center">
                                                    <span class="px-2 py-1 bg-blue-100 text-blue-700 text-xs rounded-full font-medium">Primary</span>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>

                                <!-- Summary Row -->
                                <div class="bg-gray-50 border border-gray-200 rounded-lg p-3">
                                    <div class="flex justify-between items-center text-sm">
                                        <span class="font-medium text-gray-700">Total:</span>
                                        <div class="flex items-center gap-4">
                                            <span id="totalPercentage" class="font-medium text-gray-900">100%</span>
                                            <span id="totalAmount" class="font-bold text-gray-900">$2,500.00</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Validation Warning -->
                                <div id="distributionValidationWarning" class="hidden bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                                    <div class="flex items-start gap-2">
                                        <svg class="w-4 h-4 text-yellow-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                                        </svg>
                                        <p class="text-xs text-yellow-800" id="distributionValidationMessage">Total percentage must equal 100%</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Right Column - Payment Summary -->
                    <div class="space-y-4">
                        
                        <!-- Payment Configuration Summary -->
                        <div class="bg-white rounded-lg shadow-sm p-4 sticky top-4">
                            <h2 class="text-lg font-semibold text-gray-900 mb-4">Payment Configuration Summary</h2>
                            
                            <div class="space-y-3 mb-4">
                                <div class="p-3 bg-purple-50 rounded-lg">
                                    <div class="text-xs text-purple-600 mb-1">Payment Model</div>
                                    <div class="text-lg font-bold text-purple-700" id="paymentModelDisplay">Full Payment</div>
                                </div>

                                <div class="space-y-2 text-sm">
                                    <div id="depositInfo" class="hidden">
                                        <div class="flex justify-between text-xs">
                                            <span class="text-gray-600">Deposit Amount</span>
                                            <span class="text-gray-900 font-semibold" id="depositAmountDisplay">$0.00</span>
                                        </div>
                                        <div class="flex justify-between text-xs">
                                            <span class="text-gray-600">Remaining Balance</span>
                                            <span class="text-gray-600" id="remainingBalanceDisplay">$0.00</span>
                                        </div>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Payment Terms</span>
                                        <span class="text-gray-900 font-medium" id="paymentTermsDisplay">Net 30 Days</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Payment Methods</span>
                                        <span class="text-gray-900 font-medium" id="paymentMethodsDisplay">2 selected</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Auto-save Indicator -->
                            <div class="mt-4 p-3 bg-green-50 rounded-lg border border-green-200">
                                <div class="flex items-center gap-2">
                                    <svg class="w-4 h-4 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                                    </svg>
                                    <p class="text-xs text-green-800">
                                        <strong>Auto-saved</strong> - Changes are saved automatically
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Invoices Tab Content -->
            <div id="invoicesContent" class="tab-content hidden">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                    
                    <!-- Left Column - Invoice Management -->
                    <div class="lg:col-span-2 space-y-4">
                        
                        <!-- Payment Configuration Summary Section -->
                        <div class="bg-white rounded-lg shadow-sm p-6">
                            <div class="flex items-center justify-between mb-4">
                                <h2 class="text-lg font-semibold text-gray-900">Payment Configuration Summary</h2>
                                    <button 
                                        onclick="switchTab('paymentConfig')"
                                    class="text-sm text-blue-600 hover:text-blue-700"
                                    >
                                        Edit Settings
                                    </button>
                                </div>
                                
                            <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                                <div class="grid grid-cols-3 gap-4 text-sm">
                                    <div>
                                        <div class="text-xs text-gray-600 mb-1">Payment Model</div>
                                        <div class="font-medium text-gray-900" id="invoiceTabPaymentModel">Full Payment</div>
                                    </div>
                                    <div>
                                        <div class="text-xs text-gray-600 mb-1">Payment Terms</div>
                                        <div class="font-medium text-gray-900" id="invoiceTabPaymentTerms">Net 30 Days</div>
                                            </div>
                                    <div>
                                        <div class="text-xs text-gray-600 mb-1">Payment Methods</div>
                                        <div class="font-medium text-gray-900" id="invoiceTabPaymentMethods">Stripe</div>
                                            </div>
                                        </div>
                                
                                <div id="invoiceTabDepositInfo" class="hidden mt-3 pt-3 border-t border-gray-200">
                                    <div class="grid grid-cols-2 gap-4 text-sm">
                                        <div>
                                            <span class="text-gray-600">Deposit Amount:</span>
                                            <span class="font-medium text-gray-900 ml-2" id="invoiceTabDepositAmount">$0.00</span>
                                        </div>
                                        <div>
                                            <span class="text-gray-600">Remaining Balance:</span>
                                            <span class="font-medium text-gray-900 ml-2" id="invoiceTabRemainingBalance">$0.00</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>


                        <!-- Invoice Management Section -->
                        <div class="bg-white rounded-lg shadow-sm p-6">
                            <div class="flex items-center justify-between mb-4">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center gap-3">
                                        <div class="w-8 h-8 bg-blue-500 rounded-lg flex items-center justify-center">
                                            <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5.586a1 1 0 0 1 .707.293l5.414 5.414a1 1 0 0 1 .293.707V19a2 2 0 0 1-2 2z"></path>
                                            </svg>
                                        </div>
                                        <div>
                                            <h2 class="text-lg font-bold text-gray-900">Invoice Management</h2>
                                            <p class="text-xs text-gray-500" id="invoiceCount">0 Invoices</p>
                                        </div>
                                    </div>
                                    <button 
                                        onclick="refreshInvoices()"
                                        class="px-4 py-2 bg-white border border-gray-300 text-gray-700 text-sm font-medium rounded-lg hover:bg-gray-50 transition-all flex items-center gap-2"
                                    >
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 0 0 4.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 0 1-15.357-2m15.357 2H15"></path>
                                        </svg>
                                        Refresh
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Overdue Warning Banner -->
                            <div id="overdueWarningBanner" class="hidden mb-4 bg-red-50 border-l-4 border-red-600 p-4 rounded">
                                <div class="flex items-start">
                                    <div class="flex-shrink-0">
                                        <svg class="w-5 h-5 text-red-600" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                                        </svg>
                                    </div>
                                    <div class="ml-3 flex-1">
                                        <h3 class="text-sm font-bold text-red-800" id="overdueWarningTitle">Overdue Invoices</h3>
                                        <p class="text-xs text-red-700 mt-1" id="overdueWarningMessage">You have overdue invoices that require immediate attention.</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div id="invoicesList" class="space-y-3">
                                <!-- Invoices will be populated here -->
                            </div>
                            
                            <div id="noInvoicesState" class="text-center py-8 text-gray-500">
                                <svg class="mx-auto mb-3 text-gray-400 w-12 h-12" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5.586a1 1 0 0 1 .707.293l5.414 5.414a1 1 0 0 1 .293.707V19a2 2 0 0 1-2 2z"></path>
                                </svg>
                                <p class="text-sm font-medium text-gray-700 mb-1">No invoices created yet</p>
                                <p class="text-xs text-gray-500">Click "Generatevoices" to generate invoices based on your payment configuration</p>
                            </div>

                        </div>
                    </div>

                    <!-- Right Column - Invoice Summary -->
                    <div class="lg:col-span-1 space-y-4">
                        
                        <!-- Invoice Summary -->
                        <div class="bg-white rounded-lg shadow-sm p-4 sticky top-4">
                            <h2 class="text-lg font-semibold text-gray-900 mb-4">Invoice Summary</h2>

                            <!-- Quote-style Financial Breakdown -->
                            <div class="space-y-3 mb-4">
                                <div class="flex justify-between text-sm">
                                    <span class="text-gray-600">Subtotal</span>
                                    <span class="font-medium" id="invoiceSubtotalAmount">$0.00</span>
                                </div>

                                <div id="invoiceLineItemDiscountSection" class="hidden">
                                    <div class="flex justify-between text-sm">
                                        <span class="text-sm text-gray-600">Line Item Discounts</span>
                                        <span class="text-sm font-medium text-red-600" id="invoiceLineItemDiscountAmount">-$0.00</span>
                                    </div>
                                </div>

                                <div class="border-t border-gray-200 pt-3">
                                    <div class="text-xs text-gray-600 mb-2">Tax Breakdown:</div>
                                    <div id="invoiceTaxBreakdown" class="space-y-1 text-xs">
                                        <div class="text-gray-400">No taxable items</div>
                                    </div>
                                    <div class="flex justify-between items-center mt-2 pt-2 border-t border-gray-100">
                                        <span class="text-sm text-gray-600">Total Tax</span>
                                        <span class="text-sm font-medium" id="invoiceTaxAmount">$0.00</span>
                                    </div>
                                </div>

                                <div class="border-t-2 border-gray-300 pt-3">
                                    <div class="flex justify-between">
                                        <span class="font-bold text-gray-900 text-lg">Quote Total</span>
                                        <span class="font-bold text-gray-900 text-lg" id="invoiceQuoteTotal">$0.00</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Financial Breakdown -->
                            <div class="space-y-2 text-sm mb-4">
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Total Invoiced</span>
                                        <span class="font-medium text-gray-900" id="totalInvoiced">$0.00</span>
                                    </div>
                                    
                                    <!-- Down Payment Breakdown (shown only for deposit payment model) -->
                                    <div id="downPaymentBreakdown" class="hidden space-y-1 pt-2 border-t border-gray-200">
                                        <div class="flex justify-between text-xs">
                                            <span class="text-gray-500">Deposit Invoiced:</span>
                                            <span class="font-medium text-gray-700" id="depositInvoiced">$0.00</span>
                                        </div>
                                        <div class="flex justify-between text-xs">
                                            <span class="text-gray-500">Balance Invoiced:</span>
                                            <span class="font-medium text-gray-700" id="balanceInvoiced">$0.00</span>
                                        </div>
                                        <div class="flex justify-between text-xs pt-1 border-t border-gray-100">
                                            <span class="text-gray-500">Remaining Balance:</span>
                                            <span class="font-semibold text-blue-600" id="remainingBalanceToInvoice">$0.00</span>
                                        </div>
                                    </div>
                                    
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Total Paid</span>
                                        <span class="font-medium text-green-600" id="totalPaid">$0.00</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Outstanding</span>
                                        <span class="font-medium text-red-600" id="totalOutstanding">$0.00</span>
                                    </div>
                                    <div class="flex justify-between border-t border-gray-200 pt-2">
                                        <span class="text-gray-600">Remaining to Invoice</span>
                                        <span class="font-semibold text-blue-600" id="remainingToInvoice">$0.00</span>
                                </div>
                            </div>

                            <!-- Invoice Status -->
                            <div class="border-t border-gray-200 pt-3 mb-3">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-sm font-medium text-gray-700">Invoice Status</span>
                                    <span id="invoiceStatusBadge" class="px-2 py-1 bg-gray-100 text-gray-700 rounded text-xs font-medium">Not Invoiced</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-2">
                                    <div id="invoiceProgressBar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                                </div>
                                <p class="text-xs text-gray-500 mt-1" id="invoiceProgressText">0% of quote amount invoiced</p>
                            </div>

                            <!-- Quick Actions -->
                            <div class="border-t border-gray-200 pt-3">
                                <h3 class="text-sm font-medium text-gray-700 mb-2">Quick Actions</h3>
                                <div class="space-y-2">
                                    <button 
                                        onclick="sendPaymentReminder()"
                                        class="w-full text-left px-3 py-2 text-sm text-gray-700 hover:bg-gray-50 rounded-lg flex items-center gap-2"
                                    >
                                        <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                                        </svg>
                                        Send Payment Reminder
                                    </button>
                                    <button 
                                        onclick="viewPaymentHistory()"
                                        class="w-full text-left px-3 py-2 text-sm text-gray-700 hover:bg-gray-50 rounded-lg flex items-center gap-2"
                                    >
                                        <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path>
                                        </svg>
                                        View Payment History
                                    </button>
                                    <button 
                                        onclick="downloadInvoiceReport()"
                                        class="w-full text-left px-3 py-2 text-sm text-gray-700 hover:bg-gray-50 rounded-lg flex items-center gap-2"
                                    >
                                        <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5.586a1 1 0 0 1 .707.293l5.414 5.414a1 1 0 0 1 .293.707V19a2 2 0 0 1-2 2z"></path>
                                        </svg>
                                        Download Invoice Report
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Generate Invoices Button -->
                                    <button 
                                id="createInvoicesBtn"
                                        onclick="createInvoices()"
                                class="w-full mt-4 px-4 py-3 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 flex items-center justify-center gap-2"
                                    >
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                                        </svg>
                                        Generate Invoices
                                    </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- PDF Preview Modal -->
    <div id="pdfPreviewModal" class="hidden fixed inset-0 bg-black bg-opacity-75 z-50 flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-xl w-full mx-4 max-w-6xl max-h-[95vh] flex flex-col">
            <div class="p-4 border-b border-gray-200 flex items-center justify-between">
                <h3 class="text-lg font-semibold text-gray-900">PDF Preview</h3>
                    <div class="flex gap-2">
                    <button id="downloadPdfFromPreview" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm font-medium flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                            </svg>
                            Download PDF
                        </button>
                    <button id="closePdfPreview" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 text-sm">
                            Close
                        </button>
                    </div>
                </div>
                
            <div class="flex-1 overflow-hidden">
                <iframe id="pdfPreviewFrame" class="w-full h-full" style="min-height: 600px;"></iframe>
                </div>
        </div>
    </div>

    <!-- Record Payment Modal -->
    <div id="recordPaymentModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-xl w-full mx-4 max-w-md">
            <div class="p-6 border-b border-gray-200">
                <h3 class="text-lg font-semibold text-gray-900">Confirm Full Payment</h3>
                <p class="text-sm text-gray-500 mt-1">Record that this invoice has been paid in full</p>
            </div>
            
            <div class="p-6 space-y-4">
                <!-- Invoice Info -->
                <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                    <div class="flex items-center justify-between mb-2">
                        <div class="text-sm text-gray-600">Invoice Number</div>
                        <div class="font-semibold text-gray-900" id="paymentInvoiceId">-</div>
                    </div>
                    <div class="flex items-center justify-between pt-2 border-t border-gray-300">
                        <div class="text-sm text-gray-600">Payment Amount</div>
                        <div class="text-2xl font-bold text-green-600" id="paymentOutstanding">$0.00</div>
                    </div>
                </div>

                <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                    <p class="text-sm text-blue-800">
                        <strong>Note:</strong> This will record full payment for the outstanding amount and mark the invoice as paid.
                    </p>
                </div>
                
                <!-- Payment Date -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Payment Date *</label>
                    <input 
                        type="date" 
                        id="paymentDate" 
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                    />
                </div>

                <!-- Payment Notes (Optional) -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Notes (Optional)</label>
                    <textarea 
                        id="paymentNotes" 
                        rows="3"
                        placeholder="Add any additional notes about this payment..."
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                    ></textarea>
                </div>
            </div>
            
            <div class="p-6 border-t border-gray-200 flex items-center justify-end gap-3">
                <button 
                    onclick="closeRecordPaymentModal()"
                    class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50"
                >
                    Cancel
                </button>
                <button 
                    onclick="confirmRecordPayment()"
                    class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-medium"
                >
                    Confirm Full Payment
                </button>
            </div>
        </div>
    </div>

    <!-- Price Modification Modal -->
    <div id="priceModModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
            <div class="p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-900">Modify Price</h3>
                    <button id="closePriceModModal" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                
                <div class="mb-4">
                    <div class="flex items-center gap-2 mb-2">
                        <p class="text-sm font-medium text-gray-900" id="priceModItemName"></p>
                        <span id="priceModItemType"></span>
                    </div>
                    <div class="flex items-center gap-2 text-sm">
                        <span class="text-gray-600">Original Price:</span>
                        <span class="font-medium" id="priceModOriginal"></span>
                    </div>
                    <div class="flex items-center gap-2 text-sm mt-1">
                        <span class="text-gray-600">New Price:</span>
                        <span class="font-semibold text-blue-600" id="priceModNew"></span>
                    </div>
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Reason for modification <span class="text-red-600">*</span></label>
                    <textarea 
                        id="priceModComment"
                        rows="3"
                        placeholder="Enter reason for price modification (required for record keeping)"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                    ></textarea>
                </div>
                
                <div class="flex gap-3">
                    <button id="cancelPriceModBtn" class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 text-sm font-medium">
                        Cancel
                    </button>
                    <button id="savePriceModBtn" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm font-medium">
                        Save Changes
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Invoice Preview Modal -->
    <div id="invoicePreviewModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-2xl max-w-7xl w-full max-h-[95vh] overflow-hidden flex flex-col">
            <!-- Modal Header -->
            <div class="bg-white rounded-t-lg shadow-sm p-6 border-b border-gray-200">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-4">
                        <div class="w-14 h-14 bg-gradient-to-br from-blue-600 to-indigo-600 rounded-xl flex items-center justify-center shadow-lg">
                            <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5.586a1 1 0 0 1 .707.293l5.414 5.414a1 1 0 0 1 .293.707V19a2 2 0 0 1-2 2z"></path>
                            </svg>
                        </div>
                        <div>
                            <h3 class="text-2xl font-bold text-gray-900">Invoice Preview</h3>
                            <p class="text-sm text-gray-600 mt-1">Review and configure invoices before creation</p>
                        </div>
                    </div>
                    <div class="flex gap-3">
                        <button 
                            id="createAllInvoicesBtn"
                            class="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 font-semibold flex items-center gap-2 shadow-md hover:shadow-lg transition-all duration-200"
                        >
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                            </svg>
                            Confirm & Generate
                        </button>
                        <button 
                            id="closeInvoicePreviewBtn"
                            class="px-5 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 font-medium transition-colors"
                        >
                            Cancel
                        </button>
                    </div>
                </div>
            </div>

            <div class="flex-1 overflow-y-auto custom-scrollbar p-6">
                <!-- Invoice Distribution Section (shown when multiple payers can be configured) -->
                <div id="invoiceDistributionSection" class="hidden mb-6 bg-white rounded-lg shadow-sm p-6 border border-purple-200 bg-gradient-to-br from-purple-50 to-indigo-50">
                    <div class="mb-5">
                        <div class="flex items-center gap-2 mb-2">
                            <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                            </svg>
                            <h3 class="text-lg font-semibold text-gray-900">Invoice Distribution</h3>
                        </div>
                        <p class="text-sm text-gray-600">
                            Configure how invoices are distributed among multiple payers. Adjust percentages and amounts below.
                        </p>
                    </div>

                    <!-- Add Payer Section -->
                    <div class="flex items-center justify-between mb-4">
                        <label class="text-sm font-medium text-gray-700">Payers</label>
                        <div class="flex items-center gap-2">
                            <select id="modalContactSelector" class="px-3 py-1 border border-gray-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-purple-500">
                                <option value="">Select contact to add...</option>
                                <option value="contact1">John Smith - john@company.com</option>
                                <option value="contact2">Sarah Johnson - sarah@business.com</option>
                                <option value="contact3">Mike Wilson - mike@corp.com</option>
                                <option value="quick-add">+ Quick Add New Contact</option>
                            </select>
                            <button 
                                id="modalAddSelectedPayerBtn"
                                class="px-3 py-1 bg-purple-600 text-white text-sm rounded hover:bg-purple-700 transition-colors"
                            >
                                Add
                            </button>
                        </div>
                    </div>

                    <!-- Payers Table -->
                    <div class="bg-white border border-gray-300 rounded-lg overflow-hidden mb-4 shadow-sm">
                        <table class="w-full">
                            <thead class="bg-gradient-to-r from-gray-50 to-gray-100">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Contact</th>
                                    <th class="px-4 py-3 text-center text-xs font-semibold text-gray-700 uppercase tracking-wider">Percentage</th>
                                    <th class="px-4 py-3 text-center text-xs font-semibold text-gray-700 uppercase tracking-wider">Amount</th>
                                    <th class="px-4 py-3 text-center text-xs font-semibold text-gray-700 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="modalPayersTableBody" class="bg-white divide-y divide-gray-200">
                                <!-- Payers will be populated here -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Summary Row -->
                    <div class="bg-gradient-to-r from-gray-50 to-gray-100 border-2 border-gray-300 rounded-lg p-4 mb-4">
                        <div class="flex justify-between items-center">
                            <span class="text-sm font-semibold text-gray-700 uppercase tracking-wide">Total:</span>
                            <div class="flex items-center gap-6">
                                <div class="text-center">
                                    <div class="text-xs text-gray-600 mb-1">Percentage</div>
                                    <span id="modalTotalPercentage" class="text-lg font-bold text-green-600">100%</span>
                                </div>
                                <div class="text-center">
                                    <div class="text-xs text-gray-600 mb-1">Amount</div>
                                    <span id="modalTotalAmount" class="text-xl font-bold text-gray-900">$0.00</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Validation Warning -->
                    <div id="modalDistributionValidationWarning" class="hidden bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                        <div class="flex items-start gap-2">
                            <svg class="w-4 h-4 text-yellow-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                            </svg>
                            <p class="text-xs text-yellow-800" id="modalDistributionValidationMessage">Total percentage must equal 100%</p>
                        </div>
                    </div>
                </div>

                <div id="invoicePreviewContent" class="space-y-6">
                    <!-- Invoice previews will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Existing quote data (would normally come from server/API)
        const existingQuote = {
            id: 'Q-2024-001',
            status: 'draft', // draft, sent, approved, rejected, expired, invoiced
            createdDate: '2024-10-20',
            validUntil: '2024-11-03',
            customerNotes: 'Thank you for your interest in our tutoring services.',
            internalNotes: 'Customer prefers morning sessions.'
        };

        // Status configuration for actions and permissions
        const statusConfig = {
            draft: {
                label: ' Draft',
                color: 'bg-yellow-100 text-yellow-700',
                canEdit: true,
                canDelete: true,
                actions: [
                    { id: 'save', label: 'Save Changes', color: 'gray', icon: 'save' },
                    { id: 'send', label: 'Send Quote', color: 'blue', icon: 'send', primary: true },
                    { id: 'download', label: 'Download PDF', color: 'gray', icon: 'download' },
                    { id: 'delete', label: 'Delete', color: 'red', icon: 'trash' }
                ]
            },
            sent: {
                label: ' Sent',
                color: 'bg-blue-100 text-blue-700',
                canEdit: true,
                canDelete: false,
                actions: [
                    { id: 'save', label: 'Save Changes', color: 'gray', icon: 'save' },
                    { id: 'resend', label: 'Resend Quote', color: 'green', icon: 'send' },
                    { id: 'approve', label: 'Mark as Approved', color: 'green', icon: 'check', primary: true },
                    { id: 'reject', label: 'Mark as Rejected', color: 'red', icon: 'x' },
                    { id: 'download', label: 'Download PDF', color: 'gray', icon: 'download' }
                ]
            },
            approved: {
                label: ' Approved',
                color: 'bg-green-100 text-green-700',
                canEdit: false,
                canDelete: false,
                actions: [
                    { id: 'createInvoice', label: 'Create Invoice', color: 'purple', icon: 'invoice', primary: true },
                    { id: 'download', label: 'Download PDF', color: 'gray', icon: 'download' },
                    { id: 'clone', label: 'Clone Quote', color: 'blue', icon: 'copy' }
                ]
            },
            rejected: {
                label: ' Rejected',
                color: 'bg-red-100 text-red-700',
                canEdit: false,
                canDelete: false,
                actions: [
                    { id: 'clone', label: 'Clone Quote', color: 'blue', icon: 'copy', primary: true },
                    { id: 'download', label: 'Download PDF', color: 'gray', icon: 'download' },
                    { id: 'archive', label: 'Archive', color: 'gray', icon: 'archive' }
                ]
            },
            expired: {
                label: ' Expired',
                color: 'bg-orange-100 text-orange-700',
                canEdit: false,
                canDelete: false,
                actions: [
                    { id: 'renew', label: 'Renew Quote', color: 'blue', icon: 'refresh', primary: true },
                    { id: 'clone', label: 'Clone Quote', color: 'blue', icon: 'copy' },
                    { id: 'download', label: 'Download PDF', color: 'gray', icon: 'download' },
                    { id: 'archive', label: 'Archive', color: 'gray', icon: 'archive' }
                ]
            },
            invoiced: {
                label: ' Invoiced',
                color: 'bg-purple-100 text-purple-700',
                canEdit: false,
                canDelete: false,
                actions: [
                    { id: 'viewInvoices', label: 'View Invoices', color: 'purple', icon: 'invoice', primary: true },
                    { id: 'createInvoice', label: 'Create Invoice', color: 'purple', icon: 'plus' },
                    { id: 'download', label: 'Download PDF', color: 'gray', icon: 'download' }
                ]
            }
        };

        // State management - Pre-populated with existing quote data for edit mode
        const state = {
            businessType: 'tutoring',
            quoteId: existingQuote.id,
            quoteStatus: existingQuote.status,
            selectedCustomer: {
                id: 1,
                name: 'Alice Anderson',
                email: 'alice.a@email.com',
                phone: '0412 345 678',
                address: '1 Albert St, Melbourne VIC 3000',
                previousQuotes: 3,
                secondaryContacts: [
                    { name: 'John Anderson', email: 'john.a@email.com', phone: '0412 345 679', role: 'Spouse' }
                ]
            },
            selectedQuoteContact: {
                type: 'primary',
                name: 'Alice Anderson',
                email: 'alice.a@email.com',
                phone: '0412 345 678'
            },
            showNewCustomerForm: false,
            quoteItems: [
                {
                    id: 't1',
                    name: 'One-on-One Tutoring - Math',
                    tag: 'Tutoring',
                    type: 'service',
                    price: 75,
                    customPrice: 75,
                    originalPrice: 75,
                    pricingType: 'per_hour',
                    unit: 'hour',
                    taxCategory: 'taxable_gst',
                    quantity: 2,
                    priceModified: false,
                    priceModificationComment: '',
                    notes: 'Focus on algebra and geometry',
                    serviceDate: '2024-10-25',
                    discount: 0,
                    discountType: 'percentage',
                    preferredTime: 'morning',
                    exactTime: '',
                    scheduleNotes: 'Prefer Monday and Wednesday'
                },
                {
                    id: 't4',
                    name: 'Assessment & Report',
                    tag: 'Assessment',
                    type: 'service',
                    price: 120,
                    customPrice: 120,
                    originalPrice: 120,
                    pricingType: 'fixed',
                    unit: 'each',
                    taxCategory: 'taxable_gst',
                    quantity: 1,
                    priceModified: false,
                    priceModificationComment: '',
                    notes: '',
                    serviceDate: '2024-10-28',
                    discount: 0,
                    discountType: 'percentage',
                    preferredTime: '',
                    exactTime: '',
                    scheduleNotes: ''
                }
            ],
            currentPriceModIndex: null,
            currentPriceModNewValue: null
        };

        // Sample data - Customers A-Z
        const customers = [
            { 
                id: 1, 
                name: 'Alice Anderson', 
                email: 'alice.a@email.com', 
                phone: '0412 345 678', 
                address: '1 Albert St, Melbourne VIC 3000', 
                previousQuotes: 3,
                secondaryContacts: [
                    { name: 'John Anderson', email: 'john.a@email.com', phone: '0412 345 679', role: 'Spouse' }
                ]
            },
            { 
                id: 2, 
                name: 'Bob Brown', 
                email: 'bob.brown@email.com', 
                phone: '0413 456 789', 
                address: '2 Bridge Rd, Richmond VIC 3121', 
                previousQuotes: 5,
                secondaryContacts: [
                    { name: 'Sarah Brown', email: 'sarah.b@email.com', phone: '0413 456 790', role: 'Assistant' },
                    { name: 'Mike Brown', email: 'mike.b@email.com', phone: '0413 456 791', role: 'Business Partner' }
                ]
            },
            { id: 3, name: 'Charlie Chen', email: 'charlie.c@email.com', phone: '0414 567 890', address: '3 Chapel St, Windsor VIC 3181', previousQuotes: 2 },
            { id: 4, name: 'David Davis', email: 'david.d@email.com', phone: '0412 444 444', address: '4 Docklands Dr, Docklands VIC 3008', previousQuotes: 0 },
            { id: 5, name: 'Emily Evans', email: 'emily.evans@email.com', phone: '0412 555 555', address: '5 Elizabeth St, Melbourne VIC 3000', previousQuotes: 2 },
            { id: 6, name: 'Frank Foster', email: 'frank.f@email.com', phone: '0412 666 666', address: '6 Flinders St, Melbourne VIC 3000', previousQuotes: 4 },
            { id: 7, name: 'Grace Garcia', email: 'grace.g@email.com', phone: '0412 777 777', address: '7 Glenferrie Rd, Hawthorn VIC 3122', previousQuotes: 1 },
            { id: 8, name: 'Henry Harris', email: 'henry.h@email.com', phone: '0412 888 888', address: '8 High St, Kew VIC 3101', previousQuotes: 6 },
            { id: 9, name: 'Isabella Ibrahim', email: 'isabella.i@email.com', phone: '0412 999 999', address: '9 Inkerman St, St Kilda VIC 3182', previousQuotes: 0 },
            { id: 10, name: 'James Johnson', email: 'james.j@email.com', phone: '0413 111 111', address: '10 Johnston St, Fitzroy VIC 3065', previousQuotes: 3 },
            { id: 11, name: 'Katherine Kim', email: 'kate.kim@email.com', phone: '0413 222 222', address: '11 King St, Melbourne VIC 3000', previousQuotes: 2 },
            { id: 12, name: 'Liam Lee', email: 'liam.lee@email.com', phone: '0413 333 333', address: '12 Lygon St, Carlton VIC 3053', previousQuotes: 7 },
            { id: 13, name: 'Maria Martinez', email: 'maria.m@email.com', phone: '0413 444 444', address: '13 Main Rd, Eltham VIC 3095', previousQuotes: 1 },
            { id: 14, name: 'Nathan Nguyen', email: 'nathan.n@email.com', phone: '0413 555 555', address: '14 Nicholson St, Fitzroy VIC 3065', previousQuotes: 4 },
            { id: 15, name: "Olivia O'Connor", email: 'olivia.o@email.com', phone: '0413 666 666', address: '15 Ormond Rd, Elwood VIC 3184', previousQuotes: 0 },
            { id: 16, name: 'Patrick Patel', email: 'patrick.p@email.com', phone: '0413 777 777', address: '16 Park St, South Melbourne VIC 3205', previousQuotes: 5 },
            { id: 17, name: 'Quinn Roberts', email: 'quinn.r@email.com', phone: '0413 888 888', address: '17 Queen St, Melbourne VIC 3000', previousQuotes: 2 },
            { id: 18, name: 'Rachel Robinson', email: 'rachel.r@email.com', phone: '0413 999 999', address: '18 Royal Pde, Parkville VIC 3052', previousQuotes: 3 },
            { id: 19, name: 'Samuel Smith', email: 'sam.smith@email.com', phone: '0414 111 111', address: '19 Smith St, Collingwood VIC 3066', previousQuotes: 8 },
            { id: 20, name: 'Taylor Thompson', email: 'taylor.t@email.com', phone: '0414 222 222', address: '20 Toorak Rd, South Yarra VIC 3141', previousQuotes: 1 },
            { id: 21, name: 'Uma Patel', email: 'uma.patel@email.com', phone: '0414 333 333', address: '21 Union St, Windsor VIC 3181', previousQuotes: 0 },
            { id: 22, name: 'Victor Vasquez', email: 'victor.v@email.com', phone: '0414 444 444', address: '22 Victoria St, Richmond VIC 3121', previousQuotes: 4 },
            { id: 23, name: 'Wendy White', email: 'wendy.w@email.com', phone: '0414 555 555', address: '23 Wellington St, St Kilda VIC 3182', previousQuotes: 2 },
            { id: 24, name: 'Xavier Xu', email: 'xavier.x@email.com', phone: '0414 666 666', address: '24 Xavier St, Kew VIC 3101', previousQuotes: 6 },
            { id: 25, name: 'Yasmin Young', email: 'yasmin.y@email.com', phone: '0414 777 777', address: '25 York St, South Melbourne VIC 3205', previousQuotes: 1 },
            { id: 26, name: 'Zachary Zhang', email: 'zach.zhang@email.com', phone: '0414 888 888', address: '26 Zoe St, Brunswick VIC 3056', previousQuotes: 3 }
        ];

        const tutoringServices = [
            // Services with GST (10% tax)
            { id: 't1', name: 'One-on-One Tutoring - Math', tag: 'Tutoring', type: 'service', price: 75, pricingType: 'per_hour', unit: 'hour', taxCategory: 'taxable_gst' },
            { id: 't2', name: 'One-on-One Tutoring - English', tag: 'Tutoring', type: 'service', price: 75, pricingType: 'per_hour', unit: 'hour', taxCategory: 'taxable_gst' },
            { id: 't3', name: 'Small Group (2-4 students)', tag: 'Group', type: 'service', price: 50, pricingType: 'per_hour', unit: 'hour', taxCategory: 'taxable_gst' },
            { id: 't4', name: 'Assessment & Report', tag: 'Assessment', type: 'service', price: 120, pricingType: 'fixed', unit: 'each', taxCategory: 'taxable_gst' },
            
            // Services GST-Free (0% tax)
            { id: 't5', name: 'Educational Counseling Service', tag: 'Support', type: 'service', price: 80, pricingType: 'per_hour', unit: 'hour', taxCategory: 'gst_free' },
            { id: 't6', name: 'Learning Disability Assessment', tag: 'Assessment', type: 'service', price: 150, pricingType: 'fixed', unit: 'each', taxCategory: 'gst_free' },
            
            // Services Input-Taxed (0% tax)
            { id: 't7', name: 'Tutoring Consultation Fee', tag: 'Consultation', type: 'service', price: 60, pricingType: 'fixed', unit: 'each', taxCategory: 'input_taxed' },
            
            // Products with GST (10% tax)
            { id: 'p1', name: 'Study Materials Package', tag: 'Materials', type: 'product', price: 45, pricingType: 'per_unit', unit: 'each', taxCategory: 'taxable_gst' },
            { id: 'p2', name: 'Textbook Bundle', tag: 'Materials', type: 'product', price: 120, pricingType: 'per_unit', unit: 'each', taxCategory: 'taxable_gst' },
            { id: 'p3', name: 'Practice Test Series', tag: 'Materials', type: 'product', price: 35, pricingType: 'per_unit', unit: 'each', taxCategory: 'taxable_gst' },
            
            // Products GST-Free (0% tax)
            { id: 'p4', name: 'Educational Books', tag: 'Materials', type: 'product', price: 25, pricingType: 'per_unit', unit: 'each', taxCategory: 'gst_free' },
            { id: 'p5', name: 'Basic Learning Materials', tag: 'Materials', type: 'product', price: 15, pricingType: 'per_unit', unit: 'each', taxCategory: 'gst_free' },
        ];

        // ============================================================================
        // STATUS MANAGEMENT FUNCTIONS
        // ============================================================================

        // Check if quote is expired
        function isQuoteExpired() {
            if (!existingQuote.validUntil) return false;
            const validUntil = new Date(existingQuote.validUntil);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            validUntil.setHours(0, 0, 0, 0);
            return validUntil < today;
        }

        // Get current effective status (auto-detect expired)
        function getCurrentStatus() {
            if (existingQuote.status !== 'expired' && isQuoteExpired()) {
                // Auto-detect expired status and sync
                existingQuote.status = 'expired';
                state.quoteStatus = 'expired';
                return 'expired';
            }
            // Always return from existingQuote as source of truth
            return existingQuote.status;
        }

        // Get icon SVG for action
        function getActionIcon(iconName) {
            const icons = {
                save: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path>',
                send: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>',
                download: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5.586a1 1 0 0 1 .707.293l5.414 5.414a1 1 0 0 1 .293.707V19a2 2 0 0 1-2 2z"></path>',
                trash: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0 1 16.138 21H7.862a2 2 0 0 1-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 0 0-1-1h-4a1 1 0 0 0-1 1v3M4 7h16"></path>',
                check: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>',
                x: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>',
                invoice: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5.586a1 1 0 0 1 .707.293l5.414 5.414a1 1 0 0 1 .293.707V19a2 2 0 0 1-2 2z"></path>',
                copy: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v2m-6 12h8a2 2 0 0 0 2-2v-8a2 2 0 0 0-2-2h-8a2 2 0 0 0-2 2v8a2 2 0 0 0 2 2z"></path>',
                archive: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"></path>',
                refresh: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 0 0 4.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 0 1-15.357-2m15.357 2H15"></path>',
                plus: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>'
            };
            return icons[iconName] || icons.save;
        }

        // Get button color classes
        function getButtonColor(color, isPrimary) {
            const colors = {
                gray: isPrimary ? 'bg-gray-600 text-white hover:bg-gray-700' : 'border border-gray-300 text-gray-700 hover:bg-gray-50',
                blue: 'bg-blue-600 text-white hover:bg-blue-700',
                green: 'bg-green-600 text-white hover:bg-green-700',
                red: 'bg-red-600 text-white hover:bg-red-700',
                purple: 'bg-purple-600 text-white hover:bg-purple-700'
            };
            return colors[color] || colors.gray;
        }

        // Render action buttons based on current status
        function renderStatusActions() {
            const currentStatus = getCurrentStatus();
            const config = statusConfig[currentStatus];
            
            if (!config) {
                console.error('Invalid status:', currentStatus);
                return;
            }

            // Update status badge
            const statusBadge = document.getElementById('quoteStatusBadge');
            statusBadge.textContent = config.label;
            statusBadge.className = `px-2 py-1 text-xs rounded ${config.color}`;

            // Get the header actions container
            const headerActions = document.getElementById('headerActions');
            
            // Remove only the dynamic action buttons (not the back button)
            const dynamicButtons = headerActions.querySelectorAll('button:not(:first-child)');
            dynamicButtons.forEach(btn => btn.remove());

            // Header action buttons removed - only keeping "Back to Quotes"

            // Also render action buttons in sidebar
            const sidebarActions = document.getElementById('sidebarActions');
            if (sidebarActions) {
                sidebarActions.innerHTML = '';
                
                config.actions.forEach(action => {
                    const button = document.createElement('button');
                    button.className = `w-full py-2.5 rounded-lg text-sm font-medium flex items-center justify-center gap-2 ${getButtonColor(action.color, action.primary)}`;
                    button.onclick = () => handleStatusAction(action.id);
                    
                    button.innerHTML = `
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            ${getActionIcon(action.icon)}
                        </svg>
                        ${action.label}
                    `;
                    
                    sidebarActions.appendChild(button);
                });
            }

            // Show status info banner and enable/disable editing based on status
            const banner = document.getElementById('statusInfoBanner');
            
            if (config.canEdit) {
                enableEditing();
                if (banner) banner.classList.add('hidden');
            } else {
                disableEditing();
                
                // Define informational banner messages
                const bannerMessages = {
                    approved: {
                        color: 'bg-green-50 border-green-500',
                        icon: '',
                        title: 'Quote Approved',
                        message: 'This quote has been approved by the customer. You can create invoices but cannot modify the quote details.'
                    },
                    rejected: {
                        color: 'bg-red-50 border-red-500',
                        icon: '',
                        title: 'Quote Rejected',
                        message: 'This quote was rejected by the customer. You can clone it to create a new quote with modifications.'
                    },
                    expired: {
                        color: 'bg-orange-50 border-orange-500',
                        icon: '',
                        title: 'Quote Expired',
                        message: 'This quote has passed its validity date. You can renew it to extend the validity period or clone it to create a new quote.'
                    },
                    invoiced: {
                        color: 'bg-purple-50 border-purple-500',
                        icon: '',
                        title: 'Quote Invoiced',
                        message: 'Invoices have been created for this quote. Quote details are now locked.'
                    }
                };
                
                const bannerInfo = bannerMessages[currentStatus];
                if (bannerInfo && banner) {
                    banner.className = `p-4 border-l-4 rounded-lg ${bannerInfo.color}`;
                    banner.innerHTML = `
                        <div class="flex items-start gap-3">
                            <span class="text-2xl">${bannerInfo.icon}</span>
                            <div class="flex-1">
                                <h3 class="font-semibold text-gray-900 mb-1">${bannerInfo.title}</h3>
                                <p class="text-sm text-gray-700">${bannerInfo.message}</p>
                            </div>
                        </div>
                    `;
                    banner.classList.remove('hidden');
                } else {
                    if (banner) banner.classList.add('hidden');
                }
            }
            
            // Update tab visibility based on status
            updateTabsVisibility();
        }

        // Enable editing for editable statuses
        function enableEditing() {
            // Enable Quote Details tab inputs
            const quoteInputs = document.querySelectorAll('#quoteDetailsContent input, #quoteDetailsContent textarea, #quoteDetailsContent select');
            quoteInputs.forEach(input => {
                input.disabled = false;
                input.classList.remove('bg-gray-100', 'cursor-not-allowed');
            });

            // Enable add/remove item buttons
            const catalogSearch = document.getElementById('catalogSearchInput');
            if (catalogSearch) {
                catalogSearch.disabled = false;
                catalogSearch.placeholder = 'Type to search and add services or products...';
            }

            // Show remove item buttons
            const removeButtons = document.querySelectorAll('[onclick^="removeQuoteItem"]');
            removeButtons.forEach(btn => btn.style.display = '');
            
            // Enable Payment Configuration tab inputs
            const paymentInputs = document.querySelectorAll('#paymentConfigContent input, #paymentConfigContent textarea, #paymentConfigContent select');
            paymentInputs.forEach(input => {
                input.disabled = false;
                input.classList.remove('bg-gray-100', 'cursor-not-allowed');
            });
        }

        // Disable editing for read-only statuses
        function disableEditing() {
            // Disable Quote Details tab inputs
            const quoteInputs = document.querySelectorAll('#quoteDetailsContent input, #quoteDetailsContent textarea, #quoteDetailsContent select');
            quoteInputs.forEach(input => {
                input.disabled = true;
                input.classList.add('bg-gray-100', 'cursor-not-allowed');
            });

            // Disable add/remove item buttons
            const catalogSearch = document.getElementById('catalogSearchInput');
            if (catalogSearch) {
                catalogSearch.disabled = true;
                catalogSearch.placeholder = 'Editing disabled for this status';
            }

            // Hide remove item buttons
            const removeButtons = document.querySelectorAll('[onclick^="removeQuoteItem"]');
            removeButtons.forEach(btn => btn.style.display = 'none');
            
            // Disable Payment Configuration tab inputs
            const paymentInputs = document.querySelectorAll('#paymentConfigContent input, #paymentConfigContent textarea, #paymentConfigContent select');
            paymentInputs.forEach(input => {
                input.disabled = true;
                input.classList.add('bg-gray-100', 'cursor-not-allowed');
            });
        }

        // Handle status action clicks
        function handleStatusAction(actionId) {
            switch(actionId) {
                case 'save':
                    saveQuoteChanges();
                    break;
                case 'send':
                    sendQuote();
                    break;
                case 'resend':
                    resendQuote();
                    break;
                case 'approve':
                    approveQuote();
                    break;
                case 'reject':
                    rejectQuote();
                    break;
                case 'createInvoice':
                    createInvoiceFromQuote();
                    break;
                case 'download':
                    previewQuotePDF();
                    break;
                case 'delete':
                    deleteQuote();
                    break;
                case 'clone':
                    cloneQuote();
                    break;
                case 'archive':
                    archiveQuote();
                    break;
                case 'renew':
                    renewQuote();
                    break;
                case 'viewInvoices':
                    switchTab('invoices');
                    break;
                default:
                    console.log('Action not implemented:', actionId);
            }
        }

        // Action implementations
        function saveQuoteChanges() {
            console.log('Saving quote changes...', existingQuote.id);
            
            // Update quote data with current form values
            existingQuote.validUntil = document.getElementById('validUntilDate').value;
            existingQuote.customerNotes = document.getElementById('customerNotes').value;
            existingQuote.internalNotes = document.getElementById('internalNotes').value;
            
            alert('Quote changes saved successfully!');
            // In real implementation: save to server via API
        }

        function sendQuote() {
            const email = state.selectedCustomer ? state.selectedCustomer.email : 'customer';
            if (confirm('Send this quote to ' + email + '?')) {
                existingQuote.status = 'sent';
                state.quoteStatus = 'sent'; // Update state to sync with existingQuote
                console.log('Quote sent:', existingQuote.id);
                alert('Quote sent successfully!');
                renderStatusActions();
                // In real implementation: send email and update server
            }
        }

        function resendQuote() {
            const email = state.selectedCustomer ? state.selectedCustomer.email : 'customer';
            if (confirm('Resend this quote to ' + email + '?')) {
                console.log('Quote resent:', existingQuote.id);
                alert('Quote resent successfully!');
                // In real implementation: resend email
            }
        }

        function approveQuote() {
            if (confirm('Mark this quote as Approved? This will allow invoice creation.')) {
                existingQuote.status = 'approved';
                state.quoteStatus = 'approved'; // Update state to sync with existingQuote
                console.log('Quote approved:', existingQuote.id);
                alert('Quote marked as Approved! You can now create invoices.');
                renderStatusActions();
                // In real implementation: update server
            }
        }

        function rejectQuote() {
            if (confirm('Mark this quote as Rejected?')) {
                existingQuote.status = 'rejected';
                state.quoteStatus = 'rejected'; // Update state to sync with existingQuote
                console.log('Quote rejected:', existingQuote.id);
                alert('Quote marked as Rejected.');
                renderStatusActions();
                // In real implementation: update server
            }
        }

        // Store the generated PDF globally for download
        let generatedPdfBlob = null;

        function generateQuotePDF() {
            console.log('Generating PDF for quote:', existingQuote.id);
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
                
                // Page settings
                const pageWidth = doc.internal.pageSize.width;
                const pageHeight = doc.internal.pageSize.height;
                const margin = 20;
                const contentWidth = pageWidth - (margin * 2);
                let yPos = margin;
                
                // Colors
                const primaryColor = [59, 130, 246]; // Blue
                const darkColor = [31, 41, 55]; // Gray-800
                const lightColor = [107, 114, 128]; // Gray-500
                
                // Helper function to add text with word wrap
                const addWrappedText = (text, x, y, maxWidth, fontSize = 10) => {
                    doc.setFontSize(fontSize);
                    const lines = doc.splitTextToSize(text, maxWidth);
                    doc.text(lines, x, y);
                    return y + (lines.length * fontSize * 0.4);
                };
                
                // Header - Company Name
                doc.setFillColor(primaryColor[0], primaryColor[1], primaryColor[2]);
                doc.rect(0, 0, pageWidth, 40, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(24);
                doc.setFont(undefined, 'bold');
                doc.text('SUNSHINE TUTORING', margin, 20);
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.text('Melbourne East Branch', margin, 28);
                
                // Quote Title and Status
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                const statusText = getCurrentStatus().toUpperCase();
                const statusLabel = statusConfig[getCurrentStatus()]?.label || statusText;
                doc.text('QUOTE', pageWidth - margin - 30, 20, { align: 'right' });
                doc.setFontSize(9);
                doc.setFont(undefined, 'normal');
                doc.text(statusLabel, pageWidth - margin - 30, 28, { align: 'right' });
                
                yPos = 50;
                
                // Quote ID and Date
                doc.setTextColor(darkColor[0], darkColor[1], darkColor[2]);
                doc.setFontSize(10);
                doc.setFont(undefined, 'bold');
                doc.text(`Quote #: ${existingQuote.id}`, margin, yPos);
                doc.setFont(undefined, 'normal');
                doc.text(`Date: ${new Date(existingQuote.createdDate).toLocaleDateString('en-AU')}`, pageWidth - margin, yPos, { align: 'right' });
                
                yPos += 8;
                doc.text(`Valid Until: ${new Date(existingQuote.validUntil).toLocaleDateString('en-AU')}`, pageWidth - margin, yPos, { align: 'right' });
                
                yPos += 15;
                
                // Customer Information Box
                doc.setDrawColor(220, 220, 220);
                doc.setFillColor(249, 250, 251);
                doc.roundedRect(margin, yPos, contentWidth / 2 - 5, 35, 2, 2, 'FD');
                
                doc.setFontSize(9);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(lightColor[0], lightColor[1], lightColor[2]);
                doc.text('BILL TO:', margin + 5, yPos + 7);
                
                doc.setTextColor(darkColor[0], darkColor[1], darkColor[2]);
                doc.setFont(undefined, 'bold');
                doc.setFontSize(10);
                doc.text(state.selectedCustomer.name, margin + 5, yPos + 14);
                
                doc.setFont(undefined, 'normal');
                doc.setFontSize(9);
                doc.text(state.selectedCustomer.email, margin + 5, yPos + 20);
                doc.text(state.selectedCustomer.phone, margin + 5, yPos + 26);
                if (state.selectedCustomer.address) {
                    doc.setFontSize(8);
                    const addressLines = doc.splitTextToSize(state.selectedCustomer.address, contentWidth / 2 - 15);
                    doc.text(addressLines, margin + 5, yPos + 31);
                }
                
                yPos += 45;
                
                // Line Items Table Header
                doc.setFillColor(primaryColor[0], primaryColor[1], primaryColor[2]);
                doc.rect(margin, yPos, contentWidth, 10, 'F');
                
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(9);
                doc.setFont(undefined, 'bold');
                doc.text('Description', margin + 3, yPos + 7);
                doc.text('Qty', margin + contentWidth * 0.60, yPos + 7);
                doc.text('Unit Price', margin + contentWidth * 0.70, yPos + 7);
                doc.text('Total', margin + contentWidth * 0.85, yPos + 7);
                
                yPos += 12;
                
                // Line Items
                doc.setTextColor(darkColor[0], darkColor[1], darkColor[2]);
                doc.setFont(undefined, 'normal');
                doc.setFontSize(9);
                
                state.quoteItems.forEach((item, index) => {
                    // Check if we need a new page
                    if (yPos > pageHeight - 60) {
                        doc.addPage();
                        yPos = margin;
                    }
                    
                    // Item name
                    const nameLines = doc.splitTextToSize(item.name, contentWidth * 0.55);
                    doc.text(nameLines, margin + 3, yPos);
                    
                    // Quantity
                    doc.text(`${item.quantity} ${item.unit}`, margin + contentWidth * 0.60, yPos);
                    
                    // Unit Price
                    doc.text(`$${item.customPrice.toFixed(2)}`, margin + contentWidth * 0.70, yPos);
                    
                    // Line Total
                    const lineTotal = item.customPrice * item.quantity;
                    const discountAmount = item.discountType === 'percentage' 
                        ? lineTotal * (item.discount / 100)
                        : item.discount;
                    const finalTotal = lineTotal - discountAmount;
                    doc.text(`$${finalTotal.toFixed(2)}`, margin + contentWidth * 0.85, yPos);
                    
                    yPos += (nameLines.length * 4) + 2;
                    
                    // Item notes if any
                    if (item.notes) {
                        doc.setFontSize(8);
                        doc.setTextColor(lightColor[0], lightColor[1], lightColor[2]);
                        const notesLines = doc.splitTextToSize(item.notes, contentWidth * 0.55);
                        doc.text(notesLines, margin + 5, yPos);
                        yPos += (notesLines.length * 3.5) + 1;
                        doc.setFontSize(9);
                        doc.setTextColor(darkColor[0], darkColor[1], darkColor[2]);
                    }
                    
                    // Discount if any
                    if (item.discount > 0) {
                        doc.setFontSize(8);
                        doc.setTextColor(34, 197, 94); // Green
                        doc.text(`Discount: -$${discountAmount.toFixed(2)}`, margin + contentWidth * 0.85, yPos);
                        yPos += 4;
                        doc.setFontSize(9);
                        doc.setTextColor(darkColor[0], darkColor[1], darkColor[2]);
                    }
                    
                    // Separator line
                    if (index < state.quoteItems.length - 1) {
                        doc.setDrawColor(230, 230, 230);
                        doc.line(margin, yPos, pageWidth - margin, yPos);
                        yPos += 5;
                    }
                });
                
                yPos += 8;
                
                // Summary Box
                const summaryX = pageWidth - margin - 60;
                const summaryWidth = 60;
                
                // Subtotal
                doc.setFont(undefined, 'normal');
                doc.text('Subtotal:', summaryX, yPos);
                doc.text(`$${calculateSubtotal().toFixed(2)}`, summaryX + summaryWidth, yPos, { align: 'right' });
                yPos += 6;
                
                // Line item discounts if any
                const lineItemDiscounts = calculateLineItemDiscounts();
                if (lineItemDiscounts > 0) {
                    doc.setTextColor(34, 197, 94); // Green
                    doc.text('Discounts:', summaryX, yPos);
                    doc.text(`-$${lineItemDiscounts.toFixed(2)}`, summaryX + summaryWidth, yPos, { align: 'right' });
                    doc.setTextColor(darkColor[0], darkColor[1], darkColor[2]);
                    yPos += 6;
                }
                
                // Tax Breakdown
                const taxBreakdown = getTaxBreakdown();
                if (taxBreakdown.taxable_gst > 0) {
                    doc.text('GST (10%):', summaryX, yPos);
                    doc.text(`$${taxBreakdown.taxable_gst.toFixed(2)}`, summaryX + summaryWidth, yPos, { align: 'right' });
                    yPos += 6;
                }
                
                // Total Tax
                doc.text('Total Tax:', summaryX, yPos);
                doc.text(`$${calculateTax().toFixed(2)}`, summaryX + summaryWidth, yPos, { align: 'right' });
                yPos += 8;
                
                // Total line
                doc.setDrawColor(darkColor[0], darkColor[1], darkColor[2]);
                doc.setLineWidth(0.5);
                doc.line(summaryX, yPos - 2, summaryX + summaryWidth, yPos - 2);
                
                doc.setFont(undefined, 'bold');
                doc.setFontSize(12);
                doc.text('TOTAL:', summaryX, yPos);
                doc.text(`$${calculateTotal().toFixed(2)}`, summaryX + summaryWidth, yPos, { align: 'right' });
                
                yPos += 15;
                
                // Customer Notes
                if (existingQuote.customerNotes) {
                    doc.setFontSize(9);
                    doc.setFont(undefined, 'bold');
                    doc.setTextColor(lightColor[0], lightColor[1], lightColor[2]);
                    doc.text('NOTES:', margin, yPos);
                    yPos += 5;
                    
                    doc.setFont(undefined, 'normal');
                    doc.setTextColor(darkColor[0], darkColor[1], darkColor[2]);
                    doc.setFontSize(9);
                    const notesLines = doc.splitTextToSize(existingQuote.customerNotes, contentWidth);
                    doc.text(notesLines, margin, yPos);
                    yPos += (notesLines.length * 4);
                }
                
                // Footer
                yPos = pageHeight - 30;
                doc.setDrawColor(primaryColor[0], primaryColor[1], primaryColor[2]);
                doc.setLineWidth(1);
                doc.line(margin, yPos, pageWidth - margin, yPos);
                
                yPos += 5;
                doc.setFontSize(8);
                doc.setTextColor(lightColor[0], lightColor[1], lightColor[2]);
                doc.setFont(undefined, 'normal');
                
                // Left footer
                doc.text('Sunshine Tutoring - Melbourne East', margin, yPos);
                doc.text('123 Education Street, Melbourne VIC 3000', margin, yPos + 4);
                doc.text('Phone: (03) 1234 5678 | Email: melbourne@sunshinetutoring.com.au', margin, yPos + 8);
                
                // Right footer
                doc.text('ABN: 12 345 678 901', pageWidth - margin, yPos, { align: 'right' });
                doc.text('www.sunshinetutoring.com.au', pageWidth - margin, yPos + 4, { align: 'right' });
                
                // Return the PDF document
                return doc;
        }

        function previewQuotePDF() {
            try {
                // Generate the PDF
                const doc = generateQuotePDF();
                
                // Create blob URL
                const pdfBlob = doc.output('blob');
                generatedPdfBlob = pdfBlob;
                const pdfUrl = URL.createObjectURL(pdfBlob);
                
                // Show in preview modal
                const iframe = document.getElementById('pdfPreviewFrame');
                iframe.src = pdfUrl;
                
                // Show modal
                document.getElementById('pdfPreviewModal').classList.remove('hidden');
                
                console.log('PDF preview opened');
                
            } catch (error) {
                console.error('Error generating PDF preview:', error);
                alert('Error generating PDF preview. Please try again.');
            }
        }

        function downloadQuotePDF() {
            try {
                let doc;
                
                // If we have a cached blob from preview, use it
                if (generatedPdfBlob) {
                    // Download the cached blob
                    const filename = `Quote_${existingQuote.id}_${state.selectedCustomer.name.replace(/\s+/g, '_')}.pdf`;
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(generatedPdfBlob);
                    link.download = filename;
                    link.click();
                    URL.revokeObjectURL(link.href);
                } else {
                    // Generate new PDF and download
                    doc = generateQuotePDF();
                    const filename = `Quote_${existingQuote.id}_${state.selectedCustomer.name.replace(/\s+/g, '_')}.pdf`;
                    doc.save(filename);
                }
                
                console.log('PDF downloaded successfully');
                
            } catch (error) {
                console.error('Error downloading PDF:', error);
                alert('Error downloading PDF. Please try again.');
            }
        }

        function closePdfPreview() {
            const modal = document.getElementById('pdfPreviewModal');
            const iframe = document.getElementById('pdfPreviewFrame');
            
            // Revoke the blob URL to free memory
            if (iframe.src) {
                URL.revokeObjectURL(iframe.src);
                iframe.src = '';
            }
            
            modal.classList.add('hidden');
            
            // Clear cached blob
            generatedPdfBlob = null;
        }

        function deleteQuote() {
            const customerName = state.selectedCustomer ? state.selectedCustomer.name : 'Unknown';
            if (confirm('Delete quote ' + existingQuote.id + ' for ' + customerName + '? This cannot be undone.')) {
                console.log('Quote deleted:', existingQuote.id);
                alert('Quote deleted successfully!');
                setTimeout(() => {
                    window.location.href = 'quote_list_simple.html';
                }, 500);
                // In real implementation: delete from server
            }
        }

        function cloneQuote() {
                window.location.href = `quote_create_simple.html?clone=${existingQuote.id}`;
        }

        function archiveQuote() {
                alert('Quote archived!');
                window.location.href = 'quote_list_simple.html';
                // In real implementation: archive on server
        }

        function renewQuote() {
                existingQuote.status = 'draft';
                state.quoteStatus = 'draft'; // Update state to sync with existingQuote
                // Set new validity date (30 days from now)
                const newDate = new Date();
                newDate.setDate(newDate.getDate() + 30);
                existingQuote.validUntil = newDate.toISOString().split('T')[0];
                document.getElementById('validUntilDate').value = existingQuote.validUntil;
                alert('Quote renewed! Please update and send to customer.');
                renderStatusActions();
                // In real implementation: update server
        }

        // Helper functions
        function getServices() {
            return tutoringServices;
        }
        

        function getPricingIcon(type) {
            const icons = {
                'per_hour': `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`,
                'per_sqm': `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 5a1 1 0 011-1h4a1 1 0 011 1v7a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM14 5a1 1 0 011-1h4a1 1 0 011 1v7a1 1 0 01-1 1h-4a1 1 0 01-1-1V5zM4 16a1 1 0 011-1h4a1 1 0 011 1v3a1 1 0 01-1 1H5a1 1 0 01-1-1v-3zM14 16a1 1 0 011-1h4a1 1 0 011 1v3a1 1 0 01-1 1h-4a1 1 0 01-1-1v-3z"></path></svg>`,
                'per_unit': `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path></svg>`,
                'fixed': `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`
            };
            return icons[type] || icons['fixed'];
        }

        function getTypeIndicator(type) {
            if (type === 'product') {
                return '<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800"> Product</span>';
            }
            return '<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800"> Service</span>';
        }

        // Tax rate lookup based on tax category
        function getTaxRate(taxCategory) {
            const taxRates = {
                'taxable_gst': 0.10,    // 10% GST
                'gst_free': 0.00,       // 0% GST-free
                'input_taxed': 0.00     // 0% Input-taxed (no GST on output, but special reporting)
            };
            return taxRates[taxCategory] || 0.10; // Default to 10% if category not found
        }

        function getTaxCategoryLabel(taxCategory) {
            const labels = {
                'taxable_gst': 'Taxable (10% GST)',
                'gst_free': 'GST-Free (0%)',
                'input_taxed': 'Input-Taxed (0%)'
            };
            return labels[taxCategory] || 'Standard (10%)';
        }

        // Calculate tax for each line item based on its tax category
        function calculateLineItemTax(item) {
            const taxRate = getTaxRate(item.taxCategory);
            const lineTotal = item.customPrice * item.quantity;
            return lineTotal * taxRate;
        }

        // Calculation functions
        function calculateSubtotal() {
            return state.quoteItems.reduce((sum, item) => {
                const lineTotal = item.customPrice * item.quantity;
                const discountAmount = item.discountType === 'percentage' 
                    ? lineTotal * (item.discount / 100)
                    : item.discount;
                return sum + (lineTotal - discountAmount);
            }, 0);
        }

        function calculateTax() {
            // Calculate tax per line item based on their tax categories
            return state.quoteItems.reduce((sum, item) => {
                return sum + calculateLineItemTax(item);
            }, 0);
        }

        function calculateTotal() {
            return calculateSubtotal() + calculateTax();
        }
        
        // Calculate total line item discounts
        function calculateLineItemDiscounts() {
            return state.quoteItems.reduce((sum, item) => {
                const lineTotal = item.customPrice * item.quantity;
                const discountAmount = item.discountType === 'percentage' 
                    ? lineTotal * (item.discount / 100)
                    : item.discount;
                return sum + discountAmount;
            }, 0);
        }
        
        // Get tax breakdown by category
        function getTaxBreakdown() {
            const breakdown = {
                taxable_gst: 0,
                gst_free: 0,
                input_taxed: 0
            };
            
            state.quoteItems.forEach(item => {
                const taxAmount = calculateLineItemTax(item);
                if (item.taxCategory && breakdown.hasOwnProperty(item.taxCategory)) {
                    breakdown[item.taxCategory] += taxAmount;
                } else {
                    breakdown.taxable_gst += taxAmount; // Default
                }
            });
            
            return breakdown;
        }

        function updateSummary() {
            document.getElementById('subtotalAmount').textContent = `$${calculateSubtotal().toFixed(2)}`;
            
            // Update line item discounts display
            const lineItemDiscounts = calculateLineItemDiscounts();
            const lineItemDiscountSection = document.getElementById('lineItemDiscountSection');
            if (lineItemDiscounts > 0) {
                lineItemDiscountSection.classList.remove('hidden');
                document.getElementById('lineItemDiscountAmount').textContent = `-$${lineItemDiscounts.toFixed(2)}`;
            } else {
                lineItemDiscountSection.classList.add('hidden');
            }
            
            document.getElementById('totalAmount').textContent = `$${calculateTotal().toFixed(2)}`;

            // Calculate and display tax breakdown by category
            const taxBreakdown = getTaxBreakdown();
            const taxBreakdownContainer = document.getElementById('taxBreakdown');
            
            let taxBreakdownHTML = '';
            if (taxBreakdown.taxable_gst > 0) {
                taxBreakdownHTML += `<div class="flex justify-between"><span>GST (10%):</span><span>$${taxBreakdown.taxable_gst.toFixed(2)}</span></div>`;
            }
            if (taxBreakdown.gst_free > 0) {
                taxBreakdownHTML += `<div class="flex justify-between text-gray-500"><span>GST-Free:</span><span>$0.00</span></div>`;
            }
            if (taxBreakdown.input_taxed > 0) {
                taxBreakdownHTML += `<div class="flex justify-between text-gray-500"><span>Input-Taxed:</span><span>$0.00</span></div>`;
            }
            
            taxBreakdownContainer.innerHTML = taxBreakdownHTML || '<div class="text-gray-400">No taxable items</div>';
            
            // Total tax
            const totalTax = calculateTax();
            document.getElementById('taxAmount').textContent = `$${totalTax.toFixed(2)}`;
            
            updateCreateButton();
        }

        function updateCreateButton() {
            const createBtn = document.getElementById('createQuoteBtn');
            if (createBtn) {
            const canCreate = state.quoteItems.length > 0 && state.selectedCustomer !== null;
            createBtn.disabled = !canCreate;
            }
        }

        // Render functions
        function renderCustomerAutocomplete(searchTerm = '') {
            const autocomplete = document.getElementById('customerAutocomplete');
            const clearBtn = document.getElementById('clearSearchBtn');
            
            if (!searchTerm || searchTerm.length < 2) {
                autocomplete.classList.add('hidden');
                clearBtn.classList.add('hidden');
                return;
            }
            
            clearBtn.classList.remove('hidden');
            
            const filtered = customers.filter(c => 
                c.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                c.email.toLowerCase().includes(searchTerm.toLowerCase()) ||
                c.phone.includes(searchTerm)
            );

            if (filtered.length === 0) {
                autocomplete.innerHTML = `
                    <div class="p-3 text-sm text-gray-500 text-center">
                        No customers found.
                    </div>
                `;
                autocomplete.classList.remove('hidden');
                return;
            }

            autocomplete.innerHTML = filtered.map(customer => `
                <div 
                    class="p-3 hover:bg-blue-50 cursor-pointer border-b border-gray-100 last:border-b-0"
                    onclick="selectCustomer(${customer.id})"
                >
                    <div class="flex items-center justify-between">
                        <div class="flex-1">
                            <p class="font-medium text-gray-900 text-sm">${customer.name}</p>
                            <p class="text-xs text-gray-600 mt-0.5">${customer.email}</p>
                            <p class="text-xs text-gray-500">${customer.phone}</p>
                        </div>
                        ${customer.previousQuotes > 0 ? `
                            <span class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded">${customer.previousQuotes} quotes</span>
                        ` : ''}
                    </div>
                </div>
            `).join('');
            
            autocomplete.classList.remove('hidden');
        }

        function renderCatalogAutocomplete(searchTerm = '') {
            const autocomplete = document.getElementById('catalogAutocomplete');
            const clearBtn = document.getElementById('clearCatalogSearchBtn');
            
            if (!searchTerm || searchTerm.length < 2) {
                autocomplete.classList.add('hidden');
                clearBtn.classList.add('hidden');
                return;
            }
            
            clearBtn.classList.remove('hidden');
            
            const services = getServices().filter(service => 
                service.name.toLowerCase().includes(searchTerm.toLowerCase()) || 
                service.id.toLowerCase().includes(searchTerm.toLowerCase()) ||
                service.tag.toLowerCase().includes(searchTerm.toLowerCase())
            );

            if (services.length === 0) {
                autocomplete.innerHTML = `
                    <div class="p-3 text-sm text-gray-500 text-center">
                        No services or products found.
                    </div>
                `;
                autocomplete.classList.remove('hidden');
                return;
            }

            autocomplete.innerHTML = services.map(service => `
                <div 
                    class="p-3 hover:bg-blue-50 cursor-pointer border-b border-gray-100 last:border-b-0"
                    onclick="addQuoteItem('${service.id}')"
                >
                    <div class="flex items-center justify-between">
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-1">
                                ${getTypeIndicator(service.type)}
                                <span class="text-xs bg-gray-100 text-gray-700 px-2 py-0.5 rounded">${service.tag}</span>
                            </div>
                            <p class="font-medium text-gray-900 text-sm">${service.name}</p>
                            <p class="text-xs text-gray-500 mt-0.5">${service.id}</p>
                        </div>
                        <div class="text-right ml-3">
                            <div class="flex items-center gap-1 text-gray-700">
                                <span class="text-sm font-semibold">$${service.price}</span>
                                <span class="text-xs text-gray-500">/ ${service.unit}</span>
                            </div>
                            <div class="text-xs text-gray-500 mt-0.5">${getTaxCategoryLabel(service.taxCategory || 'taxable_gst')}</div>
                        </div>
                    </div>
                </div>
            `).join('');
            
            autocomplete.classList.remove('hidden');
        }

        function renderQuoteItems() {
            const emptyState = document.getElementById('emptyQuoteState');
            const container = document.getElementById('quoteItemsContainer');
            
            if (state.quoteItems.length === 0) {
                emptyState.classList.remove('hidden');
                container.classList.add('hidden');
                return;
            }
            
            emptyState.classList.add('hidden');
            container.classList.remove('hidden');
            
            container.innerHTML = state.quoteItems.map((item, index) => {
                // Show tax category
                let taxBadge = '';
                if (item.taxCategory) {
                    const taxLabels = {
                        'taxable_gst': '<span class="inline-flex items-center px-1.5 py-0.5 rounded text-xs bg-blue-50 text-blue-700"> GST (10%)</span>',
                        'gst_free': '<span class="inline-flex items-center px-1.5 py-0.5 rounded text-xs bg-gray-50 text-gray-600">GST-Free</span>',
                        'input_taxed': '<span class="inline-flex items-center px-1.5 py-0.5 rounded text-xs bg-gray-50 text-gray-600">Input-Taxed</span>'
                    };
                    taxBadge = taxLabels[item.taxCategory] || '';
                }
                
                const lineTotal = item.quantity * item.customPrice;
                const discountAmount = item.discountType === 'percentage' 
                    ? lineTotal * (item.discount / 100)
                    : item.discount;
                const lineTotalAfterDiscount = lineTotal - discountAmount;
                
                return `
                <div class="bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                    <!-- Header Row -->
                    <div class="flex items-start justify-between mb-3">
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-1">
                                <h3 class="font-semibold text-gray-900">${item.name}</h3>
                            </div>
                            <div class="flex items-center gap-2">
                                ${getTypeIndicator(item.type)}
                                ${taxBadge}
                            </div>
                            ${item.priceModificationComment ? `
                                <div class="mt-2 text-xs text-yellow-700 bg-yellow-50 px-2 py-1 rounded">
                                     ${item.priceModificationComment}
                                </div>
                            ` : ''}
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="text-right space-y-0.5">
                                ${item.discount > 0 ? `
                                    <div class="text-xs text-gray-500">Original: $${lineTotal.toFixed(2)}</div>
                                    <div class="text-xs text-green-600">Discount: -$${discountAmount.toFixed(2)}</div>
                                ` : ''}
                                <div class="text-2xl font-bold text-gray-900">$${lineTotalAfterDiscount.toFixed(2)}</div>
                            </div>
                            <button 
                                onclick="removeQuoteItem(${index})"
                                class="ml-2 p-2 text-red-600 hover:bg-red-50 rounded-lg transition-colors"
                                title="Remove item"
                            >
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0 1 16.138 21H7.862a2 2 0 0 1-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 0 0-1-1h-4a1 1 0 0 0-1 1v3M4 7h16"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Details Grid -->
                    <div class="grid grid-cols-12 gap-3 mb-3 pb-3 border-b border-gray-200">
                        <div class="col-span-3">
                            <label class="text-xs text-gray-500 block mb-1">${item.type === 'product' ? 'Delivery Date' : 'Service Date'} <span class="text-red-500">*</span></label>
                            <input 
                                type="date"
                                value="${item.serviceDate || ''}"
                                onchange="updateItemServiceDate(${index}, this.value)"
                                class="w-full px-2 py-1.5 border border-gray-300 rounded text-sm"
                            />
                        </div>
                        <div class="col-span-2">
                            <label class="text-xs text-gray-500 block mb-1">Quantity <span class="text-red-500">*</span></label>
                            <input 
                                type="number"
                                value="${item.quantity}"
                                onchange="updateItemQuantity(${index}, this.value)"
                                class="w-full px-2 py-1.5 border border-gray-300 rounded text-sm text-center"
                                min="1"
                            />
                        </div>
                        <div class="col-span-3">
                            <label class="text-xs text-gray-500 block mb-1">Unit Price</label>
                            <input 
                                type="number"
                                value="${item.customPrice}"
                                onchange="updateItemPrice(${index}, this.value)"
                                class="w-full px-2 py-1.5 border ${item.priceModified ? 'border-yellow-500 bg-yellow-50' : 'border-gray-300'} rounded text-sm text-right"
                                min="0"
                                step="0.01"
                            />
                            ${item.priceModified ? `<span class="text-xs text-yellow-600">Modified</span>` : ''}
                        </div>
                        <div class="col-span-4">
                            <label class="text-xs text-gray-500 block mb-1">Discount</label>
                            <div class="flex gap-2">
                                <select 
                                    onchange="updateItemDiscountType(${index}, this.value)"
                                    class="w-16 px-2 py-1.5 border border-gray-300 rounded text-sm"
                                >
                                    <option value="percentage" ${item.discountType === 'percentage' ? 'selected' : ''}>%</option>
                                    <option value="fixed" ${item.discountType === 'fixed' ? 'selected' : ''}>$</option>
                                </select>
                                <input 
                                    type="number"
                                    value="${item.discount || 0}"
                                    onchange="updateItemDiscount(${index}, this.value)"
                                    class="flex-1 px-2 py-1.5 border border-gray-300 rounded text-sm text-right"
                                    min="0"
                                    step="0.01"
                                />
                            </div>
                        </div>
                    </div>
                    
                    <!-- Notes Section -->
                    <div class="mb-3">
                        <label class="text-xs text-gray-500 block mb-1">Notes</label>
                        <textarea 
                            placeholder="${item.type === 'product' ? 'Delivery instructions, quantity details, etc...' : 'Service requirements, special instructions, etc...'}"
                            onchange="updateItemNotes(${index}, this.value)"
                            class="w-full px-3 py-2 border border-gray-300 rounded text-sm resize-none"
                            rows="2"
                        >${item.notes || ''}</textarea>
                    </div>
            `;
            }).join('');
        }

        // Event handlers
        // Clear customer button - remove selected customer and show search again
        const clearCustomerBtn = document.getElementById('clearCustomerBtn');
        if (clearCustomerBtn) {
            clearCustomerBtn.addEventListener('click', function() {
                state.selectedCustomer = null;
                state.selectedQuoteContact = null;
                const searchInput = document.getElementById('customerSearchInput');
                if (searchInput) {
                    searchInput.classList.remove('border-green-500');
                    searchInput.classList.add('border-red-300');
                }
                document.getElementById('selectedCustomerCard').classList.add('hidden');
                document.getElementById('customerSearchSection').classList.remove('hidden');
                if (searchInput) {
                    searchInput.value = '';
                    searchInput.focus();
                }
            });
        }

        function selectCustomer(customerId) {
            const customer = customers.find(c => c.id === customerId);
            state.selectedCustomer = customer;
            
            // Hide search, show selected card
            const searchInput = document.getElementById('customerSearchInput');
            searchInput.value = '';
            searchInput.classList.remove('border-red-300');
            searchInput.classList.add('border-green-500');
            document.getElementById('customerAutocomplete').classList.add('hidden');
            document.getElementById('clearSearchBtn').classList.add('hidden');
            document.getElementById('customerSearchSection').classList.add('hidden');
            document.getElementById('selectedCustomerCard').classList.remove('hidden');
            
            // Populate customer info
            document.getElementById('selectedCustomerName').textContent = customer.name;
            document.getElementById('selectedCustomerEmail').textContent = customer.email;
            document.getElementById('selectedCustomerPhone').textContent = customer.phone;
            
            // Setup quote contact selector if secondary contacts exist
            const contactSelector = document.getElementById('quoteContactSelector');
            const contactSelect = document.getElementById('quoteContactSelect');
            
            if (customer.secondaryContacts && customer.secondaryContacts.length > 0) {
                // Show contact selector
                contactSelector.classList.remove('hidden');
                
                // Build options: primary contact + secondary contacts
                let options = `<option value="primary">Primary: ${customer.name} (${customer.email})</option>`;
                customer.secondaryContacts.forEach((contact, index) => {
                    options += `<option value="secondary-${index}">${contact.name} - ${contact.role} (${contact.email})</option>`;
                });
                contactSelect.innerHTML = options;
                
                // Set default to primary
                state.selectedQuoteContact = {
                    type: 'primary',
                    name: customer.name,
                    email: customer.email,
                    phone: customer.phone
                };
            } else {
                // Hide contact selector, use primary by default
                contactSelector.classList.add('hidden');
                state.selectedQuoteContact = {
                    type: 'primary',
                    name: customer.name,
                    email: customer.email,
                    phone: customer.phone
                };
            }
            
            // Set service address (same as billing by default)
            document.getElementById('displayServiceAddress').textContent = customer.address || 'No address on file';
            document.getElementById('sameAsBilling').checked = true;
            document.getElementById('serviceAddressFields').classList.add('hidden');
            document.getElementById('serviceAddressDisplay').style.display = 'block';
            
            updateCreateButton();
        }

        function addQuoteItem(serviceId) {
            const services = getServices();
            const service = services.find(s => s.id === serviceId);
            
            if (!service) return;
            
            const newItem = {
                ...service,
                quantity: 1,
                customPrice: service.price,
                originalPrice: service.price,
                priceModified: false,
                priceModificationComment: '',
                notes: '',
                serviceDate: '',
                discount: 0,
                discountType: 'percentage',
                // Schedule fields (only for services)
                preferredTime: '',
                exactTime: '',
                scheduleNotes: ''
            };
            
            state.quoteItems.push(newItem);
            renderQuoteItems();
            updateSummary();
            
            // Clear catalog search after adding
            document.getElementById('catalogSearchInput').value = '';
            document.getElementById('catalogAutocomplete').classList.add('hidden');
            document.getElementById('clearCatalogSearchBtn').classList.add('hidden');
        }

        function removeQuoteItem(index) {
            state.quoteItems.splice(index, 1);
            renderQuoteItems();
            updateSummary();
        }

        function updateItemQuantity(index, value) {
            state.quoteItems[index].quantity = Number(value);
            renderQuoteItems();
            updateSummary();
        }

        function updateItemServiceDate(index, value) {
            state.quoteItems[index].serviceDate = value;
            renderQuoteItems();
        }

        function updateItemNotes(index, value) {
            state.quoteItems[index].notes = value;
        }

        function updateItemDiscount(index, value) {
            state.quoteItems[index].discount = Number(value);
            renderQuoteItems();
            updateSummary();
        }

        function updateItemDiscountType(index, value) {
            state.quoteItems[index].discountType = value;
            renderQuoteItems();
            updateSummary();
        }

        function updateItemPreferredTime(index, value) {
            state.quoteItems[index].preferredTime = value;
            renderQuoteItems();
        }

        function updateItemExactTime(index, value) {
            state.quoteItems[index].exactTime = value;
        }

        function updateItemScheduleNotes(index, value) {
            state.quoteItems[index].scheduleNotes = value;
        }

        function showPriceModModal(index, newPrice) {
            const item = state.quoteItems[index];
            state.currentPriceModIndex = index;
            state.currentPriceModNewValue = newPrice;
            
            // Populate modal with item details
            document.getElementById('priceModItemName').textContent = item.name;
            
            // Set item type badge
            const typeBadge = document.getElementById('priceModItemType');
            if (item.type === 'product') {
                typeBadge.innerHTML = '<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800"> Product</span>';
            } else {
                typeBadge.innerHTML = '<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800"> Service</span>';
            }
            
            document.getElementById('priceModOriginal').textContent = `$${item.originalPrice.toFixed(2)}`;
            document.getElementById('priceModNew').textContent = `$${Number(newPrice).toFixed(2)}`;
            document.getElementById('priceModComment').value = '';
            
            // Show modal
            document.getElementById('priceModModal').classList.remove('hidden');
        }

        function hidePriceModModal() {
            document.getElementById('priceModModal').classList.add('hidden');
            state.currentPriceModIndex = null;
            state.currentPriceModNewValue = null;
            document.getElementById('priceModComment').value = '';
        }

        function updateItemPrice(index, value) {
            const item = state.quoteItems[index];
            const newPrice = Number(value);
            const originalPrice = item.price;
            
            // Check if price is being modified from original
            if (newPrice !== originalPrice && !item.priceModified) {
                // Show modal to get reason
                showPriceModModal(index, newPrice);
                return;
            }
            
            item.customPrice = newPrice;
            renderQuoteItems();
            updateSummary();
        }

        function confirmPriceModification() {
            const comment = document.getElementById('priceModComment').value.trim();
            
            if (!comment) {
                alert('Please provide a reason for the price modification');
                return;
            }
            
            if (state.currentPriceModIndex !== null) {
                const item = state.quoteItems[state.currentPriceModIndex];
                item.priceModified = true;
                item.priceModificationComment = comment;
                item.customPrice = state.currentPriceModNewValue;
                
                renderQuoteItems();
                updateSummary();
                hidePriceModModal();
            }
        }

        function cancelPriceModification() {
            if (state.currentPriceModIndex !== null) {
                // Revert to original price
                const item = state.quoteItems[state.currentPriceModIndex];
                item.customPrice = item.originalPrice;
                
                renderQuoteItems();
                updateSummary();
                hidePriceModModal();
            }
        }

        function updateItemNotes(index, value) {
            state.quoteItems[index].notes = value;
        }

        // Preview function
        function showPreview() {
            if (!state.selectedCustomer || state.quoteItems.length === 0) {
                alert('Please select a customer and add items to the quote first.');
                return;
            }

            const validUntil = document.getElementById('validUntilDate').value;
            const customerNotes = document.getElementById('customerNotes').value;
            const internalNotes = document.getElementById('internalNotes').value;

            // Get current date
            const currentDate = new Date().toLocaleDateString('en-AU', { day: 'numeric', month: 'long', year: 'numeric' });
            
            // Build line items HTML
            const lineItemsHTML = state.quoteItems.map(item => `
                <tr class="border-b border-gray-200">
                    <td class="py-2 px-1" style="width: 35%;">
                        <div class="font-medium text-gray-900">${item.name}</div>
                        <div class="text-xs text-gray-600 mt-1">${item.id}</div>
                        ${item.notes ? `<div class="text-xs text-gray-500 italic mt-1">${item.notes}</div>` : ''}
                    </td>
                    <td class="py-2 px-1 text-center text-gray-700">${item.quantity} ${item.unit}</td>
                    <td class="py-2 px-1 text-right text-gray-700">$${item.customPrice.toFixed(2)}</td>
                    <td class="py-2 px-1 text-right font-medium">$${(item.customPrice * item.quantity).toFixed(2)}</td>
                </tr>
            `).join('');

            // Format tax breakdown
            const taxBreakdown = getTaxBreakdown();
            const taxBreakdownHTML = `
                ${taxBreakdown.taxable_gst > 0 ? `<div class="flex justify-between text-sm py-1"><span>GST (10%):</span><span>$${taxBreakdown.taxable_gst.toFixed(2)}</span></div>` : ''}
                ${taxBreakdown.gst_free > 0 ? `<div class="flex justify-between text-xs text-gray-500 py-1"><span>GST-Free Items:</span><span>$${state.quoteItems.filter(i => i.taxCategory === 'gst_free').reduce((sum, i) => sum + i.customPrice * i.quantity, 0).toFixed(2)}</span></div>` : ''}
                ${taxBreakdown.input_taxed > 0 ? `<div class="flex justify-between text-xs text-gray-500 py-1"><span>Input-Taxed Items:</span><span>$${state.quoteItems.filter(i => i.taxCategory === 'input_taxed').reduce((sum, i) => sum + i.customPrice * i.quantity, 0).toFixed(2)}</span></div>` : ''}
            `;

            // Build preview HTML
            const previewHTML = `
                <!-- Company Header -->
                <div class="border-b-2 border-gray-800 pb-4 mb-6">
                    <div class="flex items-center justify-between mb-4">
                        <div>
                            <h1 class="text-3xl font-bold text-gray-900 mb-1">SUNSHINE TUTORING</h1>
                            <p class="text-sm text-gray-600">Tutoring Excellence Since 2015</p>
                        </div>
                        <div class="text-right">
                            <p class="text-lg font-bold">QUOTE</p>
                            <p class="text-sm text-gray-600">Date: ${currentDate}</p>
                        </div>
                    </div>
                </div>

                <!-- Customer Details -->
                <div class="grid grid-cols-2 gap-6 mb-6">
                    <div>
                        <h3 class="font-semibold text-gray-900 mb-2 text-sm uppercase tracking-wide">Bill To:</h3>
                        <div class="text-sm text-gray-700">
                            <p class="font-medium">${state.selectedCustomer.name}</p>
                            ${state.selectedCustomer.company ? `<p>${state.selectedCustomer.company}</p>` : ''}
                            <p>${state.selectedCustomer.email}</p>
                            <p>${state.selectedCustomer.phone}</p>
                            ${state.selectedCustomer.address ? `<p class="mt-2">${state.selectedCustomer.address}</p>` : ''}
                        </div>
                    </div>
                    <div>
                        <h3 class="font-semibold text-gray-900 mb-2 text-sm uppercase tracking-wide">Quote Details:</h3>
                        <div class="text-sm text-gray-700">
                            <p><span class="font-medium">Quote ID:</span> Q-2024-001</p>
                            <p><span class="font-medium">Valid Until:</span> ${validUntil ? new Date(validUntil).toLocaleDateString('en-AU', { day: 'numeric', month: 'long', year: 'numeric' }) : 'N/A'}</p>
                            <p class="mt-2 text-xs text-gray-500">Melbourne East Branch</p>
                        </div>
                    </div>
                </div>

                <!-- Line Items Table -->
                <div class="mb-6">
                    <table class="w-full text-sm" style="min-width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr class="bg-gray-100 border-b-2 border-gray-800">
                                <th class="text-left py-2 px-1 font-semibold text-gray-900" style="width: 35%;">Description</th>
                                <th class="text-center py-2 px-1 font-semibold text-gray-900" style="width: 20%;">Quantity</th>
                                <th class="text-right py-2 px-1 font-semibold text-gray-900" style="width: 20%;">Unit Price</th>
                                <th class="text-right py-2 px-1 font-semibold text-gray-900" style="width: 25%;">Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${lineItemsHTML}
                        </tbody>
                    </table>
                </div>

                <!-- Summary -->
                <div class="flex justify-end mb-6">
                    <div class="w-64">
                        <div class="border-t border-gray-300 pt-3">
                            <div class="flex justify-between text-sm py-1">
                                <span class="text-gray-700">Subtotal:</span>
                                <span class="font-medium">$${calculateSubtotal().toFixed(2)}</span>
                            </div>
                            ${calculateLineItemDiscounts() > 0 ? `
                                <div class="flex justify-between text-sm py-1">
                                    <span class="text-gray-700">Line Item Discounts:</span>
                                    <span class="text-red-600">-$${calculateLineItemDiscounts().toFixed(2)}</span>
                                </div>
                            ` : ''}
                            <div class="border-t border-gray-300 mt-2 pt-2">
                                ${taxBreakdownHTML}
                                <div class="flex justify-between items-center mt-2 pt-2 border-t border-gray-800">
                                    <span class="text-sm font-semibold">Total Tax:</span>
                                    <span class="text-sm font-semibold">$${calculateTax().toFixed(2)}</span>
                                </div>
                            </div>
                            <div class="border-t-2 border-gray-800 mt-2 pt-2">
                                <div class="flex justify-between">
                                    <span class="text-lg font-bold text-gray-900">TOTAL:</span>
                                    <span class="text-lg font-bold text-gray-900">$${calculateTotal().toFixed(2)}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Notes -->
                ${customerNotes ? `
                    <div class="border-t border-gray-300 pt-4 mb-4">
                        <h4 class="font-semibold text-gray-900 mb-2 text-sm uppercase tracking-wide">Notes:</h4>
                        <p class="text-sm text-gray-700 whitespace-pre-wrap">${customerNotes}</p>
                    </div>
                ` : ''}

                <!-- Footer -->
                <div class="border-t-2 border-gray-800 pt-4 mt-6">
                    <div class="grid grid-cols-2 gap-6 text-xs text-gray-600">
                        <div>
                            <p class="font-semibold text-gray-900 mb-1">Sunshine Tutoring - Melbourne East</p>
                            <p>123 Education Street, Melbourne VIC 3000</p>
                            <p>Phone: (03) 1234 5678</p>
                            <p>Email: melbourne@sunshinetutoring.com.au</p>
                        </div>
                        <div>
                            <p class="font-semibold text-gray-900 mb-1">Payment Information</p>
                            <p>ABN: 12 345 678 901</p>
                            <p>Valid for 30 days from date of issue</p>
                            <p class="mt-2 text-gray-500">Terms and conditions apply</p>
                        </div>
                    </div>
                </div>

                ${internalNotes ? `
                    <div class="mt-6 pt-4 border-t-2 border-dashed border-red-300 bg-red-50 p-3 rounded">
                        <p class="text-xs font-semibold text-red-700 mb-1">INTERNAL NOTES (Not visible to customer):</p>
                        <p class="text-xs text-red-600 whitespace-pre-wrap">${internalNotes}</p>
                    </div>
                ` : ''}
            `;

            document.getElementById('previewContent').innerHTML = previewHTML;
            document.getElementById('previewModal').classList.remove('hidden');
        }


        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // EDIT MODE: Load existing quote data
            // Set quote ID
            document.getElementById('quoteIdBadge').textContent = existingQuote.id;
            
            // Developer helper: Test different statuses
            console.log('%c Developer Tools', 'color: #3b82f6; font-weight: bold; font-size: 14px;');
            console.log('Test different quote statuses by running:');
            console.log('  testStatus("draft")    - Editable, can send/delete');
            console.log('  testStatus("sent")     - Editable, can approve/reject');
            console.log('  testStatus("approved") - Read-only, can create invoice');
            console.log('  testStatus("rejected") - Read-only, can clone');
            console.log('  testStatus("expired")  - Read-only, can renew/clone');
            console.log('  testStatus("invoiced") - Read-only, view invoices');
            
            // Make testStatus function available globally
            window.testStatus = function(status) {
                if (statusConfig[status]) {
                    existingQuote.status = status;
                    state.quoteStatus = status; // Update state to sync with existingQuote
                    // Re-enable editing first (in case coming from read-only status)
                    enableEditing();
                    
                    // Re-render (this will disable again if needed)
                    renderStatusActions();
                    console.log(` Status changed to: ${status}`);
                } else {
                    console.error(' Invalid status. Use: draft, sent, approved, rejected, expired, or invoiced');
                }
            };
            
            // Set valid until date from existing quote
            document.getElementById('validUntilDate').value = existingQuote.validUntil;
            
            // Set notes from existing quote
            document.getElementById('customerNotes').value = existingQuote.customerNotes;
            document.getElementById('internalNotes').value = existingQuote.internalNotes;
            
            // EDIT MODE: Populate customer data
            if (state.selectedCustomer) {
                // Hide customer search section, show selected customer card
                document.getElementById('customerSearchSection').classList.add('hidden');
                document.getElementById('selectedCustomerCard').classList.remove('hidden');
                
                document.getElementById('selectedCustomerName').textContent = state.selectedCustomer.name;
                document.getElementById('selectedCustomerEmail').textContent = state.selectedCustomer.email;
                document.getElementById('selectedCustomerPhone').textContent = state.selectedCustomer.phone;
                document.getElementById('displayServiceAddress').textContent = state.selectedCustomer.address;
                
                // Setup quote contact selector if secondary contacts exist
                const contactSelector = document.getElementById('quoteContactSelector');
                const contactSelect = document.getElementById('quoteContactSelect');
                
                if (state.selectedCustomer.secondaryContacts && state.selectedCustomer.secondaryContacts.length > 0) {
                    contactSelector.classList.remove('hidden');
                    let options = `<option value="primary">Primary: ${state.selectedCustomer.name} (${state.selectedCustomer.email})</option>`;
                    state.selectedCustomer.secondaryContacts.forEach((contact, index) => {
                        options += `<option value="secondary-${index}">${contact.name} - ${contact.role} (${contact.email})</option>`;
                    });
                    contactSelect.innerHTML = options;
                }
            } else {
                // No customer selected - show search section, hide card
                document.getElementById('customerSearchSection').classList.remove('hidden');
                document.getElementById('selectedCustomerCard').classList.add('hidden');
            }
            
            // Render existing quote items
            renderQuoteItems();
            updateSummary();
            
            // Render status-based action buttons and update UI (AFTER items are rendered)
            renderStatusActions();
            
            // Catalog search autocomplete
            const catalogSearchInput = document.getElementById('catalogSearchInput');
            const clearCatalogSearchBtn = document.getElementById('clearCatalogSearchBtn');
            
            if (catalogSearchInput) {
                catalogSearchInput.addEventListener('input', function(e) {
                    renderCatalogAutocomplete(e.target.value);
                });
            }
            
            // Clear catalog search button
            if (clearCatalogSearchBtn) {
                clearCatalogSearchBtn.addEventListener('click', function() {
                    const catalogSearchInput = document.getElementById('catalogSearchInput');
                    const catalogAutocomplete = document.getElementById('catalogAutocomplete');
                    const clearCatalogSearchBtn = document.getElementById('clearCatalogSearchBtn');
                    
                    if (catalogSearchInput) catalogSearchInput.value = '';
                    if (catalogAutocomplete) catalogAutocomplete.classList.add('hidden');
                    if (clearCatalogSearchBtn) clearCatalogSearchBtn.classList.add('hidden');
                });
            }
            
            // Close catalog autocomplete when clicking outside
            document.addEventListener('click', function(e) {
                const catalogSearch = document.getElementById('catalogSearchInput');
                const autocomplete = document.getElementById('catalogAutocomplete');
                if (catalogSearch && !catalogSearch.parentElement.contains(e.target)) {
                    autocomplete.classList.add('hidden');
                }
            });
            
            // Customer search autocomplete
            const customerSearchInput = document.getElementById('customerSearchInput');
            if (customerSearchInput) {
                customerSearchInput.addEventListener('input', function(e) {
                    renderCustomerAutocomplete(e.target.value);
                });
            }
            
            // Clear search button
            const clearSearchBtn = document.getElementById('clearSearchBtn');
            if (clearSearchBtn) {
                clearSearchBtn.addEventListener('click', function() {
                    if (customerSearchInput) customerSearchInput.value = '';
                    const autocomplete = document.getElementById('customerAutocomplete');
                    if (autocomplete) autocomplete.classList.add('hidden');
                    if (clearSearchBtn) clearSearchBtn.classList.add('hidden');
                });
            }
            
            // Close customer autocomplete when clicking outside
            document.addEventListener('click', function(e) {
                const searchSection = document.getElementById('customerSearchSection');
                const autocomplete = document.getElementById('customerAutocomplete');
                if (searchSection && !searchSection.contains(e.target)) {
                    if (autocomplete) autocomplete.classList.add('hidden');
                }
            });
            
            // EDIT MODE: Customer can be changed by clearing and selecting again
            
            // Quote contact selector change
            const quoteContactSelect = document.getElementById('quoteContactSelect');
            if (quoteContactSelect) {
                quoteContactSelect.addEventListener('change', function(e) {
                    const value = e.target.value;
                    const customer = state.selectedCustomer;
                    
                    if (value === 'primary') {
                        state.quoteContact = customer.primaryContact;
                    } else if (value === 'add_new') {
                        // In real implementation, open add contact modal
                        alert('Add new contact functionality would be implemented here');
                    } else {
                        // Find secondary contact
                        const contact = customer.secondaryContacts?.find(c => c.id === value);
                        if (contact) {
                            state.quoteContact = contact;
                        }
                    }
                    
                    updateQuoteContactDisplay();
                });
            }
            
            // Service address toggle
            const sameAsBilling = document.getElementById('sameAsBilling');
            if (sameAsBilling) {
                sameAsBilling.addEventListener('change', function(e) {
                    const isChecked = e.target.checked;
                    const serviceAddressFields = document.getElementById('serviceAddressFields');
                    const serviceAddressDisplay = document.getElementById('serviceAddressDisplay');
                    
                    if (serviceAddressFields) {
                        serviceAddressFields.classList.toggle('hidden', isChecked);
                    }
                    if (serviceAddressDisplay) {
                        serviceAddressDisplay.style.display = isChecked ? 'block' : 'none';
                    }
                    
                    if (isChecked && state.selectedCustomer && serviceAddressDisplay) {
                        // Copy billing address to service address
                        serviceAddressDisplay.innerHTML = `
                            <div class="text-sm text-gray-700">
                                ${state.selectedCustomer.address}<br>
                                ${state.selectedCustomer.city}, ${state.selectedCustomer.state} ${state.selectedCustomer.zip}
                            </div>
                        `;
                    }
                });
            }
            
            // Create quote button
            const createQuoteBtn = document.getElementById('createQuoteBtn');
            if (createQuoteBtn) {
                createQuoteBtn.addEventListener('click', function() {
                if (!state.selectedCustomer) {
                    alert('Please select a customer');
                    return;
                }
                
                if (state.quoteItems.length === 0) {
                    alert('Please add at least one item to the quote');
                    return;
                }
                
                // Check for price modifications
                const priceModifiedItems = state.quoteItems.filter(item => item.priceModified);
                if (priceModifiedItems.length > 0) {
                    console.log('Price modifications:', 
                        priceModifiedItems.map(item => ({
                            name: item.name,
                            originalPrice: item.originalPrice,
                            modifiedPrice: item.customPrice,
                            comment: item.priceModificationComment
                        }))
                    );
                }
                
                // Create quote data
                const quoteData = {
                    customer: state.selectedCustomer,
                    quoteContact: state.selectedQuoteContact, // Contact who will receive the quote
                    items: state.quoteItems,
                    subtotal: calculateSubtotal(),
                    tax: calculateTax(),
                    total: calculateTotal(),
                    validUntil: document.getElementById('validUntilDate').value,
                    customerNotes: document.getElementById('customerNotes').value,
                    internalNotes: document.getElementById('internalNotes').value,
                    priceModifications: priceModifiedItems.map(item => ({
                        name: item.name,
                        originalPrice: item.originalPrice,
                        modifiedPrice: item.customPrice,
                        comment: item.priceModificationComment
                    })),
                    status: 'active',
                    createdDate: new Date().toISOString()
                };
                
                // Here you would normally send the quote data to the server
                console.log('Creating quote:', quoteData);
                
                const contactName = state.selectedQuoteContact.type === 'secondary' 
                    ? `${state.selectedQuoteContact.name} (${state.selectedQuoteContact.role})` 
                    : state.selectedCustomer.name;
                alert(`Quote created successfully for ${state.selectedCustomer.name}!\nQuote will be sent to: ${contactName}`);
                // In real implementation: redirect to quotes list or quote detail page
                // window.location.href = 'quotes.html';
                });
            }
            
            // PDF Preview modal buttons
            const closePdfPreviewBtn = document.getElementById('closePdfPreview');
            const downloadPdfFromPreviewBtn = document.getElementById('downloadPdfFromPreview');
            
            if (closePdfPreviewBtn) {
                closePdfPreviewBtn.addEventListener('click', closePdfPreview);
            }
            if (downloadPdfFromPreviewBtn) {
                downloadPdfFromPreviewBtn.addEventListener('click', function() {
                    downloadQuotePDF();
                    closePdfPreview();
                });
            }
            
            // Close PDF preview on ESC key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    const pdfModal = document.getElementById('pdfPreviewModal');
                    if (pdfModal && !pdfModal.classList.contains('hidden')) {
                        closePdfPreview();
                    }
                }
            });
            
            // Invoice preview modal buttons
            const closeInvoicePreviewBtn = document.getElementById('closeInvoicePreviewBtn');
            const createAllInvoicesBtn = document.getElementById('createAllInvoicesBtn');
            
            if (closeInvoicePreviewBtn) {
                closeInvoicePreviewBtn.addEventListener('click', hideInvoicePreview);
            }
            if (createAllInvoicesBtn) {
                createAllInvoicesBtn.addEventListener('click', createAllInvoicesFromPreview);
            }
            
            // Close invoice preview modal on background click
            const invoicePreviewModal = document.getElementById('invoicePreviewModal');
            if (invoicePreviewModal) {
                invoicePreviewModal.addEventListener('click', function(e) {
                    if (e.target.id === 'invoicePreviewModal') {
                        hideInvoicePreview();
                    }
                });
            }
            
            // Close invoice preview modal on ESC key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    const invoicePreviewModal = document.getElementById('invoicePreviewModal');
                    if (invoicePreviewModal && !invoicePreviewModal.classList.contains('hidden')) {
                        hideInvoicePreview();
                    }
                }
            });
            
            // Price modification modal event listeners
            const closePriceModModal = document.getElementById('closePriceModModal');
            const cancelPriceModBtn = document.getElementById('cancelPriceModBtn');
            const savePriceModBtn = document.getElementById('savePriceModBtn');
            const priceModModal = document.getElementById('priceModModal');
            
            if (closePriceModModal) {
                closePriceModModal.addEventListener('click', cancelPriceModification);
            }
            if (cancelPriceModBtn) {
                cancelPriceModBtn.addEventListener('click', cancelPriceModification);
            }
            if (savePriceModBtn) {
                savePriceModBtn.addEventListener('click', confirmPriceModification);
            }
            
            // Close modal on background click
            if (priceModModal) {
                priceModModal.addEventListener('click', function(e) {
                    if (e.target.id === 'priceModModal') {
                        cancelPriceModification();
                    }
                });
                
                // Close modal on Escape key
                document.addEventListener('keydown', function(e) {
                    if (e.key === 'Escape' && !priceModModal.classList.contains('hidden')) {
                        cancelPriceModification();
                    }
                });
            }

            // Initialize payment model constraints on page load
            updatePaymentModel();
            
            // Payment configuration event listeners with autosave
            const defaultPaymentTerms = document.getElementById('defaultPaymentTerms');
            const subscriptionStartDate = document.getElementById('subscriptionStartDate');
            const billingFrequency = document.getElementById('billingFrequency');
            
            // Autosave payment configuration on change
            if (defaultPaymentTerms) {
                defaultPaymentTerms.addEventListener('change', function() {
                    updatePaymentTermsDisplay();
                    autoSavePaymentConfiguration();
                });
            }
            
            // Add autosave to all payment config inputs
            const paymentConfigInputs = document.querySelectorAll('#paymentConfigContent input, #paymentConfigContent select, #paymentConfigContent textarea');
            paymentConfigInputs.forEach(input => {
                input.addEventListener('change', autoSavePaymentConfiguration);
            });
            
            // Payment method radio buttons
            const paymentMethodsContainer = document.getElementById('paymentMethodsContainer');
            if (paymentMethodsContainer) {
                document.querySelectorAll('#paymentMethodsContainer input[type="radio"]').forEach(radio => {
                    radio.addEventListener('change', updatePaymentMethodsDisplay);
                });
            }
            
            // Subscription date changes
            if (subscriptionStartDate) {
                subscriptionStartDate.addEventListener('change', calculateNextInvoiceDate);
            }
            if (billingFrequency) {
                billingFrequency.addEventListener('change', calculateNextInvoiceDate);
            }
            
            // Initialize payment configuration displays
            updatePaymentModel();
            updatePaymentTermsDisplay();
            updatePaymentMethodsDisplay();

            // Initialize invoice management
            loadInvoices();
            updateInvoiceSummary();

            // Initialize split invoice functionality
            initializeSplitInvoice();

            // Initialize invoice distribution functionality
            initializeDistribution();

            // Initial render
            renderQuoteItems();
            updateSummary();
        });

        // Create Invoice from Quote
        function createInvoiceFromQuote() {
            // Get current quote ID (in real app, get from URL or data)
            const quoteId = document.getElementById('quoteIdBadge').textContent;
            
            // Validate quote status
            const quoteStatus = document.getElementById('quoteStatusBadge').textContent.toLowerCase();
            
            if (quoteStatus === 'draft') {
                if (!confirm('This quote is still in draft status. Do you want to create an invoice anyway?')) {
                    return;
                }
            }
            
            // Navigate to invoice creation page with quote ID
            window.location.href = `invoice_create_simple.html?quoteId=${quoteId}`;
        }

        // ============================================================================
        // TAB SWITCHING FUNCTIONALITY
        // ============================================================================

        function updateTabsVisibility() {
            const restrictedStatuses = ['expired', 'rejected', 'draft'];
            const paymentConfigTab = document.getElementById('paymentConfigTab');
            const invoicesTab = document.getElementById('invoicesTab');
            
            if (restrictedStatuses.includes(state.quoteStatus)) {
                // Disable and gray out tabs
                [paymentConfigTab, invoicesTab].forEach(tab => {
                    tab.classList.add('opacity-50', 'cursor-not-allowed');
                    tab.classList.remove('hover:text-gray-700', 'hover:border-gray-300');
                });
            } else {
                // Enable tabs
                [paymentConfigTab, invoicesTab].forEach(tab => {
                    tab.classList.remove('opacity-50', 'cursor-not-allowed');
                    tab.classList.add('hover:text-gray-700', 'hover:border-gray-300');
                });
            }
        }

        function switchTab(tabName) {
            // Check if expired/rejected/draft quotes can access Payment Configuration or Invoices tabs
            const restrictedStatuses = ['expired', 'rejected', 'draft'];
            const restrictedTabs = ['paymentConfig', 'invoices'];
            
            if (restrictedStatuses.includes(state.quoteStatus) && restrictedTabs.includes(tabName)) {
                let message = '';
                if (state.quoteStatus === 'expired') {
                    message = ' This quote has expired. Please renew or clone the quote before managing invoices or payment configuration.';
                } else if (state.quoteStatus === 'rejected') {
                    message = ' This quote has been rejected. Clone the quote to create a new one if needed.';
                } else if (state.quoteStatus === 'draft') {
                    message = ' This quote is still in draft. Send it to the customer and get approval before configuring payments or creating invoices.';
                }
                alert(message);
                return; // Prevent tab switch
            }
            
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            // Remove active class from all tab buttons
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active', 'border-blue-500', 'text-blue-600');
                button.classList.add('border-transparent', 'text-gray-500');
            });
            
            // Show selected tab content
            document.getElementById(tabName + 'Content').classList.remove('hidden');
            
            // Add active class to selected tab button
            const activeButton = document.getElementById(tabName + 'Tab');
            activeButton.classList.add('active', 'border-blue-500', 'text-blue-600');
            activeButton.classList.remove('border-transparent', 'text-gray-500');
            
            // Update invoice summary when switching to invoices tab
            if (tabName === 'invoices') {
                updateInvoiceSummary();
            }
            
            // Update invoice summary when switching to Payment Configuration tab to show current remaining amount
            if (tabName === 'paymentConfig') {
                updateInvoiceSummary();
            }
        }
        

        // ============================================================================
        // PAYMENT CONFIGURATION FUNCTIONALITY
        // ============================================================================

        // Payment method constraints based on payment model
        const paymentMethodConstraints = {
            full: {
                allowed: ['stripe', 'paypal', 'google_wallet', 'apple_pay', 'cash'],
                hint: 'All payment methods available for full payment'
            },
            deposit: {
                allowed: ['stripe', 'paypal', 'cash'],
                hint: 'Deposit payments support Stripe, PayPal, and Cash only',
                reason: 'Digital wallets not supported for deposit payments'
            },
            subscription: {
                allowed: ['stripe', 'paypal'],
                required: true,
                hint: 'Subscription requires auto-charge capable methods (Stripe or PayPal)',
                reason: 'Only Stripe and PayPal support recurring automatic charges'
            }
        };

        // Payment model functions
        function updatePaymentModel() {
            const model = document.querySelector('input[name="paymentModel"]:checked').value;
            console.log('Payment model changed to:', model); // Debug log
            const depositSection = document.getElementById('paymentDepositSection');
            const subscriptionSection = document.getElementById('subscriptionSection');
            const depositInfo = document.getElementById('depositInfo');
            const paymentModelDisplay = document.getElementById('paymentModelDisplay');
            
            console.log('Deposit section element:', depositSection); // Debug log
            
            // Hide all sections first
            if (depositSection) depositSection.classList.add('hidden');
            if (subscriptionSection) subscriptionSection.classList.add('hidden');
            if (depositInfo) depositInfo.classList.add('hidden');
            
            // Get payment method elements
            const stripeRadio = document.getElementById('paymentStripe');
            const cashRadio = document.getElementById('paymentCash');
            const cashLabel = cashRadio ? cashRadio.closest('label') : null;
            const paymentMethodHint = document.getElementById('paymentMethodHint');
            
            if (model === 'deposit') {
                if (depositSection) depositSection.classList.remove('hidden');
                if (depositInfo) depositInfo.classList.remove('hidden');
                if (paymentModelDisplay) paymentModelDisplay.textContent = 'Down Payment';
                
                // Enable both payment methods for deposit
                if (cashRadio) {
                    cashRadio.disabled = false;
                    if (cashLabel) {
                        cashLabel.classList.remove('opacity-50', 'cursor-not-allowed');
                        cashLabel.classList.add('cursor-pointer');
                    }
                }
                if (paymentMethodHint) {
                    paymentMethodHint.textContent = 'Select one payment method';
                    paymentMethodHint.classList.remove('text-orange-600');
                }
            } else if (model === 'subscription') {
                if (subscriptionSection) subscriptionSection.classList.remove('hidden');
                if (paymentModelDisplay) paymentModelDisplay.textContent = 'Subscription';
                // Set default subscription start date to today
                const startDateInput = document.getElementById('subscriptionStartDate');
                if (startDateInput) startDateInput.value = new Date().toISOString().split('T')[0];
                calculateNextInvoiceDate();
                
                // Disable Cash for subscription - only Stripe is supported
                if (cashRadio) {
                    cashRadio.disabled = true;
                    if (cashRadio.checked) {
                        // If Cash was selected, switch to Stripe
                        if (stripeRadio) {
                            stripeRadio.checked = true;
                            updatePaymentMethodsDisplay();
                        }
                    }
                    if (cashLabel) {
                        cashLabel.classList.add('opacity-50', 'cursor-not-allowed');
                        cashLabel.classList.remove('cursor-pointer', 'hover:bg-gray-50');
                    }
                }
                // Ensure Stripe is selected
                if (stripeRadio && !stripeRadio.checked) {
                    stripeRadio.checked = true;
                    updatePaymentMethodsDisplay();
                }
                if (paymentMethodHint) {
                    paymentMethodHint.textContent = 'Subscription requires Stripe for automatic recurring charges. Cash is not supported.';
                    paymentMethodHint.classList.add('text-orange-600');
                }
            } else {
                if (paymentModelDisplay) paymentModelDisplay.textContent = 'Full Payment';
                
                // Enable both payment methods for full payment
                if (cashRadio) {
                    cashRadio.disabled = false;
                    if (cashLabel) {
                        cashLabel.classList.remove('opacity-50', 'cursor-not-allowed');
                        cashLabel.classList.add('cursor-pointer');
                    }
                }
                if (paymentMethodHint) {
                    paymentMethodHint.textContent = 'Select one payment method';
                    paymentMethodHint.classList.remove('text-orange-600');
                }
            }
            
            // Update payment methods display
            updatePaymentMethodsDisplay();
            
            // Update invoice summary if on invoices tab
            const invoicesContent = document.getElementById('invoicesContent');
            if (invoicesContent && !invoicesContent.classList.contains('hidden')) {
                updateInvoiceSummary();
            }
            
            // Update invoice tab summary
            const invoiceModelDisplay = document.getElementById('invoiceTabPaymentModel');
            const invoiceDepositInfo = document.getElementById('invoiceTabDepositInfo');
            const invoiceDepositAmount = document.getElementById('invoiceTabDepositAmount');
            
            if (invoiceModelDisplay) {
                if (model === 'deposit') {
                    invoiceModelDisplay.textContent = 'Down Payment';
                    if (invoiceDepositInfo) {
                        invoiceDepositInfo.classList.remove('hidden');
                        const depositAmount = parseFloat(document.getElementById('depositAmount')?.value) || 0;
                        if (invoiceDepositAmount) {
                            invoiceDepositAmount.textContent = `$${depositAmount.toFixed(2)}`;
                        }
                    }
                } else if (model === 'subscription') {
                    invoiceModelDisplay.textContent = 'Subscription';
                    if (invoiceDepositInfo) {
                        invoiceDepositInfo.classList.add('hidden');
                    }
                } else {
                    invoiceModelDisplay.textContent = 'Full Payment';
                    if (invoiceDepositInfo) {
                        invoiceDepositInfo.classList.add('hidden');
                    }
                }
            }
        }

        function toggleEndDate() {
            const endType = document.getElementById('subscriptionEnd').value;
            const cyclesInput = document.getElementById('cyclesInput');
            const endDateInput = document.getElementById('endDateInput');
            
            cyclesInput.classList.add('hidden');
            endDateInput.classList.add('hidden');
            
            if (endType === 'after_cycles') {
                cyclesInput.classList.remove('hidden');
            } else if (endType === 'end_date') {
                endDateInput.classList.remove('hidden');
            }
            
            calculateNextInvoiceDate();
        }

        function calculateNextInvoiceDate() {
            const startDate = new Date(document.getElementById('subscriptionStartDate').value);
            const frequency = document.getElementById('billingFrequency').value;
            
            if (!startDate || isNaN(startDate)) {
                document.getElementById('nextInvoiceDate').textContent = '-';
                return;
            }
            
            const nextDate = new Date(startDate);
            
            switch(frequency) {
                case 'weekly':
                    nextDate.setDate(nextDate.getDate() + 7);
                    break;
                case 'biweekly':
                    nextDate.setDate(nextDate.getDate() + 14);
                    break;
                case 'monthly':
                    nextDate.setMonth(nextDate.getMonth() + 1);
                    break;
                case 'quarterly':
                    nextDate.setMonth(nextDate.getMonth() + 3);
                    break;
                case 'yearly':
                    nextDate.setFullYear(nextDate.getFullYear() + 1);
                    break;
            }
            
            document.getElementById('nextInvoiceDate').textContent = nextDate.toLocaleDateString();
        }

        function updateDepositCalculation() {
            const depositAmount = parseFloat(document.getElementById('depositAmount').value) || 0;
            const total = calculateTotal();
            const percentage = (depositAmount / total * 100).toFixed(0);
            const remaining = total - depositAmount;
            
            document.getElementById('depositPercentage').value = percentage;
            document.getElementById('remainingBalance').textContent = `$${remaining.toFixed(2)}`;
            document.getElementById('depositAmountDisplay').textContent = `$${depositAmount.toFixed(2)}`;
            document.getElementById('remainingBalanceDisplay').textContent = `$${remaining.toFixed(2)}`;
            
            // Update invoice tab summary
            const invoiceDepositAmount = document.getElementById('invoiceTabDepositAmount');
            const invoiceRemainingBalance = document.getElementById('invoiceTabRemainingBalance');
            if (invoiceDepositAmount) {
                invoiceDepositAmount.textContent = `$${depositAmount.toFixed(2)}`;
            }
            if (invoiceRemainingBalance) {
                invoiceRemainingBalance.textContent = `$${remaining.toFixed(2)}`;
            }
        }

        function updateDepositFromPercentage() {
            const percentage = parseFloat(document.getElementById('depositPercentage').value) || 0;
            const total = calculateTotal();
            const depositAmount = (total * percentage / 100);
            const remaining = total - depositAmount;
            
            document.getElementById('depositAmount').value = depositAmount.toFixed(2);
            document.getElementById('remainingBalance').textContent = `$${remaining.toFixed(2)}`;
            document.getElementById('depositAmountDisplay').textContent = `$${depositAmount.toFixed(2)}`;
            document.getElementById('remainingBalanceDisplay').textContent = `$${remaining.toFixed(2)}`;
            
            // Update invoice tab summary
            const invoiceDepositAmount = document.getElementById('invoiceTabDepositAmount');
            const invoiceRemainingBalance = document.getElementById('invoiceTabRemainingBalance');
            if (invoiceDepositAmount) {
                invoiceDepositAmount.textContent = `$${depositAmount.toFixed(2)}`;
            }
            if (invoiceRemainingBalance) {
                invoiceRemainingBalance.textContent = `$${remaining.toFixed(2)}`;
            }
        }

        function setDepositPercentage(percent) {
            document.getElementById('depositPercentage').value = percent;
            updateDepositFromPercentage();
        }

        function updatePaymentTermsDisplay() {
            const terms = document.getElementById('defaultPaymentTerms').value;
            const display = document.getElementById('paymentTermsDisplay');
            
            const termsMap = {
                'due_on_receipt': 'Due on Receipt',
                'net_7': 'Net 7 Days',
                'net_15': 'Net 15 Days',
                'net_30': 'Net 30 Days',
                'net_60': 'Net 60 Days'
            };
            
            const termsText = termsMap[terms] || 'Net 30 Days';
            display.textContent = termsText;
            
            // Update invoice tab summary
            const invoiceTermsDisplay = document.getElementById('invoiceTabPaymentTerms');
            if (invoiceTermsDisplay) {
                invoiceTermsDisplay.textContent = termsText;
            }
        }

        function updatePaymentMethodsDisplay() {
            const selectedRadio = document.querySelector('#paymentMethodsContainer input[type="radio"]:checked');
            const selectedMethod = selectedRadio ? selectedRadio.value : 'None';
            const displayText = selectedMethod === 'stripe' ? 'Stripe' : selectedMethod === 'cash' ? 'Cash' : 'None selected';
            
            document.getElementById('paymentMethodsDisplay').textContent = displayText;
            
            // Don't override hint text if subscription is selected (it has its own message)
            const paymentModel = document.querySelector('input[name="paymentModel"]:checked')?.value;
            if (paymentModel === 'subscription') {
                return; // Keep the subscription-specific hint message
            }
            
            // Update invoice tab summary
            const invoiceMethodsDisplay = document.getElementById('invoiceTabPaymentMethods');
            if (invoiceMethodsDisplay) {
                invoiceMethodsDisplay.textContent = displayText;
            }
        }

        function autoSavePaymentConfiguration() {
            const paymentModel = document.querySelector('input[name="paymentModel"]:checked');
            if (!paymentModel) return; // Skip if not selected yet
            
            // Get selected payment method (single selection)
            const selectedPaymentMethod = document.querySelector('input[name="paymentMethod"]:checked');
            const paymentMethod = selectedPaymentMethod ? selectedPaymentMethod.value : null;
            
            const paymentConfig = {
                paymentModel: paymentModel.value,
                paymentMethod: paymentMethod,
                paymentTerms: document.getElementById('defaultPaymentTerms')?.value,
                paymentInstructions: document.getElementById('paymentInstructions')?.value
            };
            
            // Add subscription data if applicable
            if (paymentModel.value === 'subscription') {
                const startDate = document.getElementById('subscriptionStartDate')?.value;
                
                paymentConfig.subscription = {
                    frequency: document.getElementById('billingFrequency')?.value,
                    startDate: startDate,
                    endType: document.getElementById('subscriptionEnd')?.value,
                    autoCharge: document.getElementById('autoCharge')?.checked
                };
                
                const endType = document.getElementById('subscriptionEnd')?.value;
                if (endType === 'after_cycles') {
                    const cycles = parseInt(document.getElementById('billingCycles')?.value);
                    if (cycles && cycles > 0) {
                    paymentConfig.subscription.billingCycles = cycles;
                    }
                } else if (endType === 'end_date') {
                    const endDate = document.getElementById('subscriptionEndDate')?.value;
                    if (endDate) {
                    paymentConfig.subscription.endDate = endDate;
                }
            }
            }
            
            // Add deposit data if applicable
            if (paymentModel.value === 'deposit') {
                const depositAmount = parseFloat(document.getElementById('depositAmount')?.value) || 0;
                if (depositAmount > 0) {
                paymentConfig.deposit = {
                    amount: depositAmount,
                        percentage: parseFloat(document.getElementById('depositPercentage')?.value) || 0
                };
                }
            }
            
            console.log('Auto-saving payment configuration:', paymentConfig);
            
            // In real implementation, save to server silently
            // await fetch('/api/quotes/payment-config', { method: 'POST', body: JSON.stringify(paymentConfig) });
        }

        // ============================================================================
        // INVOICE MANAGEMENT FUNCTIONALITY
        // ============================================================================

        // Invoice data for the quote (starts empty, populated when invoices are created)
        let quoteInvoices = [];
        
        // Store preview invoices for creation
        let previewInvoices = [];

        function createFullInvoice() {
            const quoteTotal = calculateTotal();
            const remainingAmount = getRemainingToInvoice();
            
            if (remainingAmount <= 0) {
                alert('This quote has already been fully invoiced. You cannot create additional invoices beyond 100% of the quote amount.');
                return;
            }
            
            if (confirm(`Create a full invoice for $${remainingAmount.toFixed(2)}?`)) {
                // Navigate to invoice creation with full amount
                const quoteId = document.getElementById('quoteIdBadge').textContent;
                window.location.href = `invoice_create_simple.html?quoteId=${quoteId}&type=full&amount=${remainingAmount}`;
            }
        }

        function createPartialInvoice() {
            const remainingAmount = getRemainingToInvoice();
            
            if (remainingAmount <= 0) {
                alert('This quote has already been fully invoiced. You cannot create additional invoices beyond 100% of the quote amount.');
                return;
            }
            
            alert('Partial invoice creation will open an item selection interface.');
            // In real implementation, this would open a modal to select specific items
            const quoteId = document.getElementById('quoteIdBadge').textContent;
            window.location.href = `invoice_create_simple.html?quoteId=${quoteId}&type=partial`;
        }
        
        function createInvoices() {
            // Check if quote status allows invoice creation
            const restrictedStatuses = ['expired', 'rejected', 'draft'];
            if (restrictedStatuses.includes(state.quoteStatus)) {
                let message = '';
                if (state.quoteStatus === 'expired') {
                    message = ' Cannot create invoices for an expired quote.\n\nPlease renew the quote first to extend its validity period.';
                } else if (state.quoteStatus === 'rejected') {
                    message = ' Cannot create invoices for a rejected quote.\n\nThis quote was not accepted by the customer.';
                } else if (state.quoteStatus === 'draft') {
                    message = ' Cannot create invoices for a draft quote.\n\nPlease send the quote to the customer and wait for approval first.';
                }
                alert(message);
                return;
            }
            
            const remainingAmount = getRemainingToInvoice();
            
            if (remainingAmount <= 0) {
                alert('This quote has already been fully invoiced. You cannot create additional invoices beyond 100% of the quote amount.');
                return;
            }
            
            // Show invoice preview modal or navigate to invoice creation
            showInvoicePreview();
        }

        function refreshInvoices() {
            loadInvoices();
            updateInvoiceSummary();
        }

        function loadInvoices() {
            const invoicesList = document.getElementById('invoicesList');
            const noInvoicesState = document.getElementById('noInvoicesState');
            const invoiceCountEl = document.getElementById('invoiceCount');
            
            // Update invoice count
            const activeInvoices = quoteInvoices.filter(inv => inv.status !== 'cancelled');
            const cancelledCount = quoteInvoices.length - activeInvoices.length;
            
            // Count overdue invoices
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const overdueCount = activeInvoices.filter(inv => {
                const dueDate = new Date(inv.dueDate);
                dueDate.setHours(0, 0, 0, 0);
                return inv.status === 'unpaid' && dueDate < today;
            }).length;
            
            let countText = `${activeInvoices.length} Invoice${activeInvoices.length !== 1 ? 's' : ''}`;
            if (overdueCount > 0) {
                countText += ` <span class="text-red-600 font-bold">(${overdueCount} overdue)</span>`;
            }
            if (cancelledCount > 0) {
                countText += ` <span class="text-gray-500">(${cancelledCount} cancelled)</span>`;
            }
            invoiceCountEl.innerHTML = countText;
            
            // Show/hide overdue warning banner
            const overdueWarningBanner = document.getElementById('overdueWarningBanner');
            if (overdueCount > 0) {
                overdueWarningBanner.classList.remove('hidden');
                document.getElementById('overdueWarningTitle').textContent = `${overdueCount} Overdue Invoice${overdueCount !== 1 ? 's' : ''}`;
                document.getElementById('overdueWarningMessage').textContent = overdueCount === 1 
                    ? 'You have 1 overdue invoice that requires immediate attention.'
                    : `You have ${overdueCount} overdue invoices that require immediate attention.`;
            } else {
                overdueWarningBanner.classList.add('hidden');
            }
            
            if (quoteInvoices.length === 0) {
                invoicesList.innerHTML = '';
                noInvoicesState.classList.remove('hidden');
                return;
            }
            
            noInvoicesState.classList.add('hidden');
            
            invoicesList.innerHTML = quoteInvoices.map(invoice => {
                const statusColors = {
                    'paid': 'bg-green-100 text-green-700',
                    'unpaid': 'bg-red-100 text-red-700',
                    'cancelled': 'bg-gray-100 text-gray-700'
                };
                
                const typeLabels = {
                    'full': 'Full Invoice',
                    'deposit': 'Deposit Invoice', 
                    'partial': 'Balance Invoice',
                    'subscription': 'Subscription Invoice'
                };
                
                const outstanding = invoice.amount - invoice.paidAmount;
                
                // Check if invoice is overdue
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const dueDate = new Date(invoice.dueDate);
                dueDate.setHours(0, 0, 0, 0);
                const isOverdue = invoice.status === 'unpaid' && dueDate < today;
                
                return `
                    <div class="bg-white border rounded-lg p-4 hover:shadow-sm transition-shadow ${invoice.status === 'cancelled' ? 'opacity-60' : ''} ${isOverdue ? 'border-red-400 border-2' : 'border-gray-200'}">
                        <div class="flex items-start justify-between mb-3">
                            <div class="flex items-center gap-2 flex-wrap">
                                <span class="text-lg font-semibold text-gray-900 ${invoice.status === 'cancelled' ? 'line-through' : ''}">${invoice.id}</span>
                                <span class="px-2 py-0.5 text-xs rounded-full font-medium ${statusColors[invoice.status]}">${invoice.status.charAt(0).toUpperCase() + invoice.status.slice(1)}</span>
                                ${isOverdue ? `<span class="px-2 py-0.5 text-xs rounded-full font-bold bg-red-600 text-white flex items-center gap-1">
                                    <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                                    </svg>
                                    OVERDUE
                                </span>` : ''}
                            </div>
                            <div class="text-right">
                                <div class="text-xl font-bold text-gray-900 ${invoice.status === 'cancelled' ? 'line-through' : ''}">$${invoice.amount.toFixed(2)}</div>
                                ${invoice.paidAmount > 0 && invoice.status !== 'cancelled' ? `<div class="text-sm text-green-600 font-medium">Paid: $${invoice.paidAmount.toFixed(2)}</div>` : ''}
                            </div>
                        </div>
                        
                        <div class="flex items-center justify-between text-sm mb-3">
                            <span class="font-medium text-gray-600">${typeLabels[invoice.type]}</span>
                            <span class="${isOverdue ? 'text-red-600 font-bold' : 'text-gray-600'}">
                                Due: ${new Date(invoice.dueDate).toLocaleDateString()}
                                ${isOverdue ? ` (${Math.floor((today - dueDate) / (1000 * 60 * 60 * 24))} days ago)` : ''}
                            </span>
                        </div>
                        
                        ${invoice.payer ? `
                            <div class="bg-purple-50 border border-purple-200 rounded-lg p-2 mb-3">
                                <div class="flex items-center gap-2">
                                    <svg class="w-4 h-4 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                    </svg>
                                    <div class="flex-1">
                                        <div class="text-xs font-semibold text-purple-900">Payer: ${invoice.payer.name}</div>
                                        ${invoice.payer.email ? `<div class="text-xs text-purple-700">${invoice.payer.email}</div>` : ''}
                                        ${invoice.payer.percentage ? `<div class="text-xs text-purple-600">${invoice.payer.percentage}% allocation</div>` : ''}
                                    </div>
                                </div>
                            </div>
                        ` : ''}
                        
                        ${invoice.paymentMethod ? `
                            <div class="text-xs text-gray-500 mb-3">
                                Payment Method: <span class="font-medium">${invoice.paymentMethod}</span>
                            </div>
                        ` : ''}
                        
                        ${invoice.status !== 'cancelled' ? `
                            ${invoice.status === 'paid' ? `
                                <!-- Paid Invoice: Only View button -->
                            <button 
                                onclick="viewInvoice('${invoice.id}')"
                                    class="w-full px-4 py-2 text-sm font-medium border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors"
                                >
                                    View Invoice
                                </button>
                            ` : `
                                <!-- Unpaid Invoice: View and Send buttons -->
                                <div class="grid grid-cols-2 gap-2 mb-2">
                                    <button 
                                        onclick="viewInvoice('${invoice.id}')"
                                        class="px-4 py-2 text-sm font-medium border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors"
                            >
                                View
                            </button>
                            <button 
                                onclick="sendInvoice('${invoice.id}')"
                                        class="px-4 py-2 text-sm font-medium border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors"
                            >
                                Send
                            </button>
                                </div>
                                <div class="grid grid-cols-2 gap-2">
                                <button 
                                        onclick="openRecordPaymentModal('${invoice.id}')"
                                        class="px-4 py-2 text-sm font-medium bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors"
                                >
                                        Confirm Payment
                                </button>
                                    <button 
                                        onclick="cancelInvoice('${invoice.id}')"
                                        class="px-4 py-2 text-sm font-medium bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors"
                                    >
                                        Cancel Invoice
                                    </button>
                        </div>
                            `}
                        ` : `
                            <div class="bg-gray-50 border border-gray-200 rounded-lg p-3 text-center">
                                <p class="text-sm font-medium text-gray-700"> This invoice has been cancelled</p>
                                ${invoice.cancelledDate ? `<p class="text-xs text-gray-500 mt-1">Cancelled on: ${new Date(invoice.cancelledDate).toLocaleDateString()}</p>` : ''}
                            </div>
                        `}
                    </div>
                `;
            }).join('');
        }

        function updateInvoiceSummary() {
            const quoteTotal = calculateTotal();
            const subtotal = calculateSubtotal();
            const lineItemDiscounts = calculateLineItemDiscounts();
            const taxBreakdown = getTaxBreakdown();
            const totalTax = calculateTax();

            // Update quote-style financial breakdown
            const invoiceSubtotalEl = document.getElementById('invoiceSubtotalAmount');
            if (invoiceSubtotalEl) {
                invoiceSubtotalEl.textContent = `$${subtotal.toFixed(2)}`;
            }

            const invoiceDiscountSection = document.getElementById('invoiceLineItemDiscountSection');
            const invoiceDiscountAmount = document.getElementById('invoiceLineItemDiscountAmount');
            if (invoiceDiscountSection && invoiceDiscountAmount) {
                if (lineItemDiscounts > 0) {
                    invoiceDiscountSection.classList.remove('hidden');
                    invoiceDiscountAmount.textContent = `-$${lineItemDiscounts.toFixed(2)}`;
                } else {
                    invoiceDiscountSection.classList.add('hidden');
                }
            }

            const taxBreakdownContainer = document.getElementById('invoiceTaxBreakdown');
            if (taxBreakdownContainer) {
                let breakdownHTML = '';
                if (taxBreakdown.taxable_gst > 0) {
                    breakdownHTML += `<div class="flex justify-between"><span>GST (10%):</span><span>$${taxBreakdown.taxable_gst.toFixed(2)}</span></div>`;
                }
                if (taxBreakdown.gst_free > 0) {
                    breakdownHTML += `<div class="flex justify-between text-gray-500"><span>GST-Free:</span><span>$0.00</span></div>`;
                }
                if (taxBreakdown.input_taxed > 0) {
                    breakdownHTML += `<div class="flex justify-between text-gray-500"><span>Input-Taxed:</span><span>$0.00</span></div>`;
                }
                taxBreakdownContainer.innerHTML = breakdownHTML || '<div class="text-gray-400">No taxable items</div>';
            }

            const invoiceTaxAmount = document.getElementById('invoiceTaxAmount');
            if (invoiceTaxAmount) {
                invoiceTaxAmount.textContent = `$${totalTax.toFixed(2)}`;
            }
            const invoiceQuoteTotalEl = document.getElementById('invoiceQuoteTotal');
            if (invoiceQuoteTotalEl) {
                invoiceQuoteTotalEl.textContent = `$${quoteTotal.toFixed(2)}`;
            }

            // Exclude cancelled invoices from calculations
            const activeInvoices = quoteInvoices.filter(inv => inv.status !== 'cancelled');
            const totalInvoiced = activeInvoices.reduce((sum, inv) => sum + inv.amount, 0);
            const totalPaid = activeInvoices.reduce((sum, inv) => sum + inv.paidAmount, 0);
            const totalOutstanding = totalInvoiced - totalPaid;
            const remainingToInvoice = Math.max(0, quoteTotal - totalInvoiced); // Cap at 0, can't be negative
            
            // Check payment model for down payment breakdown
            const paymentModel = document.querySelector('input[name="paymentModel"]:checked')?.value || 'full';
            const isDownPayment = paymentModel === 'deposit';
            const downPaymentBreakdown = document.getElementById('downPaymentBreakdown');
            
            if (isDownPayment && downPaymentBreakdown) {
                // Calculate deposit and balance invoiced amounts
                const depositInvoices = activeInvoices.filter(inv => inv.type === 'deposit');
                const balanceInvoices = activeInvoices.filter(inv => inv.type === 'partial');
                const depositInvoiced = depositInvoices.reduce((sum, inv) => sum + inv.amount, 0);
                const balanceInvoiced = balanceInvoices.reduce((sum, inv) => sum + inv.amount, 0);
                
                // Get configured deposit amount
                const depositAmount = parseFloat(document.getElementById('depositAmount')?.value) || 0;
                const expectedBalance = Math.max(0, quoteTotal - depositAmount);
                const remainingBalance = Math.max(0, expectedBalance - balanceInvoiced);
                
                // Show breakdown
                downPaymentBreakdown.classList.remove('hidden');
                document.getElementById('depositInvoiced').textContent = `$${depositInvoiced.toFixed(2)}`;
                document.getElementById('balanceInvoiced').textContent = `$${balanceInvoiced.toFixed(2)}`;
                document.getElementById('remainingBalanceToInvoice').textContent = `$${remainingBalance.toFixed(2)}`;
            } else {
                // Hide breakdown for other payment models
                if (downPaymentBreakdown) {
                    downPaymentBreakdown.classList.add('hidden');
                }
            }
            
            // Update summary displays
            document.getElementById('invoiceQuoteTotal').textContent = `$${quoteTotal.toFixed(2)}`;
            document.getElementById('totalInvoiced').textContent = `$${totalInvoiced.toFixed(2)}`;
            document.getElementById('totalPaid').textContent = `$${totalPaid.toFixed(2)}`;
            document.getElementById('totalOutstanding').textContent = `$${totalOutstanding.toFixed(2)}`;
            document.getElementById('remainingToInvoice').textContent = `$${remainingToInvoice.toFixed(2)}`;
            
            // Update progress bar - cap at 100%
            const invoiceProgress = Math.min(100, (totalInvoiced / quoteTotal) * 100);
            document.getElementById('invoiceProgressBar').style.width = `${invoiceProgress}%`;
            
            // Update progress text - show 100% when fully or over-invoiced
            const actualProgress = (totalInvoiced / quoteTotal) * 100;
            if (actualProgress >= 100) {
                document.getElementById('invoiceProgressText').textContent = '100% of quote amount invoiced';
            } else {
                document.getElementById('invoiceProgressText').textContent = `${actualProgress.toFixed(0)}% of quote amount invoiced`;
            }
            
            // Update status badge - for down payment, only show "Fully Invoiced" when both deposit AND balance are invoiced
            const statusBadge = document.getElementById('invoiceStatusBadge');
            if (totalInvoiced === 0) {
                statusBadge.textContent = 'Not Invoiced';
                statusBadge.className = 'px-2 py-1 bg-gray-100 text-gray-700 rounded text-xs font-medium';
            } else if (isDownPayment) {
                // For down payment, check if both deposit and balance are fully invoiced
                const depositAmount = parseFloat(document.getElementById('depositAmount')?.value) || 0;
                const depositInvoices = activeInvoices.filter(inv => inv.type === 'deposit');
                const balanceInvoices = activeInvoices.filter(inv => inv.type === 'partial');
                const depositInvoiced = depositInvoices.reduce((sum, inv) => sum + inv.amount, 0);
                const balanceInvoiced = balanceInvoices.reduce((sum, inv) => sum + inv.amount, 0);
                const expectedBalance = Math.max(0, quoteTotal - depositAmount);
                
                const depositComplete = depositInvoiced >= depositAmount - 0.01; // Allow small rounding differences
                const balanceComplete = balanceInvoiced >= expectedBalance - 0.01;
                
                if (depositComplete && balanceComplete) {
                    statusBadge.textContent = 'Fully Invoiced';
                    statusBadge.className = 'px-2 py-1 bg-green-100 text-green-700 rounded text-xs font-medium';
                } else if (depositComplete && !balanceComplete) {
                    statusBadge.textContent = 'Deposit Paid - Balance Pending';
                    statusBadge.className = 'px-2 py-1 bg-yellow-100 text-yellow-700 rounded text-xs font-medium';
                } else {
                    statusBadge.textContent = 'Partially Invoiced';
                    statusBadge.className = 'px-2 py-1 bg-yellow-100 text-yellow-700 rounded text-xs font-medium';
                }
            } else if (remainingToInvoice > 0) {
                statusBadge.textContent = 'Partially Invoiced';
                statusBadge.className = 'px-2 py-1 bg-yellow-100 text-yellow-700 rounded text-xs font-medium';
            } else {
                statusBadge.textContent = 'Fully Invoiced';
                statusBadge.className = 'px-2 py-1 bg-green-100 text-green-700 rounded text-xs font-medium';
            }
        }

        function getRemainingToInvoice() {
            const quoteTotal = calculateTotal();
            // Exclude cancelled invoices from calculations
            const activeInvoices = quoteInvoices.filter(inv => inv.status !== 'cancelled');
            const totalInvoiced = activeInvoices.reduce((sum, inv) => sum + inv.amount, 0);
            return Math.max(0, quoteTotal - totalInvoiced); // Cap at 0, can't invoice more than quote total
        }

        function viewInvoice(invoiceId) {
            // Navigate to invoice detail page
            window.location.href = `invoice_detail_simple.html?id=${invoiceId}`;
        }

        function sendInvoice(invoiceId) {
            const invoice = quoteInvoices.find(inv => inv.id === invoiceId);
            if (invoice) {
                alert(`Invoice ${invoiceId} sent to customer!`);
                // In real implementation, send email to customer
            }
        }

        // Store current invoice being paid
        let currentPaymentInvoiceId = null;

        function openRecordPaymentModal(invoiceId) {
            const invoice = quoteInvoices.find(inv => inv.id === invoiceId);
            if (!invoice) return;
            
            currentPaymentInvoiceId = invoiceId;
            const outstanding = invoice.amount - invoice.paidAmount;
            
            // Populate modal
            document.getElementById('paymentInvoiceId').textContent = invoice.id;
            document.getElementById('paymentOutstanding').textContent = `$${outstanding.toFixed(2)}`;
            document.getElementById('paymentDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('paymentNotes').value = '';
            
            // Show modal
            document.getElementById('recordPaymentModal').classList.remove('hidden');
        }

        function closeRecordPaymentModal() {
            document.getElementById('recordPaymentModal').classList.add('hidden');
            currentPaymentInvoiceId = null;
        }

        function confirmRecordPayment() {
            const invoice = quoteInvoices.find(inv => inv.id === currentPaymentInvoiceId);
            if (!invoice) return;
            
            const date = document.getElementById('paymentDate').value;
            const notes = document.getElementById('paymentNotes').value;
            
            // Validation
            if (!date) {
                alert('Please select a payment date');
                return;
            }
            
            // Calculate full outstanding amount
            const outstanding = invoice.amount - invoice.paidAmount;
            
            // Confirm full payment
            const confirmMsg = `Confirm full payment of $${outstanding.toFixed(2)} for invoice ${invoice.id}?`;
            if (!confirm(confirmMsg)) {
                return;
            }
            
            // Record full payment
            invoice.paidAmount = invoice.amount; // Pay in full
            invoice.paymentMethod = 'Manual Payment';
                            invoice.status = 'paid';
            invoice.paymentDate = date;
            if (notes) {
                invoice.paymentNotes = notes;
            }
            
            // Initialize payment history if it doesn't exist
            if (!invoice.paymentHistory) {
                invoice.paymentHistory = [];
            }
            
            // Add to payment history
            invoice.paymentHistory.push({
                amount: outstanding,
                method: 'Manual Payment',
                date: date,
                notes: notes || '',
                recordedAt: new Date().toISOString()
            });
            
            // Refresh UI
                        loadInvoices();
                        updateInvoiceSummary();
            closeRecordPaymentModal();
            
            // Success message
            alert(` Payment of $${outstanding.toFixed(2)} recorded successfully for ${invoice.id}\\nInvoice is now marked as PAID.`);
        }

        // Keep the old function name for compatibility but redirect to new modal
        function recordPayment(invoiceId) {
            openRecordPaymentModal(invoiceId);
        }

        function cancelInvoice(invoiceId) {
            const invoice = quoteInvoices.find(inv => inv.id === invoiceId);
            if (!invoice) return;
            
            // Confirm cancellation
            const confirmMessage = `Are you sure you want to cancel invoice ${invoiceId}?\n\n` +
                `Amount: $${invoice.amount.toFixed(2)}\n` +
                `Status: ${invoice.status}\n` +
                (invoice.paidAmount > 0 ? `Paid Amount: $${invoice.paidAmount.toFixed(2)}\n\n` : '\n') +
                `This action cannot be undone.`;
            
            if (!confirm(confirmMessage)) {
                return;
            }
            
            // Check if invoice has payments
            if (invoice.paidAmount > 0) {
                const refundConfirm = confirm(
                    ` Warning: This invoice has received payments totaling $${invoice.paidAmount.toFixed(2)}.\n\n` +
                    `Cancelling this invoice does not automatically process refunds. ` +
                    `You will need to manually refund the customer if required.\n\n` +
                    `Do you still want to cancel this invoice?`
                );
                
                if (!refundConfirm) {
                    return;
                }
            }
            
            // Cancel the invoice
            invoice.status = 'cancelled';
            invoice.cancelledDate = new Date().toISOString().split('T')[0];
            invoice.cancelledBy = 'Manager'; // In real app, use actual user info
            
            // Refresh UI
            loadInvoices();
            updateInvoiceSummary();
            
            // Calculate remaining amount after cancellation
            const remainingAmount = getRemainingToInvoice();
            
            // Success message with remaining amount info
            let successMessage = ` Invoice ${invoiceId} has been cancelled successfully.\n\n`;
            if (remainingAmount > 0) {
                successMessage += ` Remaining amount to invoice: $${remainingAmount.toFixed(2)}\n\n`;
                successMessage += `You can now create new invoices for this amount by clicking "Generate Invoices" in the Payment Configuration tab.`;
            } else {
                successMessage += `This quote is now fully invoiced.`;
            }
            alert(successMessage);
        }

        function sendPaymentReminder() {
            const unpaidInvoices = quoteInvoices.filter(inv => inv.status === 'unpaid');
            
            if (unpaidInvoices.length === 0) {
                alert('No unpaid invoices to send reminders for.');
                return;
            }
            
            alert(`Payment reminder sent for ${unpaidInvoices.length} unpaid invoice(s)!`);
            // In real implementation, send reminder emails
        }

        function viewPaymentHistory() {
            const paidInvoices = quoteInvoices.filter(inv => inv.paidAmount > 0 && inv.status !== 'cancelled');
            
            if (paidInvoices.length === 0) {
                alert('No payment history available.');
                return;
            }
            
            let historyText = 'Payment History:\\n\\n';
            paidInvoices.forEach(invoice => {
                historyText += `${invoice.id}: $${invoice.paidAmount.toFixed(2)}`;
                if (invoice.paymentDate) {
                    historyText += ` (${new Date(invoice.paymentDate).toLocaleDateString()})`;
                }
                historyText += '\\n';
            });
            
            alert(historyText);
            // In real implementation, open a detailed payment history modal
        }

        function downloadInvoiceReport() {
            alert('Invoice report download would be implemented here.');
            // In real implementation, generate and download PDF report
        }

        function createDepositInvoice() {
            const remainingAmount = getRemainingToInvoice();
            
            if (remainingAmount <= 0) {
                alert('This quote has already been fully invoiced. You cannot create additional invoices beyond 100% of the quote amount.');
                return;
            }
            
            const paymentModel = document.querySelector('input[name="paymentModel"]:checked')?.value;
            
            if (paymentModel !== 'deposit') {
                alert('Please configure deposit settings in the Payment Configuration tab first.');
                switchTab('paymentConfig');
                return;
            }
            
            const depositAmount = parseFloat(document.getElementById('depositAmount')?.value) || 0;
            
            if (depositAmount <= 0) {
                alert('Please set a valid deposit amount in the Payment Configuration tab.');
                switchTab('paymentConfig');
                return;
            }
            
            // Ensure deposit amount doesn't exceed remaining amount
            const actualDepositAmount = Math.min(depositAmount, remainingAmount);
            
            if (actualDepositAmount < depositAmount) {
                if (!confirm(`The configured deposit amount ($${depositAmount.toFixed(2)}) exceeds the remaining invoiceable amount ($${remainingAmount.toFixed(2)}). Create a deposit invoice for $${actualDepositAmount.toFixed(2)} instead?`)) {
                    return;
                }
            } else {
                if (!confirm(`Create a deposit invoice for $${actualDepositAmount.toFixed(2)}?`)) {
                    return;
                }
            }
            
            const quoteId = document.getElementById('quoteIdBadge').textContent;
            window.location.href = `invoice_create_simple.html?quoteId=${quoteId}&type=deposit&amount=${actualDepositAmount}`;
        }

        // ============================================================================
        // INVOICE PREVIEW FUNCTIONALITY
        // ============================================================================

        function showInvoicePreview() {
            const remainingAmount = getRemainingToInvoice();
            
            if (remainingAmount <= 0) {
                alert('This quote has already been fully invoiced. You cannot create additional invoices beyond 100% of the quote amount.');
                return;
            }
            
            // Show invoice distribution section in modal
            const distributionSection = document.getElementById('invoiceDistributionSection');
            if (distributionSection) {
                distributionSection.classList.remove('hidden');
                // Initialize modal distribution table
                renderModalPayersTable();
                updateModalDistributionSummary();
                
                // Set up event listeners for modal
                const modalAddBtn = document.getElementById('modalAddSelectedPayerBtn');
                if (modalAddBtn) {
                    modalAddBtn.onclick = () => addSelectedPayerToModal();
                }
            }
            
            const paymentModel = document.querySelector('input[name="paymentModel"]:checked')?.value || 'full';
            const quoteTotal = calculateTotal();
            const invoicesToCreate = generateInvoicePreview(paymentModel, quoteTotal);
            
            if (invoicesToCreate.length === 0) {
                alert('No invoices to create. Please configure payment settings first.');
                return;
            }
            
            // Store preview invoices for later creation
            previewInvoices = invoicesToCreate.filter(inv => !inv.isPlaceholder);
            
            renderInvoicePreview(invoicesToCreate);
            document.getElementById('invoicePreviewModal').classList.remove('hidden');
        }

        function generateInvoicePreview(paymentModel, quoteTotal) {
            const invoices = [];
            const today = new Date();
            const quoteId = document.getElementById('quoteIdBadge').textContent;
            
            // Check if multiple payers are configured in Invoice Distribution
            const hasMultiplePayers = distributionPayers && distributionPayers.length > 1;
            const totalPercentage = hasMultiplePayers ? distributionPayers.reduce((sum, p) => sum + p.percentage, 0) : 100;
            const isValidDistribution = hasMultiplePayers && Math.abs(totalPercentage - 100) < 0.01;
            
            if (paymentModel === 'full') {
                const remainingAmount = getRemainingToInvoice();
                if (remainingAmount > 0) {
                    if (hasMultiplePayers && isValidDistribution) {
                        // Split invoice among multiple payers
                        distributionPayers.forEach((payer, index) => {
                            const payerAmount = (remainingAmount * payer.percentage / 100);
                            if (payerAmount > 0.01) { // Only create invoice if amount is significant
                                invoices.push({
                                    id: `INV-${new Date().getFullYear()}-${String(Date.now() + index).slice(-3)}`,
                                    type: 'Full Invoice',
                                    description: `Invoice for ${payer.name} (${payer.percentage}%)`,
                                    amount: payerAmount,
                                    dueDate: calculateDueDate(today),
                                    items: state.quoteItems,
                                    color: 'purple',
                                    payer: payer,
                                    payerName: payer.name,
                                    payerEmail: payer.email
                                });
                            }
                        });
                    } else {
                        // Single invoice for full amount
                    invoices.push({
                        id: `INV-${new Date().getFullYear()}-${String(Date.now()).slice(-3)}`,
                        type: 'Full Invoice',
                        description: 'Invoice for complete quote amount',
                        amount: remainingAmount,
                        dueDate: calculateDueDate(today),
                        items: state.quoteItems,
                        color: 'purple'
                    });
                    }
                }
            } else if (paymentModel === 'deposit') {
                const remainingToInvoice = getRemainingToInvoice();
                const depositAmount = parseFloat(document.getElementById('depositAmount')?.value) || 0;
                
                // Check if deposit invoices already exist
                const activeInvoices = quoteInvoices.filter(inv => inv.status !== 'cancelled');
                const existingDepositInvoices = activeInvoices.filter(inv => inv.type === 'deposit');
                const totalDepositInvoiced = existingDepositInvoices.reduce((sum, inv) => sum + inv.amount, 0);
                
                // Check if deposit is fully invoiced (with small tolerance for rounding)
                const depositFullyInvoiced = totalDepositInvoiced >= depositAmount - 0.01;
                
                // FIRST TIME: Only show deposit invoices if deposit is not fully invoiced
                // LATER: Only show balance invoices if deposit is fully invoiced
                if (!depositFullyInvoiced) {
                    // Create deposit invoices only (first time)
                    const remainingDepositAmount = Math.max(0, depositAmount - totalDepositInvoiced);
                    const actualDepositAmount = Math.min(remainingDepositAmount, remainingToInvoice);
                    
                    if (actualDepositAmount > 0.01) {
                        // Deposit invoice(s) - split if multiple payers
                        if (hasMultiplePayers && isValidDistribution) {
                            distributionPayers.forEach((payer, index) => {
                                const payerDepositAmount = (actualDepositAmount * payer.percentage / 100);
                                if (payerDepositAmount > 0.01) {
                                    invoices.push({
                                        id: `INV-${new Date().getFullYear()}-${String(Date.now() + index).slice(-3)}`,
                                        type: 'Deposit Invoice',
                                        description: `Deposit invoice for ${payer.name} (${payer.percentage}%)`,
                                        amount: payerDepositAmount,
                                        dueDate: calculateDueDate(today),
                                        items: state.quoteItems.map(item => ({...item, isDeposit: true})),
                                        color: 'blue',
                                        payer: payer,
                                        payerName: payer.name,
                                        payerEmail: payer.email
                                    });
                                }
                            });
                        } else {
                            // Single deposit invoice
                    invoices.push({
                        id: `INV-${new Date().getFullYear()}-${String(Date.now()).slice(-3)}`,
                        type: 'Deposit Invoice',
                        description: 'Down payment invoice',
                        amount: actualDepositAmount,
                        dueDate: calculateDueDate(today),
                        items: state.quoteItems.map(item => ({...item, isDeposit: true})),
                        color: 'blue'
                    });
                        }
                    }
                } else {
                    // Deposit is fully invoiced, now show balance invoices (later)
                    // Check if balance invoices already exist
                    const existingBalanceInvoices = activeInvoices.filter(inv => inv.type === 'partial');
                    const totalBalanceInvoiced = existingBalanceInvoices.reduce((sum, inv) => sum + inv.amount, 0);
                    
                    // Calculate how much balance still needs to be invoiced
                    const quoteTotalForBalance = calculateTotal();
                    const totalAllInvoiced = activeInvoices.reduce((sum, inv) => sum + inv.amount, 0);
                    const remainingBalanceToInvoice = Math.max(0, quoteTotalForBalance - totalAllInvoiced);
                    
                    if (remainingBalanceToInvoice > 0.01) {
                        const balanceDueDate = new Date(today);
                        balanceDueDate.setDate(balanceDueDate.getDate() + 30); // 30 days after deposit
                        
                        if (hasMultiplePayers && isValidDistribution) {
                            // Split remaining balance among payers
                            distributionPayers.forEach((payer, index) => {
                                const payerBalanceAmount = (remainingBalanceToInvoice * payer.percentage / 100);
                                if (payerBalanceAmount > 0.01) {
                                    invoices.push({
                                        id: `INV-${new Date().getFullYear()}-${String(Date.now() + 100 + index).slice(-3)}`,
                                        type: 'Balance Invoice',
                                        description: `Remaining balance for ${payer.name} (${payer.percentage}%)`,
                                        amount: payerBalanceAmount,
                                        dueDate: calculateDueDate(balanceDueDate),
                                        items: state.quoteItems.map(item => ({...item, isBalance: true})),
                                        color: 'green',
                                        payer: payer,
                                        payerName: payer.name,
                                        payerEmail: payer.email
                                    });
                                }
                            });
                        } else {
                            // Single balance invoice
                        invoices.push({
                            id: `INV-${new Date().getFullYear()}-${String(Date.now() + 1).slice(-3)}`,
                            type: 'Balance Invoice',
                            description: 'Remaining balance after deposit',
                                amount: remainingBalanceToInvoice,
                            dueDate: calculateDueDate(balanceDueDate),
                            items: state.quoteItems.map(item => ({...item, isBalance: true})),
                            color: 'green'
                        });
                        }
                    }
                }
            } else if (paymentModel === 'subscription') {
                const remainingToInvoice = getRemainingToInvoice();
                
                if (remainingToInvoice <= 0) {
                    return invoices; // No invoices to create if already fully invoiced
                }
                
                const frequency = document.getElementById('billingFrequency')?.value || 'monthly';
                const startDate = new Date(document.getElementById('subscriptionStartDate')?.value || today);
                const endType = document.getElementById('subscriptionEnd')?.value || 'ongoing';
                
                let cycles = 12; // Default to 12 cycles for preview
                if (endType === 'after_cycles') {
                    cycles = parseInt(document.getElementById('billingCycles')?.value) || 12;
                } else if (endType === 'end_date') {
                    const endDate = new Date(document.getElementById('subscriptionEndDate')?.value);
                    cycles = calculateCyclesBetweenDates(startDate, endDate, frequency);
                }
                
                const cycleAmount = remainingToInvoice / cycles;
                
                for (let i = 0; i < Math.min(cycles, 6); i++) { // Show max 6 invoices in preview
                    const invoiceDate = new Date(startDate);
                    addTimeToDate(invoiceDate, frequency, i);
                    
                    invoices.push({
                        id: `INV-${new Date().getFullYear()}-${String(Date.now() + i).slice(-3)}`,
                        type: `Subscription Invoice #${i + 1}`,
                        description: `${frequency.charAt(0).toUpperCase() + frequency.slice(1)} recurring invoice`,
                        amount: cycleAmount,
                        dueDate: calculateDueDate(invoiceDate),
                        items: state.quoteItems.map(item => ({...item, isSubscription: true, cycle: i + 1})),
                        color: 'indigo'
                    });
                }
                
                if (cycles > 6) {
                    invoices.push({
                        id: '...',
                        type: `+ ${cycles - 6} more invoices`,
                        description: `Total of ${cycles} subscription invoices`,
                        amount: cycleAmount * (cycles - 6),
                        dueDate: '...',
                        items: [],
                        color: 'gray',
                        isPlaceholder: true
                    });
                }
            }
            
            return invoices;
        }

        // Get payment model display name (matches Payment Configuration tab)
        function getPaymentModelDisplayName(modelValue) {
            const modelMap = {
                'full': 'Full Payment (Upfront)',
                'deposit': 'Down Payment (Deposit)',
                'subscription': 'Subscription (Recurring)'
            };
            return modelMap[modelValue] || modelValue.charAt(0).toUpperCase() + modelValue.slice(1);
        }

        function formatCurrency(amount) {
            const value = Number(amount) || 0;
            return `$${value.toFixed(2)}`;
        }

        function getQuoteFinancialTotals() {
            const discounts = calculateLineItemDiscounts();
            const netSubtotal = calculateSubtotal();
            const grossSubtotal = netSubtotal + discounts;
            const tax = calculateTax();
            const total = netSubtotal + tax;
            return {
                grossSubtotal,
                discounts,
                netSubtotal,
                tax,
                total
            };
        }

        function getInvoiceBreakdown(invoiceAmount, quoteTotals) {
            const totals = quoteTotals || getQuoteFinancialTotals();
            if (!totals || totals.total === 0) {
                return {
                    grossSubtotal: 0,
                    discounts: 0,
                    netSubtotal: 0,
                    tax: 0,
                    total: invoiceAmount || 0
                };
            }
            const proportion = invoiceAmount ? (invoiceAmount / totals.total) : 0;
            const grossSubtotal = totals.grossSubtotal * proportion;
            const discounts = totals.discounts * proportion;
            const netSubtotal = totals.netSubtotal * proportion;
            const tax = totals.tax * proportion;
            const total = netSubtotal + tax;
            return {
                grossSubtotal,
                discounts,
                netSubtotal,
                tax,
                total
            };
        }

        function getPaymentTermsLabelForPreview() {
            const termsMap = {
                'due_on_receipt': 'Due on Receipt',
                'net_7': 'Net 7 Days',
                'net_15': 'Net 15 Days',
                'net_30': 'Net 30 Days',
                'net_60': 'Net 60 Days'
            };
            const terms = document.getElementById('defaultPaymentTerms')?.value || 'net_30';
            return termsMap[terms] || 'Net 30 Days';
        }

        function getInvoiceCoverageText(invoice) {
            if (invoice.payer?.percentage) {
                return `${invoice.payer.percentage}% share billed to ${invoice.payer.name}`;
            }
            if (invoice.items && invoice.items.length) {
                const firstItem = invoice.items[0];
                if (firstItem.isDeposit) {
                    return 'Deposit portion across all quote items';
                }
                if (firstItem.isBalance) {
                    return 'Remaining balance across all quote items';
                }
                if (firstItem.isSubscription) {
                    const cycle = firstItem.cycle || 1;
                    return `Subscription cycle #${cycle} covering scheduled services`;
                }
            }
            if (invoice.type?.toLowerCase().includes('full')) {
                return 'Full quote items';
            }
            return 'Quote items as listed in the overview';
        }

        function getCoverageStatusMessage(totalPreviewed, quoteTotal) {
            if (!quoteTotal || quoteTotal <= 0) {
                return '';
            }
            const diff = quoteTotal - totalPreviewed;
            const coveragePercent = Math.min(Math.max((totalPreviewed / quoteTotal) * 100, 0), 999);
            if (Math.abs(diff) < 0.01) {
                return `<span class="text-green-700 font-medium">Preview covers 100% of the quote total.</span>`;
            }
            if (diff > 0) {
                return `<span class="text-yellow-700 font-medium">Preview covers ${coveragePercent.toFixed(0)}% of the quote total. Remaining ${formatCurrency(diff)} still needs invoices.</span>`;
            }
            return `<span class="text-red-700 font-medium">Preview exceeds the quote total by ${formatCurrency(Math.abs(diff))}. Adjust invoice amounts before generating.</span>`;
        }

        function getSelectionCoverageText(selectedTotal, quoteTotal) {
            if (!quoteTotal || quoteTotal <= 0) {
                return '';
            }
            const diff = quoteTotal - selectedTotal;
            const coveragePercent = Math.min(Math.max((selectedTotal / quoteTotal) * 100, 0), 999);
            if (Math.abs(diff) < 0.01) {
                return 'Selected invoices cover 100% of the quote.';
            }
            if (diff > 0) {
                return `Selected invoices cover ${coveragePercent.toFixed(0)}% of the quote. ${formatCurrency(diff)} remaining.`;
            }
            return `Selection exceeds the quote total by ${formatCurrency(Math.abs(diff))}.`;
        }

        function renderInvoicePreview(invoices) {
            const content = document.getElementById('invoicePreviewContent');
            const totalAmount = invoices.reduce((sum, inv) => sum + (inv.isPlaceholder ? 0 : inv.amount), 0);
            
            const validInvoices = invoices.filter(inv => !inv.isPlaceholder);
            const paymentModel = document.querySelector('input[name="paymentModel"]:checked')?.value || 'full';
            const paymentModelDisplay = getPaymentModelDisplayName(paymentModel);
            const hasMultiplePayers = distributionPayers && distributionPayers.length > 1;
            const quoteTotals = getQuoteFinancialTotals();
            window.previewQuoteTotal = quoteTotals.total;
            const quoteItems = state.quoteItems || [];
            const quoteItemsSummary = quoteItems.length
                ? quoteItems.map(item => {
                    const quantity = item.quantity ? `<span class="text-[10px] text-gray-500 ml-1">x${item.quantity}</span>` : '';
                    return `<span class="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-white text-gray-700 text-xs border border-gray-200 shadow-sm">${item.name || 'Item'}${quantity}</span>`;
                }).join('')
                : '<span class="text-xs text-gray-500">No items selected</span>';
            const quoteTotalsGrid = `
                <div class="grid grid-cols-2 md:grid-cols-3 gap-4 text-xs text-gray-600">
                    <div>
                        <p class="font-semibold text-gray-700">Original</p>
                        <p class="text-gray-900 text-sm">${formatCurrency(quoteTotals.grossSubtotal)}</p>
                    </div>
                    <div>
                        <p class="font-semibold text-gray-700">Discount</p>
                        <p class="text-green-600 text-sm">- ${formatCurrency(quoteTotals.discounts)}</p>
                    </div>
                    <div>
                        <p class="font-semibold text-gray-700">Net</p>
                        <p class="text-gray-900 text-sm">${formatCurrency(quoteTotals.netSubtotal)}</p>
                    </div>
                    <div>
                        <p class="font-semibold text-gray-700">Tax</p>
                        <p class="text-gray-900 text-sm">${formatCurrency(quoteTotals.tax)}</p>
                    </div>
                    <div>
                        <p class="font-semibold text-gray-700">Grand Total</p>
                        <p class="text-gray-900 text-sm">${formatCurrency(quoteTotals.total)}</p>
                    </div>
                </div>
            `;
            const coverageMessage = getCoverageStatusMessage(totalAmount, quoteTotals.total);
            const customerNotes = document.getElementById('customerNotes')?.value?.trim();
            const paymentInstructions = document.getElementById('paymentInstructions')?.value?.trim();
            const showNotesSection = customerNotes || paymentInstructions;
            
            // Add selection state to each invoice
            invoices.forEach((inv, index) => {
                if (!inv.isPlaceholder) {
                    inv.selected = true; // Default to selected
                    inv.index = index;
                }
            });

            content.innerHTML = `
                <div class="bg-gradient-to-br from-blue-50 via-indigo-50 to-blue-50 border-2 border-blue-300 rounded-xl p-6 mb-6 shadow-md">
                    <div class="flex items-start justify-between mb-4">
                        <div class="flex-1">
                            <div class="flex items-center gap-3 mb-3">
                                <div class="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center">
                                    <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5.586a1 1 0 0 1 .707.293l5.414 5.414a1 1 0 0 1 .293.707V19a2 2 0 0 1-2 2z"></path>
                                    </svg>
                                </div>
                                <div class="flex-1">
                                    <h4 class="text-xl font-bold text-gray-900 mb-1">Invoice Summary</h4>
                                    <p class="text-sm text-gray-600">Select which invoices to create. Unselected invoices can be created later.</p>
                                </div>
                                <label class="flex items-center gap-2 px-4 py-2 bg-white border border-blue-300 rounded-lg cursor-pointer hover:bg-blue-50 transition-colors">
                                    <input type="checkbox" id="selectAllInvoicesPreview" checked class="rounded border-blue-300 text-blue-600 focus:ring-blue-500" onchange="toggleSelectAllInvoices()" />
                                    <span class="text-sm font-medium text-blue-700">Select All</span>
                                </label>
                            </div>
                        </div>
                        <div class="text-right ml-6 pl-6 border-l-2 border-blue-200">
                            <div class="text-4xl font-bold text-blue-900 mb-1" id="selectedInvoicesTotal">$${totalAmount.toFixed(2)}</div>
                            <div class="text-sm text-gray-600 font-medium">
                                <span id="selectedInvoicesCount" class="text-blue-700 font-semibold">${validInvoices.length}</span> of <span class="text-gray-700">${validInvoices.length}</span> invoice(s) selected
                            </div>
                            <div class="text-xs text-gray-500 mt-1" id="selectedInvoicesCoverageText"></div>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4 pt-4 mt-4 border-t border-blue-200">
                        <div class="flex items-center gap-2">
                            <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path>
                            </svg>
                            <span class="text-xs text-gray-600 font-medium">Payment Model:</span>
                            <span class="text-sm text-gray-900 font-semibold">${paymentModelDisplay}</span>
                        </div>
                        ${hasMultiplePayers ? `
                            <div class="flex items-center gap-2">
                                <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                                </svg>
                                <span class="text-xs text-gray-600 font-medium">Payers:</span>
                                <span class="text-sm text-gray-900 font-semibold">${distributionPayers.length} configured</span>
                            </div>
                        ` : ''}
                    </div>
                    ${coverageMessage ? `
                        <div class="mt-4 py-3 px-4 rounded-lg bg-white/80 border border-blue-200 text-sm" id="invoiceCoverageStatus">
                            ${coverageMessage}
                        </div>
                    ` : ''}
                    <div class="mt-4 pt-4 border-t border-blue-200">
                        <h5 class="text-xs font-semibold text-blue-700 uppercase tracking-wide mb-2">Quote Totals & Items</h5>
                        ${quoteTotalsGrid}
                        <div class="mt-3">
                            <p class="text-[10px] uppercase tracking-wide text-gray-500 font-semibold mb-2">Items</p>
                            <div class="flex flex-wrap gap-2">
                                ${quoteItemsSummary}
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    ${invoices.map((invoice, index) => `
                        <div class="bg-white border-2 border-${invoice.color}-200 rounded-xl p-6 shadow-md hover:shadow-lg transition-all duration-200 ${invoice.isPlaceholder ? 'opacity-60' : ''} ${invoice.selected ? 'ring-2 ring-blue-400 ring-offset-2' : 'hover:border-${invoice.color}-300'}">
                            ${!invoice.isPlaceholder ? `
                                <div class="flex items-start gap-3 mb-4">
                                    <input 
                                        type="checkbox" 
                                        class="mt-1 rounded border-gray-300 text-blue-600 focus:ring-blue-500 invoice-checkbox" 
                                        data-invoice-index="${index}"
                                        ${invoice.selected ? 'checked' : ''}
                                        onchange="toggleInvoiceSelection(${index})"
                                    />
                                    <div class="flex-1">
                            <div class="flex items-center justify-between mb-4 pb-4 border-b border-gray-200">
                                <div class="flex items-center gap-3">
                                    <div class="w-12 h-12 bg-gradient-to-br from-${invoice.color}-100 to-${invoice.color}-200 rounded-xl flex items-center justify-center shadow-sm">
                                        <svg class="w-6 h-6 text-${invoice.color}-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5.586a1 1 0 0 1 .707.293l5.414 5.414a1 1 0 0 1 .293.707V19a2 2 0 0 1-2 2z"></path>
                                        </svg>
                                    </div>
                        <div>
                                        <h5 class="text-lg font-bold text-gray-900">${invoice.id}</h5>
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-semibold bg-${invoice.color}-100 text-${invoice.color}-700 mt-1">${invoice.type}</span>
                                    </div>
                        </div>
                        <div class="text-right">
                                    <div class="text-2xl font-bold text-gray-900 mb-1">$${invoice.amount.toFixed(2)}</div>
                                    <div class="flex items-center gap-1 text-xs text-gray-500">
                                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                        </svg>
                                        <span>Due: ${formatDueDateForDisplay(invoice.dueDate)}</span>
                        </div>
                    </div>
                </div>
                
                            <p class="text-sm text-gray-700 mb-4 leading-relaxed">${invoice.description}</p>
                            
                                        <div class="bg-gray-50 border border-gray-200 rounded-lg p-3 mb-4 text-xs text-gray-600">
                                            <div class="flex items-center gap-2 mb-1">
                                                <svg class="w-3.5 h-3.5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                                </svg>
                                                <span class="font-semibold text-gray-700">Invoice Context</span>
                                            </div>
                                            <p class="text-gray-700"><span class="font-semibold">Covers:</span> ${getInvoiceCoverageText(invoice)}</p>
                                            <p class="text-gray-700"><span class="font-semibold">Payment Terms:</span> ${getPaymentTermsLabelForPreview()}</p>
                                        </div>
                                        
                                        ${invoice.payerName ? `
                                            <div class="bg-gradient-to-r from-gray-50 to-gray-100 border border-gray-300 rounded-lg p-4 mb-4 shadow-sm">
                                                <div class="flex items-center gap-2 mb-2">
                                                    <svg class="w-4 h-4 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                                    </svg>
                                                    <span class="text-xs font-semibold text-gray-700 uppercase tracking-wide">Payer</span>
                                                </div>
                                                <div class="text-sm font-semibold text-gray-900 mb-1">${invoice.payerName}</div>
                                                ${invoice.payerEmail ? `<div class="text-xs text-gray-600 flex items-center gap-1">
                                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                                                    </svg>
                                                    ${invoice.payerEmail}
                                                </div>` : ''}
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>
                            ` : `
                            <div class="flex items-center justify-between mb-4">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 bg-${invoice.color}-100 rounded-full flex items-center justify-center">
                                        <svg class="w-5 h-5 text-${invoice.color}-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5.586a1 1 0 0 1 .707.293l5.414 5.414a1 1 0 0 1 .293.707V19a2 2 0 0 1-2 2z"></path>
                                        </svg>
                                    </div>
                                    <div>
                                        <h5 class="font-semibold text-gray-900">${invoice.id}</h5>
                                        <p class="text-sm text-${invoice.color}-600 font-medium">${invoice.type}</p>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div class="text-xl font-bold text-gray-900">$${invoice.amount.toFixed(2)}</div>
                                </div>
                            </div>
                            <p class="text-sm text-gray-600 mb-4">${invoice.description}</p>
                            `}
                        </div>
                    `).join('')}
                </div>
            `;
            
            // Store invoices in previewInvoices for selection tracking
            previewInvoices = invoices.filter(inv => !inv.isPlaceholder);
            
            // Update summary after rendering
            setTimeout(() => {
                updateSelectedInvoicesSummary();
            }, 100);
        }
        
        // Toggle individual invoice selection (make globally accessible)
        window.toggleInvoiceSelection = function(index) {
            const checkbox = document.querySelector(`input[data-invoice-index="${index}"].invoice-checkbox`);
            if (!checkbox) return;
            
            // Find the invoice in previewInvoices array
            const invoice = previewInvoices.find(inv => inv.index === index);
            if (invoice) {
                invoice.selected = checkbox.checked;
                updateSelectedInvoicesSummary();
            }
        };
        
        // Toggle select all invoices (make globally accessible)
        window.toggleSelectAllInvoices = function() {
            const selectAllCheckbox = document.getElementById('selectAllInvoicesPreview');
            if (!selectAllCheckbox) return;
            
            const isChecked = selectAllCheckbox.checked;
            const checkboxes = document.querySelectorAll('.invoice-checkbox');
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = isChecked;
                const index = parseInt(checkbox.getAttribute('data-invoice-index'));
                const invoice = previewInvoices.find(inv => inv.index === index);
                if (invoice) {
                    invoice.selected = isChecked;
                }
            });
            
            updateSelectedInvoicesSummary();
        };
        
        // Update selected invoices summary
        function updateSelectedInvoicesSummary() {
            const selectedInvoices = previewInvoices.filter(inv => inv.selected);
            const selectedTotal = selectedInvoices.reduce((sum, inv) => sum + inv.amount, 0);
            const totalCount = previewInvoices.length;
            const selectedCount = selectedInvoices.length;
            
            // Update summary display
            const selectedTotalEl = document.getElementById('selectedInvoicesTotal');
            const selectedCountEl = document.getElementById('selectedInvoicesCount');
            
            if (selectedTotalEl) {
                selectedTotalEl.textContent = `$${selectedTotal.toFixed(2)}`;
            }
            if (selectedCountEl) {
                selectedCountEl.textContent = selectedCount;
            }
            const coverageEl = document.getElementById('selectedInvoicesCoverageText');
            if (coverageEl) {
                coverageEl.textContent = getSelectionCoverageText(selectedTotal, window.previewQuoteTotal);
            }
            
            // Update button text
            const createBtn = document.getElementById('createAllInvoicesBtn');
            if (createBtn) {
                if (selectedCount === 0) {
                    createBtn.disabled = true;
                    createBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    createBtn.textContent = 'Select Invoices to Create';
                } else if (selectedCount === totalCount) {
                    createBtn.disabled = false;
                    createBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    createBtn.innerHTML = `
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                        Confirm & Generate
                    `;
                } else {
                    createBtn.disabled = false;
                    createBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    createBtn.innerHTML = `
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                        Confirm & Create Selected (${selectedCount})
                    `;
                }
            }
            
            // Update select all checkbox state
            const selectAllCheckbox = document.getElementById('selectAllInvoicesPreview');
            if (selectAllCheckbox) {
                selectAllCheckbox.checked = selectedCount === totalCount;
                selectAllCheckbox.indeterminate = selectedCount > 0 && selectedCount < totalCount;
            }
        }

        function calculateDueDate(fromDate) {
            const terms = document.getElementById('defaultPaymentTerms')?.value || 'net_30';
            const dueDate = new Date(fromDate);
            
            switch(terms) {
                case 'due_on_receipt':
                    // Return Date object for internal use, string for display
                    return dueDate;
                case 'net_7':
                    dueDate.setDate(dueDate.getDate() + 7);
                    break;
                case 'net_15':
                    dueDate.setDate(dueDate.getDate() + 15);
                    break;
                case 'net_30':
                    dueDate.setDate(dueDate.getDate() + 30);
                    break;
                case 'net_60':
                    dueDate.setDate(dueDate.getDate() + 60);
                    break;
            }
            
            // Return Date object instead of string
            return dueDate;
        }
        
        // Helper function to format date for display
        function formatDueDateForDisplay(date) {
            if (!date) return '';
            if (date instanceof Date) {
                return date.toLocaleDateString();
            }
            return date;
        }

        function calculateCyclesBetweenDates(startDate, endDate, frequency) {
            const diffTime = Math.abs(endDate - startDate);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            switch(frequency) {
                case 'weekly': return Math.floor(diffDays / 7);
                case 'biweekly': return Math.floor(diffDays / 14);
                case 'monthly': return Math.floor(diffDays / 30);
                case 'quarterly': return Math.floor(diffDays / 90);
                case 'yearly': return Math.floor(diffDays / 365);
                default: return 12;
            }
        }

        function addTimeToDate(date, frequency, multiplier) {
            switch(frequency) {
                case 'weekly':
                    date.setDate(date.getDate() + (7 * multiplier));
                    break;
                case 'biweekly':
                    date.setDate(date.getDate() + (14 * multiplier));
                    break;
                case 'monthly':
                    date.setMonth(date.getMonth() + multiplier);
                    break;
                case 'quarterly':
                    date.setMonth(date.getMonth() + (3 * multiplier));
                    break;
                case 'yearly':
                    date.setFullYear(date.getFullYear() + multiplier);
                    break;
            }
        }

        function hideInvoicePreview() {
            document.getElementById('invoicePreviewModal').classList.add('hidden');
        }

        function createAllInvoicesFromPreview() {
            // Get only selected invoices
            const selectedInvoices = previewInvoices.filter(inv => inv.selected);
            
            if (selectedInvoices.length === 0) {
                alert('Please select at least one invoice to create.');
                return;
            }
            
            // Build confirmation message with selected invoice details
            const totalAmount = selectedInvoices.reduce((sum, inv) => sum + inv.amount, 0);
            const invoiceCount = selectedInvoices.length;
            const paymentModel = document.querySelector('input[name="paymentModel"]:checked')?.value || 'full';
            
            let confirmationMessage = `You are about to create ${invoiceCount} selected invoice(s) totaling $${totalAmount.toFixed(2)}.\n\n`;
            confirmationMessage += `Payment Model: ${paymentModel.charAt(0).toUpperCase() + paymentModel.slice(1)}\n\n`;
            confirmationMessage += `Selected Invoice Details:\n`;
            
            selectedInvoices.forEach((inv, index) => {
                const payerInfo = inv.payerName ? ` (${inv.payerName})` : '';
                confirmationMessage += `${index + 1}. ${inv.type}${payerInfo}: $${inv.amount.toFixed(2)}\n`;
            });
            
            if (selectedInvoices.length < previewInvoices.length) {
                const unselectedCount = previewInvoices.length - selectedInvoices.length;
                confirmationMessage += `\n Note: ${unselectedCount} invoice(s) were not selected and will not be created. You can create them later by clicking "Generate Invoices" again.`;
            }
            
            confirmationMessage += `\n\nDo you want to proceed with creating the selected invoices?`;
            
            if (!confirm(confirmationMessage)) {
                return;
            }
            
            // Generate invoice IDs and create invoices
            const today = new Date();
            const invoiceIdPrefix = `INV-${today.getFullYear()}-`;
            let invoiceCounter = 1;
            
            // Get the highest existing invoice number to continue sequence
            const existingInvoiceNumbers = quoteInvoices
                .map(inv => {
                    const match = inv.id.match(/INV-\d{4}-(\d+)/);
                    return match ? parseInt(match[1]) : 0;
                })
                .filter(num => num > 0);
            const maxInvoiceNumber = existingInvoiceNumbers.length > 0 ? Math.max(...existingInvoiceNumbers) : 0;
            invoiceCounter = maxInvoiceNumber + 1;
            
            // Create only selected invoices from preview with diverse statuses for testing
            const newInvoices = selectedInvoices.map((previewInv, index) => {
                const invoiceId = `${invoiceIdPrefix}${String(invoiceCounter++).padStart(3, '0')}`;
                
                // Parse dueDate - handle both Date objects and date strings
                let dueDate;
                if (previewInv.dueDate instanceof Date) {
                    // Already a Date object
                    dueDate = new Date(previewInv.dueDate);
                } else {
                    // Try to parse the date string or use today as fallback
                    dueDate = new Date(previewInv.dueDate);
                    // If parsing failed, use today's date as fallback
                    if (isNaN(dueDate.getTime())) {
                        console.warn(`Invalid dueDate for invoice ${invoiceId}, using today's date as fallback`);
                        dueDate = new Date();
                        // Apply payment terms to the fallback date
                        const terms = document.getElementById('defaultPaymentTerms')?.value || 'net_30';
                        switch(terms) {
                            case 'net_7':
                                dueDate.setDate(dueDate.getDate() + 7);
                                break;
                            case 'net_15':
                                dueDate.setDate(dueDate.getDate() + 15);
                                break;
                            case 'net_30':
                                dueDate.setDate(dueDate.getDate() + 30);
                                break;
                            case 'net_60':
                                dueDate.setDate(dueDate.getDate() + 60);
                                break;
                        }
                    }
                }
                
                // Use a combination of index and amount to create varied patterns
                const randomFactor = (index * 7 + Math.floor(previewInv.amount)) % 10;
                
                // Determine invoice type
                let invoiceType = 'full';
                if (previewInv.type.includes('Deposit')) {
                    invoiceType = 'deposit';
                } else if (previewInv.type.includes('Balance')) {
                    invoiceType = 'partial';
                } else if (previewInv.type.includes('Subscription')) {
                    invoiceType = 'subscription';
                }
                
                // Assign diverse statuses for testing (create realistic mix)
                // Distribution: ~25% paid, ~75% unpaid (with some partially paid)
                let assignedStatus = 'unpaid';
                let paidAmount = 0;
                
                if (randomFactor < 2) {
                    // 20% fully paid
                    assignedStatus = 'paid';
                    paidAmount = previewInv.amount;
                } else if (randomFactor === 2 || randomFactor === 3) {
                    // 20% partially paid (30-70% of amount)
                    assignedStatus = 'unpaid';
                    paidAmount = previewInv.amount * (0.3 + Math.random() * 0.4);
                    paidAmount = Math.round(paidAmount * 100) / 100; // Round to 2 decimals
                } else {
                    // 60% fully unpaid
                    assignedStatus = 'unpaid';
                    paidAmount = 0;
                }
                
                // Make some unpaid invoices overdue for testing (about 15% of unpaid invoices)
                if (assignedStatus === 'unpaid' && randomFactor === 4 && index % 3 === 0) {
                    // Make some unpaid invoices overdue (past due date)
                    const daysOverdue = 5 + Math.floor(Math.random() * 20); // 5-25 days overdue
                    dueDate.setDate(dueDate.getDate() - daysOverdue);
                }
                
                const newInvoice = {
                    id: invoiceId,
                    type: invoiceType,
                    amount: previewInv.amount,
                    status: assignedStatus,
                    paidAmount: paidAmount,
                    dueDate: dueDate.toISOString().split('T')[0],
                    createdDate: today.toISOString().split('T')[0],
                    // Store payer information if available
                    payer: previewInv.payer ? {
                        name: previewInv.payerName,
                        email: previewInv.payerEmail,
                        percentage: previewInv.payer?.percentage
                    } : null,
                    // Store payment method from configuration
                    paymentMethod: document.querySelector('input[name="paymentMethod"]:checked')?.value || null,
                    // Store payment terms
                    paymentTerms: document.getElementById('defaultPaymentTerms')?.value || 'net_30',
                    // Store items reference
                    items: previewInv.items || []
                };
                
                return newInvoice;
            });
            
            // Add new invoices to quoteInvoices array
            quoteInvoices.push(...newInvoices);
            
            // Remove created invoices from preview (keep unselected ones for next time)
            previewInvoices = previewInvoices.filter(inv => !inv.selected);
            
            // Show success message
            let successMessage = ` Successfully created ${newInvoices.length} invoice(s)!\n\nTotal Amount: $${totalAmount.toFixed(2)}\n\n`;
            if (previewInvoices.length > 0) {
                successMessage += `Note: ${previewInvoices.length} invoice(s) were not selected and can be created later by clicking "Generate Invoices" again.`;
            } else {
                successMessage += `You can now view and manage these invoices in the Invoices tab.`;
            }
            alert(successMessage);
            
            // If all invoices were created, close the modal. Otherwise, keep it open with updated selection.
            if (previewInvoices.length === 0) {
                hideInvoicePreview();
            } else {
                // Re-render preview with remaining invoices (all selected by default)
                const paymentModel = document.querySelector('input[name="paymentModel"]:checked')?.value || 'full';
                const quoteTotal = calculateTotal();
                const remainingInvoices = generateInvoicePreview(paymentModel, quoteTotal);
                renderInvoicePreview(remainingInvoices);
            }
            
            // Switch to Invoices tab to show the newly created invoices
            switchTab('invoices');
            
            // Refresh the invoices list and summary
                refreshInvoices();
            updateInvoiceSummary();
        }

        // ============================================================================
        // SPLIT INVOICE FUNCTIONALITY
        // ============================================================================

        let splitInvoiceEnabled = true; // Always enabled now
        let splitMethod = 'percentage'; // 'percentage' or 'amount'
        let payers = [];
        let payerIdCounter = 1;

        function initializeSplitInvoice() {
            // Check if split invoice elements exist
            const splitByPercentage = document.getElementById('splitByPercentage');
            const splitByAmount = document.getElementById('splitByAmount');
            const addPayerBtn = document.getElementById('addPayerBtn');
            
            if (!splitByPercentage || !splitByAmount || !addPayerBtn) {
                // Split invoice elements don't exist, skip initialization
                return;
            }
            
            // Add default 2 payers on initialization
            if (payers.length === 0) {
                addPayer();
                addPayer();
            }

            // Split Method Buttons
            splitByPercentage.addEventListener('click', function() {
                splitMethod = 'percentage';
                this.classList.add('bg-purple-600', 'text-white');
                this.classList.remove('bg-white', 'border', 'border-gray-300', 'text-gray-700');
                
                const amountBtn = document.getElementById('splitByAmount');
                if (amountBtn) {
                    amountBtn.classList.remove('bg-purple-600', 'text-white');
                    amountBtn.classList.add('bg-white', 'border', 'border-gray-300', 'text-gray-700');
                }
                
                renderPayers();
            });

            splitByAmount.addEventListener('click', function() {
                splitMethod = 'amount';
                this.classList.add('bg-purple-600', 'text-white');
                this.classList.remove('bg-white', 'border', 'border-gray-300', 'text-gray-700');
                
                const percentBtn = document.getElementById('splitByPercentage');
                if (percentBtn) {
                    percentBtn.classList.remove('bg-purple-600', 'text-white');
                    percentBtn.classList.add('bg-white', 'border', 'border-gray-300', 'text-gray-700');
                }
                
                renderPayers();
            });

            // Add Payer Button
            addPayerBtn.addEventListener('click', addPayer);
        }

        function addPayer() {
            const payer = {
                id: payerIdCounter++,
                name: '',
                email: '',
                phone: '',
                value: splitMethod === 'percentage' ? 50 : 0
            };
            payers.push(payer);
            renderPayers();
            updateSplitSummary();
        }

        function removePayer(payerId) {
            payers = payers.filter(p => p.id !== payerId);
            renderPayers();
            updateSplitSummary();
        }

        function renderPayers() {
            const container = document.getElementById('payersList');
            container.innerHTML = '';

            payers.forEach((payer, index) => {
                const payerCard = createPayerCard(payer, index);
                container.appendChild(payerCard);
            });
        }

        function createPayerCard(payer, index) {
            const div = document.createElement('div');
            div.className = 'border border-gray-300 rounded-lg p-3 bg-gray-50';
            
            const inputLabel = splitMethod === 'percentage' ? '%' : '$';
            const inputPlaceholder = splitMethod === 'percentage' ? '50' : '0.00';
            
            // Generate contact options from existing customer data
            let contactOptions = '<option value="">-- Select Existing Contact or Add New --</option>';
            if (state.selectedCustomer && state.selectedCustomer.secondaryContacts) {
                // Add primary contact
                contactOptions += `<option value="primary">${state.selectedCustomer.name} (Primary)</option>`;
                
                // Add secondary contacts
                state.selectedCustomer.secondaryContacts.forEach((contact, idx) => {
                    contactOptions += `<option value="secondary-${idx}">${contact.name} - ${contact.role}</option>`;
                });
            }
            contactOptions += '<option value="new">+ Add New Contact</option>';
            
            div.innerHTML = `
                <div class="flex items-center justify-between mb-3">
                    <span class="text-sm font-medium text-gray-700">Payer ${index + 1}</span>
                    ${payers.length > 1 ? `
                        <button 
                            onclick="removePayer(${payer.id})"
                            class="text-red-600 hover:text-red-700 text-sm"
                        >
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                            </svg>
                        </button>
                    ` : ''}
                </div>
                <div class="space-y-2">
                    <!-- Contact Selector -->
                    <div>
                        <label class="block text-xs text-gray-600 mb-1">Select Contact</label>
                        <select 
                            id="contactSelect-${payer.id}"
                            onchange="selectContact(${payer.id}, this.value)"
                            class="w-full px-2 py-1.5 border border-gray-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-purple-500 bg-white"
                        >
                            ${contactOptions}
                        </select>
                    </div>
                    
                    <!-- Manual Input Fields -->
                    <div id="manualFields-${payer.id}">
                        <input 
                            type="text" 
                            placeholder="Name"
                            value="${payer.name}"
                            onchange="updatePayerField(${payer.id}, 'name', this.value)"
                            class="w-full px-2 py-1.5 border border-gray-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-purple-500"
                        />
                        <input 
                            type="email" 
                            placeholder="Email"
                            value="${payer.email}"
                            onchange="updatePayerField(${payer.id}, 'email', this.value)"
                            class="w-full px-2 py-1.5 border border-gray-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-purple-500 mt-2"
                        />
                        <input 
                            type="tel" 
                            placeholder="Phone (optional)"
                            value="${payer.phone}"
                            onchange="updatePayerField(${payer.id}, 'phone', this.value)"
                            class="w-full px-2 py-1.5 border border-gray-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-purple-500 mt-2"
                        />
                    </div>
                    
                    <!-- Amount/Percentage -->
                    <div class="flex items-center gap-2 pt-2 border-t border-gray-200">
                        <label class="text-xs text-gray-600">Amount:</label>
                        <input 
                            type="number" 
                            placeholder="${inputPlaceholder}"
                            value="${payer.value}"
                            onchange="updatePayerField(${payer.id}, 'value', parseFloat(this.value) || 0)"
                            min="0"
                            step="${splitMethod === 'percentage' ? '1' : '0.01'}"
                            ${splitMethod === 'percentage' ? 'max="100"' : ''}
                            class="flex-1 px-2 py-1.5 border border-gray-300 rounded text-sm text-right focus:outline-none focus:ring-2 focus:ring-purple-500"
                        />
                        <span class="text-sm font-medium text-gray-600 w-6">${inputLabel}</span>
                    </div>
                </div>
            `;
            
            return div;
        }

        function selectContact(payerId, contactId) {
            if (contactId === 'new') {
                // Clear fields for new contact
                updatePayerField(payerId, 'name', '');
                updatePayerField(payerId, 'email', '');
                updatePayerField(payerId, 'phone', '');
                return;
            }
            
            if (contactId === '') {
                // No selection
                return;
            }
            
            let contact = null;
            
            if (contactId === 'primary') {
                contact = {
                    name: state.selectedCustomer.name,
                    email: state.selectedCustomer.email,
                    phone: state.selectedCustomer.phone
                };
            } else if (contactId.startsWith('secondary-')) {
                const index = parseInt(contactId.split('-')[1]);
                contact = state.selectedCustomer.secondaryContacts[index];
            }
            
            if (contact) {
                // Populate fields with contact data
                updatePayerField(payerId, 'name', contact.name);
                updatePayerField(payerId, 'email', contact.email);
                updatePayerField(payerId, 'phone', contact.phone || '');
                
                // Update the input fields visually
                const manualFields = document.getElementById(`manualFields-${payerId}`);
                if (manualFields) {
                    manualFields.querySelector('input[type="text"]').value = contact.name;
                    manualFields.querySelector('input[type="email"]').value = contact.email;
                    manualFields.querySelector('input[type="tel"]').value = contact.phone || '';
                }
            }
        }

        function updatePayerField(payerId, field, value) {
            const payer = payers.find(p => p.id === payerId);
            if (payer) {
                payer[field] = value;
                updateSplitSummary();
            }
        }

        function updateSplitSummary() {
            // Get total quote amount
            const totalAmount = calculateTotal();

            // Calculate allocated amount
            let allocatedAmount = 0;
            if (splitMethod === 'percentage') {
                const totalPercentage = payers.reduce((sum, p) => sum + (parseFloat(p.value) || 0), 0);
                allocatedAmount = (totalPercentage / 100) * totalAmount;
            } else {
                allocatedAmount = payers.reduce((sum, p) => sum + (parseFloat(p.value) || 0), 0);
            }

            const remainingAmount = totalAmount - allocatedAmount;

            // Update UI
            document.getElementById('splitTotalAmount').textContent = `$${totalAmount.toFixed(2)}`;
            document.getElementById('splitAllocatedAmount').textContent = `$${allocatedAmount.toFixed(2)}`;
            document.getElementById('splitRemainingAmount').textContent = `$${remainingAmount.toFixed(2)}`;

            // Show/hide validation warning
            const warningDiv = document.getElementById('splitValidationWarning');
            const warningMessage = document.getElementById('splitValidationMessage');
            
            if (Math.abs(remainingAmount) > 0.01) {
                warningDiv.classList.remove('hidden');
                if (remainingAmount > 0) {
                    warningMessage.textContent = ` Total must equal $${totalAmount.toFixed(2)}. Please allocate the remaining $${remainingAmount.toFixed(2)}.`;
                } else {
                    warningMessage.textContent = ` Total must equal $${totalAmount.toFixed(2)}. You've exceeded by $${Math.abs(remainingAmount).toFixed(2)}.`;
                }
            } else {
                warningDiv.classList.add('hidden');
            }

            // Update remaining amount color
            const remainingSpan = document.getElementById('splitRemainingAmount');
            if (Math.abs(remainingAmount) < 0.01) {
                remainingSpan.classList.remove('text-red-600');
                remainingSpan.classList.add('text-green-600');
            } else {
                remainingSpan.classList.remove('text-green-600');
                remainingSpan.classList.add('text-red-600');
            }
        }

        function isSplitAmountValid() {
            if (!splitInvoiceEnabled || payers.length === 0) {
                return true;
            }

            const totalAmount = calculateTotal();
            let allocatedAmount = 0;
            
            if (splitMethod === 'percentage') {
                const totalPercentage = payers.reduce((sum, p) => sum + (parseFloat(p.value) || 0), 0);
                allocatedAmount = (totalPercentage / 100) * totalAmount;
            } else {
                allocatedAmount = payers.reduce((sum, p) => sum + (parseFloat(p.value) || 0), 0);
            }

            // Check if amounts match (with small tolerance for rounding)
            return Math.abs(totalAmount - allocatedAmount) < 0.01;
        }

        // ============================================================================
        // INVOICE DISTRIBUTION FUNCTIONALITY
        // ============================================================================

        // Store payers data
        let distributionPayers = [
            {
                id: 'primary',
                name: 'Primary Contact',
                email: 'contact@company.com',
                percentage: 100,
                amount: 0, // Will be calculated based on total
                isPrimary: true
            }
        ];

        // Available contacts for selection
        const availableContacts = {
            'contact1': { name: 'John Smith', email: 'john@company.com' },
            'contact2': { name: 'Sarah Johnson', email: 'sarah@business.com' },
            'contact3': { name: 'Mike Wilson', email: 'mike@corp.com' }
        };

        // Add selected payer to the table
        function addSelectedPayer() {
            const selector = document.getElementById('contactSelector');
            const selectedValue = selector.value;
            
            if (!selectedValue) {
                alert('Please select a contact to add');
                return;
            }

            // Handle quick add option
            if (selectedValue === 'quick-add') {
                openQuickAddModal();
                return;
            }

            const contact = availableContacts[selectedValue];
            if (!contact) {
                alert('Invalid contact selected');
                return;
            }

            // Check if contact already exists
            const exists = distributionPayers.find(p => p.email === contact.email);
            if (exists) {
                alert('This contact is already added');
                return;
            }

            // Add new payer
            const newPayer = {
                id: selectedValue,
                name: contact.name,
                email: contact.email,
                percentage: 0,
                amount: 0,
                isPrimary: false
            };

            distributionPayers.push(newPayer);
            
            // Reset primary contact to share the percentage
            const totalAmount = calculateTotal();
            if (distributionPayers.length === 2) {
                distributionPayers[0].percentage = 50;
                distributionPayers[0].amount = totalAmount * 0.5;
                newPayer.percentage = 50;
                newPayer.amount = totalAmount * 0.5;
            } else {
                // Distribute evenly among all payers
                const evenPercentage = Math.floor(100 / distributionPayers.length);
                distributionPayers.forEach((payer, index) => {
                    payer.percentage = evenPercentage;
                    payer.amount = totalAmount * (evenPercentage / 100);
                });
                // Give remainder to primary
                const remainder = 100 - (evenPercentage * distributionPayers.length);
                distributionPayers[0].percentage += remainder;
                distributionPayers[0].amount = totalAmount * (distributionPayers[0].percentage / 100);
            }

            // Clear selector and refresh table
            selector.value = '';
            renderPayersTable();
            updateDistributionSummary();
        }

        // Remove payer from table
        function removePayer(payerId, isModal = false) {
            if (payerId === 'primary') {
                alert('Cannot remove primary contact');
                return;
            }

            distributionPayers = distributionPayers.filter(p => p.id !== payerId);
            
            // Redistribute percentages
            if (distributionPayers.length === 1) {
                distributionPayers[0].percentage = 100;
            }
            
            if (isModal) {
                renderModalPayersTable();
                updateModalDistributionSummary();
            } else {
            renderPayersTable();
            updateDistributionSummary();
            }
        }

        // Update payer percentage (and sync amount)
        function updatePayerPercentage(payerId, newPercentage, isModal = false) {
            const payer = distributionPayers.find(p => p.id === payerId);
            if (payer) {
                payer.percentage = parseFloat(newPercentage) || 0;
                // Sync amount based on percentage
                const totalAmount = calculateTotal();
                payer.amount = (totalAmount * payer.percentage / 100);
                
                if (isModal) {
                    renderModalPayersTable();
                    updateModalDistributionSummary(); // This will regenerate invoice preview
                } else {
                renderPayersTable();
                updateDistributionSummary();
                }
            }
        }

        // Update payer amount (and sync percentage)
        function updatePayerAmount(payerId, newAmount, isModal = false) {
            const payer = distributionPayers.find(p => p.id === payerId);
            if (payer) {
                payer.amount = parseFloat(newAmount) || 0;
                // Sync percentage based on amount
                const totalAmount = calculateTotal();
                payer.percentage = totalAmount > 0 ? (payer.amount / totalAmount * 100) : 0;
                
                if (isModal) {
                    renderModalPayersTable();
                    updateModalDistributionSummary(); // This will regenerate invoice preview
                } else {
                renderPayersTable();
                updateDistributionSummary();
                }
            }
        }
        
        // Add selected payer to modal
        function addSelectedPayerToModal() {
            const selector = document.getElementById('modalContactSelector');
            if (!selector) return;
            
            const selectedValue = selector.value;
            if (!selectedValue) {
                alert('Please select a contact to add');
                return;
            }

            // Handle quick add option
            if (selectedValue === 'quick-add') {
                openQuickAddModal();
                return;
            }

            const contact = availableContacts[selectedValue];
            if (!contact) {
                alert('Invalid contact selected');
                return;
            }

            // Check if contact already exists
            const exists = distributionPayers.find(p => p.email === contact.email);
            if (exists) {
                alert('This contact is already added');
                return;
            }

            // Add new payer
            const newPayer = {
                id: selectedValue,
                name: contact.name,
                email: contact.email,
                percentage: 0,
                amount: 0,
                isPrimary: false
            };

            distributionPayers.push(newPayer);
            
            // Reset primary contact to share the percentage
            const totalAmount = calculateTotal();
            if (distributionPayers.length === 2) {
                distributionPayers[0].percentage = 50;
                distributionPayers[0].amount = totalAmount * 0.5;
                newPayer.percentage = 50;
                newPayer.amount = totalAmount * 0.5;
            } else {
                // Distribute evenly among all payers
                const evenPercentage = Math.floor(100 / distributionPayers.length);
                distributionPayers.forEach((payer, index) => {
                    payer.percentage = evenPercentage;
                    payer.amount = totalAmount * (evenPercentage / 100);
                });
                const remainder = 100 - (evenPercentage * distributionPayers.length);
                distributionPayers[0].percentage += remainder;
                distributionPayers[0].amount = totalAmount * (distributionPayers[0].percentage / 100);
            }

            // Clear selector and refresh tables
            selector.value = '';
            renderPayersTable();
            updateDistributionSummary();
            renderModalPayersTable();
            updateModalDistributionSummary();
        }

        // Render the payers table
        function renderPayersTable() {
            const tbody = document.getElementById('payersTableBody');
            if (tbody) {
            tbody.innerHTML = '';
                renderPayersTableToBody(tbody, false);
            }
        }
        
        function renderModalPayersTable() {
            const tbody = document.getElementById('modalPayersTableBody');
            if (tbody) {
                tbody.innerHTML = '';
                renderPayersTableToBody(tbody, true);
            }
        }
        
        function renderPayersTableToBody(tbody, isModal) {
            distributionPayers.forEach(payer => {
                const totalAmount = calculateTotal();
                const payerAmount = (totalAmount * payer.percentage / 100);
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-4 py-3">
                        <div class="flex items-center">
                            <div class="w-8 h-8 bg-purple-100 rounded-full flex items-center justify-center mr-3">
                                <svg class="w-4 h-4 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                </svg>
                            </div>
                            <div>
                                <div class="text-sm font-medium text-gray-900">${payer.name}</div>
                                <div class="text-xs text-gray-500">${payer.email}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-4 py-3 text-center">
                        <input 
                            type="number" 
                            value="${payer.percentage.toFixed(1)}" 
                            min="0" 
                            max="100" 
                            step="0.1"
                            class="w-16 px-2 py-1 text-center border border-gray-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-purple-500"
                            onchange="updatePayerPercentage('${payer.id}', this.value, ${isModal})"
                        />
                        <span class="text-xs text-gray-500 ml-1">%</span>
                    </td>
                    <td class="px-4 py-3 text-center">
                        <div class="relative">
                            <span class="absolute left-2 top-1.5 text-gray-500 text-sm">$</span>
                            <input 
                                type="number" 
                                value="${payerAmount.toFixed(2)}" 
                                min="0" 
                                step="0.01"
                                class="w-24 pl-6 pr-2 py-1 text-center border border-gray-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-purple-500"
                                onchange="updatePayerAmount('${payer.id}', this.value, ${isModal})"
                            />
                        </div>
                    </td>
                    <td class="px-4 py-3 text-center">
                        ${payer.isPrimary ? 
                            '<span class="px-2 py-1 bg-blue-100 text-blue-700 text-xs rounded-full font-medium">Primary</span>' :
                            `<button onclick="removePayer('${payer.id}', ${isModal})" class="text-red-600 hover:text-red-700 text-xs font-medium">Remove</button>`
                        }
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Update distribution summary (for Payment Configuration tab)
        function updateDistributionSummary() {
            const totalPercentage = distributionPayers.reduce((sum, p) => sum + p.percentage, 0);
            const totalAmount = calculateTotal();
            
            const totalPercentageEl = document.getElementById('totalPercentage');
            const totalAmountEl = document.getElementById('totalAmount');
            
            if (totalPercentageEl) {
                totalPercentageEl.textContent = `${totalPercentage}%`;
            }
            if (totalAmountEl) {
                totalAmountEl.textContent = `$${totalAmount.toFixed(2)}`;
            }
            
            // Show/hide validation warning
            const warningDiv = document.getElementById('distributionValidationWarning');
            const warningMessage = document.getElementById('distributionValidationMessage');
            
            if (warningDiv && warningMessage) {
            if (totalPercentage !== 100) {
                warningDiv.classList.remove('hidden');
                if (totalPercentage < 100) {
                    warningMessage.textContent = `Total percentage is ${totalPercentage}%. Please allocate the remaining ${100 - totalPercentage}%.`;
                } else {
                    warningMessage.textContent = `Total percentage is ${totalPercentage}%. Please reduce by ${totalPercentage - 100}%.`;
                }
            } else {
                warningDiv.classList.add('hidden');
                }
            }
            
            // Update percentage color
            if (totalPercentageEl) {
            if (totalPercentage === 100) {
                    totalPercentageEl.classList.remove('text-red-600');
                    totalPercentageEl.classList.add('text-green-600');
            } else {
                    totalPercentageEl.classList.remove('text-green-600');
                    totalPercentageEl.classList.add('text-red-600');
                }
            }
            
        }
        
        // Update modal distribution summary
        function updateModalDistributionSummary() {
            const totalPercentage = distributionPayers.reduce((sum, p) => sum + p.percentage, 0);
            const totalAmount = calculateTotal();
            
            const totalPercentageEl = document.getElementById('modalTotalPercentage');
            const totalAmountEl = document.getElementById('modalTotalAmount');
            
            if (totalPercentageEl) {
                totalPercentageEl.textContent = `${totalPercentage}%`;
                if (totalPercentage === 100) {
                    totalPercentageEl.classList.remove('text-red-600');
                    totalPercentageEl.classList.add('text-green-600');
                } else {
                    totalPercentageEl.classList.remove('text-green-600');
                    totalPercentageEl.classList.add('text-red-600');
                }
            }
            if (totalAmountEl) {
                totalAmountEl.textContent = `$${totalAmount.toFixed(2)}`;
            }
            
            // Show/hide validation warning
            const warningDiv = document.getElementById('modalDistributionValidationWarning');
            const warningMessage = document.getElementById('modalDistributionValidationMessage');
            
            if (warningDiv && warningMessage) {
                if (totalPercentage !== 100) {
                    warningDiv.classList.remove('hidden');
                    if (totalPercentage < 100) {
                        warningMessage.textContent = `Total percentage is ${totalPercentage}%. Please allocate the remaining ${100 - totalPercentage}%.`;
                    } else {
                        warningMessage.textContent = `Total percentage is ${totalPercentage}%. Please reduce by ${totalPercentage - 100}%.`;
                    }
                } else {
                    warningDiv.classList.add('hidden');
                }
            }
            
            // Regenerate invoice preview if distribution changed
            const modal = document.getElementById('invoicePreviewModal');
            if (modal && !modal.classList.contains('hidden')) {
                const paymentModel = document.querySelector('input[name="paymentModel"]:checked')?.value || 'full';
                const quoteTotal = calculateTotal();
                const invoices = generateInvoicePreview(paymentModel, quoteTotal);
                renderInvoicePreview(invoices);
                // Update selected invoices summary after regenerating preview
                setTimeout(() => {
                    updateSelectedInvoicesSummary();
                }, 100);
            }
        }

        // Initialize distribution on page load
        function initializeDistribution() {
            // Set initial amount for primary contact
            const totalAmount = calculateTotal();
            distributionPayers[0].amount = totalAmount;
            
            renderPayersTable();
            updateDistributionSummary();
            
            // Add event listener to the Add button
            const addBtn = document.getElementById('addSelectedPayerBtn');
            if (addBtn) {
                addBtn.addEventListener('click', addSelectedPayer);
            }

            // Initialize quick add modal
            initializeQuickAddModal();
        }

        // ============================================================================
        // QUICK ADD CONTACT MODAL FUNCTIONALITY
        // ============================================================================

        let quickAddContactCounter = 1000; // Start from 1000 to avoid conflicts

        function openQuickAddModal() {
            const modal = document.getElementById('quickAddContactModal');
            modal.classList.remove('hidden');
            // Clear form
            document.getElementById('quickAddContactForm').reset();
            // Focus on name field
            document.getElementById('quickAddName').focus();
        }

        function closeQuickAddModal() {
            const modal = document.getElementById('quickAddContactModal');
            modal.classList.add('hidden');
        }

        function initializeQuickAddModal() {
            // Close button
            document.getElementById('closeQuickAddModal').addEventListener('click', closeQuickAddModal);
            document.getElementById('cancelQuickAdd').addEventListener('click', closeQuickAddModal);

            // Close on background click
            document.getElementById('quickAddContactModal').addEventListener('click', (e) => {
                if (e.target.id === 'quickAddContactModal') {
                    closeQuickAddModal();
                }
            });

            // Form submission
            document.getElementById('quickAddContactForm').addEventListener('submit', (e) => {
                e.preventDefault();
                handleQuickAddSubmit();
            });
        }

        function handleQuickAddSubmit() {
            const name = document.getElementById('quickAddName').value.trim();
            const email = document.getElementById('quickAddEmail').value.trim();
            const phone = document.getElementById('quickAddPhone').value.trim();
            const company = document.getElementById('quickAddCompany').value.trim();
            const role = document.getElementById('quickAddRole').value.trim();

            // Validation
            if (!name || !email) {
                alert('Please fill in the required fields (Name and Email)');
                return;
            }

            // Check if email already exists
            const exists = distributionPayers.find(p => p.email === email);
            if (exists) {
                alert('A contact with this email already exists');
                return;
            }

            // Create new contact ID
            const contactId = `quick-${quickAddContactCounter++}`;
            
            // Add to available contacts
            availableContacts[contactId] = { 
                name: name, 
                email: email, 
                phone: phone,
                company: company,
                role: role
            };

            // Add to dropdown (before the quick-add option)
            const selector = document.getElementById('contactSelector');
            const quickAddOption = selector.querySelector('option[value="quick-add"]');
            const newOption = document.createElement('option');
            newOption.value = contactId;
            newOption.textContent = `${name} - ${email}`;
            selector.insertBefore(newOption, quickAddOption);

            // Create new payer
            const newPayer = {
                id: contactId,
                name: name,
                email: email,
                phone: phone,
                company: company,
                role: role,
                percentage: 0,
                amount: 0,
                isPrimary: false
            };

            distributionPayers.push(newPayer);
            
            // Auto-distribute percentages
            const totalAmount = calculateTotal();
            if (distributionPayers.length === 2) {
                distributionPayers[0].percentage = 50;
                distributionPayers[0].amount = totalAmount * 0.5;
                newPayer.percentage = 50;
                newPayer.amount = totalAmount * 0.5;
            } else {
                // Distribute evenly among all payers
                const evenPercentage = Math.floor(100 / distributionPayers.length);
                distributionPayers.forEach((payer, index) => {
                    payer.percentage = evenPercentage;
                    payer.amount = totalAmount * (evenPercentage / 100);
                });
                // Give remainder to primary
                const remainder = 100 - (evenPercentage * distributionPayers.length);
                distributionPayers[0].percentage += remainder;
                distributionPayers[0].amount = totalAmount * (distributionPayers[0].percentage / 100);
            }

            // Update UI
            renderPayersTable();
            updateDistributionSummary();
            closeQuickAddModal();

            // Show success message
            alert(`Contact "${name}" added successfully!`);
        }
    </script>

    <!-- Quick Add Contact Modal -->
    <div id="quickAddContactModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-900">Quick Add Contact</h3>
                    <button id="closeQuickAddModal" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                
                <form id="quickAddContactForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Contact Name *</label>
                        <input 
                            type="text" 
                            id="quickAddName" 
                            required
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-purple-500" 
                            placeholder="John Doe"
                        >
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Email *</label>
                        <input 
                            type="email" 
                            id="quickAddEmail" 
                            required
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-purple-500" 
                            placeholder="john@example.com"
                        >
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Phone</label>
                        <input 
                            type="tel" 
                            id="quickAddPhone" 
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-purple-500" 
                            placeholder="+1 234 567 8900"
                        >
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Company</label>
                        <input 
                            type="text" 
                            id="quickAddCompany" 
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-purple-500" 
                            placeholder="ABC Corp"
                        >
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Role/Relationship</label>
                        <input 
                            type="text" 
                            id="quickAddRole" 
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-purple-500" 
                            placeholder="e.g., Manager, Partner, Assistant"
                        >
                    </div>
                    
                    <div class="flex gap-3 pt-4">
                        <button 
                            type="button" 
                            id="cancelQuickAdd"
                            class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors"
                        >
                            Cancel
                        </button>
                        <button 
                            type="submit"
                            class="flex-1 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors"
                        >
                            Add Contact
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</body>
</html>

