<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Quote - FMS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<body class="min-h-screen bg-gray-50">
    
    <div class="p-4">
        <div class="max-w-7xl mx-auto">
            
            <!-- Header -->
            <div class="bg-white rounded-lg shadow-sm p-4 mb-4">
                <div class="flex justify-between items-center">
                    <div>
                        <div class="flex items-center gap-3 mb-1">
                            <h1 class="text-2xl font-bold text-gray-900">Edit Quote</h1>
                            <span id="quoteIdBadge" class="px-3 py-1 bg-blue-100 text-blue-700 rounded-lg text-sm font-medium">Q-2024-001</span>
                            <span id="quoteStatusBadge" class="px-2 py-1 text-xs rounded bg-yellow-100 text-yellow-700">Draft</span>
                        </div>
                        <p class="text-gray-600 font-medium">Sunshine Tutoring - Melbourne East</p>
                    </div>
                    <div class="flex gap-2">
                        <button 
                            onclick="window.location.href='quote_list_simple.html'"
                            class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 flex items-center gap-2"
                        >
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                            </svg>
                            Back to Quotes
                        </button>
                        <button 
                            id="saveDraftBtn"
                            class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50"
                        >
                            Save Changes
                        </button>
                        <button 
                            id="createInvoiceBtn"
                            onclick="createInvoiceFromQuote()"
                            class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 flex items-center gap-2"
                        >
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            Create Invoice
                        </button>
                        <button 
                            id="createQuoteBtn"
                            class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center gap-2"
                        >
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                            </svg>
                            Update & Send Quote
                        </button>
                    </div>
                </div>
            </div>

            <!-- Tab Navigation -->
            <div class="bg-white rounded-lg shadow-sm mb-4">
                <div class="border-b border-gray-200">
                    <nav class="flex space-x-8 px-6" aria-label="Tabs">
                        <button 
                            id="quoteDetailsTab"
                            class="tab-button active py-4 px-1 border-b-2 border-blue-500 font-medium text-sm text-blue-600"
                            onclick="switchTab('quoteDetails')"
                        >
                            Quote Details
                        </button>
                        <button 
                            id="paymentConfigTab"
                            class="tab-button py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300"
                            onclick="switchTab('paymentConfig')"
                        >
                            Payment Configuration
                        </button>
                        <button 
                            id="invoicesTab"
                            class="tab-button py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300"
                            onclick="switchTab('invoices')"
                        >
                            Invoices
                        </button>
                    </nav>
                </div>
            </div>

            <!-- Quote Details Tab Content -->
            <div id="quoteDetailsContent" class="tab-content">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                
                <!-- Left Column - Customer & Services -->
                <div class="lg:col-span-2 space-y-4">
                    
                    <!-- Customer Section -->
                    <div class="bg-white rounded-lg shadow-sm p-4">
                        <div class="mb-4">
                            <h2 class="text-lg font-semibold text-gray-900">Customer Information</h2>
                        </div>

                        <!-- Selected Customer Card (Always visible in edit mode) -->
                        <div id="selectedCustomerCard">
                            <div class="border border-blue-300 rounded-lg p-3 bg-blue-50">
                                <div class="flex justify-between items-start mb-3">
                                    <div class="flex-1">
                                        <div class="flex items-center gap-2">
                                            <p class="font-semibold text-gray-900" id="selectedCustomerName"></p>
                                        </div>
                                        <p class="text-sm text-gray-600 mt-1" id="selectedCustomerEmail"></p>
                                        <p class="text-sm text-gray-600" id="selectedCustomerPhone"></p>
                                    </div>
                                </div>
                                
                                <!-- Quote Contact Selector (if secondary contacts exist) -->
                                <div id="quoteContactSelector" class="hidden border-t border-blue-200 pt-3 mt-3">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Quote Contact</label>
                                    <select id="quoteContactSelect" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white">
                                        <!-- Options populated dynamically -->
                                    </select>
                                    <p class="text-xs text-gray-500 mt-1">Select who should receive this quote</p>
                                </div>
                                
                                <!-- Service Address Section -->
                                <div class="border-t border-blue-200 pt-3 mt-3">
                                    <div class="flex items-center justify-between mb-2">
                                        <h3 class="text-sm font-medium text-gray-700">Service Address</h3>
                                        <label class="flex items-center gap-2 text-xs text-gray-600">
                                            <input type="checkbox" id="sameAsBilling" checked class="rounded" />
                                            <span>Same as customer address</span>
                                        </label>
                                    </div>
                                    <div id="serviceAddressFields" class="hidden space-y-2">
                                        <div>
                                            <label class="block text-xs text-gray-600 mb-1">Service Location</label>
                                            <input type="text" id="serviceStreet" placeholder="Enter service address" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" />
                                        </div>
                                        <div>
                                            <label class="block text-xs text-gray-600 mb-1">Access Instructions</label>
                                            <textarea id="serviceAddressNotes" rows="2" placeholder="Gate codes, parking info, entry instructions, etc." class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                                        </div>
                                    </div>
                                    <div id="serviceAddressDisplay" class="text-sm text-gray-600" style="display: block;">
                                        <span id="displayServiceAddress"></span>
                                    </div>
                                </div>

                            </div>
                        </div>

                        <!-- New Customer Form (Hidden in edit mode) -->
                        <div id="newCustomerForm" class="hidden" style="display: none;">
                            <!-- Name Fields -->
                            <div class="grid grid-cols-2 gap-3">
                                <div class="form-group">
                                    <label for="newCustomerFirstName" class="block text-sm font-medium text-gray-700 mb-1">First Name *</label>
                                    <input type="text" id="newCustomerFirstName" placeholder="John" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" required />
                                </div>
                                <div class="form-group">
                                    <label for="newCustomerLastName" class="block text-sm font-medium text-gray-700 mb-1">Last Name *</label>
                                    <input type="text" id="newCustomerLastName" placeholder="Doe" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" required />
                                </div>
                            </div>
                            
                            <!-- Company -->
                            <div class="form-group">
                                <label for="newCustomerCompany" class="block text-sm font-medium text-gray-700 mb-1">Company</label>
                                <input type="text" id="newCustomerCompany" placeholder="ABC Corp" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" />
                            </div>
                            
                            <!-- Contact Information -->
                            <div class="border-t border-gray-200 pt-3">
                                <h3 class="text-sm font-medium text-gray-700 mb-3">Contact Information</h3>
                                <div class="form-group">
                                    <label for="newCustomerEmail" class="block text-sm font-medium text-gray-700 mb-1">Email *</label>
                                    <input type="email" id="newCustomerEmail" placeholder="john@example.com" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" required />
                                </div>
                                <div class="form-group mt-3">
                                    <label for="newCustomerPhone" class="block text-sm font-medium text-gray-700 mb-1">Phone</label>
                                    <input type="tel" id="newCustomerPhone" placeholder="+1 234 567 8900" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" />
                                </div>
                                <div class="form-group mt-3">
                                    <label for="newCustomerWhatsApp" class="block text-sm font-medium text-gray-700 mb-1">
                                        WhatsApp Number
                                        <span class="text-xs text-gray-500">(for quote delivery)</span>
                                    </label>
                                    <input type="tel" id="newCustomerWhatsApp" placeholder="+61 412 345 678" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" />
                                </div>
                                <div class="form-group mt-3">
                                    <label for="newCustomerPreferredContact" class="block text-sm font-medium text-gray-700 mb-1">Preferred Contact Method</label>
                                    <select id="newCustomerPreferredContact" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="email">Email</option>
                                        <option value="phone">Phone</option>
                                        <option value="whatsapp">WhatsApp</option>
                                        <option value="none">None</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Address -->
                            <div class="border-t border-gray-200 pt-3">
                                <h3 class="text-sm font-medium text-gray-700 mb-3">Address</h3>
                                <div class="form-group">
                                    <label for="newCustomerStreet" class="block text-sm font-medium text-gray-700 mb-1">Street</label>
                                    <input type="text" id="newCustomerStreet" placeholder="123 Main St" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" />
                                </div>
                                <div class="grid grid-cols-2 gap-3 mt-3">
                                    <div class="form-group">
                                        <label for="newCustomerCity" class="block text-sm font-medium text-gray-700 mb-1">City</label>
                                        <input type="text" id="newCustomerCity" placeholder="New York" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" />
                                    </div>
                                    <div class="form-group">
                                        <label for="newCustomerState" class="block text-sm font-medium text-gray-700 mb-1">State</label>
                                        <input type="text" id="newCustomerState" placeholder="NY" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" />
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-3 mt-3">
                                    <div class="form-group">
                                        <label for="newCustomerPostalCode" class="block text-sm font-medium text-gray-700 mb-1">Postal Code</label>
                                        <input type="text" id="newCustomerPostalCode" placeholder="10001" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" />
                                    </div>
                                    <div class="form-group">
                                        <label for="newCustomerCountry" class="block text-sm font-medium text-gray-700 mb-1">Country</label>
                                        <input type="text" id="newCustomerCountry" placeholder="Australia" value="Australia" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" />
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Notes -->
                            <div class="border-t border-gray-200 pt-3">
                                <h3 class="text-sm font-medium text-gray-700 mb-3">Notes</h3>
                                <textarea id="newCustomerNotes" placeholder="Additional notes about the customer" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                            </div>
                            
                            <!-- Actions -->
                            <div class="flex gap-2 border-t border-gray-200 pt-3">
                                <button 
                                    id="cancelNewCustomerBtn"
                                    class="flex-1 px-3 py-2 border border-gray-300 text-gray-700 rounded-lg text-sm hover:bg-gray-50"
                                >
                                    Cancel
                                </button>
                                <button 
                                    id="createCustomerBtn"
                                    class="flex-1 px-3 py-2 bg-blue-600 text-white rounded-lg text-sm hover:bg-blue-700"
                                >
                                    Create & Select
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Quote Line Items -->
                    <div class="bg-white rounded-lg shadow-sm p-4">
                        <h2 class="text-lg font-semibold text-gray-900 mb-4">Quote Line Items <span class="text-red-500">*</span></h2>
                        
                        <!-- Add Service/Product Search -->
                        <div class="mb-4">
                            <div class="relative">
                                <svg class="absolute left-3 top-3 text-gray-400 w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                </svg>
                                <input 
                                    type="text" 
                                    id="catalogSearchInput"
                                    placeholder="Type to search and add services or products..."
                                    class="w-full pl-10 pr-10 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"
                                    autocomplete="off"
                                />
                                <button id="clearCatalogSearchBtn" class="hidden absolute right-3 top-3 text-gray-400 hover:text-gray-600">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                </button>
                                <!-- Autocomplete Dropdown -->
                                <div id="catalogAutocomplete" class="hidden absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-80 overflow-y-auto custom-scrollbar">
                                    <!-- Autocomplete results will be populated here -->
                                </div>
                            </div>
                        </div>
                        
                        <div id="emptyQuoteState" class="text-center py-12 text-gray-500 bg-gray-50 rounded-lg border-2 border-dashed border-gray-300">
                            <svg class="mx-auto mb-3 text-gray-400 w-12 h-12" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                            </svg>
                            <p class="text-sm font-medium text-gray-700 mb-1">No items added yet</p>
                            <p class="text-xs text-gray-500">Search and add services or products above to build your quote</p>
                        </div>

                        <!-- Card-based Quote Items Container -->
                        <div id="quoteItemsContainer" class="hidden space-y-3">
                            <!-- Quote item cards will be populated here -->
                        </div>
                    </div>
                </div>

                <!-- Right Column - Summary & Actions -->
                <div class="space-y-4">
                    
                    <!-- Pricing Summary -->
                    <div class="bg-white rounded-lg shadow-sm p-4 sticky top-4">
                        <h2 class="text-lg font-semibold text-gray-900 mb-4">Quote Summary</h2>
                        
                        <div class="space-y-3 mb-4">
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-600">Subtotal</span>
                                <span class="font-medium" id="subtotalAmount">$0.00</span>
                            </div>

                            <!-- Line Item Discounts Summary -->
                            <div id="lineItemDiscountSection" class="hidden">
                                <div class="flex justify-between text-sm">
                                    <span class="text-sm text-gray-600">Line Item Discounts</span>
                                    <span class="text-sm font-medium text-red-600" id="lineItemDiscountAmount">-$0.00</span>
                                </div>
                            </div>


                            <div id="approvalWarning" class="hidden bg-yellow-50 border border-yellow-200 rounded p-2 flex items-start gap-2">
                                <svg class="w-4 h-4 text-yellow-600 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                                </svg>
                                <p class="text-xs text-yellow-800">Manager approval required (discount >20%)</p>
                            </div>

                            <!-- Tax Breakdown by Category -->
                            <div class="border-t border-gray-200 pt-3">
                                <div class="text-xs text-gray-600 mb-2">Tax Breakdown:</div>
                                <div id="taxBreakdown" class="space-y-1 text-xs">
                                    <!-- Tax breakdown will be populated here -->
                                </div>
                                <div class="flex justify-between items-center mt-2 pt-2 border-t border-gray-100">
                                    <span class="text-sm text-gray-600">Total Tax</span>
                                    <span class="text-sm font-medium" id="taxAmount">$0.00</span>
                                </div>
                            </div>

                            <!-- Deposit Section -->
                            <div class="border-t border-gray-200 pt-3">
                                <div class="flex items-center justify-between mb-2">
                                    <label class="flex items-center gap-2 text-sm cursor-pointer">
                                        <input type="checkbox" id="requireDeposit" class="rounded" />
                                        <span class="text-gray-700 font-medium">Require Deposit</span>
                                    </label>
                                    <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                </div>
                                
                                <div id="depositSection" class="hidden space-y-2">
                                    <div class="flex items-center gap-2">
                                        <select 
                                            id="depositType"
                                            class="px-2 py-1 border border-gray-300 rounded text-xs"
                                        >
                                            <option value="percentage">%</option>
                                            <option value="fixed">$</option>
                                        </select>
                                        <input 
                                            type="number"
                                            id="depositValue"
                                            value="50"
                                            class="flex-1 px-2 py-1 border border-gray-300 rounded text-sm text-right"
                                            min="0"
                                            step="1"
                                        />
                                    </div>
                                    <div class="flex justify-between text-sm bg-green-50 p-2 rounded">
                                        <span class="text-gray-700">Deposit Required:</span>
                                        <span class="font-semibold text-green-700" id="depositAmount">$0.00</span>
                                    </div>
                                    <div class="flex justify-between text-xs text-gray-600">
                                        <span>Balance Due:</span>
                                        <span id="balanceDue">$0.00</span>
                                    </div>
                                </div>
                            </div>

                            <div class="border-t-2 border-gray-300 pt-3">
                                <div class="flex justify-between">
                                    <span class="font-bold text-gray-900 text-lg">Total</span>
                                    <span class="font-bold text-gray-900 text-lg" id="totalAmount">$0.00</span>
                                </div>
                            </div>
                        </div>

                        <!-- Quote Details -->
                        <div class="border-t border-gray-200 pt-4 space-y-3">
                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-1">Valid Until</label>
                                <input 
                                    type="date" 
                                    id="validUntilDate"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                                />
                            </div>

                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-1">Notes for Customer</label>
                                <textarea 
                                    id="customerNotes"
                                    rows="3"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    placeholder="Terms, conditions, or special notes..."
                                ></textarea>
                            </div>

                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-1">Internal Notes</label>
                                <textarea 
                                    id="internalNotes"
                                    rows="2"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    placeholder="Private notes (not visible to customer)..."
                                ></textarea>
                            </div>
                        </div>
                        <!-- Action Buttons -->
                        <div class="mt-4 space-y-2">
                            <button 
                                id="saveChangesBtn"
                                class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 text-sm font-medium flex items-center justify-center gap-2"
                            >
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path>
                                </svg>
                                Save Changes
                            </button>
                            <button 
                                id="resendQuoteBtn"
                                class="w-full bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 text-sm font-medium flex items-center justify-center gap-2"
                            >
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                                </svg>
                                Resend Quote
                            </button>
                            <button 
                                id="downloadPdfBtn"
                                class="w-full bg-gray-600 text-white py-2 rounded-lg hover:bg-gray-700 text-sm font-medium flex items-center justify-center gap-2"
                            >
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                Download PDF
                            </button>
                            <button 
                                id="createInvoiceSidebarBtn"
                                onclick="createInvoiceFromQuote()"
                                class="w-full bg-purple-600 text-white py-2 rounded-lg hover:bg-purple-700 text-sm font-medium flex items-center justify-center gap-2"
                            >
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                Create Invoice
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            </div>

            <!-- Payment Configuration Tab Content -->
            <div id="paymentConfigContent" class="tab-content hidden">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                    
                    <!-- Left Column - Payment Configuration -->
                    <div class="lg:col-span-2 space-y-4">
                        
                        <!-- Payment Model Section -->
                        <div class="bg-white rounded-lg shadow-sm p-6">
                            <h2 class="text-lg font-semibold text-gray-900 mb-4">Payment Model</h2>
                            
                            <div class="space-y-3">
                                <label class="flex items-start gap-3 p-3 border-2 border-purple-300 bg-purple-50 rounded-lg cursor-pointer">
                                    <input type="radio" name="paymentModel" value="full" checked class="mt-1" onchange="updatePaymentModel()" />
                                    <div class="flex-1">
                                        <div class="font-semibold text-gray-900">Full Payment (Upfront)</div>
                                        <div class="text-xs text-gray-600 mt-1">Customer pays entire amount upfront before service begins</div>
                                    </div>
                                </label>
                                <label class="flex items-start gap-3 p-3 border-2 border-gray-200 rounded-lg cursor-pointer hover:border-purple-300 hover:bg-purple-50">
                                    <input type="radio" name="paymentModel" value="deposit" class="mt-1" onchange="updatePaymentModel()" />
                                    <div class="flex-1">
                                        <div class="font-semibold text-gray-900">Down Payment (Deposit)</div>
                                        <div class="text-xs text-gray-600 mt-1">Customer pays deposit now, remaining balance later</div>
                                    </div>
                                </label>
                                <label class="flex items-start gap-3 p-3 border-2 border-gray-200 rounded-lg cursor-pointer hover:border-purple-300 hover:bg-purple-50">
                                    <input type="radio" name="paymentModel" value="subscription" class="mt-1" onchange="updatePaymentModel()" />
                                    <div class="flex-1">
                                        <div class="font-semibold text-gray-900">Subscription (Recurring)</div>
                                        <div class="text-xs text-gray-600 mt-1">Automatic recurring invoices at regular intervals</div>
                                    </div>
                                </label>
                            </div>

                            <!-- Subscription Settings (shown when subscription selected) -->
                            <div id="subscriptionSection" class="hidden mt-4 p-4 bg-gray-50 rounded-lg">
                                <h3 class="text-sm font-medium text-gray-700 mb-3">Subscription Settings</h3>
                                <div class="space-y-3">
                                    <div>
                                        <label class="block text-xs text-gray-600 mb-1">Billing Frequency</label>
                                        <select id="billingFrequency" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                                            <option value="weekly">Weekly</option>
                                            <option value="biweekly">Bi-weekly (Every 2 weeks)</option>
                                            <option value="monthly" selected>Monthly</option>
                                            <option value="quarterly">Quarterly (Every 3 months)</option>
                                            <option value="yearly">Yearly</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-xs text-gray-600 mb-1">Subscription Start Date</label>
                                        <input type="date" id="subscriptionStartDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500" />
                                    </div>
                                    <div>
                                        <label class="block text-xs text-gray-600 mb-1">Subscription End (Optional)</label>
                                        <select id="subscriptionEnd" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500" onchange="toggleEndDate()">
                                            <option value="ongoing">Ongoing (No end date)</option>
                                            <option value="after_cycles">After specific number of cycles</option>
                                            <option value="end_date">Specific end date</option>
                                        </select>
                                    </div>
                                    <div id="cyclesInput" class="hidden">
                                        <label class="block text-xs text-gray-600 mb-1">Number of Billing Cycles</label>
                                        <input type="number" id="billingCycles" min="1" placeholder="e.g., 12" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500" />
                                    </div>
                                    <div id="endDateInput" class="hidden">
                                        <label class="block text-xs text-gray-600 mb-1">End Date</label>
                                        <input type="date" id="subscriptionEndDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500" />
                                    </div>
                                    <div class="flex items-center gap-2 p-2 bg-green-50 rounded">
                                        <input type="checkbox" id="autoCharge" checked class="rounded text-green-600" />
                                        <label for="autoCharge" class="text-xs text-green-800">
                                            <strong>Auto-charge enabled</strong> - Automatically charge customer on billing date
                                        </label>
                                    </div>
                                    <div class="p-2 bg-blue-50 rounded text-xs text-blue-800">
                                        <strong>Next Invoice:</strong> <span id="nextInvoiceDate">-</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Deposit Amount (shown when deposit selected) -->
                            <div id="depositSection" class="hidden mt-4 p-4 bg-gray-50 rounded-lg">
                                <h3 class="text-sm font-medium text-gray-700 mb-3">Deposit Amount</h3>
                                <div class="space-y-2">
                                    <div class="flex gap-2">
                                        <div class="flex-1">
                                            <div class="relative">
                                                <span class="absolute left-3 top-2.5 text-gray-500">$</span>
                                                <input 
                                                    type="number" 
                                                    id="depositAmount"
                                                    placeholder="0.00"
                                                    min="0"
                                                    step="0.01"
                                                    class="w-full pl-7 pr-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                                                    oninput="updateDepositCalculation()"
                                                />
                                            </div>
                                        </div>
                                        <div class="flex-1">
                                            <div class="relative">
                                                <input 
                                                    type="number" 
                                                    id="depositPercentage"
                                                    placeholder="0"
                                                    min="0"
                                                    max="100"
                                                    step="1"
                                                    class="w-full pr-8 pl-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                                                    oninput="updateDepositFromPercentage()"
                                                />
                                                <span class="absolute right-3 top-2.5 text-gray-500">%</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="flex gap-2">
                                        <button type="button" onclick="setDepositPercentage(25)" class="flex-1 px-3 py-1.5 text-xs border border-gray-300 rounded hover:bg-gray-50">25%</button>
                                        <button type="button" onclick="setDepositPercentage(50)" class="flex-1 px-3 py-1.5 text-xs border border-gray-300 rounded hover:bg-gray-50">50%</button>
                                        <button type="button" onclick="setDepositPercentage(75)" class="flex-1 px-3 py-1.5 text-xs border border-gray-300 rounded hover:bg-gray-50">75%</button>
                                    </div>
                                    <div class="p-2 bg-blue-50 rounded text-xs text-blue-800">
                                        <strong>Remaining Balance:</strong> <span id="remainingBalance">$0.00</span> (due after service completion)
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Accepted Payment Methods Section -->
                        <div class="bg-white rounded-lg shadow-sm p-6">
                            <h2 class="text-lg font-semibold text-gray-900 mb-4">Accepted Payment Methods</h2>
                            
                            <div id="paymentMethodsContainer" class="space-y-2">
                                <label class="flex items-center gap-2 p-2 border border-gray-200 rounded hover:bg-gray-50 cursor-pointer" data-payment-method="stripe">
                                    <input type="checkbox" id="paymentStripe" value="stripe" checked class="rounded text-purple-600" />
                                    <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path>
                                    </svg>
                                    <span class="text-sm font-medium">Stripe</span>
                                    <span class="ml-auto text-xs text-purple-600 font-medium" id="stripeTag"></span>
                                </label>
                                <label class="flex items-center gap-2 p-2 border border-gray-200 rounded hover:bg-gray-50 cursor-pointer" data-payment-method="paypal">
                                    <input type="checkbox" id="paymentPaypal" value="paypal" checked class="rounded text-purple-600" />
                                    <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path>
                                    </svg>
                                    <span class="text-sm font-medium">PayPal</span>
                                    <span class="ml-auto text-xs text-purple-600 font-medium" id="paypalTag"></span>
                                </label>
                                <label class="flex items-center gap-2 p-2 border border-gray-200 rounded hover:bg-gray-50 cursor-pointer" data-payment-method="google_wallet">
                                    <input type="checkbox" id="paymentGoogleWallet" value="google_wallet" class="rounded text-purple-600" />
                                    <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9 3-9m-9 9a9 9 0 019-9"></path>
                                    </svg>
                                    <span class="text-sm font-medium">Google Wallet</span>
                                    <span class="ml-auto text-xs text-purple-600 font-medium" id="googleWalletTag"></span>
                                </label>
                                <label class="flex items-center gap-2 p-2 border border-gray-200 rounded hover:bg-gray-50 cursor-pointer" data-payment-method="apple_pay">
                                    <input type="checkbox" id="paymentApplePay" value="apple_pay" class="rounded text-purple-600" />
                                    <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                                    </svg>
                                    <span class="text-sm font-medium">Apple Pay</span>
                                    <span class="ml-auto text-xs text-purple-600 font-medium" id="applePayTag"></span>
                                </label>
                                <label class="flex items-center gap-2 p-2 border border-gray-200 rounded hover:bg-gray-50 cursor-pointer" data-payment-method="cash">
                                    <input type="checkbox" id="paymentCash" value="cash" class="rounded text-purple-600" />
                                    <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path>
                                    </svg>
                                    <span class="text-sm font-medium">Cash</span>
                                </label>
                            </div>
                            <p class="text-xs text-gray-500 mt-2" id="paymentMethodHint">Select at least one payment method</p>
                        </div>

                        <!-- Payment Terms Section -->
                        <div class="bg-white rounded-lg shadow-sm p-6">
                            <h2 class="text-lg font-semibold text-gray-900 mb-4">Payment Terms</h2>
                            
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Default Payment Terms</label>
                                    <select 
                                        id="defaultPaymentTerms"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                                    >
                                        <option value="due_on_receipt">Due on Receipt</option>
                                        <option value="net_7">Net 7 Days</option>
                                        <option value="net_15">Net 15 Days</option>
                                        <option value="net_30" selected>Net 30 Days</option>
                                        <option value="net_60">Net 60 Days</option>
                                    </select>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Payment Instructions</label>
                                    <textarea 
                                        id="paymentInstructions"
                                        rows="3"
                                        placeholder="Payment instructions, terms, or special notes..."
                                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                                    ></textarea>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Right Column - Payment Summary -->
                    <div class="space-y-4">
                        
                        <!-- Payment Configuration Summary -->
                        <div class="bg-white rounded-lg shadow-sm p-4 sticky top-4">
                            <h2 class="text-lg font-semibold text-gray-900 mb-4">Payment Configuration Summary</h2>
                            
                            <div class="space-y-3 mb-4">
                                <div class="p-3 bg-purple-50 rounded-lg">
                                    <div class="text-xs text-purple-600 mb-1">Payment Model</div>
                                    <div class="text-lg font-bold text-purple-700" id="paymentModelDisplay">Full Payment</div>
                                </div>

                                <div class="space-y-2 text-sm">
                                    <div id="depositInfo" class="hidden">
                                        <div class="flex justify-between text-xs">
                                            <span class="text-gray-600">Deposit Amount</span>
                                            <span class="text-gray-900 font-semibold" id="depositAmountDisplay">$0.00</span>
                                        </div>
                                        <div class="flex justify-between text-xs">
                                            <span class="text-gray-600">Remaining Balance</span>
                                            <span class="text-gray-600" id="remainingBalanceDisplay">$0.00</span>
                                        </div>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Payment Terms</span>
                                        <span class="text-gray-900 font-medium" id="paymentTermsDisplay">Net 30 Days</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Payment Methods</span>
                                        <span class="text-gray-900 font-medium" id="paymentMethodsDisplay">2 selected</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Action Buttons -->
                            <div class="space-y-2">
                                <button 
                                    id="savePaymentConfigBtn"
                                    class="w-full bg-purple-600 text-white py-2.5 rounded-lg hover:bg-purple-700 text-sm font-medium flex items-center justify-center gap-2"
                                >
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path>
                                    </svg>
                                    Save Payment Configuration
                                </button>
                            </div>

                            <!-- Help Text -->
                            <div class="mt-4 p-3 bg-blue-50 rounded-lg">
                                <p class="text-xs text-blue-800">
                                    <strong>Payment Configuration</strong><br>
                                    These settings will be applied when creating invoices from this quote.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Invoices Tab Content -->
            <div id="invoicesContent" class="tab-content hidden">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                    
                    <!-- Left Column - Invoice Management -->
                    <div class="lg:col-span-2 space-y-4">
                        
                        <!-- Create New Invoice Section -->
                        <div class="bg-white rounded-lg shadow-sm p-6">
                            <div class="flex items-center justify-between mb-4">
                                <h2 class="text-lg font-semibold text-gray-900">Create New Invoice</h2>
                                <span class="px-2 py-1 bg-blue-100 text-blue-700 text-xs rounded-full font-medium">From Quote</span>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                <button 
                                    onclick="createFullInvoice()"
                                    class="p-4 border-2 border-purple-200 rounded-lg hover:border-purple-400 hover:bg-purple-50 transition-colors text-left"
                                >
                                    <div class="flex items-center gap-3 mb-2">
                                        <div class="w-8 h-8 bg-purple-100 rounded-full flex items-center justify-center">
                                            <svg class="w-4 h-4 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                            </svg>
                                        </div>
                                        <span class="font-semibold text-gray-900">Full Invoice</span>
                                    </div>
                                    <p class="text-xs text-gray-600">Invoice for the complete quote amount</p>
                                </button>
                                
                                <button 
                                    onclick="createDepositInvoice()"
                                    class="p-4 border-2 border-blue-200 rounded-lg hover:border-blue-400 hover:bg-blue-50 transition-colors text-left"
                                >
                                    <div class="flex items-center gap-3 mb-2">
                                        <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
                                            <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path>
                                            </svg>
                                        </div>
                                        <span class="font-semibold text-gray-900">Deposit Invoice</span>
                                    </div>
                                    <p class="text-xs text-gray-600">Invoice for deposit/down payment</p>
                                </button>
                                
                                <button 
                                    onclick="createPartialInvoice()"
                                    class="p-4 border-2 border-green-200 rounded-lg hover:border-green-400 hover:bg-green-50 transition-colors text-left"
                                >
                                    <div class="flex items-center gap-3 mb-2">
                                        <div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center">
                                            <svg class="w-4 h-4 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                                            </svg>
                                        </div>
                                        <span class="font-semibold text-gray-900">Partial Invoice</span>
                                    </div>
                                    <p class="text-xs text-gray-600">Invoice for selected items only</p>
                                </button>
                            </div>
                            
                            <!-- Preview Invoices Button -->
                            <div class="mb-4">
                                <button 
                                    onclick="showInvoicePreview()"
                                    class="w-full bg-gray-600 text-white py-3 px-4 rounded-lg hover:bg-gray-700 transition-colors flex items-center justify-center gap-2"
                                >
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                    </svg>
                                    Preview All Invoices
                                </button>
                            </div>
                            
                            <!-- Payment Configuration Summary -->
                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                <div class="flex items-start gap-2 mb-3">
                                    <svg class="w-4 h-4 text-blue-600 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                    <div class="flex-1">
                                        <p class="font-medium text-blue-800 text-sm mb-2">Payment Configuration Summary</p>
                                        <div class="space-y-2 text-xs text-blue-700">
                                            <div class="flex justify-between">
                                                <span>Payment Model:</span>
                                                <span class="font-medium" id="invoicePaymentModel">Full Payment</span>
                                            </div>
                                            <div class="flex justify-between">
                                                <span>Payment Terms:</span>
                                                <span class="font-medium" id="invoicePaymentTerms">Net 30 Days</span>
                                            </div>
                                            <div class="flex justify-between">
                                                <span>Payment Methods:</span>
                                                <span class="font-medium" id="invoicePaymentMethods">2 selected</span>
                                            </div>
                                            <div id="invoiceDepositInfo" class="hidden">
                                                <div class="flex justify-between">
                                                    <span>Deposit Amount:</span>
                                                    <span class="font-medium" id="invoiceDepositAmount">$0.00</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="mt-2 pt-2 border-t border-blue-300">
                                            <button 
                                                onclick="switchTab('paymentConfig')"
                                                class="text-xs text-blue-700 hover:text-blue-800 underline"
                                            >
                                                Configure Payment Settings 
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Split Invoice Section -->
                        <div class="bg-white rounded-lg shadow-sm p-6">
                            <div class="mb-4">
                                <h2 class="text-lg font-semibold text-gray-900">Split Invoice</h2>
                                <p class="text-xs text-gray-500 mt-1">Create separate invoices for multiple payers</p>
                            </div>

                            <!-- Split Configuration -->
                            <div id="splitInvoiceConfig" class="space-y-4">
                                <!-- Split Method -->
                                <div class="bg-purple-50 border border-purple-200 rounded-lg p-3">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Split Method</label>
                                    <div class="flex gap-2">
                                        <button 
                                            id="splitByPercentage" 
                                            class="flex-1 px-3 py-2 text-sm font-medium rounded-lg bg-purple-600 text-white"
                                        >
                                            By Percentage
                                        </button>
                                        <button 
                                            id="splitByAmount" 
                                            class="flex-1 px-3 py-2 text-sm font-medium rounded-lg bg-white border border-gray-300 text-gray-700 hover:bg-gray-50"
                                        >
                                            By Amount
                                        </button>
                                    </div>
                                </div>

                                <!-- Payers List -->
                                <div>
                                    <div class="flex items-center justify-between mb-3">
                                        <label class="text-sm font-medium text-gray-700">Payers</label>
                                        <button 
                                            id="addPayerBtn"
                                            class="text-sm text-purple-600 hover:text-purple-700 font-medium flex items-center gap-1"
                                        >
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                                            </svg>
                                            Add Payer
                                        </button>
                                    </div>
                                    <div id="payersList" class="space-y-3">
                                        <!-- Payers will be added here -->
                                    </div>
                                </div>

                                <!-- Split Summary -->
                                <div class="bg-gray-50 rounded-lg p-3 border border-gray-200">
                                    <div class="text-xs font-medium text-gray-700 mb-2">Split Summary</div>
                                    <div class="space-y-1 text-xs">
                                        <div class="flex justify-between">
                                            <span class="text-gray-600">Total Amount:</span>
                                            <span id="splitTotalAmount" class="font-medium">$0.00</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-gray-600">Allocated:</span>
                                            <span id="splitAllocatedAmount" class="font-medium">$0.00</span>
                                        </div>
                                        <div class="flex justify-between border-t border-gray-300 pt-1 mt-1">
                                            <span class="text-gray-600">Remaining:</span>
                                            <span id="splitRemainingAmount" class="font-medium text-red-600">$0.00</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Validation Warning -->
                                <div id="splitValidationWarning" class="hidden bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                                    <div class="flex items-start gap-2">
                                        <svg class="w-4 h-4 text-yellow-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                                        </svg>
                                        <p class="text-xs text-yellow-800" id="splitValidationMessage">Please allocate the full amount across all payers.</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Existing Invoices Section -->
                        <div class="bg-white rounded-lg shadow-sm p-6">
                            <div class="flex items-center justify-between mb-4">
                                <h2 class="text-lg font-semibold text-gray-900">Existing Invoices</h2>
                                <button 
                                    onclick="refreshInvoices()"
                                    class="text-sm text-blue-600 hover:text-blue-700 flex items-center gap-1"
                                >
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                    </svg>
                                    Refresh
                                </button>
                            </div>
                            
                            <div id="invoicesList" class="space-y-3">
                                <!-- Invoices will be populated here -->
                            </div>
                            
                            <div id="noInvoicesState" class="text-center py-8 text-gray-500">
                                <svg class="mx-auto mb-3 text-gray-400 w-12 h-12" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                <p class="text-sm font-medium text-gray-700 mb-1">No invoices created yet</p>
                                <p class="text-xs text-gray-500">Create your first invoice using the options above</p>
                            </div>
                        </div>
                    </div>

                    <!-- Right Column - Invoice Summary -->
                    <div class="space-y-4">
                        
                        <!-- Invoice Summary -->
                        <div class="bg-white rounded-lg shadow-sm p-4 sticky top-4">
                            <h2 class="text-lg font-semibold text-gray-900 mb-4">Invoice Summary</h2>
                            
                            <div class="space-y-3 mb-4">
                                <div class="p-3 bg-gray-50 rounded-lg">
                                    <div class="text-xs text-gray-600 mb-1">Quote Total</div>
                                    <div class="text-2xl font-bold text-gray-900" id="invoiceQuoteTotal">$0.00</div>
                                </div>

                                <div class="space-y-2 text-sm">
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Total Invoiced</span>
                                        <span class="font-medium text-gray-900" id="totalInvoiced">$0.00</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Total Paid</span>
                                        <span class="font-medium text-green-600" id="totalPaid">$0.00</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Outstanding</span>
                                        <span class="font-medium text-red-600" id="totalOutstanding">$0.00</span>
                                    </div>
                                    <div class="flex justify-between border-t border-gray-200 pt-2">
                                        <span class="text-gray-600">Remaining to Invoice</span>
                                        <span class="font-semibold text-blue-600" id="remainingToInvoice">$0.00</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Invoice Status -->
                            <div class="border-t border-gray-200 pt-3">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-sm font-medium text-gray-700">Invoice Status</span>
                                    <span id="invoiceStatusBadge" class="px-2 py-1 bg-gray-100 text-gray-700 rounded text-xs font-medium">Not Invoiced</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-2">
                                    <div id="invoiceProgressBar" class="bg-blue-600 h-2 rounded-full" style="width: 0%"></div>
                                </div>
                                <p class="text-xs text-gray-500 mt-1" id="invoiceProgressText">0% of quote amount invoiced</p>
                            </div>

                            <!-- Quick Actions -->
                            <div class="border-t border-gray-200 pt-3 mt-3">
                                <h3 class="text-sm font-medium text-gray-700 mb-2">Quick Actions</h3>
                                <div class="space-y-2">
                                    <button 
                                        onclick="sendPaymentReminder()"
                                        class="w-full text-left px-3 py-2 text-sm text-gray-700 hover:bg-gray-50 rounded-lg flex items-center gap-2"
                                    >
                                        <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                                        </svg>
                                        Send Payment Reminder
                                    </button>
                                    <button 
                                        onclick="viewPaymentHistory()"
                                        class="w-full text-left px-3 py-2 text-sm text-gray-700 hover:bg-gray-50 rounded-lg flex items-center gap-2"
                                    >
                                        <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path>
                                        </svg>
                                        View Payment History
                                    </button>
                                    <button 
                                        onclick="downloadInvoiceReport()"
                                        class="w-full text-left px-3 py-2 text-sm text-gray-700 hover:bg-gray-50 rounded-lg flex items-center gap-2"
                                    >
                                        <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                        </svg>
                                        Download Invoice Report
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quote Preview Modal (PDF-like) -->
    <div id="previewModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto custom-scrollbar">
            <div class="p-6">
                <div class="flex items-center justify-between mb-4 sticky top-0 bg-white pb-4 border-b">
                    <h3 class="text-lg font-semibold text-gray-900">Quote Preview</h3>
                    <div class="flex gap-2">
                        <button id="downloadPreviewBtn" class="px-3 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 text-sm flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                            </svg>
                            Download PDF
                        </button>
                        <button id="closePreviewBtn" class="px-3 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 text-sm">
                            Close
                        </button>
                    </div>
                </div>
                
                <div id="previewContent" class="bg-white p-8" style="font-family: 'Helvetica', 'Arial', sans-serif;">
                    <!-- PDF-like content will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Price Modification Modal -->
    <div id="priceModModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
            <div class="p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-900">Modify Price</h3>
                    <button id="closePriceModModal" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                
                <div class="mb-4">
                    <div class="flex items-center gap-2 mb-2">
                        <p class="text-sm font-medium text-gray-900" id="priceModItemName"></p>
                        <span id="priceModItemType"></span>
                    </div>
                    <div class="flex items-center gap-2 text-sm">
                        <span class="text-gray-600">Original Price:</span>
                        <span class="font-medium" id="priceModOriginal"></span>
                    </div>
                    <div class="flex items-center gap-2 text-sm mt-1">
                        <span class="text-gray-600">New Price:</span>
                        <span class="font-semibold text-blue-600" id="priceModNew"></span>
                    </div>
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Reason for modification <span class="text-red-600">*</span></label>
                    <textarea 
                        id="priceModComment"
                        rows="3"
                        placeholder="Enter reason for price modification (required for approval)"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                    ></textarea>
                </div>
                
                <div class="flex gap-3">
                    <button id="cancelPriceModBtn" class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 text-sm font-medium">
                        Cancel
                    </button>
                    <button id="savePriceModBtn" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm font-medium">
                        Save Changes
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Invoice Preview Modal -->
    <div id="invoicePreviewModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-xl max-w-5xl w-full mx-4 max-h-[90vh] overflow-y-auto custom-scrollbar">
            <div class="p-6">
                <div class="flex items-center justify-between mb-6 sticky top-0 bg-white pb-4 border-b">
                    <h3 class="text-xl font-semibold text-gray-900">Invoice Preview</h3>
                    <div class="flex gap-2">
                        <button 
                            id="createAllInvoicesBtn"
                            class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm font-medium flex items-center gap-2"
                        >
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                            </svg>
                            Create All Invoices
                        </button>
                        <button 
                            id="closeInvoicePreviewBtn"
                            class="px-3 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 text-sm"
                        >
                            Close
                        </button>
                    </div>
                </div>

                <div id="invoicePreviewContent" class="space-y-6">
                    <!-- Invoice previews will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Existing quote data (would normally come from server/API)
        const existingQuote = {
            id: 'Q-2024-001',
            status: 'draft',
            createdDate: '2024-10-20',
            validUntil: '2024-11-03',
            customerNotes: 'Thank you for your interest in our tutoring services.',
            internalNotes: 'Customer prefers morning sessions.'
        };

        // State management - Pre-populated with existing quote data for edit mode
        const state = {
            businessType: 'tutoring',
            quoteId: existingQuote.id,
            quoteStatus: existingQuote.status,
            selectedCustomer: {
                id: 1,
                name: 'Alice Anderson',
                email: 'alice.a@email.com',
                phone: '0412 345 678',
                address: '1 Albert St, Melbourne VIC 3000',
                previousQuotes: 3,
                secondaryContacts: [
                    { name: 'John Anderson', email: 'john.a@email.com', phone: '0412 345 679', role: 'Spouse' }
                ]
            },
            selectedQuoteContact: {
                type: 'primary',
                name: 'Alice Anderson',
                email: 'alice.a@email.com',
                phone: '0412 345 678'
            },
            showNewCustomerForm: false,
            quoteItems: [
                {
                    id: 't1',
                    name: 'One-on-One Tutoring - Math',
                    tag: 'Tutoring',
                    type: 'service',
                    price: 75,
                    customPrice: 75,
                    originalPrice: 75,
                    pricingType: 'per_hour',
                    unit: 'hour',
                    taxCategory: 'taxable_gst',
                    quantity: 2,
                    priceModified: false,
                    priceModificationComment: '',
                    notes: 'Focus on algebra and geometry',
                    serviceDate: '2024-10-25',
                    discount: 0,
                    discountType: 'percentage',
                    preferredTime: 'morning',
                    exactTime: '',
                    scheduleNotes: 'Prefer Monday and Wednesday'
                },
                {
                    id: 't4',
                    name: 'Assessment & Report',
                    tag: 'Assessment',
                    type: 'service',
                    price: 120,
                    customPrice: 120,
                    originalPrice: 120,
                    pricingType: 'fixed',
                    unit: 'each',
                    taxCategory: 'taxable_gst',
                    quantity: 1,
                    priceModified: false,
                    priceModificationComment: '',
                    notes: '',
                    serviceDate: '2024-10-28',
                    discount: 0,
                    discountType: 'percentage',
                    preferredTime: '',
                    exactTime: '',
                    scheduleNotes: ''
                }
            ],
            depositRequired: false,
            depositType: 'percentage',
            depositValue: 50,
            approvalRequired: false,
            currentPriceModIndex: null,
            currentPriceModNewValue: null
        };

        // Sample data - Customers A-Z
        const customers = [
            { 
                id: 1, 
                name: 'Alice Anderson', 
                email: 'alice.a@email.com', 
                phone: '0412 345 678', 
                address: '1 Albert St, Melbourne VIC 3000', 
                previousQuotes: 3,
                secondaryContacts: [
                    { name: 'John Anderson', email: 'john.a@email.com', phone: '0412 345 679', role: 'Spouse' }
                ]
            },
            { 
                id: 2, 
                name: 'Bob Brown', 
                email: 'bob.brown@email.com', 
                phone: '0413 456 789', 
                address: '2 Bridge Rd, Richmond VIC 3121', 
                previousQuotes: 5,
                secondaryContacts: [
                    { name: 'Sarah Brown', email: 'sarah.b@email.com', phone: '0413 456 790', role: 'Assistant' },
                    { name: 'Mike Brown', email: 'mike.b@email.com', phone: '0413 456 791', role: 'Business Partner' }
                ]
            },
            { id: 3, name: 'Charlie Chen', email: 'charlie.c@email.com', phone: '0414 567 890', address: '3 Chapel St, Windsor VIC 3181', previousQuotes: 2 },
            { id: 4, name: 'David Davis', email: 'david.d@email.com', phone: '0412 444 444', address: '4 Docklands Dr, Docklands VIC 3008', previousQuotes: 0 },
            { id: 5, name: 'Emily Evans', email: 'emily.evans@email.com', phone: '0412 555 555', address: '5 Elizabeth St, Melbourne VIC 3000', previousQuotes: 2 },
            { id: 6, name: 'Frank Foster', email: 'frank.f@email.com', phone: '0412 666 666', address: '6 Flinders St, Melbourne VIC 3000', previousQuotes: 4 },
            { id: 7, name: 'Grace Garcia', email: 'grace.g@email.com', phone: '0412 777 777', address: '7 Glenferrie Rd, Hawthorn VIC 3122', previousQuotes: 1 },
            { id: 8, name: 'Henry Harris', email: 'henry.h@email.com', phone: '0412 888 888', address: '8 High St, Kew VIC 3101', previousQuotes: 6 },
            { id: 9, name: 'Isabella Ibrahim', email: 'isabella.i@email.com', phone: '0412 999 999', address: '9 Inkerman St, St Kilda VIC 3182', previousQuotes: 0 },
            { id: 10, name: 'James Johnson', email: 'james.j@email.com', phone: '0413 111 111', address: '10 Johnston St, Fitzroy VIC 3065', previousQuotes: 3 },
            { id: 11, name: 'Katherine Kim', email: 'kate.kim@email.com', phone: '0413 222 222', address: '11 King St, Melbourne VIC 3000', previousQuotes: 2 },
            { id: 12, name: 'Liam Lee', email: 'liam.lee@email.com', phone: '0413 333 333', address: '12 Lygon St, Carlton VIC 3053', previousQuotes: 7 },
            { id: 13, name: 'Maria Martinez', email: 'maria.m@email.com', phone: '0413 444 444', address: '13 Main Rd, Eltham VIC 3095', previousQuotes: 1 },
            { id: 14, name: 'Nathan Nguyen', email: 'nathan.n@email.com', phone: '0413 555 555', address: '14 Nicholson St, Fitzroy VIC 3065', previousQuotes: 4 },
            { id: 15, name: "Olivia O'Connor", email: 'olivia.o@email.com', phone: '0413 666 666', address: '15 Ormond Rd, Elwood VIC 3184', previousQuotes: 0 },
            { id: 16, name: 'Patrick Patel', email: 'patrick.p@email.com', phone: '0413 777 777', address: '16 Park St, South Melbourne VIC 3205', previousQuotes: 5 },
            { id: 17, name: 'Quinn Roberts', email: 'quinn.r@email.com', phone: '0413 888 888', address: '17 Queen St, Melbourne VIC 3000', previousQuotes: 2 },
            { id: 18, name: 'Rachel Robinson', email: 'rachel.r@email.com', phone: '0413 999 999', address: '18 Royal Pde, Parkville VIC 3052', previousQuotes: 3 },
            { id: 19, name: 'Samuel Smith', email: 'sam.smith@email.com', phone: '0414 111 111', address: '19 Smith St, Collingwood VIC 3066', previousQuotes: 8 },
            { id: 20, name: 'Taylor Thompson', email: 'taylor.t@email.com', phone: '0414 222 222', address: '20 Toorak Rd, South Yarra VIC 3141', previousQuotes: 1 },
            { id: 21, name: 'Uma Patel', email: 'uma.patel@email.com', phone: '0414 333 333', address: '21 Union St, Windsor VIC 3181', previousQuotes: 0 },
            { id: 22, name: 'Victor Vasquez', email: 'victor.v@email.com', phone: '0414 444 444', address: '22 Victoria St, Richmond VIC 3121', previousQuotes: 4 },
            { id: 23, name: 'Wendy White', email: 'wendy.w@email.com', phone: '0414 555 555', address: '23 Wellington St, St Kilda VIC 3182', previousQuotes: 2 },
            { id: 24, name: 'Xavier Xu', email: 'xavier.x@email.com', phone: '0414 666 666', address: '24 Xavier St, Kew VIC 3101', previousQuotes: 6 },
            { id: 25, name: 'Yasmin Young', email: 'yasmin.y@email.com', phone: '0414 777 777', address: '25 York St, South Melbourne VIC 3205', previousQuotes: 1 },
            { id: 26, name: 'Zachary Zhang', email: 'zach.zhang@email.com', phone: '0414 888 888', address: '26 Zoe St, Brunswick VIC 3056', previousQuotes: 3 }
        ];

        const tutoringServices = [
            // Services with GST (10% tax)
            { id: 't1', name: 'One-on-One Tutoring - Math', tag: 'Tutoring', type: 'service', price: 75, pricingType: 'per_hour', unit: 'hour', taxCategory: 'taxable_gst' },
            { id: 't2', name: 'One-on-One Tutoring - English', tag: 'Tutoring', type: 'service', price: 75, pricingType: 'per_hour', unit: 'hour', taxCategory: 'taxable_gst' },
            { id: 't3', name: 'Small Group (2-4 students)', tag: 'Group', type: 'service', price: 50, pricingType: 'per_hour', unit: 'hour', taxCategory: 'taxable_gst' },
            { id: 't4', name: 'Assessment & Report', tag: 'Assessment', type: 'service', price: 120, pricingType: 'fixed', unit: 'each', taxCategory: 'taxable_gst' },
            
            // Services GST-Free (0% tax)
            { id: 't5', name: 'Educational Counseling Service', tag: 'Support', type: 'service', price: 80, pricingType: 'per_hour', unit: 'hour', taxCategory: 'gst_free' },
            { id: 't6', name: 'Learning Disability Assessment', tag: 'Assessment', type: 'service', price: 150, pricingType: 'fixed', unit: 'each', taxCategory: 'gst_free' },
            
            // Services Input-Taxed (0% tax)
            { id: 't7', name: 'Tutoring Consultation Fee', tag: 'Consultation', type: 'service', price: 60, pricingType: 'fixed', unit: 'each', taxCategory: 'input_taxed' },
            
            // Products with GST (10% tax)
            { id: 'p1', name: 'Study Materials Package', tag: 'Materials', type: 'product', price: 45, pricingType: 'per_unit', unit: 'each', taxCategory: 'taxable_gst' },
            { id: 'p2', name: 'Textbook Bundle', tag: 'Materials', type: 'product', price: 120, pricingType: 'per_unit', unit: 'each', taxCategory: 'taxable_gst' },
            { id: 'p3', name: 'Practice Test Series', tag: 'Materials', type: 'product', price: 35, pricingType: 'per_unit', unit: 'each', taxCategory: 'taxable_gst' },
            
            // Products GST-Free (0% tax)
            { id: 'p4', name: 'Educational Books', tag: 'Materials', type: 'product', price: 25, pricingType: 'per_unit', unit: 'each', taxCategory: 'gst_free' },
            { id: 'p5', name: 'Basic Learning Materials', tag: 'Materials', type: 'product', price: 15, pricingType: 'per_unit', unit: 'each', taxCategory: 'gst_free' },
        ];

        // Helper functions
        function getServices() {
            return tutoringServices;
        }
        

        function getPricingIcon(type) {
            const icons = {
                'per_hour': `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`,
                'per_sqm': `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 5a1 1 0 011-1h4a1 1 0 011 1v7a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM14 5a1 1 0 011-1h4a1 1 0 011 1v7a1 1 0 01-1 1h-4a1 1 0 01-1-1V5zM4 16a1 1 0 011-1h4a1 1 0 011 1v3a1 1 0 01-1 1H5a1 1 0 01-1-1v-3zM14 16a1 1 0 011-1h4a1 1 0 011 1v3a1 1 0 01-1 1h-4a1 1 0 01-1-1v-3z"></path></svg>`,
                'per_unit': `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path></svg>`,
                'fixed': `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`
            };
            return icons[type] || icons['fixed'];
        }

        function getTypeIndicator(type) {
            if (type === 'product') {
                return '<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800"> Product</span>';
            }
            return '<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800"> Service</span>';
        }

        // Tax rate lookup based on tax category
        function getTaxRate(taxCategory) {
            const taxRates = {
                'taxable_gst': 0.10,    // 10% GST
                'gst_free': 0.00,       // 0% GST-free
                'input_taxed': 0.00     // 0% Input-taxed (no GST on output, but special reporting)
            };
            return taxRates[taxCategory] || 0.10; // Default to 10% if category not found
        }

        function getTaxCategoryLabel(taxCategory) {
            const labels = {
                'taxable_gst': 'Taxable (10% GST)',
                'gst_free': 'GST-Free (0%)',
                'input_taxed': 'Input-Taxed (0%)'
            };
            return labels[taxCategory] || 'Standard (10%)';
        }

        // Calculate tax for each line item based on its tax category
        function calculateLineItemTax(item) {
            const taxRate = getTaxRate(item.taxCategory);
            const lineTotal = item.customPrice * item.quantity;
            return lineTotal * taxRate;
        }

        // Calculation functions
        function calculateSubtotal() {
            return state.quoteItems.reduce((sum, item) => {
                const lineTotal = item.customPrice * item.quantity;
                const discountAmount = item.discountType === 'percentage' 
                    ? lineTotal * (item.discount / 100)
                    : item.discount;
                return sum + (lineTotal - discountAmount);
            }, 0);
        }

        function calculateTax() {
            // Calculate tax per line item based on their tax categories
            return state.quoteItems.reduce((sum, item) => {
                return sum + calculateLineItemTax(item);
            }, 0);
        }

        function calculateTotal() {
            return calculateSubtotal() + calculateTax();
        }
        
        // Calculate total line item discounts
        function calculateLineItemDiscounts() {
            return state.quoteItems.reduce((sum, item) => {
                const lineTotal = item.customPrice * item.quantity;
                const discountAmount = item.discountType === 'percentage' 
                    ? lineTotal * (item.discount / 100)
                    : item.discount;
                return sum + discountAmount;
            }, 0);
        }
        
        // Calculate deposit amount
        function calculateDeposit() {
            if (!state.depositRequired) return 0;
            const total = calculateTotal();
            if (state.depositType === 'percentage') {
                return total * (state.depositValue / 100);
            }
            return Math.min(state.depositValue, total);
        }
        
        // Calculate balance due after deposit
        function calculateBalanceDue() {
            return calculateTotal() - calculateDeposit();
        }
        
        // Get tax breakdown by category
        function getTaxBreakdown() {
            const breakdown = {
                taxable_gst: 0,
                gst_free: 0,
                input_taxed: 0
            };
            
            state.quoteItems.forEach(item => {
                const taxAmount = calculateLineItemTax(item);
                if (item.taxCategory && breakdown.hasOwnProperty(item.taxCategory)) {
                    breakdown[item.taxCategory] += taxAmount;
                } else {
                    breakdown.taxable_gst += taxAmount; // Default
                }
            });
            
            return breakdown;
        }

        function updateSummary() {
            document.getElementById('subtotalAmount').textContent = `$${calculateSubtotal().toFixed(2)}`;
            
            // Update line item discounts display
            const lineItemDiscounts = calculateLineItemDiscounts();
            const lineItemDiscountSection = document.getElementById('lineItemDiscountSection');
            if (lineItemDiscounts > 0) {
                lineItemDiscountSection.classList.remove('hidden');
                document.getElementById('lineItemDiscountAmount').textContent = `-$${lineItemDiscounts.toFixed(2)}`;
            } else {
                lineItemDiscountSection.classList.add('hidden');
            }
            
            document.getElementById('totalAmount').textContent = `$${calculateTotal().toFixed(2)}`;

            // Calculate and display tax breakdown by category
            const taxBreakdown = getTaxBreakdown();
            const taxBreakdownContainer = document.getElementById('taxBreakdown');
            
            let taxBreakdownHTML = '';
            if (taxBreakdown.taxable_gst > 0) {
                taxBreakdownHTML += `<div class="flex justify-between"><span>GST (10%):</span><span>$${taxBreakdown.taxable_gst.toFixed(2)}</span></div>`;
            }
            if (taxBreakdown.gst_free > 0) {
                taxBreakdownHTML += `<div class="flex justify-between text-gray-500"><span>GST-Free:</span><span>$0.00</span></div>`;
            }
            if (taxBreakdown.input_taxed > 0) {
                taxBreakdownHTML += `<div class="flex justify-between text-gray-500"><span>Input-Taxed:</span><span>$0.00</span></div>`;
            }
            
            taxBreakdownContainer.innerHTML = taxBreakdownHTML || '<div class="text-gray-400">No taxable items</div>';
            
            // Total tax
            const totalTax = calculateTax();
            document.getElementById('taxAmount').textContent = `$${totalTax.toFixed(2)}`;

            // Update deposit display
            if (state.depositRequired) {
                document.getElementById('depositAmount').textContent = `$${calculateDeposit().toFixed(2)}`;
                document.getElementById('balanceDue').textContent = `$${calculateBalanceDue().toFixed(2)}`;
            }

            // Check approval requirement based on line item discounts
            const lineItemDiscountTotal = calculateLineItemDiscounts();
            const subtotal = calculateSubtotal();
            const discountPercent = subtotal > 0 ? (lineItemDiscountTotal / (subtotal + lineItemDiscountTotal)) * 100 : 0;
            state.approvalRequired = discountPercent > 20;
            
            const approvalWarning = document.getElementById('approvalWarning');
            if (approvalWarning) {
                approvalWarning.classList.toggle('hidden', !state.approvalRequired);
            }
            
            updateCreateButton();
        }

        function updateCreateButton() {
            const createBtn = document.getElementById('createQuoteBtn');
            const canCreate = state.quoteItems.length > 0 && state.selectedCustomer !== null;
            createBtn.disabled = !canCreate;
        }

        // Render functions
        function renderCustomerAutocomplete(searchTerm = '') {
            const autocomplete = document.getElementById('customerAutocomplete');
            const clearBtn = document.getElementById('clearSearchBtn');
            
            if (!searchTerm || searchTerm.length < 2) {
                autocomplete.classList.add('hidden');
                clearBtn.classList.add('hidden');
                return;
            }
            
            clearBtn.classList.remove('hidden');
            
            const filtered = customers.filter(c => 
                c.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                c.email.toLowerCase().includes(searchTerm.toLowerCase()) ||
                c.phone.includes(searchTerm)
            );

            if (filtered.length === 0) {
                autocomplete.innerHTML = `
                    <div class="p-3 text-sm text-gray-500 text-center">
                        No customers found. <button onclick="document.getElementById('toggleNewCustomerBtn').click()" class="text-blue-600 hover:underline">Create new customer</button>
                    </div>
                `;
                autocomplete.classList.remove('hidden');
                return;
            }

            autocomplete.innerHTML = filtered.map(customer => `
                <div 
                    class="p-3 hover:bg-blue-50 cursor-pointer border-b border-gray-100 last:border-b-0"
                    onclick="selectCustomer(${customer.id})"
                >
                    <div class="flex items-center justify-between">
                        <div class="flex-1">
                            <p class="font-medium text-gray-900 text-sm">${customer.name}</p>
                            <p class="text-xs text-gray-600 mt-0.5">${customer.email}</p>
                            <p class="text-xs text-gray-500">${customer.phone}</p>
                        </div>
                        ${customer.previousQuotes > 0 ? `
                            <span class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded">${customer.previousQuotes} quotes</span>
                        ` : ''}
                    </div>
                </div>
            `).join('');
            
            autocomplete.classList.remove('hidden');
        }

        function renderCatalogAutocomplete(searchTerm = '') {
            const autocomplete = document.getElementById('catalogAutocomplete');
            const clearBtn = document.getElementById('clearCatalogSearchBtn');
            
            if (!searchTerm || searchTerm.length < 2) {
                autocomplete.classList.add('hidden');
                clearBtn.classList.add('hidden');
                return;
            }
            
            clearBtn.classList.remove('hidden');
            
            const services = getServices().filter(service => 
                service.name.toLowerCase().includes(searchTerm.toLowerCase()) || 
                service.id.toLowerCase().includes(searchTerm.toLowerCase()) ||
                service.tag.toLowerCase().includes(searchTerm.toLowerCase())
            );

            if (services.length === 0) {
                autocomplete.innerHTML = `
                    <div class="p-3 text-sm text-gray-500 text-center">
                        No services or products found.
                    </div>
                `;
                autocomplete.classList.remove('hidden');
                return;
            }

            autocomplete.innerHTML = services.map(service => `
                <div 
                    class="p-3 hover:bg-blue-50 cursor-pointer border-b border-gray-100 last:border-b-0"
                    onclick="addQuoteItem('${service.id}')"
                >
                    <div class="flex items-center justify-between">
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-1">
                                ${getTypeIndicator(service.type)}
                                <span class="text-xs bg-gray-100 text-gray-700 px-2 py-0.5 rounded">${service.tag}</span>
                            </div>
                            <p class="font-medium text-gray-900 text-sm">${service.name}</p>
                            <p class="text-xs text-gray-500 mt-0.5">${service.id}</p>
                        </div>
                        <div class="text-right ml-3">
                            <div class="flex items-center gap-1 text-gray-700">
                                <span class="text-sm font-semibold">$${service.price}</span>
                                <span class="text-xs text-gray-500">/ ${service.unit}</span>
                            </div>
                            <div class="text-xs text-gray-500 mt-0.5">${getTaxCategoryLabel(service.taxCategory || 'taxable_gst')}</div>
                        </div>
                    </div>
                </div>
            `).join('');
            
            autocomplete.classList.remove('hidden');
        }

        function renderQuoteItems() {
            const emptyState = document.getElementById('emptyQuoteState');
            const container = document.getElementById('quoteItemsContainer');
            
            if (state.quoteItems.length === 0) {
                emptyState.classList.remove('hidden');
                container.classList.add('hidden');
                return;
            }
            
            emptyState.classList.add('hidden');
            container.classList.remove('hidden');
            
            container.innerHTML = state.quoteItems.map((item, index) => {
                // Show tax category
                let taxBadge = '';
                if (item.taxCategory) {
                    const taxLabels = {
                        'taxable_gst': '<span class="inline-flex items-center px-1.5 py-0.5 rounded text-xs bg-blue-50 text-blue-700"> GST (10%)</span>',
                        'gst_free': '<span class="inline-flex items-center px-1.5 py-0.5 rounded text-xs bg-gray-50 text-gray-600">GST-Free</span>',
                        'input_taxed': '<span class="inline-flex items-center px-1.5 py-0.5 rounded text-xs bg-gray-50 text-gray-600">Input-Taxed</span>'
                    };
                    taxBadge = taxLabels[item.taxCategory] || '';
                }
                
                const lineTotal = item.quantity * item.customPrice;
                const discountAmount = item.discountType === 'percentage' 
                    ? lineTotal * (item.discount / 100)
                    : item.discount;
                const lineTotalAfterDiscount = lineTotal - discountAmount;
                
                return `
                <div class="bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                    <!-- Header Row -->
                    <div class="flex items-start justify-between mb-3">
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-1">
                                <h3 class="font-semibold text-gray-900">${item.name}</h3>
                            </div>
                            <div class="flex items-center gap-2">
                                ${getTypeIndicator(item.type)}
                                ${taxBadge}
                            </div>
                            ${item.priceModificationComment ? `
                                <div class="mt-2 text-xs text-yellow-700 bg-yellow-50 px-2 py-1 rounded">
                                     ${item.priceModificationComment}
                                </div>
                            ` : ''}
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="text-right">
                                <div class="text-2xl font-bold text-gray-900">$${lineTotalAfterDiscount.toFixed(2)}</div>
                                ${item.discount > 0 ? `<div class="text-xs text-green-600">-$${discountAmount.toFixed(2)} discount</div>` : ''}
                            </div>
                            <button 
                                onclick="removeQuoteItem(${index})"
                                class="ml-2 p-2 text-red-600 hover:bg-red-50 rounded-lg transition-colors"
                                title="Remove item"
                            >
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Details Grid -->
                    <div class="grid grid-cols-12 gap-3 mb-3 pb-3 border-b border-gray-200">
                        <div class="col-span-3">
                            <label class="text-xs text-gray-500 block mb-1">${item.type === 'product' ? 'Delivery Date' : 'Service Date'} <span class="text-red-500">*</span></label>
                            <input 
                                type="date"
                                value="${item.serviceDate || ''}"
                                onchange="updateItemServiceDate(${index}, this.value)"
                                class="w-full px-2 py-1.5 border border-gray-300 rounded text-sm"
                            />
                        </div>
                        <div class="col-span-2">
                            <label class="text-xs text-gray-500 block mb-1">Quantity <span class="text-red-500">*</span></label>
                            <input 
                                type="number"
                                value="${item.quantity}"
                                onchange="updateItemQuantity(${index}, this.value)"
                                class="w-full px-2 py-1.5 border border-gray-300 rounded text-sm text-center"
                                min="1"
                            />
                        </div>
                        <div class="col-span-3">
                            <label class="text-xs text-gray-500 block mb-1">Unit Price</label>
                            <input 
                                type="number"
                                value="${item.customPrice}"
                                onchange="updateItemPrice(${index}, this.value)"
                                class="w-full px-2 py-1.5 border ${item.priceModified ? 'border-yellow-500 bg-yellow-50' : 'border-gray-300'} rounded text-sm text-right"
                                min="0"
                                step="0.01"
                            />
                            ${item.priceModified ? `<span class="text-xs text-yellow-600">Modified</span>` : ''}
                        </div>
                        <div class="col-span-4">
                            <label class="text-xs text-gray-500 block mb-1">Discount</label>
                            <div class="flex gap-2">
                                <select 
                                    onchange="updateItemDiscountType(${index}, this.value)"
                                    class="w-16 px-2 py-1.5 border border-gray-300 rounded text-sm"
                                >
                                    <option value="percentage" ${item.discountType === 'percentage' ? 'selected' : ''}>%</option>
                                    <option value="fixed" ${item.discountType === 'fixed' ? 'selected' : ''}>$</option>
                                </select>
                                <input 
                                    type="number"
                                    value="${item.discount || 0}"
                                    onchange="updateItemDiscount(${index}, this.value)"
                                    class="flex-1 px-2 py-1.5 border border-gray-300 rounded text-sm text-right"
                                    min="0"
                                    step="0.01"
                                />
                            </div>
                        </div>
                    </div>
                    
                    <!-- Notes Section -->
                    <div class="mb-3">
                        <label class="text-xs text-gray-500 block mb-1">Notes</label>
                        <textarea 
                            placeholder="${item.type === 'product' ? 'Delivery instructions, quantity details, etc...' : 'Service requirements, special instructions, etc...'}"
                            onchange="updateItemNotes(${index}, this.value)"
                            class="w-full px-3 py-2 border border-gray-300 rounded text-sm resize-none"
                            rows="2"
                        >${item.notes || ''}</textarea>
                    </div>
            `;
            }).join('');
        }

        // Event handlers
        function selectCustomer(customerId) {
            const customer = customers.find(c => c.id === customerId);
            state.selectedCustomer = customer;
            
            // Hide search, show selected card
            const searchInput = document.getElementById('customerSearchInput');
            searchInput.value = '';
            searchInput.classList.remove('border-red-300');
            searchInput.classList.add('border-green-500');
            document.getElementById('customerAutocomplete').classList.add('hidden');
            document.getElementById('clearSearchBtn').classList.add('hidden');
            document.getElementById('customerSearchSection').classList.add('hidden');
            document.getElementById('selectedCustomerCard').classList.remove('hidden');
            
            // Populate customer info
            document.getElementById('selectedCustomerName').textContent = customer.name;
            document.getElementById('selectedCustomerEmail').textContent = customer.email;
            document.getElementById('selectedCustomerPhone').textContent = customer.phone;
            
            // Setup quote contact selector if secondary contacts exist
            const contactSelector = document.getElementById('quoteContactSelector');
            const contactSelect = document.getElementById('quoteContactSelect');
            
            if (customer.secondaryContacts && customer.secondaryContacts.length > 0) {
                // Show contact selector
                contactSelector.classList.remove('hidden');
                
                // Build options: primary contact + secondary contacts
                let options = `<option value="primary">Primary: ${customer.name} (${customer.email})</option>`;
                customer.secondaryContacts.forEach((contact, index) => {
                    options += `<option value="secondary-${index}">${contact.name} - ${contact.role} (${contact.email})</option>`;
                });
                contactSelect.innerHTML = options;
                
                // Set default to primary
                state.selectedQuoteContact = {
                    type: 'primary',
                    name: customer.name,
                    email: customer.email,
                    phone: customer.phone
                };
            } else {
                // Hide contact selector, use primary by default
                contactSelector.classList.add('hidden');
                state.selectedQuoteContact = {
                    type: 'primary',
                    name: customer.name,
                    email: customer.email,
                    phone: customer.phone
                };
            }
            
            // Set service address (same as billing by default)
            document.getElementById('displayServiceAddress').textContent = customer.address || 'No address on file';
            document.getElementById('sameAsBilling').checked = true;
            document.getElementById('serviceAddressFields').classList.add('hidden');
            document.getElementById('serviceAddressDisplay').style.display = 'block';
            
            updateCreateButton();
        }

        function addQuoteItem(serviceId) {
            const services = getServices();
            const service = services.find(s => s.id === serviceId);
            
            if (!service) return;
            
            const newItem = {
                ...service,
                quantity: 1,
                customPrice: service.price,
                originalPrice: service.price,
                priceModified: false,
                priceModificationComment: '',
                notes: '',
                serviceDate: '',
                discount: 0,
                discountType: 'percentage',
                // Schedule fields (only for services)
                preferredTime: '',
                exactTime: '',
                scheduleNotes: ''
            };
            
            state.quoteItems.push(newItem);
            renderQuoteItems();
            updateSummary();
            
            // Clear catalog search after adding
            document.getElementById('catalogSearchInput').value = '';
            document.getElementById('catalogAutocomplete').classList.add('hidden');
            document.getElementById('clearCatalogSearchBtn').classList.add('hidden');
        }

        function removeQuoteItem(index) {
            state.quoteItems.splice(index, 1);
            renderQuoteItems();
            updateSummary();
        }

        function updateItemQuantity(index, value) {
            state.quoteItems[index].quantity = Number(value);
            renderQuoteItems();
            updateSummary();
        }

        function updateItemServiceDate(index, value) {
            state.quoteItems[index].serviceDate = value;
            renderQuoteItems();
        }

        function updateItemNotes(index, value) {
            state.quoteItems[index].notes = value;
        }

        function updateItemDiscount(index, value) {
            state.quoteItems[index].discount = Number(value);
            renderQuoteItems();
            updateSummary();
        }

        function updateItemDiscountType(index, value) {
            state.quoteItems[index].discountType = value;
            renderQuoteItems();
            updateSummary();
        }

        function updateItemPreferredTime(index, value) {
            state.quoteItems[index].preferredTime = value;
            renderQuoteItems();
        }

        function updateItemExactTime(index, value) {
            state.quoteItems[index].exactTime = value;
        }

        function updateItemScheduleNotes(index, value) {
            state.quoteItems[index].scheduleNotes = value;
        }

        function showPriceModModal(index, newPrice) {
            const item = state.quoteItems[index];
            state.currentPriceModIndex = index;
            state.currentPriceModNewValue = newPrice;
            
            // Populate modal with item details
            document.getElementById('priceModItemName').textContent = item.name;
            
            // Set item type badge
            const typeBadge = document.getElementById('priceModItemType');
            if (item.type === 'product') {
                typeBadge.innerHTML = '<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800"> Product</span>';
            } else {
                typeBadge.innerHTML = '<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800"> Service</span>';
            }
            
            document.getElementById('priceModOriginal').textContent = `$${item.originalPrice.toFixed(2)}`;
            document.getElementById('priceModNew').textContent = `$${Number(newPrice).toFixed(2)}`;
            document.getElementById('priceModComment').value = '';
            
            // Show modal
            document.getElementById('priceModModal').classList.remove('hidden');
        }

        function hidePriceModModal() {
            document.getElementById('priceModModal').classList.add('hidden');
            state.currentPriceModIndex = null;
            state.currentPriceModNewValue = null;
            document.getElementById('priceModComment').value = '';
        }

        function updateItemPrice(index, value) {
            const item = state.quoteItems[index];
            const newPrice = Number(value);
            const originalPrice = item.price;
            
            // Check if price is being modified from original
            if (newPrice !== originalPrice && !item.priceModified) {
                // Show modal to get reason
                showPriceModModal(index, newPrice);
                return;
            }
            
            item.customPrice = newPrice;
            renderQuoteItems();
            updateSummary();
        }

        function confirmPriceModification() {
            const comment = document.getElementById('priceModComment').value.trim();
            
            if (!comment) {
                alert('Please provide a reason for the price modification');
                return;
            }
            
            if (state.currentPriceModIndex !== null) {
                const item = state.quoteItems[state.currentPriceModIndex];
                item.priceModified = true;
                item.priceModificationComment = comment;
                item.customPrice = state.currentPriceModNewValue;
                
                renderQuoteItems();
                updateSummary();
                hidePriceModModal();
            }
        }

        function cancelPriceModification() {
            if (state.currentPriceModIndex !== null) {
                // Revert to original price
                const item = state.quoteItems[state.currentPriceModIndex];
                item.customPrice = item.originalPrice;
                
                renderQuoteItems();
                updateSummary();
                hidePriceModModal();
            }
        }

        function updateItemNotes(index, value) {
            state.quoteItems[index].notes = value;
        }

        // Preview function
        function showPreview() {
            if (!state.selectedCustomer || state.quoteItems.length === 0) {
                alert('Please select a customer and add items to the quote first.');
                return;
            }

            const validUntil = document.getElementById('validUntilDate').value;
            const customerNotes = document.getElementById('customerNotes').value;
            const internalNotes = document.getElementById('internalNotes').value;

            // Get current date
            const currentDate = new Date().toLocaleDateString('en-AU', { day: 'numeric', month: 'long', year: 'numeric' });
            
            // Build line items HTML
            const lineItemsHTML = state.quoteItems.map(item => `
                <tr class="border-b border-gray-200">
                    <td class="py-2 px-1" style="width: 35%;">
                        <div class="font-medium text-gray-900">${item.name}</div>
                        <div class="text-xs text-gray-600 mt-1">${item.id}</div>
                        ${item.notes ? `<div class="text-xs text-gray-500 italic mt-1">${item.notes}</div>` : ''}
                    </td>
                    <td class="py-2 px-1 text-center text-gray-700">${item.quantity} ${item.unit}</td>
                    <td class="py-2 px-1 text-right text-gray-700">$${item.customPrice.toFixed(2)}</td>
                    <td class="py-2 px-1 text-right font-medium">$${(item.customPrice * item.quantity).toFixed(2)}</td>
                </tr>
            `).join('');

            // Format tax breakdown
            const taxBreakdown = getTaxBreakdown();
            const taxBreakdownHTML = `
                ${taxBreakdown.taxable_gst > 0 ? `<div class="flex justify-between text-sm py-1"><span>GST (10%):</span><span>$${taxBreakdown.taxable_gst.toFixed(2)}</span></div>` : ''}
                ${taxBreakdown.gst_free > 0 ? `<div class="flex justify-between text-xs text-gray-500 py-1"><span>GST-Free Items:</span><span>$${state.quoteItems.filter(i => i.taxCategory === 'gst_free').reduce((sum, i) => sum + i.customPrice * i.quantity, 0).toFixed(2)}</span></div>` : ''}
                ${taxBreakdown.input_taxed > 0 ? `<div class="flex justify-between text-xs text-gray-500 py-1"><span>Input-Taxed Items:</span><span>$${state.quoteItems.filter(i => i.taxCategory === 'input_taxed').reduce((sum, i) => sum + i.customPrice * i.quantity, 0).toFixed(2)}</span></div>` : ''}
            `;

            // Build preview HTML
            const previewHTML = `
                <!-- Company Header -->
                <div class="border-b-2 border-gray-800 pb-4 mb-6">
                    <div class="flex items-center justify-between mb-4">
                        <div>
                            <h1 class="text-3xl font-bold text-gray-900 mb-1">SUNSHINE TUTORING</h1>
                            <p class="text-sm text-gray-600">Tutoring Excellence Since 2015</p>
                        </div>
                        <div class="text-right">
                            <p class="text-lg font-bold">QUOTE</p>
                            <p class="text-sm text-gray-600">Date: ${currentDate}</p>
                        </div>
                    </div>
                </div>

                <!-- Customer Details -->
                <div class="grid grid-cols-2 gap-6 mb-6">
                    <div>
                        <h3 class="font-semibold text-gray-900 mb-2 text-sm uppercase tracking-wide">Bill To:</h3>
                        <div class="text-sm text-gray-700">
                            <p class="font-medium">${state.selectedCustomer.name}</p>
                            ${state.selectedCustomer.company ? `<p>${state.selectedCustomer.company}</p>` : ''}
                            <p>${state.selectedCustomer.email}</p>
                            <p>${state.selectedCustomer.phone}</p>
                            ${state.selectedCustomer.address ? `<p class="mt-2">${state.selectedCustomer.address}</p>` : ''}
                        </div>
                    </div>
                    <div>
                        <h3 class="font-semibold text-gray-900 mb-2 text-sm uppercase tracking-wide">Quote Details:</h3>
                        <div class="text-sm text-gray-700">
                            <p><span class="font-medium">Quote ID:</span> Q-2024-001</p>
                            <p><span class="font-medium">Valid Until:</span> ${validUntil ? new Date(validUntil).toLocaleDateString('en-AU', { day: 'numeric', month: 'long', year: 'numeric' }) : 'N/A'}</p>
                            <p class="mt-2 text-xs text-gray-500">Melbourne East Branch</p>
                        </div>
                    </div>
                </div>

                <!-- Line Items Table -->
                <div class="mb-6">
                    <table class="w-full text-sm" style="min-width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr class="bg-gray-100 border-b-2 border-gray-800">
                                <th class="text-left py-2 px-1 font-semibold text-gray-900" style="width: 35%;">Description</th>
                                <th class="text-center py-2 px-1 font-semibold text-gray-900" style="width: 20%;">Quantity</th>
                                <th class="text-right py-2 px-1 font-semibold text-gray-900" style="width: 20%;">Unit Price</th>
                                <th class="text-right py-2 px-1 font-semibold text-gray-900" style="width: 25%;">Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${lineItemsHTML}
                        </tbody>
                    </table>
                </div>

                <!-- Summary -->
                <div class="flex justify-end mb-6">
                    <div class="w-64">
                        <div class="border-t border-gray-300 pt-3">
                            <div class="flex justify-between text-sm py-1">
                                <span class="text-gray-700">Subtotal:</span>
                                <span class="font-medium">$${calculateSubtotal().toFixed(2)}</span>
                            </div>
                            ${calculateLineItemDiscounts() > 0 ? `
                                <div class="flex justify-between text-sm py-1">
                                    <span class="text-gray-700">Line Item Discounts:</span>
                                    <span class="text-red-600">-$${calculateLineItemDiscounts().toFixed(2)}</span>
                                </div>
                            ` : ''}
                            <div class="border-t border-gray-300 mt-2 pt-2">
                                ${taxBreakdownHTML}
                                <div class="flex justify-between items-center mt-2 pt-2 border-t border-gray-800">
                                    <span class="text-sm font-semibold">Total Tax:</span>
                                    <span class="text-sm font-semibold">$${calculateTax().toFixed(2)}</span>
                                </div>
                            </div>
                            <div class="border-t-2 border-gray-800 mt-2 pt-2">
                                <div class="flex justify-between">
                                    <span class="text-lg font-bold text-gray-900">TOTAL:</span>
                                    <span class="text-lg font-bold text-gray-900">$${calculateTotal().toFixed(2)}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Notes -->
                ${customerNotes ? `
                    <div class="border-t border-gray-300 pt-4 mb-4">
                        <h4 class="font-semibold text-gray-900 mb-2 text-sm uppercase tracking-wide">Notes:</h4>
                        <p class="text-sm text-gray-700 whitespace-pre-wrap">${customerNotes}</p>
                    </div>
                ` : ''}

                <!-- Footer -->
                <div class="border-t-2 border-gray-800 pt-4 mt-6">
                    <div class="grid grid-cols-2 gap-6 text-xs text-gray-600">
                        <div>
                            <p class="font-semibold text-gray-900 mb-1">Sunshine Tutoring - Melbourne East</p>
                            <p>123 Education Street, Melbourne VIC 3000</p>
                            <p>Phone: (03) 1234 5678</p>
                            <p>Email: melbourne@sunshinetutoring.com.au</p>
                        </div>
                        <div>
                            <p class="font-semibold text-gray-900 mb-1">Payment Information</p>
                            <p>ABN: 12 345 678 901</p>
                            <p>Valid for 30 days from date of issue</p>
                            <p class="mt-2 text-gray-500">Terms and conditions apply</p>
                        </div>
                    </div>
                </div>

                ${internalNotes ? `
                    <div class="mt-6 pt-4 border-t-2 border-dashed border-red-300 bg-red-50 p-3 rounded">
                        <p class="text-xs font-semibold text-red-700 mb-1">INTERNAL NOTES (Not visible to customer):</p>
                        <p class="text-xs text-red-600 whitespace-pre-wrap">${internalNotes}</p>
                    </div>
                ` : ''}
            `;

            document.getElementById('previewContent').innerHTML = previewHTML;
            document.getElementById('previewModal').classList.remove('hidden');
        }

        function hidePreview() {
            document.getElementById('previewModal').classList.add('hidden');
        }

        function downloadPreviewPDF() {
            alert('PDF download functionality would be implemented here');
            // In a real implementation, this would generate and download a PDF
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // EDIT MODE: Load existing quote data
            // Set quote ID and status in header
            document.getElementById('quoteIdBadge').textContent = existingQuote.id;
            const statusBadge = document.getElementById('quoteStatusBadge');
            const statusMap = {
                'draft': { class: 'bg-yellow-100 text-yellow-700', text: ' Draft' },
                'sent': { class: 'bg-blue-100 text-blue-700', text: ' Sent' },
                'approved': { class: 'bg-green-100 text-green-700', text: ' Approved' },
                'rejected': { class: 'bg-red-100 text-red-700', text: ' Rejected' }
            };
            const statusInfo = statusMap[existingQuote.status] || statusMap['draft'];
            statusBadge.className = `px-2 py-1 text-xs rounded ${statusInfo.class}`;
            statusBadge.textContent = statusInfo.text;
            
            // Set valid until date from existing quote
            document.getElementById('validUntilDate').value = existingQuote.validUntil;
            
            // Set notes from existing quote
            document.getElementById('customerNotes').value = existingQuote.customerNotes;
            document.getElementById('internalNotes').value = existingQuote.internalNotes;
            
            // EDIT MODE: Populate customer data (customer card is always visible)
            if (state.selectedCustomer) {
                document.getElementById('selectedCustomerName').textContent = state.selectedCustomer.name;
                document.getElementById('selectedCustomerEmail').textContent = state.selectedCustomer.email;
                document.getElementById('selectedCustomerPhone').textContent = state.selectedCustomer.phone;
                document.getElementById('displayServiceAddress').textContent = state.selectedCustomer.address;
                
                // Setup quote contact selector if secondary contacts exist
                const contactSelector = document.getElementById('quoteContactSelector');
                const contactSelect = document.getElementById('quoteContactSelect');
                
                if (state.selectedCustomer.secondaryContacts && state.selectedCustomer.secondaryContacts.length > 0) {
                    contactSelector.classList.remove('hidden');
                    let options = `<option value="primary">Primary: ${state.selectedCustomer.name} (${state.selectedCustomer.email})</option>`;
                    state.selectedCustomer.secondaryContacts.forEach((contact, index) => {
                        options += `<option value="secondary-${index}">${contact.name} - ${contact.role} (${contact.email})</option>`;
                    });
                    contactSelect.innerHTML = options;
                }
            }
            
            // Render existing quote items
            renderQuoteItems();
            updateSummary();
            
            // Catalog search autocomplete
            document.getElementById('catalogSearchInput').addEventListener('input', function(e) {
                renderCatalogAutocomplete(e.target.value);
            });
            
            // Clear catalog search button
            document.getElementById('clearCatalogSearchBtn').addEventListener('click', function() {
                document.getElementById('catalogSearchInput').value = '';
                document.getElementById('catalogAutocomplete').classList.add('hidden');
                document.getElementById('clearCatalogSearchBtn').classList.add('hidden');
            });
            
            // Close catalog autocomplete when clicking outside
            document.addEventListener('click', function(e) {
                const catalogSearch = document.getElementById('catalogSearchInput');
                const autocomplete = document.getElementById('catalogAutocomplete');
                if (catalogSearch && !catalogSearch.parentElement.contains(e.target)) {
                    autocomplete.classList.add('hidden');
                }
            });
            
            // EDIT MODE: Customer management disabled - customer is locked to existing quote
            
            // Quote contact selector change
            document.getElementById('quoteContactSelect').addEventListener('change', function(e) {
                const value = e.target.value;
                const customer = state.selectedCustomer;
                
                if (value === 'primary') {
                    state.selectedQuoteContact = {
                        type: 'primary',
                        name: customer.name,
                        email: customer.email,
                        phone: customer.phone
                    };
                } else if (value.startsWith('secondary-')) {
                    const index = parseInt(value.split('-')[1]);
                    const contact = customer.secondaryContacts[index];
                    state.selectedQuoteContact = {
                        type: 'secondary',
                        name: contact.name,
                        email: contact.email,
                        phone: contact.phone,
                        role: contact.role
                    };
                }
                
                console.log('Quote contact changed:', state.selectedQuoteContact);
            });
            
            // Service address toggle
            document.getElementById('sameAsBilling').addEventListener('change', function(e) {
                const isChecked = e.target.checked;
                document.getElementById('serviceAddressFields').classList.toggle('hidden', isChecked);
                document.getElementById('serviceAddressDisplay').style.display = isChecked ? 'block' : 'none';
                
                if (!isChecked) {
                    // Clear custom address fields
                    document.getElementById('serviceStreet').value = '';
                    document.getElementById('serviceAddressNotes').value = '';
                }
            });
            
            // Deposit changes
            document.getElementById('requireDeposit').addEventListener('change', function(e) {
                state.depositRequired = e.target.checked;
                document.getElementById('depositSection').classList.toggle('hidden', !e.target.checked);
                updateSummary();
            });
            
            document.getElementById('depositType').addEventListener('change', function(e) {
                state.depositType = e.target.value;
                document.getElementById('depositValue').step = e.target.value === 'percentage' ? '1' : '0.01';
                updateSummary();
            });
            
            document.getElementById('depositValue').addEventListener('input', function(e) {
                state.depositValue = Number(e.target.value);
                updateSummary();
            });
            
            // Create quote button
            document.getElementById('createQuoteBtn').addEventListener('click', function() {
                if (!state.selectedCustomer) {
                    alert('Please select a customer');
                    return;
                }
                
                if (state.quoteItems.length === 0) {
                    alert('Please add at least one item to the quote');
                    return;
                }
                
                // Check for price modifications
                const priceModifiedItems = state.quoteItems.filter(item => item.priceModified);
                if (priceModifiedItems.length > 0) {
                    console.log('Price modifications:', 
                        priceModifiedItems.map(item => ({
                            name: item.name,
                            originalPrice: item.originalPrice,
                            modifiedPrice: item.customPrice,
                            comment: item.priceModificationComment
                        }))
                    );
                }
                
                // Create quote data
                const quoteData = {
                    customer: state.selectedCustomer,
                    quoteContact: state.selectedQuoteContact, // Contact who will receive the quote
                    items: state.quoteItems,
                    subtotal: calculateSubtotal(),
                    tax: calculateTax(),
                    total: calculateTotal(),
                    validUntil: document.getElementById('validUntilDate').value,
                    customerNotes: document.getElementById('customerNotes').value,
                    internalNotes: document.getElementById('internalNotes').value,
                    priceModifications: priceModifiedItems.map(item => ({
                        name: item.name,
                        originalPrice: item.originalPrice,
                        modifiedPrice: item.customPrice,
                        comment: item.priceModificationComment
                    })),
                    status: 'active',
                    createdDate: new Date().toISOString()
                };
                
                // Here you would normally send the quote data to the server
                console.log('Creating quote:', quoteData);
                
                const contactName = state.selectedQuoteContact.type === 'secondary' 
                    ? `${state.selectedQuoteContact.name} (${state.selectedQuoteContact.role})` 
                    : state.selectedCustomer.name;
                alert(`Quote created successfully for ${state.selectedCustomer.name}!\nQuote will be sent to: ${contactName}`);
                // In real implementation: redirect to quotes list or quote detail page
                // window.location.href = 'quotes.html';
            });
            
            // Save draft button
            document.getElementById('saveDraftBtn').addEventListener('click', function() {
                // Create draft quote data
                const draftData = {
                    customer: state.selectedCustomer,
                    quoteContact: state.selectedQuoteContact, // Contact who will receive the quote
                    items: state.quoteItems,
                    subtotal: calculateSubtotal(),
                    tax: calculateTax(),
                    total: calculateTotal(),
                    validUntil: document.getElementById('validUntilDate').value,
                    customerNotes: document.getElementById('customerNotes').value,
                    internalNotes: document.getElementById('internalNotes').value,
                    status: 'draft',
                    createdDate: new Date().toISOString()
                };
                
                // Here you would normally save the draft to the server
                console.log('Saving draft:', draftData);
                
                alert('Quote saved as draft!');
                // In real implementation: redirect to quotes list
                // window.location.href = 'quotes.html';
            });
            
            // Preview button
            document.getElementById('previewBtn').addEventListener('click', showPreview);
            
            // Preview modal buttons
            document.getElementById('closePreviewBtn').addEventListener('click', hidePreview);
            document.getElementById('downloadPreviewBtn').addEventListener('click', downloadPreviewPDF);
            
            // Invoice preview modal buttons
            document.getElementById('closeInvoicePreviewBtn').addEventListener('click', hideInvoicePreview);
            document.getElementById('createAllInvoicesBtn').addEventListener('click', createAllInvoicesFromPreview);
            
            // Price modification modal event listeners
            document.getElementById('closePriceModModal').addEventListener('click', cancelPriceModification);
            document.getElementById('cancelPriceModBtn').addEventListener('click', cancelPriceModification);
            document.getElementById('savePriceModBtn').addEventListener('click', confirmPriceModification);
            
            // Close modal on background click
            document.getElementById('priceModModal').addEventListener('click', function(e) {
                if (e.target.id === 'priceModModal') {
                    cancelPriceModification();
                }
            });
            
            // Close modal on Escape key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && !document.getElementById('priceModModal').classList.contains('hidden')) {
                    cancelPriceModification();
                }
            });

            // Payment configuration event listeners
            document.getElementById('savePaymentConfigBtn').addEventListener('click', savePaymentConfiguration);
            document.getElementById('defaultPaymentTerms').addEventListener('change', updatePaymentTermsDisplay);
            
            // Payment method checkboxes
            document.querySelectorAll('#paymentMethodsContainer input[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('change', updatePaymentMethodsDisplay);
            });
            
            // Subscription date changes
            document.getElementById('subscriptionStartDate').addEventListener('change', calculateNextInvoiceDate);
            document.getElementById('billingFrequency').addEventListener('change', calculateNextInvoiceDate);
            
            // Initialize payment configuration displays
            updatePaymentModel();
            updatePaymentTermsDisplay();
            updatePaymentMethodsDisplay();

            // Initialize invoice management
            loadInvoices();
            updateInvoiceSummary();

            // Initialize split invoice functionality
            initializeSplitInvoice();

            // Initial render
            renderQuoteItems();
            updateSummary();
        });

        // Create Invoice from Quote
        function createInvoiceFromQuote() {
            // Get current quote ID (in real app, get from URL or data)
            const quoteId = document.getElementById('quoteIdBadge').textContent;
            
            // Validate quote status
            const quoteStatus = document.getElementById('quoteStatusBadge').textContent.toLowerCase();
            
            if (quoteStatus === 'draft') {
                if (!confirm('This quote is still in draft status. Do you want to create an invoice anyway?')) {
                    return;
                }
            }
            
            // Navigate to invoice creation page with quote ID
            window.location.href = `invoice_create_simple.html?quoteId=${quoteId}`;
        }

        // ============================================================================
        // TAB SWITCHING FUNCTIONALITY
        // ============================================================================

        function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            // Remove active class from all tab buttons
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active', 'border-blue-500', 'text-blue-600');
                button.classList.add('border-transparent', 'text-gray-500');
            });
            
            // Show selected tab content
            document.getElementById(tabName + 'Content').classList.remove('hidden');
            
            // Add active class to selected tab button
            const activeButton = document.getElementById(tabName + 'Tab');
            activeButton.classList.add('active', 'border-blue-500', 'text-blue-600');
            activeButton.classList.remove('border-transparent', 'text-gray-500');
        }

        // ============================================================================
        // PAYMENT CONFIGURATION FUNCTIONALITY
        // ============================================================================

        // Payment method constraints based on payment model
        const paymentMethodConstraints = {
            full: {
                allowed: ['stripe', 'paypal', 'google_wallet', 'apple_pay', 'cash'],
                hint: 'All payment methods available for full payment'
            },
            deposit: {
                allowed: ['stripe', 'paypal', 'cash'],
                hint: 'Deposit payments support Stripe, PayPal, and Cash only',
                reason: 'Digital wallets not supported for deposit payments'
            },
            subscription: {
                allowed: ['stripe', 'paypal'],
                required: true,
                hint: 'Subscription requires auto-charge capable methods (Stripe or PayPal)',
                reason: 'Only Stripe and PayPal support recurring automatic charges'
            }
        };

        // Payment model functions
        function updatePaymentModel() {
            const model = document.querySelector('input[name="paymentModel"]:checked').value;
            const depositSection = document.getElementById('depositSection');
            const subscriptionSection = document.getElementById('subscriptionSection');
            const depositInfo = document.getElementById('depositInfo');
            const paymentModelDisplay = document.getElementById('paymentModelDisplay');
            
            // Hide all sections first
            depositSection.classList.add('hidden');
            subscriptionSection.classList.add('hidden');
            depositInfo.classList.add('hidden');
            
            if (model === 'deposit') {
                depositSection.classList.remove('hidden');
                depositInfo.classList.remove('hidden');
                paymentModelDisplay.textContent = 'Down Payment';
            } else if (model === 'subscription') {
                subscriptionSection.classList.remove('hidden');
                paymentModelDisplay.textContent = 'Subscription';
                // Set default subscription start date to today
                document.getElementById('subscriptionStartDate').value = new Date().toISOString().split('T')[0];
                calculateNextInvoiceDate();
            } else {
                paymentModelDisplay.textContent = 'Full Payment';
            }
            
            // Update payment method constraints
            updatePaymentMethodConstraints(model);
            updatePaymentMethodsDisplay();
            
            // Update invoice tab summary
            const invoiceModelDisplay = document.getElementById('invoicePaymentModel');
            const invoiceDepositInfo = document.getElementById('invoiceDepositInfo');
            const invoiceDepositAmount = document.getElementById('invoiceDepositAmount');
            
            if (invoiceModelDisplay) {
                if (model === 'deposit') {
                    invoiceModelDisplay.textContent = 'Down Payment';
                    if (invoiceDepositInfo) {
                        invoiceDepositInfo.classList.remove('hidden');
                        const depositAmount = parseFloat(document.getElementById('depositAmount')?.value) || 0;
                        if (invoiceDepositAmount) {
                            invoiceDepositAmount.textContent = `$${depositAmount.toFixed(2)}`;
                        }
                    }
                } else if (model === 'subscription') {
                    invoiceModelDisplay.textContent = 'Subscription';
                    if (invoiceDepositInfo) {
                        invoiceDepositInfo.classList.add('hidden');
                    }
                } else {
                    invoiceModelDisplay.textContent = 'Full Payment';
                    if (invoiceDepositInfo) {
                        invoiceDepositInfo.classList.add('hidden');
                    }
                }
            }
        }

        function updatePaymentMethodConstraints(model) {
            const constraints = paymentMethodConstraints[model];
            const allMethods = ['stripe', 'paypal', 'google_wallet', 'apple_pay', 'cash'];
            const hintElement = document.getElementById('paymentMethodHint');
            
            // Update hint text
            hintElement.textContent = constraints.hint;
            if (constraints.reason) {
                hintElement.textContent += ` (${constraints.reason})`;
            }
            
            // Update each payment method
            allMethods.forEach(method => {
                const checkbox = document.getElementById(`payment${method.split('_').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join('')}`);
                const label = checkbox.closest('label');
                const tag = document.getElementById(`${method.replace('_', '')}Tag`);
                
                if (constraints.allowed.includes(method)) {
                    // Enable method
                    checkbox.disabled = false;
                    label.classList.remove('opacity-50', 'cursor-not-allowed');
                    label.classList.add('cursor-pointer', 'hover:bg-gray-50');
                    
                    // Add tag for subscription required methods
                    if (model === 'subscription' && tag) {
                        tag.textContent = 'Required for auto-charge';
                    } else if (tag) {
                        tag.textContent = '';
                    }
                } else {
                    // Disable method
                    checkbox.disabled = true;
                    checkbox.checked = false;
                    label.classList.add('opacity-50', 'cursor-not-allowed');
                    label.classList.remove('cursor-pointer', 'hover:bg-gray-50');
                    
                    if (tag) {
                        tag.textContent = '';
                    }
                }
            });
            
            // For subscription, ensure at least one allowed method is checked
            if (model === 'subscription') {
                const stripeChecked = document.getElementById('paymentStripe').checked;
                const paypalChecked = document.getElementById('paymentPaypal').checked;
                
                if (!stripeChecked && !paypalChecked) {
                    document.getElementById('paymentStripe').checked = true;
                }
            }
        }

        function toggleEndDate() {
            const endType = document.getElementById('subscriptionEnd').value;
            const cyclesInput = document.getElementById('cyclesInput');
            const endDateInput = document.getElementById('endDateInput');
            
            cyclesInput.classList.add('hidden');
            endDateInput.classList.add('hidden');
            
            if (endType === 'after_cycles') {
                cyclesInput.classList.remove('hidden');
            } else if (endType === 'end_date') {
                endDateInput.classList.remove('hidden');
            }
            
            calculateNextInvoiceDate();
        }

        function calculateNextInvoiceDate() {
            const startDate = new Date(document.getElementById('subscriptionStartDate').value);
            const frequency = document.getElementById('billingFrequency').value;
            
            if (!startDate || isNaN(startDate)) {
                document.getElementById('nextInvoiceDate').textContent = '-';
                return;
            }
            
            const nextDate = new Date(startDate);
            
            switch(frequency) {
                case 'weekly':
                    nextDate.setDate(nextDate.getDate() + 7);
                    break;
                case 'biweekly':
                    nextDate.setDate(nextDate.getDate() + 14);
                    break;
                case 'monthly':
                    nextDate.setMonth(nextDate.getMonth() + 1);
                    break;
                case 'quarterly':
                    nextDate.setMonth(nextDate.getMonth() + 3);
                    break;
                case 'yearly':
                    nextDate.setFullYear(nextDate.getFullYear() + 1);
                    break;
            }
            
            document.getElementById('nextInvoiceDate').textContent = nextDate.toLocaleDateString();
        }

        function updateDepositCalculation() {
            const depositAmount = parseFloat(document.getElementById('depositAmount').value) || 0;
            const total = calculateTotal();
            const percentage = (depositAmount / total * 100).toFixed(0);
            const remaining = total - depositAmount;
            
            document.getElementById('depositPercentage').value = percentage;
            document.getElementById('remainingBalance').textContent = `$${remaining.toFixed(2)}`;
            document.getElementById('depositAmountDisplay').textContent = `$${depositAmount.toFixed(2)}`;
            document.getElementById('remainingBalanceDisplay').textContent = `$${remaining.toFixed(2)}`;
            
            // Update invoice tab summary
            const invoiceDepositAmount = document.getElementById('invoiceDepositAmount');
            if (invoiceDepositAmount) {
                invoiceDepositAmount.textContent = `$${depositAmount.toFixed(2)}`;
            }
        }

        function updateDepositFromPercentage() {
            const percentage = parseFloat(document.getElementById('depositPercentage').value) || 0;
            const total = calculateTotal();
            const depositAmount = (total * percentage / 100);
            const remaining = total - depositAmount;
            
            document.getElementById('depositAmount').value = depositAmount.toFixed(2);
            document.getElementById('remainingBalance').textContent = `$${remaining.toFixed(2)}`;
            document.getElementById('depositAmountDisplay').textContent = `$${depositAmount.toFixed(2)}`;
            document.getElementById('remainingBalanceDisplay').textContent = `$${remaining.toFixed(2)}`;
            
            // Update invoice tab summary
            const invoiceDepositAmount = document.getElementById('invoiceDepositAmount');
            if (invoiceDepositAmount) {
                invoiceDepositAmount.textContent = `$${depositAmount.toFixed(2)}`;
            }
        }

        function setDepositPercentage(percent) {
            document.getElementById('depositPercentage').value = percent;
            updateDepositFromPercentage();
        }

        function updatePaymentTermsDisplay() {
            const terms = document.getElementById('defaultPaymentTerms').value;
            const display = document.getElementById('paymentTermsDisplay');
            
            const termsMap = {
                'due_on_receipt': 'Due on Receipt',
                'net_7': 'Net 7 Days',
                'net_15': 'Net 15 Days',
                'net_30': 'Net 30 Days',
                'net_60': 'Net 60 Days'
            };
            
            const termsText = termsMap[terms] || 'Net 30 Days';
            display.textContent = termsText;
            
            // Update invoice tab summary
            const invoiceTermsDisplay = document.getElementById('invoicePaymentTerms');
            if (invoiceTermsDisplay) {
                invoiceTermsDisplay.textContent = termsText;
            }
        }

        function updatePaymentMethodsDisplay() {
            const checkboxes = document.querySelectorAll('#paymentMethodsContainer input[type="checkbox"]:checked');
            const count = checkboxes.length;
            document.getElementById('paymentMethodsDisplay').textContent = `${count} selected`;
            
            // Update invoice tab summary
            const invoiceMethodsDisplay = document.getElementById('invoicePaymentMethods');
            if (invoiceMethodsDisplay) {
                invoiceMethodsDisplay.textContent = `${count} selected`;
            }
        }

        function savePaymentConfiguration() {
            const paymentModel = document.querySelector('input[name="paymentModel"]:checked').value;
            const paymentMethods = [];
            
            // Collect selected payment methods
            if (document.getElementById('paymentStripe').checked) paymentMethods.push('stripe');
            if (document.getElementById('paymentPaypal').checked) paymentMethods.push('paypal');
            if (document.getElementById('paymentGoogleWallet').checked) paymentMethods.push('google_wallet');
            if (document.getElementById('paymentApplePay').checked) paymentMethods.push('apple_pay');
            if (document.getElementById('paymentCash').checked) paymentMethods.push('cash');
            
            if (paymentMethods.length === 0) {
                alert('Please select at least one payment method');
                return;
            }
            
            const paymentConfig = {
                paymentModel: paymentModel,
                paymentMethods: paymentMethods,
                paymentTerms: document.getElementById('defaultPaymentTerms').value,
                paymentInstructions: document.getElementById('paymentInstructions').value
            };
            
            // Add subscription data if applicable
            if (paymentModel === 'subscription') {
                const startDate = document.getElementById('subscriptionStartDate').value;
                if (!startDate) {
                    alert('Please select a subscription start date');
                    return;
                }
                
                paymentConfig.subscription = {
                    frequency: document.getElementById('billingFrequency').value,
                    startDate: startDate,
                    endType: document.getElementById('subscriptionEnd').value,
                    autoCharge: document.getElementById('autoCharge').checked
                };
                
                const endType = document.getElementById('subscriptionEnd').value;
                if (endType === 'after_cycles') {
                    const cycles = parseInt(document.getElementById('billingCycles').value);
                    if (!cycles || cycles <= 0) {
                        alert('Please enter a valid number of billing cycles');
                        return;
                    }
                    paymentConfig.subscription.billingCycles = cycles;
                } else if (endType === 'end_date') {
                    const endDate = document.getElementById('subscriptionEndDate').value;
                    if (!endDate) {
                        alert('Please select a subscription end date');
                        return;
                    }
                    paymentConfig.subscription.endDate = endDate;
                }
            }
            
            // Add deposit data if applicable
            if (paymentModel === 'deposit') {
                const depositAmount = parseFloat(document.getElementById('depositAmount').value) || 0;
                if (depositAmount <= 0) {
                    alert('Please enter a valid deposit amount');
                    return;
                }
                
                paymentConfig.deposit = {
                    amount: depositAmount,
                    percentage: parseFloat(document.getElementById('depositPercentage').value) || 0
                };
            }
            
            console.log('Saving payment configuration:', paymentConfig);
            alert('Payment configuration saved successfully!');
            
            // In real implementation, save to server
            // await fetch('/api/quotes/payment-config', { method: 'POST', body: JSON.stringify(paymentConfig) });
        }

        // ============================================================================
        // INVOICE MANAGEMENT FUNCTIONALITY
        // ============================================================================

        // Mock invoice data for the quote
        let quoteInvoices = [
            {
                id: 'INV-2024-001',
                type: 'full',
                amount: 341.00,
                status: 'paid',
                paidAmount: 341.00,
                dueDate: '2024-01-15',
                createdDate: '2024-01-01',
                paymentDate: '2024-01-10'
            },
            {
                id: 'INV-2024-002', 
                type: 'deposit',
                amount: 170.50,
                status: 'unpaid',
                paidAmount: 0,
                dueDate: '2024-02-15',
                createdDate: '2024-02-01'
            }
        ];

        function createFullInvoice() {
            const quoteTotal = calculateTotal();
            const remainingAmount = getRemainingToInvoice();
            
            if (remainingAmount <= 0) {
                alert('This quote has already been fully invoiced.');
                return;
            }
            
            if (confirm(`Create a full invoice for $${remainingAmount.toFixed(2)}?`)) {
                // Navigate to invoice creation with full amount
                const quoteId = document.getElementById('quoteIdBadge').textContent;
                window.location.href = `invoice_create_simple.html?quoteId=${quoteId}&type=full&amount=${remainingAmount}`;
            }
        }

        function createDepositInvoice() {
            const paymentModel = document.querySelector('input[name="paymentModel"]:checked')?.value;
            
            if (paymentModel !== 'deposit') {
                alert('Please configure deposit settings in the Payment Configuration tab first.');
                switchTab('paymentConfig');
                return;
            }
            
            const depositAmount = parseFloat(document.getElementById('depositAmount')?.value) || 0;
            
            if (depositAmount <= 0) {
                alert('Please set a valid deposit amount in the Payment Configuration tab.');
                switchTab('paymentConfig');
                return;
            }
            
            if (confirm(`Create a deposit invoice for $${depositAmount.toFixed(2)}?`)) {
                const quoteId = document.getElementById('quoteIdBadge').textContent;
                window.location.href = `invoice_create_simple.html?quoteId=${quoteId}&type=deposit&amount=${depositAmount}`;
            }
        }

        function createPartialInvoice() {
            alert('Partial invoice creation will open an item selection interface.');
            // In real implementation, this would open a modal to select specific items
            const quoteId = document.getElementById('quoteIdBadge').textContent;
            window.location.href = `invoice_create_simple.html?quoteId=${quoteId}&type=partial`;
        }

        function refreshInvoices() {
            loadInvoices();
            updateInvoiceSummary();
        }

        function loadInvoices() {
            const invoicesList = document.getElementById('invoicesList');
            const noInvoicesState = document.getElementById('noInvoicesState');
            
            if (quoteInvoices.length === 0) {
                invoicesList.innerHTML = '';
                noInvoicesState.classList.remove('hidden');
                return;
            }
            
            noInvoicesState.classList.add('hidden');
            
            invoicesList.innerHTML = quoteInvoices.map(invoice => {
                const statusColors = {
                    'paid': 'bg-green-100 text-green-800',
                    'unpaid': 'bg-red-100 text-red-800',
                    'partial': 'bg-yellow-100 text-yellow-800',
                    'overdue': 'bg-red-100 text-red-800'
                };
                
                const typeLabels = {
                    'full': 'Full Invoice',
                    'deposit': 'Deposit Invoice', 
                    'partial': 'Partial Invoice'
                };
                
                return `
                    <div class="border border-gray-200 rounded-lg p-4 hover:border-gray-300 transition-colors">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center gap-2">
                                <span class="font-semibold text-gray-900">${invoice.id}</span>
                                <span class="px-2 py-1 text-xs rounded-full ${statusColors[invoice.status]}">${invoice.status.charAt(0).toUpperCase() + invoice.status.slice(1)}</span>
                            </div>
                            <div class="text-right">
                                <div class="font-semibold text-gray-900">$${invoice.amount.toFixed(2)}</div>
                                ${invoice.paidAmount > 0 ? `<div class="text-xs text-green-600">Paid: $${invoice.paidAmount.toFixed(2)}</div>` : ''}
                            </div>
                        </div>
                        
                        <div class="flex items-center justify-between text-sm text-gray-600">
                            <span>${typeLabels[invoice.type]}</span>
                            <span>Due: ${new Date(invoice.dueDate).toLocaleDateString()}</span>
                        </div>
                        
                        <div class="flex gap-2 mt-3">
                            <button 
                                onclick="viewInvoice('${invoice.id}')"
                                class="flex-1 px-3 py-1.5 text-xs border border-gray-300 rounded hover:bg-gray-50"
                            >
                                View
                            </button>
                            <button 
                                onclick="sendInvoice('${invoice.id}')"
                                class="flex-1 px-3 py-1.5 text-xs border border-gray-300 rounded hover:bg-gray-50"
                            >
                                Send
                            </button>
                            ${invoice.status === 'unpaid' ? `
                                <button 
                                    onclick="recordPayment('${invoice.id}')"
                                    class="flex-1 px-3 py-1.5 text-xs bg-green-600 text-white rounded hover:bg-green-700"
                                >
                                    Record Payment
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateInvoiceSummary() {
            const quoteTotal = calculateTotal();
            const totalInvoiced = quoteInvoices.reduce((sum, inv) => sum + inv.amount, 0);
            const totalPaid = quoteInvoices.reduce((sum, inv) => sum + inv.paidAmount, 0);
            const totalOutstanding = totalInvoiced - totalPaid;
            const remainingToInvoice = quoteTotal - totalInvoiced;
            
            // Update summary displays
            document.getElementById('invoiceQuoteTotal').textContent = `$${quoteTotal.toFixed(2)}`;
            document.getElementById('totalInvoiced').textContent = `$${totalInvoiced.toFixed(2)}`;
            document.getElementById('totalPaid').textContent = `$${totalPaid.toFixed(2)}`;
            document.getElementById('totalOutstanding').textContent = `$${totalOutstanding.toFixed(2)}`;
            document.getElementById('remainingToInvoice').textContent = `$${remainingToInvoice.toFixed(2)}`;
            
            // Update progress bar
            const invoiceProgress = (totalInvoiced / quoteTotal) * 100;
            document.getElementById('invoiceProgressBar').style.width = `${invoiceProgress}%`;
            document.getElementById('invoiceProgressText').textContent = `${invoiceProgress.toFixed(0)}% of quote amount invoiced`;
            
            // Update status badge
            const statusBadge = document.getElementById('invoiceStatusBadge');
            if (totalInvoiced === 0) {
                statusBadge.textContent = 'Not Invoiced';
                statusBadge.className = 'px-2 py-1 bg-gray-100 text-gray-700 rounded text-xs font-medium';
            } else if (remainingToInvoice > 0) {
                statusBadge.textContent = 'Partially Invoiced';
                statusBadge.className = 'px-2 py-1 bg-yellow-100 text-yellow-700 rounded text-xs font-medium';
            } else {
                statusBadge.textContent = 'Fully Invoiced';
                statusBadge.className = 'px-2 py-1 bg-green-100 text-green-700 rounded text-xs font-medium';
            }
        }

        function getRemainingToInvoice() {
            const quoteTotal = calculateTotal();
            const totalInvoiced = quoteInvoices.reduce((sum, inv) => sum + inv.amount, 0);
            return quoteTotal - totalInvoiced;
        }

        function viewInvoice(invoiceId) {
            // Navigate to invoice detail page
            window.location.href = `invoice_detail_simple.html?id=${invoiceId}`;
        }

        function sendInvoice(invoiceId) {
            const invoice = quoteInvoices.find(inv => inv.id === invoiceId);
            if (invoice) {
                alert(`Invoice ${invoiceId} sent to customer!`);
                // In real implementation, send email to customer
            }
        }

        function recordPayment(invoiceId) {
            const invoice = quoteInvoices.find(inv => inv.id === invoiceId);
            if (invoice) {
                const paymentAmount = prompt(`Record payment for ${invoiceId}\\nOutstanding amount: $${(invoice.amount - invoice.paidAmount).toFixed(2)}\\n\\nEnter payment amount:`);
                
                if (paymentAmount && !isNaN(paymentAmount)) {
                    const amount = parseFloat(paymentAmount);
                    if (amount > 0 && amount <= (invoice.amount - invoice.paidAmount)) {
                        invoice.paidAmount += amount;
                        
                        if (invoice.paidAmount >= invoice.amount) {
                            invoice.status = 'paid';
                            invoice.paymentDate = new Date().toISOString().split('T')[0];
                        } else {
                            invoice.status = 'partial';
                        }
                        
                        loadInvoices();
                        updateInvoiceSummary();
                        alert(`Payment of $${amount.toFixed(2)} recorded for ${invoiceId}`);
                    } else {
                        alert('Invalid payment amount');
                    }
                }
            }
        }

        function sendPaymentReminder() {
            const unpaidInvoices = quoteInvoices.filter(inv => inv.status === 'unpaid' || inv.status === 'partial');
            
            if (unpaidInvoices.length === 0) {
                alert('No unpaid invoices to send reminders for.');
                return;
            }
            
            alert(`Payment reminder sent for ${unpaidInvoices.length} unpaid invoice(s)!`);
            // In real implementation, send reminder emails
        }

        function viewPaymentHistory() {
            const paidInvoices = quoteInvoices.filter(inv => inv.paidAmount > 0);
            
            if (paidInvoices.length === 0) {
                alert('No payment history available.');
                return;
            }
            
            let historyText = 'Payment History:\\n\\n';
            paidInvoices.forEach(invoice => {
                historyText += `${invoice.id}: $${invoice.paidAmount.toFixed(2)}`;
                if (invoice.paymentDate) {
                    historyText += ` (${new Date(invoice.paymentDate).toLocaleDateString()})`;
                }
                historyText += '\\n';
            });
            
            alert(historyText);
            // In real implementation, open a detailed payment history modal
        }

        function downloadInvoiceReport() {
            alert('Invoice report download would be implemented here.');
            // In real implementation, generate and download PDF report
        }

        // ============================================================================
        // INVOICE PREVIEW FUNCTIONALITY
        // ============================================================================

        function showInvoicePreview() {
            const paymentModel = document.querySelector('input[name="paymentModel"]:checked')?.value || 'full';
            const quoteTotal = calculateTotal();
            const invoicesToCreate = generateInvoicePreview(paymentModel, quoteTotal);
            
            if (invoicesToCreate.length === 0) {
                alert('No invoices to create. Please configure payment settings first.');
                return;
            }
            
            renderInvoicePreview(invoicesToCreate);
            document.getElementById('invoicePreviewModal').classList.remove('hidden');
        }

        function generateInvoicePreview(paymentModel, quoteTotal) {
            const invoices = [];
            const today = new Date();
            const quoteId = document.getElementById('quoteIdBadge').textContent;
            
            if (paymentModel === 'full') {
                const remainingAmount = getRemainingToInvoice();
                if (remainingAmount > 0) {
                    invoices.push({
                        id: `INV-${new Date().getFullYear()}-${String(Date.now()).slice(-3)}`,
                        type: 'Full Invoice',
                        description: 'Invoice for complete quote amount',
                        amount: remainingAmount,
                        dueDate: calculateDueDate(today),
                        items: state.quoteItems,
                        color: 'purple'
                    });
                }
            } else if (paymentModel === 'deposit') {
                const depositAmount = parseFloat(document.getElementById('depositAmount')?.value) || 0;
                const remainingAmount = quoteTotal - depositAmount;
                
                if (depositAmount > 0) {
                    // Deposit invoice
                    invoices.push({
                        id: `INV-${new Date().getFullYear()}-${String(Date.now()).slice(-3)}`,
                        type: 'Deposit Invoice',
                        description: 'Down payment invoice',
                        amount: depositAmount,
                        dueDate: calculateDueDate(today),
                        items: state.quoteItems.map(item => ({...item, isDeposit: true})),
                        color: 'blue'
                    });
                    
                    // Remaining balance invoice
                    if (remainingAmount > 0) {
                        const balanceDueDate = new Date(today);
                        balanceDueDate.setDate(balanceDueDate.getDate() + 30); // 30 days after deposit
                        
                        invoices.push({
                            id: `INV-${new Date().getFullYear()}-${String(Date.now() + 1).slice(-3)}`,
                            type: 'Balance Invoice',
                            description: 'Remaining balance after deposit',
                            amount: remainingAmount,
                            dueDate: calculateDueDate(balanceDueDate),
                            items: state.quoteItems.map(item => ({...item, isBalance: true})),
                            color: 'green'
                        });
                    }
                }
            } else if (paymentModel === 'subscription') {
                const frequency = document.getElementById('billingFrequency')?.value || 'monthly';
                const startDate = new Date(document.getElementById('subscriptionStartDate')?.value || today);
                const endType = document.getElementById('subscriptionEnd')?.value || 'ongoing';
                
                let cycles = 12; // Default to 12 cycles for preview
                if (endType === 'after_cycles') {
                    cycles = parseInt(document.getElementById('billingCycles')?.value) || 12;
                } else if (endType === 'end_date') {
                    const endDate = new Date(document.getElementById('subscriptionEndDate')?.value);
                    cycles = calculateCyclesBetweenDates(startDate, endDate, frequency);
                }
                
                const cycleAmount = quoteTotal / cycles;
                
                for (let i = 0; i < Math.min(cycles, 6); i++) { // Show max 6 invoices in preview
                    const invoiceDate = new Date(startDate);
                    addTimeToDate(invoiceDate, frequency, i);
                    
                    invoices.push({
                        id: `INV-${new Date().getFullYear()}-${String(Date.now() + i).slice(-3)}`,
                        type: `Subscription Invoice #${i + 1}`,
                        description: `${frequency.charAt(0).toUpperCase() + frequency.slice(1)} recurring invoice`,
                        amount: cycleAmount,
                        dueDate: calculateDueDate(invoiceDate),
                        items: state.quoteItems.map(item => ({...item, isSubscription: true, cycle: i + 1})),
                        color: 'indigo'
                    });
                }
                
                if (cycles > 6) {
                    invoices.push({
                        id: '...',
                        type: `+ ${cycles - 6} more invoices`,
                        description: `Total of ${cycles} subscription invoices`,
                        amount: cycleAmount * (cycles - 6),
                        dueDate: '...',
                        items: [],
                        color: 'gray',
                        isPlaceholder: true
                    });
                }
            }
            
            return invoices;
        }

        function renderInvoicePreview(invoices) {
            const content = document.getElementById('invoicePreviewContent');
            const totalAmount = invoices.reduce((sum, inv) => sum + (inv.isPlaceholder ? 0 : inv.amount), 0);
            
            content.innerHTML = `
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <h4 class="font-semibold text-blue-900">Invoice Summary</h4>
                            <p class="text-sm text-blue-700">Based on current payment configuration</p>
                        </div>
                        <div class="text-right">
                            <div class="text-2xl font-bold text-blue-900">$${totalAmount.toFixed(2)}</div>
                            <div class="text-sm text-blue-700">${invoices.filter(inv => !inv.isPlaceholder).length} invoice(s)</div>
                        </div>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    ${invoices.map(invoice => `
                        <div class="border-2 border-${invoice.color}-200 rounded-lg p-6 ${invoice.isPlaceholder ? 'opacity-60' : ''}">
                            <div class="flex items-center justify-between mb-4">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 bg-${invoice.color}-100 rounded-full flex items-center justify-center">
                                        <svg class="w-5 h-5 text-${invoice.color}-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                        </svg>
                                    </div>
                                    <div>
                                        <h5 class="font-semibold text-gray-900">${invoice.id}</h5>
                                        <p class="text-sm text-${invoice.color}-600 font-medium">${invoice.type}</p>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div class="text-xl font-bold text-gray-900">$${invoice.amount.toFixed(2)}</div>
                                    ${!invoice.isPlaceholder ? `<div class="text-sm text-gray-500">Due: ${invoice.dueDate}</div>` : ''}
                                </div>
                            </div>
                            
                            <p class="text-sm text-gray-600 mb-4">${invoice.description}</p>
                            
                            ${!invoice.isPlaceholder && invoice.items.length > 0 ? `
                                <div class="border-t border-gray-200 pt-3">
                                    <h6 class="text-xs font-medium text-gray-700 mb-2">Items (${invoice.items.length})</h6>
                                    <div class="space-y-1 max-h-32 overflow-y-auto">
                                        ${invoice.items.slice(0, 3).map(item => `
                                            <div class="flex justify-between text-xs text-gray-600">
                                                <span>${item.name}</span>
                                                <span>$${(item.customPrice || item.price).toFixed(2)}</span>
                                            </div>
                                        `).join('')}
                                        ${invoice.items.length > 3 ? `<div class="text-xs text-gray-500">+ ${invoice.items.length - 3} more items</div>` : ''}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function calculateDueDate(fromDate) {
            const terms = document.getElementById('defaultPaymentTerms')?.value || 'net_30';
            const dueDate = new Date(fromDate);
            
            switch(terms) {
                case 'due_on_receipt':
                    return dueDate.toLocaleDateString();
                case 'net_7':
                    dueDate.setDate(dueDate.getDate() + 7);
                    break;
                case 'net_15':
                    dueDate.setDate(dueDate.getDate() + 15);
                    break;
                case 'net_30':
                    dueDate.setDate(dueDate.getDate() + 30);
                    break;
                case 'net_60':
                    dueDate.setDate(dueDate.getDate() + 60);
                    break;
            }
            
            return dueDate.toLocaleDateString();
        }

        function calculateCyclesBetweenDates(startDate, endDate, frequency) {
            const diffTime = Math.abs(endDate - startDate);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            switch(frequency) {
                case 'weekly': return Math.floor(diffDays / 7);
                case 'biweekly': return Math.floor(diffDays / 14);
                case 'monthly': return Math.floor(diffDays / 30);
                case 'quarterly': return Math.floor(diffDays / 90);
                case 'yearly': return Math.floor(diffDays / 365);
                default: return 12;
            }
        }

        function addTimeToDate(date, frequency, multiplier) {
            switch(frequency) {
                case 'weekly':
                    date.setDate(date.getDate() + (7 * multiplier));
                    break;
                case 'biweekly':
                    date.setDate(date.getDate() + (14 * multiplier));
                    break;
                case 'monthly':
                    date.setMonth(date.getMonth() + multiplier);
                    break;
                case 'quarterly':
                    date.setMonth(date.getMonth() + (3 * multiplier));
                    break;
                case 'yearly':
                    date.setFullYear(date.getFullYear() + multiplier);
                    break;
            }
        }

        function hideInvoicePreview() {
            document.getElementById('invoicePreviewModal').classList.add('hidden');
        }

        function createAllInvoicesFromPreview() {
            const paymentModel = document.querySelector('input[name="paymentModel"]:checked')?.value || 'full';
            
            if (confirm(`Create all invoices based on the ${paymentModel} payment model?`)) {
                // In real implementation, this would create all the invoices
                alert('All invoices created successfully!');
                hideInvoicePreview();
                
                // Refresh the invoices list
                refreshInvoices();
            }
        }

        // ============================================================================
        // SPLIT INVOICE FUNCTIONALITY
        // ============================================================================

        let splitInvoiceEnabled = true; // Always enabled now
        let splitMethod = 'percentage'; // 'percentage' or 'amount'
        let payers = [];
        let payerIdCounter = 1;

        function initializeSplitInvoice() {
            // Add default 2 payers on initialization
            if (payers.length === 0) {
                addPayer();
                addPayer();
            }

            // Split Method Buttons
            document.getElementById('splitByPercentage').addEventListener('click', function() {
                splitMethod = 'percentage';
                this.classList.add('bg-purple-600', 'text-white');
                this.classList.remove('bg-white', 'border', 'border-gray-300', 'text-gray-700');
                
                const amountBtn = document.getElementById('splitByAmount');
                amountBtn.classList.remove('bg-purple-600', 'text-white');
                amountBtn.classList.add('bg-white', 'border', 'border-gray-300', 'text-gray-700');
                
                renderPayers();
            });

            document.getElementById('splitByAmount').addEventListener('click', function() {
                splitMethod = 'amount';
                this.classList.add('bg-purple-600', 'text-white');
                this.classList.remove('bg-white', 'border', 'border-gray-300', 'text-gray-700');
                
                const percentBtn = document.getElementById('splitByPercentage');
                percentBtn.classList.remove('bg-purple-600', 'text-white');
                percentBtn.classList.add('bg-white', 'border', 'border-gray-300', 'text-gray-700');
                
                renderPayers();
            });

            // Add Payer Button
            document.getElementById('addPayerBtn').addEventListener('click', addPayer);
        }

        function addPayer() {
            const payer = {
                id: payerIdCounter++,
                name: '',
                email: '',
                phone: '',
                value: splitMethod === 'percentage' ? 50 : 0
            };
            payers.push(payer);
            renderPayers();
            updateSplitSummary();
        }

        function removePayer(payerId) {
            payers = payers.filter(p => p.id !== payerId);
            renderPayers();
            updateSplitSummary();
        }

        function renderPayers() {
            const container = document.getElementById('payersList');
            container.innerHTML = '';

            payers.forEach((payer, index) => {
                const payerCard = createPayerCard(payer, index);
                container.appendChild(payerCard);
            });
        }

        function createPayerCard(payer, index) {
            const div = document.createElement('div');
            div.className = 'border border-gray-300 rounded-lg p-3 bg-gray-50';
            
            const inputLabel = splitMethod === 'percentage' ? '%' : '$';
            const inputPlaceholder = splitMethod === 'percentage' ? '50' : '0.00';
            
            // Generate contact options from existing customer data
            let contactOptions = '<option value="">-- Select Existing Contact or Add New --</option>';
            if (state.selectedCustomer && state.selectedCustomer.secondaryContacts) {
                // Add primary contact
                contactOptions += `<option value="primary">${state.selectedCustomer.name} (Primary)</option>`;
                
                // Add secondary contacts
                state.selectedCustomer.secondaryContacts.forEach((contact, idx) => {
                    contactOptions += `<option value="secondary-${idx}">${contact.name} - ${contact.role}</option>`;
                });
            }
            contactOptions += '<option value="new">+ Add New Contact</option>';
            
            div.innerHTML = `
                <div class="flex items-center justify-between mb-3">
                    <span class="text-sm font-medium text-gray-700">Payer ${index + 1}</span>
                    ${payers.length > 1 ? `
                        <button 
                            onclick="removePayer(${payer.id})"
                            class="text-red-600 hover:text-red-700 text-sm"
                        >
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                            </svg>
                        </button>
                    ` : ''}
                </div>
                <div class="space-y-2">
                    <!-- Contact Selector -->
                    <div>
                        <label class="block text-xs text-gray-600 mb-1">Select Contact</label>
                        <select 
                            id="contactSelect-${payer.id}"
                            onchange="selectContact(${payer.id}, this.value)"
                            class="w-full px-2 py-1.5 border border-gray-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-purple-500 bg-white"
                        >
                            ${contactOptions}
                        </select>
                    </div>
                    
                    <!-- Manual Input Fields -->
                    <div id="manualFields-${payer.id}">
                        <input 
                            type="text" 
                            placeholder="Name"
                            value="${payer.name}"
                            onchange="updatePayerField(${payer.id}, 'name', this.value)"
                            class="w-full px-2 py-1.5 border border-gray-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-purple-500"
                        />
                        <input 
                            type="email" 
                            placeholder="Email"
                            value="${payer.email}"
                            onchange="updatePayerField(${payer.id}, 'email', this.value)"
                            class="w-full px-2 py-1.5 border border-gray-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-purple-500 mt-2"
                        />
                        <input 
                            type="tel" 
                            placeholder="Phone (optional)"
                            value="${payer.phone}"
                            onchange="updatePayerField(${payer.id}, 'phone', this.value)"
                            class="w-full px-2 py-1.5 border border-gray-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-purple-500 mt-2"
                        />
                    </div>
                    
                    <!-- Amount/Percentage -->
                    <div class="flex items-center gap-2 pt-2 border-t border-gray-200">
                        <label class="text-xs text-gray-600">Amount:</label>
                        <input 
                            type="number" 
                            placeholder="${inputPlaceholder}"
                            value="${payer.value}"
                            onchange="updatePayerField(${payer.id}, 'value', parseFloat(this.value) || 0)"
                            min="0"
                            step="${splitMethod === 'percentage' ? '1' : '0.01'}"
                            ${splitMethod === 'percentage' ? 'max="100"' : ''}
                            class="flex-1 px-2 py-1.5 border border-gray-300 rounded text-sm text-right focus:outline-none focus:ring-2 focus:ring-purple-500"
                        />
                        <span class="text-sm font-medium text-gray-600 w-6">${inputLabel}</span>
                    </div>
                </div>
            `;
            
            return div;
        }

        function selectContact(payerId, contactId) {
            if (contactId === 'new') {
                // Clear fields for new contact
                updatePayerField(payerId, 'name', '');
                updatePayerField(payerId, 'email', '');
                updatePayerField(payerId, 'phone', '');
                return;
            }
            
            if (contactId === '') {
                // No selection
                return;
            }
            
            let contact = null;
            
            if (contactId === 'primary') {
                contact = {
                    name: state.selectedCustomer.name,
                    email: state.selectedCustomer.email,
                    phone: state.selectedCustomer.phone
                };
            } else if (contactId.startsWith('secondary-')) {
                const index = parseInt(contactId.split('-')[1]);
                contact = state.selectedCustomer.secondaryContacts[index];
            }
            
            if (contact) {
                // Populate fields with contact data
                updatePayerField(payerId, 'name', contact.name);
                updatePayerField(payerId, 'email', contact.email);
                updatePayerField(payerId, 'phone', contact.phone || '');
                
                // Update the input fields visually
                const manualFields = document.getElementById(`manualFields-${payerId}`);
                if (manualFields) {
                    manualFields.querySelector('input[type="text"]').value = contact.name;
                    manualFields.querySelector('input[type="email"]').value = contact.email;
                    manualFields.querySelector('input[type="tel"]').value = contact.phone || '';
                }
            }
        }

        function updatePayerField(payerId, field, value) {
            const payer = payers.find(p => p.id === payerId);
            if (payer) {
                payer[field] = value;
                updateSplitSummary();
            }
        }

        function updateSplitSummary() {
            // Get total quote amount
            const totalAmount = calculateTotal();

            // Calculate allocated amount
            let allocatedAmount = 0;
            if (splitMethod === 'percentage') {
                const totalPercentage = payers.reduce((sum, p) => sum + (parseFloat(p.value) || 0), 0);
                allocatedAmount = (totalPercentage / 100) * totalAmount;
            } else {
                allocatedAmount = payers.reduce((sum, p) => sum + (parseFloat(p.value) || 0), 0);
            }

            const remainingAmount = totalAmount - allocatedAmount;

            // Update UI
            document.getElementById('splitTotalAmount').textContent = `$${totalAmount.toFixed(2)}`;
            document.getElementById('splitAllocatedAmount').textContent = `$${allocatedAmount.toFixed(2)}`;
            document.getElementById('splitRemainingAmount').textContent = `$${remainingAmount.toFixed(2)}`;

            // Show/hide validation warning
            const warningDiv = document.getElementById('splitValidationWarning');
            const warningMessage = document.getElementById('splitValidationMessage');
            
            if (Math.abs(remainingAmount) > 0.01) {
                warningDiv.classList.remove('hidden');
                if (remainingAmount > 0) {
                    warningMessage.textContent = ` Total must equal $${totalAmount.toFixed(2)}. Please allocate the remaining $${remainingAmount.toFixed(2)}.`;
                } else {
                    warningMessage.textContent = ` Total must equal $${totalAmount.toFixed(2)}. You've exceeded by $${Math.abs(remainingAmount).toFixed(2)}.`;
                }
            } else {
                warningDiv.classList.add('hidden');
            }

            // Update remaining amount color
            const remainingSpan = document.getElementById('splitRemainingAmount');
            if (Math.abs(remainingAmount) < 0.01) {
                remainingSpan.classList.remove('text-red-600');
                remainingSpan.classList.add('text-green-600');
            } else {
                remainingSpan.classList.remove('text-green-600');
                remainingSpan.classList.add('text-red-600');
            }
        }

        function isSplitAmountValid() {
            if (!splitInvoiceEnabled || payers.length === 0) {
                return true;
            }

            const totalAmount = calculateTotal();
            let allocatedAmount = 0;
            
            if (splitMethod === 'percentage') {
                const totalPercentage = payers.reduce((sum, p) => sum + (parseFloat(p.value) || 0), 0);
                allocatedAmount = (totalPercentage / 100) * totalAmount;
            } else {
                allocatedAmount = payers.reduce((sum, p) => sum + (parseFloat(p.value) || 0), 0);
            }

            // Check if amounts match (with small tolerance for rounding)
            return Math.abs(totalAmount - allocatedAmount) < 0.01;
        }
    </script>
</body>
</html>

