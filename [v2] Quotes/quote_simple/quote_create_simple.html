<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Quote - Simplified - FMS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<body class="min-h-screen bg-gray-50">
    
    <div class="p-4">
        <div class="max-w-7xl mx-auto">
            
            <!-- Header -->
            <div class="bg-white rounded-lg shadow-sm p-6 mb-4">
                <div class="flex justify-between items-start">
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-3">
                            <h1 class="text-3xl font-bold text-gray-900">Create Quote</h1>
                            <span class="px-3 py-1.5 text-sm font-medium rounded-full bg-blue-100 text-blue-700">üìù New</span>
                        </div>
                        <div class="flex items-center gap-2 text-gray-700">
                            <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                            </svg>
                            <span class="font-medium">Sunshine Tutoring - Melbourne East</span>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button 
                            onclick="window.location.href='quote_list_simple.html'"
                            class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors flex items-center gap-2 font-medium"
                        >
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                            </svg>
                            Back to Quotes
                        </button>
                        <button 
                            id="saveDraftBtn"
                            class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50"
                        >
                            Save Draft
                        </button>
                    </div>
                </div>
            </div>

            <!-- Required Fields Notice -->
            <div class="bg-blue-50 border-l-4 border-blue-500 p-3 mb-4">
                <div class="flex items-center gap-2">
                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <p class="text-sm text-blue-800">
                        <span class="text-red-500 font-bold">*</span> indicates required fields
                    </p>
                </div>
            </div>

            <!-- Tab Navigation -->
            <div class="bg-white rounded-lg shadow-sm mb-4">
                <div class="border-b border-gray-200">
                    <nav class="flex space-x-8 px-6" aria-label="Tabs">
                        <button 
                            id="quoteDetailsTab"
                            class="tab-button active py-4 px-1 border-b-2 border-blue-500 font-medium text-sm text-blue-600"
                            onclick="switchTab('quoteDetails')"
                        >
                            Quote Details
                        </button>
                        <button 
                            id="paymentConfigTab"
                            class="tab-button py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300"
                            onclick="switchTab('paymentConfig')"
                        >
                            Payment Configuration
                        </button>
                        <button 
                            id="invoicesTab"
                            class="tab-button py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300"
                            onclick="switchTab('invoices')"
                        >
                            Invoices
                        </button>
                    </nav>
                </div>
            </div>

            <div id="quoteDetailsContent" class="tab-content">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                
                <!-- Left Column - Customer & Services -->
                <div class="lg:col-span-2 space-y-4">
                    
                    <!-- Customer Section -->
                    <div class="bg-white rounded-lg shadow-sm p-4">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-lg font-semibold text-gray-900">Customer Information <span class="text-red-500">*</span></h2>
                            <button 
                                id="toggleNewCustomerBtn"
                                class="text-blue-600 text-sm hover:underline flex items-center gap-1"
                            >
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                                </svg>
                                New Customer
                            </button>
                        </div>

                        <!-- Customer Search with Autocomplete -->
                        <div id="customerSearchSection">
                            <div class="relative">
                                <svg class="absolute left-3 top-3 text-gray-400 w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                </svg>
                                <input
                                    type="text"
                                    id="customerSearchInput"
                                    placeholder="Type to search customer by name, email, or phone... (Required)"
                                    class="w-full pl-10 pr-10 py-2 border border-red-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"
                                    autocomplete="off"
                                    required
                                />
                                <button id="clearSearchBtn" class="hidden absolute right-3 top-3 text-gray-400 hover:text-gray-600">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                </button>
                                <!-- Autocomplete Dropdown -->
                                <div id="customerAutocomplete" class="hidden absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto custom-scrollbar">
                                    <!-- Autocomplete results will be populated here -->
                                </div>
                            </div>
                        </div>

                        <!-- Selected Customer Card -->
                        <div id="selectedCustomerCard" class="hidden mt-3">
                            <div class="border border-blue-300 rounded-lg p-3 bg-blue-50">
                                <div class="flex justify-between items-start mb-3">
                                    <div class="flex-1">
                                        <div class="flex items-center gap-2">
                                            <p class="font-semibold text-gray-900" id="selectedCustomerName"></p>
                                            <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800">Selected</span>
                                        </div>
                                        <p class="text-sm text-gray-600 mt-1" id="selectedCustomerEmail"></p>
                                        <p class="text-sm text-gray-600" id="selectedCustomerPhone"></p>
                                    </div>
                                    <button 
                                        id="clearCustomerBtn"
                                        class="text-gray-500 hover:text-gray-700"
                                        title="Clear selection"
                                    >
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                        </svg>
                                    </button>
                                </div>
                                
                                <!-- Quote Contact Selector (if secondary contacts exist) -->
                                <div id="quoteContactSelector" class="hidden border-t border-blue-200 pt-3 mt-3">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Quote Contact</label>
                                    <select id="quoteContactSelect" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white">
                                        <!-- Options populated dynamically -->
                                    </select>
                                    <p class="text-xs text-gray-500 mt-1">Select who should receive this quote</p>
                                </div>
                                
                                <!-- Service Address Section -->
                                <div class="border-t border-blue-200 pt-3 mt-3">
                                    <div class="flex items-center justify-between mb-2">
                                        <h3 class="text-sm font-medium text-gray-700">Service Address</h3>
                                        <label class="flex items-center gap-2 text-xs text-gray-600">
                                            <input type="checkbox" id="sameAsBilling" checked class="rounded" />
                                            <span>Same as customer address</span>
                                        </label>
                                    </div>
                                    <div id="serviceAddressFields" class="hidden">
                                        <div class="mb-2">
                                            <label class="block text-xs text-gray-600 mb-1">Service Location <span class="text-red-500">*</span></label>
                                            <input type="text" id="serviceStreet" placeholder="Enter service address" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" required />
                                        </div>
                                    </div>
                                    <div id="serviceAddressDisplay" class="text-sm text-gray-600 mb-2" style="display: block;">
                                        <span id="displayServiceAddress"></span>
                                    </div>
                                    <!-- Access Instructions - Always visible -->
                                    <div class="mt-2">
                                        <label class="block text-xs text-gray-600 mb-1">Access Instructions <span class="text-gray-400 text-xs">(Optional)</span></label>
                                        <textarea id="serviceAddressNotes" rows="2" placeholder="Gate codes, parking info, entry instructions, etc." class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                                    </div>
                                </div>

                            </div>
                        </div>

                        <!-- Quick Add Customer Form -->
                        <div id="newCustomerForm" class="hidden bg-gray-50 border border-gray-200 rounded-lg p-4 space-y-4">
                            <div class="flex items-center gap-2">
                                <span class="text-sm font-semibold text-gray-900">Quick Add Customer</span>
                                <span class="text-xs text-gray-500">Only key details required</span>
                            </div>
                            
                            <div class="space-y-3">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Full Name *</label>
                                    <input type="text" id="quickCustomerFullName" placeholder="John Doe" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" required />
                                </div>
                            <div class="grid grid-cols-2 gap-3">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Company</label>
                                        <input type="text" id="quickCustomerCompany" placeholder="ABC Corp" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" />
                                </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Role</label>
                                        <input type="text" id="quickCustomerRole" placeholder="Operations Manager" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" />
                                </div>
                            </div>
                                <div class="grid grid-cols-2 gap-3">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Email *</label>
                                        <input type="email" id="quickCustomerEmail" placeholder="john@example.com" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" required />
                            </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Phone *</label>
                                        <input type="tel" id="quickCustomerPhone" placeholder="+1 234 567 8900" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" required />
                                </div>
                                </div>
                                <div class="grid grid-cols-2 gap-3">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">WhatsApp (optional)</label>
                                        <input type="tel" id="quickCustomerWhatsApp" placeholder="+61 412 345 678" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" />
                                </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Preferred Contact</label>
                                        <select id="quickCustomerPreferredContact" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="email">Email</option>
                                        <option value="phone">Phone</option>
                                        <option value="whatsapp">WhatsApp</option>
                                    </select>
                                </div>
                            </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Address</label>
                                    <input type="text" id="quickCustomerAddress" placeholder="123 Main St, Melbourne VIC 3000" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" />
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Notes</label>
                                    <textarea id="quickCustomerNotes" rows="2" placeholder="Additional notes about the customer" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                                </div>
                            </div>
                            
                            <div class="flex gap-2 border-t border-gray-200 pt-3">
                                <button 
                                    id="cancelNewCustomerBtn"
                                    class="flex-1 px-3 py-2 border border-gray-300 text-gray-700 rounded-lg text-sm hover:bg-gray-50"
                                >
                                    Cancel
                                </button>
                                <button 
                                    id="createCustomerBtn"
                                    class="flex-1 px-3 py-2 bg-blue-600 text-white rounded-lg text-sm hover:bg-blue-700"
                                >
                                    Quick Add & Select
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Quote Line Items -->
                    <div class="bg-white rounded-lg shadow-sm p-4">
                        <h2 class="text-lg font-semibold text-gray-900 mb-4">Quote Line Items <span class="text-red-500">*</span></h2>
                        
                        <!-- Add Service/Product Search -->
                        <div class="mb-4">
                            <div class="relative">
                                <svg class="absolute left-3 top-3 text-gray-400 w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                </svg>
                                <input 
                                    type="text" 
                                    id="catalogSearchInput"
                                    placeholder="Type to search and add services or products..."
                                    class="w-full pl-10 pr-10 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"
                                    autocomplete="off"
                                />
                                <button id="clearCatalogSearchBtn" class="hidden absolute right-3 top-3 text-gray-400 hover:text-gray-600">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                </button>
                                <!-- Autocomplete Dropdown -->
                                <div id="catalogAutocomplete" class="hidden absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-80 overflow-y-auto custom-scrollbar">
                                    <!-- Autocomplete results will be populated here -->
                                </div>
                            </div>
                        </div>
                        
                        <div id="emptyQuoteState" class="text-center py-12 text-gray-500 bg-gray-50 rounded-lg border-2 border-dashed border-gray-300">
                            <svg class="mx-auto mb-3 text-gray-400 w-12 h-12" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                            </svg>
                            <p class="text-sm font-medium text-gray-700 mb-1">No items added yet</p>
                            <p class="text-xs text-gray-500">Search and add services or products above to build your quote</p>
                        </div>

                        <!-- Card-based Quote Items Container -->
                        <div id="quoteItemsContainer" class="hidden space-y-3">
                            <!-- Quote item cards will be populated here -->
                        </div>
                    </div>
                </div>

                <!-- Right Column - Summary & Actions -->
                <div class="space-y-4">
                    
                    <!-- Pricing Summary -->
                    <div class="bg-white rounded-lg shadow-sm p-4 sticky top-4">
                        <h2 class="text-lg font-semibold text-gray-900 mb-4">Quote Summary</h2>
                        
                        <div class="space-y-3 mb-4">
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-600">Subtotal</span>
                                <span class="font-medium" id="subtotalAmount">$0.00</span>
                            </div>

                            <!-- Line Item Discounts Summary -->
                            <div id="lineItemDiscountSection" class="hidden">
                                <div class="flex justify-between text-sm">
                                    <span class="text-sm text-gray-600">Line Item Discounts</span>
                                    <span class="text-sm font-medium text-red-600" id="lineItemDiscountAmount">-$0.00</span>
                                </div>
                            </div>
                            
                            <!-- Tax Breakdown by Category -->
                            <div class="border-t border-gray-200 pt-3">
                                <div class="text-xs text-gray-600 mb-2">Tax Breakdown:</div>
                                <div id="taxBreakdown" class="space-y-1 text-xs">
                                    <!-- Tax breakdown will be populated here -->
                                </div>
                                <div class="flex justify-between items-center mt-2 pt-2 border-t border-gray-100">
                                    <span class="text-sm text-gray-600">Total Tax</span>
                                    <span class="text-sm font-medium" id="taxAmount">$0.00</span>
                                </div>
                            </div>

                            <div class="border-t-2 border-gray-300 pt-3">
                                <div class="flex justify-between">
                                    <span class="font-bold text-gray-900 text-lg">Total</span>
                                    <span class="font-bold text-gray-900 text-lg" id="totalAmount">$0.00</span>
                                </div>
                            </div>
                        </div>

                        <!-- Quote Details -->
                        <div class="border-t border-gray-200 pt-4 space-y-3">
                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-1">Valid Until</label>
                                <input 
                                    type="date" 
                                    id="validUntilDate"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                                />
                            </div>

                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-1">Notes for Customer</label>
                                <textarea 
                                    id="customerNotes"
                                    rows="3"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    placeholder="Terms, conditions, or special notes..."
                                ></textarea>
                            </div>

                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-1">Internal Notes</label>
                                <textarea 
                                    id="internalNotes"
                                    rows="2"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    placeholder="Private notes (not visible to customer)..."
                                ></textarea>
                            </div>
                        </div>
                        <!-- Action Buttons -->
                        <div class="mt-4 space-y-2">
                            <button 
                                id="createQuoteBtn"
                                class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed text-sm font-medium flex items-center justify-center gap-2"
                            >
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                Create Quote
                            </button>
                            <button 
                                id="saveDraftBtn"
                                class="w-full bg-gray-600 text-white py-2 rounded-lg hover:bg-gray-700 text-sm font-medium flex items-center justify-center gap-2"
                            >
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path>
                                </svg>
                                Save as Draft
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

            <!-- Payment Configuration Tab Content -->
            <div id="paymentConfigContent" class="tab-content hidden">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                    
                    <!-- Left Column - Payment Configuration -->
                    <div class="lg:col-span-2 space-y-4">
                        
                        <!-- Payment Model Section -->
                        <div class="bg-white rounded-lg shadow-sm p-6">
                            <h2 class="text-lg font-semibold text-gray-900 mb-4">Payment Model</h2>
                            
                            <div class="space-y-3">
                                <label class="flex items-start gap-3 p-3 border-2 border-purple-300 bg-purple-50 rounded-lg cursor-pointer">
                                    <input type="radio" name="paymentModel" value="full" checked class="mt-1" onchange="updatePaymentModel()" />
                                    <div class="flex-1">
                                        <div class="font-semibold text-gray-900">Full Payment (Upfront)</div>
                                        <div class="text-xs text-gray-600 mt-1">Customer pays entire amount upfront before service begins</div>
                                    </div>
                                </label>
                                <label class="flex items-start gap-3 p-3 border-2 border-gray-200 rounded-lg cursor-pointer hover:border-purple-300 hover:bg-purple-50">
                                    <input type="radio" name="paymentModel" value="deposit" class="mt-1" onchange="updatePaymentModel()" />
                                    <div class="flex-1">
                                        <div class="font-semibold text-gray-900">Down Payment (Deposit)</div>
                                        <div class="text-xs text-gray-600 mt-1">Customer pays deposit now, remaining balance later</div>
                                    </div>
                                </label>
                                <label class="flex items-start gap-3 p-3 border-2 border-gray-200 rounded-lg cursor-pointer hover:border-purple-300 hover:bg-purple-50">
                                    <input type="radio" name="paymentModel" value="subscription" class="mt-1" onchange="updatePaymentModel()" />
                                    <div class="flex-1">
                                        <div class="font-semibold text-gray-900">Subscription (Recurring)</div>
                                        <div class="text-xs text-gray-600 mt-1">Automatic recurring invoices at regular intervals</div>
                                    </div>
                                </label>
    </div>

                            <!-- Subscription Settings -->
                            <div id="subscriptionSection" class="hidden mt-4 p-4 bg-gray-50 rounded-lg">
                                <h3 class="text-sm font-medium text-gray-700 mb-3">Subscription Settings</h3>
                                <div class="space-y-3">
                                    <div>
                                        <label class="block text-xs text-gray-600 mb-1">Billing Frequency</label>
                                        <select id="billingFrequency" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                                            <option value="weekly">Weekly</option>
                                            <option value="biweekly">Bi-weekly (Every 2 weeks)</option>
                                            <option value="monthly" selected>Monthly</option>
                                            <option value="quarterly">Quarterly (Every 3 months)</option>
                                            <option value="yearly">Yearly</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-xs text-gray-600 mb-1">Subscription Start Date</label>
                                        <input type="date" id="subscriptionStartDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500" />
                                    </div>
                                    <div>
                                        <label class="block text-xs text-gray-600 mb-1">Subscription End (Optional)</label>
                                        <select id="subscriptionEnd" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500" onchange="toggleEndDate()">
                                            <option value="ongoing">Ongoing (No end date)</option>
                                            <option value="after_cycles">After specific number of cycles</option>
                                            <option value="end_date">Specific end date</option>
                                        </select>
                                    </div>
                                    <div id="cyclesInput" class="hidden">
                                        <label class="block text-xs text-gray-600 mb-1">Number of Billing Cycles</label>
                                        <input type="number" id="billingCycles" min="1" placeholder="e.g., 12" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500" />
                                    </div>
                                    <div id="endDateInput" class="hidden">
                                        <label class="block text-xs text-gray-600 mb-1">End Date</label>
                                        <input type="date" id="subscriptionEndDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500" />
                                    </div>
                                    <div class="flex items-center gap-2 p-2 bg-green-50 rounded">
                                        <input type="checkbox" id="autoCharge" checked class="rounded text-green-600" />
                                        <label for="autoCharge" class="text-xs text-green-800">
                                            <strong>Auto-charge enabled</strong> - Automatically charge customer on billing date
                                        </label>
                                    </div>
                                    <div class="p-2 bg-blue-50 rounded text-xs text-blue-800">
                                        <strong>Next Invoice:</strong> <span id="nextInvoiceDate">-</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Deposit Amount -->
                            <div id="paymentDepositSection" class="hidden mt-4 p-4 bg-gray-50 rounded-lg">
                                <h3 class="text-sm font-medium text-gray-700 mb-3">Deposit Amount</h3>
                                <div class="space-y-2">
                    <div class="flex gap-2">
                                        <div class="flex-1">
                                            <div class="relative">
                                                <span class="absolute left-3 top-2.5 text-gray-500">$</span>
                                                <input 
                                                    type="number" 
                                                    id="depositAmount"
                                                    placeholder="0.00"
                                                    min="0"
                                                    step="0.01"
                                                    class="w-full pl-7 pr-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                                                    oninput="updateDepositCalculation()"
                                                />
                                            </div>
                                        </div>
                                        <div class="flex-1">
                                            <div class="relative">
                                                <input 
                                                    type="number" 
                                                    id="depositPercentage"
                                                    placeholder="0"
                                                    min="0"
                                                    max="100"
                                                    step="1"
                                                    class="w-full pr-8 pl-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                                                    oninput="updateDepositFromPercentage()"
                                                />
                                                <span class="absolute right-3 top-2.5 text-gray-500">%</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="flex gap-2">
                                        <button type="button" onclick="setDepositPercentage(25)" class="flex-1 px-3 py-1.5 text-xs border border-gray-300 rounded hover:bg-gray-50">25%</button>
                                        <button type="button" onclick="setDepositPercentage(50)" class="flex-1 px-3 py-1.5 text-xs border border-gray-300 rounded hover:bg-gray-50">50%</button>
                                        <button type="button" onclick="setDepositPercentage(75)" class="flex-1 px-3 py-1.5 text-xs border border-gray-300 rounded hover	bg-gray-50">75%</button>
                                    </div>
                                    <div class="p-2 bg-blue-50 rounded text-xs text-blue-800">
                                        <strong>Remaining Balance:</strong> <span id="remainingBalance">$0.00</span>
                                    </div>
                                </div>
                            </div>

                        </div>

                        <!-- Accepted Payment Methods Section -->
                        <div class="bg-white rounded-lg shadow-sm p-6">
                            <h2 class="text-lg font-semibold text-gray-900 mb-4">Accepted Payment Methods</h2>
                            
                            <div id="paymentMethodsContainer" class="space-y-2">
                                <label class="flex items-center gap-2 p-2 border-2 border-purple-300 bg-purple-50 rounded hover:bg-purple-100 cursor-pointer">
                                    <input type="radio" name="paymentMethod" id="paymentStripe" value="stripe" checked class="text-purple-600" onchange="updatePaymentMethodsDisplay()" />
                                    <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path>
                            </svg>
                                    <span class="text-sm font-medium">Stripe</span>
                                </label>
                                <label class="flex items-center gap-2 p-2 border border-gray-200 rounded hover:bg-gray-50 cursor-pointer">
                                    <input type="radio" name="paymentMethod" id="paymentCash" value="cash" class="text-purple-600" onchange="updatePaymentMethodsDisplay()" />
                                    <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path>
                                    </svg>
                                    <span class="text-sm font-medium">Cash</span>
                                </label>
                    </div>
                            <p class="text-xs text-gray-500 mt-2" id="paymentMethodHint">Select one payment method</p>
                </div>
                
                        <!-- Payment Terms Section -->
                        <div class="bg-white rounded-lg shadow-sm p-6">
                            <h2 class="text-lg font-semibold text-gray-900 mb-4">Payment Terms</h2>
                            
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Default Payment Terms</label>
                                    <select 
                                        id="defaultPaymentTerms"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                                    >
                                        <option value="due_on_receipt">Due on Receipt</option>
                                        <option value="net_7">Net 7 Days</option>
                                        <option value="net_15">Net 15 Days</option>
                                        <option value="net_30" selected>Net 30 Days</option>
                                        <option value="net_60">Net 60 Days</option>
                                    </select>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Payment Instructions</label>
                                    <textarea 
                                        id="paymentInstructions"
                                        rows="3"
                                        placeholder="Payment instructions, terms, or special notes..."
                                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                                    ></textarea>
                </div>
            </div>
                        </div>
                    </div>

                    <!-- Right Column - Summary -->
                    <div class="space-y-4">
                        <div class="bg-white rounded-lg shadow-sm p-4 sticky top-4">
                            <h2 class="text-lg font-semibold text-gray-900 mb-4">Payment Configuration Summary</h2>
                            
                            <div class="space-y-3 mb-4">
                                <div class="p-3 bg-purple-50 rounded-lg">
                                    <div class="text-xs text-purple-600 mb-1">Payment Model</div>
                                    <div class="text-lg font-bold text-purple-700" id="paymentModelDisplay">Full Payment</div>
                                </div>

                                <div class="space-y-2 text-sm">
                                    <div id="depositInfo" class="hidden">
                                        <div class="flex justify-between text-xs">
                                            <span class="text-gray-600">Deposit Amount</span>
                                            <span class="text-gray-900 font-semibold" id="depositAmountDisplay">$0.00</span>
                                        </div>
                                        <div class="flex justify-between text-xs">
                                            <span class="text-gray-600">Remaining Balance</span>
                                            <span class="text-gray-600" id="remainingBalanceDisplay">$0.00</span>
                                        </div>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Payment Terms</span>
                                        <span class="text-gray-900 font-medium" id="paymentTermsDisplay">Net 30 Days</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Payment Methods</span>
                                        <span class="text-gray-900 font-medium" id="paymentMethodsDisplay">Stripe</span>
                                    </div>
                                </div>
                            </div>

                            <div class="mt-4 p-3 bg-blue-50 rounded-lg">
                                <p class="text-xs text-blue-800">
                                    <strong>Payment Configuration</strong><br>
                                    These preferences will be saved with the quote and used when invoices are created later.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Invoices Tab Content -->
            <div id="invoicesContent" class="tab-content hidden">
                <div class="bg-white rounded-lg shadow-sm p-6">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center">
                            <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                        </div>
                        <div>
                            <h2 class="text-lg font-bold text-gray-900">Invoices</h2>
                            <p class="text-xs text-gray-500">Invoices will be available after this quote is created.</p>
                        </div>
                    </div>

                    <div class="border border-dashed border-gray-300 rounded-lg p-6 bg-gray-50 text-center">
                        <p class="text-sm text-gray-600 mb-2">Once the quote is approved and created, you'll be able to:</p>
                        <ul class="text-sm text-gray-600 space-y-1 max-w-md mx-auto text-left">
                            <li>‚Ä¢ Generate invoices based on your payment configuration</li>
                            <li>‚Ä¢ Track payments and outstanding balances</li>
                            <li>‚Ä¢ Send invoices and reminders to customers</li>
                        </ul>
                    </div>

                    <button class="mt-6 px-4 py-2 bg-gray-200 text-gray-600 rounded-lg cursor-not-allowed text-sm font-medium">
                        Create Invoices (Available after quote creation)
                    </button>
        </div>
    </div>

    <!-- Price Modification Modal -->
    <div id="priceModModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
            <div class="p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-900">Modify Price</h3>
                    <button id="closePriceModModal" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                
                <div class="mb-4">
                    <div class="flex items-center gap-2 mb-2">
                        <p class="text-sm font-medium text-gray-900" id="priceModItemName"></p>
                        <span id="priceModItemType"></span>
                    </div>
                    <div class="flex items-center gap-2 text-sm">
                        <span class="text-gray-600">Original Price:</span>
                        <span class="font-medium" id="priceModOriginal"></span>
                    </div>
                    <div class="flex items-center gap-2 text-sm mt-1">
                        <span class="text-gray-600">New Price:</span>
                        <span class="font-semibold text-blue-600" id="priceModNew"></span>
                    </div>
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Reason for modification <span class="text-red-600">*</span></label>
                    <textarea 
                        id="priceModComment"
                        rows="3"
                        placeholder="Enter reason for price modification (required for record keeping)"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                    ></textarea>
                </div>
                
                <div class="flex gap-3">
                    <button id="cancelPriceModBtn" class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 text-sm font-medium">
                        Cancel
                    </button>
                    <button id="savePriceModBtn" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm font-medium">
                        Save Changes
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // State management
        const state = {
            businessType: 'tutoring',
            selectedCustomer: null,
            selectedQuoteContact: null, // Will store the contact for this quote (primary or secondary)
            showNewCustomerForm: false,
            quoteItems: [],
            currentPriceModIndex: null,
            currentPriceModNewValue: null
        };

        // Sample data - Customers A-Z
        const customers = [
            { 
                id: 1, 
                name: 'Alice Anderson', 
                email: 'alice.a@email.com', 
                phone: '0412 345 678', 
                address: '1 Albert St, Melbourne VIC 3000', 
                previousQuotes: 3,
                secondaryContacts: [
                    { name: 'John Anderson', email: 'john.a@email.com', phone: '0412 345 679', role: 'Spouse' }
                ]
            },
            { 
                id: 2, 
                name: 'Bob Brown', 
                email: 'bob.brown@email.com', 
                phone: '0413 456 789', 
                address: '2 Bridge Rd, Richmond VIC 3121', 
                previousQuotes: 5,
                secondaryContacts: [
                    { name: 'Sarah Brown', email: 'sarah.b@email.com', phone: '0413 456 790', role: 'Assistant' },
                    { name: 'Mike Brown', email: 'mike.b@email.com', phone: '0413 456 791', role: 'Business Partner' }
                ]
            },
            { id: 3, name: 'Charlie Chen', email: 'charlie.c@email.com', phone: '0414 567 890', address: '3 Chapel St, Windsor VIC 3181', previousQuotes: 2 },
            { id: 4, name: 'David Davis', email: 'david.d@email.com', phone: '0412 444 444', address: '4 Docklands Dr, Docklands VIC 3008', previousQuotes: 0 },
            { id: 5, name: 'Emily Evans', email: 'emily.evans@email.com', phone: '0412 555 555', address: '5 Elizabeth St, Melbourne VIC 3000', previousQuotes: 2 },
            { id: 6, name: 'Frank Foster', email: 'frank.f@email.com', phone: '0412 666 666', address: '6 Flinders St, Melbourne VIC 3000', previousQuotes: 4 },
            { id: 7, name: 'Grace Garcia', email: 'grace.g@email.com', phone: '0412 777 777', address: '7 Glenferrie Rd, Hawthorn VIC 3122', previousQuotes: 1 },
            { id: 8, name: 'Henry Harris', email: 'henry.h@email.com', phone: '0412 888 888', address: '8 High St, Kew VIC 3101', previousQuotes: 6 },
            { id: 9, name: 'Isabella Ibrahim', email: 'isabella.i@email.com', phone: '0412 999 999', address: '9 Inkerman St, St Kilda VIC 3182', previousQuotes: 0 },
            { id: 10, name: 'James Johnson', email: 'james.j@email.com', phone: '0413 111 111', address: '10 Johnston St, Fitzroy VIC 3065', previousQuotes: 3 },
            { id: 11, name: 'Katherine Kim', email: 'kate.kim@email.com', phone: '0413 222 222', address: '11 King St, Melbourne VIC 3000', previousQuotes: 2 },
            { id: 12, name: 'Liam Lee', email: 'liam.lee@email.com', phone: '0413 333 333', address: '12 Lygon St, Carlton VIC 3053', previousQuotes: 7 },
            { id: 13, name: 'Maria Martinez', email: 'maria.m@email.com', phone: '0413 444 444', address: '13 Main Rd, Eltham VIC 3095', previousQuotes: 1 },
            { id: 14, name: 'Nathan Nguyen', email: 'nathan.n@email.com', phone: '0413 555 555', address: '14 Nicholson St, Fitzroy VIC 3065', previousQuotes: 4 },
            { id: 15, name: "Olivia O'Connor", email: 'olivia.o@email.com', phone: '0413 666 666', address: '15 Ormond Rd, Elwood VIC 3184', previousQuotes: 0 },
            { id: 16, name: 'Patrick Patel', email: 'patrick.p@email.com', phone: '0413 777 777', address: '16 Park St, South Melbourne VIC 3205', previousQuotes: 5 },
            { id: 17, name: 'Quinn Roberts', email: 'quinn.r@email.com', phone: '0413 888 888', address: '17 Queen St, Melbourne VIC 3000', previousQuotes: 2 },
            { id: 18, name: 'Rachel Robinson', email: 'rachel.r@email.com', phone: '0413 999 999', address: '18 Royal Pde, Parkville VIC 3052', previousQuotes: 3 },
            { id: 19, name: 'Samuel Smith', email: 'sam.smith@email.com', phone: '0414 111 111', address: '19 Smith St, Collingwood VIC 3066', previousQuotes: 8 },
            { id: 20, name: 'Taylor Thompson', email: 'taylor.t@email.com', phone: '0414 222 222', address: '20 Toorak Rd, South Yarra VIC 3141', previousQuotes: 1 },
            { id: 21, name: 'Uma Patel', email: 'uma.patel@email.com', phone: '0414 333 333', address: '21 Union St, Windsor VIC 3181', previousQuotes: 0 },
            { id: 22, name: 'Victor Vasquez', email: 'victor.v@email.com', phone: '0414 444 444', address: '22 Victoria St, Richmond VIC 3121', previousQuotes: 4 },
            { id: 23, name: 'Wendy White', email: 'wendy.w@email.com', phone: '0414 555 555', address: '23 Wellington St, St Kilda VIC 3182', previousQuotes: 2 },
            { id: 24, name: 'Xavier Xu', email: 'xavier.x@email.com', phone: '0414 666 666', address: '24 Xavier St, Kew VIC 3101', previousQuotes: 6 },
            { id: 25, name: 'Yasmin Young', email: 'yasmin.y@email.com', phone: '0414 777 777', address: '25 York St, South Melbourne VIC 3205', previousQuotes: 1 },
            { id: 26, name: 'Zachary Zhang', email: 'zach.zhang@email.com', phone: '0414 888 888', address: '26 Zoe St, Brunswick VIC 3056', previousQuotes: 3 }
        ];

        const tutoringServices = [
            // Services with GST (10% tax)
            { id: 't1', name: 'One-on-One Tutoring - Math', tag: 'Tutoring', type: 'service', price: 75, pricingType: 'per_hour', unit: 'hour', taxCategory: 'taxable_gst' },
            { id: 't2', name: 'One-on-One Tutoring - English', tag: 'Tutoring', type: 'service', price: 75, pricingType: 'per_hour', unit: 'hour', taxCategory: 'taxable_gst' },
            { id: 't3', name: 'Small Group (2-4 students)', tag: 'Group', type: 'service', price: 50, pricingType: 'per_hour', unit: 'hour', taxCategory: 'taxable_gst' },
            { id: 't4', name: 'Assessment & Report', tag: 'Assessment', type: 'service', price: 120, pricingType: 'fixed', unit: 'each', taxCategory: 'taxable_gst' },
            
            // Services GST-Free (0% tax)
            { id: 't5', name: 'Educational Counseling Service', tag: 'Support', type: 'service', price: 80, pricingType: 'per_hour', unit: 'hour', taxCategory: 'gst_free' },
            { id: 't6', name: 'Learning Disability Assessment', tag: 'Assessment', type: 'service', price: 150, pricingType: 'fixed', unit: 'each', taxCategory: 'gst_free' },
            
            // Services Input-Taxed (0% tax)
            { id: 't7', name: 'Tutoring Consultation Fee', tag: 'Consultation', type: 'service', price: 60, pricingType: 'fixed', unit: 'each', taxCategory: 'input_taxed' },
            
            // Products with GST (10% tax)
            { id: 'p1', name: 'Study Materials Package', tag: 'Materials', type: 'product', price: 45, pricingType: 'per_unit', unit: 'each', taxCategory: 'taxable_gst' },
            { id: 'p2', name: 'Textbook Bundle', tag: 'Materials', type: 'product', price: 120, pricingType: 'per_unit', unit: 'each', taxCategory: 'taxable_gst' },
            { id: 'p3', name: 'Practice Test Series', tag: 'Materials', type: 'product', price: 35, pricingType: 'per_unit', unit: 'each', taxCategory: 'taxable_gst' },
            
            // Products GST-Free (0% tax)
            { id: 'p4', name: 'Educational Books', tag: 'Materials', type: 'product', price: 25, pricingType: 'per_unit', unit: 'each', taxCategory: 'gst_free' },
            { id: 'p5', name: 'Basic Learning Materials', tag: 'Materials', type: 'product', price: 15, pricingType: 'per_unit', unit: 'each', taxCategory: 'gst_free' },
        ];

        // Helper functions
        function getServices() {
            return tutoringServices;
        }
        

        function getPricingIcon(type) {
            const icons = {
                'per_hour': `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`,
                'per_sqm': `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 5a1 1 0 011-1h4a1 1 0 011 1v7a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM14 5a1 1 0 011-1h4a1 1 0 011 1v7a1 1 0 01-1 1h-4a1 1 0 01-1-1V5zM4 16a1 1 0 011-1h4a1 1 0 011 1v3a1 1 0 01-1 1H5a1 1 0 01-1-1v-3zM14 16a1 1 0 011-1h4a1 1 0 011 1v3a1 1 0 01-1 1h-4a1 1 0 01-1-1v-3z"></path></svg>`,
                'per_unit': `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path></svg>`,
                'fixed': `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`
            };
            return icons[type] || icons['fixed'];
        }

        function getTypeIndicator(type) {
            if (type === 'product') {
                return '<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800">üü¢ Product</span>';
            }
            return '<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800">üîµ Service</span>';
        }

        // Tax rate lookup based on tax category
        function getTaxRate(taxCategory) {
            const taxRates = {
                'taxable_gst': 0.10,    // 10% GST
                'gst_free': 0.00,       // 0% GST-free
                'input_taxed': 0.00     // 0% Input-taxed (no GST on output, but special reporting)
            };
            return taxRates[taxCategory] || 0.10; // Default to 10% if category not found
        }

        function getTaxCategoryLabel(taxCategory) {
            const labels = {
                'taxable_gst': 'Taxable (10% GST)',
                'gst_free': 'GST-Free (0%)',
                'input_taxed': 'Input-Taxed (0%)'
            };
            return labels[taxCategory] || 'Standard (10%)';
        }

        // Calculate tax for each line item based on its tax category
        function calculateLineItemTax(item) {
            const taxRate = getTaxRate(item.taxCategory);
            const lineTotal = item.customPrice * item.quantity;
            return lineTotal * taxRate;
        }

        // Calculation functions
        function calculateSubtotal() {
            return state.quoteItems.reduce((sum, item) => {
                const lineTotal = item.customPrice * item.quantity;
                const discountAmount = item.discountType === 'percentage' 
                    ? lineTotal * (item.discount / 100)
                    : item.discount;
                return sum + (lineTotal - discountAmount);
            }, 0);
        }

        function calculateTax() {
            // Calculate tax per line item based on their tax categories
            return state.quoteItems.reduce((sum, item) => {
                return sum + calculateLineItemTax(item);
            }, 0);
        }

        function calculateTotal() {
            return calculateSubtotal() + calculateTax();
        }
        
        // Calculate total line item discounts
        function calculateLineItemDiscounts() {
            return state.quoteItems.reduce((sum, item) => {
                const lineTotal = item.customPrice * item.quantity;
                const discountAmount = item.discountType === 'percentage' 
                    ? lineTotal * (item.discount / 100)
                    : item.discount;
                return sum + discountAmount;
            }, 0);
        }
        
        // Get tax breakdown by category
        function getTaxBreakdown() {
            const breakdown = {
                taxable_gst: 0,
                gst_free: 0,
                input_taxed: 0
            };
            
            state.quoteItems.forEach(item => {
                const taxAmount = calculateLineItemTax(item);
                if (item.taxCategory && breakdown.hasOwnProperty(item.taxCategory)) {
                    breakdown[item.taxCategory] += taxAmount;
                } else {
                    breakdown.taxable_gst += taxAmount; // Default
                }
            });
            
            return breakdown;
        }

        function updateSummary() {
            const netSubtotal = calculateSubtotal();
            const lineItemDiscounts = calculateLineItemDiscounts();
            const grossSubtotal = netSubtotal + lineItemDiscounts;
            document.getElementById('subtotalAmount').textContent = `$${grossSubtotal.toFixed(2)}`;
            
            // Update line item discounts display
            const lineItemDiscountSection = document.getElementById('lineItemDiscountSection');
            if (lineItemDiscounts > 0) {
                lineItemDiscountSection.classList.remove('hidden');
                document.getElementById('lineItemDiscountAmount').textContent = `-$${lineItemDiscounts.toFixed(2)}`;
            } else {
                lineItemDiscountSection.classList.add('hidden');
            }
            
            document.getElementById('totalAmount').textContent = `$${calculateTotal().toFixed(2)}`;

            // Calculate and display tax breakdown by category
            const taxBreakdown = getTaxBreakdown();
            const taxBreakdownContainer = document.getElementById('taxBreakdown');
            
            let taxBreakdownHTML = '';
            if (taxBreakdown.taxable_gst > 0) {
                taxBreakdownHTML += `<div class="flex justify-between"><span>GST (10%):</span><span>$${taxBreakdown.taxable_gst.toFixed(2)}</span></div>`;
            }
            if (taxBreakdown.gst_free > 0) {
                taxBreakdownHTML += `<div class="flex justify-between text-gray-500"><span>GST-Free:</span><span>$0.00</span></div>`;
            }
            if (taxBreakdown.input_taxed > 0) {
                taxBreakdownHTML += `<div class="flex justify-between text-gray-500"><span>Input-Taxed:</span><span>$0.00</span></div>`;
            }
            
            taxBreakdownContainer.innerHTML = taxBreakdownHTML || '<div class="text-gray-400">No taxable items</div>';
            
            // Total tax
            const totalTax = calculateTax();
            document.getElementById('taxAmount').textContent = `$${totalTax.toFixed(2)}`;
            
            updateCreateButton();
        }

        function updateCreateButton() {
            const createBtn = document.getElementById('createQuoteBtn');
            const canCreate = state.quoteItems.length > 0 && state.selectedCustomer !== null;
            createBtn.disabled = !canCreate;
        }

        // ============================================================================
        // TAB & PAYMENT CONFIGURATION HELPERS
        // ============================================================================

        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active', 'border-blue-500', 'text-blue-600');
                button.classList.add('border-transparent', 'text-gray-500');
            });

            const activeContent = document.getElementById(`${tabName}Content`);
            if (activeContent) activeContent.classList.remove('hidden');

            const activeButton = document.getElementById(`${tabName}Tab`);
            if (activeButton) {
                activeButton.classList.add('active', 'border-blue-500', 'text-blue-600');
                activeButton.classList.remove('border-transparent', 'text-gray-500');
            }
        }

        function updatePaymentModel() {
            const model = document.querySelector('input[name="paymentModel"]:checked').value;
            const depositSection = document.getElementById('paymentDepositSection');
            const subscriptionSection = document.getElementById('subscriptionSection');
            const depositInfo = document.getElementById('depositInfo');
            const paymentModelDisplay = document.getElementById('paymentModelDisplay');

            if (depositSection) depositSection.classList.toggle('hidden', model !== 'deposit');
            if (depositInfo) depositInfo.classList.toggle('hidden', model !== 'deposit');
            if (subscriptionSection) subscriptionSection.classList.toggle('hidden', model !== 'subscription');

            if (paymentModelDisplay) {
                paymentModelDisplay.textContent = model === 'deposit' ? 'Down Payment' : model === 'subscription' ? 'Subscription' : 'Full Payment';
            }

            // Get payment method elements
            const stripeRadio = document.getElementById('paymentStripe');
            const cashRadio = document.getElementById('paymentCash');
            const cashLabel = cashRadio ? cashRadio.closest('label') : null;
            const paymentMethodHint = document.getElementById('paymentMethodHint');

            if (model === 'subscription') {
                calculateNextInvoiceDate();
                
                // Disable Cash for subscription - only Stripe is supported
                if (cashRadio) {
                    cashRadio.disabled = true;
                    if (cashRadio.checked) {
                        // If Cash was selected, switch to Stripe
                        if (stripeRadio) {
                            stripeRadio.checked = true;
                            updatePaymentMethodsDisplay();
                        }
                    }
                    if (cashLabel) {
                        cashLabel.classList.add('opacity-50', 'cursor-not-allowed');
                        cashLabel.classList.remove('cursor-pointer', 'hover:bg-gray-50');
                    }
                }
                // Ensure Stripe is selected
                if (stripeRadio && !stripeRadio.checked) {
                    stripeRadio.checked = true;
                    updatePaymentMethodsDisplay();
                }
                if (paymentMethodHint) {
                    paymentMethodHint.textContent = 'Subscription requires Stripe for automatic recurring charges. Cash is not supported.';
                    paymentMethodHint.classList.add('text-orange-600');
                }
            } else {
                // Enable both payment methods for full payment and deposit
                if (cashRadio) {
                    cashRadio.disabled = false;
                    if (cashLabel) {
                        cashLabel.classList.remove('opacity-50', 'cursor-not-allowed');
                        cashLabel.classList.add('cursor-pointer');
                    }
                }
                if (paymentMethodHint) {
                    paymentMethodHint.textContent = 'Select one payment method';
                    paymentMethodHint.classList.remove('text-orange-600');
                }
            }

            autoSavePaymentConfiguration();
        }

        function toggleEndDate() {
            const endType = document.getElementById('subscriptionEnd').value;
            const cyclesInput = document.getElementById('cyclesInput');
            const endDateInput = document.getElementById('endDateInput');
            
            if (cyclesInput) cyclesInput.classList.toggle('hidden', endType !== 'after_cycles');
            if (endDateInput) endDateInput.classList.toggle('hidden', endType !== 'end_date');

            autoSavePaymentConfiguration();
        }

        function calculateNextInvoiceDate() {
            const startDateValue = document.getElementById('subscriptionStartDate')?.value;
            const frequency = document.getElementById('billingFrequency')?.value || 'monthly';
            const display = document.getElementById('nextInvoiceDate');

            if (!startDateValue || !display) {
                if (display) display.textContent = '-';
                return;
            }

            const nextDate = new Date(startDateValue);
            switch(frequency) {
                case 'weekly':
                    nextDate.setDate(nextDate.getDate() + 7);
                    break;
                case 'biweekly':
                    nextDate.setDate(nextDate.getDate() + 14);
                    break;
                case 'monthly':
                    nextDate.setMonth(nextDate.getMonth() + 1);
                    break;
                case 'quarterly':
                    nextDate.setMonth(nextDate.getMonth() + 3);
                    break;
                case 'yearly':
                    nextDate.setFullYear(nextDate.getFullYear() + 1);
                    break;
            }

            display.textContent = nextDate.toLocaleDateString();
            autoSavePaymentConfiguration();
        }

        function updateDepositCalculation() {
            const depositAmount = parseFloat(document.getElementById('depositAmount')?.value) || 0;
            const total = calculateTotal();
            const percentage = total > 0 ? (depositAmount / total) * 100 : 0;
            const remaining = Math.max(0, total - depositAmount);

            const depositPercentageEl = document.getElementById('depositPercentage');
            if (depositPercentageEl) depositPercentageEl.value = Math.round(percentage);
            const remainingBalance = document.getElementById('remainingBalance');
            if (remainingBalance) remainingBalance.textContent = `$${remaining.toFixed(2)}`;
            const depositAmountDisplay = document.getElementById('depositAmountDisplay');
            if (depositAmountDisplay) depositAmountDisplay.textContent = `$${depositAmount.toFixed(2)}`;
            const remainingBalanceDisplay = document.getElementById('remainingBalanceDisplay');
            if (remainingBalanceDisplay) remainingBalanceDisplay.textContent = `$${remaining.toFixed(2)}`;

            autoSavePaymentConfiguration();
        }

        function updateDepositFromPercentage() {
            const percentage = parseFloat(document.getElementById('depositPercentage')?.value) || 0;
            const total = calculateTotal();
            const depositAmount = total * (percentage / 100);
            const depositAmountEl = document.getElementById('depositAmount');
            if (depositAmountEl) depositAmountEl.value = depositAmount.toFixed(2);
            updateDepositCalculation();
        }

        function setDepositPercentage(percent) {
            const depositPercentageEl = document.getElementById('depositPercentage');
            if (depositPercentageEl) depositPercentageEl.value = percent;
            updateDepositFromPercentage();
        }

        function updatePaymentTermsDisplay() {
            const termsMap = {
                'due_on_receipt': 'Due on Receipt',
                'net_7': 'Net 7 Days',
                'net_15': 'Net 15 Days',
                'net_30': 'Net 30 Days',
                'net_60': 'Net 60 Days'
            };
            const terms = document.getElementById('defaultPaymentTerms')?.value || 'net_30';
            const display = document.getElementById('paymentTermsDisplay');
            if (display) display.textContent = termsMap[terms] || 'Net 30 Days';
        }

        function updatePaymentMethodsDisplay() {
            const selectedRadio = document.querySelector('#paymentMethodsContainer input[type="radio"]:checked');
            const selectedMethod = selectedRadio ? selectedRadio.value : 'none';
            const displayText = selectedMethod === 'stripe' ? 'Stripe' : selectedMethod === 'cash' ? 'Cash' : 'Select a method';

            const display = document.getElementById('paymentMethodsDisplay');
            if (display) display.textContent = displayText;
            const hint = document.getElementById('paymentMethodHint');
            const paymentModel = document.querySelector('input[name="paymentModel"]:checked')?.value;
            // Only update hint if not subscription (subscription has its own message)
            if (hint && paymentModel !== 'subscription') {
                hint.textContent = selectedMethod ? `Primary method: ${displayText}` : 'Select one payment method';
            }

            autoSavePaymentConfiguration();
        }

        function autoSavePaymentConfiguration() {
            const paymentModel = document.querySelector('input[name="paymentModel"]:checked');
            if (!paymentModel) return; // Skip if not selected yet
            
            // Get selected payment method (single selection)
            const selectedPaymentMethod = document.querySelector('input[name="paymentMethod"]:checked');
            const paymentMethod = selectedPaymentMethod ? selectedPaymentMethod.value : null;
            
            const paymentConfig = {
                paymentModel: paymentModel.value,
                paymentMethod: paymentMethod,
                paymentTerms: document.getElementById('defaultPaymentTerms')?.value,
                paymentInstructions: document.getElementById('paymentInstructions')?.value
            };
            
            // Add subscription data if applicable
            if (paymentModel.value === 'subscription') {
                const startDate = document.getElementById('subscriptionStartDate')?.value;
                
                paymentConfig.subscription = {
                    frequency: document.getElementById('billingFrequency')?.value,
                    startDate: startDate,
                    endType: document.getElementById('subscriptionEnd')?.value,
                    autoCharge: document.getElementById('autoCharge')?.checked
                };
                
                const endType = document.getElementById('subscriptionEnd')?.value;
                if (endType === 'after_cycles') {
                    const cycles = parseInt(document.getElementById('billingCycles')?.value);
                    if (cycles && cycles > 0) {
                        paymentConfig.subscription.billingCycles = cycles;
                    }
                } else if (endType === 'end_date') {
                    const endDate = document.getElementById('subscriptionEndDate')?.value;
                    if (endDate) {
                        paymentConfig.subscription.endDate = endDate;
                    }
                }
            }
            
            // Add deposit data if applicable
            if (paymentModel.value === 'deposit') {
                const depositAmount = parseFloat(document.getElementById('depositAmount')?.value) || 0;
                if (depositAmount > 0) {
                    paymentConfig.deposit = {
                        amount: depositAmount,
                        percentage: parseFloat(document.getElementById('depositPercentage')?.value) || 0
                    };
                }
            }
            
            console.log('Auto-saving payment configuration:', paymentConfig);
            
            // In real implementation, save to server silently
            // await fetch('/api/quotes/payment-config', { method: 'POST', body: JSON.stringify(paymentConfig) });
        }

        // Render functions
        function renderCustomerAutocomplete(searchTerm = '') {
            const autocomplete = document.getElementById('customerAutocomplete');
            const clearBtn = document.getElementById('clearSearchBtn');
            
            if (!searchTerm || searchTerm.length < 2) {
                autocomplete.classList.add('hidden');
                clearBtn.classList.add('hidden');
                return;
            }
            
            clearBtn.classList.remove('hidden');
            
            const filtered = customers.filter(c => 
                c.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                c.email.toLowerCase().includes(searchTerm.toLowerCase()) ||
                c.phone.includes(searchTerm)
            );

            if (filtered.length === 0) {
                autocomplete.innerHTML = `
                    <div class="p-3 text-sm text-gray-500 text-center">
                        No customers found. <button onclick="document.getElementById('toggleNewCustomerBtn').click()" class="text-blue-600 hover:underline">Create new customer</button>
                    </div>
                `;
                autocomplete.classList.remove('hidden');
                return;
            }

            autocomplete.innerHTML = filtered.map(customer => `
                <div 
                    class="p-3 hover:bg-blue-50 cursor-pointer border-b border-gray-100 last:border-b-0"
                    onclick="selectCustomer(${customer.id})"
                >
                    <div class="flex items-center justify-between">
                        <div class="flex-1">
                            <p class="font-medium text-gray-900 text-sm">${customer.name}</p>
                            <p class="text-xs text-gray-600 mt-0.5">${customer.email}</p>
                            <p class="text-xs text-gray-500">${customer.phone}</p>
                        </div>
                        ${customer.previousQuotes > 0 ? `
                            <span class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded">${customer.previousQuotes} quotes</span>
                        ` : ''}
                    </div>
                </div>
            `).join('');
            
            autocomplete.classList.remove('hidden');
        }

        function renderCatalogAutocomplete(searchTerm = '') {
            const autocomplete = document.getElementById('catalogAutocomplete');
            const clearBtn = document.getElementById('clearCatalogSearchBtn');
            
            if (!searchTerm || searchTerm.length < 2) {
                autocomplete.classList.add('hidden');
                clearBtn.classList.add('hidden');
                return;
            }
            
            clearBtn.classList.remove('hidden');
            
            const services = getServices().filter(service => 
                service.name.toLowerCase().includes(searchTerm.toLowerCase()) || 
                service.id.toLowerCase().includes(searchTerm.toLowerCase()) ||
                service.tag.toLowerCase().includes(searchTerm.toLowerCase())
            );

            if (services.length === 0) {
                autocomplete.innerHTML = `
                    <div class="p-3 text-sm text-gray-500 text-center">
                        No services or products found.
                    </div>
                `;
                autocomplete.classList.remove('hidden');
                return;
            }

            autocomplete.innerHTML = services.map(service => `
                <div 
                    class="p-3 hover:bg-blue-50 cursor-pointer border-b border-gray-100 last:border-b-0"
                    onclick="addQuoteItem('${service.id}')"
                >
                    <div class="flex items-center justify-between">
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-1">
                                ${getTypeIndicator(service.type)}
                                <span class="text-xs bg-gray-100 text-gray-700 px-2 py-0.5 rounded">${service.tag}</span>
                            </div>
                            <p class="font-medium text-gray-900 text-sm">${service.name}</p>
                            <p class="text-xs text-gray-500 mt-0.5">${service.id}</p>
                        </div>
                        <div class="text-right ml-3">
                            <div class="flex items-center gap-1 text-gray-700">
                                <span class="text-sm font-semibold">$${service.price}</span>
                                <span class="text-xs text-gray-500">/ ${service.unit}</span>
                            </div>
                            <div class="text-xs text-gray-500 mt-0.5">${getTaxCategoryLabel(service.taxCategory || 'taxable_gst')}</div>
                        </div>
                    </div>
                </div>
            `).join('');
            
            autocomplete.classList.remove('hidden');
        }

        function renderQuoteItems() {
            const emptyState = document.getElementById('emptyQuoteState');
            const container = document.getElementById('quoteItemsContainer');
            
            if (state.quoteItems.length === 0) {
                emptyState.classList.remove('hidden');
                container.classList.add('hidden');
                return;
            }
            
            emptyState.classList.add('hidden');
            container.classList.remove('hidden');
            
            container.innerHTML = state.quoteItems.map((item, index) => {
                // Show tax category
                let taxBadge = '';
                if (item.taxCategory) {
                    const taxLabels = {
                        'taxable_gst': '<span class="inline-flex items-center px-1.5 py-0.5 rounded text-xs bg-blue-50 text-blue-700">üìã GST (10%)</span>',
                        'gst_free': '<span class="inline-flex items-center px-1.5 py-0.5 rounded text-xs bg-gray-50 text-gray-600">GST-Free</span>',
                        'input_taxed': '<span class="inline-flex items-center px-1.5 py-0.5 rounded text-xs bg-gray-50 text-gray-600">Input-Taxed</span>'
                    };
                    taxBadge = taxLabels[item.taxCategory] || '';
                }
                
                const lineTotal = item.quantity * item.customPrice;
                const discountAmount = item.discountType === 'percentage' 
                    ? lineTotal * (item.discount / 100)
                    : item.discount;
                const lineTotalAfterDiscount = lineTotal - discountAmount;
                
                return `
                <div class="bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                    <!-- Header Row -->
                    <div class="flex items-start justify-between mb-3">
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-1">
                                <h3 class="font-semibold text-gray-900">${item.name}</h3>
                            </div>
                            <div class="flex items-center gap-2">
                                ${getTypeIndicator(item.type)}
                                ${taxBadge}
                            </div>
                            ${item.priceModificationComment ? `
                                <div class="mt-2 text-xs text-yellow-700 bg-yellow-50 px-2 py-1 rounded">
                                    üí¨ ${item.priceModificationComment}
                                </div>
                            ` : ''}
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="text-right space-y-0.5">
                                ${item.discount > 0 ? `
                                    <div class="text-xs text-gray-500">Original: $${lineTotal.toFixed(2)}</div>
                                    <div class="text-xs text-green-600">Discount: -$${discountAmount.toFixed(2)}</div>
                                ` : ''}
                                <div class="text-2xl font-bold text-gray-900">$${lineTotalAfterDiscount.toFixed(2)}</div>
                            </div>
                            <button 
                                onclick="removeQuoteItem(${index})"
                                class="ml-2 p-2 text-red-600 hover:bg-red-50 rounded-lg transition-colors"
                                title="Remove item"
                            >
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Details Grid -->
                    <div class="grid grid-cols-12 gap-3 mb-3 pb-3 border-b border-gray-200">
                        <div class="col-span-3">
                            <label class="text-xs text-gray-500 block mb-1">${item.type === 'product' ? 'Delivery Date' : 'Service Date'} <span class="text-red-500">*</span></label>
                            <input 
                                type="date"
                                value="${item.serviceDate || ''}"
                                onchange="updateItemServiceDate(${index}, this.value)"
                                class="w-full px-2 py-1.5 border border-gray-300 rounded text-sm"
                            />
                        </div>
                        <div class="col-span-2">
                            <label class="text-xs text-gray-500 block mb-1">Quantity <span class="text-red-500">*</span></label>
                            <input 
                                type="number"
                                value="${item.quantity}"
                                onchange="updateItemQuantity(${index}, this.value)"
                                class="w-full px-2 py-1.5 border border-gray-300 rounded text-sm text-center"
                                min="1"
                            />
                        </div>
                        <div class="col-span-3">
                            <label class="text-xs text-gray-500 block mb-1">Unit Price</label>
                            <input 
                                type="number"
                                value="${item.customPrice}"
                                onchange="updateItemPrice(${index}, this.value)"
                                class="w-full px-2 py-1.5 border ${item.priceModified ? 'border-yellow-500 bg-yellow-50' : 'border-gray-300'} rounded text-sm text-right"
                                min="0"
                                step="0.01"
                            />
                            ${item.priceModified ? `<span class="text-xs text-yellow-600">Modified</span>` : ''}
                        </div>
                        <div class="col-span-4">
                            <label class="text-xs text-gray-500 block mb-1">Discount</label>
                            <div class="flex gap-2">
                                <select 
                                    onchange="updateItemDiscountType(${index}, this.value)"
                                    class="w-16 px-2 py-1.5 border border-gray-300 rounded text-sm"
                                >
                                    <option value="percentage" ${item.discountType === 'percentage' ? 'selected' : ''}>%</option>
                                    <option value="fixed" ${item.discountType === 'fixed' ? 'selected' : ''}>$</option>
                                </select>
                                <input 
                                    type="number"
                                    value="${item.discount || 0}"
                                    onchange="updateItemDiscount(${index}, this.value)"
                                    class="flex-1 px-2 py-1.5 border border-gray-300 rounded text-sm text-right"
                                    min="0"
                                    step="0.01"
                                />
                            </div>
                        </div>
                    </div>
                    
                    <!-- Notes Section -->
                    <div class="mb-3">
                        <label class="text-xs text-gray-500 block mb-1">Notes</label>
                        <textarea 
                            placeholder="${item.type === 'product' ? 'Delivery instructions, quantity details, etc...' : 'Service requirements, special instructions, etc...'}"
                            onchange="updateItemNotes(${index}, this.value)"
                            class="w-full px-3 py-2 border border-gray-300 rounded text-sm resize-none"
                            rows="2"
                        >${item.notes || ''}</textarea>
                    </div>
                </div>
            `;
            }).join('');
        }

        // Event handlers
        function selectCustomer(customerId) {
            const customer = customers.find(c => c.id === customerId);
            state.selectedCustomer = customer;
            
            // Hide search, show selected card
            const searchInput = document.getElementById('customerSearchInput');
            searchInput.value = '';
            searchInput.classList.remove('border-red-300');
            searchInput.classList.add('border-green-500');
            document.getElementById('customerAutocomplete').classList.add('hidden');
            document.getElementById('clearSearchBtn').classList.add('hidden');
            document.getElementById('customerSearchSection').classList.add('hidden');
            document.getElementById('selectedCustomerCard').classList.remove('hidden');
            
            // Populate customer info
            document.getElementById('selectedCustomerName').textContent = customer.name;
            document.getElementById('selectedCustomerEmail').textContent = customer.email;
            document.getElementById('selectedCustomerPhone').textContent = customer.phone;
            
            // Setup quote contact selector if secondary contacts exist
            const contactSelector = document.getElementById('quoteContactSelector');
            const contactSelect = document.getElementById('quoteContactSelect');
            
            if (customer.secondaryContacts && customer.secondaryContacts.length > 0) {
                // Show contact selector
                contactSelector.classList.remove('hidden');
                
                // Build options: primary contact + secondary contacts
                let options = `<option value="primary">Primary: ${customer.name} (${customer.email})</option>`;
                customer.secondaryContacts.forEach((contact, index) => {
                    options += `<option value="secondary-${index}">${contact.name} - ${contact.role} (${contact.email})</option>`;
                });
                contactSelect.innerHTML = options;
                
                // Set default to primary
                state.selectedQuoteContact = {
                    type: 'primary',
                    name: customer.name,
                    email: customer.email,
                    phone: customer.phone
                };
            } else {
                // Hide contact selector, use primary by default
                contactSelector.classList.add('hidden');
                state.selectedQuoteContact = {
                    type: 'primary',
                    name: customer.name,
                    email: customer.email,
                    phone: customer.phone
                };
            }
            
            // Set service address (same as billing by default)
            document.getElementById('displayServiceAddress').textContent = customer.address || 'No address on file';
            document.getElementById('sameAsBilling').checked = true;
            document.getElementById('serviceAddressFields').classList.add('hidden');
            document.getElementById('serviceAddressDisplay').style.display = 'block';
            
            updateCreateButton();
        }

        function addQuoteItem(serviceId) {
            const services = getServices();
            const service = services.find(s => s.id === serviceId);
            
            if (!service) return;
            
            const newItem = {
                ...service,
                quantity: 1,
                customPrice: service.price,
                originalPrice: service.price,
                priceModified: false,
                priceModificationComment: '',
                notes: '',
                serviceDate: '',
                discount: 0,
                discountType: 'percentage',
                // Schedule fields (only for services)
                preferredTime: '',
                exactTime: '',
                scheduleNotes: ''
            };
            
            state.quoteItems.push(newItem);
            renderQuoteItems();
            updateSummary();
            
            // Clear catalog search after adding
            document.getElementById('catalogSearchInput').value = '';
            document.getElementById('catalogAutocomplete').classList.add('hidden');
            document.getElementById('clearCatalogSearchBtn').classList.add('hidden');
        }

        function removeQuoteItem(index) {
            state.quoteItems.splice(index, 1);
            renderQuoteItems();
            updateSummary();
        }

        function updateItemQuantity(index, value) {
            state.quoteItems[index].quantity = Number(value);
            renderQuoteItems();
            updateSummary();
        }

        function updateItemServiceDate(index, value) {
            state.quoteItems[index].serviceDate = value;
            renderQuoteItems();
        }

        function updateItemNotes(index, value) {
            state.quoteItems[index].notes = value;
        }

        function updateItemDiscount(index, value) {
            state.quoteItems[index].discount = Number(value);
            renderQuoteItems();
            updateSummary();
        }

        function updateItemDiscountType(index, value) {
            state.quoteItems[index].discountType = value;
            renderQuoteItems();
            updateSummary();
        }

        function updateItemPreferredTime(index, value) {
            state.quoteItems[index].preferredTime = value;
            renderQuoteItems();
        }

        function updateItemExactTime(index, value) {
            state.quoteItems[index].exactTime = value;
        }

        function updateItemScheduleNotes(index, value) {
            state.quoteItems[index].scheduleNotes = value;
        }

        function showPriceModModal(index, newPrice) {
            const item = state.quoteItems[index];
            state.currentPriceModIndex = index;
            state.currentPriceModNewValue = newPrice;
            
            // Populate modal with item details
            document.getElementById('priceModItemName').textContent = item.name;
            
            // Set item type badge
            const typeBadge = document.getElementById('priceModItemType');
            if (item.type === 'product') {
                typeBadge.innerHTML = '<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800">üü¢ Product</span>';
            } else {
                typeBadge.innerHTML = '<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800">üîµ Service</span>';
            }
            
            document.getElementById('priceModOriginal').textContent = `$${item.originalPrice.toFixed(2)}`;
            document.getElementById('priceModNew').textContent = `$${Number(newPrice).toFixed(2)}`;
            document.getElementById('priceModComment').value = '';
            
            // Show modal
            document.getElementById('priceModModal').classList.remove('hidden');
        }

        function hidePriceModModal() {
            document.getElementById('priceModModal').classList.add('hidden');
            state.currentPriceModIndex = null;
            state.currentPriceModNewValue = null;
            document.getElementById('priceModComment').value = '';
        }

        function updateItemPrice(index, value) {
            const item = state.quoteItems[index];
            const newPrice = Number(value);
            const originalPrice = item.price;
            
            // Check if price is being modified from original
            if (newPrice !== originalPrice && !item.priceModified) {
                // Show modal to get reason
                showPriceModModal(index, newPrice);
                return;
            }
            
            item.customPrice = newPrice;
            renderQuoteItems();
            updateSummary();
        }

        function confirmPriceModification() {
            const comment = document.getElementById('priceModComment').value.trim();
            
            if (!comment) {
                alert('Please provide a reason for the price modification');
                return;
            }
            
            if (state.currentPriceModIndex !== null) {
                const item = state.quoteItems[state.currentPriceModIndex];
                item.priceModified = true;
                item.priceModificationComment = comment;
                item.customPrice = state.currentPriceModNewValue;
                
                renderQuoteItems();
                updateSummary();
                hidePriceModModal();
            }
        }

        function cancelPriceModification() {
            if (state.currentPriceModIndex !== null) {
                // Revert to original price
                const item = state.quoteItems[state.currentPriceModIndex];
                item.customPrice = item.originalPrice;
                
                renderQuoteItems();
                updateSummary();
                hidePriceModModal();
            }
        }

        function updateItemNotes(index, value) {
            state.quoteItems[index].notes = value;
        }

        // Load cloned quote data
        function loadClonedQuoteData(quoteId) {
            // In a real application, this would fetch from API
            // For now, using mock data from the quote list
            const mockQuoteData = {
                'Q-2024-001': {
                    customerId: 1,
                    customerName: 'Alice Anderson',
                    items: [
                        { id: 1, name: 'Math Tutoring - Grade 10', description: '4 sessions per month', quantity: 4, unitPrice: 50.00 },
                        { id: 2, name: 'Science Tutoring - Grade 10', description: '2 sessions per month', quantity: 2, unitPrice: 55.00 }
                    ],
                    notes: 'Original quote notes'
                },
                'Q-2024-002': {
                    customerId: 2,
                    customerName: 'Bob Brown',
                    items: [
                        { id: 1, name: 'English Tutoring', description: 'Weekly sessions', quantity: 4, unitPrice: 60.00 }
                    ],
                    notes: ''
                }
            };
            
            const quoteData = mockQuoteData[quoteId];
            if (!quoteData) return;
            
            // Pre-fill customer
            const customer = customers.find(c => c.id === quoteData.customerId);
            if (customer) {
                selectCustomer(customer);
            }
            
            // Pre-fill items
            quoteData.items.forEach(item => {
                state.quoteItems.push({
                    id: Date.now() + Math.random(),
                    name: item.name,
                    description: item.description,
                    quantity: item.quantity,
                    unitPrice: item.unitPrice,
                    total: item.quantity * item.unitPrice
                });
            });
            renderQuoteItems();
            updateTotals();
            
            // Pre-fill notes
            if (quoteData.notes) {
                document.getElementById('internalNotes').value = quoteData.notes;
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Check if cloning a quote
            const urlParams = new URLSearchParams(window.location.search);
            const cloneId = urlParams.get('clone');
            
            if (cloneId) {
                // Load the quote data to clone (in real app, fetch from API)
                loadClonedQuoteData(cloneId);
                // Update header to indicate cloning
                document.querySelector('h1').textContent = 'Clone Quote';
                document.querySelector('.bg-blue-100').innerHTML = 'üìã Clone from ' + cloneId;
            }
            
            // Set default valid until date (14 days from now)
            const validUntil = new Date();
            validUntil.setDate(validUntil.getDate() + 14);
            document.getElementById('validUntilDate').valueAsDate = validUntil;

            // Initialize tabs and payment configuration displays
            switchTab('quoteDetails');
            updatePaymentModel();
            updatePaymentTermsDisplay();
            updatePaymentMethodsDisplay();
            calculateNextInvoiceDate();

            // Payment configuration change listeners (autosave)
            const paymentConfigInputs = document.querySelectorAll('#paymentConfigContent input, #paymentConfigContent select, #paymentConfigContent textarea');
            paymentConfigInputs.forEach(input => {
                input.addEventListener('change', function() {
                    if (input.id === 'defaultPaymentTerms') {
                        updatePaymentTermsDisplay();
                    }
                    if (input.id === 'subscriptionStartDate' || input.id === 'billingFrequency') {
                        calculateNextInvoiceDate();
                    }
                    autoSavePaymentConfiguration();
                });
            });
            
            // Catalog search autocomplete
            document.getElementById('catalogSearchInput').addEventListener('input', function(e) {
                renderCatalogAutocomplete(e.target.value);
            });
            
            // Clear catalog search button
            document.getElementById('clearCatalogSearchBtn').addEventListener('click', function() {
                document.getElementById('catalogSearchInput').value = '';
                document.getElementById('catalogAutocomplete').classList.add('hidden');
                document.getElementById('clearCatalogSearchBtn').classList.add('hidden');
            });
            
            // Close catalog autocomplete when clicking outside
            document.addEventListener('click', function(e) {
                const catalogSearch = document.getElementById('catalogSearchInput');
                const autocomplete = document.getElementById('catalogAutocomplete');
                if (catalogSearch && !catalogSearch.parentElement.contains(e.target)) {
                    autocomplete.classList.add('hidden');
                }
            });
            
            // Customer search autocomplete
            document.getElementById('customerSearchInput').addEventListener('input', function(e) {
                renderCustomerAutocomplete(e.target.value);
            });
            
            // Clear search button
            document.getElementById('clearSearchBtn').addEventListener('click', function() {
                document.getElementById('customerSearchInput').value = '';
                document.getElementById('customerAutocomplete').classList.add('hidden');
                document.getElementById('clearSearchBtn').classList.add('hidden');
            });
            
            // Close autocomplete when clicking outside
            document.addEventListener('click', function(e) {
                const searchSection = document.getElementById('customerSearchSection');
                const autocomplete = document.getElementById('customerAutocomplete');
                if (searchSection && !searchSection.contains(e.target)) {
                    autocomplete.classList.add('hidden');
                }
            });
            
            // Toggle new customer form
            document.getElementById('toggleNewCustomerBtn').addEventListener('click', function() {
                state.showNewCustomerForm = !state.showNewCustomerForm;
                document.getElementById('newCustomerForm').classList.toggle('hidden');
                document.getElementById('customerSearchSection').classList.toggle('hidden');
            });
            
            // Cancel new customer
            document.getElementById('cancelNewCustomerBtn').addEventListener('click', function() {
                state.showNewCustomerForm = false;
                document.getElementById('newCustomerForm').classList.add('hidden');
                document.getElementById('customerSearchSection').classList.remove('hidden');
            });
            
            // Create customer
            document.getElementById('createCustomerBtn').addEventListener('click', function() {
                const fullName = document.getElementById('quickCustomerFullName').value.trim();
                const company = document.getElementById('quickCustomerCompany').value.trim();
                const role = document.getElementById('quickCustomerRole').value.trim();
                const email = document.getElementById('quickCustomerEmail').value.trim();
                const phone = document.getElementById('quickCustomerPhone').value.trim();
                const whatsapp = document.getElementById('quickCustomerWhatsApp').value.trim();
                const preferredContactMethod = document.getElementById('quickCustomerPreferredContact').value;
                const address = document.getElementById('quickCustomerAddress').value.trim();
                const notes = document.getElementById('quickCustomerNotes').value.trim();
                
                if (!fullName || !email || !phone) {
                    alert('Please fill in the required fields: Full Name, Email, and Phone.');
                    return;
                }
                
                const newCustomer = {
                    id: customers.length + 1,
                    name: fullName,
                    company,
                    role,
                    email,
                    phone,
                    whatsapp,
                    preferredContactMethod,
                    address,
                    notes,
                    previousQuotes: 0,
                    secondaryContacts: []
                };
                
                customers.push(newCustomer);
                selectCustomer(newCustomer.id);
                
                state.showNewCustomerForm = false;
                document.getElementById('newCustomerForm').classList.add('hidden');
                
                // Clear form inputs
                document.getElementById('quickCustomerFullName').value = '';
                document.getElementById('quickCustomerCompany').value = '';
                document.getElementById('quickCustomerRole').value = '';
                document.getElementById('quickCustomerEmail').value = '';
                document.getElementById('quickCustomerPhone').value = '';
                document.getElementById('quickCustomerWhatsApp').value = '';
                document.getElementById('quickCustomerPreferredContact').value = 'email';
                document.getElementById('quickCustomerAddress').value = '';
                document.getElementById('quickCustomerNotes').value = '';
            });
            
            // Clear customer
            document.getElementById('clearCustomerBtn').addEventListener('click', function() {
                state.selectedCustomer = null;
                state.selectedQuoteContact = null;
                const searchInput = document.getElementById('customerSearchInput');
                searchInput.classList.remove('border-green-500');
                searchInput.classList.add('border-red-300');
                document.getElementById('selectedCustomerCard').classList.add('hidden');
                document.getElementById('customerSearchSection').classList.remove('hidden');
                searchInput.focus();
                updateCreateButton();
            });
            
            // Quote contact selector change
            document.getElementById('quoteContactSelect').addEventListener('change', function(e) {
                const value = e.target.value;
                const customer = state.selectedCustomer;
                
                if (value === 'primary') {
                    state.selectedQuoteContact = {
                        type: 'primary',
                        name: customer.name,
                        email: customer.email,
                        phone: customer.phone
                    };
                } else if (value.startsWith('secondary-')) {
                    const index = parseInt(value.split('-')[1]);
                    const contact = customer.secondaryContacts[index];
                    state.selectedQuoteContact = {
                        type: 'secondary',
                        name: contact.name,
                        email: contact.email,
                        phone: contact.phone,
                        role: contact.role
                    };
                }
                
                console.log('Quote contact changed:', state.selectedQuoteContact);
            });
            
            // Service address toggle
            document.getElementById('sameAsBilling').addEventListener('change', function(e) {
                const isChecked = e.target.checked;
                document.getElementById('serviceAddressFields').classList.toggle('hidden', isChecked);
                document.getElementById('serviceAddressDisplay').style.display = isChecked ? 'block' : 'none';
                
                if (!isChecked) {
                    // Clear custom address fields
                    document.getElementById('serviceStreet').value = '';
                    document.getElementById('serviceAddressNotes').value = '';
                }
            });
            
            // Create quote button
            document.getElementById('createQuoteBtn').addEventListener('click', function() {
                if (!state.selectedCustomer) {
                    alert('Please select a customer');
                    return;
                }
                
                if (state.quoteItems.length === 0) {
                    alert('Please add at least one item to the quote');
                    return;
                }
                
                // Check for price modifications
                const priceModifiedItems = state.quoteItems.filter(item => item.priceModified);
                if (priceModifiedItems.length > 0) {
                    console.log('Price modifications:', 
                        priceModifiedItems.map(item => ({
                            name: item.name,
                            originalPrice: item.originalPrice,
                            modifiedPrice: item.customPrice,
                            comment: item.priceModificationComment
                        }))
                    );
                }
                
                // Create quote data
                const quoteData = {
                    customer: state.selectedCustomer,
                    quoteContact: state.selectedQuoteContact, // Contact who will receive the quote
                    items: state.quoteItems,
                    subtotal: calculateSubtotal(),
                    tax: calculateTax(),
                    total: calculateTotal(),
                    validUntil: document.getElementById('validUntilDate').value,
                    customerNotes: document.getElementById('customerNotes').value,
                    internalNotes: document.getElementById('internalNotes').value,
                    priceModifications: priceModifiedItems.map(item => ({
                        name: item.name,
                        originalPrice: item.originalPrice,
                        modifiedPrice: item.customPrice,
                        comment: item.priceModificationComment
                    })),
                    status: 'active',
                    createdDate: new Date().toISOString()
                };
                
                // Here you would normally send the quote data to the server
                console.log('Creating quote:', quoteData);
                
                const contactName = state.selectedQuoteContact.type === 'secondary' 
                    ? `${state.selectedQuoteContact.name} (${state.selectedQuoteContact.role})` 
                    : state.selectedCustomer.name;
                alert(`Quote created successfully for ${state.selectedCustomer.name}!\nQuote will be sent to: ${contactName}`);
                // In real implementation: redirect to quotes list or quote detail page
                // window.location.href = 'quotes.html';
            });
            
            // Save draft button
            document.getElementById('saveDraftBtn').addEventListener('click', function() {
                // Create draft quote data
                const draftData = {
                    customer: state.selectedCustomer,
                    quoteContact: state.selectedQuoteContact, // Contact who will receive the quote
                    items: state.quoteItems,
                    subtotal: calculateSubtotal(),
                    tax: calculateTax(),
                    total: calculateTotal(),
                    validUntil: document.getElementById('validUntilDate').value,
                    customerNotes: document.getElementById('customerNotes').value,
                    internalNotes: document.getElementById('internalNotes').value,
                    status: 'draft',
                    createdDate: new Date().toISOString()
                };
                
                // Here you would normally save the draft to the server
                console.log('Saving draft:', draftData);
                
                alert('Quote saved as draft!');
                // In real implementation: redirect to quotes list
                // window.location.href = 'quotes.html';
            });
            
            // Price modification modal event listeners
            document.getElementById('closePriceModModal').addEventListener('click', cancelPriceModification);
            document.getElementById('cancelPriceModBtn').addEventListener('click', cancelPriceModification);
            document.getElementById('savePriceModBtn').addEventListener('click', confirmPriceModification);
            
            // Close modal on background click
            document.getElementById('priceModModal').addEventListener('click', function(e) {
                if (e.target.id === 'priceModModal') {
                    cancelPriceModification();
                }
            });
            
            // Close modal on Escape key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && !document.getElementById('priceModModal').classList.contains('hidden')) {
                    cancelPriceModification();
                }
            });

            // Initial render
            renderQuoteItems();
            updateSummary();
        });
    </script>
</body>
</html>

