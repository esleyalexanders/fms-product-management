<!-- Convert to Jobs Modal - Add this before closing </body> tag -->
<div id="convertToJobsModal"
    class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] flex flex-col">
        <!-- Modal Header -->
        <div id="convertJobsHeader" class="p-6 border-b border-gray-200">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div id="convertJobsHeaderIcon"
                        class="w-12 h-12 bg-gradient-to-br from-blue-600 to-indigo-600 rounded-xl flex items-center justify-center shadow-lg">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z">
                            </path>
                        </svg>
                    </div>
                    <div>
                        <h3 id="convertJobsTitle" class="text-xl font-bold text-gray-900">Convert to Jobs</h3>
                        <p id="convertJobsSubtitle" class="text-sm text-gray-600 mt-1">Create jobs from quote items</p>
                    </div>
                </div>
                <button onclick="closeConvertToJobsModal()" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                        </path>
                    </svg>
                </button>
            </div>
        </div>

        <!-- STATE 1: Confirmation View (before creating jobs) -->
        <div id="convertJobsConfirmView">
            <!-- Modal Body -->
            <div class="flex-1 overflow-y-auto p-6">
                <!-- Info Banner -->
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                    <div class="flex items-start gap-3">
                        <svg class="w-5 h-5 text-blue-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor"
                            viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <div>
                            <h4 class="text-sm font-semibold text-blue-900 mb-1">What will happen?</h4>
                            <p class="text-xs text-blue-800">The system will create jobs for each quote item based on
                                quantity. Each job will be linked to the customer and can be configured independently.
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Job Details & Items -->
                <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 mb-6">
                    <h4 class="text-sm font-semibold text-gray-900 mb-4">Job Details Confirmation</h4>

                    <!-- Customer -->
                    <div class="mb-5">
                        <label class="block text-xs font-medium text-gray-700 mb-1">Customer</label>
                        <input type="text" id="jobCustomerName" readonly
                            class="w-full px-3 py-2 bg-white border border-gray-300 rounded-lg text-sm text-gray-600 cursor-not-allowed">
                    </div>

                    <!-- Items -->
                    <div>
                        <label class="block text-xs font-medium text-gray-700 mb-2">Quote Items to Convert</label>
                        <div id="jobConversionItemsList" class="space-y-2">
                            <!-- Items will be populated by JavaScript -->
                        </div>
                    </div>
                </div>

                <!-- Summary -->
                <div class="bg-gradient-to-br from-green-50 to-emerald-50 border-2 border-green-200 rounded-lg p-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600 mb-1">Total Jobs to Create:</p>
                            <p id="jobConversionSummaryText" class="text-lg font-bold text-gray-900">0 Jobs</p>
                        </div>
                        <div class="w-12 h-12 bg-green-600 rounded-lg flex items-center justify-center">
                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2-2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z">
                                </path>
                            </svg>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal Footer -->
            <div class="p-6 border-t border-gray-200 flex items-center justify-end gap-3">
                <button onclick="closeConvertToJobsModal()"
                    class="px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 font-medium">
                    Cancel
                </button>
                <button onclick="createJobsAndShowResults()"
                    class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium shadow-sm flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                    </svg>
                    Create Jobs
                </button>
            </div>
        </div>

        <!-- STATE 2: Success View (after creating jobs) -->
        <div id="convertJobsSuccessView" class="hidden">
            <!-- Modal Body -->
            <div class="flex-1 overflow-y-auto p-6">
                <!-- Success Banner -->
                <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-6">
                    <div class="flex items-start gap-3">
                        <div class="w-8 h-8 bg-green-600 rounded-full flex items-center justify-center flex-shrink-0">
                            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M5 13l4 4L19 7"></path>
                            </svg>
                        </div>
                        <div>
                            <h4 class="text-sm font-semibold text-green-900 mb-1">Jobs Created Successfully!</h4>
                            <p class="text-xs text-green-800">Click on any job below to open it and start enrolling the
                                customer into sessions.</p>
                        </div>
                    </div>
                </div>

                <!-- Created Jobs List -->
                <div class="mb-4">
                    <h4 class="text-sm font-semibold text-gray-900 mb-3">Created Jobs</h4>
                    <div id="createdJobsList" class="space-y-2">
                        <!-- Created job cards will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Modal Footer -->
            <div class="p-6 border-t border-gray-200 flex items-center justify-between">
                <button onclick="goToJobList()"
                    class="px-4 py-2 text-blue-600 hover:text-blue-800 hover:bg-blue-50 rounded-lg font-medium text-sm flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 6h16M4 10h16M4 14h16M4 18h16"></path>
                    </svg>
                    View All Jobs
                </button>
                <button onclick="closeConvertToJobsModal()"
                    class="px-6 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 font-medium">
                    Done
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    // Open Convert to Jobs Modal
    function openConvertToJobsModal() {
        // Get quote items
        const quoteItems = state.lineItems || [];

        if (quoteItems.length === 0) {
            alert('⚠️ No quote items to convert. Please add items to the quote first.');
            return;
        }

        // Calculate total jobs
        let totalJobs = 0;
        quoteItems.forEach(item => {
            totalJobs += item.quantity || 1;
        });

        // Populate items list
        const itemsList = document.getElementById('jobConversionItemsList');
        itemsList.innerHTML = quoteItems.map(item => `
            <div class="flex justify-between items-center p-3 bg-white rounded border border-gray-200">
                <div class="flex-1">
                    <p class="font-medium text-gray-900">${item.name}</p>
                    <p class="text-xs text-gray-500 mt-0.5">${item.packageType || 'Standard'} • ${item.serviceType || 'Service'}</p>
                </div>
                <div class="text-right">
                    <p class="text-sm font-semibold text-blue-600">
                        ${item.quantity || 1} Job${(item.quantity || 1) > 1 ? 's' : ''}
                    </p>
                    <p class="text-xs text-gray-500">@ $${item.unitPrice ? item.unitPrice.toFixed(2) : '0.00'} each</p>
                </div>
            </div>
        `).join('');

        // Populate Job Settings
        const customerName = state.selectedCustomer?.name || 'Customer';
        const customerEl = document.getElementById('jobCustomerName');
        if (customerEl) customerEl.value = customerName;

        // Update summary
        document.getElementById('jobConversionSummaryText').textContent =
            `${totalJobs} Job${totalJobs > 1 ? 's' : ''}`;

        // Show modal
        document.getElementById('convertToJobsModal').classList.remove('hidden');
    }

    // Close Convert to Jobs Modal (and reset to confirm view)
    function closeConvertToJobsModal() {
        document.getElementById('convertToJobsModal').classList.add('hidden');

        // Reset to confirmation view for next time
        const confirmView = document.getElementById('convertJobsConfirmView');
        const successView = document.getElementById('convertJobsSuccessView');
        if (confirmView) confirmView.classList.remove('hidden');
        if (successView) successView.classList.add('hidden');

        // Reset header
        const title = document.getElementById('convertJobsTitle');
        const subtitle = document.getElementById('convertJobsSubtitle');
        const icon = document.getElementById('convertJobsHeaderIcon');
        if (title) title.textContent = 'Convert to Jobs';
        if (subtitle) subtitle.textContent = 'Create jobs from quote items';
        if (icon) {
            icon.className = 'w-12 h-12 bg-gradient-to-br from-blue-600 to-indigo-600 rounded-xl flex items-center justify-center shadow-lg';
        }
    }

    // Create Jobs and show results in the same modal
    function createJobsAndShowResults() {
        const quoteItems = state.lineItems || [];
        const quoteId = getQuoteIdFromUrl();
        const quoteData = state;

        let totalJobsCreated = 0;
        const jobsCreated = [];

        // Create jobs based on quantity
        quoteItems.forEach(item => {
            const quantity = item.quantity || 1;

            for (let i = 0; i < quantity; i++) {
                const jobId = generateJobId();
                const newJob = {
                    id: jobId,
                    customerId: quoteData.selectedCustomer?.id || 'CUST-001',
                    customerName: quoteData.selectedCustomer?.name || 'Customer',
                    customerEmail: quoteData.selectedCustomer?.email || 'customer@email.com',
                    serviceName: item.name,
                    pricebookItemId: item.itemId,
                    serviceType: item.serviceType || 'subscription',
                    packageType: item.packageType || 'Standard',
                    subscriptionFrequency: item.subscriptionFrequency,
                    unitPrice: item.unitPrice || 0,
                    quoteId: quoteId,
                    status: 'incomplete',
                    paymentStatus: 'not_setup',
                    sessionsName: null,
                    sessionsId: null,
                    linkedService: null,
                    nextSession: null,
                    staff: null,
                    schedulePattern: 'Not yet scheduled',
                    enrollmentDate: new Date().toISOString().split('T')[0],
                    incompleteReason: 'not_linked',
                    paymentSetup: false,
                    createdAt: new Date().toISOString()
                };

                jobsCreated.push(newJob);
                totalJobsCreated++;
            }
        });

        // Save jobs to localStorage
        const existingJobs = JSON.parse(localStorage.getItem('jobs') || '[]');
        const allJobs = [...existingJobs, ...jobsCreated];
        localStorage.setItem('jobs', JSON.stringify(allJobs));

        // Transition modal to success view
        const confirmView = document.getElementById('convertJobsConfirmView');
        const successView = document.getElementById('convertJobsSuccessView');
        if (confirmView) confirmView.classList.add('hidden');
        if (successView) successView.classList.remove('hidden');

        // Update header for success state
        const title = document.getElementById('convertJobsTitle');
        const subtitle = document.getElementById('convertJobsSubtitle');
        const icon = document.getElementById('convertJobsHeaderIcon');
        if (title) title.textContent = 'Jobs Created';
        if (subtitle) subtitle.textContent = `${totalJobsCreated} job${totalJobsCreated > 1 ? 's' : ''} created successfully`;
        if (icon) {
            icon.className = 'w-12 h-12 bg-gradient-to-br from-green-600 to-emerald-600 rounded-xl flex items-center justify-center shadow-lg';
        }

        // Populate created jobs list
        const jobsList = document.getElementById('createdJobsList');
        if (jobsList) {
            jobsList.innerHTML = jobsCreated.map((job, index) => `
                <div class="group flex items-center justify-between p-4 bg-white rounded-lg border border-gray-200 hover:border-blue-300 hover:shadow-md transition-all cursor-pointer"
                     onclick="enrollJob('${job.id}')">
                    <div class="flex items-center gap-3 flex-1">
                        <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center text-blue-600 font-bold text-sm">
                            ${index + 1}
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2">
                                <p class="font-semibold text-gray-900 text-sm">${job.id}</p>
                                <span class="px-2 py-0.5 text-xs rounded-full bg-amber-100 text-amber-700 font-medium">Incomplete</span>
                            </div>
                            <p class="text-xs text-gray-600 mt-0.5 truncate">${job.serviceName}</p>
                            <p class="text-xs text-gray-400">${job.customerName} • $${job.unitPrice.toFixed(2)}</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="px-3 py-1.5 bg-blue-600 text-white rounded-lg text-xs font-medium group-hover:bg-blue-700 transition-colors flex items-center gap-1">
                            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"></path>
                            </svg>
                            Enroll
                        </span>
                    </div>
                </div>
            `).join('');
        }
    }

    // Navigate to the job list page
    function goToJobList() {
        window.location.href = '../../[v2] Jobs/job_list_simple.html';
    }

    // Navigate to a specific job detail page for enrollment
    function enrollJob(jobId) {
        window.location.href = '../../[v2] Jobs/job_detail_simple.html?id=' + encodeURIComponent(jobId);
    }

    // Generate unique job ID
    function generateJobId() {
        const year = new Date().getFullYear();
        const existingJobs = JSON.parse(localStorage.getItem('jobs') || '[]');
        const nextNumber = (existingJobs.length + 1).toString().padStart(3, '0');
        return `JOB-${year}-${nextNumber}`;
    }

    // Get quote ID from URL
    function getQuoteIdFromUrl() {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get('id') || 'Q-2024-001';
    }
</script>