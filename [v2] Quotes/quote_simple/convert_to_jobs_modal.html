<!-- Convert to Jobs Modal - Add this before closing </body> tag -->
<div id="convertToJobsModal"
    class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] flex flex-col">
        <!-- Modal Header -->
        <div class="p-6 border-b border-gray-200">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div
                        class="w-12 h-12 bg-gradient-to-br from-blue-600 to-indigo-600 rounded-xl flex items-center justify-center shadow-lg">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z">
                            </path>
                        </svg>
                    </div>
                    <div>
                        <h3 class="text-xl font-bold text-gray-900">Convert to Jobs</h3>
                        <p class="text-sm text-gray-600 mt-1">Create jobs from quote items</p>
                    </div>
                </div>
                <button onclick="closeConvertToJobsModal()" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                        </path>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Modal Body -->
        <div class="flex-1 overflow-y-auto p-6">
            <!-- Info Banner -->
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                <div class="flex items-start gap-3">
                    <svg class="w-5 h-5 text-blue-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor"
                        viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <div>
                        <h4 class="text-sm font-semibold text-blue-900 mb-1">What will happen?</h4>
                        <p class="text-xs text-blue-800">The system will create jobs for each quote item based on
                            quantity. Each job will be linked to the customer and can be configured independently.</p>
                    </div>
                </div>
            </div>

            <!-- Job Details & Items -->
            <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 mb-6">
                <h4 class="text-sm font-semibold text-gray-900 mb-4">Job Details Confirmation</h4>

                <!-- Customer -->
                <div class="mb-5">
                    <label class="block text-xs font-medium text-gray-700 mb-1">Customer</label>
                    <input type="text" id="jobCustomerName" readonly
                        class="w-full px-3 py-2 bg-white border border-gray-300 rounded-lg text-sm text-gray-600 cursor-not-allowed">
                </div>

                <!-- Items -->
                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-2">Quote Items to Convert</label>
                    <div id="jobConversionItemsList" class="space-y-2">
                        <!-- Items will be populated by JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Conversion Options -->
            <div class="mb-6">
                <h4 class="text-sm font-semibold text-gray-900 mb-3">How would you like to proceed?</h4>
                <div class="space-y-3">
                    <!-- Button 1: Continue to Enroll -->
                    <button onclick="proceedToEnrollment()"
                        class="w-full flex items-start gap-4 p-4 bg-white border-2 border-purple-200 rounded-xl hover:bg-purple-50 hover:border-purple-400 hover:shadow-md transition-all group">
                        <div
                            class="flex-shrink-0 w-12 h-12 bg-purple-100 text-purple-600 rounded-lg flex items-center justify-center group-hover:bg-purple-600 group-hover:text-white transition-colors">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253">
                                </path>
                            </svg>
                        </div>
                        <div class="flex-1 text-left">
                            <span
                                class="block text-lg font-bold text-gray-900 group-hover:text-purple-700 mb-1">Continue
                                to enroll</span>
                            <p class="text-sm text-gray-600">Create jobs AND enroll the customer in sessions
                                immediately.</p>
                        </div>
                        <svg class="w-6 h-6 text-gray-400 group-hover:text-purple-600 mt-3" fill="none"
                            stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7">
                            </path>
                        </svg>
                    </button>

                    <!-- Button 2: Create Jobs Only -->
                    <button onclick="createJobsWithoutSessions()"
                        class="w-full flex items-start gap-4 p-4 bg-white border-2 border-gray-200 rounded-xl hover:bg-gray-50 hover:border-gray-400 hover:shadow-md transition-all group">
                        <div
                            class="flex-shrink-0 w-12 h-12 bg-gray-100 text-gray-600 rounded-lg flex items-center justify-center group-hover:bg-gray-600 group-hover:text-white transition-colors">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2-2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z">
                                </path>
                            </svg>
                        </div>
                        <div class="flex-1 text-left">
                            <span class="block text-lg font-bold text-gray-900 group-hover:text-gray-800 mb-1">Create
                                jobs</span>
                            <p class="text-sm text-gray-600">Only create the job records now. You can link them to
                                sessions later.</p>
                        </div>
                        <svg class="w-6 h-6 text-gray-400 group-hover:text-gray-600 mt-3" fill="none"
                            stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7">
                            </path>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Summary -->
            <div class="bg-gradient-to-br from-green-50 to-emerald-50 border-2 border-green-200 rounded-lg p-4">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600 mb-1">Total Jobs to Create:</p>
                        <p id="jobConversionSummaryText" class="text-lg font-bold text-gray-900">0 Jobs</p>
                    </div>
                    <div class="w-12 h-12 bg-green-600 rounded-lg flex items-center justify-center">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2-2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z">
                            </path>
                        </svg>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal Footer -->
        <div class="p-6 border-t border-gray-200 flex items-center justify-center">
            <button onclick="closeConvertToJobsModal()"
                class="px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 font-medium">
                Cancel
            </button>
        </div>
    </div>
</div>

<script>
    // Open Convert to Jobs Modal
    function openConvertToJobsModal() {
        // Get quote items
        const quoteItems = state.lineItems || [];

        if (quoteItems.length === 0) {
            alert('⚠️ No quote items to convert. Please add items to the quote first.');
            return;
        }

        // Calculate total jobs
        let totalJobs = 0;
        quoteItems.forEach(item => {
            totalJobs += item.quantity || 1;
        });

        // Populate items list
        const itemsList = document.getElementById('jobConversionItemsList');
        itemsList.innerHTML = quoteItems.map(item => `
            <div class="flex justify-between items-center p-3 bg-white rounded border border-gray-200">
                <div class="flex-1">
                    <p class="font-medium text-gray-900">${item.name}</p>
                    <p class="text-xs text-gray-500 mt-0.5">${item.packageType || 'Standard'} • ${item.serviceType || 'Service'}</p>
                </div>
                <div class="text-right">
                    <p class="text-sm font-semibold text-blue-600">
                        ${item.quantity || 1} Job${(item.quantity || 1) > 1 ? 's' : ''}
                    </p>
                    <p class="text-xs text-gray-500">@ $${item.unitPrice ? item.unitPrice.toFixed(2) : '0.00'} each</p>
                </div>
            </div>
        `).join('');

        // Populate Job Settings
        const customerName = state.selectedCustomer?.name || 'Customer';
        const customerEl = document.getElementById('jobCustomerName');
        if (customerEl) customerEl.value = customerName;


        // Update summary
        document.getElementById('jobConversionSummaryText').textContent =
            `${totalJobs} Job${totalJobs > 1 ? 's' : ''}`;

        // Show modal
        document.getElementById('convertToJobsModal').classList.remove('hidden');
    }

    // Close Convert to Jobs Modal
    function closeConvertToJobsModal() {
        document.getElementById('convertToJobsModal').classList.add('hidden');
    }

    // Proceed to enrollment flow
    function proceedToEnrollment() {
        // Close this modal and open the sessions modal
        closeConvertToJobsModal();

        // Small delay for smooth transition
        setTimeout(() => {
            // Open the existing convert to sessions modal
            if (typeof openConvertToSessionsModal === 'function') {
                openConvertToSessionsModal();
            } else {
                // If function doesn't exist, show the modal directly
                const sessionsModal = document.getElementById('convertToSessionsModal');
                if (sessionsModal) {
                    sessionsModal.classList.remove('hidden');
                } else {
                    // Fallback: create jobs without sessions
                    createJobsWithoutSessions();
                }
            }
        }, 200);
    }

    // Create jobs without session linking
    function createJobsWithoutSessions() {
        const quoteItems = state.lineItems || [];
        const quoteId = getQuoteIdFromUrl();
        const quoteData = state;



        let totalJobsCreated = 0;
        const jobsCreated = [];

        // Create jobs based on quantity
        quoteItems.forEach(item => {
            const quantity = item.quantity || 1;

            for (let i = 0; i < quantity; i++) {
                const jobId = generateJobId();
                const newJob = {
                    id: jobId,
                    customerId: quoteData.selectedCustomer?.id || 'CUST-001',
                    customerName: quoteData.selectedCustomer?.name || 'Customer',
                    customerEmail: quoteData.selectedCustomer?.email || 'customer@email.com',
                    serviceName: item.name,
                    pricebookItemId: item.itemId,
                    serviceType: item.serviceType || 'subscription',
                    packageType: item.packageType || 'Standard',
                    subscriptionFrequency: item.subscriptionFrequency,
                    unitPrice: item.unitPrice || 0,
                    quoteId: quoteId,
                    status: 'incomplete', // Default status
                    paymentStatus: 'not_setup',
                    sessionsName: null,
                    sessionsId: null,
                    linkedService: null,
                    nextSession: null,
                    nextSession: null,
                    staff: null,
                    schedulePattern: 'Not yet scheduled',
                    enrollmentDate: new Date().toISOString().split('T')[0],
                    incompleteReason: 'not_linked',
                    paymentSetup: false,
                    createdAt: new Date().toISOString()
                };

                jobsCreated.push(newJob);
                totalJobsCreated++;
            }
        });

        // Save jobs to localStorage
        const existingJobs = JSON.parse(localStorage.getItem('jobs') || '[]');
        const allJobs = [...existingJobs, ...jobsCreated];
        localStorage.setItem('jobs', JSON.stringify(allJobs));

        // Close modal
        closeConvertToJobsModal();

        // Show success message
        setTimeout(() => {
            alert(`✅ Success!\n\n${totalJobsCreated} job(s) created successfully!\n\nWhat's next:\n• Link jobs to sessions\n• Configure payment for each job\n• Assign staff to jobs\n• Schedule sessions`);

            // Redirect to job list
            if (confirm('Go to Job List to view created jobs?')) {
                window.location.href = '../../[v2] Jobs/job_list_simple.html';
            }
        }, 200);
    }

    // Generate unique job ID
    function generateJobId() {
        const year = new Date().getFullYear();
        const existingJobs = JSON.parse(localStorage.getItem('jobs') || '[]');
        const nextNumber = (existingJobs.length + 1).toString().padStart(3, '0');
        return `JOB-${year}-${nextNumber}`;
    }

    // Get quote ID from URL
    function getQuoteIdFromUrl() {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get('id') || 'Q-2024-001';
    }
</script>