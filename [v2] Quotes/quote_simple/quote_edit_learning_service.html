<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/svg+xml"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ“„</text></svg>">
    <link rel="shortcut icon" type="image/svg+xml"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ“„</text></svg>">
    <link rel="apple-touch-icon"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ“„</text></svg>">
    <title>Edit Quote - Learning Service Search (EXPERIMENT) - FMS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        /* Custom scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>

<body class="min-h-screen bg-gray-50">

    <div class="p-4">
        <div class="max-w-7xl mx-auto">

            <!-- Header -->
            <div class="bg-white rounded-lg shadow-sm p-4 mb-4">
                <div class="flex justify-between items-center">
                    <div>
                        <div class="flex items-center gap-3 mb-1">
                            <h1 class="text-2xl font-bold text-gray-900">Edit Quote</h1>
                            <span id="quoteIdBadge"
                                class="px-3 py-1 bg-blue-100 text-blue-700 rounded-lg text-sm font-medium">Q-2024-001</span>
                            <span id="quoteStatusBadge"
                                class="px-2 py-1 text-xs rounded bg-yellow-100 text-yellow-700">Draft</span>
                        </div>
                        <p class="text-gray-600 font-medium">Sunshine Tutoring - Melbourne East</p>
                    </div>
                    <div id="headerActions" class="flex gap-2">
                        <button onclick="window.location.href='quote_list_simple.html'"
                            class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 flex items-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                            </svg>
                            Back to Quotes
                        </button>
                        <!-- Dynamic action buttons will be inserted here -->
                    </div>
                </div>
            </div>

            <!-- Experimental Banner -->
            <div class="bg-orange-100 border-l-4 border-orange-500 p-4 mb-4">
                <div class="flex items-center gap-3">
                    <svg class="w-6 h-6 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z">
                        </path>
                    </svg>
                    <div>
                        <p class="font-bold text-orange-800">EXPERIMENTAL VERSION - Solution 1 Demo</p>
                        <p class="text-sm text-orange-700">This page demonstrates searching for Learning Services
                            instead of Pricebook Items</p>
                    </div>
                </div>
            </div>

            <!-- Status Information Banner (for non-editable statuses) -->
            <div id="statusInfoBanner" class="hidden mb-4"></div>

            <!-- Tab Navigation -->
            <div class="bg-white rounded-lg shadow-sm mb-4">
                <div class="border-b border-gray-200">
                    <nav class="flex space-x-8 px-6" aria-label="Tabs">
                        <button id="quoteDetailsTab"
                            class="tab-button active py-4 px-1 border-b-2 border-blue-500 font-medium text-sm text-blue-600"
                            onclick="switchTab('quoteDetails')">
                            Quote Details
                        </button>
                        <button id="paymentConfigTab"
                            class="tab-button py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300"
                            onclick="switchTab('paymentConfig')">
                            Payment Configuration
                        </button>
                        <button id="invoicesTab"
                            class="tab-button py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300"
                            onclick="switchTab('invoices')">
                            Invoices
                        </button>
                    </nav>
                </div>
            </div>

            <!-- Quote Details Tab Content -->
            <div id="quoteDetailsContent" class="tab-content">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">

                    <!-- Left Column - Customer & Services -->
                    <div class="lg:col-span-2 space-y-4">

                        <!-- Customer Section -->
                        <div class="bg-white rounded-lg shadow-sm p-4">
                            <div class="mb-4">
                                <h2 class="text-lg font-semibold text-gray-900">Customer Information</h2>
                            </div>

                            <!-- Customer Search with Autocomplete -->
                            <div id="customerSearchSection" class="hidden">
                                <div class="relative">
                                    <svg class="absolute left-3 top-3 text-gray-400 w-5 h-5" fill="none"
                                        stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                    </svg>
                                    <input type="text" id="customerSearchInput"
                                        placeholder="Type to search customer by name, email, or phone... (Required)"
                                        class="w-full pl-10 pr-10 py-2 border border-red-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"
                                        autocomplete="off" required />
                                    <button id="clearSearchBtn"
                                        class="hidden absolute right-3 top-3 text-gray-400 hover:text-gray-600">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M6 18L18 6M6 6l12 12"></path>
                                        </svg>
                                    </button>
                                    <!-- Autocomplete Dropdown -->
                                    <div id="customerAutocomplete"
                                        class="hidden absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto custom-scrollbar">
                                        <!-- Autocomplete results will be populated here -->
                                    </div>
                                </div>
                            </div>

                            <!-- Selected Customer Card -->
                            <div id="selectedCustomerCard">
                                <div class="border border-blue-300 rounded-lg p-3 bg-blue-50">
                                    <div class="flex justify-between items-start mb-3">
                                        <div class="flex-1">
                                            <div class="flex items-center gap-2">
                                                <p class="font-semibold text-gray-900" id="selectedCustomerName"></p>
                                                <span
                                                    class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800">Selected</span>
                                            </div>
                                            <p class="text-sm text-gray-600 mt-1" id="selectedCustomerEmail"></p>
                                            <p class="text-sm text-gray-600" id="selectedCustomerPhone"></p>
                                        </div>
                                        <button id="clearCustomerBtn"
                                            class="p-2 text-red-600 hover:text-red-700 hover:bg-red-50 rounded-lg transition-colors"
                                            title="Remove customer and select again">
                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16">
                                                </path>
                                            </svg>
                                        </button>
                                    </div>

                                    <!-- Quote Contact Selector (if secondary contacts exist) -->
                                    <div id="quoteContactSelector" class="hidden border-t border-blue-200 pt-3 mt-3">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Quote
                                            Contact</label>
                                        <select id="quoteContactSelect"
                                            class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white">
                                            <!-- Options populated dynamically -->
                                        </select>
                                        <p class="text-xs text-gray-500 mt-1">Select who should receive this quote</p>
                                    </div>

                                    <!-- Service Address Section -->
                                    <div class="border-t border-blue-200 pt-3 mt-3">
                                        <div class="flex items-center justify-between mb-2">
                                            <h3 class="text-sm font-medium text-gray-700">Service Address</h3>
                                            <label class="flex items-center gap-2 text-xs text-gray-600">
                                                <input type="checkbox" id="sameAsBilling" checked class="rounded" />
                                                <span>Same as customer address</span>
                                            </label>
                                        </div>
                                        <div id="serviceAddressFields" class="hidden space-y-2">
                                            <div>
                                                <label class="block text-xs text-gray-600 mb-1">Service Location</label>
                                                <input type="text" id="serviceStreet"
                                                    placeholder="Enter service address"
                                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" />
                                            </div>
                                            <div>
                                                <label class="block text-xs text-gray-600 mb-1">Access
                                                    Instructions</label>
                                                <textarea id="serviceAddressNotes" rows="2"
                                                    placeholder="Gate codes, parking info, entry instructions, etc."
                                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                                            </div>
                                        </div>
                                        <div id="serviceAddressDisplay" class="text-sm text-gray-600"
                                            style="display: block;">
                                            <span id="displayServiceAddress"></span>
                                        </div>
                                    </div>

                                </div>
                            </div>

                            <!-- New Customer Form (Hidden in edit mode) -->
                            <div id="newCustomerForm" class="hidden" style="display: none;">
                                <!-- Name Fields -->
                                <div class="grid grid-cols-2 gap-3">
                                    <div class="form-group">
                                        <label for="newCustomerFirstName"
                                            class="block text-sm font-medium text-gray-700 mb-1">First Name *</label>
                                        <input type="text" id="newCustomerFirstName" placeholder="John"
                                            class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                                            required />
                                    </div>
                                    <div class="form-group">
                                        <label for="newCustomerLastName"
                                            class="block text-sm font-medium text-gray-700 mb-1">Last Name *</label>
                                        <input type="text" id="newCustomerLastName" placeholder="Doe"
                                            class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                                            required />
                                    </div>
                                </div>

                                <!-- Company -->
                                <div class="form-group">
                                    <label for="newCustomerCompany"
                                        class="block text-sm font-medium text-gray-700 mb-1">Company</label>
                                    <input type="text" id="newCustomerCompany" placeholder="ABC Corp"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" />
                                </div>

                                <!-- Contact Information -->
                                <div class="border-t border-gray-200 pt-3">
                                    <h3 class="text-sm font-medium text-gray-700 mb-3">Contact Information</h3>
                                    <div class="form-group">
                                        <label for="newCustomerEmail"
                                            class="block text-sm font-medium text-gray-700 mb-1">Email *</label>
                                        <input type="email" id="newCustomerEmail" placeholder="john@example.com"
                                            class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                                            required />
                                    </div>
                                    <div class="form-group mt-3">
                                        <label for="newCustomerPhone"
                                            class="block text-sm font-medium text-gray-700 mb-1">Phone</label>
                                        <input type="tel" id="newCustomerPhone" placeholder="+1 234 567 8900"
                                            class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" />
                                    </div>
                                    <div class="form-group mt-3">
                                        <label for="newCustomerWhatsApp"
                                            class="block text-sm font-medium text-gray-700 mb-1">
                                            WhatsApp Number
                                            <span class="text-xs text-gray-500">(for quote delivery)</span>
                                        </label>
                                        <input type="tel" id="newCustomerWhatsApp" placeholder="+61 412 345 678"
                                            class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" />
                                    </div>
                                    <div class="form-group mt-3">
                                        <label for="newCustomerPreferredContact"
                                            class="block text-sm font-medium text-gray-700 mb-1">Preferred Contact
                                            Method</label>
                                        <select id="newCustomerPreferredContact"
                                            class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                                            <option value="email">Email</option>
                                            <option value="phone">Phone</option>
                                            <option value="whatsapp">WhatsApp</option>
                                            <option value="none">None</option>
                                        </select>
                                    </div>
                                </div>

                                <!-- Address -->
                                <div class="border-t border-gray-200 pt-3">
                                    <h3 class="text-sm font-medium text-gray-700 mb-3">Address</h3>
                                    <div class="form-group">
                                        <label for="newCustomerStreet"
                                            class="block text-sm font-medium text-gray-700 mb-1">Street</label>
                                        <input type="text" id="newCustomerStreet" placeholder="123 Main St"
                                            class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" />
                                    </div>
                                    <div class="grid grid-cols-2 gap-3 mt-3">
                                        <div class="form-group">
                                            <label for="newCustomerCity"
                                                class="block text-sm font-medium text-gray-700 mb-1">City</label>
                                            <input type="text" id="newCustomerCity" placeholder="New York"
                                                class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" />
                                        </div>
                                        <div class="form-group">
                                            <label for="newCustomerState"
                                                class="block text-sm font-medium text-gray-700 mb-1">State</label>
                                            <input type="text" id="newCustomerState" placeholder="NY"
                                                class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" />
                                        </div>
                                    </div>
                                    <div class="grid grid-cols-2 gap-3 mt-3">
                                        <div class="form-group">
                                            <label for="newCustomerPostalCode"
                                                class="block text-sm font-medium text-gray-700 mb-1">Postal Code</label>
                                            <input type="text" id="newCustomerPostalCode" placeholder="10001"
                                                class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" />
                                        </div>
                                        <div class="form-group">
                                            <label for="newCustomerCountry"
                                                class="block text-sm font-medium text-gray-700 mb-1">Country</label>
                                            <input type="text" id="newCustomerCountry" placeholder="Australia"
                                                value="Australia"
                                                class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" />
                                        </div>
                                    </div>
                                </div>

                                <!-- Notes -->
                                <div class="border-t border-gray-200 pt-3">
                                    <h3 class="text-sm font-medium text-gray-700 mb-3">Notes</h3>
                                    <textarea id="newCustomerNotes" placeholder="Additional notes about the customer"
                                        rows="3"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                                </div>

                                <!-- Actions -->
                                <div class="flex gap-2 border-t border-gray-200 pt-3">
                                    <button id="cancelNewCustomerBtn"
                                        class="flex-1 px-3 py-2 border border-gray-300 text-gray-700 rounded-lg text-sm hover:bg-gray-50">
                                        Cancel
                                    </button>
                                    <button id="createCustomerBtn"
                                        class="flex-1 px-3 py-2 bg-blue-600 text-white rounded-lg text-sm hover:bg-blue-700">
                                        Create & Select
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Quote Line Items -->
                        <div class="bg-white rounded-lg shadow-sm p-4">
                            <h2 class="text-lg font-semibold text-gray-900 mb-4">Quote Line Items <span
                                    class="text-red-500">*</span></h2>

                            <!-- Add Service/Product Search -->
                            <div class="mb-4">
                                <div class="relative">
                                    <svg class="absolute left-3 top-3 text-gray-400 w-5 h-5" fill="none"
                                        stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                    </svg>
                                    <input type="text" id="catalogSearchInput"
                                        placeholder="ðŸ”¬ EXPERIMENT: Search Learning Services (Class, Group, One-to-One)..."
                                        class="w-full pl-10 pr-10 py-2 border border-orange-300 bg-orange-50 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500 text-sm"
                                        autocomplete="off" />
                                    <button id="clearCatalogSearchBtn"
                                        class="hidden absolute right-3 top-3 text-gray-400 hover:text-gray-600">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M6 18L18 6M6 6l12 12"></path>
                                        </svg>
                                    </button>
                                    <!-- Autocomplete Dropdown -->
                                    <div id="catalogAutocomplete"
                                        class="hidden absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-80 overflow-y-auto custom-scrollbar">
                                        <!-- Autocomplete results will be populated here -->
                                    </div>
                                </div>
                            </div>

                            <div id="emptyQuoteState"
                                class="text-center py-12 text-gray-500 bg-gray-50 rounded-lg border-2 border-dashed border-gray-300">
                                <svg class="mx-auto mb-3 text-gray-400 w-12 h-12" fill="none" stroke="currentColor"
                                    viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                                </svg>
                                <p class="text-sm font-medium text-gray-700 mb-1">No items added yet</p>
                                <p class="text-xs text-gray-500">Search and add services or products above to build your
                                    quote</p>
                            </div>

                            <!-- Card-based Quote Items Container -->
                            <div id="quoteItemsContainer" class="hidden space-y-3">
                                <!-- Quote item cards will be populated here -->
                            </div>
                        </div>
                    </div>

                    <!-- Right Column - Summary & Actions -->
                    <div class="space-y-4">

                        <!-- Pricing Summary -->
                        <div class="bg-white rounded-lg shadow-sm p-4 sticky top-4">
                            <h2 class="text-lg font-semibold text-gray-900 mb-4">Quote Summary</h2>

                            <div class="space-y-3 mb-4">
                                <div class="flex justify-between text-sm">
                                    <span class="text-gray-600">Subtotal</span>
                                    <span class="font-medium" id="subtotalAmount">$0.00</span>
                                </div>

                                <!-- Line Item Discounts Summary -->
                                <div id="lineItemDiscountSection" class="hidden">
                                    <div class="flex justify-between text-sm">
                                        <span class="text-sm text-gray-600">Line Item Discounts</span>
                                        <span class="text-sm font-medium text-red-600"
                                            id="lineItemDiscountAmount">-$0.00</span>
                                    </div>
                                </div>

                                <!-- Tax Breakdown by Category -->
                                <div class="border-t border-gray-200 pt-3">
                                    <div class="text-xs text-gray-600 mb-2">Tax Breakdown:</div>
                                    <div id="taxBreakdown" class="space-y-1 text-xs">
                                        <!-- Tax breakdown will be populated here -->
                                    </div>
                                    <div class="flex justify-between items-center mt-2 pt-2 border-t border-gray-100">
                                        <span class="text-sm text-gray-600">Total Tax</span>
                                        <span class="text-sm font-medium" id="taxAmount">$0.00</span>
                                    </div>
                                </div>

                                <div class="border-t-2 border-gray-300 pt-3">
                                    <div class="flex justify-between">
                                        <span class="font-bold text-gray-900 text-lg">Total</span>
                                        <span class="font-bold text-gray-900 text-lg" id="totalAmount">$0.00</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Quote Details -->
                            <div class="border-t border-gray-200 pt-4 space-y-3">
                                <div>
                                    <label class="block text-xs font-medium text-gray-700 mb-1">Valid Until</label>
                                    <input type="date" id="validUntilDate"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" />
                                </div>

                                <div>
                                    <label class="block text-xs font-medium text-gray-700 mb-1">Notes for
                                        Customer</label>
                                    <textarea id="customerNotes" rows="3"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        placeholder="Terms, conditions, or special notes..."></textarea>
                                </div>

                                <div>
                                    <label class="block text-xs font-medium text-gray-700 mb-1">Internal Notes</label>
                                    <textarea id="internalNotes" rows="2"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        placeholder="Private notes (not visible to customer)..."></textarea>
                                </div>
                            </div>
                            <!-- Action Buttons (Dynamic based on status) -->
                            <div id="sidebarActions" class="mt-4 space-y-2">
                                <!-- Buttons will be dynamically populated based on status -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Payment Configuration Tab Content -->
            <div id="paymentConfigContent" class="tab-content hidden">
                <!-- Payment Configuration Lock Banner (shown when invoices exist) -->
                <div id="paymentConfigBanner" class="hidden mb-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">

                    <!-- Left Column - Payment Configuration -->
                    <div class="lg:col-span-2 space-y-4">

                        <!-- Payment Model Section -->
                        <div class="bg-white rounded-lg shadow-sm p-6">
                            <h2 class="text-lg font-semibold text-gray-900 mb-4">Payment Model</h2>

                            <div class="space-y-3">
                                <label
                                    class="flex items-start gap-3 p-3 border-2 border-purple-300 bg-purple-50 rounded-lg cursor-pointer">
                                    <input type="radio" name="paymentModel" value="full" checked class="mt-1"
                                        onchange="updatePaymentModel()" />
                                    <div class="flex-1">
                                        <div class="font-semibold text-gray-900">Full Payment (Upfront)</div>
                                        <div class="text-xs text-gray-600 mt-1">Customer pays entire amount upfront
                                            before service begins</div>
                                    </div>
                                </label>
                                <label
                                    class="flex items-start gap-3 p-3 border-2 border-gray-200 rounded-lg cursor-pointer hover:border-purple-300 hover:bg-purple-50">
                                    <input type="radio" name="paymentModel" value="deposit" class="mt-1"
                                        onchange="updatePaymentModel()" />
                                    <div class="flex-1">
                                        <div class="font-semibold text-gray-900">Down Payment (Deposit)</div>
                                        <div class="text-xs text-gray-600 mt-1">Customer pays deposit now, remaining
                                            balance later</div>
                                    </div>
                                </label>
                                <label
                                    class="flex items-start gap-3 p-3 border-2 border-gray-200 rounded-lg cursor-pointer hover:border-purple-300 hover:bg-purple-50">
                                    <input type="radio" name="paymentModel" value="subscription" class="mt-1"
                                        onchange="updatePaymentModel()" />
                                    <div class="flex-1">
                                        <div class="font-semibold text-gray-900">Subscription (Recurring)</div>
                                        <div class="text-xs text-gray-600 mt-1">Automatic recurring invoices at regular
                                            intervals</div>
                                    </div>
                                </label>
                            </div>

                            <!-- Subscription Settings (shown when subscription selected) -->
                            <div id="subscriptionSection" class="hidden mt-4 p-4 bg-gray-50 rounded-lg">
                                <h3 class="text-sm font-medium text-gray-700 mb-3">Subscription Settings</h3>
                                <div class="space-y-3">
                                    <div>
                                        <label class="block text-xs text-gray-600 mb-1">Billing Frequency</label>
                                        <select id="billingFrequency"
                                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                                            onchange="updateBillingDateField()">
                                            <option value="weekly">Weekly</option>
                                            <option value="biweekly">Bi-weekly (Every 2 weeks)</option>
                                            <option value="monthly" selected>Monthly</option>
                                            <option value="quarterly">Quarterly (Every 3 months)</option>
                                            <option value="yearly">Yearly</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-xs text-gray-600 mb-1">Subscription Start Date</label>
                                        <input type="date" id="subscriptionStartDate"
                                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                                            onchange="updateBillingDateField(); calculateNextInvoiceDate();" />
                                    </div>
                                    <div id="billingDateSection">
                                        <label class="block text-xs text-gray-600 mb-1">Billing Date</label>
                                        <div class="space-y-2">
                                            <div id="billingDayOfMonth" class="hidden flex items-center gap-2">
                                                <span class="text-xs text-gray-500 whitespace-nowrap">Bill on day</span>
                                                <input type="number" id="billingDay" min="1" max="28" value="1"
                                                    placeholder="Day"
                                                    class="w-20 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                                                    oninput="if(this.value > 28) this.value = 28; if(this.value < 1 && this.value !== '') this.value = 1;"
                                                    onchange="calculateNextInvoiceDate()" />
                                                <span class="text-xs text-gray-500" id="billingDayPeriod">of each
                                                    period</span>
                                            </div>
                                            <div id="billingDayOfWeek" class="hidden flex items-center gap-2">
                                                <span class="text-xs text-gray-500 whitespace-nowrap">Bill every</span>
                                                <select id="billingWeekday"
                                                    class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                                                    onchange="calculateNextInvoiceDate()">
                                                    <option value="0">Sunday</option>
                                                    <option value="1">Monday</option>
                                                    <option value="2">Tuesday</option>
                                                    <option value="3">Wednesday</option>
                                                    <option value="4">Thursday</option>
                                                    <option value="5">Friday</option>
                                                    <option value="6">Saturday</option>
                                                </select>
                                            </div>
                                            <p class="text-xs text-gray-500 italic" id="billingDatePreview">First
                                                billing will occur on the selected date</p>
                                        </div>
                                    </div>
                                    <div>
                                        <label class="block text-xs text-gray-600 mb-1">Subscription End
                                            (Optional)</label>
                                        <select id="subscriptionEnd"
                                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                                            onchange="toggleEndDate()">
                                            <option value="ongoing">Ongoing (No end date)</option>
                                            <option value="after_cycles">After specific number of cycles</option>
                                            <option value="end_date">Specific end date</option>
                                        </select>
                                    </div>
                                    <div id="cyclesInput" class="hidden">
                                        <label class="block text-xs text-gray-600 mb-1">Number of Billing Cycles</label>
                                        <input type="number" id="billingCycles" min="1" placeholder="e.g., 12"
                                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500" />
                                    </div>
                                    <div id="endDateInput" class="hidden">
                                        <label class="block text-xs text-gray-600 mb-1">End Date</label>
                                        <input type="date" id="subscriptionEndDate"
                                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500" />
                                    </div>
                                    <div class="flex items-center gap-2 p-2 bg-green-50 rounded">
                                        <input type="checkbox" id="autoCharge" checked class="rounded text-green-600" />
                                        <label for="autoCharge" class="text-xs text-green-800">
                                            <strong>Auto-charge enabled</strong> - Automatically charge customer on
                                            billing date
                                        </label>
                                    </div>
                                    <div class="p-2 bg-blue-50 rounded text-xs text-blue-800">
                                        <strong>Next Invoice:</strong> <span id="nextInvoiceDate">-</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Deposit Amount (shown when deposit selected) -->
                            <div id="paymentDepositSection" class="hidden mt-4 p-4 bg-gray-50 rounded-lg">
                                <h3 class="text-sm font-medium text-gray-700 mb-3">Deposit Amount</h3>
                                <div class="space-y-2">
                                    <div class="flex gap-2">
                                        <div class="flex-1">
                                            <div class="relative">
                                                <span class="absolute left-3 top-2.5 text-gray-500">$</span>
                                                <input type="number" id="depositAmount" placeholder="0.00" min="0"
                                                    step="0.01"
                                                    class="w-full pl-7 pr-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                                                    oninput="updateDepositCalculation()" />
                                            </div>
                                        </div>
                                        <div class="flex-1">
                                            <div class="relative">
                                                <input type="number" id="depositPercentage" placeholder="0" min="0"
                                                    max="100" step="1"
                                                    class="w-full pr-8 pl-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                                                    oninput="updateDepositFromPercentage()" />
                                                <span class="absolute right-3 top-2.5 text-gray-500">%</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="flex gap-2">
                                        <button type="button" onclick="setDepositPercentage(25)"
                                            class="flex-1 px-3 py-1.5 text-xs border border-gray-300 rounded hover:bg-gray-50">25%</button>
                                        <button type="button" onclick="setDepositPercentage(50)"
                                            class="flex-1 px-3 py-1.5 text-xs border border-gray-300 rounded hover:bg-gray-50">50%</button>
                                        <button type="button" onclick="setDepositPercentage(75)"
                                            class="flex-1 px-3 py-1.5 text-xs border border-gray-300 rounded hover:bg-gray-50">75%</button>
                                    </div>
                                    <div class="p-2 bg-blue-50 rounded text-xs text-blue-800">
                                        <strong>Remaining Balance:</strong> <span id="remainingBalance">$0.00</span>
                                    </div>
                                    <div class="pt-3 border-t border-gray-200">
                                        <label class="block text-xs text-gray-600 mb-1">Remaining Balance Due
                                            Date</label>
                                        <div class="space-y-2">
                                            <select id="remainingBalanceDueType"
                                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                                                onchange="toggleRemainingBalanceDueDate()">
                                                <option value="specific_date">Specific Date</option>
                                                <option value="days_after_deposit">Days After Deposit</option>
                                                <option value="days_before_service">Days Before Service Completion
                                                </option>
                                                <option value="after_service">After Service Completion</option>
                                            </select>
                                            <div id="specificDateInput">
                                                <input type="date" id="remainingBalanceDueDate"
                                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500" />
                                            </div>
                                            <div id="daysAfterDepositInput" class="hidden">
                                                <div class="flex items-center gap-2">
                                                    <input type="number" id="daysAfterDeposit" min="1" value="30"
                                                        placeholder="30"
                                                        class="w-24 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500" />
                                                    <span class="text-xs text-gray-500">days after deposit
                                                        payment</span>
                                                </div>
                                            </div>
                                            <div id="daysBeforeServiceInput" class="hidden">
                                                <div class="flex items-center gap-2">
                                                    <input type="number" id="daysBeforeService" min="1" value="30"
                                                        placeholder="30"
                                                        class="w-24 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500" />
                                                    <span class="text-xs text-gray-500">days before service
                                                        completion</span>
                                                </div>
                                            </div>
                                            <p class="text-xs text-gray-500 italic" id="remainingBalanceDuePreview">Due
                                                date will be calculated based on your selection</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                        </div>

                        <!-- Accepted Payment Methods Section -->
                        <div class="bg-white rounded-lg shadow-sm p-6">
                            <h2 class="text-lg font-semibold text-gray-900 mb-4">Accepted Payment Methods</h2>

                            <div id="paymentMethodsContainer" class="space-y-2">
                                <label
                                    class="flex items-center gap-2 p-2 border-2 border-purple-300 bg-purple-50 rounded hover:bg-purple-100 cursor-pointer">
                                    <input type="radio" name="paymentMethod" id="paymentStripe" value="stripe" checked
                                        class="text-purple-600" onchange="updatePaymentMethodsDisplay()" />
                                    <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor"
                                        viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z">
                                        </path>
                                    </svg>
                                    <span class="text-sm font-medium">Stripe</span>
                                </label>
                                <label
                                    class="flex items-center gap-2 p-2 border border-gray-200 rounded hover:bg-gray-50 cursor-pointer">
                                    <input type="radio" name="paymentMethod" id="paymentCash" value="cash"
                                        class="text-purple-600" onchange="updatePaymentMethodsDisplay()" />
                                    <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor"
                                        viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z">
                                        </path>
                                    </svg>
                                    <span class="text-sm font-medium">Cash</span>
                                </label>
                            </div>
                            <p class="text-xs text-gray-500 mt-2" id="paymentMethodHint">Select one payment method</p>
                        </div>

                        <!-- Payment Terms Section -->
                        <div class="bg-white rounded-lg shadow-sm p-6">
                            <h2 class="text-lg font-semibold text-gray-900 mb-4">Payment Terms</h2>

                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Default Payment
                                        Terms</label>
                                    <select id="defaultPaymentTerms"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                                        <option value="due_on_receipt">Due on Receipt</option>
                                        <option value="net_7">Net 7 Days</option>
                                        <option value="net_15">Net 15 Days</option>
                                        <option value="net_30" selected>Net 30 Days</option>
                                        <option value="net_60">Net 60 Days</option>
                                    </select>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Payment
                                        Instructions</label>
                                    <textarea id="paymentInstructions" rows="3"
                                        placeholder="Payment instructions, terms, or special notes..."
                                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"></textarea>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Right Column - Payment Summary -->
                    <div class="space-y-4">

                        <!-- Payment Configuration Summary -->
                        <div class="bg-white rounded-lg shadow-sm p-4 sticky top-4">
                            <h2 class="text-lg font-semibold text-gray-900 mb-4">Payment Configuration Summary</h2>

                            <div class="space-y-3 mb-4">
                                <div class="p-3 bg-purple-50 rounded-lg">
                                    <div class="text-xs text-purple-600 mb-1">Payment Model</div>
                                    <div class="text-lg font-bold text-purple-700" id="paymentModelDisplay">Full Payment
                                    </div>
                                </div>

                                <div class="space-y-2 text-sm">
                                    <div id="depositInfo" class="hidden">
                                        <div class="flex justify-between text-xs">
                                            <span class="text-gray-600">Deposit Amount</span>
                                            <span class="text-gray-900 font-semibold"
                                                id="depositAmountDisplay">$0.00</span>
                                        </div>
                                        <div class="flex justify-between text-xs">
                                            <span class="text-gray-600">Remaining Balance</span>
                                            <span class="text-gray-600" id="remainingBalanceDisplay">$0.00</span>
                                        </div>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Payment Terms</span>
                                        <span class="text-gray-900 font-medium" id="paymentTermsDisplay">Net 30
                                            Days</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Payment Methods</span>
                                        <span class="text-gray-900 font-medium" id="paymentMethodsDisplay">2
                                            selected</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Auto-save Indicator -->
                            <div class="mt-4 p-3 bg-green-50 rounded-lg border border-green-200">
                                <div class="flex items-center gap-2">
                                    <svg class="w-4 h-4 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd"
                                            d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                                            clip-rule="evenodd"></path>
                                    </svg>
                                    <p class="text-xs text-green-800">
                                        <strong>Auto-saved</strong> - Changes are saved automatically
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Invoices Tab Content -->
            <div id="invoicesContent" class="tab-content hidden">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">

                    <!-- Left Column - Invoice Management -->
                    <div class="lg:col-span-2 space-y-4">

                        <!-- Payment Configuration Summary Section -->
                        <div class="bg-white rounded-lg shadow-sm p-6">
                            <div class="flex items-center justify-between mb-4">
                                <h2 class="text-lg font-semibold text-gray-900">Payment Configuration Summary</h2>
                                <button onclick="switchTab('paymentConfig')"
                                    class="text-sm text-blue-600 hover:text-blue-700">
                                    Edit Settings
                                </button>
                            </div>

                            <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                                <div class="grid grid-cols-3 gap-4 text-sm">
                                    <div>
                                        <div class="text-xs text-gray-600 mb-1">Payment Model</div>
                                        <div class="font-medium text-gray-900" id="invoiceTabPaymentModel">Full Payment
                                        </div>
                                    </div>
                                    <div>
                                        <div class="text-xs text-gray-600 mb-1">Payment Terms</div>
                                        <div class="font-medium text-gray-900" id="invoiceTabPaymentTerms">Net 30 Days
                                        </div>
                                    </div>
                                    <div>
                                        <div class="text-xs text-gray-600 mb-1">Payment Methods</div>
                                        <div class="font-medium text-gray-900" id="invoiceTabPaymentMethods">Stripe
                                        </div>
                                    </div>
                                </div>

                                <div id="invoiceTabDepositInfo" class="hidden mt-3 pt-3 border-t border-gray-200">
                                    <div class="grid grid-cols-2 gap-4 text-sm">
                                        <div>
                                            <span class="text-gray-600">Deposit Amount:</span>
                                            <span class="font-medium text-gray-900 ml-2"
                                                id="invoiceTabDepositAmount">$0.00</span>
                                        </div>
                                        <div>
                                            <span class="text-gray-600">Remaining Balance:</span>
                                            <span class="font-medium text-gray-900 ml-2"
                                                id="invoiceTabRemainingBalance">$0.00</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>


                        <!-- Invoice Management Section -->
                        <div class="bg-white rounded-lg shadow-sm p-6">
                            <div class="flex items-center justify-between mb-4">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center gap-3">
                                        <div class="w-8 h-8 bg-blue-500 rounded-lg flex items-center justify-center">
                                            <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor"
                                                viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M9 12h6m-6 4h6m2 5H7a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5.586a1 1 0 0 1 .707.293l5.414 5.414a1 1 0 0 1 .293.707V19a2 2 0 0 1-2 2z">
                                                </path>
                                            </svg>
                                        </div>
                                        <div>
                                            <h2 class="text-lg font-bold text-gray-900">Invoice Management</h2>
                                            <p class="text-xs text-gray-500" id="invoiceCount">0 Invoices</p>
                                        </div>
                                    </div>
                                    <button onclick="refreshInvoices()"
                                        class="px-4 py-2 bg-white border border-gray-300 text-gray-700 text-sm font-medium rounded-lg hover:bg-gray-50 transition-all flex items-center gap-2">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M4 4v5h.582m15.356 2A8.001 8.001 0 0 0 4.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 0 1-15.357-2m15.357 2H15">
                                            </path>
                                        </svg>
                                        Refresh
                                    </button>
                                </div>
                            </div>

                            <!-- Overdue Warning Banner -->
                            <div id="overdueWarningBanner"
                                class="hidden mb-4 bg-red-50 border-l-4 border-red-600 p-4 rounded">
                                <div class="flex items-start">
                                    <div class="flex-shrink-0">
                                        <svg class="w-5 h-5 text-red-600" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd"
                                                d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z"
                                                clip-rule="evenodd"></path>
                                        </svg>
                                    </div>
                                    <div class="ml-3 flex-1">
                                        <h3 class="text-sm font-bold text-red-800" id="overdueWarningTitle">Overdue
                                            Invoices</h3>
                                        <p class="text-xs text-red-700 mt-1" id="overdueWarningMessage">You have overdue
                                            invoices that require immediate attention.</p>
                                    </div>
                                </div>
                            </div>

                            <div id="invoicesList" class="space-y-3">
                                <!-- Invoices will be populated here -->
                            </div>

                            <div id="noInvoicesState" class="text-center py-8 text-gray-500">
                                <svg class="mx-auto mb-3 text-gray-400 w-12 h-12" fill="none" stroke="currentColor"
                                    viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M9 12h6m-6 4h6m2 5H7a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5.586a1 1 0 0 1 .707.293l5.414 5.414a1 1 0 0 1 .293.707V19a2 2 0 0 1-2 2z">
                                    </path>
                                </svg>
                                <p class="text-sm font-medium text-gray-700 mb-1">No invoices published yet</p>
                                <p class="text-xs text-gray-500">Click "Publish Invoice" to create invoices. Payers can
                                    be assigned after invoice creation.</p>
                            </div>

                        </div>


                    </div>

                    <!-- Right Column - Invoice Summary -->
                    <div class="lg:col-span-1 space-y-4">

                        <!-- Invoice Summary -->
                        <div class="bg-white rounded-lg shadow-sm p-4 sticky top-4">
                            <h2 class="text-lg font-semibold text-gray-900 mb-4">Invoice Summary</h2>

                            <!-- Quote-style Financial Breakdown -->
                            <div class="space-y-3 mb-4">
                                <div class="flex justify-between text-sm">
                                    <span class="text-gray-600">Subtotal</span>
                                    <span class="font-medium" id="invoiceSubtotalAmount">$0.00</span>
                                </div>

                                <div id="invoiceLineItemDiscountSection" class="hidden">
                                    <div class="flex justify-between text-sm">
                                        <span class="text-sm text-gray-600">Line Item Discounts</span>
                                        <span class="text-sm font-medium text-red-600"
                                            id="invoiceLineItemDiscountAmount">-$0.00</span>
                                    </div>
                                </div>

                                <div class="border-t border-gray-200 pt-3">
                                    <div class="text-xs text-gray-600 mb-2">Tax Breakdown:</div>
                                    <div id="invoiceTaxBreakdown" class="space-y-1 text-xs">
                                        <div class="text-gray-400">No taxable items</div>
                                    </div>
                                    <div class="flex justify-between items-center mt-2 pt-2 border-t border-gray-100">
                                        <span class="text-sm text-gray-600">Total Tax</span>
                                        <span class="text-sm font-medium" id="invoiceTaxAmount">$0.00</span>
                                    </div>
                                </div>

                                <div class="border-t-2 border-gray-300 pt-3">
                                    <div class="flex justify-between">
                                        <span class="font-bold text-gray-900 text-lg">Quote Total</span>
                                        <span class="font-bold text-gray-900 text-lg"
                                            id="invoiceQuoteTotal">$0.00</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Financial Breakdown -->
                            <div class="space-y-2 text-sm mb-4">
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Total Invoiced</span>
                                    <span class="font-medium text-gray-900" id="totalInvoiced">$0.00</span>
                                </div>

                                <!-- Down Payment Breakdown (shown only for deposit payment model) -->
                                <div id="downPaymentBreakdown" class="hidden space-y-1 pt-2 border-t border-gray-200">
                                    <div class="flex justify-between text-xs">
                                        <span class="text-gray-500">Deposit Invoiced:</span>
                                        <span class="font-medium text-gray-700" id="depositInvoiced">$0.00</span>
                                    </div>
                                    <div class="flex justify-between text-xs">
                                        <span class="text-gray-500">Balance Invoiced:</span>
                                        <span class="font-medium text-gray-700" id="balanceInvoiced">$0.00</span>
                                    </div>
                                    <div class="flex justify-between text-xs pt-1 border-t border-gray-100">
                                        <span class="text-gray-500">Remaining Balance:</span>
                                        <span class="font-semibold text-blue-600"
                                            id="remainingBalanceToInvoice">$0.00</span>
                                    </div>
                                </div>

                                <div class="flex justify-between">
                                    <span class="text-gray-600">Total Paid</span>
                                    <span class="font-medium text-green-600" id="totalPaid">$0.00</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Outstanding</span>
                                    <span class="font-medium text-red-600" id="totalOutstanding">$0.00</span>
                                </div>
                                <div class="flex justify-between border-t border-gray-200 pt-2">
                                    <span class="text-gray-600">Remaining to Invoice</span>
                                    <span class="font-semibold text-blue-600" id="remainingToInvoice">$0.00</span>
                                </div>
                            </div>

                            <!-- Invoice Status -->
                            <div class="border-t border-gray-200 pt-3 mb-3">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-sm font-medium text-gray-700">Invoice Status</span>
                                    <span id="invoiceStatusBadge"
                                        class="px-2 py-1 bg-gray-100 text-gray-700 rounded text-xs font-medium">Not
                                        Invoiced</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-2">
                                    <div id="invoiceProgressBar"
                                        class="bg-blue-600 h-2 rounded-full transition-all duration-300"
                                        style="width: 0%"></div>
                                </div>
                                <p class="text-xs text-gray-500 mt-1" id="invoiceProgressText">0% of quote amount
                                    invoiced</p>
                            </div>

                            <!-- Quick Actions -->
                            <div class="border-t border-gray-200 pt-3">
                                <h3 class="text-sm font-medium text-gray-700 mb-2">Quick Actions</h3>
                                <div class="space-y-2">
                                    <button onclick="sendPaymentReminder()"
                                        class="w-full text-left px-3 py-2 text-sm text-gray-700 hover:bg-gray-50 rounded-lg flex items-center gap-2">
                                        <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor"
                                            viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z">
                                            </path>
                                        </svg>
                                        Send Payment Reminder
                                    </button>
                                    <button onclick="viewPaymentHistory()"
                                        class="w-full text-left px-3 py-2 text-sm text-gray-700 hover:bg-gray-50 rounded-lg flex items-center gap-2">
                                        <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor"
                                            viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4">
                                            </path>
                                        </svg>
                                        View Payment History
                                    </button>
                                    <button onclick="downloadInvoiceReport()"
                                        class="w-full text-left px-3 py-2 text-sm text-gray-700 hover:bg-gray-50 rounded-lg flex items-center gap-2">
                                        <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor"
                                            viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5.586a1 1 0 0 1 .707.293l5.414 5.414a1 1 0 0 1 .293.707V19a2 2 0 0 1-2 2z">
                                            </path>
                                        </svg>
                                        Download Invoice Report
                                    </button>
                                </div>
                            </div>

                            <!-- Publish Invoice Button -->
                            <button id="createInvoicesBtn" onclick="createInvoices()"
                                class="w-full mt-4 px-4 py-3 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 flex items-center justify-center gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M12 4v16m8-8H4"></path>
                                </svg>
                                Publish Invoice
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- PDF Preview Modal -->
    <div id="pdfPreviewModal" class="hidden fixed inset-0 bg-black bg-opacity-75 z-50 flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-xl w-full mx-4 max-w-6xl max-h-[95vh] flex flex-col">
            <div class="p-4 border-b border-gray-200 flex items-center justify-between">
                <h3 class="text-lg font-semibold text-gray-900">PDF Preview</h3>
                <div class="flex gap-2">
                    <button id="downloadPdfFromPreview"
                        class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm font-medium flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                        </svg>
                        Download PDF
                    </button>
                    <button id="closePdfPreview"
                        class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 text-sm">
                        Close
                    </button>
                </div>
            </div>

            <div class="flex-1 overflow-hidden">
                <iframe id="pdfPreviewFrame" class="w-full h-full" style="min-height: 600px;"></iframe>
            </div>
        </div>
    </div>

    <!-- Mark as Paid Modal -->
    <div id="recordPaymentModal"
        class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-xl w-full mx-4 max-w-md">
            <div class="p-6">
                <h3 class="text-xl font-bold text-gray-900 mb-1">Record Payment</h3>
                <p class="text-sm text-gray-500">Record a payment for this invoice</p>
            </div>

            <div class="px-6 pb-6 space-y-4">
                <!-- Invoice Details -->
                <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                    <div class="flex items-center justify-between mb-3">
                        <div class="text-sm text-gray-600">Invoice Number</div>
                        <div class="font-semibold text-gray-900" id="paymentInvoiceId">-</div>
                    </div>
                    <div class="flex items-center justify-between pt-3 border-t border-gray-200">
                        <div class="text-sm text-gray-600">Payment Amount</div>
                        <div class="text-lg font-bold text-green-600" id="paymentAmountDisplay">$0.00</div>
                    </div>
                </div>

                <!-- Information Note -->
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                    <p class="text-sm text-blue-800">
                        <strong>Note:</strong> <span id="paymentNoteText">This will record a payment for the outstanding
                            amount.</span>
                    </p>
                </div>

                <!-- Payment Date -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Payment Date <span class="text-red-500">*</span>
                    </label>
                    <div class="relative">
                        <input type="date" id="paymentDate"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" />
                    </div>
                </div>

                <!-- Notes (Optional) -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Notes (Optional)</label>
                    <textarea id="paymentNotes" rows="3" placeholder="Add any additional notes about this payment..."
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none"></textarea>
                </div>
            </div>

            <div class="p-6 border-t border-gray-200 flex items-center justify-end gap-3">
                <button onclick="closeRecordPaymentModal()"
                    class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 font-medium">
                    Cancel
                </button>
                <button onclick="confirmRecordPayment()"
                    class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-medium">
                    Mark as Paid
                </button>
            </div>
        </div>
    </div>

    <!-- Payment History Modal -->
    <div id="paymentHistoryModal"
        class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[80vh] flex flex-col">
            <div class="p-6 border-b border-gray-200 flex justify-between items-center">
                <h3 class="text-xl font-bold text-gray-900">Payment History</h3>
                <button onclick="closePaymentHistoryModal()" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                        </path>
                    </svg>
                </button>
            </div>
            <div class="p-6 overflow-y-auto custom-scrollbar flex-1">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="text-xs text-gray-500 border-b border-gray-200">
                            <th class="py-2 font-medium">Date</th>
                            <th class="py-2 font-medium">Invoice</th>
                            <th class="py-2 font-medium">Payer</th>
                            <th class="py-2 font-medium">Method</th>
                            <th class="py-2 font-medium text-right">Amount</th>
                            <th class="py-2 font-medium text-center">Status</th>
                        </tr>
                    </thead>
                    <tbody id="paymentHistoryTableBody" class="text-sm text-gray-700 divide-y divide-gray-100">
                        <!-- Rows populated by JS -->
                    </tbody>
                </table>
                <div id="noPaymentHistoryMsg" class="hidden text-center text-gray-500 py-8">
                    No payments recorded yet.
                </div>
            </div>
            <div class="p-4 border-t border-gray-200 bg-gray-50 rounded-b-lg flex justify-end">
                <button onclick="closePaymentHistoryModal()"
                    class="px-4 py-2 border border-gray-300 bg-white text-gray-700 rounded-lg hover:bg-gray-50 font-medium">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Toast Notification Container -->
    <div id="toastContainer" class="fixed top-4 right-4 z-50 space-y-2"> </div>

    <!-- Assign Payers Modal -->
    <div id="assignPayersModal"
        class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-7xl max-h-[95vh] overflow-hidden flex flex-col">
            <!-- Modal Header -->
            <div class="p-6 border-b border-gray-200">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-4">
                        <div
                            class="w-14 h-14 bg-gradient-to-br from-purple-600 to-indigo-600 rounded-xl flex items-center justify-center shadow-lg">
                            <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z">
                                </path>
                            </svg>
                        </div>
                        <div>
                            <h3 class="text-2xl font-bold text-gray-900">Manage Payment Requests</h3>
                            <p class="text-sm text-gray-500 mt-1" id="assignPayersInvoiceId">INV-2024-001</p>
                        </div>
                    </div>
                    <div class="flex gap-3">
                        <button onclick="savePayerAssignment()"
                            class="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 font-semibold flex items-center gap-2 shadow-md hover:shadow-lg transition-all duration-200"
                            id="saveAssignmentBtn">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M5 13l4 4L19 7"></path>
                            </svg>
                            Save Assignment
                        </button>
                        <button onclick="closeAssignPayersModal()"
                            class="px-5 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 font-medium transition-colors">
                            Cancel
                        </button>
                    </div>
                </div>
            </div>

            <div class="flex-1 overflow-y-auto custom-scrollbar p-6">
                <div class="space-y-6">
                    <!-- Invoice Info -->
                    <div class="bg-gradient-to-br from-gray-50 to-gray-100 border border-gray-200 rounded-lg p-4">
                        <div class="flex items-center justify-between">
                            <div class="text-sm text-gray-600">Invoice Amount</div>
                            <div class="text-3xl font-bold text-gray-900" id="assignPayersInvoiceAmount">$0.00</div>
                        </div>
                    </div>

                    <!-- Invoice Distribution Section -->
                    <div
                        class="bg-white rounded-lg shadow-sm p-6 border border-purple-200 bg-gradient-to-br from-purple-50 to-indigo-50">
                        <div class="mb-5">
                            <div class="flex items-center gap-2 mb-2">
                                <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor"
                                    viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z">
                                    </path>
                                </svg>
                                <h3 class="text-lg font-semibold text-gray-900">Invoice Distribution</h3>
                            </div>
                            <p class="text-sm text-gray-600">
                                Configure how invoices are distributed among multiple payers. Adjust percentages and
                                amounts below.
                            </p>
                        </div>

                        <!-- Add Payer Section -->
                        <div class="flex items-center justify-between mb-4">
                            <label class="text-sm font-medium text-gray-700">Payers</label>
                            <div class="flex items-center gap-2">
                                <select id="assignModalContactSelector"
                                    class="px-3 py-1 border border-gray-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-purple-500">
                                    <option value="">Select contact to add...</option>
                                    <option value="contact1">John Smith - john@company.com</option>
                                    <option value="contact2">Sarah Johnson - sarah@business.com</option>
                                    <option value="contact3">Mike Wilson - mike@corp.com</option>
                                    <option value="quick-add">+ Quick Add New Contact</option>
                                </select>
                                <button id="assignModalAddSelectedPayerBtn"
                                    onclick="addSelectedPayerToAssignmentModal()"
                                    class="px-3 py-1 bg-purple-600 text-white text-sm rounded hover:bg-purple-700 transition-colors">
                                    Add
                                </button>
                            </div>
                        </div>

                        <!-- Payers Table -->
                        <div class="bg-white border border-gray-300 rounded-lg overflow-hidden mb-4 shadow-sm">
                            <table class="w-full">
                                <thead class="bg-gradient-to-r from-gray-50 to-gray-100">
                                    <tr>
                                        <th
                                            class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">
                                            Contact</th>
                                        <th
                                            class="px-4 py-3 text-center text-xs font-semibold text-gray-700 uppercase tracking-wider">
                                            Percentage</th>
                                        <th
                                            class="px-4 py-3 text-center text-xs font-semibold text-gray-700 uppercase tracking-wider">
                                            Amount</th>
                                        <th
                                            class="px-4 py-3 text-center text-xs font-semibold text-gray-700 uppercase tracking-wider">
                                            Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="assignModalPayersTableBody" class="bg-white divide-y divide-gray-200">
                                    <!-- Payers will be populated here -->
                                </tbody>
                            </table>
                        </div>

                        <!-- Summary Row -->
                        <div
                            class="bg-gradient-to-r from-gray-50 to-gray-100 border-2 border-gray-300 rounded-lg p-4 mb-4">
                            <div class="flex justify-between items-center">
                                <span class="text-sm font-semibold text-gray-700 uppercase tracking-wide">Total:</span>
                                <div class="flex items-center gap-6">
                                    <div class="text-center">
                                        <div class="text-xs text-gray-600 mb-1">Percentage</div>
                                        <span id="assignModalTotalPercentage"
                                            class="text-lg font-bold text-green-600">100%</span>
                                    </div>
                                    <div class="text-center">
                                        <div class="text-xs text-gray-600 mb-1">Amount</div>
                                        <span id="assignModalTotalAmount"
                                            class="text-xl font-bold text-gray-900">$0.00</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Validation Warning -->
                        <div id="assignModalDistributionValidationWarning"
                            class="hidden bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                            <div class="flex items-start gap-2">
                                <svg class="w-4 h-4 text-yellow-600 flex-shrink-0 mt-0.5" fill="none"
                                    stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z">
                                    </path>
                                </svg>
                                <p class="text-xs text-yellow-800" id="assignModalDistributionValidationMessage">Total
                                    percentage must equal 100%</p>
                            </div>
                        </div>
                    </div>

                    <!-- Invoice Summary Section -->
                    <div
                        class="bg-gradient-to-br from-blue-50 via-indigo-50 to-blue-50 border-2 border-blue-300 rounded-xl p-6 shadow-md">
                        <div class="flex items-start justify-between mb-4">
                            <div class="flex-1">
                                <div class="flex items-center gap-3 mb-3">
                                    <div class="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center">
                                        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor"
                                            viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M9 12h6m-6 4h6m2 5H7a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5.586a1 1 0 0 1 .707.293l5.414 5.414a1 1 0 0 1 .293.707V19a2 2 0 0 1-2 2z">
                                            </path>
                                        </svg>
                                    </div>
                                    <div class="flex-1">
                                        <h4 class="text-xl font-bold text-gray-900 mb-1">Invoice Summary</h4>
                                        <p class="text-sm text-gray-600">Review the invoice details and line items</p>
                                    </div>
                                </div>
                            </div>
                            <div class="text-right ml-6 pl-6 border-l-2 border-blue-200">
                                <div class="text-4xl font-bold text-blue-900 mb-1" id="assignModalInvoiceTotal">$0.00
                                </div>
                                <div class="text-sm text-gray-600 font-medium">Total Invoice Amount</div>
                            </div>
                        </div>

                        <!-- Quote Totals & Items -->
                        <div class="mt-4 pt-4 border-t border-blue-200">
                            <h5 class="text-xs font-semibold text-blue-700 uppercase tracking-wide mb-2">Quote Totals &
                                Items</h5>
                            <div class="bg-white/80 rounded-lg border border-blue-100 p-4 mb-4"
                                id="assignModalQuoteTotals">
                                <!-- Quote totals will be populated here -->
                            </div>
                            <div class="mt-3">
                                <p class="text-[10px] uppercase tracking-wide text-gray-500 font-semibold mb-2">Line
                                    Items</p>
                                <div id="assignModalLineItems">
                                    <!-- Line items will be populated here -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Invoice Preview Card -->
                    <div id="assignModalInvoicePreview"
                        class="bg-white border-2 border-purple-200 rounded-xl p-6 shadow-md">
                        <!-- Invoice preview card will be populated here -->
                    </div>
                </div>
            </div>

            <div class="p-6 border-t border-gray-200 flex items-center justify-end gap-3">
                <button onclick="closeAssignPayersModal()"
                    class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
                    Cancel
                </button>
                <button onclick="savePayerAssignment()"
                    class="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 font-semibold flex items-center gap-2 shadow-md hover:shadow-lg transition-all duration-200"
                    id="saveAssignmentBtn">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                    Save Assignment
                </button>
            </div>
        </div>
    </div>

    <!-- Payment Confirmation Modal -->
    <div id="confirmPaymentModal"
        class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-xl w-full mx-4 max-w-md">
            <div class="p-6 border-b border-gray-200">
                <h3 class="text-lg font-semibold text-gray-900">Confirm Payment</h3>
                <p class="text-sm text-gray-500 mt-1">Confirm this payment to update the invoice</p>
            </div>

            <div class="p-6 space-y-4">
                <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-600">Amount:</span>
                            <span class="font-semibold text-gray-900" id="confirmPaymentAmount">$0.00</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Payer:</span>
                            <span class="font-semibold text-gray-900" id="confirmPaymentPayer">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Method:</span>
                            <span class="font-semibold text-gray-900" id="confirmPaymentMethod">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Date:</span>
                            <span class="font-semibold text-gray-900" id="confirmPaymentDate">-</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="p-6 border-t border-gray-200 flex items-center justify-end gap-3">
                <button onclick="closeConfirmPaymentModal()"
                    class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
                    Cancel
                </button>
                <button onclick="executeConfirmPayment()"
                    class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-medium">
                    Confirm Payment
                </button>
            </div>
        </div>
    </div>

    <!-- Payment Cancellation Modal -->
    <div id="cancelPaymentModal"
        class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-xl w-full mx-4 max-w-md">
            <div class="p-6 border-b border-gray-200">
                <h3 class="text-lg font-semibold text-gray-900">Cancel Payment</h3>
                <p class="text-sm text-gray-500 mt-1">Cancel this payment and remove it from the invoice</p>
            </div>

            <div class="p-6 space-y-4">
                <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-600">Amount:</span>
                            <span class="font-semibold text-gray-900" id="cancelPaymentAmount">$0.00</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Payer:</span>
                            <span class="font-semibold text-gray-900" id="cancelPaymentPayer">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Method:</span>
                            <span class="font-semibold text-gray-900" id="cancelPaymentMethod">-</span>
                        </div>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Reason for Cancellation <span class="text-red-500">*</span>
                    </label>
                    <textarea id="cancellationReason" rows="3" placeholder="Enter reason for cancelling this payment..."
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500"></textarea>
                </div>

                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                    <p class="text-sm text-yellow-800">
                        <strong>Warning:</strong> This will remove this payment from the invoice. The invoice paid
                        amount will be updated accordingly.
                    </p>
                </div>
            </div>

            <div class="p-6 border-t border-gray-200 flex items-center justify-end gap-3">
                <button onclick="closeCancelPaymentModal()"
                    class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
                    Cancel
                </button>
                <button onclick="executeCancelPayment()"
                    class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 font-medium">
                    Cancel Payment
                </button>
            </div>
        </div>
    </div>

    <!-- Price Modification Modal -->
    <div id="priceModModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
            <div class="p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-900">Modify Price</h3>
                    <button id="closePriceModModal" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>

                <div class="mb-4">
                    <div class="flex items-center gap-2 mb-2">
                        <p class="text-sm font-medium text-gray-900" id="priceModItemName"></p>
                        <span id="priceModItemType"></span>
                    </div>
                    <div class="flex items-center gap-2 text-sm">
                        <span class="text-gray-600">Original Price:</span>
                        <span class="font-medium" id="priceModOriginal"></span>
                    </div>
                    <div class="flex items-center gap-2 text-sm mt-1">
                        <span class="text-gray-600">New Price:</span>
                        <span class="font-semibold text-blue-600" id="priceModNew"></span>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Reason for modification <span
                            class="text-red-600">*</span></label>
                    <textarea id="priceModComment" rows="3"
                        placeholder="Enter reason for price modification (required for record keeping)"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                </div>

                <div class="flex gap-3">
                    <button id="cancelPriceModBtn"
                        class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 text-sm font-medium">
                        Cancel
                    </button>
                    <button id="savePriceModBtn"
                        class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm font-medium">
                        Save Changes
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Invoice Preview Modal -->
    <div id="invoicePreviewModal"
        class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-2xl max-w-7xl w-full max-h-[95vh] overflow-hidden flex flex-col">
            <!-- Modal Header -->
            <div class="bg-white rounded-t-lg shadow-sm p-6 border-b border-gray-200">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-4">
                        <div
                            class="w-14 h-14 bg-gradient-to-br from-blue-600 to-indigo-600 rounded-xl flex items-center justify-center shadow-lg">
                            <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9 12h6m-6 4h6m2 5H7a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5.586a1 1 0 0 1 .707.293l5.414 5.414a1 1 0 0 1 .293.707V19a2 2 0 0 1-2 2z">
                                </path>
                            </svg>
                        </div>
                        <div>
                            <h3 class="text-2xl font-bold text-gray-900">Invoice Preview</h3>
                            <p class="text-sm text-gray-600 mt-1">Review invoices that will be created. Payers can be
                                assigned after invoice creation.</p>
                        </div>
                    </div>
                    <div class="flex gap-3">
                        <button id="createAllInvoicesBtn"
                            class="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 font-semibold flex items-center gap-2 shadow-md hover:shadow-lg transition-all duration-200">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M5 13l4 4L19 7"></path>
                            </svg>
                            Confirm & Publish
                        </button>
                        <button id="closeInvoicePreviewBtn"
                            class="px-5 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 font-medium transition-colors">
                            Cancel
                        </button>
                    </div>
                </div>
            </div>

            <div class="flex-1 overflow-y-auto custom-scrollbar p-6">
                <!-- Note about Payer Assignment -->
                <div class="mb-6 bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <div class="flex items-start gap-3">
                        <svg class="w-5 h-5 text-blue-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor"
                            viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <div>
                            <h4 class="text-sm font-semibold text-blue-900 mb-1">Payment Requests</h4>
                            <p class="text-xs text-blue-800">
                                Invoices will be created without payment requests. You can manage payment requests
                                after creation using the "Manage Payment Requests" button on each invoice card.
                            </p>
                        </div>
                    </div>
                </div>

                <div id="invoicePreviewContent" class="space-y-6">
                    <!-- Invoice previews will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Existing quote data (would normally come from server/API)
        const existingQuote = {
            id: 'Q-2024-001',
            status: 'draft', // draft, sent, approved, rejected, expired, invoiced
            createdDate: '2024-10-20',
            validUntil: '2026-12-31',
            customerNotes: 'Thank you for your interest in our tutoring services.',
            internalNotes: 'Customer prefers morning sessions.'
        };

        // Status configuration for actions and permissions
        const statusConfig = {
            draft: {
                label: 'ðŸ“ Draft',
                color: 'bg-yellow-100 text-yellow-700',
                canEdit: true,
                canDelete: true,
                actions: [
                    { id: 'save', label: 'Save Changes', color: 'gray', icon: 'save' },
                    { id: 'send', label: 'Send Quote', color: 'blue', icon: 'send', primary: true },
                    { id: 'download', label: 'Download PDF', color: 'gray', icon: 'download' },
                    { id: 'delete', label: 'Delete', color: 'red', icon: 'trash' }
                ]
            },
            sent: {
                label: 'ðŸ“¤ Sent',
                color: 'bg-blue-100 text-blue-700',
                canEdit: true,
                canDelete: false,
                actions: [
                    { id: 'save', label: 'Save Changes', color: 'gray', icon: 'save' },
                    { id: 'resend', label: 'Resend Quote', color: 'green', icon: 'send' },
                    { id: 'approve', label: 'Mark as Approved', color: 'green', icon: 'check', primary: true },
                    { id: 'reject', label: 'Mark as Rejected', color: 'red', icon: 'x' },
                    { id: 'download', label: 'Download PDF', color: 'gray', icon: 'download' }
                ]
            },
            approved: {
                label: 'âœ… Approved',
                color: 'bg-green-100 text-green-700',
                canEdit: false,
                canDelete: false,
                actions: [
                    { id: 'createInvoice', label: 'Create Invoice', color: 'purple', icon: 'invoice', primary: true },
                    { id: 'download', label: 'Download PDF', color: 'gray', icon: 'download' },
                    { id: 'clone', label: 'Clone Quote', color: 'blue', icon: 'copy' }
                ]
            },
            rejected: {
                label: 'âŒ Rejected',
                color: 'bg-red-100 text-red-700',
                canEdit: false,
                canDelete: false,
                actions: [
                    { id: 'clone', label: 'Clone Quote', color: 'blue', icon: 'copy', primary: true },
                    { id: 'download', label: 'Download PDF', color: 'gray', icon: 'download' },
                    { id: 'archive', label: 'Archive', color: 'gray', icon: 'archive' }
                ]
            },
            expired: {
                label: 'â° Expired',
                color: 'bg-orange-100 text-orange-700',
                canEdit: false,
                canDelete: false,
                actions: [
                    { id: 'renew', label: 'Renew Quote', color: 'blue', icon: 'refresh', primary: true },
                    { id: 'extend', label: 'Extend Validity', color: 'green', icon: 'check' },
                    { id: 'clone', label: 'Clone Quote', color: 'blue', icon: 'copy' },
                    { id: 'download', label: 'Download PDF', color: 'gray', icon: 'download' },
                    { id: 'archive', label: 'Archive', color: 'gray', icon: 'archive' }
                ]
            },
            invoiced: {
                label: 'ðŸ’° Invoiced',
                color: 'bg-purple-100 text-purple-700',
                canEdit: false,
                canDelete: false,
                actions: [
                    { id: 'viewInvoices', label: 'View Invoices', color: 'purple', icon: 'invoice', primary: true },
                    { id: 'download', label: 'Download PDF', color: 'gray', icon: 'download' }
                ]
            },
            partially_paid: {
                label: 'ðŸ’¸ Partially Paid',
                color: 'bg-blue-100 text-blue-700',
                canEdit: false,
                canDelete: false,
                actions: [
                    { id: 'viewInvoices', label: 'View Invoices', color: 'purple', icon: 'invoice', primary: true },
                    { id: 'download', label: 'Download PDF', color: 'gray', icon: 'download' }
                ]
            },
            paid: {
                label: 'âœ… Paid',
                color: 'bg-green-100 text-green-700',
                canEdit: false,
                canDelete: false,
                actions: [
                    { id: 'viewInvoices', label: 'View Invoices', color: 'purple', icon: 'invoice', primary: true },
                    { id: 'download', label: 'Download PDF', color: 'gray', icon: 'download' }
                ]
            }
        };

        // State management - Pre-populated with existing quote data for edit mode
        const state = {
            businessType: 'tutoring',
            quoteId: existingQuote.id,
            quoteStatus: existingQuote.status,
            selectedCustomer: {
                id: 1,
                name: 'Alice Anderson',
                email: 'alice.a@email.com',
                phone: '0412 345 678',
                address: '1 Albert St, Melbourne VIC 3000',
                previousQuotes: 3,
                secondaryContacts: [
                    { name: 'John Anderson', email: 'john.a@email.com', phone: '0412 345 679', role: 'Spouse' }
                ]
            },
            selectedQuoteContact: {
                type: 'primary',
                name: 'Alice Anderson',
                email: 'alice.a@email.com',
                phone: '0412 345 678'
            },
            showNewCustomerForm: false,
            quoteItems: [
                {
                    id: 't1',
                    name: 'One-on-One Tutoring - Math',
                    tag: 'Tutoring',
                    type: 'service',
                    price: 75,
                    customPrice: 75,
                    originalPrice: 75,
                    pricingType: 'per_hour',
                    unit: 'hour',
                    taxCategory: 'taxable_gst',
                    quantity: 2,
                    priceModified: false,
                    priceModificationComment: '',
                    notes: 'Focus on algebra and geometry',
                    serviceDate: '2024-10-25',
                    discount: 0,
                    discountType: 'percentage',
                    preferredTime: 'morning',
                    exactTime: '',
                    scheduleNotes: 'Prefer Monday and Wednesday'
                },
                {
                    id: 't4',
                    name: 'Assessment & Report',
                    tag: 'Assessment',
                    type: 'service',
                    price: 120,
                    customPrice: 120,
                    originalPrice: 120,
                    pricingType: 'fixed',
                    unit: 'each',
                    taxCategory: 'taxable_gst',
                    quantity: 1,
                    priceModified: false,
                    priceModificationComment: '',
                    notes: '',
                    serviceDate: '2024-10-28',
                    discount: 0,
                    discountType: 'percentage',
                    preferredTime: '',
                    exactTime: '',
                    scheduleNotes: ''
                }
            ],
            currentPriceModIndex: null,
            currentPriceModNewValue: null
        };

        // Sample data - Customers A-Z
        const customers = [
            {
                id: 1,
                name: 'Alice Anderson',
                email: 'alice.a@email.com',
                phone: '0412 345 678',
                address: '1 Albert St, Melbourne VIC 3000',
                previousQuotes: 3,
                secondaryContacts: [
                    { name: 'John Anderson', email: 'john.a@email.com', phone: '0412 345 679', role: 'Spouse' }
                ]
            },
            {
                id: 2,
                name: 'Bob Brown',
                email: 'bob.brown@email.com',
                phone: '0413 456 789',
                address: '2 Bridge Rd, Richmond VIC 3121',
                previousQuotes: 5,
                secondaryContacts: [
                    { name: 'Sarah Brown', email: 'sarah.b@email.com', phone: '0413 456 790', role: 'Assistant' },
                    { name: 'Mike Brown', email: 'mike.b@email.com', phone: '0413 456 791', role: 'Business Partner' }
                ]
            },
            { id: 3, name: 'Charlie Chen', email: 'charlie.c@email.com', phone: '0414 567 890', address: '3 Chapel St, Windsor VIC 3181', previousQuotes: 2 },
            { id: 4, name: 'David Davis', email: 'david.d@email.com', phone: '0412 444 444', address: '4 Docklands Dr, Docklands VIC 3008', previousQuotes: 0 },
            { id: 5, name: 'Emily Evans', email: 'emily.evans@email.com', phone: '0412 555 555', address: '5 Elizabeth St, Melbourne VIC 3000', previousQuotes: 2 },
            { id: 6, name: 'Frank Foster', email: 'frank.f@email.com', phone: '0412 666 666', address: '6 Flinders St, Melbourne VIC 3000', previousQuotes: 4 },
            { id: 7, name: 'Grace Garcia', email: 'grace.g@email.com', phone: '0412 777 777', address: '7 Glenferrie Rd, Hawthorn VIC 3122', previousQuotes: 1 },
            { id: 8, name: 'Henry Harris', email: 'henry.h@email.com', phone: '0412 888 888', address: '8 High St, Kew VIC 3101', previousQuotes: 6 },
            { id: 9, name: 'Isabella Ibrahim', email: 'isabella.i@email.com', phone: '0412 999 999', address: '9 Inkerman St, St Kilda VIC 3182', previousQuotes: 0 },
            { id: 10, name: 'James Johnson', email: 'james.j@email.com', phone: '0413 111 111', address: '10 Johnston St, Fitzroy VIC 3065', previousQuotes: 3 },
            { id: 11, name: 'Katherine Kim', email: 'kate.kim@email.com', phone: '0413 222 222', address: '11 King St, Melbourne VIC 3000', previousQuotes: 2 },
            { id: 12, name: 'Liam Lee', email: 'liam.lee@email.com', phone: '0413 333 333', address: '12 Lygon St, Carlton VIC 3053', previousQuotes: 7 },
            { id: 13, name: 'Maria Martinez', email: 'maria.m@email.com', phone: '0413 444 444', address: '13 Main Rd, Eltham VIC 3095', previousQuotes: 1 },
            { id: 14, name: 'Nathan Nguyen', email: 'nathan.n@email.com', phone: '0413 555 555', address: '14 Nicholson St, Fitzroy VIC 3065', previousQuotes: 4 },
            { id: 15, name: "Olivia O'Connor", email: 'olivia.o@email.com', phone: '0413 666 666', address: '15 Ormond Rd, Elwood VIC 3184', previousQuotes: 0 },
            { id: 16, name: 'Patrick Patel', email: 'patrick.p@email.com', phone: '0413 777 777', address: '16 Park St, South Melbourne VIC 3205', previousQuotes: 5 },
            { id: 17, name: 'Quinn Roberts', email: 'quinn.r@email.com', phone: '0413 888 888', address: '17 Queen St, Melbourne VIC 3000', previousQuotes: 2 },
            { id: 18, name: 'Rachel Robinson', email: 'rachel.r@email.com', phone: '0413 999 999', address: '18 Royal Pde, Parkville VIC 3052', previousQuotes: 3 },
            { id: 19, name: 'Samuel Smith', email: 'sam.smith@email.com', phone: '0414 111 111', address: '19 Smith St, Collingwood VIC 3066', previousQuotes: 8 },
            { id: 20, name: 'Taylor Thompson', email: 'taylor.t@email.com', phone: '0414 222 222', address: '20 Toorak Rd, South Yarra VIC 3141', previousQuotes: 1 },
            { id: 21, name: 'Uma Patel', email: 'uma.patel@email.com', phone: '0414 333 333', address: '21 Union St, Windsor VIC 3181', previousQuotes: 0 },
            { id: 22, name: 'Victor Vasquez', email: 'victor.v@email.com', phone: '0414 444 444', address: '22 Victoria St, Richmond VIC 3121', previousQuotes: 4 },
            { id: 23, name: 'Wendy White', email: 'wendy.w@email.com', phone: '0414 555 555', address: '23 Wellington St, St Kilda VIC 3182', previousQuotes: 2 },
            { id: 26, name: 'Zachary Zhang', email: 'zach.zhang@email.com', phone: '0414 888 888', address: '26 Zoe St, Brunswick VIC 3056', previousQuotes: 3 }
        ];

        // ============================================================================
        // LEARNING SERVICES DATA (Solution 1: Search Learning Services Instead of Pricebook)
        // ============================================================================
        const learningServices = [
            {
                id: 'ls_001',
                name: 'AP Calculus AB',
                type: 'Class',
                description: 'Advanced Placement Calculus course covering limits, derivatives, and integrals',
                price: 75,
                pricingType: 'per_hour',
                unit: 'hour',
                schedule: {
                    days: ['Monday', 'Wednesday', 'Friday'],
                    time: '15:00 - 16:30',
                    duration: 90
                },
                staff: [
                    { name: 'John Smith', role: 'Senior Tutor' }
                ],
                maxCapacity: 20,
                currentEnrollment: 17,
                availableSlots: 3,
                avgEnrollment: 85,
                sessionsCount: 45,
                status: 'active'
            },
            {
                id: 'ls_002',
                name: 'SAT Math Prep Group',
                type: 'Group',
                description: 'Small group SAT Math preparation with focus on problem-solving strategies',
                price: 50,
                pricingType: 'per_hour',
                unit: 'hour',
                schedule: {
                    days: ['Tuesday', 'Thursday'],
                    time: '17:00 - 18:30',
                    duration: 90
                },
                staff: [
                    { name: 'Emily Davis', role: 'Math Specialist' }
                ],
                maxCapacity: 6,
                currentEnrollment: 4,
                availableSlots: 2,
                avgEnrollment: 72,
                sessionsCount: 24,
                status: 'active'
            },
            {
                id: 'ls_003',
                name: 'Private Math Tutoring',
                type: 'One-to-One',
                description: 'Personalized one-on-one math tutoring tailored to student needs',
                price: 75,
                pricingType: 'per_hour',
                unit: 'hour',
                schedule: {
                    days: ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'],
                    time: '14:00 - 15:00',
                    duration: 60
                },
                staff: [
                    { name: 'John Smith', role: 'Senior Tutor' }
                ],
                maxCapacity: 1,
                currentEnrollment: 1,
                availableSlots: 0,
                avgEnrollment: 100,
                sessionsCount: 120,
                status: 'active'
            },
            {
                id: 'ls_004',
                name: 'Chemistry 101',
                type: 'Class',
                description: 'Introduction to Chemistry for high school students',
                price: 60,
                pricingType: 'per_hour',
                unit: 'hour',
                schedule: {
                    days: ['Monday', 'Wednesday'],
                    time: '10:00 - 11:30',
                    duration: 90
                },
                staff: [
                    { name: 'Michael Chen', role: 'Science Teacher' }
                ],
                maxCapacity: 15,
                currentEnrollment: 14,
                availableSlots: 1,
                avgEnrollment: 90,
                sessionsCount: 32,
                status: 'active'
            },
            {
                id: 'ls_005',
                name: 'Essay Writing Workshop',
                type: 'Group',
                description: 'Collaborative workshop for improving essay writing skills',
                price: 45,
                pricingType: 'per_hour',
                unit: 'hour',
                schedule: {
                    days: ['Saturday'],
                    time: '10:00 - 12:00',
                    duration: 120
                },
                staff: [
                    { name: 'Sarah Wilson', role: 'English Tutor' }
                ],
                maxCapacity: 8,
                currentEnrollment: 5,
                availableSlots: 3,
                avgEnrollment: 65,
                sessionsCount: 12,
                status: 'active'
            },
            {
                id: 'ls_006',
                name: 'ACT Prep - Private',
                type: 'One-to-One',
                description: 'Intensive one-on-one ACT preparation with focus on weak areas',
                price: 65,
                pricingType: 'per_hour',
                unit: 'hour',
                schedule: {
                    days: ['Tuesday', 'Thursday', 'Saturday'],
                    time: '16:00 - 17:30',
                    duration: 90
                },
                staff: [
                    { name: 'David Brown', role: 'Test Prep Coach' }
                ],
                maxCapacity: 1,
                currentEnrollment: 1,
                availableSlots: 0,
                avgEnrollment: 100,
                sessionsCount: 48,
                status: 'active'
            },
            {
                id: 'ls_007',
                name: 'Spanish for Beginners',
                type: 'Class',
                description: 'Introductory Spanish language course for beginners',
                price: 55,
                pricingType: 'per_hour',
                unit: 'hour',
                schedule: {
                    days: ['Tuesday', 'Thursday'],
                    time: '14:00 - 15:30',
                    duration: 90
                },
                staff: [
                    { name: 'Maria Rodriguez', role: 'Language Teacher' }
                ],
                maxCapacity: 12,
                currentEnrollment: 10,
                availableSlots: 2,
                avgEnrollment: 83,
                sessionsCount: 36,
                status: 'active'
            },
            {
                id: 'ls_008',
                name: 'Physics Tutoring - Group',
                type: 'Group',
                description: 'Small group physics tutoring for high school students',
                price: 48,
                pricingType: 'per_hour',
                unit: 'hour',
                schedule: {
                    days: ['Wednesday', 'Friday'],
                    time: '16:00 - 17:30',
                    duration: 90
                },
                staff: [
                    { name: 'Dr. James Wilson', role: 'Physics Specialist' }
                ],
                maxCapacity: 5,
                currentEnrollment: 5,
                availableSlots: 0,
                avgEnrollment: 100,
                sessionsCount: 28,
                status: 'active'
            },
            {
                id: 'ls_009',
                name: 'Reading Comprehension - One-on-One',
                type: 'One-to-One',
                description: 'Personalized reading comprehension and literacy support',
                price: 70,
                pricingType: 'per_hour',
                unit: 'hour',
                schedule: {
                    days: ['Monday', 'Wednesday', 'Friday'],
                    time: '13:00 - 14:00',
                    duration: 60
                },
                staff: [
                    { name: 'Lisa Anderson', role: 'Reading Specialist' }
                ],
                maxCapacity: 1,
                currentEnrollment: 0,
                availableSlots: 1,
                avgEnrollment: 75,
                sessionsCount: 60,
                status: 'active'
            },
            {
                id: 'ls_010',
                name: 'AP Biology',
                type: 'Class',
                description: 'Advanced Placement Biology course with lab components',
                price: 80,
                pricingType: 'per_hour',
                unit: 'hour',
                schedule: {
                    days: ['Monday', 'Wednesday', 'Friday'],
                    time: '09:00 - 10:30',
                    duration: 90
                },
                staff: [
                    { name: 'Dr. Sarah Chen', role: 'Biology Teacher' }
                ],
                maxCapacity: 18,
                currentEnrollment: 16,
                availableSlots: 2,
                avgEnrollment: 89,
                sessionsCount: 50,
                status: 'active'
            },
            {
                id: 'ls_011',
                name: 'Music Theory Basics',
                type: 'Group',
                description: 'Introduction to music theory and notation',
                price: 42,
                pricingType: 'per_hour',
                unit: 'hour',
                schedule: {
                    days: ['Saturday'],
                    time: '14:00 - 16:00',
                    duration: 120
                },
                staff: [
                    { name: 'Robert Martinez', role: 'Music Instructor' }
                ],
                maxCapacity: 10,
                currentEnrollment: 7,
                availableSlots: 3,
                avgEnrollment: 70,
                sessionsCount: 16,
                status: 'active'
            },
            {
                id: 'ls_012',
                name: 'College Essay Coaching',
                type: 'One-to-One',
                description: 'One-on-one coaching for college application essays',
                price: 85,
                pricingType: 'per_hour',
                unit: 'hour',
                schedule: {
                    days: ['Tuesday', 'Thursday', 'Saturday'],
                    time: '15:00 - 16:00',
                    duration: 60
                },
                staff: [
                    { name: 'Jennifer Lee', role: 'College Counselor' }
                ],
                maxCapacity: 1,
                currentEnrollment: 1,
                availableSlots: 0,
                avgEnrollment: 95,
                sessionsCount: 40,
                status: 'active'
            }
        ];

        // Use Learning Services instead of pricebook items for this experimental version
        const tutoringServices = learningServices;

        // ============================================================================
        // LEARNING SERVICE AUTOCOMPLETE CUSTOMIZATION
        // ============================================================================
        // Override the default autocomplete to show Learning Service details
        document.addEventListener('DOMContentLoaded', function () {
            const searchInput = document.getElementById('catalogSearchInput');
            const autocompleteDiv = document.getElementById('catalogAutocomplete');

            if (searchInput && autocompleteDiv) {
                searchInput.addEventListener('input', function (e) {
                    const query = e.target.value.toLowerCase().trim();

                    if (query.length < 2) {
                        autocompleteDiv.classList.add('hidden');
                        return;
                    }

                    // Filter Learning Services
                    const matches = learningServices.filter(service =>
                        service.name.toLowerCase().includes(query) ||
                        service.description.toLowerCase().includes(query) ||
                        service.type.toLowerCase().includes(query)
                    ).slice(0, 5); // Limit to 5 results

                    if (matches.length === 0) {
                        autocompleteDiv.classList.add('hidden');
                        return;
                    }

                    // Render Learning Service results with schedule, staff, and enrollment
                    autocompleteDiv.innerHTML = matches.map(service => {
                        const daysText = service.schedule.days.join(', ');
                        const staffText = service.staff.map(s => s.name).join(', ');
                        const enrollmentColor = service.availableSlots > 0 ? 'text-green-600' : 'text-red-600';
                        const typeColor = service.type === 'Class' ? 'bg-purple-100 text-purple-700' :
                            service.type === 'Group' ? 'bg-amber-100 text-amber-700' :
                                'bg-cyan-100 text-cyan-700';

                        return `
                            <div class="p-3 hover:bg-gray-50 cursor-pointer border-b border-gray-100 last:border-b-0"
                                 onclick="selectLearningService('${service.id}')">
                                <div class="flex items-start justify-between gap-3">
                                    <div class="flex-1 min-w-0">
                                        <div class="flex items-center gap-2 mb-1">
                                            <span class="px-2 py-0.5 text-xs font-medium rounded-full ${typeColor}">
                                                ${service.type}
                                            </span>
                                            <h4 class="font-semibold text-gray-900 text-sm truncate">${service.name}</h4>
                                        </div>
                                        <p class="text-xs text-gray-600 mb-2 line-clamp-1">${service.description}</p>
                                        
                                        <div class="grid grid-cols-2 gap-2 text-xs">
                                            <div class="flex items-center gap-1 text-gray-600">
                                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                                </svg>
                                                <span class="truncate">${daysText}</span>
                                            </div>
                                            <div class="flex items-center gap-1 text-gray-600">
                                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                                </svg>
                                                <span class="truncate">${staffText}</span>
                                            </div>
                                            <div class="flex items-center gap-1 text-gray-600">
                                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                                </svg>
                                                <span>${service.schedule.time}</span>
                                            </div>
                                            <div class="flex items-center gap-1 ${enrollmentColor} font-medium">
                                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                                                </svg>
                                                <span>${service.availableSlots} slots available</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="text-right flex-shrink-0">
                                        <div class="text-lg font-bold text-gray-900">$${service.price}</div>
                                        <div class="text-xs text-gray-500">per ${service.unit}</div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');

                    autocompleteDiv.classList.remove('hidden');
                });

                // Close autocomplete when clicking outside
                document.addEventListener('click', function (e) {
                    if (!searchInput.contains(e.target) && !autocompleteDiv.contains(e.target)) {
                        autocompleteDiv.classList.add('hidden');
                    }
                });
            }
        });

        // Function to select a Learning Service from autocomplete
        function selectLearningService(serviceId) {
            const service = learningServices.find(s => s.id === serviceId);
            if (!service) return;

            // Clear search
            const searchInput = document.getElementById('catalogSearchInput');
            const autocompleteDiv = document.getElementById('catalogAutocomplete');
            if (searchInput) searchInput.value = '';
            if (autocompleteDiv) autocompleteDiv.classList.add('hidden');

            // Add to quote items (reuse existing addItemToQuote logic if it exists)
            // For now, show an alert
            alert(`Selected Learning Service:\n\n${service.name}\nType: ${service.type}\nSchedule: ${service.schedule.days.join(', ')} ${service.schedule.time}\nStaff: ${service.staff.map(s => s.name).join(', ')}\nPrice: $${service.price}/${service.unit}\nAvailable Slots: ${service.availableSlots}`);
        }

        // ============================================================================
        // STATUS MANAGEMENT FUNCTIONS
        // ============================================================================

        // Check if quote is expired
        function isQuoteExpired() {
            if (!existingQuote.validUntil) return false;
            const validUntil = new Date(existingQuote.validUntil);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            validUntil.setHours(0, 0, 0, 0);
            return validUntil < today;
        }

        // Get current effective status (auto-detect expired)
        function getCurrentStatus() {
            if (existingQuote.status !== 'expired' && isQuoteExpired()) {
                // Auto-detect expired status and sync
                existingQuote.status = 'expired';
                state.quoteStatus = 'expired';
                return 'expired';
            }
            // Always return from existingQuote as source of truth
            return existingQuote.status;
        }

        // Get icon SVG for action
        function getActionIcon(iconName) {
            const icons = {
                save: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path>',
                send: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>',
                download: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5.586a1 1 0 0 1 .707.293l5.414 5.414a1 1 0 0 1 .293.707V19a2 2 0 0 1-2 2z"></path>',
                trash: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0 1 16.138 21H7.862a2 2 0 0 1-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 0 0-1-1h-4a1 1 0 0 0-1 1v3M4 7h16"></path>',
                check: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>',
                x: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>',
                invoice: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5.586a1 1 0 0 1 .707.293l5.414 5.414a1 1 0 0 1 .293.707V19a2 2 0 0 1-2 2z"></path>',
                copy: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v2m-6 12h8a2 2 0 0 0 2-2v-8a2 2 0 0 0-2-2h-8a2 2 0 0 0-2 2v8a2 2 0 0 0 2 2z"></path>',
                archive: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"></path>',
                refresh: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 0 0 4.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 0 1-15.357-2m15.357 2H15"></path>',
                plus: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>'
            };
            return icons[iconName] || icons.save;
        }

        // Get button color classes
        function getButtonColor(color, isPrimary) {
            const colors = {
                gray: isPrimary ? 'bg-gray-600 text-white hover:bg-gray-700' : 'border border-gray-300 text-gray-700 hover:bg-gray-50',
                blue: 'bg-blue-600 text-white hover:bg-blue-700',
                green: 'bg-green-600 text-white hover:bg-green-700',
                red: 'bg-red-600 text-white hover:bg-red-700',
                purple: 'bg-purple-600 text-white hover:bg-purple-700'
            };
            return colors[color] || colors.gray;
        }

        // Render action buttons based on current status
        function renderStatusActions() {
            const currentStatus = getCurrentStatus();
            const config = statusConfig[currentStatus];

            if (!config) {
                console.error('Invalid status:', currentStatus);
                return;
            }

            // Update status badge
            const statusBadge = document.getElementById('quoteStatusBadge');
            statusBadge.textContent = config.label;
            statusBadge.className = `px-2 py-1 text-xs rounded ${config.color}`;

            // Get the header actions container
            const headerActions = document.getElementById('headerActions');

            // Remove only the dynamic action buttons (not the back button)
            const dynamicButtons = headerActions.querySelectorAll('button:not(:first-child)');
            dynamicButtons.forEach(btn => btn.remove());

            // Header action buttons removed - only keeping "Back to Quotes"

            // Also render action buttons in sidebar
            const sidebarActions = document.getElementById('sidebarActions');
            if (sidebarActions) {
                sidebarActions.innerHTML = '';

                config.actions.forEach(action => {
                    const button = document.createElement('button');
                    button.className = `w-full py-2.5 rounded-lg text-sm font-medium flex items-center justify-center gap-2 ${getButtonColor(action.color, action.primary)}`;
                    button.onclick = () => handleStatusAction(action.id);

                    button.innerHTML = `
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            ${getActionIcon(action.icon)}
                        </svg>
                        ${action.label}
                    `;

                    sidebarActions.appendChild(button);
                });
            }

            // Show status info banner and enable/disable editing based on status
            const banner = document.getElementById('statusInfoBanner');

            if (config.canEdit) {
                enableEditing();
                if (banner) banner.classList.add('hidden');
            } else {
                disableEditing();

                // Define informational banner messages
                const bannerMessages = {
                    approved: {
                        color: 'bg-green-50 border-green-500',
                        icon: 'âœ…',
                        title: 'Quote Approved',
                        message: 'This quote has been approved by the customer. You can create invoices but cannot modify the quote details.'
                    },
                    rejected: {
                        color: 'bg-red-50 border-red-500',
                        icon: 'âŒ',
                        title: 'Quote Rejected',
                        message: 'This quote was rejected by the customer. You can clone it to create a new quote with modifications.'
                    },
                    expired: {
                        color: 'bg-orange-50 border-orange-500',
                        icon: 'â°',
                        title: 'Quote Expired',
                        message: 'This quote has passed its validity date. You can renew it to extend the validity period or clone it to create a new quote.'
                    },
                    invoiced: {
                        color: 'bg-purple-50 border-purple-500',
                        icon: 'ðŸ’°',
                        title: 'Quote Invoiced',
                        message: 'Invoices have been created for this quote. Quote details are now locked.'
                    }
                };

                const bannerInfo = bannerMessages[currentStatus];
                if (bannerInfo && banner) {
                    banner.className = `p-4 border-l-4 rounded-lg ${bannerInfo.color}`;
                    banner.innerHTML = `
                        <div class="flex items-start gap-3">
                            <span class="text-2xl">${bannerInfo.icon}</span>
                            <div class="flex-1">
                                <h3 class="font-semibold text-gray-900 mb-1">${bannerInfo.title}</h3>
                                <p class="text-sm text-gray-700">${bannerInfo.message}</p>
                            </div>
                        </div>
                    `;
                    banner.classList.remove('hidden');
                } else {
                    if (banner) banner.classList.add('hidden');
                }
            }

            // Update tab visibility based on status
            updateTabsVisibility();
        }

        // Enable editing for editable statuses
        function enableEditing() {
            // Enable Quote Details tab inputs
            const quoteInputs = document.querySelectorAll('#quoteDetailsContent input, #quoteDetailsContent textarea, #quoteDetailsContent select');
            quoteInputs.forEach(input => {
                input.disabled = false;
                input.classList.remove('bg-gray-100', 'cursor-not-allowed');
            });

            // Enable add/remove item buttons
            const catalogSearch = document.getElementById('catalogSearchInput');
            if (catalogSearch) {
                catalogSearch.disabled = false;
                catalogSearch.placeholder = 'Type to search and add services or products...';
            }

            // Show remove item buttons
            const removeButtons = document.querySelectorAll('[onclick^="removeQuoteItem"]');
            removeButtons.forEach(btn => btn.style.display = '');

            // Enable Payment Configuration tab inputs
            const paymentInputs = document.querySelectorAll('#paymentConfigContent input, #paymentConfigContent textarea, #paymentConfigContent select');
            paymentInputs.forEach(input => {
                input.disabled = false;
                input.classList.remove('bg-gray-100', 'cursor-not-allowed');
            });

            // Hide payment configuration banner when editing is enabled
            const configBanner = document.getElementById('paymentConfigBanner');
            if (configBanner) {
                configBanner.classList.add('hidden');
            }
        }

        // Disable editing for read-only statuses
        function disableEditing() {
            // Disable Quote Details tab inputs
            const quoteInputs = document.querySelectorAll('#quoteDetailsContent input, #quoteDetailsContent textarea, #quoteDetailsContent select');
            quoteInputs.forEach(input => {
                input.disabled = true;
                input.classList.add('bg-gray-100', 'cursor-not-allowed');
            });

            // Disable add/remove item buttons
            const catalogSearch = document.getElementById('catalogSearchInput');
            if (catalogSearch) {
                catalogSearch.disabled = true;
                catalogSearch.placeholder = 'Editing disabled for this status';
            }

            // Hide remove item buttons
            const removeButtons = document.querySelectorAll('[onclick^="removeQuoteItem"]');
            removeButtons.forEach(btn => btn.style.display = 'none');

            // Only disable Payment Configuration tab inputs if invoices have been generated
            // For approved quotes without invoices, payment configuration should remain editable
            if (hasGeneratedInvoices()) {
                const paymentInputs = document.querySelectorAll('#paymentConfigContent input, #paymentConfigContent textarea, #paymentConfigContent select');
                paymentInputs.forEach(input => {
                    input.disabled = true;
                    input.classList.add('bg-gray-100', 'cursor-not-allowed');
                });

                // Add locking banner when invoices exist
                const configBanner = document.getElementById('paymentConfigBanner');
                if (configBanner) {
                    configBanner.classList.remove('hidden');
                    configBanner.innerHTML = `
                        <div class="flex items-start gap-3">
                            <span class="text-xl">ðŸ”’</span>
                            <div>
                                <h3 class="font-semibold text-gray-900">Payment Configuration Locked</h3>
                                <p class="text-sm text-gray-700">Invoices have already been generated for this quote. Payment settings cannot be modified to prevent inconsistencies.</p>
                            </div>
                        </div>
                     `;
                }
            } else {
                // Ensure payment configuration is enabled if no invoices exist
                const paymentInputs = document.querySelectorAll('#paymentConfigContent input, #paymentConfigContent textarea, #paymentConfigContent select');
                paymentInputs.forEach(input => {
                    input.disabled = false;
                    input.classList.remove('bg-gray-100', 'cursor-not-allowed');
                });

                // Hide banner if no invoices exist
                const configBanner = document.getElementById('paymentConfigBanner');
                if (configBanner) {
                    configBanner.classList.add('hidden');
                }
            }
        }

        // Handle status action clicks
        function handleStatusAction(actionId) {
            switch (actionId) {
                case 'save':
                    saveQuoteChanges();
                    break;
                case 'send':
                    sendQuote();
                    break;
                case 'resend':
                    resendQuote();
                    break;
                case 'approve':
                    approveQuote();
                    break;
                case 'reject':
                    rejectQuote();
                    break;
                case 'createInvoice':
                    createInvoiceFromQuote();
                    break;
                case 'download':
                    previewQuotePDF();
                    break;
                case 'delete':
                    deleteQuote();
                    break;
                case 'clone':
                    cloneQuote();
                    break;
                case 'archive':
                    archiveQuote();
                    break;
                case 'renew':
                    renewQuote();
                    break;
                case 'extend':
                    extendValidity();
                    break;
                case 'viewInvoices':
                    switchTab('invoices');
                    break;
                default:
                    console.log('Action not implemented:', actionId);
            }
        }

        // Action implementations
        function saveQuoteChanges() {
            console.log('Saving quote changes...', existingQuote.id);

            // Update quote data with current form values
            existingQuote.validUntil = document.getElementById('validUntilDate').value;
            existingQuote.customerNotes = document.getElementById('customerNotes').value;
            existingQuote.internalNotes = document.getElementById('internalNotes').value;

            alert('Quote changes saved successfully!');
            // In real implementation: save to server via API
        }

        function sendQuote() {
            const email = state.selectedCustomer ? state.selectedCustomer.email : 'customer';
            existingQuote.status = 'sent';
            state.quoteStatus = 'sent'; // Update state to sync with existingQuote
            console.log('Quote sent:', existingQuote.id);
            showToast('Quote sent successfully!', 'success');
            renderStatusActions();
            // In real implementation: send email and update server
        }

        function resendQuote() {
            const email = state.selectedCustomer ? state.selectedCustomer.email : 'customer';
            console.log('Quote resent:', existingQuote.id);
            showToast('Quote resent successfully!', 'success');
            // In real implementation: resend email
        }

        function approveQuote() {
            if (confirm('Mark this quote as Approved? This will allow invoice creation.')) {
                existingQuote.status = 'approved';
                state.quoteStatus = 'approved'; // Update state to sync with existingQuote
                console.log('Quote approved:', existingQuote.id);
                alert('Quote marked as Approved! You can now create invoices.');
                renderStatusActions();
                // In real implementation: update server
            }
        }

        function rejectQuote() {
            if (confirm('Mark this quote as Rejected?')) {
                existingQuote.status = 'rejected';
                state.quoteStatus = 'rejected'; // Update state to sync with existingQuote
                console.log('Quote rejected:', existingQuote.id);
                alert('Quote marked as Rejected.');
                renderStatusActions();
                // In real implementation: update server
            }
        }

        // Helper to check if invoices exist (for locking Payment Config)
        function hasGeneratedInvoices() {
            return quoteInvoices && quoteInvoices.filter(inv => inv.status !== 'cancelled').length > 0;
        }

        function extendValidity() {
            if (confirm('Extend quote validity by 30 days?')) {
                const today = new Date();
                const newDate = new Date(today.setDate(today.getDate() + 30));
                existingQuote.validUntil = newDate.toISOString().split('T')[0];

                // If status was expired, reset to approved to unlock tabs
                if (existingQuote.status === 'expired') {
                    existingQuote.status = 'approved';
                    state.quoteStatus = 'approved';
                }

                // Update UI input
                const dateInput = document.getElementById('validUntilDate');
                if (dateInput) dateInput.value = existingQuote.validUntil;

                console.log('Quote validity extended:', existingQuote.id);
                showToast('Quote validity extended by 30 days!', 'success');
                renderStatusActions();
            }
        }

        // Store the generated PDF globally for download
        let generatedPdfBlob = null;

        function generateQuotePDF() {
            console.log('Generating PDF for quote:', existingQuote.id);

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Page settings
            const pageWidth = doc.internal.pageSize.width;
            const pageHeight = doc.internal.pageSize.height;
            const margin = 20;
            const contentWidth = pageWidth - (margin * 2);
            let yPos = margin;

            // Colors
            const primaryColor = [59, 130, 246]; // Blue
            const darkColor = [31, 41, 55]; // Gray-800
            const lightColor = [107, 114, 128]; // Gray-500

            // Helper function to add text with word wrap
            const addWrappedText = (text, x, y, maxWidth, fontSize = 10) => {
                doc.setFontSize(fontSize);
                const lines = doc.splitTextToSize(text, maxWidth);
                doc.text(lines, x, y);
                return y + (lines.length * fontSize * 0.4);
            };

            // Header - Company Name
            doc.setFillColor(primaryColor[0], primaryColor[1], primaryColor[2]);
            doc.rect(0, 0, pageWidth, 40, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(24);
            doc.setFont(undefined, 'bold');
            doc.text('SUNSHINE TUTORING', margin, 20);
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text('Melbourne East Branch', margin, 28);

            // Quote Title and Status
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            const statusText = getCurrentStatus().toUpperCase();
            const statusLabel = statusConfig[getCurrentStatus()]?.label || statusText;
            doc.text('QUOTE', pageWidth - margin - 30, 20, { align: 'right' });
            doc.setFontSize(9);
            doc.setFont(undefined, 'normal');
            doc.text(statusLabel, pageWidth - margin - 30, 28, { align: 'right' });

            yPos = 50;

            // Quote ID and Date
            doc.setTextColor(darkColor[0], darkColor[1], darkColor[2]);
            doc.setFontSize(10);
            doc.setFont(undefined, 'bold');
            doc.text(`Quote #: ${existingQuote.id}`, margin, yPos);
            doc.setFont(undefined, 'normal');
            doc.text(`Date: ${new Date(existingQuote.createdDate).toLocaleDateString('en-AU')}`, pageWidth - margin, yPos, { align: 'right' });

            yPos += 8;
            doc.text(`Valid Until: ${new Date(existingQuote.validUntil).toLocaleDateString('en-AU')}`, pageWidth - margin, yPos, { align: 'right' });

            yPos += 15;

            // Customer Information Box
            doc.setDrawColor(220, 220, 220);
            doc.setFillColor(249, 250, 251);
            doc.roundedRect(margin, yPos, contentWidth / 2 - 5, 35, 2, 2, 'FD');

            doc.setFontSize(9);
            doc.setFont(undefined, 'bold');
            doc.setTextColor(lightColor[0], lightColor[1], lightColor[2]);
            doc.text('BILL TO:', margin + 5, yPos + 7);

            doc.setTextColor(darkColor[0], darkColor[1], darkColor[2]);
            doc.setFont(undefined, 'bold');
            doc.setFontSize(10);
            doc.text(state.selectedCustomer.name, margin + 5, yPos + 14);

            doc.setFont(undefined, 'normal');
            doc.setFontSize(9);
            doc.text(state.selectedCustomer.email, margin + 5, yPos + 20);
            doc.text(state.selectedCustomer.phone, margin + 5, yPos + 26);
            if (state.selectedCustomer.address) {
                doc.setFontSize(8);
                const addressLines = doc.splitTextToSize(state.selectedCustomer.address, contentWidth / 2 - 15);
                doc.text(addressLines, margin + 5, yPos + 31);
            }

            yPos += 45;

            // Line Items Table Header
            doc.setFillColor(primaryColor[0], primaryColor[1], primaryColor[2]);
            doc.rect(margin, yPos, contentWidth, 10, 'F');

            doc.setTextColor(255, 255, 255);
            doc.setFontSize(9);
            doc.setFont(undefined, 'bold');
            doc.text('Description', margin + 3, yPos + 7);
            doc.text('Qty', margin + contentWidth * 0.60, yPos + 7);
            doc.text('Unit Price', margin + contentWidth * 0.70, yPos + 7);
            doc.text('Total', margin + contentWidth * 0.85, yPos + 7);

            yPos += 12;

            // Line Items
            doc.setTextColor(darkColor[0], darkColor[1], darkColor[2]);
            doc.setFont(undefined, 'normal');
            doc.setFontSize(9);

            state.quoteItems.forEach((item, index) => {
                // Check if we need a new page
                if (yPos > pageHeight - 60) {
                    doc.addPage();
                    yPos = margin;
                }

                // Item name
                const nameLines = doc.splitTextToSize(item.name, contentWidth * 0.55);
                doc.text(nameLines, margin + 3, yPos);

                // Quantity
                doc.text(`${item.quantity} ${item.unit}`, margin + contentWidth * 0.60, yPos);

                // Unit Price
                doc.text(`$${item.customPrice.toFixed(2)}`, margin + contentWidth * 0.70, yPos);

                // Line Total
                const lineTotal = item.customPrice * item.quantity;
                const discountAmount = item.discountType === 'percentage'
                    ? lineTotal * (item.discount / 100)
                    : item.discount;
                const finalTotal = lineTotal - discountAmount;
                doc.text(`$${finalTotal.toFixed(2)}`, margin + contentWidth * 0.85, yPos);

                yPos += (nameLines.length * 4) + 2;

                // Item notes if any
                if (item.notes) {
                    doc.setFontSize(8);
                    doc.setTextColor(lightColor[0], lightColor[1], lightColor[2]);
                    const notesLines = doc.splitTextToSize(item.notes, contentWidth * 0.55);
                    doc.text(notesLines, margin + 5, yPos);
                    yPos += (notesLines.length * 3.5) + 1;
                    doc.setFontSize(9);
                    doc.setTextColor(darkColor[0], darkColor[1], darkColor[2]);
                }

                // Discount if any
                if (item.discount > 0) {
                    doc.setFontSize(8);
                    doc.setTextColor(34, 197, 94); // Green
                    doc.text(`Discount: -$${discountAmount.toFixed(2)}`, margin + contentWidth * 0.85, yPos);
                    yPos += 4;
                    doc.setFontSize(9);
                    doc.setTextColor(darkColor[0], darkColor[1], darkColor[2]);
                }

                // Separator line
                if (index < state.quoteItems.length - 1) {
                    doc.setDrawColor(230, 230, 230);
                    doc.line(margin, yPos, pageWidth - margin, yPos);
                    yPos += 5;
                }
            });

            yPos += 8;

            // Summary Box
            const summaryX = pageWidth - margin - 60;
            const summaryWidth = 60;

            // Subtotal
            doc.setFont(undefined, 'normal');
            doc.text('Subtotal:', summaryX, yPos);
            doc.text(`$${calculateSubtotal().toFixed(2)}`, summaryX + summaryWidth, yPos, { align: 'right' });
            yPos += 6;

            // Line item discounts if any
            const lineItemDiscounts = calculateLineItemDiscounts();
            if (lineItemDiscounts > 0) {
                doc.setTextColor(34, 197, 94); // Green
                doc.text('Discounts:', summaryX, yPos);
                doc.text(`-$${lineItemDiscounts.toFixed(2)}`, summaryX + summaryWidth, yPos, { align: 'right' });
                doc.setTextColor(darkColor[0], darkColor[1], darkColor[2]);
                yPos += 6;
            }

            // Tax Breakdown
            const taxBreakdown = getTaxBreakdown();
            if (taxBreakdown.taxable_gst > 0) {
                doc.text('GST (10%):', summaryX, yPos);
                doc.text(`$${taxBreakdown.taxable_gst.toFixed(2)}`, summaryX + summaryWidth, yPos, { align: 'right' });
                yPos += 6;
            }

            // Total Tax
            doc.text('Total Tax:', summaryX, yPos);
            doc.text(`$${calculateTax().toFixed(2)}`, summaryX + summaryWidth, yPos, { align: 'right' });
            yPos += 8;

            // Total line
            doc.setDrawColor(darkColor[0], darkColor[1], darkColor[2]);
            doc.setLineWidth(0.5);
            doc.line(summaryX, yPos - 2, summaryX + summaryWidth, yPos - 2);

            doc.setFont(undefined, 'bold');
            doc.setFontSize(12);
            doc.text('TOTAL:', summaryX, yPos);
            doc.text(`$${calculateTotal().toFixed(2)}`, summaryX + summaryWidth, yPos, { align: 'right' });

            yPos += 15;

            // Customer Notes
            if (existingQuote.customerNotes) {
                doc.setFontSize(9);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(lightColor[0], lightColor[1], lightColor[2]);
                doc.text('NOTES:', margin, yPos);
                yPos += 5;

                doc.setFont(undefined, 'normal');
                doc.setTextColor(darkColor[0], darkColor[1], darkColor[2]);
                doc.setFontSize(9);
                const notesLines = doc.splitTextToSize(existingQuote.customerNotes, contentWidth);
                doc.text(notesLines, margin, yPos);
                yPos += (notesLines.length * 4);
            }

            // Footer
            yPos = pageHeight - 30;
            doc.setDrawColor(primaryColor[0], primaryColor[1], primaryColor[2]);
            doc.setLineWidth(1);
            doc.line(margin, yPos, pageWidth - margin, yPos);

            yPos += 5;
            doc.setFontSize(8);
            doc.setTextColor(lightColor[0], lightColor[1], lightColor[2]);
            doc.setFont(undefined, 'normal');

            // Left footer
            doc.text('Sunshine Tutoring - Melbourne East', margin, yPos);
            doc.text('123 Education Street, Melbourne VIC 3000', margin, yPos + 4);
            doc.text('Phone: (03) 1234 5678 | Email: melbourne@sunshinetutoring.com.au', margin, yPos + 8);

            // Right footer
            doc.text('ABN: 12 345 678 901', pageWidth - margin, yPos, { align: 'right' });
            doc.text('www.sunshinetutoring.com.au', pageWidth - margin, yPos + 4, { align: 'right' });

            // Return the PDF document
            return doc;
        }

        function previewQuotePDF() {
            try {
                // Generate the PDF
                const doc = generateQuotePDF();

                // Create blob URL
                const pdfBlob = doc.output('blob');
                generatedPdfBlob = pdfBlob;
                const pdfUrl = URL.createObjectURL(pdfBlob);

                // Show in preview modal
                const iframe = document.getElementById('pdfPreviewFrame');
                iframe.src = pdfUrl;

                // Show modal
                document.getElementById('pdfPreviewModal').classList.remove('hidden');

                console.log('PDF preview opened');

            } catch (error) {
                console.error('Error generating PDF preview:', error);
                alert('Error generating PDF preview. Please try again.');
            }
        }

        function downloadQuotePDF() {
            try {
                let doc;

                // If we have a cached blob from preview, use it
                if (generatedPdfBlob) {
                    // Download the cached blob
                    const filename = `Quote_${existingQuote.id}_${state.selectedCustomer.name.replace(/\s+/g, '_')}.pdf`;
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(generatedPdfBlob);
                    link.download = filename;
                    link.click();
                    URL.revokeObjectURL(link.href);
                } else {
                    // Generate new PDF and download
                    doc = generateQuotePDF();
                    const filename = `Quote_${existingQuote.id}_${state.selectedCustomer.name.replace(/\s+/g, '_')}.pdf`;
                    doc.save(filename);
                }

                console.log('PDF downloaded successfully');

            } catch (error) {
                console.error('Error downloading PDF:', error);
                alert('Error downloading PDF. Please try again.');
            }
        }

        function closePdfPreview() {
            const modal = document.getElementById('pdfPreviewModal');
            const iframe = document.getElementById('pdfPreviewFrame');

            // Revoke the blob URL to free memory
            if (iframe.src) {
                URL.revokeObjectURL(iframe.src);
                iframe.src = '';
            }

            modal.classList.add('hidden');

            // Clear cached blob
            generatedPdfBlob = null;
        }

        function deleteQuote() {
            const customerName = state.selectedCustomer ? state.selectedCustomer.name : 'Unknown';
            if (confirm('Delete quote ' + existingQuote.id + ' for ' + customerName + '? This cannot be undone.')) {
                console.log('Quote deleted:', existingQuote.id);
                alert('Quote deleted successfully!');
                setTimeout(() => {
                    window.location.href = 'quote_list_simple.html';
                }, 500);
                // In real implementation: delete from server
            }
        }

        function cloneQuote() {
            window.location.href = `quote_create_simple.html?clone=${existingQuote.id}`;
        }

        function archiveQuote() {
            alert('Quote archived!');
            window.location.href = 'quote_list_simple.html';
            // In real implementation: archive on server
        }

        function renewQuote() {
            existingQuote.status = 'draft';
            state.quoteStatus = 'draft'; // Update state to sync with existingQuote
            // Set new validity date (30 days from now)
            const newDate = new Date();
            newDate.setDate(newDate.getDate() + 30);
            existingQuote.validUntil = newDate.toISOString().split('T')[0];
            document.getElementById('validUntilDate').value = existingQuote.validUntil;
            showToast('Quote renewed! Please update and send to customer.', 'success');
            renderStatusActions();
            // In real implementation: update server
        }

        // Helper functions
        function getServices() {
            return tutoringServices;
        }


        function getPricingIcon(type) {
            const icons = {
                'per_hour': `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`,
                'per_sqm': `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 5a1 1 0 011-1h4a1 1 0 011 1v7a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM14 5a1 1 0 011-1h4a1 1 0 011 1v7a1 1 0 01-1 1h-4a1 1 0 01-1-1V5zM4 16a1 1 0 011-1h4a1 1 0 011 1v3a1 1 0 01-1 1H5a1 1 0 01-1-1v-3zM14 16a1 1 0 011-1h4a1 1 0 011 1v3a1 1 0 01-1 1h-4a1 1 0 01-1-1v-3z"></path></svg>`,
                'per_unit': `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path></svg>`,
                'fixed': `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`
            };
            return icons[type] || icons['fixed'];
        }

        function getTypeIndicator(type) {
            if (type === 'product') {
                return '<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800">ðŸŸ¢ Product</span>';
            }
            return '<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800">ðŸ”µ Service</span>';
        }

        // Tax rate lookup based on tax category
        function getTaxRate(taxCategory) {
            const taxRates = {
                'taxable_gst': 0.10,    // 10% GST
                'gst_free': 0.00,       // 0% GST-free
                'input_taxed': 0.00     // 0% Input-taxed (no GST on output, but special reporting)
            };
            return taxRates[taxCategory] || 0.10; // Default to 10% if category not found
        }

        function getTaxCategoryLabel(taxCategory) {
            const labels = {
                'taxable_gst': 'Taxable (10% GST)',
                'gst_free': 'GST-Free (0%)',
                'input_taxed': 'Input-Taxed (0%)'
            };
            return labels[taxCategory] || 'Standard (10%)';
        }

        // Calculate tax for each line item based on its tax category
        function calculateLineItemTax(item) {
            const taxRate = getTaxRate(item.taxCategory);
            const lineTotal = item.customPrice * item.quantity;
            return lineTotal * taxRate;
        }

        // Calculation functions
        function calculateSubtotal() {
            return state.quoteItems.reduce((sum, item) => {
                const lineTotal = item.customPrice * item.quantity;
                const discountAmount = item.discountType === 'percentage'
                    ? lineTotal * (item.discount / 100)
                    : item.discount;
                return sum + (lineTotal - discountAmount);
            }, 0);
        }

        function calculateTax() {
            // Calculate tax per line item based on their tax categories
            return state.quoteItems.reduce((sum, item) => {
                return sum + calculateLineItemTax(item);
            }, 0);
        }

        function calculateTotal() {
            return calculateSubtotal() + calculateTax();
        }

        // Calculate total line item discounts
        function calculateLineItemDiscounts() {
            return state.quoteItems.reduce((sum, item) => {
                const lineTotal = item.customPrice * item.quantity;
                const discountAmount = item.discountType === 'percentage'
                    ? lineTotal * (item.discount / 100)
                    : item.discount;
                return sum + discountAmount;
            }, 0);
        }

        // Get tax breakdown by category
        function getTaxBreakdown() {
            const breakdown = {
                taxable_gst: 0,
                gst_free: 0,
                input_taxed: 0
            };

            state.quoteItems.forEach(item => {
                const taxAmount = calculateLineItemTax(item);
                if (item.taxCategory && breakdown.hasOwnProperty(item.taxCategory)) {
                    breakdown[item.taxCategory] += taxAmount;
                } else {
                    breakdown.taxable_gst += taxAmount; // Default
                }
            });

            return breakdown;
        }

        function updateSummary() {
            const netSubtotal = calculateSubtotal();
            const lineItemDiscounts = calculateLineItemDiscounts();
            const grossSubtotal = netSubtotal + lineItemDiscounts;
            document.getElementById('subtotalAmount').textContent = `$${grossSubtotal.toFixed(2)}`;

            // Update line item discounts display
            const lineItemDiscountSection = document.getElementById('lineItemDiscountSection');
            if (lineItemDiscounts > 0) {
                lineItemDiscountSection.classList.remove('hidden');
                document.getElementById('lineItemDiscountAmount').textContent = `-$${lineItemDiscounts.toFixed(2)}`;
            } else {
                lineItemDiscountSection.classList.add('hidden');
            }

            document.getElementById('totalAmount').textContent = `$${calculateTotal().toFixed(2)}`;

            // Calculate and display tax breakdown by category
            const taxBreakdown = getTaxBreakdown();
            const taxBreakdownContainer = document.getElementById('taxBreakdown');

            let taxBreakdownHTML = '';
            if (taxBreakdown.taxable_gst > 0) {
                taxBreakdownHTML += `<div class="flex justify-between"><span>GST (10%):</span><span>$${taxBreakdown.taxable_gst.toFixed(2)}</span></div>`;
            }
            if (taxBreakdown.gst_free > 0) {
                taxBreakdownHTML += `<div class="flex justify-between text-gray-500"><span>GST-Free:</span><span>$0.00</span></div>`;
            }
            if (taxBreakdown.input_taxed > 0) {
                taxBreakdownHTML += `<div class="flex justify-between text-gray-500"><span>Input-Taxed:</span><span>$0.00</span></div>`;
            }

            taxBreakdownContainer.innerHTML = taxBreakdownHTML || '<div class="text-gray-400">No taxable items</div>';

            // Total tax
            const totalTax = calculateTax();
            document.getElementById('taxAmount').textContent = `$${totalTax.toFixed(2)}`;

            updateCreateButton();
        }

        function updateCreateButton() {
            const createBtn = document.getElementById('createQuoteBtn');
            if (createBtn) {
                const canCreate = state.quoteItems.length > 0 && state.selectedCustomer !== null;
                createBtn.disabled = !canCreate;
            }
        }

        // Render functions
        function renderCustomerAutocomplete(searchTerm = '') {
            const autocomplete = document.getElementById('customerAutocomplete');
            const clearBtn = document.getElementById('clearSearchBtn');

            if (!searchTerm || searchTerm.length < 2) {
                autocomplete.classList.add('hidden');
                clearBtn.classList.add('hidden');
                return;
            }

            clearBtn.classList.remove('hidden');

            const filtered = customers.filter(c =>
                c.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                c.email.toLowerCase().includes(searchTerm.toLowerCase()) ||
                c.phone.includes(searchTerm)
            );

            if (filtered.length === 0) {
                autocomplete.innerHTML = `
                    <div class="p-3 text-sm text-gray-500 text-center">
                        No customers found.
                    </div>
                `;
                autocomplete.classList.remove('hidden');
                return;
            }

            autocomplete.innerHTML = filtered.map(customer => `
                <div 
                    class="p-3 hover:bg-blue-50 cursor-pointer border-b border-gray-100 last:border-b-0"
                    onclick="selectCustomer(${customer.id})"
                >
                    <div class="flex items-center justify-between">
                        <div class="flex-1">
                            <p class="font-medium text-gray-900 text-sm">${customer.name}</p>
                            <p class="text-xs text-gray-600 mt-0.5">${customer.email}</p>
                            <p class="text-xs text-gray-500">${customer.phone}</p>
                        </div>
                        ${customer.previousQuotes > 0 ? `
                            <span class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded">${customer.previousQuotes} quotes</span>
                        ` : ''}
                    </div>
                </div>
            `).join('');

            autocomplete.classList.remove('hidden');
        }

        function renderCatalogAutocomplete(searchTerm = '') {
            const autocomplete = document.getElementById('catalogAutocomplete');
            const clearBtn = document.getElementById('clearCatalogSearchBtn');

            if (!searchTerm || searchTerm.length < 2) {
                autocomplete.classList.add('hidden');
                clearBtn.classList.add('hidden');
                return;
            }

            clearBtn.classList.remove('hidden');

            const services = getServices().filter(service =>
                service.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                service.id.toLowerCase().includes(searchTerm.toLowerCase()) ||
                service.tag.toLowerCase().includes(searchTerm.toLowerCase())
            );

            if (services.length === 0) {
                autocomplete.innerHTML = `
                    <div class="p-3 text-sm text-gray-500 text-center">
                        No services or products found.
                    </div>
                `;
                autocomplete.classList.remove('hidden');
                return;
            }

            autocomplete.innerHTML = services.map(service => `
                <div 
                    class="p-3 hover:bg-blue-50 cursor-pointer border-b border-gray-100 last:border-b-0"
                    onclick="addQuoteItem('${service.id}')"
                >
                    <div class="flex items-center justify-between">
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-1">
                                ${getTypeIndicator(service.type)}
                                <span class="text-xs bg-gray-100 text-gray-700 px-2 py-0.5 rounded">${service.tag}</span>
                            </div>
                            <p class="font-medium text-gray-900 text-sm">${service.name}</p>
                            <p class="text-xs text-gray-500 mt-0.5">${service.id}</p>
                        </div>
                        <div class="text-right ml-3">
                            <div class="flex items-center gap-1 text-gray-700">
                                <span class="text-sm font-semibold">$${service.price}</span>
                                <span class="text-xs text-gray-500">/ ${service.unit}</span>
                            </div>
                            <div class="text-xs text-gray-500 mt-0.5">${getTaxCategoryLabel(service.taxCategory || 'taxable_gst')}</div>
                        </div>
                    </div>
                </div>
            `).join('');

            autocomplete.classList.remove('hidden');
        }

        function renderQuoteItems() {
            const emptyState = document.getElementById('emptyQuoteState');
            const container = document.getElementById('quoteItemsContainer');

            if (state.quoteItems.length === 0) {
                emptyState.classList.remove('hidden');
                container.classList.add('hidden');
                return;
            }

            emptyState.classList.add('hidden');
            container.classList.remove('hidden');

            container.innerHTML = state.quoteItems.map((item, index) => {
                // Show tax category
                let taxBadge = '';
                if (item.taxCategory) {
                    const taxLabels = {
                        'taxable_gst': '<span class="inline-flex items-center px-1.5 py-0.5 rounded text-xs bg-blue-50 text-blue-700">ðŸ“‹ GST (10%)</span>',
                        'gst_free': '<span class="inline-flex items-center px-1.5 py-0.5 rounded text-xs bg-gray-50 text-gray-600">GST-Free</span>',
                        'input_taxed': '<span class="inline-flex items-center px-1.5 py-0.5 rounded text-xs bg-gray-50 text-gray-600">Input-Taxed</span>'
                    };
                    taxBadge = taxLabels[item.taxCategory] || '';
                }

                const lineTotal = item.quantity * item.customPrice;
                const discountAmount = item.discountType === 'percentage'
                    ? lineTotal * (item.discount / 100)
                    : item.discount;
                const lineTotalAfterDiscount = lineTotal - discountAmount;

                return `
                <div class="bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                    <!-- Header Row -->
                    <div class="flex items-start justify-between mb-3">
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-1">
                                <h3 class="font-semibold text-gray-900">${item.name}</h3>
                            </div>
                            <div class="flex items-center gap-2">
                                ${getTypeIndicator(item.type)}
                                ${taxBadge}
                            </div>
                            ${item.priceModificationComment ? `
                                <div class="mt-2 text-xs text-yellow-700 bg-yellow-50 px-2 py-1 rounded">
                                    ðŸ’¬ ${item.priceModificationComment}
                                </div>
                            ` : ''}
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="text-right space-y-0.5">
                                ${item.discount > 0 ? `
                                    <div class="text-xs text-gray-500">Original: $${lineTotal.toFixed(2)}</div>
                                    <div class="text-xs text-green-600">Discount: -$${discountAmount.toFixed(2)}</div>
                                ` : ''}
                                <div class="text-2xl font-bold text-gray-900">$${lineTotalAfterDiscount.toFixed(2)}</div>
                            </div>
                            <button 
                                onclick="removeQuoteItem(${index})"
                                class="ml-2 p-2 text-red-600 hover:bg-red-50 rounded-lg transition-colors"
                                title="Remove item"
                            >
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0 1 16.138 21H7.862a2 2 0 0 1-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 0 0-1-1h-4a1 1 0 0 0-1 1v3M4 7h16"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Details Grid -->
                    <div class="grid grid-cols-12 gap-3 mb-3 pb-3 border-b border-gray-200">
                        <div class="col-span-3">
                            <label class="text-xs text-gray-500 block mb-1">${item.type === 'product' ? 'Delivery Date' : 'Service Date'} <span class="text-red-500">*</span></label>
                            <input 
                                type="date"
                                value="${item.serviceDate || ''}"
                                onchange="updateItemServiceDate(${index}, this.value)"
                                class="w-full px-2 py-1.5 border border-gray-300 rounded text-sm"
                            />
                        </div>
                        <div class="col-span-2">
                            <label class="text-xs text-gray-500 block mb-1">Quantity <span class="text-red-500">*</span></label>
                            <input 
                                type="number"
                                value="${item.quantity}"
                                onchange="updateItemQuantity(${index}, this.value)"
                                class="w-full px-2 py-1.5 border border-gray-300 rounded text-sm text-center"
                                min="1"
                            />
                        </div>
                        <div class="col-span-3">
                            <label class="text-xs text-gray-500 block mb-1">Unit Price</label>
                            <input 
                                type="number"
                                value="${item.customPrice}"
                                onchange="updateItemPrice(${index}, this.value)"
                                class="w-full px-2 py-1.5 border ${item.priceModified ? 'border-yellow-500 bg-yellow-50' : 'border-gray-300'} rounded text-sm text-right"
                                min="0"
                                step="0.01"
                            />
                            ${item.priceModified ? `<span class="text-xs text-yellow-600">Modified</span>` : ''}
                        </div>
                        <div class="col-span-4">
                            <label class="text-xs text-gray-500 block mb-1">Discount</label>
                            <div class="flex gap-2">
                                <select 
                                    onchange="updateItemDiscountType(${index}, this.value)"
                                    class="w-16 px-2 py-1.5 border border-gray-300 rounded text-sm"
                                >
                                    <option value="percentage" ${item.discountType === 'percentage' ? 'selected' : ''}>%</option>
                                    <option value="fixed" ${item.discountType === 'fixed' ? 'selected' : ''}>$</option>
                                </select>
                                <input 
                                    type="number"
                                    value="${item.discount || 0}"
                                    onchange="updateItemDiscount(${index}, this.value)"
                                    class="flex-1 px-2 py-1.5 border border-gray-300 rounded text-sm text-right"
                                    min="0"
                                    step="0.01"
                                />
                            </div>
                        </div>
                    </div>
                    
                    <!-- Notes Section -->
                    <div class="mb-3">
                        <label class="text-xs text-gray-500 block mb-1">Notes</label>
                        <textarea 
                            placeholder="${item.type === 'product' ? 'Delivery instructions, quantity details, etc...' : 'Service requirements, special instructions, etc...'}"
                            onchange="updateItemNotes(${index}, this.value)"
                            class="w-full px-3 py-2 border border-gray-300 rounded text-sm resize-none"
                            rows="2"
                        >${item.notes || ''}</textarea>
                    </div>
            `;
            }).join('');
        }

        // Event handlers
        // Clear customer button - remove selected customer and show search again
        const clearCustomerBtn = document.getElementById('clearCustomerBtn');
        if (clearCustomerBtn) {
            clearCustomerBtn.addEventListener('click', function () {
                state.selectedCustomer = null;
                state.selectedQuoteContact = null;
                const searchInput = document.getElementById('customerSearchInput');
                if (searchInput) {
                    searchInput.classList.remove('border-green-500');
                    searchInput.classList.add('border-red-300');
                }
                document.getElementById('selectedCustomerCard').classList.add('hidden');
                document.getElementById('customerSearchSection').classList.remove('hidden');
                if (searchInput) {
                    searchInput.value = '';
                    searchInput.focus();
                }
            });
        }

        function selectCustomer(customerId) {
            const customer = customers.find(c => c.id === customerId);
            state.selectedCustomer = customer;

            // Hide search, show selected card
            const searchInput = document.getElementById('customerSearchInput');
            searchInput.value = '';
            searchInput.classList.remove('border-red-300');
            searchInput.classList.add('border-green-500');
            document.getElementById('customerAutocomplete').classList.add('hidden');
            document.getElementById('clearSearchBtn').classList.add('hidden');
            document.getElementById('customerSearchSection').classList.add('hidden');
            document.getElementById('selectedCustomerCard').classList.remove('hidden');

            // Populate customer info
            document.getElementById('selectedCustomerName').textContent = customer.name;
            document.getElementById('selectedCustomerEmail').textContent = customer.email;
            document.getElementById('selectedCustomerPhone').textContent = customer.phone;

            // Setup quote contact selector if secondary contacts exist
            const contactSelector = document.getElementById('quoteContactSelector');
            const contactSelect = document.getElementById('quoteContactSelect');

            if (customer.secondaryContacts && customer.secondaryContacts.length > 0) {
                // Show contact selector
                contactSelector.classList.remove('hidden');

                // Build options: primary contact + secondary contacts
                let options = `<option value="primary">Primary: ${customer.name} (${customer.email})</option>`;
                customer.secondaryContacts.forEach((contact, index) => {
                    options += `<option value="secondary-${index}">${contact.name} - ${contact.role} (${contact.email})</option>`;
                });
                contactSelect.innerHTML = options;

                // Set default to primary
                state.selectedQuoteContact = {
                    type: 'primary',
                    name: customer.name,
                    email: customer.email,
                    phone: customer.phone
                };
            } else {
                // Hide contact selector, use primary by default
                contactSelector.classList.add('hidden');
                state.selectedQuoteContact = {
                    type: 'primary',
                    name: customer.name,
                    email: customer.email,
                    phone: customer.phone
                };
            }

            // Set service address (same as billing by default)
            document.getElementById('displayServiceAddress').textContent = customer.address || 'No address on file';
            document.getElementById('sameAsBilling').checked = true;
            document.getElementById('serviceAddressFields').classList.add('hidden');
            document.getElementById('serviceAddressDisplay').style.display = 'block';

            updateCreateButton();
        }

        function addQuoteItem(serviceId) {
            const services = getServices();
            const service = services.find(s => s.id === serviceId);

            if (!service) return;

            const newItem = {
                ...service,
                quantity: 1,
                customPrice: service.price,
                originalPrice: service.price,
                priceModified: false,
                priceModificationComment: '',
                notes: '',
                serviceDate: '',
                discount: 0,
                discountType: 'percentage',
                // Schedule fields (only for services)
                preferredTime: '',
                exactTime: '',
                scheduleNotes: ''
            };

            state.quoteItems.push(newItem);
            renderQuoteItems();
            updateSummary();

            // Clear catalog search after adding
            document.getElementById('catalogSearchInput').value = '';
            document.getElementById('catalogAutocomplete').classList.add('hidden');
            document.getElementById('clearCatalogSearchBtn').classList.add('hidden');
        }

        function removeQuoteItem(index) {
            state.quoteItems.splice(index, 1);
            renderQuoteItems();
            updateSummary();
        }

        function updateItemQuantity(index, value) {
            state.quoteItems[index].quantity = Number(value);
            renderQuoteItems();
            updateSummary();
        }

        function updateItemServiceDate(index, value) {
            state.quoteItems[index].serviceDate = value;
            renderQuoteItems();
        }

        function updateItemNotes(index, value) {
            state.quoteItems[index].notes = value;
        }

        function updateItemDiscount(index, value) {
            state.quoteItems[index].discount = Number(value);
            renderQuoteItems();
            updateSummary();
        }

        function updateItemDiscountType(index, value) {
            state.quoteItems[index].discountType = value;
            renderQuoteItems();
            updateSummary();
        }

        function updateItemPreferredTime(index, value) {
            state.quoteItems[index].preferredTime = value;
            renderQuoteItems();
        }

        function updateItemExactTime(index, value) {
            state.quoteItems[index].exactTime = value;
        }

        function updateItemScheduleNotes(index, value) {
            state.quoteItems[index].scheduleNotes = value;
        }

        function showPriceModModal(index, newPrice) {
            const item = state.quoteItems[index];
            state.currentPriceModIndex = index;
            state.currentPriceModNewValue = newPrice;

            // Populate modal with item details
            document.getElementById('priceModItemName').textContent = item.name;

            // Set item type badge
            const typeBadge = document.getElementById('priceModItemType');
            if (item.type === 'product') {
                typeBadge.innerHTML = '<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800">ðŸŸ¢ Product</span>';
            } else {
                typeBadge.innerHTML = '<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800">ðŸ”µ Service</span>';
            }

            document.getElementById('priceModOriginal').textContent = `$${item.originalPrice.toFixed(2)}`;
            document.getElementById('priceModNew').textContent = `$${Number(newPrice).toFixed(2)}`;
            document.getElementById('priceModComment').value = '';

            // Show modal
            document.getElementById('priceModModal').classList.remove('hidden');
        }

        function hidePriceModModal() {
            document.getElementById('priceModModal').classList.add('hidden');
            state.currentPriceModIndex = null;
            state.currentPriceModNewValue = null;
            document.getElementById('priceModComment').value = '';
        }

        function updateItemPrice(index, value) {
            const item = state.quoteItems[index];
            const newPrice = Number(value);
            const originalPrice = item.price;

            // Check if price is being modified from original
            if (newPrice !== originalPrice && !item.priceModified) {
                // Show modal to get reason
                showPriceModModal(index, newPrice);
                return;
            }

            item.customPrice = newPrice;
            renderQuoteItems();
            updateSummary();
        }

        function confirmPriceModification() {
            const comment = document.getElementById('priceModComment').value.trim();

            if (!comment) {
                alert('Please provide a reason for the price modification');
                return;
            }

            if (state.currentPriceModIndex !== null) {
                const item = state.quoteItems[state.currentPriceModIndex];
                item.priceModified = true;
                item.priceModificationComment = comment;
                item.customPrice = state.currentPriceModNewValue;

                renderQuoteItems();
                updateSummary();
                hidePriceModModal();
            }
        }

        function cancelPriceModification() {
            if (state.currentPriceModIndex !== null) {
                // Revert to original price
                const item = state.quoteItems[state.currentPriceModIndex];
                item.customPrice = item.originalPrice;

                renderQuoteItems();
                updateSummary();
                hidePriceModModal();
            }
        }

        function updateItemNotes(index, value) {
            state.quoteItems[index].notes = value;
        }

        // Preview function
        function showPreview() {
            if (!state.selectedCustomer || state.quoteItems.length === 0) {
                alert('Please select a customer and add items to the quote first.');
                return;
            }

            const validUntil = document.getElementById('validUntilDate').value;
            const customerNotes = document.getElementById('customerNotes').value;
            const internalNotes = document.getElementById('internalNotes').value;

            // Get current date
            const currentDate = new Date().toLocaleDateString('en-AU', { day: 'numeric', month: 'long', year: 'numeric' });

            // Build line items HTML
            const lineItemsHTML = state.quoteItems.map(item => `
                <tr class="border-b border-gray-200">
                    <td class="py-2 px-1" style="width: 35%;">
                        <div class="font-medium text-gray-900">${item.name}</div>
                        <div class="text-xs text-gray-600 mt-1">${item.id}</div>
                        ${item.notes ? `<div class="text-xs text-gray-500 italic mt-1">${item.notes}</div>` : ''}
                    </td>
                    <td class="py-2 px-1 text-center text-gray-700">${item.quantity} ${item.unit}</td>
                    <td class="py-2 px-1 text-right text-gray-700">$${item.customPrice.toFixed(2)}</td>
                    <td class="py-2 px-1 text-right font-medium">$${(item.customPrice * item.quantity).toFixed(2)}</td>
                </tr>
            `).join('');

            // Format tax breakdown
            const taxBreakdown = getTaxBreakdown();
            const taxBreakdownHTML = `
                ${taxBreakdown.taxable_gst > 0 ? `<div class="flex justify-between text-sm py-1"><span>GST (10%):</span><span>$${taxBreakdown.taxable_gst.toFixed(2)}</span></div>` : ''}
                ${taxBreakdown.gst_free > 0 ? `<div class="flex justify-between text-xs text-gray-500 py-1"><span>GST-Free Items:</span><span>$${state.quoteItems.filter(i => i.taxCategory === 'gst_free').reduce((sum, i) => sum + i.customPrice * i.quantity, 0).toFixed(2)}</span></div>` : ''}
                ${taxBreakdown.input_taxed > 0 ? `<div class="flex justify-between text-xs text-gray-500 py-1"><span>Input-Taxed Items:</span><span>$${state.quoteItems.filter(i => i.taxCategory === 'input_taxed').reduce((sum, i) => sum + i.customPrice * i.quantity, 0).toFixed(2)}</span></div>` : ''}
            `;

            const netSubtotal = calculateSubtotal();
            const lineItemDiscounts = calculateLineItemDiscounts();
            const grossSubtotal = netSubtotal + lineItemDiscounts;
            const totalTax = calculateTax();

            // Build preview HTML
            const previewHTML = `
                <!-- Company Header -->
                <div class="border-b-2 border-gray-800 pb-4 mb-6">
                    <div class="flex items-center justify-between mb-4">
                        <div>
                            <h1 class="text-3xl font-bold text-gray-900 mb-1">SUNSHINE TUTORING</h1>
                            <p class="text-sm text-gray-600">Tutoring Excellence Since 2015</p>
                        </div>
                        <div class="text-right">
                            <p class="text-lg font-bold">QUOTE</p>
                            <p class="text-sm text-gray-600">Date: ${currentDate}</p>
                        </div>
                    </div>
                </div>

                <!-- Customer Details -->
                <div class="grid grid-cols-2 gap-6 mb-6">
                    <div>
                        <h3 class="font-semibold text-gray-900 mb-2 text-sm uppercase tracking-wide">Bill To:</h3>
                        <div class="text-sm text-gray-700">
                            <p class="font-medium">${state.selectedCustomer.name}</p>
                            ${state.selectedCustomer.company ? `<p>${state.selectedCustomer.company}</p>` : ''}
                            <p>${state.selectedCustomer.email}</p>
                            <p>${state.selectedCustomer.phone}</p>
                            ${state.selectedCustomer.address ? `<p class="mt-2">${state.selectedCustomer.address}</p>` : ''}
                        </div>
                    </div>
                    <div>
                        <h3 class="font-semibold text-gray-900 mb-2 text-sm uppercase tracking-wide">Quote Details:</h3>
                        <div class="text-sm text-gray-700">
                            <p><span class="font-medium">Quote ID:</span> Q-2024-001</p>
                            <p><span class="font-medium">Valid Until:</span> ${validUntil ? new Date(validUntil).toLocaleDateString('en-AU', { day: 'numeric', month: 'long', year: 'numeric' }) : 'N/A'}</p>
                            <p class="mt-2 text-xs text-gray-500">Melbourne East Branch</p>
                        </div>
                    </div>
                </div>

                <!-- Line Items Table -->
                <div class="mb-6">
                    <table class="w-full text-sm" style="min-width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr class="bg-gray-100 border-b-2 border-gray-800">
                                <th class="text-left py-2 px-1 font-semibold text-gray-900" style="width: 35%;">Description</th>
                                <th class="text-center py-2 px-1 font-semibold text-gray-900" style="width: 20%;">Quantity</th>
                                <th class="text-right py-2 px-1 font-semibold text-gray-900" style="width: 20%;">Unit Price</th>
                                <th class="text-right py-2 px-1 font-semibold text-gray-900" style="width: 25%;">Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${lineItemsHTML}
                        </tbody>
                    </table>
                </div>

                <!-- Summary -->
                <div class="flex justify-end mb-6">
                    <div class="w-64">
                        <div class="border-t border-gray-300 pt-3">
                            <div class="flex justify-between text-sm py-1">
                                <span class="text-gray-700">Subtotal:</span>
                                <span class="font-medium">$${grossSubtotal.toFixed(2)}</span>
                            </div>
                            ${lineItemDiscounts > 0 ? `
                                <div class="flex justify-between text-sm py-1">
                                    <span class="text-gray-700">Line Item Discounts:</span>
                                    <span class="text-red-600">-$${lineItemDiscounts.toFixed(2)}</span>
                                </div>
                            ` : ''}
                            <div class="flex justify-between text-sm py-1">
                                <span class="text-gray-700">Net Subtotal:</span>
                                <span class="font-medium">$${netSubtotal.toFixed(2)}</span>
                            </div>
                            <div class="border-t border-gray-300 mt-2 pt-2">
                                ${taxBreakdownHTML}
                                <div class="flex justify-between items-center mt-2 pt-2 border-t border-gray-800">
                                    <span class="text-sm font-semibold">Total Tax:</span>
                                    <span class="text-sm font-semibold">$${totalTax.toFixed(2)}</span>
                                </div>
                            </div>
                            <div class="border-t-2 border-gray-800 mt-2 pt-2">
                                <div class="flex justify-between">
                                    <span class="text-lg font-bold text-gray-900">TOTAL:</span>
                                    <span class="text-lg font-bold text-gray-900">$${(netSubtotal + totalTax).toFixed(2)}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Notes -->
                ${customerNotes ? `
                    <div class="border-t border-gray-300 pt-4 mb-4">
                        <h4 class="font-semibold text-gray-900 mb-2 text-sm uppercase tracking-wide">Notes:</h4>
                        <p class="text-sm text-gray-700 whitespace-pre-wrap">${customerNotes}</p>
                    </div>
                ` : ''}

                <!-- Footer -->
                <div class="border-t-2 border-gray-800 pt-4 mt-6">
                    <div class="grid grid-cols-2 gap-6 text-xs text-gray-600">
                        <div>
                            <p class="font-semibold text-gray-900 mb-1">Sunshine Tutoring - Melbourne East</p>
                            <p>123 Education Street, Melbourne VIC 3000</p>
                            <p>Phone: (03) 1234 5678</p>
                            <p>Email: melbourne@sunshinetutoring.com.au</p>
                        </div>
                        <div>
                            <p class="font-semibold text-gray-900 mb-1">Payment Information</p>
                            <p>ABN: 12 345 678 901</p>
                            <p>Valid for 30 days from date of issue</p>
                            <p class="mt-2 text-gray-500">Terms and conditions apply</p>
                        </div>
                    </div>
                </div>

                ${internalNotes ? `
                    <div class="mt-6 pt-4 border-t-2 border-dashed border-red-300 bg-red-50 p-3 rounded">
                        <p class="text-xs font-semibold text-red-700 mb-1">INTERNAL NOTES (Not visible to customer):</p>
                        <p class="text-xs text-red-600 whitespace-pre-wrap">${internalNotes}</p>
                    </div>
                ` : ''}
            `;

            document.getElementById('previewContent').innerHTML = previewHTML;
            document.getElementById('previewModal').classList.remove('hidden');
        }


        // Initialize
        document.addEventListener('DOMContentLoaded', function () {
            // EDIT MODE: Load existing quote data
            // Set quote ID
            document.getElementById('quoteIdBadge').textContent = existingQuote.id;

            // Developer helper: Test different statuses
            console.log('%cðŸ”§ Developer Tools', 'color: #3b82f6; font-weight: bold; font-size: 14px;');
            console.log('Test different quote statuses by running:');
            console.log('  testStatus("draft")    - Editable, can send/delete');
            console.log('  testStatus("sent")     - Editable, can approve/reject');
            console.log('  testStatus("approved") - Read-only, can create invoice');
            console.log('  testStatus("rejected") - Read-only, can clone');
            console.log('  testStatus("expired")  - Read-only, can renew/clone');
            console.log('  testStatus("invoiced") - Read-only, view invoices');

            // Make testStatus function available globally
            window.testStatus = function (status) {
                if (statusConfig[status]) {
                    existingQuote.status = status;
                    state.quoteStatus = status; // Update state to sync with existingQuote
                    // Re-enable editing first (in case coming from read-only status)
                    enableEditing();

                    // Re-render (this will disable again if needed)
                    renderStatusActions();
                    console.log(`âœ… Status changed to: ${status}`);
                } else {
                    console.error('âŒ Invalid status. Use: draft, sent, approved, rejected, expired, or invoiced');
                }
            };

            // Set valid until date from existing quote
            document.getElementById('validUntilDate').value = existingQuote.validUntil;

            // Set notes from existing quote
            document.getElementById('customerNotes').value = existingQuote.customerNotes;
            document.getElementById('internalNotes').value = existingQuote.internalNotes;

            // EDIT MODE: Populate customer data
            if (state.selectedCustomer) {
                // Hide customer search section, show selected customer card
                document.getElementById('customerSearchSection').classList.add('hidden');
                document.getElementById('selectedCustomerCard').classList.remove('hidden');

                document.getElementById('selectedCustomerName').textContent = state.selectedCustomer.name;
                document.getElementById('selectedCustomerEmail').textContent = state.selectedCustomer.email;
                document.getElementById('selectedCustomerPhone').textContent = state.selectedCustomer.phone;
                document.getElementById('displayServiceAddress').textContent = state.selectedCustomer.address;

                // Setup quote contact selector if secondary contacts exist
                const contactSelector = document.getElementById('quoteContactSelector');
                const contactSelect = document.getElementById('quoteContactSelect');

                if (state.selectedCustomer.secondaryContacts && state.selectedCustomer.secondaryContacts.length > 0) {
                    contactSelector.classList.remove('hidden');
                    let options = `<option value="primary">Primary: ${state.selectedCustomer.name} (${state.selectedCustomer.email})</option>`;
                    state.selectedCustomer.secondaryContacts.forEach((contact, index) => {
                        options += `<option value="secondary-${index}">${contact.name} - ${contact.role} (${contact.email})</option>`;
                    });
                    contactSelect.innerHTML = options;
                }
            } else {
                // No customer selected - show search section, hide card
                document.getElementById('customerSearchSection').classList.remove('hidden');
                document.getElementById('selectedCustomerCard').classList.add('hidden');
            }

            // Render existing quote items
            renderQuoteItems();
            updateSummary();

            // Render status-based action buttons and update UI (AFTER items are rendered)
            renderStatusActions();

            // Catalog search autocomplete
            const catalogSearchInput = document.getElementById('catalogSearchInput');
            const clearCatalogSearchBtn = document.getElementById('clearCatalogSearchBtn');

            if (catalogSearchInput) {
                catalogSearchInput.addEventListener('input', function (e) {
                    renderCatalogAutocomplete(e.target.value);
                });
            }

            // Clear catalog search button
            if (clearCatalogSearchBtn) {
                clearCatalogSearchBtn.addEventListener('click', function () {
                    const catalogSearchInput = document.getElementById('catalogSearchInput');
                    const catalogAutocomplete = document.getElementById('catalogAutocomplete');
                    const clearCatalogSearchBtn = document.getElementById('clearCatalogSearchBtn');

                    if (catalogSearchInput) catalogSearchInput.value = '';
                    if (catalogAutocomplete) catalogAutocomplete.classList.add('hidden');
                    if (clearCatalogSearchBtn) clearCatalogSearchBtn.classList.add('hidden');
                });
            }

            // Close catalog autocomplete when clicking outside
            document.addEventListener('click', function (e) {
                const catalogSearch = document.getElementById('catalogSearchInput');
                const autocomplete = document.getElementById('catalogAutocomplete');
                if (catalogSearch && !catalogSearch.parentElement.contains(e.target)) {
                    autocomplete.classList.add('hidden');
                }
            });

            // Customer search autocomplete
            const customerSearchInput = document.getElementById('customerSearchInput');
            if (customerSearchInput) {
                customerSearchInput.addEventListener('input', function (e) {
                    renderCustomerAutocomplete(e.target.value);
                });
            }

            // Clear search button
            const clearSearchBtn = document.getElementById('clearSearchBtn');
            if (clearSearchBtn) {
                clearSearchBtn.addEventListener('click', function () {
                    if (customerSearchInput) customerSearchInput.value = '';
                    const autocomplete = document.getElementById('customerAutocomplete');
                    if (autocomplete) autocomplete.classList.add('hidden');
                    if (clearSearchBtn) clearSearchBtn.classList.add('hidden');
                });
            }

            // Close customer autocomplete when clicking outside
            document.addEventListener('click', function (e) {
                const searchSection = document.getElementById('customerSearchSection');
                const autocomplete = document.getElementById('customerAutocomplete');
                if (searchSection && !searchSection.contains(e.target)) {
                    if (autocomplete) autocomplete.classList.add('hidden');
                }
            });

            // EDIT MODE: Customer can be changed by clearing and selecting again

            // Quote contact selector change
            const quoteContactSelect = document.getElementById('quoteContactSelect');
            if (quoteContactSelect) {
                quoteContactSelect.addEventListener('change', function (e) {
                    const value = e.target.value;
                    const customer = state.selectedCustomer;

                    if (value === 'primary') {
                        state.quoteContact = customer.primaryContact;
                    } else if (value === 'add_new') {
                        // In real implementation, open add contact modal
                        alert('Add new contact functionality would be implemented here');
                    } else {
                        // Find secondary contact
                        const contact = customer.secondaryContacts?.find(c => c.id === value);
                        if (contact) {
                            state.quoteContact = contact;
                        }
                    }

                    updateQuoteContactDisplay();
                });
            }

            // Service address toggle
            const sameAsBilling = document.getElementById('sameAsBilling');
            if (sameAsBilling) {
                sameAsBilling.addEventListener('change', function (e) {
                    const isChecked = e.target.checked;
                    const serviceAddressFields = document.getElementById('serviceAddressFields');
                    const serviceAddressDisplay = document.getElementById('serviceAddressDisplay');

                    if (serviceAddressFields) {
                        serviceAddressFields.classList.toggle('hidden', isChecked);
                    }
                    if (serviceAddressDisplay) {
                        serviceAddressDisplay.style.display = isChecked ? 'block' : 'none';
                    }

                    if (isChecked && state.selectedCustomer && serviceAddressDisplay) {
                        // Copy billing address to service address
                        serviceAddressDisplay.innerHTML = `
                            <div class="text-sm text-gray-700">
                                ${state.selectedCustomer.address}<br>
                                ${state.selectedCustomer.city}, ${state.selectedCustomer.state} ${state.selectedCustomer.zip}
                            </div>
                        `;
                    }
                });
            }

            // Create quote button
            const createQuoteBtn = document.getElementById('createQuoteBtn');
            if (createQuoteBtn) {
                createQuoteBtn.addEventListener('click', function () {
                    if (!state.selectedCustomer) {
                        alert('Please select a customer');
                        return;
                    }

                    if (state.quoteItems.length === 0) {
                        alert('Please add at least one item to the quote');
                        return;
                    }

                    // Check for price modifications
                    const priceModifiedItems = state.quoteItems.filter(item => item.priceModified);
                    if (priceModifiedItems.length > 0) {
                        console.log('Price modifications:',
                            priceModifiedItems.map(item => ({
                                name: item.name,
                                originalPrice: item.originalPrice,
                                modifiedPrice: item.customPrice,
                                comment: item.priceModificationComment
                            }))
                        );
                    }

                    // Create quote data
                    const quoteData = {
                        customer: state.selectedCustomer,
                        quoteContact: state.selectedQuoteContact, // Contact who will receive the quote
                        items: state.quoteItems,
                        subtotal: calculateSubtotal(),
                        tax: calculateTax(),
                        total: calculateTotal(),
                        validUntil: document.getElementById('validUntilDate').value,
                        customerNotes: document.getElementById('customerNotes').value,
                        internalNotes: document.getElementById('internalNotes').value,
                        priceModifications: priceModifiedItems.map(item => ({
                            name: item.name,
                            originalPrice: item.originalPrice,
                            modifiedPrice: item.customPrice,
                            comment: item.priceModificationComment
                        })),
                        status: 'active',
                        createdDate: new Date().toISOString()
                    };

                    // Here you would normally send the quote data to the server
                    console.log('Creating quote:', quoteData);

                    const contactName = state.selectedQuoteContact.type === 'secondary'
                        ? `${state.selectedQuoteContact.name} (${state.selectedQuoteContact.role})`
                        : state.selectedCustomer.name;
                    alert(`Quote created successfully for ${state.selectedCustomer.name}!\nQuote will be sent to: ${contactName}`);
                    // In real implementation: redirect to quotes list or quote detail page
                    // window.location.href = 'quotes.html';
                });
            }

            // PDF Preview modal buttons
            const closePdfPreviewBtn = document.getElementById('closePdfPreview');
            const downloadPdfFromPreviewBtn = document.getElementById('downloadPdfFromPreview');

            if (closePdfPreviewBtn) {
                closePdfPreviewBtn.addEventListener('click', closePdfPreview);
            }
            if (downloadPdfFromPreviewBtn) {
                downloadPdfFromPreviewBtn.addEventListener('click', function () {
                    downloadQuotePDF();
                    closePdfPreview();
                });
            }

            // Close PDF preview on ESC key
            document.addEventListener('keydown', function (e) {
                if (e.key === 'Escape') {
                    const pdfModal = document.getElementById('pdfPreviewModal');
                    if (pdfModal && !pdfModal.classList.contains('hidden')) {
                        closePdfPreview();
                    }
                }
            });

            // Invoice preview modal buttons
            const closeInvoicePreviewBtn = document.getElementById('closeInvoicePreviewBtn');
            const createAllInvoicesBtn = document.getElementById('createAllInvoicesBtn');

            if (closeInvoicePreviewBtn) {
                closeInvoicePreviewBtn.addEventListener('click', hideInvoicePreview);
            }
            if (createAllInvoicesBtn) {
                createAllInvoicesBtn.addEventListener('click', createAllInvoicesFromPreview);
            }

            // Close invoice preview modal on background click
            const invoicePreviewModal = document.getElementById('invoicePreviewModal');
            if (invoicePreviewModal) {
                invoicePreviewModal.addEventListener('click', function (e) {
                    if (e.target.id === 'invoicePreviewModal') {
                        hideInvoicePreview();
                    }
                });
            }

            // Close invoice preview modal on ESC key
            document.addEventListener('keydown', function (e) {
                if (e.key === 'Escape') {
                    const invoicePreviewModal = document.getElementById('invoicePreviewModal');
                    if (invoicePreviewModal && !invoicePreviewModal.classList.contains('hidden')) {
                        hideInvoicePreview();
                    }
                }
            });

            // Price modification modal event listeners
            const closePriceModModal = document.getElementById('closePriceModModal');
            const cancelPriceModBtn = document.getElementById('cancelPriceModBtn');
            const savePriceModBtn = document.getElementById('savePriceModBtn');
            const priceModModal = document.getElementById('priceModModal');

            if (closePriceModModal) {
                closePriceModModal.addEventListener('click', cancelPriceModification);
            }
            if (cancelPriceModBtn) {
                cancelPriceModBtn.addEventListener('click', cancelPriceModification);
            }
            if (savePriceModBtn) {
                savePriceModBtn.addEventListener('click', confirmPriceModification);
            }

            // Close modal on background click
            if (priceModModal) {
                priceModModal.addEventListener('click', function (e) {
                    if (e.target.id === 'priceModModal') {
                        cancelPriceModification();
                    }
                });

                // Close modal on Escape key
                document.addEventListener('keydown', function (e) {
                    if (e.key === 'Escape' && !priceModModal.classList.contains('hidden')) {
                        cancelPriceModification();
                    }
                });
            }

            // Initialize payment model constraints on page load
            updatePaymentModel();

            // Payment configuration event listeners with autosave
            const defaultPaymentTerms = document.getElementById('defaultPaymentTerms');
            const subscriptionStartDate = document.getElementById('subscriptionStartDate');
            const billingFrequency = document.getElementById('billingFrequency');

            // Autosave payment configuration on change
            if (defaultPaymentTerms) {
                defaultPaymentTerms.addEventListener('change', function () {
                    updatePaymentTermsDisplay();
                    autoSavePaymentConfiguration();
                });
            }

            // Add autosave to all payment config inputs
            const paymentConfigInputs = document.querySelectorAll('#paymentConfigContent input, #paymentConfigContent select, #paymentConfigContent textarea');
            paymentConfigInputs.forEach(input => {
                input.addEventListener('change', autoSavePaymentConfiguration);
            });

            // Payment method radio buttons
            const paymentMethodsContainer = document.getElementById('paymentMethodsContainer');
            if (paymentMethodsContainer) {
                document.querySelectorAll('#paymentMethodsContainer input[type="radio"]').forEach(radio => {
                    radio.addEventListener('change', updatePaymentMethodsDisplay);
                });
            }

            // Subscription date changes
            if (subscriptionStartDate) {
                subscriptionStartDate.addEventListener('change', calculateNextInvoiceDate);
            }
            if (billingFrequency) {
                billingFrequency.addEventListener('change', updateBillingDateField);
            }

            // Billing date field changes
            const billingDay = document.getElementById('billingDay');
            const billingWeekday = document.getElementById('billingWeekday');
            if (billingDay) {
                billingDay.addEventListener('change', calculateNextInvoiceDate);
            }
            if (billingWeekday) {
                billingWeekday.addEventListener('change', calculateNextInvoiceDate);
            }

            // Remaining balance due date changes
            const remainingBalanceDueType = document.getElementById('remainingBalanceDueType');
            const remainingBalanceDueDate = document.getElementById('remainingBalanceDueDate');
            const daysAfterDeposit = document.getElementById('daysAfterDeposit');
            const daysBeforeService = document.getElementById('daysBeforeService');

            if (remainingBalanceDueType) {
                remainingBalanceDueType.addEventListener('change', toggleRemainingBalanceDueDate);
            }
            if (remainingBalanceDueDate) {
                remainingBalanceDueDate.addEventListener('change', updateRemainingBalanceDuePreview);
            }
            if (daysAfterDeposit) {
                daysAfterDeposit.addEventListener('input', updateRemainingBalanceDuePreview);
            }
            if (daysBeforeService) {
                daysBeforeService.addEventListener('input', updateRemainingBalanceDuePreview);
            }

            // Initialize payment configuration displays
            updatePaymentModel();
            updatePaymentTermsDisplay();
            updatePaymentMethodsDisplay();

            // Initialize invoice management
            loadInvoices();
            updateInvoiceSummary();

            // Initialize split invoice functionality
            initializeSplitInvoice();

            // Initialize invoice distribution functionality
            initializeDistribution();

            // Initial render
            renderQuoteItems();
            updateSummary();
        });

        function checkInvoicePaymentStatus(invoice) {
            // Logic: Invoice is paid ONLY if all individual payment requests are satisfied
            // If manual generic payment (no assigned payers), fallback to total amount check

            const newPaidAmount = getConfirmedPaymentsTotal(invoice);

            if (!invoice.assignedPayers || invoice.assignedPayers.length === 0) {
                // Fallback for single payer / legacy
                if (newPaidAmount >= invoice.amount - 0.01) {
                    invoice.status = 'paid';
                } else if (newPaidAmount > 0) {
                    invoice.status = 'partially_paid';
                }
            } else {
                // Strict check: Are all assigned payers status = 'paid'?
                const allPaid = invoice.assignedPayers.every(p => {
                    // Check logic: paidAmount >= assignedAmount
                    const pAmount = p.assignedAmount || 0;
                    const pPaid = p.paidAmount || 0;
                    return pPaid >= pAmount - 0.01;
                });

                if (allPaid && newPaidAmount >= invoice.amount - 0.01) {
                    invoice.status = 'paid';
                } else if (newPaidAmount > 0) {
                    invoice.status = 'partially_paid';
                } else {
                    invoice.status = 'sent'; // or invoiced
                }
            }
        }

        // Generate invoice preview based on model
        function generateInvoicePreview() {
            // Get current quote ID (in real app, get from URL or data)
            const quoteId = document.getElementById('quoteIdBadge').textContent;

            // Validate quote status
            const quoteStatus = document.getElementById('quoteStatusBadge').textContent.toLowerCase();

            if (quoteStatus === 'draft') {
                if (!confirm('This quote is still in draft status. Do you want to create an invoice anyway?')) {
                    return;
                }
            }

            // Navigate to invoice creation page with quote ID
            window.location.href = `invoice_create_simple.html?quoteId=${quoteId}`;
        }

        // ============================================================================
        // TAB SWITCHING FUNCTIONALITY
        // ============================================================================

        function updateTabsVisibility() {
            const restrictedStatuses = ['expired', 'rejected', 'draft'];
            const paymentConfigTab = document.getElementById('paymentConfigTab');
            const invoicesTab = document.getElementById('invoicesTab');

            if (restrictedStatuses.includes(state.quoteStatus)) {
                // Disable and gray out tabs
                [paymentConfigTab, invoicesTab].forEach(tab => {
                    tab.classList.add('opacity-50', 'cursor-not-allowed');
                    tab.classList.remove('hover:text-gray-700', 'hover:border-gray-300');
                });
            } else {
                // Enable tabs
                [paymentConfigTab, invoicesTab].forEach(tab => {
                    tab.classList.remove('opacity-50', 'cursor-not-allowed');
                    tab.classList.add('hover:text-gray-700', 'hover:border-gray-300');
                });
            }
        }

        function switchTab(tabName) {
            // Check if expired/rejected/draft quotes can access Payment Configuration or Invoices tabs
            const restrictedStatuses = ['expired', 'rejected', 'draft'];
            const restrictedTabs = ['paymentConfig', 'invoices'];

            if (restrictedStatuses.includes(state.quoteStatus) && restrictedTabs.includes(tabName)) {
                let message = '';
                if (state.quoteStatus === 'expired') {
                    message = 'â° This quote has expired. Please renew or clone the quote before managing invoices or payment configuration.';
                } else if (state.quoteStatus === 'rejected') {
                    message = 'âŒ This quote has been rejected. Clone the quote to create a new one if needed.';
                } else if (state.quoteStatus === 'draft') {
                    message = 'ðŸ“ This quote is still in draft. Send it to the customer and get approval before configuring payments or creating invoices.';
                }
                alert(message);
                return; // Prevent tab switch
            }

            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });

            // Remove active class from all tab buttons
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active', 'border-blue-500', 'text-blue-600');
                button.classList.add('border-transparent', 'text-gray-500');
            });

            // Show selected tab content
            document.getElementById(tabName + 'Content').classList.remove('hidden');

            // Add active class to selected tab button
            const activeButton = document.getElementById(tabName + 'Tab');
            activeButton.classList.add('active', 'border-blue-500', 'text-blue-600');
            activeButton.classList.remove('border-transparent', 'text-gray-500');

            // Update invoice summary when switching to invoices tab
            if (tabName === 'invoices') {
                loadInvoices();
                updateInvoiceSummary();
                // Initialize activity log (always update, not just when visible)
                setTimeout(() => {

                }, 200);
            }

            // Update invoice summary when switching to Payment Configuration tab to show current remaining amount
            if (tabName === 'paymentConfig') {
                updateInvoiceSummary();
            }
        }

        // Make switchTab globally accessible
        window.switchTab = switchTab;

        // ============================================================================
        // PAYMENT CONFIGURATION FUNCTIONALITY
        // ============================================================================

        // Payment method constraints based on payment model
        const paymentMethodConstraints = {
            full: {
                allowed: ['stripe', 'paypal', 'google_wallet', 'apple_pay', 'cash'],
                hint: 'All payment methods available for full payment'
            },
            deposit: {
                allowed: ['stripe', 'paypal', 'cash'],
                hint: 'Deposit payments support Stripe, PayPal, and Cash only',
                reason: 'Digital wallets not supported for deposit payments'
            },
            subscription: {
                allowed: ['stripe', 'paypal'],
                required: true,
                hint: 'Subscription requires auto-charge capable methods (Stripe or PayPal)',
                reason: 'Only Stripe and PayPal support recurring automatic charges'
            }
        };

        // Payment model functions
        function updatePaymentModel() {
            const model = document.querySelector('input[name="paymentModel"]:checked').value;
            console.log('Payment model changed to:', model); // Debug log
            const depositSection = document.getElementById('paymentDepositSection');
            const subscriptionSection = document.getElementById('subscriptionSection');
            const depositInfo = document.getElementById('depositInfo');
            const paymentModelDisplay = document.getElementById('paymentModelDisplay');

            console.log('Deposit section element:', depositSection); // Debug log

            // Hide all sections first
            if (depositSection) depositSection.classList.add('hidden');
            if (subscriptionSection) subscriptionSection.classList.add('hidden');
            if (depositInfo) depositInfo.classList.add('hidden');

            // Get payment method elements
            const stripeRadio = document.getElementById('paymentStripe');
            const cashRadio = document.getElementById('paymentCash');
            const cashLabel = cashRadio ? cashRadio.closest('label') : null;
            const paymentMethodHint = document.getElementById('paymentMethodHint');

            if (model === 'deposit') {
                if (depositSection) depositSection.classList.remove('hidden');
                if (depositInfo) depositInfo.classList.remove('hidden');
                if (paymentModelDisplay) paymentModelDisplay.textContent = 'Down Payment';
                // Initialize remaining balance due date
                toggleRemainingBalanceDueDate();

                // Enable both payment methods for deposit
                if (cashRadio) {
                    cashRadio.disabled = false;
                    if (cashLabel) {
                        cashLabel.classList.remove('opacity-50', 'cursor-not-allowed');
                        cashLabel.classList.add('cursor-pointer');
                    }
                }
                if (paymentMethodHint) {
                    paymentMethodHint.textContent = 'Select one payment method';
                    paymentMethodHint.classList.remove('text-orange-600');
                }
            } else if (model === 'subscription') {
                if (subscriptionSection) subscriptionSection.classList.remove('hidden');
                if (paymentModelDisplay) paymentModelDisplay.textContent = 'Subscription';
                // Set default subscription start date to today
                const startDateInput = document.getElementById('subscriptionStartDate');
                if (startDateInput && !startDateInput.value) {
                    startDateInput.value = new Date().toISOString().split('T')[0];
                }
                // Initialize billing date field
                updateBillingDateField();
                calculateNextInvoiceDate();

                // Disable Cash for subscription - only Stripe is supported
                if (cashRadio) {
                    cashRadio.disabled = true;
                    if (cashRadio.checked) {
                        // If Cash was selected, switch to Stripe
                        if (stripeRadio) {
                            stripeRadio.checked = true;
                            updatePaymentMethodsDisplay();
                        }
                    }
                    if (cashLabel) {
                        cashLabel.classList.add('opacity-50', 'cursor-not-allowed');
                        cashLabel.classList.remove('cursor-pointer', 'hover:bg-gray-50');
                    }
                }
                // Ensure Stripe is selected
                if (stripeRadio && !stripeRadio.checked) {
                    stripeRadio.checked = true;
                    updatePaymentMethodsDisplay();
                }
                if (paymentMethodHint) {
                    paymentMethodHint.textContent = 'Subscription requires Stripe for automatic recurring charges. Cash is not supported.';
                    paymentMethodHint.classList.add('text-orange-600');
                }
            } else {
                if (paymentModelDisplay) paymentModelDisplay.textContent = 'Full Payment';

                // Enable both payment methods for full payment
                if (cashRadio) {
                    cashRadio.disabled = false;
                    if (cashLabel) {
                        cashLabel.classList.remove('opacity-50', 'cursor-not-allowed');
                        cashLabel.classList.add('cursor-pointer');
                    }
                }
                if (paymentMethodHint) {
                    paymentMethodHint.textContent = 'Select one payment method';
                    paymentMethodHint.classList.remove('text-orange-600');
                }
            }

            // Update payment methods display
            updatePaymentMethodsDisplay();

            // Update invoice summary if on invoices tab
            const invoicesContent = document.getElementById('invoicesContent');
            if (invoicesContent && !invoicesContent.classList.contains('hidden')) {
                updateInvoiceSummary();
            }

            // Update invoice tab summary
            const invoiceModelDisplay = document.getElementById('invoiceTabPaymentModel');
            const invoiceDepositInfo = document.getElementById('invoiceTabDepositInfo');
            const invoiceDepositAmount = document.getElementById('invoiceTabDepositAmount');

            if (invoiceModelDisplay) {
                if (model === 'deposit') {
                    invoiceModelDisplay.textContent = 'Down Payment';
                    if (invoiceDepositInfo) {
                        invoiceDepositInfo.classList.remove('hidden');
                        const depositAmount = parseFloat(document.getElementById('depositAmount')?.value) || 0;
                        if (invoiceDepositAmount) {
                            invoiceDepositAmount.textContent = `$${depositAmount.toFixed(2)}`;
                        }
                    }
                } else if (model === 'subscription') {
                    invoiceModelDisplay.textContent = 'Subscription';
                    if (invoiceDepositInfo) {
                        invoiceDepositInfo.classList.add('hidden');
                    }
                } else {
                    invoiceModelDisplay.textContent = 'Full Payment';
                    if (invoiceDepositInfo) {
                        invoiceDepositInfo.classList.add('hidden');
                    }
                }
            }
        }

        function toggleEndDate() {
            const endType = document.getElementById('subscriptionEnd').value;
            const cyclesInput = document.getElementById('cyclesInput');
            const endDateInput = document.getElementById('endDateInput');

            cyclesInput.classList.add('hidden');
            endDateInput.classList.add('hidden');

            if (endType === 'after_cycles') {
                cyclesInput.classList.remove('hidden');
            } else if (endType === 'end_date') {
                endDateInput.classList.remove('hidden');
            }

            calculateNextInvoiceDate();
        }

        function updateBillingDateField() {
            const frequency = document.getElementById('billingFrequency').value;
            const billingDayOfMonth = document.getElementById('billingDayOfMonth');
            const billingDayOfWeek = document.getElementById('billingDayOfWeek');
            const billingDatePreview = document.getElementById('billingDatePreview');

            // Hide both initially
            if (billingDayOfMonth) billingDayOfMonth.classList.add('hidden');
            if (billingDayOfWeek) billingDayOfWeek.classList.add('hidden');

            // Show appropriate field based on frequency
            if (frequency === 'monthly') {
                // Only show billing day field for monthly
                if (billingDayOfMonth) billingDayOfMonth.classList.remove('hidden');
                const billingDayPeriod = document.getElementById('billingDayPeriod');
                if (billingDayPeriod) {
                    billingDayPeriod.textContent = `of each month`;
                }
                if (billingDatePreview) {
                    const billingDay = document.getElementById('billingDay').value || 1;
                    billingDatePreview.textContent = `Billing will occur on day ${billingDay} of each month`;
                }
            } else if (frequency === 'quarterly' || frequency === 'yearly') {
                // For quarterly and yearly, use subscription start date for billing
                if (billingDatePreview) {
                    const startDate = document.getElementById('subscriptionStartDate').value;
                    if (startDate) {
                        const date = new Date(startDate);
                        const day = date.getDate();
                        const periodText = frequency === 'quarterly' ? 'quarter' : 'year';
                        billingDatePreview.textContent = `Billing will occur on day ${day} of each ${periodText}, based on subscription start date`;
                    } else {
                        const periodText = frequency === 'quarterly' ? 'quarter' : 'year';
                        billingDatePreview.textContent = `Billing will occur each ${periodText} on the same day as subscription start date`;
                    }
                }
            } else if (frequency === 'weekly' || frequency === 'biweekly') {
                if (billingDayOfWeek) billingDayOfWeek.classList.remove('hidden');
                if (billingDatePreview) {
                    const weekday = document.getElementById('billingWeekday');
                    const weekdayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                    const selectedDay = weekdayNames[parseInt(weekday.value) || 0];
                    billingDatePreview.textContent = `Billing will occur every ${frequency === 'weekly' ? 'week' : '2 weeks'} on ${selectedDay}`;
                }
            }

            calculateNextInvoiceDate();
        }

        function calculateNextInvoiceDate() {
            const startDateInput = document.getElementById('subscriptionStartDate');
            const frequency = document.getElementById('billingFrequency').value;

            if (!startDateInput || !startDateInput.value) {
                const nextInvoiceDateEl = document.getElementById('nextInvoiceDate');
                if (nextInvoiceDateEl) nextInvoiceDateEl.textContent = '-';
                return;
            }

            const startDate = new Date(startDateInput.value);
            if (isNaN(startDate.getTime())) {
                const nextInvoiceDateEl = document.getElementById('nextInvoiceDate');
                if (nextInvoiceDateEl) nextInvoiceDateEl.textContent = '-';
                return;
            }

            const nextDate = new Date(startDate);
            const billingDatePreview = document.getElementById('billingDatePreview');

            switch (frequency) {
                case 'weekly':
                    // Use the selected weekday
                    const weekday = parseInt(document.getElementById('billingWeekday').value) || startDate.getDay();
                    nextDate.setDate(nextDate.getDate() + 7);
                    // Adjust to the selected weekday
                    const daysUntilWeekday = (weekday - nextDate.getDay() + 7) % 7;
                    nextDate.setDate(nextDate.getDate() + daysUntilWeekday);
                    break;
                case 'biweekly':
                    const biweeklyWeekday = parseInt(document.getElementById('billingWeekday').value) || startDate.getDay();
                    nextDate.setDate(nextDate.getDate() + 14);
                    const daysUntilBiweeklyWeekday = (biweeklyWeekday - nextDate.getDay() + 7) % 7;
                    nextDate.setDate(nextDate.getDate() + daysUntilBiweeklyWeekday);
                    break;
                case 'monthly':
                    // Use the selected day of month
                    const billingDay = parseInt(document.getElementById('billingDay').value) || 1;
                    nextDate.setMonth(nextDate.getMonth() + 1);
                    // Set to the billing day, but handle months with fewer days
                    const lastDayOfMonth = new Date(nextDate.getFullYear(), nextDate.getMonth() + 1, 0).getDate();
                    nextDate.setDate(Math.min(billingDay, lastDayOfMonth));
                    break;
                case 'quarterly':
                    const quarterlyBillingDay = parseInt(document.getElementById('billingDay').value) || 1;
                    nextDate.setMonth(nextDate.getMonth() + 3);
                    const lastDayOfQuarter = new Date(nextDate.getFullYear(), nextDate.getMonth() + 1, 0).getDate();
                    nextDate.setDate(Math.min(quarterlyBillingDay, lastDayOfQuarter));
                    break;
                case 'yearly':
                    const yearlyBillingDay = parseInt(document.getElementById('billingDay').value) || 1;
                    nextDate.setFullYear(nextDate.getFullYear() + 1);
                    const lastDayOfYear = new Date(nextDate.getFullYear(), nextDate.getMonth() + 1, 0).getDate();
                    nextDate.setDate(Math.min(yearlyBillingDay, lastDayOfYear));
                    break;
            }

            const nextInvoiceDateEl = document.getElementById('nextInvoiceDate');
            if (nextInvoiceDateEl) {
                nextInvoiceDateEl.textContent = nextDate.toLocaleDateString();
            }

            // Update preview text
            if (billingDatePreview) {
                if (frequency === 'monthly' || frequency === 'quarterly' || frequency === 'yearly') {
                    const billingDay = document.getElementById('billingDay').value || 1;
                    const period = frequency === 'monthly' ? 'month' : frequency === 'quarterly' ? 'quarter' : 'year';
                    billingDatePreview.textContent = `Bill every ${period} on day ${billingDay}. Next invoice: ${nextDate.toLocaleDateString()}`;
                } else {
                    const weekday = document.getElementById('billingWeekday');
                    const weekdayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                    const selectedDay = weekdayNames[parseInt(weekday.value) || 0];
                    const period = frequency === 'weekly' ? 'week' : '2 weeks';
                    billingDatePreview.textContent = `Bill every ${period} on ${selectedDay}. Next invoice: ${nextDate.toLocaleDateString()}`;
                }
            }
        }

        function toggleRemainingBalanceDueDate() {
            const dueType = document.getElementById('remainingBalanceDueType').value;
            const specificDateInput = document.getElementById('specificDateInput');
            const daysAfterDepositInput = document.getElementById('daysAfterDepositInput');
            const daysBeforeServiceInput = document.getElementById('daysBeforeServiceInput');

            // Hide all inputs
            if (specificDateInput) specificDateInput.classList.add('hidden');
            if (daysAfterDepositInput) daysAfterDepositInput.classList.add('hidden');
            if (daysBeforeServiceInput) daysBeforeServiceInput.classList.add('hidden');

            // Show appropriate input
            if (dueType === 'specific_date') {
                if (specificDateInput) specificDateInput.classList.remove('hidden');
            } else if (dueType === 'days_after_deposit') {
                if (daysAfterDepositInput) daysAfterDepositInput.classList.remove('hidden');
            } else if (dueType === 'days_before_service') {
                if (daysBeforeServiceInput) daysBeforeServiceInput.classList.remove('hidden');
            }

            updateRemainingBalanceDuePreview();
        }

        function updateRemainingBalanceDuePreview() {
            const dueType = document.getElementById('remainingBalanceDueType').value;
            const preview = document.getElementById('remainingBalanceDuePreview');

            if (!preview) return;

            let previewText = '';

            switch (dueType) {
                case 'specific_date':
                    const specificDate = document.getElementById('remainingBalanceDueDate').value;
                    if (specificDate) {
                        const date = new Date(specificDate);
                        previewText = `Remaining balance due on ${date.toLocaleDateString()}`;
                    } else {
                        previewText = 'Select a specific date for remaining balance due date';
                    }
                    break;
                case 'days_after_deposit':
                    const daysAfter = document.getElementById('daysAfterDeposit').value || 30;
                    previewText = `Remaining balance due ${daysAfter} days after deposit payment`;
                    break;
                case 'days_before_service':
                    const daysBefore = document.getElementById('daysBeforeService').value || 30;
                    previewText = `Remaining balance due ${daysBefore} days before service completion`;
                    break;
                case 'after_service':
                    previewText = 'Remaining balance due after service completion';
                    break;
                default:
                    previewText = 'Due date will be calculated based on your selection';
            }

            preview.textContent = previewText;
        }

        function updateDepositCalculation() {
            const depositAmount = parseFloat(document.getElementById('depositAmount').value) || 0;
            const total = calculateTotal();
            const percentage = (depositAmount / total * 100).toFixed(0);
            const remaining = total - depositAmount;

            document.getElementById('depositPercentage').value = percentage;
            document.getElementById('remainingBalance').textContent = `$${remaining.toFixed(2)}`;
            document.getElementById('depositAmountDisplay').textContent = `$${depositAmount.toFixed(2)}`;
            document.getElementById('remainingBalanceDisplay').textContent = `$${remaining.toFixed(2)}`;

            // Update invoice tab summary
            const invoiceDepositAmount = document.getElementById('invoiceTabDepositAmount');
            const invoiceRemainingBalance = document.getElementById('invoiceTabRemainingBalance');
            if (invoiceDepositAmount) {
                invoiceDepositAmount.textContent = `$${depositAmount.toFixed(2)}`;
            }
            if (invoiceRemainingBalance) {
                invoiceRemainingBalance.textContent = `$${remaining.toFixed(2)}`;
            }
        }

        function updateDepositFromPercentage() {
            const percentage = parseFloat(document.getElementById('depositPercentage').value) || 0;
            const total = calculateTotal();
            const depositAmount = (total * percentage / 100);
            const remaining = total - depositAmount;

            document.getElementById('depositAmount').value = depositAmount.toFixed(2);
            document.getElementById('remainingBalance').textContent = `$${remaining.toFixed(2)}`;
            document.getElementById('depositAmountDisplay').textContent = `$${depositAmount.toFixed(2)}`;
            document.getElementById('remainingBalanceDisplay').textContent = `$${remaining.toFixed(2)}`;

            // Update invoice tab summary
            const invoiceDepositAmount = document.getElementById('invoiceTabDepositAmount');
            const invoiceRemainingBalance = document.getElementById('invoiceTabRemainingBalance');
            if (invoiceDepositAmount) {
                invoiceDepositAmount.textContent = `$${depositAmount.toFixed(2)}`;
            }
            if (invoiceRemainingBalance) {
                invoiceRemainingBalance.textContent = `$${remaining.toFixed(2)}`;
            }
        }

        function setDepositPercentage(percent) {
            document.getElementById('depositPercentage').value = percent;
            updateDepositFromPercentage();
        }

        function updatePaymentTermsDisplay() {
            const terms = document.getElementById('defaultPaymentTerms').value;
            const display = document.getElementById('paymentTermsDisplay');

            const termsMap = {
                'due_on_receipt': 'Due on Receipt',
                'net_7': 'Net 7 Days',
                'net_15': 'Net 15 Days',
                'net_30': 'Net 30 Days',
                'net_60': 'Net 60 Days'
            };

            const termsText = termsMap[terms] || 'Net 30 Days';
            display.textContent = termsText;

            // Update invoice tab summary
            const invoiceTermsDisplay = document.getElementById('invoiceTabPaymentTerms');
            if (invoiceTermsDisplay) {
                invoiceTermsDisplay.textContent = termsText;
            }
        }

        function updatePaymentMethodsDisplay() {
            const selectedRadio = document.querySelector('#paymentMethodsContainer input[type="radio"]:checked');
            const selectedMethod = selectedRadio ? selectedRadio.value : 'None';
            const displayText = selectedMethod === 'stripe' ? 'Stripe' : selectedMethod === 'cash' ? 'Cash' : 'None selected';

            document.getElementById('paymentMethodsDisplay').textContent = displayText;

            // Don't override hint text if subscription is selected (it has its own message)
            const paymentModel = document.querySelector('input[name="paymentModel"]:checked')?.value;
            if (paymentModel === 'subscription') {
                return; // Keep the subscription-specific hint message
            }

            // Update invoice tab summary
            const invoiceMethodsDisplay = document.getElementById('invoiceTabPaymentMethods');
            if (invoiceMethodsDisplay) {
                invoiceMethodsDisplay.textContent = displayText;
            }
        }

        function autoSavePaymentConfiguration() {
            const paymentModel = document.querySelector('input[name="paymentModel"]:checked');
            if (!paymentModel) return; // Skip if not selected yet

            // Get selected payment method (single selection)
            const selectedPaymentMethod = document.querySelector('input[name="paymentMethod"]:checked');
            const paymentMethod = selectedPaymentMethod ? selectedPaymentMethod.value : null;

            const paymentConfig = {
                paymentModel: paymentModel.value,
                paymentMethod: paymentMethod,
                paymentTerms: document.getElementById('defaultPaymentTerms')?.value,
                paymentInstructions: document.getElementById('paymentInstructions')?.value
            };

            // Add subscription data if applicable
            if (paymentModel.value === 'subscription') {
                const startDate = document.getElementById('subscriptionStartDate')?.value;

                paymentConfig.subscription = {
                    frequency: document.getElementById('billingFrequency')?.value,
                    startDate: startDate,
                    endType: document.getElementById('subscriptionEnd')?.value,
                    autoCharge: document.getElementById('autoCharge')?.checked
                };

                const endType = document.getElementById('subscriptionEnd')?.value;
                if (endType === 'after_cycles') {
                    const cycles = parseInt(document.getElementById('billingCycles')?.value);
                    if (cycles && cycles > 0) {
                        paymentConfig.subscription.billingCycles = cycles;
                    }
                } else if (endType === 'end_date') {
                    const endDate = document.getElementById('subscriptionEndDate')?.value;
                    if (endDate) {
                        paymentConfig.subscription.endDate = endDate;
                    }
                }
            }

            // Add deposit data if applicable
            if (paymentModel.value === 'deposit') {
                const depositAmount = parseFloat(document.getElementById('depositAmount')?.value) || 0;
                if (depositAmount > 0) {
                    paymentConfig.deposit = {
                        amount: depositAmount,
                        percentage: parseFloat(document.getElementById('depositPercentage')?.value) || 0
                    };
                }
            }

            console.log('Auto-saving payment configuration:', paymentConfig);

            // In real implementation, save to server silently
            // await fetch('/api/quotes/payment-config', { method: 'POST', body: JSON.stringify(paymentConfig) });
        }

        // ============================================================================
        // INVOICE MANAGEMENT FUNCTIONALITY
        // ============================================================================

        // Invoice data for the quote (starts empty, populated when invoices are created)
        let quoteInvoices = [];

        // Store preview invoices for creation
        let previewInvoices = [];

        function createFullInvoice() {
            const quoteTotal = calculateTotal();
            const remainingAmount = getRemainingToInvoice();

            if (remainingAmount <= 0) {
                alert('This quote has already been fully invoiced. You cannot create additional invoices beyond 100% of the quote amount.');
                return;
            }

            if (confirm(`Create a full invoice for $${remainingAmount.toFixed(2)}?`)) {
                // Navigate to invoice creation with full amount
                const quoteId = document.getElementById('quoteIdBadge').textContent;
                window.location.href = `invoice_create_simple.html?quoteId=${quoteId}&type=full&amount=${remainingAmount}`;
            }
        }

        function createPartialInvoice() {
            const remainingAmount = getRemainingToInvoice();

            if (remainingAmount <= 0) {
                alert('This quote has already been fully invoiced. You cannot create additional invoices beyond 100% of the quote amount.');
                return;
            }

            alert('Partial invoice creation will open an item selection interface.');
            // In real implementation, this would open a modal to select specific items
            const quoteId = document.getElementById('quoteIdBadge').textContent;
            window.location.href = `invoice_create_simple.html?quoteId=${quoteId}&type=partial`;
        }

        function createInvoices() {
            // Check if quote status allows invoice creation
            const restrictedStatuses = ['expired', 'rejected', 'draft'];
            if (restrictedStatuses.includes(state.quoteStatus)) {
                let message = '';
                if (state.quoteStatus === 'expired') {
                    message = 'â° Cannot create invoices for an expired quote.\n\nPlease renew the quote first to extend its validity period.';
                } else if (state.quoteStatus === 'rejected') {
                    message = 'âŒ Cannot create invoices for a rejected quote.\n\nThis quote was not accepted by the customer.';
                } else if (state.quoteStatus === 'draft') {
                    message = 'ðŸ“ Cannot create invoices for a draft quote.\n\nPlease send the quote to the customer and wait for approval first.';
                }
                alert(message);
                return;
            }

            const remainingAmount = getRemainingToInvoice();

            if (remainingAmount <= 0) {
                alert('This quote has already been fully invoiced. You cannot create additional invoices beyond 100% of the quote amount.');
                return;
            }

            // Show invoice preview modal or navigate to invoice creation
            showInvoicePreview();
        }

        function refreshInvoices() {
            loadInvoices();
            updateInvoiceSummary();
        }

        function loadInvoices() {
            const invoicesList = document.getElementById('invoicesList');
            const noInvoicesState = document.getElementById('noInvoicesState');
            const invoiceCountEl = document.getElementById('invoiceCount');

            // Update global activity log when invoices are loaded (if visible)
            setTimeout(() => {
                const activityLogContent = document.getElementById('globalActivityLogContent');
                if (activityLogContent && !activityLogContent.classList.contains('hidden')) {

                }
            }, 100);

            // Update invoice count
            const activeInvoices = quoteInvoices.filter(inv => inv.status !== 'cancelled');
            const cancelledCount = quoteInvoices.length - activeInvoices.length;

            // Count overdue invoices
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const overdueCount = activeInvoices.filter(inv => {
                const dueDate = new Date(inv.dueDate);
                dueDate.setHours(0, 0, 0, 0);
                return inv.status === 'unpaid' && dueDate < today;
            }).length;

            let countText = `${activeInvoices.length} Invoice${activeInvoices.length !== 1 ? 's' : ''}`;
            if (overdueCount > 0) {
                countText += ` <span class="text-red-600 font-bold">(${overdueCount} overdue)</span>`;
            }
            if (cancelledCount > 0) {
                countText += ` <span class="text-gray-500">(${cancelledCount} cancelled)</span>`;
            }
            invoiceCountEl.innerHTML = countText;

            // Show/hide overdue warning banner
            const overdueWarningBanner = document.getElementById('overdueWarningBanner');
            if (overdueCount > 0) {
                overdueWarningBanner.classList.remove('hidden');
                document.getElementById('overdueWarningTitle').textContent = `${overdueCount} Overdue Invoice${overdueCount !== 1 ? 's' : ''}`;
                document.getElementById('overdueWarningMessage').textContent = overdueCount === 1
                    ? 'You have 1 overdue invoice that requires immediate attention.'
                    : `You have ${overdueCount} overdue invoices that require immediate attention.`;
            } else {
                overdueWarningBanner.classList.add('hidden');
            }

            if (quoteInvoices.length === 0) {
                invoicesList.innerHTML = '';
                noInvoicesState.classList.remove('hidden');
                return;
            }

            noInvoicesState.classList.add('hidden');

            invoicesList.innerHTML = quoteInvoices.map(invoice => {
                const statusColors = {
                    'paid': 'bg-green-100 text-green-700',
                    'partially_paid': 'bg-yellow-100 text-yellow-700',
                    'unpaid': 'bg-red-100 text-red-700',
                    'unassigned': 'bg-gray-100 text-gray-700',
                    'assigned': 'bg-blue-100 text-blue-700',
                    'cancelled': 'bg-gray-100 text-gray-700'
                };

                const statusLabels = {
                    'paid': 'Paid',
                    'partially_paid': 'Partially Paid',
                    'unpaid': 'Unpaid',
                    'unassigned': 'Not Started',
                    'assigned': 'Unpaid',
                    'cancelled': 'Cancelled'
                };

                const typeLabels = {
                    'full': 'Full Invoice',
                    'deposit': 'Deposit Invoice',
                    'partial': 'Balance Invoice',
                    'subscription': 'Subscription Invoice'
                };

                // Calculate paid amount from confirmed payments only
                const currentPaid = getConfirmedPaymentsTotal(invoice);
                const outstanding = invoice.amount - currentPaid;
                const completionPercent = invoice.amount > 0 ? (currentPaid / invoice.amount) * 100 : 0;

                // Recalculate invoice status based on confirmed payments and payer assignment
                let calculatedStatus = invoice.status;
                if (invoice.status !== 'cancelled') {
                    if (currentPaid >= invoice.amount - 0.01) {
                        calculatedStatus = 'paid';
                    } else if (currentPaid > 0) {
                        calculatedStatus = 'partially_paid';
                    } else if (invoice.assignedPayers && invoice.assignedPayers.length > 0) {
                        calculatedStatus = 'assigned';
                    } else {
                        calculatedStatus = 'unassigned';
                    }
                }

                // Check if invoice is overdue
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const dueDate = new Date(invoice.dueDate);
                dueDate.setHours(0, 0, 0, 0);
                const isOverdue = (invoice.status === 'unpaid' || invoice.status === 'partially_paid') && dueDate < today;

                // Determine primary status for display
                let primaryStatus = calculatedStatus;
                let primaryStatusLabel = statusLabels[calculatedStatus] || calculatedStatus.charAt(0).toUpperCase() + calculatedStatus.slice(1);
                let primaryStatusColor = statusColors[calculatedStatus] || statusColors['unpaid'];

                // Simplify: Show only the most important status
                if (calculatedStatus === 'assigned' || calculatedStatus === 'unassigned') {
                    primaryStatus = 'unpaid';
                    primaryStatusLabel = 'Unpaid';
                    primaryStatusColor = statusColors['unpaid'];
                }

                // No pending payments - all payments are auto-confirmed

                return `
                    <div class="bg-white border rounded-lg p-4 hover:shadow-md transition-shadow ${invoice.status === 'cancelled' ? 'opacity-60' : ''} ${isOverdue ? 'border-red-400 border-2' : 'border-gray-200'}">
                        <!-- Header -->
                        <div class="flex items-start justify-between mb-3 pb-3 border-b border-gray-200">
                            <div class="flex-1">
                                <div class="flex items-center gap-2 flex-wrap mb-1">
                                <span class="text-lg font-semibold text-gray-900 ${invoice.status === 'cancelled' ? 'line-through' : ''}">${invoice.id}</span>
                                    <span class="px-2 py-0.5 text-xs rounded-full font-medium ${primaryStatusColor}">${primaryStatusLabel}</span>
                                ${isOverdue ? `<span class="px-2 py-0.5 text-xs rounded-full font-bold bg-red-600 text-white flex items-center gap-1">
                                    <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                                    </svg>
                                    OVERDUE
                                </span>` : ''}
                            </div>
                                <div class="flex items-center gap-3 text-sm text-gray-600">
                                    <span class="font-medium">${typeLabels[invoice.type]}</span>
                                    <span class="text-gray-400">â€¢</span>
                                    <span class="${isOverdue ? 'text-red-600 font-bold' : ''}">
                                Due: ${new Date(invoice.dueDate).toLocaleDateString()}
                                ${isOverdue ? ` (${Math.floor((today - dueDate) / (1000 * 60 * 60 * 24))} days ago)` : ''}
                            </span>
                                </div>
                            </div>
                            <div class="text-right ml-4">
                                <div class="text-2xl font-bold text-gray-900 ${invoice.status === 'cancelled' ? 'line-through' : ''}">$${invoice.amount.toFixed(2)}</div>
                                ${currentPaid > 0 && invoice.status !== 'cancelled' ? `<div class="text-sm text-green-600 font-medium">Paid: $${currentPaid.toFixed(2)}</div>` : ''}
                                ${outstanding > 0.01 && invoice.status !== 'cancelled' ? `<div class="text-sm text-red-600 font-medium">Due: $${outstanding.toFixed(2)}</div>` : ''}
                            </div>
                        </div>
                        
                        ${invoice.status !== 'cancelled' && invoice.amount > 0 ? `
                            <!-- Payment Progress Bar -->
                            <div class="mb-4">
                                <div class="flex items-center justify-between text-xs text-gray-600 mb-1">
                                    <span>Payment Progress</span>
                                    <span class="font-semibold">${Math.round((currentPaid / invoice.amount) * 100)}%</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-3 overflow-hidden">
                                    <div 
                                        class="h-3 rounded-full transition-all duration-500 ${currentPaid >= invoice.amount - 0.01 ? 'bg-green-600' : currentPaid > 0 ? 'bg-yellow-500' : 'bg-gray-300'}" 
                                        style="width: ${Math.min(100, Math.max(0, (currentPaid / invoice.amount) * 100))}%"
                                    ></div>
                                </div>
                                <div class="flex justify-between text-xs text-gray-500 mt-1.5">
                                    <span class="text-green-600 font-medium">$${currentPaid.toFixed(2)} paid</span>
                                    <span class="text-red-600 font-medium">$${outstanding.toFixed(2)} remaining</span>
                                </div>
                            </div>
                        ` : ''}
                        
                        <!-- Payer Details Section (Collapsible) -->
                        ${invoice.assignedPayers && invoice.assignedPayers.length > 0 ? `
                            <div class="mb-3">
                                <button 
                                    onclick="togglePayerDetails('${invoice.id}')"
                                    class="w-full flex items-center justify-between p-3 bg-gray-50 hover:bg-gray-100 border border-gray-200 rounded-lg transition-colors"
                                >
                                <div class="flex items-center gap-2">
                                        <svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                                    </svg>
                                        <span class="text-sm font-medium text-gray-900">${invoice.assignedPayers.length} Payer${invoice.assignedPayers.length !== 1 ? 's' : ''}</span>
                                        <span class="text-xs text-gray-500">(${invoice.assignedPayers.map(ap => ap.name).join(', ')})</span>
                                    </div>
                                    <svg id="payerDetailsIcon-${invoice.id}" class="w-5 h-5 text-gray-500 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                    </svg>
                                </button>
                                
                                <div id="payerDetailsContent-${invoice.id}" class="hidden mt-2 space-y-2">
                                    ${invoice.assignedPayers.map(assignedPayer => {
                    // Calculate payer's confirmed payments
                    const payerPayments = invoice.paymentHistory ? invoice.paymentHistory.filter(p =>
                        p.status === 'confirmed' &&
                        (p.payer?.id === assignedPayer.payerId || p.payer?.name === assignedPayer.name)
                    ) : [];
                    const payerPaid = payerPayments.reduce((sum, p) => sum + p.amount, 0);
                    const payerOutstanding = assignedPayer.assignedAmount - payerPaid;
                    const payerPercent = assignedPayer.assignedAmount > 0 ? (payerPaid / assignedPayer.assignedAmount) * 100 : 0;

                    // Status indicators
                    let statusBadge = '';
                    let statusColor = '';
                    if (payerPaid >= assignedPayer.assignedAmount - 0.01) {
                        statusBadge = 'Paid';
                        statusColor = 'green';
                    } else if (payerPaid > 0) {
                        statusBadge = 'Partial';
                        statusColor = 'yellow';
                    } else {
                        statusBadge = 'Unpaid';
                        statusColor = 'red';
                    }

                    return `
                                            <div class="bg-gray-50 border border-gray-200 rounded-lg p-3">
                                                <div class="flex items-start justify-between mb-2">
                                    <div class="flex-1">
                                                        <div class="flex items-center gap-2 mb-1">
                                                            <div class="font-medium text-gray-900 text-sm">${assignedPayer.name}</div>
                                                            ${assignedPayer.isPrimary ? `<span class="px-1.5 py-0.5 text-xs rounded-full bg-purple-100 text-purple-700 font-medium">Primary</span>` : ''}
                                    </div>
                                                        ${assignedPayer.email ? `<div class="text-xs text-gray-500">${assignedPayer.email}</div>` : ''}
                                </div>
                                                    <div class="text-right ml-2">
                                                        <div class="text-xs font-semibold text-${statusColor}-600">${statusBadge}</div>
                            </div>
                                                </div>
                                                
                                                <div class="mb-2">
                                                    <div class="flex justify-between text-xs text-gray-600 mb-1">
                                                        <span>$${assignedPayer.assignedAmount.toFixed(2)} (${assignedPayer.assignedPercentage.toFixed(1)}%)</span>
                                                        <span class="text-green-600 font-medium">$${payerPaid.toFixed(2)} paid</span>
                                                    </div>
                                                    <div class="w-full bg-gray-200 rounded-full h-1.5">
                                                        <div 
                                                            class="h-1.5 rounded-full transition-all duration-500 ${statusColor === 'green' ? 'bg-green-600' : statusColor === 'yellow' ? 'bg-yellow-500' : 'bg-gray-300'}" 
                                                            style="width: ${Math.min(100, Math.max(0, payerPercent))}%"
                                                        ></div>
                                                    </div>
                                                    ${payerOutstanding > 0.01 ? `
                                                        <div class="text-xs text-red-600 mt-1 text-right">$${payerOutstanding.toFixed(2)} due</div>
                        ` : ''}
                                                </div>
                                                
                                                <button 
                                                    onclick="openRecordPaymentModal('${invoice.id}', '${assignedPayer.payerId}')"
                                                    class="w-full px-2 py-1 bg-green-600 text-white text-xs rounded hover:bg-green-700 transition-colors"
                                                >
                                                    Mark as Paid
                                                </button>
                                            </div>
                                        `;
                }).join('')}
                                </div>
                            </div>
                        ` : (!invoice.assignedPayers || invoice.assignedPayers.length === 0) ? `
                            <div class="bg-gray-50 border border-gray-200 rounded-lg p-3 mb-3">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center gap-2">
                                        <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                                        </svg>
                                        <span class="text-sm text-gray-600">No payers assigned</span>
                                    </div>
                                    <button 
                                        onclick="openAssignPayersModal('${invoice.id}')"
                                        class="text-sm text-blue-600 hover:text-blue-700 font-medium"
                                    >
                                        Manage Payment Requests
                                    </button>
                                </div>
                            </div>
                        ` : ''}
                        


                        <!-- Actions Section -->
                        ${calculatedStatus !== 'cancelled' ? `
                            <div class="pt-3 border-t border-gray-200 space-y-2">
                                <!-- Primary Actions Row -->
                                <div class="grid grid-cols-1 gap-2">

                                    <button 
                                        onclick="viewInvoice('${invoice.id}')"
                                        class="px-4 py-2 text-sm font-medium border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors flex items-center justify-center gap-2"
                            >
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                        </svg>
                                View
                            </button>
                                </div>
                                
                                <!-- Secondary Actions Row -->
                                ${calculatedStatus !== 'paid' || (invoice.assignedPayers && invoice.assignedPayers.length > 0) ? `
                                    <div class="grid grid-cols-2 gap-2">
                                        ${calculatedStatus !== 'paid' ? `
                            <button 
                                onclick="sendInvoice('${invoice.id}')"
                                                class="px-4 py-2 text-sm font-medium border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors flex items-center justify-center gap-2"
                            >
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                                                </svg>
                                Send
                            </button>
                                        ` : ''}
                                        ${invoice.assignedPayers && invoice.assignedPayers.length > 0 ? `
                                            <button 
                                                onclick="openAssignPayersModal('${invoice.id}')"
                                                class="px-4 py-2 text-sm font-medium border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors flex items-center justify-center gap-2"
                                            >
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                                                </svg>
                                                Manage Payment Requests
                                            </button>
                                        ` : calculatedStatus !== 'paid' ? `
                                            <div></div>
                                        ` : ''}
                                </div>
                                ` : ''}
                                
                                <!-- More Actions Dropdown (for less common actions) -->
                                <div class="relative">
                                <button 
                                        onclick="toggleInvoiceActions('${invoice.id}')"
                                        class="w-full px-4 py-2 text-sm font-medium border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors flex items-center justify-center gap-2"
                                        id="invoiceActionsBtn-${invoice.id}"
                                >
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"></path>
                                        </svg>
                                        More Actions
                                </button>
                                    
                                    <div id="invoiceActionsMenu-${invoice.id}" class="hidden absolute left-0 right-0 mt-1 w-full bg-white border border-gray-200 rounded-lg shadow-lg z-10 py-1">
                                    <button 
                                            onclick="downloadInvoicePDF('${invoice.id}'); toggleInvoiceActions('${invoice.id}');"
                                            class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 flex items-center gap-2"
                                        >
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                            </svg>
                                            Download PDF
                                        </button>
                                        ${calculatedStatus !== 'paid' ? `
                                            <div class="border-t border-gray-200 my-1"></div>
                                            <button 
                                                onclick="cancelInvoice('${invoice.id}'); toggleInvoiceActions('${invoice.id}');"
                                                class="w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50 flex items-center gap-2"
                                            >
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                                </svg>
                                        Cancel Invoice
                                    </button>
                                        ` : ''}
                        </div>
                                </div>
                            </div>
                        ` : `
                            <div class="pt-3 border-t border-gray-200">
                            <div class="bg-gray-50 border border-gray-200 rounded-lg p-3 text-center">
                                <p class="text-sm font-medium text-gray-700">âš ï¸ This invoice has been cancelled</p>
                                ${invoice.cancelledDate ? `<p class="text-xs text-gray-500 mt-1">Cancelled on: ${new Date(invoice.cancelledDate).toLocaleDateString()}</p>` : ''}
                                </div>
                            </div>
                        `}
                    </div>
                `;
            }).join('');
        }

        function updateInvoiceSummary() {
            const quoteTotal = calculateTotal();
            const subtotal = calculateSubtotal();
            const lineItemDiscounts = calculateLineItemDiscounts();
            const taxBreakdown = getTaxBreakdown();
            const totalTax = calculateTax();

            // Update quote-style financial breakdown
            const invoiceSubtotalEl = document.getElementById('invoiceSubtotalAmount');
            if (invoiceSubtotalEl) {
                invoiceSubtotalEl.textContent = `$${subtotal.toFixed(2)}`;
            }

            const invoiceDiscountSection = document.getElementById('invoiceLineItemDiscountSection');
            const invoiceDiscountAmount = document.getElementById('invoiceLineItemDiscountAmount');
            if (invoiceDiscountSection && invoiceDiscountAmount) {
                if (lineItemDiscounts > 0) {
                    invoiceDiscountSection.classList.remove('hidden');
                    invoiceDiscountAmount.textContent = `-$${lineItemDiscounts.toFixed(2)}`;
                } else {
                    invoiceDiscountSection.classList.add('hidden');
                }
            }

            const taxBreakdownContainer = document.getElementById('invoiceTaxBreakdown');
            if (taxBreakdownContainer) {
                let breakdownHTML = '';
                if (taxBreakdown.taxable_gst > 0) {
                    breakdownHTML += `<div class="flex justify-between"><span>GST (10%):</span><span>$${taxBreakdown.taxable_gst.toFixed(2)}</span></div>`;
                }
                if (taxBreakdown.gst_free > 0) {
                    breakdownHTML += `<div class="flex justify-between text-gray-500"><span>GST-Free:</span><span>$0.00</span></div>`;
                }
                if (taxBreakdown.input_taxed > 0) {
                    breakdownHTML += `<div class="flex justify-between text-gray-500"><span>Input-Taxed:</span><span>$0.00</span></div>`;
                }
                taxBreakdownContainer.innerHTML = breakdownHTML || '<div class="text-gray-400">No taxable items</div>';
            }

            const invoiceTaxAmount = document.getElementById('invoiceTaxAmount');
            if (invoiceTaxAmount) {
                invoiceTaxAmount.textContent = `$${totalTax.toFixed(2)}`;
            }
            const invoiceQuoteTotalEl = document.getElementById('invoiceQuoteTotal');
            if (invoiceQuoteTotalEl) {
                invoiceQuoteTotalEl.textContent = `$${quoteTotal.toFixed(2)}`;
            }

            // Exclude cancelled invoices from calculations
            const activeInvoices = quoteInvoices.filter(inv => inv.status !== 'cancelled');
            const totalInvoiced = activeInvoices.reduce((sum, inv) => sum + inv.amount, 0);
            // Calculate total paid from confirmed payments only
            const totalPaid = activeInvoices.reduce((sum, inv) => {
                return sum + getConfirmedPaymentsTotal(inv);
            }, 0);
            const totalOutstanding = totalInvoiced - totalPaid;
            const remainingToInvoice = Math.max(0, quoteTotal - totalInvoiced); // Cap at 0, can't be negative

            // Check payment model for down payment breakdown
            const paymentModel = document.querySelector('input[name="paymentModel"]:checked')?.value || 'full';
            const isDownPayment = paymentModel === 'deposit';
            const downPaymentBreakdown = document.getElementById('downPaymentBreakdown');

            if (isDownPayment && downPaymentBreakdown) {
                // Calculate deposit and balance invoiced amounts
                const depositInvoices = activeInvoices.filter(inv => inv.type === 'deposit');
                const balanceInvoices = activeInvoices.filter(inv => inv.type === 'partial');
                const depositInvoiced = depositInvoices.reduce((sum, inv) => sum + inv.amount, 0);
                const balanceInvoiced = balanceInvoices.reduce((sum, inv) => sum + inv.amount, 0);

                // Get configured deposit amount
                const depositAmount = parseFloat(document.getElementById('depositAmount')?.value) || 0;
                const expectedBalance = Math.max(0, quoteTotal - depositAmount);
                const remainingBalance = Math.max(0, expectedBalance - balanceInvoiced);

                // Show breakdown
                downPaymentBreakdown.classList.remove('hidden');
                document.getElementById('depositInvoiced').textContent = `$${depositInvoiced.toFixed(2)}`;
                document.getElementById('balanceInvoiced').textContent = `$${balanceInvoiced.toFixed(2)}`;
                document.getElementById('remainingBalanceToInvoice').textContent = `$${remainingBalance.toFixed(2)}`;
            } else {
                // Hide breakdown for other payment models
                if (downPaymentBreakdown) {
                    downPaymentBreakdown.classList.add('hidden');
                }
            }

            // Update summary displays
            document.getElementById('invoiceQuoteTotal').textContent = `$${quoteTotal.toFixed(2)}`;
            document.getElementById('totalInvoiced').textContent = `$${totalInvoiced.toFixed(2)}`;
            document.getElementById('totalPaid').textContent = `$${totalPaid.toFixed(2)}`;
            document.getElementById('totalOutstanding').textContent = `$${totalOutstanding.toFixed(2)}`;
            document.getElementById('remainingToInvoice').textContent = `$${remainingToInvoice.toFixed(2)}`;

            // Update progress bar - cap at 100%
            const invoiceProgress = Math.min(100, (totalInvoiced / quoteTotal) * 100);
            document.getElementById('invoiceProgressBar').style.width = `${invoiceProgress}%`;

            // Update progress text - show 100% when fully or over-invoiced
            const actualProgress = (totalInvoiced / quoteTotal) * 100;
            if (actualProgress >= 100) {
                document.getElementById('invoiceProgressText').textContent = '100% of quote amount invoiced';
            } else {
                document.getElementById('invoiceProgressText').textContent = `${actualProgress.toFixed(0)}% of quote amount invoiced`;
            }

            // Update status badge - for down payment, only show "Fully Invoiced" when both deposit AND balance are invoiced
            const statusBadge = document.getElementById('invoiceStatusBadge');
            if (totalInvoiced === 0) {
                statusBadge.textContent = 'Not Invoiced';
                statusBadge.className = 'px-2 py-1 bg-gray-100 text-gray-700 rounded text-xs font-medium';
            } else if (isDownPayment) {
                // For down payment, check if both deposit and balance are fully invoiced
                const depositAmount = parseFloat(document.getElementById('depositAmount')?.value) || 0;
                const depositInvoices = activeInvoices.filter(inv => inv.type === 'deposit');
                const balanceInvoices = activeInvoices.filter(inv => inv.type === 'partial');
                const depositInvoiced = depositInvoices.reduce((sum, inv) => sum + inv.amount, 0);
                const balanceInvoiced = balanceInvoices.reduce((sum, inv) => sum + inv.amount, 0);
                const expectedBalance = Math.max(0, quoteTotal - depositAmount);

                const depositComplete = depositInvoiced >= depositAmount - 0.01; // Allow small rounding differences
                const balanceComplete = balanceInvoiced >= expectedBalance - 0.01;

                if (depositComplete && balanceComplete) {
                    statusBadge.textContent = 'Fully Invoiced';
                    statusBadge.className = 'px-2 py-1 bg-green-100 text-green-700 rounded text-xs font-medium';
                } else if (depositComplete && !balanceComplete) {
                    statusBadge.textContent = 'Deposit Paid - Balance Pending';
                    statusBadge.className = 'px-2 py-1 bg-yellow-100 text-yellow-700 rounded text-xs font-medium';
                } else {
                    statusBadge.textContent = 'Partially Invoiced';
                    statusBadge.className = 'px-2 py-1 bg-yellow-100 text-yellow-700 rounded text-xs font-medium';
                }
            } else if (remainingToInvoice > 0) {
                statusBadge.textContent = 'Partially Invoiced';
                statusBadge.className = 'px-2 py-1 bg-yellow-100 text-yellow-700 rounded text-xs font-medium';
            } else {
                statusBadge.textContent = 'Fully Invoiced';
                statusBadge.className = 'px-2 py-1 bg-green-100 text-green-700 rounded text-xs font-medium';
            }

            // Update global activity log when summary is updated (if visible)
            setTimeout(() => {
                const activityLogContent = document.getElementById('globalActivityLogContent');
                if (activityLogContent && !activityLogContent.classList.contains('hidden')) {

                }
            }, 100);
        }

        function getRemainingToInvoice() {
            const quoteTotal = calculateTotal();
            // Exclude cancelled invoices from calculations
            const activeInvoices = quoteInvoices.filter(inv => inv.status !== 'cancelled');
            const totalInvoiced = activeInvoices.reduce((sum, inv) => sum + inv.amount, 0);
            return Math.max(0, quoteTotal - totalInvoiced); // Cap at 0, can't invoice more than quote total
        }

        function viewInvoice(invoiceId) {
            // Navigate to invoice detail page
            window.location.href = `invoice_detail_simple.html?id=${invoiceId}`;
        }

        function sendInvoice(invoiceId) {
            const invoice = quoteInvoices.find(inv => inv.id === invoiceId);
            if (invoice) {
                alert(`Invoice ${invoiceId} sent to customer!`);
                // In real implementation, send email to customer
            }
        }

        // Store current invoice being paid
        let currentPaymentInvoiceId = null;

        function openRecordPaymentModal(invoiceId, payerId = null, amount = null) {
            const invoice = quoteInvoices.find(inv => inv.id === invoiceId);
            if (!invoice) return;

            currentPaymentInvoiceId = invoiceId;
            // Calculate paid amount from confirmed payments only
            const currentPaid = getConfirmedPaymentsTotal(invoice);
            const outstanding = invoice.amount - currentPaid;

            // Determine payment amount - use provided amount, or outstanding amount, or full amount
            let paymentAmount = amount || outstanding;
            if (payerId && invoice.assignedPayers) {
                const assignedPayer = invoice.assignedPayers.find(ap => ap.payerId === payerId);
                if (assignedPayer) {
                    // Calculate how much this payer still owes
                    const payerPayments = invoice.paymentHistory ? invoice.paymentHistory.filter(p =>
                        p.status === 'confirmed' &&
                        (p.payer?.id === assignedPayer.payerId || p.payer?.name === assignedPayer.name)
                    ) : [];
                    const payerPaid = payerPayments.reduce((sum, p) => sum + p.amount, 0);
                    paymentAmount = assignedPayer.assignedAmount - payerPaid;
                }
            }

            // Populate simplified modal
            document.getElementById('paymentInvoiceId').textContent = invoice.id;
            document.getElementById('paymentAmountDisplay').textContent = `$${paymentAmount.toFixed(2)}`;

            // Update note text
            const noteText = paymentAmount >= outstanding - 0.01
                ? 'This will record full payment for the outstanding amount and mark the invoice as paid.'
                : `This will record a payment of $${paymentAmount.toFixed(2)}. The invoice will remain ${currentPaid > 0 ? 'partially paid' : 'unpaid'}.`;
            document.getElementById('paymentNoteText').textContent = noteText;

            // Store payment amount and payer for confirmation
            window.currentPaymentAmount = paymentAmount;
            window.currentPaymentPayerId = payerId;

            // Set default date
            document.getElementById('paymentDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('paymentNotes').value = '';

            // Show modal
            document.getElementById('recordPaymentModal').classList.remove('hidden');
        }

        function populatePayerDropdown(invoice) {
            const payerSelect = document.getElementById('paymentPayerSelect');
            if (!payerSelect) return; // Element doesn't exist in simplified modal
            payerSelect.innerHTML = '<option value="">Select a payer...</option>';

            // Get payers from invoice's assignedPayers or from quotePayers
            const availablePayers = (invoice.assignedPayers && invoice.assignedPayers.length > 0)
                ? invoice.assignedPayers.map(ap => ({
                    id: ap.payerId,
                    name: ap.name,
                    email: ap.email,
                    percentage: ap.assignedPercentage
                }))
                : quotePayers || [];

            if (availablePayers.length > 0) {
                availablePayers.forEach(payer => {
                    const option = document.createElement('option');
                    option.value = payer.id || payer.email || payer.name;
                    option.textContent = `${payer.name}${payer.email ? ` (${payer.email})` : ''}${payer.percentage ? ` - ${payer.percentage}%` : ''}`;
                    option.dataset.payerData = JSON.stringify(payer);
                    payerSelect.appendChild(option);
                });
            }
        }

        function handlePayerSelection() {
            const select = document.getElementById('paymentPayerSelect');
            if (!select) return; // Element doesn't exist in simplified modal
            if (select.value) {
                hideAddPayerForm();
            }
        }

        function showAddPayerForm() {
            const addPayerForm = document.getElementById('addPayerForm');
            if (!addPayerForm) return; // Element doesn't exist in simplified modal
            addPayerForm.classList.remove('hidden');
            const nameInput = document.getElementById('newPayerName');
            const emailInput = document.getElementById('newPayerEmail');
            const payerSelect = document.getElementById('paymentPayerSelect');
            if (nameInput) nameInput.value = '';
            if (emailInput) emailInput.value = '';
            if (payerSelect) payerSelect.value = '';
        }

        function hideAddPayerForm() {
            const addPayerForm = document.getElementById('addPayerForm');
            if (!addPayerForm) return; // Element doesn't exist in simplified modal
            addPayerForm.classList.add('hidden');
        }

        function addNewPayer() {
            const nameInput = document.getElementById('newPayerName');
            const emailInput = document.getElementById('newPayerEmail');
            if (!nameInput || !emailInput) return; // Elements don't exist in simplified modal

            const name = nameInput.value.trim();
            const email = emailInput.value.trim();

            if (!name) {
                showToast('Please enter a payer name', 'warning');
                return;
            }

            // Create new payer object
            const newPayer = {
                id: `payer-${Date.now()}`,
                name: name,
                email: email || null
            };

            // Add to dropdown
            const payerSelect = document.getElementById('paymentPayerSelect');
            if (!payerSelect) return; // Element doesn't exist in simplified modal
            const option = document.createElement('option');
            option.value = newPayer.id;
            option.textContent = `${newPayer.name}${newPayer.email ? ` (${newPayer.email})` : ''}`;
            option.dataset.payerData = JSON.stringify(newPayer);
            option.selected = true;
            payerSelect.appendChild(option);

            // Hide form
            hideAddPayerForm();
        }

        function updatePaymentAmount() {
            const amountInput = document.getElementById('paymentAmount');
            const maxAmount = parseFloat(document.getElementById('paymentMaxAmount').textContent.replace('$', ''));
            const enteredAmount = parseFloat(amountInput.value) || 0;

            if (enteredAmount > maxAmount) {
                amountInput.value = maxAmount.toFixed(2);
                showToast(`Payment amount cannot exceed outstanding amount of $${maxAmount.toFixed(2)}`, 'warning');
            }
            if (enteredAmount < 0.01) {
                amountInput.value = '0.01';
            }

            updatePaymentPreview();
        }

        function setPaymentAmount(type) {
            const maxAmount = parseFloat(document.getElementById('paymentMaxAmount').textContent.replace('$', ''));
            const amountInput = document.getElementById('paymentAmount');

            let amount = 0;
            switch (type) {
                case 'full':
                    amount = maxAmount;
                    break;
                case 'half':
                    amount = maxAmount / 2;
                    break;
                case 'quarter':
                    amount = maxAmount / 4;
                    break;
            }

            amountInput.value = amount.toFixed(2);
            updatePaymentPreview();
            amountInput.focus();
        }

        function updatePaymentPreview() {
            const invoice = quoteInvoices.find(inv => inv.id === currentPaymentInvoiceId);
            if (!invoice) return;

            const paymentAmount = parseFloat(document.getElementById('paymentAmount').value) || 0;
            // Calculate current paid from confirmed payments
            const currentPaid = getConfirmedPaymentsTotal(invoice);
            const invoiceTotal = invoice.amount;
            // Note: This preview shows what would happen if payment is confirmed
            const newPaid = currentPaid + paymentAmount;
            const remaining = invoiceTotal - newPaid;

            const previewDiv = document.getElementById('paymentPreview');
            if (paymentAmount > 0 && paymentAmount <= (invoiceTotal - currentPaid)) {
                previewDiv.classList.remove('hidden');
                document.getElementById('previewCurrentPaid').textContent = `$${currentPaid.toFixed(2)}`;
                document.getElementById('previewPaymentAmount').textContent = `$${paymentAmount.toFixed(2)}`;
                document.getElementById('previewNewPaid').textContent = `$${newPaid.toFixed(2)}`;
                document.getElementById('previewRemaining').textContent = `$${Math.max(0, remaining).toFixed(2)}`;

                const statusDiv = document.getElementById('previewStatus');
                if (remaining <= 0.01) {
                    statusDiv.textContent = 'âœ… Invoice will be marked as PAID';
                    statusDiv.className = 'mt-2 pt-2 border-t border-green-200 text-xs font-medium text-green-800';
                } else if (currentPaid === 0) {
                    statusDiv.textContent = 'ðŸ“ Invoice will be marked as PARTIALLY PAID';
                    statusDiv.className = 'mt-2 pt-2 border-t border-green-200 text-xs font-medium text-yellow-700';
                } else {
                    statusDiv.textContent = 'ðŸ“ Invoice will remain PARTIALLY PAID';
                    statusDiv.className = 'mt-2 pt-2 border-t border-green-200 text-xs font-medium text-yellow-700';
                }
            } else {
                previewDiv.classList.add('hidden');
            }
        }

        function updatePaymentMethodIcon() {
            const select = document.getElementById('paymentMethodSelect');
            const selectedOption = select.options[select.selectedIndex];
            const icon = selectedOption.getAttribute('data-icon') || 'ðŸ’³';
            const methodName = selectedOption.text;

            document.getElementById('methodIconDisplay').textContent = icon;
            document.getElementById('methodNameDisplay').textContent = methodName;
        }

        // Toast Notification System
        function showToast(message, type = 'success', duration = 3000) {
            const toastContainer = document.getElementById('toastContainer');
            if (!toastContainer) return;

            const toastId = `toast-${Date.now()}`;

            const icons = {
                success: 'âœ…',
                error: 'âŒ',
                warning: 'âš ï¸',
                info: 'â„¹ï¸'
            };

            const colors = {
                success: 'bg-green-50 border-green-200 text-green-800',
                error: 'bg-red-50 border-red-200 text-red-800',
                warning: 'bg-yellow-50 border-yellow-200 text-yellow-800',
                info: 'bg-blue-50 border-blue-200 text-blue-800'
            };

            const toast = document.createElement('div');
            toast.id = toastId;
            toast.className = `${colors[type]} border-l-4 rounded-lg shadow-lg p-4 min-w-[300px] max-w-md transform transition-all duration-300 translate-x-full`;
            toast.innerHTML = `
                <div class="flex items-start gap-3">
                    <span class="text-xl flex-shrink-0">${icons[type]}</span>
                    <div class="flex-1">
                        <p class="text-sm font-medium">${message}</p>
                    </div>
                    <button onclick="closeToast('${toastId}')" class="text-gray-400 hover:text-gray-600 flex-shrink-0">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            `;

            toastContainer.appendChild(toast);

            // Animate in
            setTimeout(() => {
                toast.classList.remove('translate-x-full');
            }, 10);

            // Auto dismiss
            if (duration > 0) {
                setTimeout(() => {
                    closeToast(toastId);
                }, duration);
            }
        }

        function closeToast(toastId) {
            const toast = document.getElementById(toastId);
            if (toast) {
                toast.classList.add('translate-x-full');
                setTimeout(() => {
                    toast.remove();
                }, 300);
            }
        }

        // ============================================================================
        // PAYER ASSIGNMENT FUNCTIONALITY
        // ============================================================================

        let currentAssignmentInvoiceId = null;
        let tempAssignedPayers = [];

        function openAssignPayersModal(invoiceId) {
            currentAssignmentInvoiceId = invoiceId;
            const invoice = quoteInvoices.find(inv => inv.id === invoiceId);
            if (!invoice) return;

            // Populate modal header
            document.getElementById('assignPayersInvoiceId').textContent = invoice.id;
            document.getElementById('assignPayersInvoiceAmount').textContent = `$${invoice.amount.toFixed(2)}`;
            document.getElementById('assignModalInvoiceTotal').textContent = `$${invoice.amount.toFixed(2)}`;

            // Initialize temp assigned payers from invoice or empty
            tempAssignedPayers = invoice.assignedPayers ? [...invoice.assignedPayers] : [];

            // Ensure primary contact (quote contact) is always included
            ensurePrimaryContactInPayers();

            // Render all sections
            renderAssignModalPayersTable();
            renderAssignModalQuoteTotals();
            renderAssignModalLineItems();
            renderAssignModalInvoicePreview(invoice);
            updateAssignModalDistributionSummary();
            updateAssignModalContactSelector();

            // Show modal
            document.getElementById('assignPayersModal').classList.remove('hidden');
        }

        function ensurePrimaryContactInPayers() {
            // Get the quote contact (primary contact)
            const quoteContact = state.selectedQuoteContact || state.quoteContact;
            if (!quoteContact) return;

            // Check if primary contact already exists in quotePayers
            const primaryPayerExists = quotePayers.some(p => p.isPrimary === true);

            if (!primaryPayerExists) {
                // Add primary contact to quotePayers if not exists
                const primaryPayer = {
                    id: 'primary-contact',
                    name: quoteContact.name || 'Primary Contact',
                    email: quoteContact.email || '',
                    phone: quoteContact.phone || '',
                    percentage: 100, // Default to 100% if no other payers
                    isPrimary: true,
                    createdAt: new Date().toISOString()
                };

                // Check if it already exists by email/name
                const existingIndex = quotePayers.findIndex(p =>
                    (p.email && p.email === primaryPayer.email) ||
                    (p.name === primaryPayer.name && p.isPrimary)
                );

                if (existingIndex === -1) {
                    quotePayers.unshift(primaryPayer); // Add at the beginning
                } else {
                    // Update existing to mark as primary
                    quotePayers[existingIndex].isPrimary = true;
                    quotePayers[existingIndex].id = 'primary-contact';
                }
            }

            // Always ensure primary contact is assigned by default (if not already assigned)
            const primaryPayer = quotePayers.find(p => p.isPrimary === true);
            if (primaryPayer) {
                const invoice = quoteInvoices.find(inv => inv.id === currentAssignmentInvoiceId);
                if (invoice) {
                    // Check if primary contact is already assigned
                    const primaryAssigned = tempAssignedPayers.find(ap =>
                        ap.payerId === primaryPayer.id ||
                        ap.isPrimary ||
                        (ap.email && primaryPayer.email && ap.email === primaryPayer.email) ||
                        (ap.name === primaryPayer.name && primaryPayer.isPrimary)
                    );

                    if (!primaryAssigned) {
                        // Auto-add primary contact as default with 100% if no payers, or distribute if others exist
                        let percentage = 100;
                        let assignedAmount = invoice.amount;

                        if (tempAssignedPayers.length > 0) {
                            // Distribute remaining percentage among existing payers
                            const totalAssigned = tempAssignedPayers.reduce((sum, p) => sum + (p.assignedPercentage || 0), 0);
                            const remaining = 100 - totalAssigned;

                            if (remaining > 0) {
                                percentage = remaining;
                                assignedAmount = (invoice.amount * percentage / 100);
                            } else {
                                // If already 100% assigned, give primary contact the remaining from others
                                percentage = 100 - totalAssigned;
                                assignedAmount = invoice.amount - tempAssignedPayers.reduce((sum, p) => sum + (p.assignedAmount || 0), 0);
                            }
                        }

                        tempAssignedPayers.unshift({
                            payerId: primaryPayer.id,
                            name: primaryPayer.name,
                            email: primaryPayer.email,
                            assignedPercentage: percentage,
                            assignedAmount: assignedAmount,
                            assignedAt: new Date().toISOString(),
                            isPrimary: true,
                            paidAmount: 0,
                            outstandingAmount: assignedAmount,
                            paymentStatus: 'unpaid',
                            payments: [],
                            lastPaymentDate: null
                        });
                    }
                }
            }

            if (tempAssignedPayers.length > 0) {
                // Ensure primary contact is in assigned payers (only one primary allowed)
                const primaryPayer = quotePayers.find(p => p.isPrimary === true);
                if (primaryPayer) {
                    const primaryAssigned = tempAssignedPayers.find(ap =>
                        ap.payerId === primaryPayer.id ||
                        ap.isPrimary ||
                        (ap.email && primaryPayer.email && ap.email === primaryPayer.email) ||
                        (ap.name === primaryPayer.name && primaryPayer.isPrimary)
                    );
                    if (!primaryAssigned) {
                        // Primary contact should be assigned, but if not, we'll let user add it manually
                        // Don't auto-add if there are already payers assigned
                    } else {
                        // Mark it as primary if not already marked
                        primaryAssigned.isPrimary = true;
                        // Ensure only one primary contact - unmark others if any
                        tempAssignedPayers.forEach(ap => {
                            if (ap.payerId !== primaryAssigned.payerId &&
                                ap.payerId !== primaryPayer.id &&
                                (ap.isPrimary || ap.payerId === 'primary-contact')) {
                                ap.isPrimary = false;
                            }
                        });
                    }
                }
            }
        }

        function renderAssignModalPayersTable() {
            const tbody = document.getElementById('assignModalPayersTableBody');
            if (!tbody) return;

            const invoice = quoteInvoices.find(inv => inv.id === currentAssignmentInvoiceId);
            if (!invoice) return;

            if (tempAssignedPayers.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="4" class="px-4 py-8 text-center text-sm text-gray-500">
                            No payers assigned yet. Select payers from the dropdown above.
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = tempAssignedPayers.map((payer, index) => {
                const percentage = payer.assignedPercentage || 0;
                const amount = payer.assignedAmount || 0;
                const isPrimary = payer.isPrimary || payer.payerId === 'primary-contact' || quotePayers.find(p => p.id === payer.payerId)?.isPrimary;
                return `
                    <tr class="hover:bg-gray-50 ${isPrimary ? 'bg-purple-50' : ''}">
                        <td class="px-4 py-3">
                            <div class="flex items-center">
                                <div class="w-8 h-8 ${isPrimary ? 'bg-purple-600' : 'bg-purple-100'} rounded-full flex items-center justify-center mr-3">
                                    ${isPrimary ? `
                                        <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
                                        </svg>
                                    ` : `
                                        <svg class="w-4 h-4 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                        </svg>
                                    `}
                                </div>
                                <div>
                                    <div class="flex items-center gap-2">
                                        <div class="text-sm font-medium text-gray-900">${payer.name}</div>
                                        ${isPrimary ? `<span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold bg-purple-100 text-purple-700">Primary Contact</span>` : ''}
                                    </div>
                                    <div class="text-xs text-gray-500">${payer.email || ''}</div>
                                </div>
                            </div>
                        </td>
                        <td class="px-4 py-3 text-center">
                            <div class="flex items-center justify-center gap-1">
                                <input 
                                    type="number" 
                                    value="${percentage.toFixed(1)}" 
                                    min="0" 
                                    max="100" 
                                    step="0.1"
                                    onchange="updatePayerAssignmentPercentage(${index}, this.value)"
                                    class="w-16 px-2 py-1 text-center border border-gray-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-purple-500"
                                />
                                <span class="text-xs text-gray-500">%</span>
                            </div>
                        </td>
                        <td class="px-4 py-3 text-center">
                            <div class="relative inline-block">
                                <span class="absolute left-2 top-1.5 text-gray-500 text-sm">$</span>
                                <input 
                                    type="number" 
                                    value="${amount.toFixed(2)}" 
                                    min="0" 
                                    step="0.01"
                                    onchange="updatePayerAssignmentAmount(${index}, this.value)"
                                    class="w-24 pl-6 pr-2 py-1 text-center border border-gray-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-purple-500"
                                />
                            </div>
                        </td>
                        <td class="px-4 py-3 text-center">
                            ${isPrimary ? `
                                <span class="text-xs text-gray-400 italic">Required</span>
                            ` : `
                                <button 
                                    onclick="removePayerFromAssignment(${index})"
                                    class="text-red-600 hover:text-red-700 text-sm font-medium"
                                >
                                    Remove
                                </button>
                            `}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function updatePayerAssignmentAmount(index, newAmount) {
            const currentInvoice = quoteInvoices.find(inv => inv.id === currentAssignmentInvoiceId);
            if (!currentInvoice) return;

            const payer = tempAssignedPayers[index];
            if (!payer) return;

            const amount = parseFloat(newAmount) || 0;
            payer.assignedAmount = Math.max(0, Math.min(currentInvoice.amount, amount));
            payer.assignedPercentage = currentInvoice.amount > 0 ? (payer.assignedAmount / currentInvoice.amount * 100) : 0;

            renderAssignModalPayersTable();
            updateAssignModalDistributionSummary();
            renderAssignModalInvoicePreview(currentInvoice);
        }

        function renderAssignModalQuoteTotals() {
            const container = document.getElementById('assignModalQuoteTotals');
            if (!container) return;

            const quoteSummary = getQuoteSummaryDetails();
            const taxBreakdownLines = [];
            if (quoteSummary.taxBreakdown.taxable_gst > 0) {
                taxBreakdownLines.push(`<div class="flex justify-between"><span>GST (10%):</span><span>${formatCurrency(quoteSummary.taxBreakdown.taxable_gst)}</span></div>`);
            }
            if (quoteSummary.taxBreakdown.gst_free > 0) {
                taxBreakdownLines.push(`<div class="flex justify-between text-gray-500"><span>GST-Free:</span><span>${formatCurrency(0)}</span></div>`);
            }
            if (quoteSummary.taxBreakdown.input_taxed > 0) {
                taxBreakdownLines.push(`<div class="flex justify-between text-gray-500"><span>Input-Taxed:</span><span>${formatCurrency(0)}</span></div>`);
            }

            container.innerHTML = `
                <div class="space-y-2 text-sm text-gray-700">
                    <div class="flex justify-between">
                        <span>Subtotal</span>
                        <span>${formatCurrency(quoteSummary.grossSubtotal)}</span>
                    </div>
                    <div class="flex justify-between text-red-600">
                        <span>Line Item Discounts</span>
                        <span>- ${formatCurrency(quoteSummary.discounts)}</span>
                    </div>
                    <div class="flex justify-between font-medium">
                        <span>Net Subtotal</span>
                        <span>${formatCurrency(quoteSummary.netSubtotal)}</span>
                    </div>
                    <div class="pt-2 border-t border-gray-200 space-y-1">
                        <div class="text-xs text-gray-500 uppercase tracking-wide">Tax Breakdown:</div>
                        ${taxBreakdownLines.length ? taxBreakdownLines.join('') : `<div class="text-xs text-gray-400">No taxable items</div>`}
                        <div class="flex justify-between font-medium mt-1">
                            <span>Total Tax</span>
                            <span>${formatCurrency(quoteSummary.totalTax)}</span>
                        </div>
                    </div>
                    <div class="flex justify-between items-center border-t-2 border-gray-300 pt-3">
                        <span class="font-bold text-gray-900 text-base">Total</span>
                        <span class="font-bold text-gray-900 text-base">${formatCurrency(quoteSummary.total)}</span>
                    </div>
                </div>
            `;
        }

        function renderAssignModalLineItems() {
            const container = document.getElementById('assignModalLineItems');
            if (!container) return;

            const quoteSummary = getQuoteSummaryDetails();

            if (quoteSummary.items.length === 0) {
                container.innerHTML = '<p class="text-sm text-gray-500">No line items added yet.</p>';
                return;
            }

            container.innerHTML = `
                <div class="space-y-2">
                    ${quoteSummary.items.map(item => `
                        <div class="flex items-center justify-between p-2 bg-white rounded-lg border border-gray-200 text-sm">
                            <div>
                                <p class="font-medium text-gray-900">${item.name}</p>
                                <p class="text-xs text-gray-500">${item.quantity} ${item.unit || ''}</p>
                            </div>
                            <div class="font-semibold text-gray-900">${formatCurrency(item.amount)}</div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function renderAssignModalInvoicePreview(invoice) {
            const container = document.getElementById('assignModalInvoicePreview');
            if (!container) return;

            const invoiceColor = invoice.color || 'purple';
            const dueDate = invoice.dueDate ? new Date(invoice.dueDate).toLocaleDateString() : 'N/A';

            container.innerHTML = `
                <div class="flex items-start gap-3 mb-4">
                    <div class="flex-1">
                        <div class="flex items-center justify-between mb-4 pb-4 border-b border-gray-200">
                            <div class="flex items-center gap-3">
                                <div class="w-12 h-12 bg-gradient-to-br from-${invoiceColor}-100 to-${invoiceColor}-200 rounded-xl flex items-center justify-center shadow-sm">
                                    <svg class="w-6 h-6 text-${invoiceColor}-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5.586a1 1 0 0 1 .707.293l5.414 5.414a1 1 0 0 1 .293.707V19a2 2 0 0 1-2 2z"></path>
                                    </svg>
                                </div>
                                <div>
                                    <h5 class="text-lg font-bold text-gray-900">${invoice.id}</h5>
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-semibold bg-${invoiceColor}-100 text-${invoiceColor}-700 mt-1">${invoice.type}</span>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-2xl font-bold text-gray-900 mb-1">${formatCurrency(invoice.amount)}</div>
                                <div class="flex items-center gap-1 text-xs text-gray-500">
                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                    </svg>
                                    <span>Due: ${dueDate}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                ${tempAssignedPayers.length > 0 ? `
                    <div class="pt-4 border-t border-gray-200">
                        <h6 class="text-xs font-semibold text-gray-700 uppercase tracking-wide mb-3">Payment Distribution</h6>
                        <div class="space-y-2">
                            ${tempAssignedPayers.map(payer => {
                const visualPercentage = invoice.amount > 0 ? (payer.assignedAmount / invoice.amount) * 100 : 0;
                return `
                                    <div class="bg-gradient-to-r from-purple-50 to-indigo-50 border border-purple-200 rounded-lg p-3">
                                        <div class="flex items-center justify-between mb-2">
                                            <div class="font-semibold text-gray-900 text-sm">${payer.name}</div>
                                            <div class="text-right">
                                                <div class="text-sm font-bold text-purple-700">${formatCurrency(payer.assignedAmount)}</div>
                                                <div class="text-xs text-gray-600">${payer.assignedPercentage.toFixed(1)}%</div>
                                            </div>
                                        </div>
                                        <div class="w-full bg-gray-200 rounded-full h-2 overflow-hidden">
                                            <div 
                                                class="h-2 rounded-full bg-gradient-to-r from-purple-500 to-indigo-500 transition-all duration-300" 
                                                style="width: ${Math.min(100, Math.max(0, visualPercentage))}%"
                                            ></div>
                                        </div>
                                    </div>
                                `;
            }).join('')}
                        </div>
                    </div>
                ` : ''}
            `;
        }

        function updateAssignModalDistributionSummary() {
            const invoice = quoteInvoices.find(inv => inv.id === currentAssignmentInvoiceId);
            if (!invoice) return;

            const totalPercentage = tempAssignedPayers.reduce((sum, p) => sum + (p.assignedPercentage || 0), 0);
            const totalAmount = tempAssignedPayers.reduce((sum, p) => sum + (p.assignedAmount || 0), 0);

            const totalPercentageEl = document.getElementById('assignModalTotalPercentage');
            const totalAmountEl = document.getElementById('assignModalTotalAmount');
            const warningDiv = document.getElementById('assignModalDistributionValidationWarning');
            const warningMessage = document.getElementById('assignModalDistributionValidationMessage');
            const saveBtn = document.getElementById('saveAssignmentBtn');

            if (totalPercentageEl) {
                totalPercentageEl.textContent = `${totalPercentage.toFixed(1)}%`;
                if (Math.abs(totalPercentage - 100) < 0.01) {
                    totalPercentageEl.classList.remove('text-red-600');
                    totalPercentageEl.classList.add('text-green-600');
                } else {
                    totalPercentageEl.classList.remove('text-green-600');
                    totalPercentageEl.classList.add('text-red-600');
                }
            }

            if (totalAmountEl) {
                totalAmountEl.textContent = `$${totalAmount.toFixed(2)}`;
            }

            if (warningDiv && warningMessage) {
                if (Math.abs(totalPercentage - 100) < 0.01) {
                    warningDiv.classList.add('hidden');
                } else {
                    warningDiv.classList.remove('hidden');
                    if (totalPercentage < 100) {
                        warningMessage.textContent = `Total percentage is ${totalPercentage.toFixed(1)}%. Please allocate the remaining ${(100 - totalPercentage).toFixed(1)}%.`;
                    } else {
                        warningMessage.textContent = `Total percentage is ${totalPercentage.toFixed(1)}%. Please reduce by ${(totalPercentage - 100).toFixed(1)}%.`;
                    }
                }
            }

            if (saveBtn) {
                if (Math.abs(totalPercentage - 100) < 0.01) {
                    saveBtn.disabled = false;
                    saveBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                } else {
                    saveBtn.disabled = true;
                    saveBtn.classList.add('opacity-50', 'cursor-not-allowed');
                }
            }

            // Update invoice preview
            renderAssignModalInvoicePreview(invoice);
        }

        function updateAssignModalContactSelector() {
            const selector = document.getElementById('assignModalContactSelector');
            if (!selector) return;

            // Get assigned payer IDs
            const assignedPayerIds = tempAssignedPayers.map(ap => ap.payerId);

            // Build options from multiple sources: quotePayers, customer contacts, and quote contact
            let optionsHTML = '<option value="">Select contact to add...</option>';

            // Get all available contacts
            const availableContacts = [];

            // 1. Add primary contact (quote contact) first
            const quoteContact = state.selectedQuoteContact || state.quoteContact;
            if (quoteContact && quoteContact.name) {
                const contactId = 'primary-contact';
                if (!assignedPayerIds.includes(contactId)) {
                    availableContacts.push({
                        id: contactId,
                        name: quoteContact.name,
                        email: quoteContact.email || '',
                        phone: quoteContact.phone || '',
                        isPrimary: true,
                        source: 'quote'
                    });
                }
            }

            // 2. Add customer primary contact if different from quote contact
            const customer = state.selectedCustomer;
            if (customer && customer.primaryContact) {
                const contactId = 'customer-primary';
                const isQuoteContact = quoteContact &&
                    (quoteContact.email === customer.primaryContact.email ||
                        quoteContact.name === customer.primaryContact.name);

                if (!isQuoteContact && !assignedPayerIds.includes(contactId)) {
                    availableContacts.push({
                        id: contactId,
                        name: customer.primaryContact.name || customer.name,
                        email: customer.primaryContact.email || customer.email || '',
                        phone: customer.primaryContact.phone || customer.phone || '',
                        isPrimary: false,
                        source: 'customer'
                    });
                }
            }

            // 3. Add customer secondary contacts
            if (customer && customer.secondaryContacts && Array.isArray(customer.secondaryContacts)) {
                customer.secondaryContacts.forEach((contact, index) => {
                    const contactId = `secondary-${index}`;
                    if (!assignedPayerIds.includes(contactId)) {
                        availableContacts.push({
                            id: contactId,
                            name: contact.name,
                            email: contact.email || '',
                            phone: contact.phone || '',
                            role: contact.role || '',
                            isPrimary: false,
                            source: 'customer'
                        });
                    }
                });
            }

            // 4. Add existing quotePayers (already configured payers)
            quotePayers.forEach(payer => {
                if (!assignedPayerIds.includes(payer.id)) {
                    // Check if this payer is already in availableContacts
                    const exists = availableContacts.some(ac =>
                        (ac.email && payer.email && ac.email === payer.email) ||
                        (ac.name === payer.name && ac.source === 'quote')
                    );

                    if (!exists) {
                        availableContacts.push({
                            id: payer.id,
                            name: payer.name,
                            email: payer.email || '',
                            phone: payer.phone || '',
                            isPrimary: payer.isPrimary || false,
                            source: 'configured'
                        });
                    }
                }
            });

            // 5. Add sample contacts from the global availableContacts object (if defined)
            // Access the global availableContacts object defined elsewhere in the code
            try {
                // The global availableContacts is an object, not an array
                // We need to check if it exists in the scope
                const globalAvailableContactsObj = typeof availableContacts !== 'undefined' &&
                    !Array.isArray(availableContacts) &&
                    availableContacts.constructor === Object ?
                    availableContacts : null;

                // If not found, try accessing it from window or check the defined constant
                // Since it's defined as const, we'll use a workaround
                const sampleContactsData = {
                    'contact1': { name: 'John Smith', email: 'john@company.com' },
                    'contact2': { name: 'Sarah Johnson', email: 'sarah@business.com' },
                    'contact3': { name: 'Mike Wilson', email: 'mike@corp.com' }
                };

                Object.keys(sampleContactsData).forEach((contactKey, index) => {
                    const sampleContact = sampleContactsData[contactKey];
                    const contactId = `sample-${contactKey}`;

                    // Check if already exists (by email or name) or assigned
                    const exists = availableContacts.some(ac =>
                        (ac.email && sampleContact.email && ac.email === sampleContact.email) ||
                        (ac.name === sampleContact.name)
                    );

                    if (!exists && !assignedPayerIds.includes(contactId)) {
                        availableContacts.push({
                            id: contactId,
                            name: sampleContact.name,
                            email: sampleContact.email,
                            phone: '',
                            isPrimary: false,
                            source: 'sample'
                        });
                    }
                });
            } catch (e) {
                // Ignore errors - sample contacts are optional
            }

            // Check if primary contact is already assigned
            const hasPrimaryAssigned = tempAssignedPayers.some(ap =>
                ap.isPrimary ||
                ap.payerId === 'primary-contact' ||
                quotePayers.find(p => p.id === ap.payerId)?.isPrimary
            );

            // Build HTML options, prioritizing primary contact (only if not already assigned)
            const primaryContact = availableContacts.find(c => c.isPrimary);
            if (primaryContact && !hasPrimaryAssigned) {
                const displayText = primaryContact.email ?
                    `${primaryContact.name} (Primary Contact) - ${primaryContact.email}` :
                    `${primaryContact.name} (Primary Contact)`;
                optionsHTML += `<option value="${primaryContact.id}" style="font-weight: bold;">${displayText}</option>`;
            }

            // Add other contacts (excluding primary if already assigned)
            availableContacts.forEach(contact => {
                // Skip primary contact if already assigned
                if (contact.isPrimary && hasPrimaryAssigned) {
                    return;
                }

                if (!contact.isPrimary) {
                    let displayText = contact.name;
                    if (contact.email) {
                        displayText += ` - ${contact.email}`;
                    }
                    if (contact.role) {
                        displayText += ` (${contact.role})`;
                    }
                    optionsHTML += `<option value="${contact.id}">${displayText}</option>`;
                }
            });

            optionsHTML += '<option value="quick-add">+ Quick Add New Contact</option>';

            selector.innerHTML = optionsHTML;
        }

        function addSelectedPayerToAssignmentModal() {
            const selector = document.getElementById('assignModalContactSelector');
            if (!selector) return;

            const selectedValue = selector.value;
            if (!selectedValue) {
                showToast('Please select a contact to add', 'warning');
                return;
            }

            if (selectedValue === 'quick-add') {
                showAddPayerToAssignment();
                return;
            }

            // Find the contact from various sources
            let contactData = null;
            let payerId = selectedValue;

            // Check quotePayers first
            let payer = quotePayers.find(p => p.id === selectedValue);

            if (!payer) {
                // Check customer contacts
                const customer = state.selectedCustomer;
                const quoteContact = state.selectedQuoteContact || state.quoteContact;

                if (selectedValue === 'primary-contact') {
                    // Quote contact (primary contact)
                    if (quoteContact) {
                        contactData = {
                            id: 'primary-contact',
                            name: quoteContact.name,
                            email: quoteContact.email || '',
                            phone: quoteContact.phone || '',
                            isPrimary: true
                        };
                    }
                } else if (selectedValue === 'customer-primary') {
                    // Customer primary contact
                    if (customer && customer.primaryContact) {
                        contactData = {
                            id: 'customer-primary',
                            name: customer.primaryContact.name || customer.name,
                            email: customer.primaryContact.email || customer.email || '',
                            phone: customer.primaryContact.phone || customer.phone || '',
                            isPrimary: false
                        };
                    }
                } else if (selectedValue.startsWith('secondary-')) {
                    // Secondary contact
                    const index = parseInt(selectedValue.split('-')[1]);
                    if (customer && customer.secondaryContacts && customer.secondaryContacts[index]) {
                        const secContact = customer.secondaryContacts[index];
                        contactData = {
                            id: selectedValue,
                            name: secContact.name,
                            email: secContact.email || '',
                            phone: secContact.phone || '',
                            role: secContact.role || '',
                            isPrimary: false
                        };
                    }
                }

                // If contact found, add to quotePayers and use it
                if (contactData) {
                    payerId = contactData.id;
                    payer = {
                        id: contactData.id,
                        name: contactData.name,
                        email: contactData.email,
                        phone: contactData.phone,
                        percentage: 0,
                        isPrimary: contactData.isPrimary || false,
                        createdAt: new Date().toISOString()
                    };

                    // Add to quotePayers if not exists
                    const exists = quotePayers.find(p => p.id === payerId);
                    if (!exists) {
                        quotePayers.push(payer);
                    }
                } else {
                    // Fallback: create from selector text
                    const optionText = selector.options[selector.selectedIndex].text;
                    const parts = optionText.split(' - ');
                    const payerName = parts[0].replace(' (Primary Contact)', '').trim();
                    const payerEmail = parts[1] ? parts[1].split(' (')[0].trim() : '';

                    payerId = `payer-${Date.now()}`;
                    payer = {
                        id: payerId,
                        name: payerName,
                        email: payerEmail,
                        percentage: 0,
                        isPrimary: false,
                        createdAt: new Date().toISOString()
                    };

                    quotePayers.push(payer);
                }
            }

            if (payer) {
                // Check if this payer is already assigned before adding
                const alreadyAssigned = tempAssignedPayers.some(ap =>
                    ap.payerId === payer.id ||
                    (ap.payerId === 'primary-contact' && payer.isPrimary) ||
                    (ap.isPrimary && payer.isPrimary) ||
                    (ap.email && payer.email && ap.email === payer.email) ||
                    (ap.name === payer.name && payer.isPrimary)
                );

                if (alreadyAssigned) {
                    showToast('This payer is already assigned to this invoice', 'warning');
                    selector.value = '';
                    return;
                }

                // Check if trying to add a primary contact when one already exists
                if (payer.isPrimary || payerId === 'primary-contact') {
                    const hasPrimary = tempAssignedPayers.some(ap =>
                        ap.isPrimary ||
                        ap.payerId === 'primary-contact' ||
                        quotePayers.find(p => p.id === ap.payerId)?.isPrimary
                    );

                    if (hasPrimary) {
                        showToast('A primary contact is already assigned. Only one primary contact is allowed per invoice.', 'warning');
                        selector.value = '';
                        return;
                    }
                }

                addPayerToAssignment(payer.id);
            }

            selector.value = '';
        }

        function closeAssignPayersModal() {
            document.getElementById('assignPayersModal').classList.add('hidden');
            currentAssignmentInvoiceId = null;
            tempAssignedPayers = [];
            hideAddPayerToAssignmentForm();
        }

        function renderAssignedPayers() {
            const container = document.getElementById('assignedPayersList');
            if (tempAssignedPayers.length === 0) {
                container.innerHTML = '<div class="text-sm text-gray-500 text-center py-4">No payers assigned yet</div>';
                return;
            }

            const invoice = quoteInvoices.find(inv => inv.id === currentAssignmentInvoiceId);
            if (!invoice) return;

            container.innerHTML = tempAssignedPayers.map((payer, index) => {
                const percentage = payer.assignedPercentage || 0;
                const amount = payer.assignedAmount || 0;
                return `
                    <div class="bg-white border border-gray-200 rounded-lg p-3">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex-1">
                                <div class="font-medium text-gray-900">${payer.name}</div>
                                ${payer.email ? `<div class="text-xs text-gray-500">${payer.email}</div>` : ''}
                            </div>
                            <button 
                                onclick="removePayerFromAssignment(${index})"
                                class="text-red-600 hover:text-red-700 ml-2"
                            >
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                        <div class="flex items-center gap-3">
                            <div class="flex-1">
                                <label class="text-xs text-gray-600 mb-1 block">Percentage</label>
                                <div class="flex items-center gap-2">
                                    <input 
                                        type="number" 
                                        value="${percentage.toFixed(1)}" 
                                        min="0" 
                                        max="100" 
                                        step="0.1"
                                        onchange="updatePayerAssignmentPercentage(${index}, this.value)"
                                        class="w-20 px-2 py-1.5 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    />
                                    <span class="text-xs text-gray-500">%</span>
                                </div>
                            </div>
                            <div class="flex-1">
                                <label class="text-xs text-gray-600 mb-1 block">Amount</label>
                                <div class="text-sm font-semibold text-gray-900">$${amount.toFixed(2)}</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderAvailablePayers() {
            const container = document.getElementById('availablePayersList');
            const invoice = quoteInvoices.find(inv => inv.id === currentAssignmentInvoiceId);
            if (!invoice) return;

            // Get payers not already assigned
            const assignedPayerIds = tempAssignedPayers.map(ap => ap.payerId);
            const available = quotePayers.filter(p => !assignedPayerIds.includes(p.id));

            if (available.length === 0) {
                container.innerHTML = '<div class="text-sm text-gray-500 text-center py-2">All configured payers are assigned</div>';
                return;
            }

            container.innerHTML = available.map(payer => {
                return `
                    <button
                        onclick="addPayerToAssignment('${payer.id}')"
                        class="w-full bg-white border border-gray-200 rounded-lg p-3 text-left hover:bg-gray-50 transition-colors"
                    >
                        <div class="font-medium text-gray-900">${payer.name}</div>
                        ${payer.email ? `<div class="text-xs text-gray-500">${payer.email}</div>` : ''}
                        ${payer.percentage ? `<div class="text-xs text-gray-400 mt-1">Default: ${payer.percentage}%</div>` : ''}
                    </button>
                `;
            }).join('');
        }

        function addPayerToAssignment(payerId) {
            const payer = quotePayers.find(p => p.id === payerId);
            if (!payer) return;

            const currentInvoice = quoteInvoices.find(inv => inv.id === currentAssignmentInvoiceId);
            if (!currentInvoice) return;

            // Check if this payer is already assigned
            const alreadyAssigned = tempAssignedPayers.some(ap =>
                ap.payerId === payerId ||
                (ap.payerId === 'primary-contact' && payer.isPrimary) ||
                (ap.isPrimary && payer.isPrimary) ||
                (ap.email && payer.email && ap.email === payer.email) ||
                (ap.name === payer.name && payer.isPrimary)
            );

            if (alreadyAssigned) {
                showToast('This payer is already assigned to this invoice', 'warning');
                return;
            }

            // Check if trying to add a primary contact when one already exists
            if (payer.isPrimary || payerId === 'primary-contact') {
                const hasPrimary = tempAssignedPayers.some(ap =>
                    ap.isPrimary ||
                    ap.payerId === 'primary-contact' ||
                    quotePayers.find(p => p.id === ap.payerId)?.isPrimary
                );

                if (hasPrimary) {
                    showToast('A primary contact is already assigned. Only one primary contact is allowed per invoice.', 'warning');
                    return;
                }
            }

            // Calculate default percentage if this is the first payer
            let percentage = payer.percentage || 0;
            if (tempAssignedPayers.length === 0 && percentage === 0) {
                percentage = 100;
            } else if (tempAssignedPayers.length > 0 && percentage === 0) {
                // Distribute remaining percentage
                const totalAssigned = tempAssignedPayers.reduce((sum, p) => sum + (p.assignedPercentage || 0), 0);
                percentage = Math.max(0, 100 - totalAssigned);
            }

            const assignedAmount = (currentInvoice.amount * percentage / 100);

            tempAssignedPayers.push({
                payerId: payer.id,
                name: payer.name,
                email: payer.email,
                assignedPercentage: percentage,
                assignedAmount: assignedAmount,
                assignedAt: new Date().toISOString(),
                isPrimary: payer.isPrimary || payerId === 'primary-contact',
                // Payment tracking fields
                paidAmount: 0,
                outstandingAmount: assignedAmount,
                paymentStatus: 'unpaid',
                payments: [],
                lastPaymentDate: null
            });

            renderAssignModalPayersTable();
            updateAssignModalDistributionSummary();
            renderAssignModalInvoicePreview(currentInvoice);

            // Update contact selector dropdown
            updateAssignModalContactSelector();
        }

        function removePayerFromAssignment(index) {
            const payer = tempAssignedPayers[index];
            if (!payer) return;

            // Prevent removing primary contact
            const isPrimary = payer.isPrimary || payer.payerId === 'primary-contact' || quotePayers.find(p => p.id === payer.payerId)?.isPrimary;
            if (isPrimary) {
                showToast('Primary contact cannot be removed', 'warning');
                return;
            }

            tempAssignedPayers.splice(index, 1);
            renderAssignModalPayersTable();
            updateAssignModalDistributionSummary();
            updateAssignModalContactSelector();

            const invoice = quoteInvoices.find(inv => inv.id === currentAssignmentInvoiceId);
            if (invoice) {
                renderAssignModalInvoicePreview(invoice);
            }
        }

        function updatePayerAssignmentPercentage(index, newPercentage) {
            const invoice = quoteInvoices.find(inv => inv.id === currentAssignmentInvoiceId);
            if (!invoice) return;

            const payer = tempAssignedPayers[index];
            if (!payer) return;

            const percentage = parseFloat(newPercentage) || 0;
            payer.assignedPercentage = Math.max(0, Math.min(100, percentage));
            payer.assignedAmount = (invoice.amount * payer.assignedPercentage / 100);

            renderAssignModalPayersTable();
            updateAssignModalDistributionSummary();

            renderAssignModalInvoicePreview(invoice);
        }

        function updateAssignmentSummary() {
            const invoice = quoteInvoices.find(inv => inv.id === currentAssignmentInvoiceId);
            if (!invoice) return;

            const totalPercentage = tempAssignedPayers.reduce((sum, p) => sum + (p.assignedPercentage || 0), 0);
            const totalAmount = tempAssignedPayers.reduce((sum, p) => sum + (p.assignedAmount || 0), 0);

            document.getElementById('totalAssignmentPercentage').textContent = `${totalPercentage.toFixed(1)}%`;
            document.getElementById('totalAssignmentAmount').textContent = `$${totalAmount.toFixed(2)}`;

            const validationDiv = document.getElementById('assignmentValidation');
            const saveBtn = document.getElementById('saveAssignmentBtn');

            if (Math.abs(totalPercentage - 100) < 0.01) {
                validationDiv.innerHTML = '<span class="text-green-700 font-medium">âœ“ Assignment is valid (100%)</span>';
                saveBtn.disabled = false;
                saveBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            } else if (totalPercentage > 100) {
                validationDiv.innerHTML = '<span class="text-red-700 font-medium">âš  Total exceeds 100%</span>';
                saveBtn.disabled = true;
                saveBtn.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                validationDiv.innerHTML = `<span class="text-yellow-700 font-medium">âš  Total is ${totalPercentage.toFixed(1)}% (should be 100%)</span>`;
                saveBtn.disabled = false;
                saveBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }

            // Update payment distribution preview
            updatePaymentDistributionPreview();
        }

        function updatePaymentDistributionPreview() {
            const invoice = quoteInvoices.find(inv => inv.id === currentAssignmentInvoiceId);
            if (!invoice) return;

            const previewSection = document.getElementById('paymentDistributionPreview');
            const previewContainer = document.getElementById('payerDistributionPreview');

            if (tempAssignedPayers.length === 0) {
                previewSection.classList.add('hidden');
                return;
            }

            previewSection.classList.remove('hidden');

            // Update invoice info in preview
            document.getElementById('previewInvoiceId').textContent = invoice.id;
            document.getElementById('previewInvoiceTotal').textContent = `$${invoice.amount.toFixed(2)}`;

            // Render payer distribution cards
            const totalAssigned = tempAssignedPayers.reduce((sum, p) => sum + (p.assignedAmount || 0), 0);
            const remaining = invoice.amount - totalAssigned;

            previewContainer.innerHTML = tempAssignedPayers.map((payer, index) => {
                const percentage = payer.assignedPercentage || 0;
                const amount = payer.assignedAmount || 0;
                const visualPercentage = invoice.amount > 0 ? (amount / invoice.amount) * 100 : 0;

                return `
                    <div class="bg-gradient-to-r from-purple-50 to-indigo-50 border border-purple-200 rounded-lg p-3">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex-1">
                                <div class="font-semibold text-gray-900 text-sm">${payer.name}</div>
                                ${payer.email ? `<div class="text-xs text-gray-500">${payer.email}</div>` : ''}
                            </div>
                            <div class="text-right ml-3">
                                <div class="text-lg font-bold text-purple-700">${formatCurrency(amount)}</div>
                                <div class="text-xs text-gray-600">${percentage.toFixed(1)}%</div>
                            </div>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2 overflow-hidden">
                            <div 
                                class="h-2 rounded-full bg-gradient-to-r from-purple-500 to-indigo-500 transition-all duration-300" 
                                style="width: ${Math.min(100, Math.max(0, visualPercentage))}%"
                            ></div>
                        </div>
                    </div>
                `;
            }).join('');

            // Update totals
            document.getElementById('previewTotalAssigned').textContent = `$${totalAssigned.toFixed(2)}`;
            document.getElementById('previewRemaining').textContent = `$${remaining.toFixed(2)}`;
        }

        function savePayerAssignment() {
            const invoice = quoteInvoices.find(inv => inv.id === currentAssignmentInvoiceId);
            if (!invoice) return;

            const totalPercentage = tempAssignedPayers.reduce((sum, p) => sum + (p.assignedPercentage || 0), 0);

            if (Math.abs(totalPercentage - 100) > 0.01) {
                showToast('Total assignment must equal 100%', 'warning');
                return;
            }

            // Save assignment
            const oldPayers = invoice.assignedPayers || [];
            invoice.assignedPayers = tempAssignedPayers;

            // Update invoice status
            const oldStatus = invoice.status;
            if (tempAssignedPayers.length > 0) {
                invoice.status = invoice.status === 'unassigned' ? 'assigned' : invoice.status;
            }

            // Log payer assignment activity
            const payerNames = tempAssignedPayers.map(p => p.name).join(', ');
            logInvoiceActivity(invoice.id, 'payer_assigned',
                `${tempAssignedPayers.length} payer(s) assigned: ${payerNames}`,
                {
                    payerCount: tempAssignedPayers.length,
                    payers: tempAssignedPayers.map(p => ({ name: p.name, email: p.email, amount: p.assignedAmount })),
                    oldStatus: oldStatus,
                    newStatus: invoice.status
                }
            );

            // Log status change if status changed
            if (oldStatus !== invoice.status) {
                logInvoiceActivity(invoice.id, 'status_change',
                    `Invoice status changed from ${oldStatus} to ${invoice.status}`,
                    {
                        oldStatus: oldStatus,
                        newStatus: invoice.status,
                        reason: 'payer_assigned'
                    }
                );
            }

            // Refresh UI
            loadInvoices();
            updateInvoiceSummary();

            // Payer payment status is now displayed within each invoice card
            closeAssignPayersModal();

            showToast(`Successfully assigned ${tempAssignedPayers.length} payer(s) to invoice ${invoice.id}`, 'success');
        }

        function showAddPayerToAssignment() {
            const form = document.getElementById('addPayerToAssignmentForm');
            if (form) {
                form.classList.remove('hidden');
            }
            const nameInput = document.getElementById('newPayerNameAssignment');
            const emailInput = document.getElementById('newPayerEmailAssignment');
            if (nameInput) nameInput.value = '';
            if (emailInput) emailInput.value = '';
        }

        function hideAddPayerToAssignmentForm() {
            const form = document.getElementById('addPayerToAssignmentForm');
            if (form) {
                form.classList.add('hidden');
            }
        }

        function addNewPayerToAssignment() {
            const name = document.getElementById('newPayerNameAssignment').value.trim();
            const email = document.getElementById('newPayerEmailAssignment').value.trim();

            if (!name) {
                showToast('Please enter a payer name', 'warning');
                return;
            }

            const invoice = quoteInvoices.find(inv => inv.id === currentAssignmentInvoiceId);
            if (!invoice) return;

            // Create new payer
            const newPayerId = `payer-${Date.now()}`;
            const newPayer = {
                id: newPayerId,
                name: name,
                email: email || null,
                percentage: 0,
                isPrimary: false,
                createdAt: new Date().toISOString()
            };

            // Add to quotePayers
            quotePayers.push(newPayer);

            // Add to assignment
            const totalAssigned = tempAssignedPayers.reduce((sum, p) => sum + (p.assignedPercentage || 0), 0);
            const remainingPercentage = Math.max(0, 100 - totalAssigned);
            const percentage = remainingPercentage > 0 ? remainingPercentage : 0;
            const assignedAmount = (invoice.amount * percentage / 100);

            tempAssignedPayers.push({
                payerId: newPayerId,
                name: name,
                email: email || null,
                assignedPercentage: percentage,
                assignedAmount: assignedAmount,
                assignedAt: new Date().toISOString(),
                paidAmount: 0,
                outstandingAmount: assignedAmount,
                paymentStatus: 'unpaid',
                payments: [],
                lastPaymentDate: null
            });

            hideAddPayerToAssignmentForm();
            renderAssignedPayers();
            renderAvailablePayers();
            updateAssignmentSummary();
            updatePaymentDistributionPreview();
        }

        // ============================================================================
        // PAYMENT CONFIRMATION/CANCELLATION FUNCTIONALITY
        // ============================================================================

        let currentPaymentConfirmationId = null;
        let currentPaymentConfirmationInvoiceId = null;

        function openConfirmPaymentModal(invoiceId, paymentId) {
            const invoice = quoteInvoices.find(inv => inv.id === invoiceId);
            if (!invoice) return;

            const payment = invoice.paymentHistory.find(p => p.id === paymentId);
            if (!payment) return;

            currentPaymentConfirmationId = paymentId;
            currentPaymentConfirmationInvoiceId = invoiceId;

            // Populate modal
            document.getElementById('confirmPaymentAmount').textContent = `$${payment.amount.toFixed(2)}`;
            document.getElementById('confirmPaymentPayer').textContent = payment.payer?.name || 'Unknown';
            document.getElementById('confirmPaymentMethod').textContent = payment.method || 'N/A';
            document.getElementById('confirmPaymentDate').textContent = new Date(payment.date).toLocaleDateString();

            // Show modal
            document.getElementById('confirmPaymentModal').classList.remove('hidden');
        }

        function closeConfirmPaymentModal() {
            document.getElementById('confirmPaymentModal').classList.add('hidden');
            currentPaymentConfirmationId = null;
            currentPaymentConfirmationInvoiceId = null;
        }

        function executeConfirmPayment() {
            const invoice = quoteInvoices.find(inv => inv.id === currentPaymentConfirmationInvoiceId);
            if (!invoice) return;

            const payment = invoice.paymentHistory.find(p => p.id === currentPaymentConfirmationId);
            if (!payment) return;

            // Update payment status
            payment.status = 'confirmed';
            payment.confirmedBy = 'manager-user-id'; // In real app, use actual user ID
            payment.confirmedAt = new Date().toISOString();

            // Recalculate invoice paid amount (sum of all confirmed payments)
            const confirmedPayments = invoice.paymentHistory.filter(p => p.status === 'confirmed');
            invoice.paidAmount = confirmedPayments.reduce((sum, p) => sum + p.amount, 0);

            // Update invoice status
            if (invoice.paidAmount >= invoice.amount - 0.01) {
                invoice.status = 'paid';
                invoice.paidAmount = invoice.amount;
            } else if (invoice.paidAmount > 0) {
                invoice.status = 'partially_paid';
            }

            // Update assigned payer payment tracking
            if (invoice.assignedPayers && payment.payer) {
                const assignedPayer = invoice.assignedPayers.find(ap => ap.payerId === payment.payer.id || ap.name === payment.payer.name);
                if (assignedPayer) {
                    // Recalculate payer's paid amount (only confirmed payments)
                    const payerPayments = invoice.paymentHistory.filter(p =>
                        p.status === 'confirmed' &&
                        (p.payer?.id === assignedPayer.payerId || p.payer?.name === assignedPayer.name)
                    );
                    assignedPayer.paidAmount = payerPayments.reduce((sum, p) => sum + p.amount, 0);
                    assignedPayer.outstandingAmount = assignedPayer.assignedAmount - assignedPayer.paidAmount;

                    // Update payer payment status
                    if (assignedPayer.paidAmount >= assignedPayer.assignedAmount - 0.01) {
                        assignedPayer.paymentStatus = 'paid';
                    } else if (assignedPayer.paidAmount > 0) {
                        assignedPayer.paymentStatus = 'partial';
                    } else {
                        assignedPayer.paymentStatus = 'unpaid';
                    }

                    // Update last payment date
                    if (payerPayments.length > 0) {
                        const lastPayment = payerPayments.sort((a, b) => new Date(b.date) - new Date(a.date))[0];
                        assignedPayer.lastPaymentDate = lastPayment.date;
                    }
                }
            }

            // Refresh UI
            loadInvoices();
            updateInvoiceSummary();
            // Payer payment status is now displayed within each invoice card
            closeConfirmPaymentModal();

            showToast(`Payment of $${payment.amount.toFixed(2)} confirmed successfully`, 'success');
        }

        function openCancelPaymentModal(invoiceId, paymentId) {
            const invoice = quoteInvoices.find(inv => inv.id === invoiceId);
            if (!invoice) return;

            const payment = invoice.paymentHistory.find(p => p.id === paymentId);
            if (!payment) return;

            currentPaymentConfirmationId = paymentId;
            currentPaymentConfirmationInvoiceId = invoiceId;

            // Populate modal
            document.getElementById('cancelPaymentAmount').textContent = `$${payment.amount.toFixed(2)}`;
            document.getElementById('cancelPaymentPayer').textContent = payment.payer?.name || 'Unknown';
            document.getElementById('cancelPaymentMethod').textContent = payment.method || 'N/A';
            document.getElementById('cancellationReason').value = '';

            // Show modal
            document.getElementById('cancelPaymentModal').classList.remove('hidden');
        }

        function closeCancelPaymentModal() {
            document.getElementById('cancelPaymentModal').classList.add('hidden');
            currentPaymentConfirmationId = null;
            currentPaymentConfirmationInvoiceId = null;
        }

        function executeCancelPayment() {
            const invoice = quoteInvoices.find(inv => inv.id === currentPaymentConfirmationInvoiceId);
            if (!invoice) return;

            const payment = invoice.paymentHistory.find(p => p.id === currentPaymentConfirmationId);
            if (!payment) return;

            const reason = document.getElementById('cancellationReason').value.trim();
            if (!reason) {
                showToast('Please provide a reason for cancellation', 'warning');
                return;
            }

            // Update payment status
            payment.status = 'cancelled';
            payment.cancelledBy = 'manager-user-id'; // In real app, use actual user ID
            payment.cancelledAt = new Date().toISOString();
            payment.cancellationReason = reason;

            // Recalculate invoice paid amount (only confirmed payments)
            const confirmedPayments = invoice.paymentHistory.filter(p => p.status === 'confirmed');
            invoice.paidAmount = confirmedPayments.reduce((sum, p) => sum + p.amount, 0);

            // Update invoice status
            if (invoice.paidAmount >= invoice.amount - 0.01) {
                invoice.status = 'paid';
                invoice.paidAmount = invoice.amount;
            } else if (invoice.paidAmount > 0) {
                invoice.status = 'partially_paid';
            } else {
                invoice.status = invoice.assignedPayers && invoice.assignedPayers.length > 0 ? 'assigned' : 'unassigned';
            }

            // Update assigned payer payment tracking
            if (invoice.assignedPayers && payment.payer) {
                const assignedPayer = invoice.assignedPayers.find(ap => ap.payerId === payment.payer.id || ap.name === payment.payer.name);
                if (assignedPayer) {
                    // Recalculate payer's paid amount (only confirmed payments)
                    const payerPayments = invoice.paymentHistory.filter(p =>
                        p.status === 'confirmed' &&
                        (p.payer?.id === assignedPayer.payerId || p.payer?.name === assignedPayer.name)
                    );
                    assignedPayer.paidAmount = payerPayments.reduce((sum, p) => sum + p.amount, 0);
                    assignedPayer.outstandingAmount = assignedPayer.assignedAmount - assignedPayer.paidAmount;

                    // Update payer payment status
                    if (assignedPayer.paidAmount >= assignedPayer.assignedAmount - 0.01) {
                        assignedPayer.paymentStatus = 'paid';
                    } else if (assignedPayer.paidAmount > 0) {
                        assignedPayer.paymentStatus = 'partial';
                    } else {
                        assignedPayer.paymentStatus = 'unpaid';
                    }
                }
            }

            // Refresh UI
            loadInvoices();
            updateInvoiceSummary();
            // Payer payment status is now displayed within each invoice card
            closeCancelPaymentModal();

            showToast(`Payment of $${payment.amount.toFixed(2)} has been cancelled`, 'success');
        }

        // Helper function to calculate confirmed payments total
        // Activity Log Functions
        function logInvoiceActivity(invoiceId, activityType, description, details = {}) {
            const invoice = quoteInvoices.find(inv => inv.id === invoiceId);
            if (!invoice) return;

            // Initialize activity log if it doesn't exist
            if (!invoice.activityLog) {
                invoice.activityLog = [];
            }

            const activity = {
                id: `ACT-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
                type: activityType, // 'created', 'payment', 'status_change', 'payer_assigned', 'payer_removed', 'cancelled', 'sent', 'viewed'
                description: description,
                details: details,
                timestamp: new Date().toISOString(),
                performedBy: 'staff-user-id', // In real app, use actual user ID
                performedByName: 'Staff User' // In real app, use actual user name
            };

            invoice.activityLog.unshift(activity); // Add to beginning (most recent first)

            // Keep only last 100 activities per invoice
            if (invoice.activityLog.length > 100) {
                invoice.activityLog = invoice.activityLog.slice(0, 100);
            }
        }

        function getConfirmedPaymentsTotal(invoice) {
            if (!invoice.paymentHistory) return 0;
            const confirmedPayments = invoice.paymentHistory.filter(p => p.status === 'confirmed');
            return confirmedPayments.reduce((sum, p) => sum + p.amount, 0);
        }

        // ============================================================================
        // PAYER PAYMENT STATUS PANEL
        // ============================================================================

        function updatePayerPaymentStatusPanel() {
            const panel = document.getElementById('payerPaymentStatusPanel');
            const content = document.getElementById('payerStatusContent');
            if (!panel || !content) return;

            // Find invoices with assigned payers
            const invoicesWithPayers = quoteInvoices.filter(inv =>
                inv.assignedPayers && inv.assignedPayers.length > 0 && inv.status !== 'cancelled'
            );

            if (invoicesWithPayers.length === 0) {
                content.innerHTML = `
                    <div class="text-sm text-gray-500 text-center py-4">
                        No payers assigned to any invoices yet.<br>
                        <span class="text-xs">Assign payers to invoices to track payment status</span>
                    </div>
                `;
                return;
            }

            // Group by invoice or show all
            let html = '';

            invoicesWithPayers.forEach(invoice => {
                const invoicePaid = getConfirmedPaymentsTotal(invoice);
                const invoiceOutstanding = invoice.amount - invoicePaid;
                const completionPercent = invoice.amount > 0 ? (invoicePaid / invoice.amount) * 100 : 0;

                html += `
                    <div class="mb-4 pb-4 border-b border-gray-200 last:border-0">
                        <div class="flex items-center justify-between mb-3">
                            <div>
                                <div class="font-semibold text-gray-900">${invoice.id}</div>
                                <div class="text-xs text-gray-500">$${invoice.amount.toFixed(2)}</div>
                            </div>
                            <div class="text-right">
                                <div class="text-sm font-semibold ${completionPercent >= 100 ? 'text-green-600' : completionPercent > 0 ? 'text-yellow-600' : 'text-red-600'}">
                                    ${completionPercent.toFixed(0)}%
                                </div>
                                <div class="text-xs text-gray-500">Complete</div>
                            </div>
                        </div>

                        <div class="space-y-2">
                            ${invoice.assignedPayers.map(assignedPayer => {
                    // Calculate payer's confirmed payments
                    const payerPayments = invoice.paymentHistory ? invoice.paymentHistory.filter(p =>
                        p.status === 'confirmed' &&
                        (p.payer?.id === assignedPayer.payerId || p.payer?.name === assignedPayer.name)
                    ) : [];
                    const payerPaid = payerPayments.reduce((sum, p) => sum + p.amount, 0);
                    const payerOutstanding = assignedPayer.assignedAmount - payerPaid;
                    const payerPercent = assignedPayer.assignedAmount > 0 ? (payerPaid / assignedPayer.assignedAmount) * 100 : 0;

                    // Status indicators
                    let statusBadge = '';
                    let statusColor = '';
                    if (payerPaid >= assignedPayer.assignedAmount - 0.01) {
                        statusBadge = 'âœ… Fully Paid';
                        statusColor = 'green';
                    } else if (payerPaid > 0) {
                        statusBadge = 'âš ï¸ Partially Paid';
                        statusColor = 'yellow';
                    } else {
                        statusBadge = 'âŒ Not Paid';
                        statusColor = 'red';
                    }

                    return `
                                    <div class="bg-gray-50 border border-gray-200 rounded-lg p-3">
                                        <div class="flex items-start justify-between mb-2">
                                            <div class="flex-1">
                                                <div class="font-medium text-gray-900 text-sm">${assignedPayer.name}</div>
                                                ${assignedPayer.email ? `<div class="text-xs text-gray-500">${assignedPayer.email}</div>` : ''}
                                            </div>
                                            <div class="text-right ml-2">
                                                <div class="text-xs font-semibold text-${statusColor}-600">${statusBadge}</div>
                                            </div>
                                        </div>
                                        
                                        <div class="mb-2">
                                            <div class="flex justify-between text-xs text-gray-600 mb-1">
                                                <span>Assigned: $${assignedPayer.assignedAmount.toFixed(2)} (${assignedPayer.assignedPercentage}%)</span>
                                                <span>Paid: $${payerPaid.toFixed(2)}</span>
                                            </div>
                                            <div class="w-full bg-gray-200 rounded-full h-1.5">
                                                <div 
                                                    class="h-1.5 rounded-full transition-all duration-500 ${statusColor === 'green' ? 'bg-green-600' : statusColor === 'yellow' ? 'bg-yellow-500' : 'bg-gray-300'}" 
                                                    style="width: ${Math.min(100, Math.max(0, payerPercent))}%"
                                                ></div>
                                            </div>
                                        </div>
                                        
                                        ${payerOutstanding > 0.01 ? `
                                            <div class="flex justify-between text-xs pt-2 border-t border-gray-200">
                                                <span class="text-gray-600">Outstanding:</span>
                                                <span class="font-semibold text-red-600">$${payerOutstanding.toFixed(2)}</span>
                                            </div>
                                        ` : ''}
                                        
                                        ${assignedPayer.lastPaymentDate ? `
                                            <div class="text-xs text-gray-500 mt-1">
                                                Last Payment: ${new Date(assignedPayer.lastPaymentDate).toLocaleDateString()}
                                            </div>
                                        ` : ''}
                                        
                                        <div class="flex gap-2 mt-2">
                                                <button 
                                                    onclick="openRecordPaymentModal('${invoice.id}', '${assignedPayer.payerId}')"
                                                    class="flex-1 px-2 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700"
                                                >
                                                    Mark as Paid
                                                </button>
                                            ${payerPayments.length > 0 ? `
                                                <button 
                                                    onclick="viewPayerPayments('${invoice.id}', '${assignedPayer.payerId}')"
                                                    class="flex-1 px-2 py-1 bg-gray-100 text-gray-700 text-xs rounded hover:bg-gray-200"
                                                >
                                                    View Payments
                                                </button>
                                            ` : ''}
                                        </div>
                                    </div>
                                `;
                }).join('')}
                        </div>

                        <div class="mt-3 pt-3 border-t border-gray-200">
                            <div class="flex justify-between text-xs">
                                <span class="text-gray-600">Total Paid:</span>
                                <span class="font-semibold text-green-600">$${invoicePaid.toFixed(2)}</span>
                            </div>
                            ${invoiceOutstanding > 0.01 ? `
                                <div class="flex justify-between text-xs mt-1">
                                    <span class="text-gray-600">Outstanding:</span>
                                    <span class="font-semibold text-red-600">$${invoiceOutstanding.toFixed(2)}</span>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            });

            content.innerHTML = html;
        }

        function viewPayerPayments(invoiceId, payerId) {
            const invoice = quoteInvoices.find(inv => inv.id === invoiceId);
            if (!invoice) return;

            const assignedPayer = invoice.assignedPayers.find(ap => ap.payerId === payerId);
            if (!assignedPayer) return;

            const payerPayments = invoice.paymentHistory ? invoice.paymentHistory.filter(p =>
                (p.payer?.id === payerId || p.payer?.name === assignedPayer.name)
            ) : [];

            if (payerPayments.length === 0) {
                showToast('No payments found for this payer', 'info');
                return;
            }

            let message = `Payment History for ${assignedPayer.name}:\n\n`;
            payerPayments.forEach((payment, idx) => {
                message += `${idx + 1}. $${payment.amount.toFixed(2)} - ${payment.method}\n`;
                message += `   Date: ${new Date(payment.date).toLocaleDateString()}\n`;
                message += `   Status: ${payment.status}\n`;
                if (payment.notes) message += `   Notes: ${payment.notes}\n`;
                message += '\n';
            });

            alert(message);
        }

        function closeRecordPaymentModal() {
            document.getElementById('recordPaymentModal').classList.add('hidden');
            currentPaymentInvoiceId = null;
        }

        function confirmRecordPayment() {
            const invoice = quoteInvoices.find(inv => inv.id === currentPaymentInvoiceId);
            if (!invoice) return;

            const date = document.getElementById('paymentDate').value;
            const notes = document.getElementById('paymentNotes').value;
            const paymentAmount = window.currentPaymentAmount || 0;
            const payerId = window.currentPaymentPayerId;

            // Validation
            if (!date) {
                showToast('Please select a payment date', 'warning');
                return;
            }

            if (!paymentAmount || paymentAmount < 0.01) {
                showToast('Invalid payment amount', 'error');
                return;
            }

            // Get payer information
            let payerData = null;
            if (payerId && invoice.assignedPayers) {
                const assignedPayer = invoice.assignedPayers.find(ap => ap.payerId === payerId);
                if (assignedPayer) {
                    payerData = {
                        id: assignedPayer.payerId,
                        name: assignedPayer.name,
                        email: assignedPayer.email
                    };
                }
            }

            // If no payer found, use primary contact
            if (!payerData) {
                const primaryContact = state.selectedQuoteContact || state.quoteContact;
                payerData = {
                    id: primaryContact?.id || 'primary',
                    name: primaryContact?.name || 'Primary Contact',
                    email: primaryContact?.email || null
                };
            }

            // Calculate outstanding amount (from confirmed payments only)
            const currentPaid = getConfirmedPaymentsTotal(invoice);
            const outstanding = invoice.amount - currentPaid;

            if (paymentAmount > outstanding + 0.01) {
                showToast(`Payment amount cannot exceed outstanding amount of $${outstanding.toFixed(2)}`, 'error');
                return;
            }

            // Confirm payment
            // Confirm payment - removed as button is explicit
            // const confirmMsg = `Record payment of $${paymentAmount.toFixed(2)} from ${payerData.name} for invoice ${invoice.id}?`;
            // if (!confirm(confirmMsg)) {
            //    return;
            // }

            // Initialize payment history if it doesn't exist
            if (!invoice.paymentHistory) {
                invoice.paymentHistory = [];
            }

            // Create payment record - automatically confirmed
            // Default payment method to "Manual Payment" since it's not in simplified modal
            const now = new Date().toISOString();
            const paymentRecord = {
                id: `PAY-${Date.now()}`,
                amount: paymentAmount,
                payer: payerData,
                method: 'Manual Payment',
                date: date,
                notes: notes || '',
                recordedAt: now,
                // Payment automatically confirmed
                status: 'confirmed',
                recordedBy: 'staff-user-id', // In real app, use actual user ID
                confirmedBy: 'staff-user-id',
                confirmedAt: now,
                cancelledBy: null,
                cancelledAt: null,
                cancellationReason: null
            };

            // Add to payment history
            invoice.paymentHistory.push(paymentRecord);

            // Update invoice paidAmount and status immediately
            const oldStatus = invoice.status;
            const newPaidAmount = getConfirmedPaymentsTotal(invoice);
            invoice.paidAmount = newPaidAmount;

            // Update assigned payer status if applicable
            if (payerId && invoice.assignedPayers) {
                const assignedPayer = invoice.assignedPayers.find(p => p.payerId === payerId);
                if (assignedPayer) {
                    assignedPayer.paidAmount = (assignedPayer.paidAmount || 0) + paymentAmount;
                    assignedPayer.outstandingAmount = Math.max(0, (assignedPayer.assignedAmount || 0) - assignedPayer.paidAmount);

                    if (assignedPayer.outstandingAmount < 0.01) {
                        assignedPayer.paymentStatus = 'paid';
                    } else if (assignedPayer.paidAmount > 0) {
                        assignedPayer.paymentStatus = 'partially_paid';
                    }
                }
            }

            // Update invoice status using strict "All Paid" logic
            checkInvoicePaymentStatus(invoice);

            // Log payment activity
            logInvoiceActivity(invoice.id, 'payment',
                `Payment of $${paymentAmount.toFixed(2)} recorded from ${payerData.name}`,
                {
                    paymentId: paymentRecord.id,
                    amount: paymentAmount,
                    payer: payerData.name,
                    payerEmail: payerData.email,
                    method: 'Manual Payment',
                    date: date,
                    oldStatus: oldStatus,
                    newStatus: invoice.status,
                    notes: notes || null
                }
            );

            // Log status change if status changed
            if (oldStatus !== invoice.status) {
                logInvoiceActivity(invoice.id, 'status_change',
                    `Invoice status changed from ${oldStatus} to ${invoice.status}`,
                    {
                        oldStatus: oldStatus,
                        newStatus: invoice.status,
                        reason: 'payment_recorded'
                    }
                );
            }

            // Refresh UI
            loadInvoices();
            updateInvoiceSummary();

            closeRecordPaymentModal();

            // Success message with toast
            showToast(`Payment of $${paymentAmount.toFixed(2)} from ${payerData.name} recorded successfully.`, 'success', 3000);
        }

        // Keep the old function name for compatibility but redirect to new modal
        function recordPayment(invoiceId) {
            openRecordPaymentModal(invoiceId);
        }

        function cancelInvoice(invoiceId) {
            const invoice = quoteInvoices.find(inv => inv.id === invoiceId);
            if (!invoice) return;

            // Confirm cancellation
            const confirmMessage = `Are you sure you want to cancel invoice ${invoiceId}?\n\n` +
                `Amount: $${invoice.amount.toFixed(2)}\n` +
                `Status: ${invoice.status}\n` +
                (invoice.paidAmount > 0 ? `Paid Amount: $${invoice.paidAmount.toFixed(2)}\n\n` : '\n') +
                `This action cannot be undone.`;

            if (!confirm(confirmMessage)) {
                return;
            }

            // Check if invoice has payments
            if (invoice.paidAmount > 0) {
                const refundConfirm = confirm(
                    `âš ï¸ Warning: This invoice has received payments totaling $${invoice.paidAmount.toFixed(2)}.\n\n` +
                    `Cancelling this invoice does not automatically process refunds. ` +
                    `You will need to manually refund the customer if required.\n\n` +
                    `Do you still want to cancel this invoice?`
                );

                if (!refundConfirm) {
                    return;
                }
            }

            // Cancel the invoice
            const oldStatus = invoice.status;
            invoice.status = 'cancelled';
            invoice.cancelledDate = new Date().toISOString().split('T')[0];
            invoice.cancelledBy = 'Manager'; // In real app, use actual user info

            // Log cancellation activity
            logInvoiceActivity(invoice.id, 'cancelled',
                `Invoice cancelled`,
                {
                    oldStatus: oldStatus,
                    cancelledDate: invoice.cancelledDate,
                    cancelledBy: invoice.cancelledBy,
                    amount: invoice.amount,
                    paidAmount: invoice.paidAmount || 0
                }
            );

            // Refresh UI
            loadInvoices();
            updateInvoiceSummary();


            // Calculate remaining amount after cancellation
            const remainingAmount = getRemainingToInvoice();

            // Success message with remaining amount info
            let successMessage = `âœ… Invoice ${invoiceId} has been cancelled successfully.\n\n`;
            if (remainingAmount > 0) {
                successMessage += `ðŸ’° Remaining amount to invoice: $${remainingAmount.toFixed(2)}\n\n`;
                successMessage += `You can now create new invoices for this amount by clicking "Generate Invoices" in the Payment Configuration tab.`;
            } else {
                successMessage += `This quote is now fully invoiced.`;
            }
            alert(successMessage);
        }

        function sendPaymentReminder() {
            const unpaidInvoices = quoteInvoices.filter(inv => inv.status === 'unpaid');

            if (unpaidInvoices.length === 0) {
                alert('No unpaid invoices to send reminders for.');
                return;
            }

            alert(`Payment reminder sent for ${unpaidInvoices.length} unpaid invoice(s)!`);
            // In real implementation, send reminder emails
        }

        function viewPaymentHistory() {
            const tbody = document.getElementById('paymentHistoryTableBody');
            const noMsg = document.getElementById('noPaymentHistoryMsg');
            const modal = document.getElementById('paymentHistoryModal');

            if (!tbody || !modal) return;

            tbody.innerHTML = '';

            // Aggregate all payments
            let allPayments = [];
            quoteInvoices.forEach(inv => {
                if (inv.paymentHistory && inv.paymentHistory.length > 0) {
                    inv.paymentHistory.forEach(p => {
                        allPayments.push({
                            ...p,
                            invoiceId: inv.id
                        });
                    });
                }
            });

            // Sort by date desc
            allPayments.sort((a, b) => new Date(b.date) - new Date(a.date));

            if (allPayments.length === 0) {
                noMsg.classList.remove('hidden');
            } else {
                noMsg.classList.add('hidden');
                allPayments.forEach(p => {
                    const row = document.createElement('tr');
                    const payerName = p.payer ? p.payer.name : 'Unknown';
                    const payerEmail = p.payer && p.payer.email ? p.payer.email : '';

                    row.innerHTML = `
                        <td class="py-3 px-2">${new Date(p.date).toLocaleDateString()}</td>
                        <td class="py-3 px-2 font-medium text-blue-600">${p.invoiceId}</td>
                        <td class="py-3 px-2">
                            <div class="font-medium">${payerName}</div>
                            ${payerEmail ? `<div class="text-xs text-gray-500">${payerEmail}</div>` : ''}
                        </td>
                        <td class="py-3 px-2">${p.method}</td>
                        <td class="py-3 px-2 text-right font-medium">$${parseFloat(p.amount).toFixed(2)}</td>
                        <td class="py-3 px-2 text-center">
                            <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800">
                                ${p.status || 'Completed'}
                            </span>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            }

            modal.classList.remove('hidden');
        }

        function closePaymentHistoryModal() {
            const modal = document.getElementById('paymentHistoryModal');
            if (modal) modal.classList.add('hidden');
        }

        function toggleActivityLog(invoiceId) {
            const content = document.getElementById(`activityLogContent-${invoiceId}`);
            const icon = document.getElementById(`activityLogIcon-${invoiceId}`);
            if (content && icon) {
                content.classList.toggle('hidden');
                icon.classList.toggle('rotate-180');
            }
        }



        function updateGlobalActivityLog() {
            console.log('Antigravity fix loaded', new Date().toISOString());
            return;
        }

        function togglePayerDetails(invoiceId) {
            const content = document.getElementById(`payerDetailsContent-${invoiceId}`);
            const icon = document.getElementById(`payerDetailsIcon-${invoiceId}`);
            if (content && icon) {
                content.classList.toggle('hidden');
                icon.classList.toggle('rotate-180');
            }
        }

        function toggleInvoiceActions(invoiceId) {
            const menu = document.getElementById(`invoiceActionsMenu-${invoiceId}`);
            if (menu) {
                menu.classList.toggle('hidden');
                // Close other open menus
                document.querySelectorAll('[id^="invoiceActionsMenu-"]').forEach(m => {
                    if (m.id !== `invoiceActionsMenu-${invoiceId}`) {
                        m.classList.add('hidden');
                    }
                });
            }
        }

        // Close dropdown menus when clicking outside
        document.addEventListener('click', function (event) {
            if (!event.target.closest('[id^="invoiceActionsBtn-"]') && !event.target.closest('[id^="invoiceActionsMenu-"]')) {
                document.querySelectorAll('[id^="invoiceActionsMenu-"]').forEach(menu => {
                    menu.classList.add('hidden');
                });
            }
        });

        function togglePaymentHistory(invoiceId) {
            const detailsDiv = document.getElementById(`paymentHistoryDetails-${invoiceId}`);
            const icon = document.getElementById(`paymentHistoryIcon-${invoiceId}`);

            if (detailsDiv && icon) {
                detailsDiv.classList.toggle('hidden');
                icon.classList.toggle('rotate-180');
            }
        }

        function downloadInvoicePDF(invoiceId) {
            const invoice = quoteInvoices.find(inv => inv.id === invoiceId);
            if (invoice) {
                // In real implementation, generate and download PDF
                showToast(`Downloading PDF for invoice ${invoiceId}...`, 'info');
                // For now, just show a message
                setTimeout(() => {
                    showToast(`PDF download would be implemented here`, 'info');
                }, 500);
            }
        }

        function viewPaymentHistory() {
            const paidInvoices = quoteInvoices.filter(inv => inv.paidAmount > 0 && inv.status !== 'cancelled');

            if (paidInvoices.length === 0) {
                alert('No payment history available.');
                return;
            }

            let historyText = 'Payment History:\\n\\n';
            paidInvoices.forEach(invoice => {
                historyText += `${invoice.id}: $${invoice.paidAmount.toFixed(2)}`;
                if (invoice.paymentDate) {
                    historyText += ` (${new Date(invoice.paymentDate).toLocaleDateString()})`;
                }
                historyText += '\\n';
            });

            alert(historyText);
            // In real implementation, open a detailed payment history modal
        }

        function downloadInvoiceReport() {
            alert('Invoice report download would be implemented here.');
            // In real implementation, generate and download PDF report
        }

        function createDepositInvoice() {
            const remainingAmount = getRemainingToInvoice();

            if (remainingAmount <= 0) {
                alert('This quote has already been fully invoiced. You cannot create additional invoices beyond 100% of the quote amount.');
                return;
            }

            const paymentModel = document.querySelector('input[name="paymentModel"]:checked')?.value;

            if (paymentModel !== 'deposit') {
                alert('Please configure deposit settings in the Payment Configuration tab first.');
                switchTab('paymentConfig');
                return;
            }

            const depositAmount = parseFloat(document.getElementById('depositAmount')?.value) || 0;

            if (depositAmount <= 0) {
                alert('Please set a valid deposit amount in the Payment Configuration tab.');
                switchTab('paymentConfig');
                return;
            }

            // Ensure deposit amount doesn't exceed remaining amount
            const actualDepositAmount = Math.min(depositAmount, remainingAmount);

            if (actualDepositAmount < depositAmount) {
                if (!confirm(`The configured deposit amount ($${depositAmount.toFixed(2)}) exceeds the remaining invoiceable amount ($${remainingAmount.toFixed(2)}). Create a deposit invoice for $${actualDepositAmount.toFixed(2)} instead?`)) {
                    return;
                }
            } else {
                if (!confirm(`Create a deposit invoice for $${actualDepositAmount.toFixed(2)}?`)) {
                    return;
                }
            }

            const quoteId = document.getElementById('quoteIdBadge').textContent;
            window.location.href = `invoice_create_simple.html?quoteId=${quoteId}&type=deposit&amount=${actualDepositAmount}`;
        }

        // ============================================================================
        // INVOICE PREVIEW FUNCTIONALITY
        // ============================================================================

        function showInvoicePreview() {
            const remainingAmount = getRemainingToInvoice();

            if (remainingAmount <= 0) {
                alert('This quote has already been fully invoiced. You cannot create additional invoices beyond 100% of the quote amount.');
                return;
            }

            // Note: Payer assignment happens AFTER invoice creation, not in preview
            // Invoices are created independently, then payers can be assigned

            const paymentModel = document.querySelector('input[name="paymentModel"]:checked')?.value || 'full';
            const quoteTotal = calculateTotal();
            const invoicesToCreate = generateInvoicePreview(paymentModel, quoteTotal);

            if (invoicesToCreate.length === 0) {
                alert('No invoices to create. Please configure payment settings first.');
                return;
            }

            // Store preview invoices for later creation
            previewInvoices = invoicesToCreate.filter(inv => !inv.isPlaceholder);

            renderInvoicePreview(invoicesToCreate);
            document.getElementById('invoicePreviewModal').classList.remove('hidden');
        }

        function generateInvoicePreview(paymentModel, quoteTotal) {
            const invoices = [];
            const today = new Date();
            const quoteId = document.getElementById('quoteIdBadge').textContent;

            // Get primary contact (quote contact) for default assignment
            const quoteContact = state.selectedQuoteContact || state.quoteContact;
            const primaryPayer = quoteContact ? {
                payerId: 'primary-contact',
                name: quoteContact.name || 'Primary Contact',
                email: quoteContact.email || '',
                assignedPercentage: 100,
                assignedAmount: 0, // Will be set per invoice
                assignedAt: new Date().toISOString(),
                isPrimary: true,
                paidAmount: 0,
                outstandingAmount: 0, // Will be set per invoice
                paymentStatus: 'unpaid',
                payments: [],
                lastPaymentDate: null
            } : null;

            // Invoice generation is independent of payer configuration
            // But primary contact is auto-assigned by default

            if (paymentModel === 'full') {
                const remainingAmount = getRemainingToInvoice();
                if (remainingAmount > 0) {
                    // Create ONE invoice for the full amount (regardless of multiple payers)
                    // Multiple payers can make payments toward this single invoice
                    const fullInvoice = {
                        id: `INV-${new Date().getFullYear()}-${String(Date.now()).slice(-3)}`,
                        type: 'Full Invoice',
                        description: 'Invoice for complete quote amount',
                        amount: remainingAmount,
                        dueDate: calculateDueDate(today),
                        items: state.quoteItems,
                        color: 'purple',
                        status: 'assigned', // Default to 'assigned' if primary contact is auto-assigned
                        paidAmount: 0,
                        // NEW: Payer assignment - primary contact assigned by default
                        assignedPayers: primaryPayer ? [{
                            ...primaryPayer,
                            assignedAmount: remainingAmount,
                            outstandingAmount: remainingAmount
                        }] : [],
                        // Payment history with confirmation tracking
                        paymentHistory: []
                    };
                    invoices.push(fullInvoice);
                }
            } else if (paymentModel === 'deposit') {
                const remainingToInvoice = getRemainingToInvoice();
                const depositAmount = parseFloat(document.getElementById('depositAmount')?.value) || 0;

                // Check if deposit invoices already exist
                const activeInvoices = quoteInvoices.filter(inv => inv.status !== 'cancelled');
                const existingDepositInvoices = activeInvoices.filter(inv => inv.type === 'deposit');
                const totalDepositInvoiced = existingDepositInvoices.reduce((sum, inv) => sum + inv.amount, 0);

                // Check if deposit is fully invoiced (with small tolerance for rounding)
                const depositFullyInvoiced = totalDepositInvoiced >= depositAmount - 0.01;

                // FIRST TIME: Only show deposit invoices if deposit is not fully invoiced
                // LATER: Only show balance invoices if deposit is fully invoiced
                if (!depositFullyInvoiced) {
                    // Create deposit invoices only (first time)
                    const remainingDepositAmount = Math.max(0, depositAmount - totalDepositInvoiced);
                    const actualDepositAmount = Math.min(remainingDepositAmount, remainingToInvoice);

                    if (actualDepositAmount > 0.01) {
                        // Create ONE deposit invoice (regardless of multiple payers)
                        // Multiple payers can make payments toward this single deposit invoice
                        const depositInvoice = {
                            id: `INV-${new Date().getFullYear()}-${String(Date.now()).slice(-3)}`,
                            type: 'Deposit Invoice',
                            description: 'Down payment invoice',
                            amount: actualDepositAmount,
                            dueDate: calculateDueDate(today),
                            items: state.quoteItems.map(item => ({ ...item, isDeposit: true })),
                            color: 'blue',
                            status: primaryPayer ? 'assigned' : 'unassigned',
                            paidAmount: 0,
                            assignedPayers: primaryPayer ? [{
                                ...primaryPayer,
                                assignedAmount: actualDepositAmount,
                                outstandingAmount: actualDepositAmount
                            }] : [],
                            paymentHistory: []
                        };
                        invoices.push(depositInvoice);
                    }
                } else {
                    // Deposit is fully invoiced, now show balance invoices (later)
                    // Check if balance invoices already exist
                    const existingBalanceInvoices = activeInvoices.filter(inv => inv.type === 'partial');
                    const totalBalanceInvoiced = existingBalanceInvoices.reduce((sum, inv) => sum + inv.amount, 0);

                    // Calculate how much balance still needs to be invoiced
                    const quoteTotalForBalance = calculateTotal();
                    const totalAllInvoiced = activeInvoices.reduce((sum, inv) => sum + inv.amount, 0);
                    const remainingBalanceToInvoice = Math.max(0, quoteTotalForBalance - totalAllInvoiced);

                    if (remainingBalanceToInvoice > 0.01) {
                        const balanceDueDate = new Date(today);
                        balanceDueDate.setDate(balanceDueDate.getDate() + 30); // 30 days after deposit

                        // Create ONE balance invoice (regardless of multiple payers)
                        // Multiple payers can make payments toward this single balance invoice
                        const balanceInvoice = {
                            id: `INV-${new Date().getFullYear()}-${String(Date.now() + 1).slice(-3)}`,
                            type: 'Balance Invoice',
                            description: 'Remaining balance after deposit',
                            amount: remainingBalanceToInvoice,
                            dueDate: calculateDueDate(balanceDueDate),
                            items: state.quoteItems.map(item => ({ ...item, isBalance: true })),
                            color: 'green',
                            status: primaryPayer ? 'assigned' : 'unassigned',
                            paidAmount: 0,
                            assignedPayers: primaryPayer ? [{
                                ...primaryPayer,
                                assignedAmount: remainingBalanceToInvoice,
                                outstandingAmount: remainingBalanceToInvoice
                            }] : [],
                            paymentHistory: []
                        };
                        invoices.push(balanceInvoice);
                    }
                }
            } else if (paymentModel === 'subscription') {
                const remainingToInvoice = getRemainingToInvoice();

                if (remainingToInvoice <= 0) {
                    return invoices; // No invoices to create if already fully invoiced
                }

                const frequency = document.getElementById('billingFrequency')?.value || 'monthly';
                const startDate = new Date(document.getElementById('subscriptionStartDate')?.value || today);
                const endType = document.getElementById('subscriptionEnd')?.value || 'ongoing';

                let cycles = 12; // Default to 12 cycles for preview
                if (endType === 'after_cycles') {
                    cycles = parseInt(document.getElementById('billingCycles')?.value) || 12;
                } else if (endType === 'end_date') {
                    const endDate = new Date(document.getElementById('subscriptionEndDate')?.value);
                    cycles = calculateCyclesBetweenDates(startDate, endDate, frequency);
                }

                const cycleAmount = remainingToInvoice / cycles;

                for (let i = 0; i < Math.min(cycles, 6); i++) { // Show max 6 invoices in preview
                    const invoiceDate = new Date(startDate);
                    addTimeToDate(invoiceDate, frequency, i);

                    const subscriptionInvoice = {
                        id: `INV-${new Date().getFullYear()}-${String(Date.now() + i).slice(-3)}`,
                        type: `Subscription Invoice #${i + 1}`,
                        description: `${frequency.charAt(0).toUpperCase() + frequency.slice(1)} recurring invoice`,
                        amount: cycleAmount,
                        dueDate: calculateDueDate(invoiceDate),
                        items: state.quoteItems.map(item => ({ ...item, isSubscription: true, cycle: i + 1 })),
                        color: 'indigo',
                        status: primaryPayer ? 'assigned' : 'unassigned',
                        paidAmount: 0,
                        assignedPayers: primaryPayer ? [{
                            ...primaryPayer,
                            assignedAmount: cycleAmount,
                            outstandingAmount: cycleAmount
                        }] : [],
                        paymentHistory: []
                    };
                    invoices.push(subscriptionInvoice);
                }

                if (cycles > 6) {
                    invoices.push({
                        id: '...',
                        type: `+ ${cycles - 6} more invoices`,
                        description: `Total of ${cycles} subscription invoices`,
                        amount: cycleAmount * (cycles - 6),
                        dueDate: '...',
                        items: [],
                        color: 'gray',
                        isPlaceholder: true
                    });
                }
            }

            return invoices;
        }

        // Get payment model display name (matches Payment Configuration tab)
        function getPaymentModelDisplayName(modelValue) {
            const modelMap = {
                'full': 'Full Payment (Upfront)',
                'deposit': 'Down Payment (Deposit)',
                'subscription': 'Subscription (Recurring)'
            };
            return modelMap[modelValue] || modelValue.charAt(0).toUpperCase() + modelValue.slice(1);
        }

        function formatCurrency(amount) {
            const value = Number(amount) || 0;
            return `$${value.toFixed(2)}`;
        }

        function getQuoteFinancialTotals() {
            const discounts = calculateLineItemDiscounts();
            const netSubtotal = calculateSubtotal();
            const grossSubtotal = netSubtotal + discounts;
            const tax = calculateTax();
            const total = netSubtotal + tax;
            return {
                grossSubtotal,
                discounts,
                netSubtotal,
                tax,
                total
            };
        }

        function getInvoiceBreakdown(invoiceAmount, quoteTotals) {
            const totals = quoteTotals || getQuoteFinancialTotals();
            if (!totals || totals.total === 0) {
                return {
                    grossSubtotal: 0,
                    discounts: 0,
                    netSubtotal: 0,
                    tax: 0,
                    total: invoiceAmount || 0
                };
            }
            const proportion = invoiceAmount ? (invoiceAmount / totals.total) : 0;
            const grossSubtotal = totals.grossSubtotal * proportion;
            const discounts = totals.discounts * proportion;
            const netSubtotal = totals.netSubtotal * proportion;
            const tax = totals.tax * proportion;
            const total = netSubtotal + tax;
            return {
                grossSubtotal,
                discounts,
                netSubtotal,
                tax,
                total
            };
        }

        function getQuoteSummaryDetails() {
            const netSubtotal = calculateSubtotal();
            const discounts = calculateLineItemDiscounts();
            const grossSubtotal = netSubtotal + discounts;
            const taxBreakdown = getTaxBreakdown();
            const totalTax = calculateTax();
            const total = netSubtotal + totalTax;
            const items = state.quoteItems.map(item => {
                const lineTotal = item.customPrice * item.quantity;
                const discountAmount = item.discountType === 'percentage'
                    ? lineTotal * (item.discount / 100)
                    : item.discount;
                const finalAmount = lineTotal - discountAmount;
                return {
                    name: item.name,
                    quantity: item.quantity,
                    unit: item.unit || item.pricingType || '',
                    amount: finalAmount
                };
            });
            return {
                grossSubtotal,
                netSubtotal,
                discounts,
                taxBreakdown,
                totalTax,
                total,
                items
            };
        }

        function getPaymentTermsLabelForPreview() {
            const termsMap = {
                'due_on_receipt': 'Due on Receipt',
                'net_7': 'Net 7 Days',
                'net_15': 'Net 15 Days',
                'net_30': 'Net 30 Days',
                'net_60': 'Net 60 Days'
            };
            const terms = document.getElementById('defaultPaymentTerms')?.value || 'net_30';
            return termsMap[terms] || 'Net 30 Days';
        }

        function getInvoiceCoverageText(invoice) {
            if (invoice.payer?.percentage) {
                return `${invoice.payer.percentage}% share billed to ${invoice.payer.name}`;
            }
            if (invoice.items && invoice.items.length) {
                const firstItem = invoice.items[0];
                if (firstItem.isDeposit) {
                    return 'Deposit portion across all quote items';
                }
                if (firstItem.isBalance) {
                    return 'Remaining balance across all quote items';
                }
                if (firstItem.isSubscription) {
                    const cycle = firstItem.cycle || 1;
                    return `Subscription cycle #${cycle} covering scheduled services`;
                }
            }
            if (invoice.type?.toLowerCase().includes('full')) {
                return 'Full quote items';
            }
            return 'Quote items as listed in the overview';
        }

        function getCoverageStatusMessage(totalPreviewed, quoteTotal) {
            if (!quoteTotal || quoteTotal <= 0) {
                return '';
            }
            const diff = quoteTotal - totalPreviewed;
            const coveragePercent = Math.min(Math.max((totalPreviewed / quoteTotal) * 100, 0), 999);
            if (Math.abs(diff) < 0.01) {
                return `<span class="text-green-700 font-medium">Preview covers 100% of the quote total.</span>`;
            }
            if (diff > 0) {
                return `<span class="text-yellow-700 font-medium">Preview covers ${coveragePercent.toFixed(0)}% of the quote total. Remaining ${formatCurrency(diff)} still needs invoices.</span>`;
            }
            return `<span class="text-red-700 font-medium">Preview exceeds the quote total by ${formatCurrency(Math.abs(diff))}. Adjust invoice amounts before generating.</span>`;
        }

        function renderInvoicePreview(invoices) {
            const content = document.getElementById('invoicePreviewContent');
            const totalAmount = invoices.reduce((sum, inv) => sum + (inv.isPlaceholder ? 0 : inv.amount), 0);

            const validInvoices = invoices.filter(inv => !inv.isPlaceholder);
            const paymentModel = document.querySelector('input[name="paymentModel"]:checked')?.value || 'full';
            const paymentModelDisplay = getPaymentModelDisplayName(paymentModel);
            const hasMultiplePayers = distributionPayers && distributionPayers.length > 1;
            const quoteTotals = getQuoteFinancialTotals();
            window.previewQuoteTotal = quoteTotals.total;
            const quoteSummary = getQuoteSummaryDetails();
            const taxBreakdownLines = [];
            if (quoteSummary.taxBreakdown.taxable_gst > 0) {
                taxBreakdownLines.push(`<div class="flex justify-between"><span>GST (10%):</span><span>${formatCurrency(quoteSummary.taxBreakdown.taxable_gst)}</span></div>`);
            }
            if (quoteSummary.taxBreakdown.gst_free > 0) {
                taxBreakdownLines.push(`<div class="flex justify-between text-gray-500"><span>GST-Free:</span><span>${formatCurrency(0)}</span></div>`);
            }
            if (quoteSummary.taxBreakdown.input_taxed > 0) {
                taxBreakdownLines.push(`<div class="flex justify-between text-gray-500"><span>Input-Taxed:</span><span>${formatCurrency(0)}</span></div>`);
            }
            const quoteSummaryMetrics = `
                <div class="space-y-2 text-sm text-gray-700">
                    <div class="flex justify-between">
                        <span>Subtotal</span>
                        <span>${formatCurrency(quoteSummary.grossSubtotal)}</span>
                    </div>
                    <div class="flex justify-between text-red-600">
                        <span>Line Item Discounts</span>
                        <span>- ${formatCurrency(quoteSummary.discounts)}</span>
                    </div>
                    <div class="flex justify-between font-medium">
                        <span>Net Subtotal</span>
                        <span>${formatCurrency(quoteSummary.netSubtotal)}</span>
                    </div>
                    <div class="pt-2 border-t border-gray-200 space-y-1">
                        <div class="text-xs text-gray-500 uppercase tracking-wide">Tax Breakdown:</div>
                        ${taxBreakdownLines.length ? taxBreakdownLines.join('') : `<div class="text-xs text-gray-400">No taxable items</div>`}
                        <div class="flex justify-between font-medium mt-1">
                            <span>Total Tax</span>
                            <span>${formatCurrency(quoteSummary.totalTax)}</span>
                        </div>
                    </div>
                    <div class="flex justify-between items-center border-t-2 border-gray-300 pt-3">
                        <span class="font-bold text-gray-900 text-base">Total</span>
                        <span class="font-bold text-gray-900 text-base">${formatCurrency(quoteSummary.total)}</span>
                    </div>
                </div>
            `;
            const quoteItemsList = quoteSummary.items.length
                ? `
                    <div class="space-y-2">
                        ${quoteSummary.items.map(item => `
                            <div class="flex items-center justify-between p-2 bg-white rounded-lg border border-gray-200 text-sm">
                                <div>
                                    <p class="font-medium text-gray-900">${item.name}</p>
                                    <p class="text-xs text-gray-500">${item.quantity} ${item.unit || ''}</p>
                                </div>
                                <div class="font-semibold text-gray-900">${formatCurrency(item.amount)}</div>
                            </div>
                        `).join('')}
                    </div>
                `
                : '<p class="text-sm text-gray-500">No line items added yet.</p>';
            const coverageMessage = getCoverageStatusMessage(totalAmount, quoteTotals.total);

            // Add selection state to each invoice
            invoices.forEach((inv, index) => {
                if (!inv.isPlaceholder) {
                    inv.selected = true; // Default to selected
                    inv.index = index;
                }
            });

            // Get customer info for invoice header
            const customerName = state.selectedCustomer ? state.selectedCustomer.name : 'Customer';
            const customerEmail = state.selectedCustomer ? state.selectedCustomer.email : '';
            const quoteId = document.getElementById('quoteIdBadge')?.textContent || 'Q-2024-001';
            const invoiceDate = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
            const paymentTerms = getPaymentTermsLabelForPreview();

            content.innerHTML = `
                ${invoices.map((invoice, index) => {
                if (invoice.isPlaceholder) return '';

                // Calculate invoice breakdown
                const invoiceBreakdown = getInvoiceBreakdown(invoice.amount, quoteTotals);

                return `
                        <div class="bg-white border border-gray-300 rounded-lg shadow-sm mb-6" style="max-width: 800px; margin: 0 auto;">
                            <!-- Invoice Header -->
                            <div class="border-b-2 border-gray-300 p-6">
                                <div class="flex justify-between items-start mb-6">
                                    <div>
                                        <h1 class="text-3xl font-bold text-gray-900 mb-2">INVOICE</h1>
                                        <div class="text-sm text-gray-600">
                                            <div>Invoice #: <span class="font-semibold text-gray-900">${invoice.id}</span></div>
                                            <div>Date: <span class="font-semibold text-gray-900">${invoiceDate}</span></div>
                                            ${quoteId ? `<div>Quote #: <span class="font-semibold text-gray-900">${quoteId}</span></div>` : ''}
                                </div>
                                </div>
                                    <div class="text-right">
                                        <div class="text-3xl font-bold text-gray-900 mb-1">${formatCurrency(invoice.amount)}</div>
                                        <div class="text-sm text-gray-600">Due: ${formatDueDateForDisplay(invoice.dueDate)}</div>
                                        <div class="text-xs text-gray-500 mt-1">${paymentTerms}</div>
                            </div>
                        </div>
                                
                                <!-- Bill To Section -->
                                <div class="grid grid-cols-2 gap-6 mt-4">
                                    <div>
                                        <h3 class="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-2">Bill To</h3>
                                        <div class="text-sm text-gray-900">
                                            <div class="font-semibold">${customerName}</div>
                                            ${customerEmail ? `<div class="text-gray-600">${customerEmail}</div>` : ''}
                        </div>
                    </div>
                                    <div>
                                        <h3 class="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-2">Invoice Type</h3>
                                        <div class="text-sm text-gray-900 font-medium">${invoice.type}</div>
                        </div>
                    </div>
                </div>
                
                            <!-- Line Items -->
                            <div class="p-6">
                                <table class="w-full">
                                    <thead>
                                        <tr class="border-b-2 border-gray-300">
                                            <th class="text-left py-3 px-4 text-xs font-semibold text-gray-700 uppercase tracking-wide">Description</th>
                                            <th class="text-right py-3 px-4 text-xs font-semibold text-gray-700 uppercase tracking-wide">Quantity</th>
                                            <th class="text-right py-3 px-4 text-xs font-semibold text-gray-700 uppercase tracking-wide">Unit Price</th>
                                            <th class="text-right py-3 px-4 text-xs font-semibold text-gray-700 uppercase tracking-wide">Amount</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${quoteSummary.items.map(item => `
                                            <tr class="border-b border-gray-200">
                                                <td class="py-3 px-4 text-sm text-gray-900">${item.name}</td>
                                                <td class="py-3 px-4 text-sm text-gray-600 text-right">${item.quantity} ${item.unit || ''}</td>
                                                <td class="py-3 px-4 text-sm text-gray-600 text-right">${formatCurrency(item.amount / item.quantity)}</td>
                                                <td class="py-3 px-4 text-sm font-semibold text-gray-900 text-right">${formatCurrency(item.amount)}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                                
                                <!-- Totals -->
                                <div class="mt-6 flex justify-end">
                                    <div class="w-64 space-y-2">
                                        <div class="flex justify-between text-sm text-gray-600">
                                            <span>Subtotal</span>
                                            <span>${formatCurrency(invoiceBreakdown.netSubtotal)}</span>
                                                </div>
                                        ${invoiceBreakdown.discounts > 0 ? `
                                            <div class="flex justify-between text-sm text-red-600">
                                                <span>Discounts</span>
                                                <span>-${formatCurrency(invoiceBreakdown.discounts)}</span>
                                                </div>
                                        ` : ''}
                                        ${invoiceBreakdown.tax > 0 ? `
                                            <div class="flex justify-between text-sm text-gray-600">
                                                <span>Tax</span>
                                                <span>${formatCurrency(invoiceBreakdown.tax)}</span>
                                            </div>
                                        ` : ''}
                                        <div class="flex justify-between items-center pt-3 border-t-2 border-gray-300">
                                            <span class="text-lg font-bold text-gray-900">Total</span>
                                            <span class="text-2xl font-bold text-gray-900">${formatCurrency(invoice.amount)}</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                            
                            <!-- Footer -->
                            <div class="border-t border-gray-200 bg-gray-50 p-4">
                                <div class="text-xs text-gray-500 text-center">
                                    ${invoice.description || 'Thank you for your business'}
                                </div>
                        </div>
                </div>
                    `;
            }).join('')}
            `;

            // Store invoices in previewInvoices for generation
            previewInvoices = invoices.filter(inv => !inv.isPlaceholder);
        }


        function calculateDueDate(fromDate) {
            const terms = document.getElementById('defaultPaymentTerms')?.value || 'net_30';
            const dueDate = new Date(fromDate);

            switch (terms) {
                case 'due_on_receipt':
                    // Return Date object for internal use, string for display
                    return dueDate;
                case 'net_7':
                    dueDate.setDate(dueDate.getDate() + 7);
                    break;
                case 'net_15':
                    dueDate.setDate(dueDate.getDate() + 15);
                    break;
                case 'net_30':
                    dueDate.setDate(dueDate.getDate() + 30);
                    break;
                case 'net_60':
                    dueDate.setDate(dueDate.getDate() + 60);
                    break;
            }

            // Return Date object instead of string
            return dueDate;
        }

        // Helper function to format date for display
        function formatDueDateForDisplay(date) {
            if (!date) return '';
            if (date instanceof Date) {
                return date.toLocaleDateString();
            }
            return date;
        }

        function calculateCyclesBetweenDates(startDate, endDate, frequency) {
            const diffTime = Math.abs(endDate - startDate);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            switch (frequency) {
                case 'weekly': return Math.floor(diffDays / 7);
                case 'biweekly': return Math.floor(diffDays / 14);
                case 'monthly': return Math.floor(diffDays / 30);
                case 'quarterly': return Math.floor(diffDays / 90);
                case 'yearly': return Math.floor(diffDays / 365);
                default: return 12;
            }
        }

        function addTimeToDate(date, frequency, multiplier) {
            switch (frequency) {
                case 'weekly':
                    date.setDate(date.getDate() + (7 * multiplier));
                    break;
                case 'biweekly':
                    date.setDate(date.getDate() + (14 * multiplier));
                    break;
                case 'monthly':
                    date.setMonth(date.getMonth() + multiplier);
                    break;
                case 'quarterly':
                    date.setMonth(date.getMonth() + (3 * multiplier));
                    break;
                case 'yearly':
                    date.setFullYear(date.getFullYear() + multiplier);
                    break;
            }
        }

        function hideInvoicePreview() {
            document.getElementById('invoicePreviewModal').classList.add('hidden');
        }

        function createAllInvoicesFromPreview() {
            if (!previewInvoices || previewInvoices.length === 0) {
                showToast('There are no invoices to create. Generate a preview first.', 'error');
                return;
            }

            const totalAmount = previewInvoices.reduce((sum, inv) => sum + inv.amount, 0);
            const invoiceCount = previewInvoices.length;
            const paymentModel = document.querySelector('input[name="paymentModel"]:checked')?.value || 'full';

            // Confirmation dialog removed - The "Confirm & Publish" button is explicit enough
            // if (!confirm(confirmationMessage)) {
            //    return;
            // }

            // Generate invoice IDs and create invoices
            const today = new Date();
            const invoiceIdPrefix = `INV-${today.getFullYear()}-`;
            let invoiceCounter = 1;

            // Get the highest existing invoice number to continue sequence
            const existingInvoiceNumbers = quoteInvoices
                .map(inv => {
                    const match = inv.id.match(/INV-\d{4}-(\d+)/);
                    return match ? parseInt(match[1]) : 0;
                })
                .filter(num => num > 0);
            const maxInvoiceNumber = existingInvoiceNumbers.length > 0 ? Math.max(...existingInvoiceNumbers) : 0;
            invoiceCounter = maxInvoiceNumber + 1;

            // Create only selected invoices from preview with diverse statuses for testing
            const newInvoices = previewInvoices.map((previewInv, index) => {
                const invoiceId = `${invoiceIdPrefix}${String(invoiceCounter++).padStart(3, '0')}`;

                // Parse dueDate - handle both Date objects and date strings
                let dueDate;
                if (previewInv.dueDate instanceof Date) {
                    // Already a Date object
                    dueDate = new Date(previewInv.dueDate);
                } else {
                    // Try to parse the date string or use today as fallback
                    dueDate = new Date(previewInv.dueDate);
                    // If parsing failed, use today's date as fallback
                    if (isNaN(dueDate.getTime())) {
                        console.warn(`Invalid dueDate for invoice ${invoiceId}, using today's date as fallback`);
                        dueDate = new Date();
                        // Apply payment terms to the fallback date
                        const terms = document.getElementById('defaultPaymentTerms')?.value || 'net_30';
                        switch (terms) {
                            case 'net_7':
                                dueDate.setDate(dueDate.getDate() + 7);
                                break;
                            case 'net_15':
                                dueDate.setDate(dueDate.getDate() + 15);
                                break;
                            case 'net_30':
                                dueDate.setDate(dueDate.getDate() + 30);
                                break;
                            case 'net_60':
                                dueDate.setDate(dueDate.getDate() + 60);
                                break;
                        }
                    }
                }

                // Use a combination of index and amount to create varied patterns
                const randomFactor = (index * 7 + Math.floor(previewInv.amount)) % 10;

                // Determine invoice type
                let invoiceType = 'full';
                if (previewInv.type.includes('Deposit')) {
                    invoiceType = 'deposit';
                } else if (previewInv.type.includes('Balance')) {
                    invoiceType = 'partial';
                } else if (previewInv.type.includes('Subscription')) {
                    invoiceType = 'subscription';
                }

                // Assign diverse statuses for testing (create realistic mix)
                // Distribution: ~25% paid, ~75% unpaid (with some partially paid)
                let assignedStatus = 'unpaid';
                let paidAmount = 0;

                if (randomFactor < 2) {
                    // 20% fully paid
                    assignedStatus = 'paid';
                    paidAmount = previewInv.amount;
                } else if (randomFactor === 2 || randomFactor === 3) {
                    // 20% partially paid (30-70% of amount)
                    assignedStatus = 'unpaid';
                    paidAmount = previewInv.amount * (0.3 + Math.random() * 0.4);
                    paidAmount = Math.round(paidAmount * 100) / 100; // Round to 2 decimals
                } else {
                    // 60% fully unpaid
                    assignedStatus = 'unpaid';
                    paidAmount = 0;
                }

                // Make some unpaid invoices overdue for testing (about 15% of unpaid invoices)
                if (assignedStatus === 'unpaid' && randomFactor === 4 && index % 3 === 0) {
                    // Make some unpaid invoices overdue (past due date)
                    const daysOverdue = 5 + Math.floor(Math.random() * 20); // 5-25 days overdue
                    dueDate.setDate(dueDate.getDate() - daysOverdue);
                }

                // Ensure primary contact is assigned if not already assigned
                let assignedPayers = previewInv.assignedPayers || [];
                const quoteContact = state.selectedQuoteContact || state.quoteContact;

                // Check if primary contact is already assigned
                const hasPrimary = assignedPayers.some(ap =>
                    ap.isPrimary ||
                    ap.payerId === 'primary-contact' ||
                    (ap.email && quoteContact?.email && ap.email === quoteContact.email) ||
                    (ap.name === quoteContact?.name && quoteContact)
                );

                // Auto-assign primary contact if not present
                if (!hasPrimary && quoteContact) {
                    assignedPayers = [{
                        payerId: 'primary-contact',
                        name: quoteContact.name || 'Primary Contact',
                        email: quoteContact.email || '',
                        assignedPercentage: 100,
                        assignedAmount: previewInv.amount,
                        assignedAt: new Date().toISOString(),
                        isPrimary: true,
                        paidAmount: 0,
                        outstandingAmount: previewInv.amount,
                        paymentStatus: 'unpaid',
                        payments: [],
                        lastPaymentDate: null
                    }];
                }

                // Update status based on assigned payers
                let finalStatus = assignedStatus;
                if (assignedPayers.length > 0 && finalStatus === 'unpaid') {
                    finalStatus = 'assigned';
                }

                const newInvoice = {
                    id: invoiceId,
                    type: invoiceType,
                    amount: previewInv.amount,
                    status: finalStatus,
                    paidAmount: paidAmount,
                    dueDate: dueDate.toISOString().split('T')[0],
                    createdDate: today.toISOString().split('T')[0],
                    // Store payer information if available
                    payer: previewInv.payer ? {
                        name: previewInv.payerName,
                        email: previewInv.payerEmail,
                        percentage: previewInv.payer?.percentage
                    } : null,
                    // Store payment method from configuration
                    paymentMethod: document.querySelector('input[name="paymentMethod"]:checked')?.value || null,
                    // Store payment terms
                    paymentTerms: document.getElementById('defaultPaymentTerms')?.value || 'net_30',
                    // Store items reference
                    items: previewInv.items || [],
                    // Auto-assign primary contact by default
                    assignedPayers: assignedPayers,
                    paymentHistory: previewInv.paymentHistory || [],
                    activityLog: [] // Initialize activity log
                };

                return newInvoice;
            });

            // Add new invoices to quoteInvoices array
            quoteInvoices.push(...newInvoices);

            // Log invoice creation activity AFTER invoices are added to quoteInvoices
            newInvoices.forEach(invoice => {
                logInvoiceActivity(invoice.id, 'created',
                    `Invoice created: ${invoice.type} for $${invoice.amount.toFixed(2)}`,
                    {
                        type: invoice.type,
                        amount: invoice.amount,
                        status: invoice.status,
                        dueDate: invoice.dueDate,
                        payerCount: invoice.assignedPayers ? invoice.assignedPayers.length : 0,
                        payers: invoice.assignedPayers ? invoice.assignedPayers.map(p => p.name) : []
                    }
                );
            });

            // Clear preview invoices
            previewInvoices = [];

            // Update global activity log and invoice display

            loadInvoices();
            updateInvoiceSummary();

            // Show success message
            // Show success message
            let successMessage = `âœ… Successfully created ${newInvoices.length} invoice(s)! Total Amount: $${totalAmount.toFixed(2)}`;
            showToast(successMessage, 'success', 5000);

            // Close modal after creation
            hideInvoicePreview();

            // Switch to Invoices tab to show the newly created invoices
            switchTab('invoices');
        }

        // ============================================================================
        // SPLIT INVOICE FUNCTIONALITY
        // ============================================================================

        let splitInvoiceEnabled = true; // Always enabled now
        let splitMethod = 'percentage'; // 'percentage' or 'amount'
        let payers = [];
        let payerIdCounter = 1;

        function initializeSplitInvoice() {
            // Check if split invoice elements exist
            const splitByPercentage = document.getElementById('splitByPercentage');
            const splitByAmount = document.getElementById('splitByAmount');
            const addPayerBtn = document.getElementById('addPayerBtn');

            if (!splitByPercentage || !splitByAmount || !addPayerBtn) {
                // Split invoice elements don't exist, skip initialization
                return;
            }

            // Add default 2 payers on initialization
            if (payers.length === 0) {
                addPayer();
                addPayer();
            }

            // Split Method Buttons
            splitByPercentage.addEventListener('click', function () {
                splitMethod = 'percentage';
                this.classList.add('bg-purple-600', 'text-white');
                this.classList.remove('bg-white', 'border', 'border-gray-300', 'text-gray-700');

                const amountBtn = document.getElementById('splitByAmount');
                if (amountBtn) {
                    amountBtn.classList.remove('bg-purple-600', 'text-white');
                    amountBtn.classList.add('bg-white', 'border', 'border-gray-300', 'text-gray-700');
                }

                renderPayers();
            });

            splitByAmount.addEventListener('click', function () {
                splitMethod = 'amount';
                this.classList.add('bg-purple-600', 'text-white');
                this.classList.remove('bg-white', 'border', 'border-gray-300', 'text-gray-700');

                const percentBtn = document.getElementById('splitByPercentage');
                if (percentBtn) {
                    percentBtn.classList.remove('bg-purple-600', 'text-white');
                    percentBtn.classList.add('bg-white', 'border', 'border-gray-300', 'text-gray-700');
                }

                renderPayers();
            });

            // Add Payer Button
            addPayerBtn.addEventListener('click', addPayer);
        }

        function addPayer() {
            const payer = {
                id: payerIdCounter++,
                name: '',
                email: '',
                phone: '',
                value: splitMethod === 'percentage' ? 50 : 0
            };
            payers.push(payer);
            renderPayers();
            updateSplitSummary();
        }

        function removePayer(payerId) {
            payers = payers.filter(p => p.id !== payerId);
            renderPayers();
            updateSplitSummary();
        }

        function renderPayers() {
            const container = document.getElementById('payersList');
            container.innerHTML = '';

            payers.forEach((payer, index) => {
                const payerCard = createPayerCard(payer, index);
                container.appendChild(payerCard);
            });
        }

        function createPayerCard(payer, index) {
            const div = document.createElement('div');
            div.className = 'border border-gray-300 rounded-lg p-3 bg-gray-50';

            const inputLabel = splitMethod === 'percentage' ? '%' : '$';
            const inputPlaceholder = splitMethod === 'percentage' ? '50' : '0.00';

            // Generate contact options from existing customer data
            let contactOptions = '<option value="">-- Select Existing Contact or Add New --</option>';
            if (state.selectedCustomer && state.selectedCustomer.secondaryContacts) {
                // Add primary contact
                contactOptions += `<option value="primary">${state.selectedCustomer.name} (Primary)</option>`;

                // Add secondary contacts
                state.selectedCustomer.secondaryContacts.forEach((contact, idx) => {
                    contactOptions += `<option value="secondary-${idx}">${contact.name} - ${contact.role}</option>`;
                });
            }
            contactOptions += '<option value="new">+ Add New Contact</option>';

            div.innerHTML = `
                <div class="flex items-center justify-between mb-3">
                    <span class="text-sm font-medium text-gray-700">Payer ${index + 1}</span>
                    ${payers.length > 1 ? `
                        <button 
                            onclick="removePayer(${payer.id})"
                            class="text-red-600 hover:text-red-700 text-sm"
                        >
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                            </svg>
                        </button>
                    ` : ''}
                </div>
                <div class="space-y-2">
                    <!-- Contact Selector -->
                    <div>
                        <label class="block text-xs text-gray-600 mb-1">Select Contact</label>
                        <select 
                            id="contactSelect-${payer.id}"
                            onchange="selectContact(${payer.id}, this.value)"
                            class="w-full px-2 py-1.5 border border-gray-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-purple-500 bg-white"
                        >
                            ${contactOptions}
                        </select>
                    </div>
                    
                    <!-- Manual Input Fields -->
                    <div id="manualFields-${payer.id}">
                        <input 
                            type="text" 
                            placeholder="Name"
                            value="${payer.name}"
                            onchange="updatePayerField(${payer.id}, 'name', this.value)"
                            class="w-full px-2 py-1.5 border border-gray-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-purple-500"
                        />
                        <input 
                            type="email" 
                            placeholder="Email"
                            value="${payer.email}"
                            onchange="updatePayerField(${payer.id}, 'email', this.value)"
                            class="w-full px-2 py-1.5 border border-gray-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-purple-500 mt-2"
                        />
                        <input 
                            type="tel" 
                            placeholder="Phone (optional)"
                            value="${payer.phone}"
                            onchange="updatePayerField(${payer.id}, 'phone', this.value)"
                            class="w-full px-2 py-1.5 border border-gray-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-purple-500 mt-2"
                        />
                    </div>
                    
                    <!-- Amount/Percentage -->
                    <div class="flex items-center gap-2 pt-2 border-t border-gray-200">
                        <label class="text-xs text-gray-600">Amount:</label>
                        <input 
                            type="number" 
                            placeholder="${inputPlaceholder}"
                            value="${payer.value}"
                            onchange="updatePayerField(${payer.id}, 'value', parseFloat(this.value) || 0)"
                            min="0"
                            step="${splitMethod === 'percentage' ? '1' : '0.01'}"
                            ${splitMethod === 'percentage' ? 'max="100"' : ''}
                            class="flex-1 px-2 py-1.5 border border-gray-300 rounded text-sm text-right focus:outline-none focus:ring-2 focus:ring-purple-500"
                        />
                        <span class="text-sm font-medium text-gray-600 w-6">${inputLabel}</span>
                    </div>
                </div>
            `;

            return div;
        }

        function selectContact(payerId, contactId) {
            if (contactId === 'new') {
                // Clear fields for new contact
                updatePayerField(payerId, 'name', '');
                updatePayerField(payerId, 'email', '');
                updatePayerField(payerId, 'phone', '');
                return;
            }

            if (contactId === '') {
                // No selection
                return;
            }

            let contact = null;

            if (contactId === 'primary') {
                contact = {
                    name: state.selectedCustomer.name,
                    email: state.selectedCustomer.email,
                    phone: state.selectedCustomer.phone
                };
            } else if (contactId.startsWith('secondary-')) {
                const index = parseInt(contactId.split('-')[1]);
                contact = state.selectedCustomer.secondaryContacts[index];
            }

            if (contact) {
                // Populate fields with contact data
                updatePayerField(payerId, 'name', contact.name);
                updatePayerField(payerId, 'email', contact.email);
                updatePayerField(payerId, 'phone', contact.phone || '');

                // Update the input fields visually
                const manualFields = document.getElementById(`manualFields-${payerId}`);
                if (manualFields) {
                    manualFields.querySelector('input[type="text"]').value = contact.name;
                    manualFields.querySelector('input[type="email"]').value = contact.email;
                    manualFields.querySelector('input[type="tel"]').value = contact.phone || '';
                }
            }
        }

        function updatePayerField(payerId, field, value) {
            const payer = payers.find(p => p.id === payerId);
            if (payer) {
                payer[field] = value;
                updateSplitSummary();
            }
        }

        function updateSplitSummary() {
            // Get total quote amount
            const totalAmount = calculateTotal();

            // Calculate allocated amount
            let allocatedAmount = 0;
            if (splitMethod === 'percentage') {
                const totalPercentage = payers.reduce((sum, p) => sum + (parseFloat(p.value) || 0), 0);
                allocatedAmount = (totalPercentage / 100) * totalAmount;
            } else {
                allocatedAmount = payers.reduce((sum, p) => sum + (parseFloat(p.value) || 0), 0);
            }

            const remainingAmount = totalAmount - allocatedAmount;

            // Update UI
            document.getElementById('splitTotalAmount').textContent = `$${totalAmount.toFixed(2)}`;
            document.getElementById('splitAllocatedAmount').textContent = `$${allocatedAmount.toFixed(2)}`;
            document.getElementById('splitRemainingAmount').textContent = `$${remainingAmount.toFixed(2)}`;

            // Show/hide validation warning
            const warningDiv = document.getElementById('splitValidationWarning');
            const warningMessage = document.getElementById('splitValidationMessage');

            if (Math.abs(remainingAmount) > 0.01) {
                warningDiv.classList.remove('hidden');
                if (remainingAmount > 0) {
                    warningMessage.textContent = `âš ï¸ Total must equal $${totalAmount.toFixed(2)}. Please allocate the remaining $${remainingAmount.toFixed(2)}.`;
                } else {
                    warningMessage.textContent = `âš ï¸ Total must equal $${totalAmount.toFixed(2)}. You've exceeded by $${Math.abs(remainingAmount).toFixed(2)}.`;
                }
            } else {
                warningDiv.classList.add('hidden');
            }

            // Update remaining amount color
            const remainingSpan = document.getElementById('splitRemainingAmount');
            if (Math.abs(remainingAmount) < 0.01) {
                remainingSpan.classList.remove('text-red-600');
                remainingSpan.classList.add('text-green-600');
            } else {
                remainingSpan.classList.remove('text-green-600');
                remainingSpan.classList.add('text-red-600');
            }
        }

        function isSplitAmountValid() {
            if (!splitInvoiceEnabled || payers.length === 0) {
                return true;
            }

            const totalAmount = calculateTotal();
            let allocatedAmount = 0;

            if (splitMethod === 'percentage') {
                const totalPercentage = payers.reduce((sum, p) => sum + (parseFloat(p.value) || 0), 0);
                allocatedAmount = (totalPercentage / 100) * totalAmount;
            } else {
                allocatedAmount = payers.reduce((sum, p) => sum + (parseFloat(p.value) || 0), 0);
            }

            // Check if amounts match (with small tolerance for rounding)
            return Math.abs(totalAmount - allocatedAmount) < 0.01;
        }

        // ============================================================================
        // INVOICE DISTRIBUTION FUNCTIONALITY
        // ============================================================================

        // Store payers data (quote-level configuration, independent of invoices)
        let quotePayers = [
            {
                id: 'primary',
                name: 'Primary Contact',
                email: 'contact@company.com',
                percentage: 100,
                amount: 0, // Will be calculated based on total
                isPrimary: true,
                createdAt: new Date().toISOString()
            }
        ];

        // Keep distributionPayers as alias for backward compatibility during migration
        let distributionPayers = quotePayers;

        // Available contacts for selection
        const availableContacts = {
            'contact1': { name: 'John Smith', email: 'john@company.com' },
            'contact2': { name: 'Sarah Johnson', email: 'sarah@business.com' },
            'contact3': { name: 'Mike Wilson', email: 'mike@corp.com' }
        };

        // Add selected payer to the table
        function addSelectedPayer() {
            const selector = document.getElementById('contactSelector');
            const selectedValue = selector.value;

            if (!selectedValue) {
                alert('Please select a contact to add');
                return;
            }

            // Handle quick add option
            if (selectedValue === 'quick-add') {
                openQuickAddModal();
                return;
            }

            const contact = availableContacts[selectedValue];
            if (!contact) {
                alert('Invalid contact selected');
                return;
            }

            // Check if contact already exists
            const exists = distributionPayers.find(p => p.email === contact.email);
            if (exists) {
                alert('This contact is already added');
                return;
            }

            // Add new payer
            const newPayer = {
                id: selectedValue,
                name: contact.name,
                email: contact.email,
                percentage: 0,
                amount: 0,
                isPrimary: false
            };

            distributionPayers.push(newPayer);

            // Reset primary contact to share the percentage
            const totalAmount = calculateTotal();
            if (distributionPayers.length === 2) {
                distributionPayers[0].percentage = 50;
                distributionPayers[0].amount = totalAmount * 0.5;
                newPayer.percentage = 50;
                newPayer.amount = totalAmount * 0.5;
            } else {
                // Distribute evenly among all payers
                const evenPercentage = Math.floor(100 / distributionPayers.length);
                distributionPayers.forEach((payer, index) => {
                    payer.percentage = evenPercentage;
                    payer.amount = totalAmount * (evenPercentage / 100);
                });
                // Give remainder to primary
                const remainder = 100 - (evenPercentage * distributionPayers.length);
                distributionPayers[0].percentage += remainder;
                distributionPayers[0].amount = totalAmount * (distributionPayers[0].percentage / 100);
            }

            // Clear selector and refresh table
            selector.value = '';
            renderPayersTable();
            updateDistributionSummary();
        }

        // Remove payer from table
        function removePayer(payerId, isModal = false) {
            if (payerId === 'primary') {
                alert('Cannot remove primary contact');
                return;
            }

            distributionPayers = distributionPayers.filter(p => p.id !== payerId);

            // Redistribute percentages
            if (distributionPayers.length === 1) {
                distributionPayers[0].percentage = 100;
            }

            // Note: Modal payer table removed - payers assigned after invoice creation
            // Only update Payment Configuration tab table
            renderPayersTable();
            updateDistributionSummary();
        }

        // Update payer percentage (and sync amount)
        function updatePayerPercentage(payerId, newPercentage, isModal = false) {
            const payer = distributionPayers.find(p => p.id === payerId);
            if (payer) {
                payer.percentage = parseFloat(newPercentage) || 0;
                // Sync amount based on percentage
                const totalAmount = calculateTotal();
                payer.amount = (totalAmount * payer.percentage / 100);

                // Note: Modal payer table removed - payers assigned after invoice creation
                // Only update Payment Configuration tab table
                renderPayersTable();
                updateDistributionSummary();
            }
        }

        // Update payer amount (and sync percentage)
        function updatePayerAmount(payerId, newAmount, isModal = false) {
            const payer = distributionPayers.find(p => p.id === payerId);
            if (payer) {
                payer.amount = parseFloat(newAmount) || 0;
                // Sync percentage based on amount
                const totalAmount = calculateTotal();
                payer.percentage = totalAmount > 0 ? (payer.amount / totalAmount * 100) : 0;

                // Note: Modal payer table removed - payers assigned after invoice creation
                // Only update Payment Configuration tab table
                renderPayersTable();
                updateDistributionSummary();
            }
        }

        // Add selected payer to modal
        function addSelectedPayerToModal() {
            const selector = document.getElementById('modalContactSelector');
            if (!selector) return;

            const selectedValue = selector.value;
            if (!selectedValue) {
                alert('Please select a contact to add');
                return;
            }

            // Handle quick add option
            if (selectedValue === 'quick-add') {
                openQuickAddModal();
                return;
            }

            const contact = availableContacts[selectedValue];
            if (!contact) {
                alert('Invalid contact selected');
                return;
            }

            // Check if contact already exists
            const exists = distributionPayers.find(p => p.email === contact.email);
            if (exists) {
                alert('This contact is already added');
                return;
            }

            // Add new payer
            const newPayer = {
                id: selectedValue,
                name: contact.name,
                email: contact.email,
                percentage: 0,
                amount: 0,
                isPrimary: false
            };

            distributionPayers.push(newPayer);

            // Reset primary contact to share the percentage
            const totalAmount = calculateTotal();
            if (distributionPayers.length === 2) {
                distributionPayers[0].percentage = 50;
                distributionPayers[0].amount = totalAmount * 0.5;
                newPayer.percentage = 50;
                newPayer.amount = totalAmount * 0.5;
            } else {
                // Distribute evenly among all payers
                const evenPercentage = Math.floor(100 / distributionPayers.length);
                distributionPayers.forEach((payer, index) => {
                    payer.percentage = evenPercentage;
                    payer.amount = totalAmount * (evenPercentage / 100);
                });
                const remainder = 100 - (evenPercentage * distributionPayers.length);
                distributionPayers[0].percentage += remainder;
                distributionPayers[0].amount = totalAmount * (distributionPayers[0].percentage / 100);
            }

            // Clear selector and refresh tables
            selector.value = '';
            renderPayersTable();
            updateDistributionSummary();
            // Note: Modal payer table removed - payers assigned after invoice creation
        }

        // Render the payers table
        function renderPayersTable() {
            const tbody = document.getElementById('payersTableBody');
            if (tbody) {
                tbody.innerHTML = '';
                renderPayersTableToBody(tbody, false);
            }
        }

        // Removed: renderModalPayersTable() - Payer assignment happens after invoice creation, not in preview

        function renderPayersTableToBody(tbody, isModal) {
            distributionPayers.forEach(payer => {
                const totalAmount = calculateTotal();
                const payerAmount = (totalAmount * payer.percentage / 100);

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-4 py-3">
                        <div class="flex items-center">
                            <div class="w-8 h-8 bg-purple-100 rounded-full flex items-center justify-center mr-3">
                                <svg class="w-4 h-4 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                </svg>
                            </div>
                            <div>
                                <div class="text-sm font-medium text-gray-900">${payer.name}</div>
                                <div class="text-xs text-gray-500">${payer.email}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-4 py-3 text-center">
                        <input 
                            type="number" 
                            value="${payer.percentage.toFixed(1)}" 
                            min="0" 
                            max="100" 
                            step="0.1"
                            class="w-16 px-2 py-1 text-center border border-gray-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-purple-500"
                            onchange="updatePayerPercentage('${payer.id}', this.value, ${isModal})"
                        />
                        <span class="text-xs text-gray-500 ml-1">%</span>
                    </td>
                    <td class="px-4 py-3 text-center">
                        <div class="relative">
                            <span class="absolute left-2 top-1.5 text-gray-500 text-sm">$</span>
                            <input 
                                type="number" 
                                value="${payerAmount.toFixed(2)}" 
                                min="0" 
                                step="0.01"
                                class="w-24 pl-6 pr-2 py-1 text-center border border-gray-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-purple-500"
                                onchange="updatePayerAmount('${payer.id}', this.value, ${isModal})"
                            />
                        </div>
                    </td>
                    <td class="px-4 py-3 text-center">
                        ${payer.isPrimary ?
                        '<span class="px-2 py-1 bg-blue-100 text-blue-700 text-xs rounded-full font-medium">Primary</span>' :
                        `<button onclick="removePayer('${payer.id}', ${isModal})" class="text-red-600 hover:text-red-700 text-xs font-medium">Remove</button>`
                    }
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Update distribution summary (for Payment Configuration tab)
        function updateDistributionSummary() {
            const totalPercentage = distributionPayers.reduce((sum, p) => sum + p.percentage, 0);
            const totalAmount = calculateTotal();

            const totalPercentageEl = document.getElementById('totalPercentage');
            const totalAmountEl = document.getElementById('totalAmount');

            if (totalPercentageEl) {
                totalPercentageEl.textContent = `${totalPercentage}%`;
            }
            if (totalAmountEl) {
                totalAmountEl.textContent = `$${totalAmount.toFixed(2)}`;
            }

            // Show/hide validation warning
            const warningDiv = document.getElementById('distributionValidationWarning');
            const warningMessage = document.getElementById('distributionValidationMessage');

            if (warningDiv && warningMessage) {
                if (totalPercentage !== 100) {
                    warningDiv.classList.remove('hidden');
                    if (totalPercentage < 100) {
                        warningMessage.textContent = `Total percentage is ${totalPercentage}%. Please allocate the remaining ${100 - totalPercentage}%.`;
                    } else {
                        warningMessage.textContent = `Total percentage is ${totalPercentage}%. Please reduce by ${totalPercentage - 100}%.`;
                    }
                } else {
                    warningDiv.classList.add('hidden');
                }
            }

            // Update percentage color
            if (totalPercentageEl) {
                if (totalPercentage === 100) {
                    totalPercentageEl.classList.remove('text-red-600');
                    totalPercentageEl.classList.add('text-green-600');
                } else {
                    totalPercentageEl.classList.remove('text-green-600');
                    totalPercentageEl.classList.add('text-red-600');
                }
            }

        }

        // Removed: updateModalDistributionSummary() - Payer assignment happens after invoice creation, not in preview

        // Initialize distribution on page load
        function initializeDistribution() {
            // Set initial amount for primary contact
            const totalAmount = calculateTotal();
            distributionPayers[0].amount = totalAmount;

            renderPayersTable();
            updateDistributionSummary();

            // Add event listener to the Add button
            const addBtn = document.getElementById('addSelectedPayerBtn');
            if (addBtn) {
                addBtn.addEventListener('click', addSelectedPayer);
            }

            // Initialize quick add modal
            initializeQuickAddModal();
        }

        // ============================================================================
        // QUICK ADD CONTACT MODAL FUNCTIONALITY
        // ============================================================================

        let quickAddContactCounter = 1000; // Start from 1000 to avoid conflicts

        function openQuickAddModal() {
            const modal = document.getElementById('quickAddContactModal');
            modal.classList.remove('hidden');
            // Clear form
            document.getElementById('quickAddContactForm').reset();
            // Focus on name field
            document.getElementById('quickAddName').focus();
        }

        function closeQuickAddModal() {
            const modal = document.getElementById('quickAddContactModal');
            modal.classList.add('hidden');
        }

        function initializeQuickAddModal() {
            // Close button
            document.getElementById('closeQuickAddModal').addEventListener('click', closeQuickAddModal);
            document.getElementById('cancelQuickAdd').addEventListener('click', closeQuickAddModal);

            // Close on background click
            document.getElementById('quickAddContactModal').addEventListener('click', (e) => {
                if (e.target.id === 'quickAddContactModal') {
                    closeQuickAddModal();
                }
            });

            // Form submission
            document.getElementById('quickAddContactForm').addEventListener('submit', (e) => {
                e.preventDefault();
                handleQuickAddSubmit();
            });
        }

        function handleQuickAddSubmit() {
            const name = document.getElementById('quickAddName').value.trim();
            const email = document.getElementById('quickAddEmail').value.trim();
            const phone = document.getElementById('quickAddPhone').value.trim();
            const company = document.getElementById('quickAddCompany').value.trim();
            const role = document.getElementById('quickAddRole').value.trim();

            // Validation
            if (!name || !email) {
                alert('Please fill in the required fields (Name and Email)');
                return;
            }

            // Check if email already exists
            const exists = distributionPayers.find(p => p.email === email);
            if (exists) {
                alert('A contact with this email already exists');
                return;
            }

            // Create new contact ID
            const contactId = `quick-${quickAddContactCounter++}`;

            // Add to available contacts
            availableContacts[contactId] = {
                name: name,
                email: email,
                phone: phone,
                company: company,
                role: role
            };

            // Add to dropdown (before the quick-add option)
            const selector = document.getElementById('contactSelector');
            const quickAddOption = selector.querySelector('option[value="quick-add"]');
            const newOption = document.createElement('option');
            newOption.value = contactId;
            newOption.textContent = `${name} - ${email}`;
            selector.insertBefore(newOption, quickAddOption);

            // Create new payer
            const newPayer = {
                id: contactId,
                name: name,
                email: email,
                phone: phone,
                company: company,
                role: role,
                percentage: 0,
                amount: 0,
                isPrimary: false
            };

            distributionPayers.push(newPayer);

            // Auto-distribute percentages
            const totalAmount = calculateTotal();
            if (distributionPayers.length === 2) {
                distributionPayers[0].percentage = 50;
                distributionPayers[0].amount = totalAmount * 0.5;
                newPayer.percentage = 50;
                newPayer.amount = totalAmount * 0.5;
            } else {
                // Distribute evenly among all payers
                const evenPercentage = Math.floor(100 / distributionPayers.length);
                distributionPayers.forEach((payer, index) => {
                    payer.percentage = evenPercentage;
                    payer.amount = totalAmount * (evenPercentage / 100);
                });
                // Give remainder to primary
                const remainder = 100 - (evenPercentage * distributionPayers.length);
                distributionPayers[0].percentage += remainder;
                distributionPayers[0].amount = totalAmount * (distributionPayers[0].percentage / 100);
            }

            // Update UI
            renderPayersTable();
            updateDistributionSummary();
            closeQuickAddModal();

            // Show success message
            alert(`Contact "${name}" added successfully!`);
        }
    </script>

    <!-- Quick Add Contact Modal -->
    <div id="quickAddContactModal"
        class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-900">Quick Add Contact</h3>
                    <button id="closeQuickAddModal" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>

                <form id="quickAddContactForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Contact Name *</label>
                        <input type="text" id="quickAddName" required
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-purple-500"
                            placeholder="John Doe">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Email *</label>
                        <input type="email" id="quickAddEmail" required
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-purple-500"
                            placeholder="john@example.com">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Phone</label>
                        <input type="tel" id="quickAddPhone"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-purple-500"
                            placeholder="+1 234 567 8900">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Company</label>
                        <input type="text" id="quickAddCompany"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-purple-500"
                            placeholder="ABC Corp">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Role/Relationship</label>
                        <input type="text" id="quickAddRole"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-purple-500"
                            placeholder="e.g., Manager, Partner, Assistant">
                    </div>

                    <div class="flex gap-3 pt-4">
                        <button type="button" id="cancelQuickAdd"
                            class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                            Cancel
                        </button>
                        <button type="submit"
                            class="flex-1 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors">
                            Add Contact
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</body>

</html>