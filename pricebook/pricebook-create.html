<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Pricebook Item - Admin</title>
    <link rel="stylesheet" href="../home-styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .form-container {
            max-width: 900px;
            margin: 0 auto;
            background: #fff;
            border-radius: 8px;
            padding: 24px;
        }

        .form-row {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
        }

        .form-row .form-group {
            flex: 1;
            margin-bottom: 0;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            font-size: 13px;
            font-weight: 500;
            margin-bottom: 6px;
            color: #374151;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 9px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .form-group input:disabled {
            background: #f3f4f6;
            color: #6b7280;
            cursor: not-allowed;
        }

        .price-section {
            display: flex;
            gap: 12px;
            align-items: flex-start;
        }

        .currency-wrapper {
            flex-shrink: 0;
        }

        .currency-select {
            min-width: 80px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            background: #fff;
            padding: 9px 12px;
            font-size: 14px;
            font-weight: 500;
            color: #374151;
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 8px center;
            background-repeat: no-repeat;
            background-size: 16px;
            padding-right: 32px;
        }

        .currency-select:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .price-wrapper {
            flex: 1;
        }

        .price-input {
            width: 100%;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            padding: 9px 12px;
            font-size: 14px;
        }

        .price-input:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .price-input::placeholder {
            color: #9ca3af;
        }

        .form-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            padding-top: 20px;
            border-top: 1px solid #e5e7eb;
            margin-top: 20px;
        }

        .btn-primary,
        .btn-secondary {
            font-family: inherit;
            font-size: 14px;
            border-radius: 6px;
            padding: 10px 20px;
            border: none;
            cursor: pointer;
            font-weight: 500;
        }

        .btn-primary {
            background: #6366f1;
            color: #fff;
        }

        .btn-primary:hover {
            background: #4f46e5;
        }

        .btn-secondary {
            background: #e5e7eb;
            color: #374151;
        }

        .btn-secondary:hover {
            background: #d1d5db;
        }

        .section-title {
            font-size: 16px;
            font-weight: 600;
            margin: 20px 0 12px 0;
            color: #111827;
            padding-bottom: 6px;
            border-bottom: 1px solid #e5e7eb;
        }

        .section-title:first-of-type {
            margin-top: 0;
        }

        .sidebar .nav-item.manage-team-link {
            background: #eef2ff;
            color: #6366f1;
            font-weight: 600;
        }

        .image-upload-section {
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            padding: 12px;
            text-align: center;
            background: #f9fafb;
            cursor: pointer;
            transition: all 0.3s;
            max-width: 200px;
        }

        .image-upload-section:hover {
            border-color: #6366f1;
            background: #f3f4f6;
        }

        .image-upload-section img {
            max-width: 100%;
            max-height: 150px;
            border-radius: 6px;
        }

        .file-input {
            display: none;
        }

        .info-text {
            font-size: 12px;
            color: #6b7280;
            margin-top: 4px;
        }

        .preview-section {
            background: #f9fafb;
            padding: 16px;
            border-radius: 8px;
            margin-top: 16px;
        }

        .preview-section h4 {
            margin: 0 0 12px 0;
            font-size: 15px;
            font-weight: 600;
        }

        .required {
            color: #dc2626;
        }

        /* Toggle Option Styles */
        .toggle-option {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 8px 16px;
            border: 1.5px solid #d1d5db;
            border-radius: 6px;
            background: #fff;
            color: #6b7280;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            user-select: none;
        }

        .toggle-option:hover {
            border-color: #9ca3af;
            background: #f9fafb;
        }

        .toggle-option.active {
            border-color: #6366f1;
            background: #eef2ff;
            color: #6366f1;
            font-weight: 600;
        }

        .toggle-option.active:hover {
            border-color: #4f46e5;
            background: #e0e7ff;
        }

        /* Toggle group spacing */
        .toggle-group {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 6px;
        }
    </style>
</head>

<body>
    <div class="app-container">
        <!-- Sidebar -->
        <nav class="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <i class="fas fa-store"></i>
                    <div class="logo-text-wrapper">
                        <span class="logo-text" id="storeName">My Store</span>
                    </div>
                </div>
            </div>
            <div class="sidebar-nav">
                <div class="nav-section-label">MAIN</div>
                <a href="../home.html" class="nav-item" style="text-decoration: none; color: inherit;"><i
                        class="fas fa-home"></i><span>Home</span></a>
                <a href="../quotes.html" class="nav-item" style="text-decoration: none; color: inherit;"><i
                        class="fas fa-file-contract"></i><span>Quotes</span></a>
                <a href="../tenant_schedule.html" class="nav-item" style="text-decoration: none; color: inherit;"><i
                        class="fas fa-calendar-alt"></i><span>Schedule</span></a>
                <a href="../manage-team/manage-team.html" class="nav-item"
                    style="text-decoration: none; color: inherit;"><i class="fas fa-users"></i><span>Manage
                        team</span></a>
                <a href="pricebook.html" class="nav-item" style="text-decoration: none; color: inherit;"><i
                        class="fas fa-book"></i><span>My pricebook</span></a>
                <a href="../Customer Management/customer-list.html" class="nav-item"
                    style="text-decoration: none; color: inherit;"><i
                        class="fas fa-user-friends"></i><span>Customers</span></a>
                <div class="sidebar-footer">
                    <a href="../manage-team/manage-team-roles.html" class="nav-item"
                        style="text-decoration: none; color: inherit;">
                        <i class="fas fa-shield-alt"></i>
                        <span>Manage roles</span>
                    </a>
                    <div class="nav-item">
                        <i class="fas fa-question-circle"></i>
                        <span>Get Set Up</span>
                    </div>
                    <div class="nav-item">
                        <i class="fas fa-cog"></i>
                        <span>Settings</span>
                    </div>
                </div>
        </nav>
        <!-- Main Content Area -->
        <main class="main-content">
            <header class="top-header">
                <div class="header-left">
                    <h1 class="page-title">Create Pricebook Item</h1>
                    <p class="page-subtitle">Add a new service or product to your pricebook</p>
                </div>
                <div class="header-right">
                    <a href="pricebook.html" style="text-decoration:none;"><button class="btn-secondary"><i
                                class="fas fa-arrow-left"></i> Back to Pricebook</button></a>
                </div>
            </header>
            <div class="content-wrapper">
                <div class="form-container">
                    <form id="pricebookForm">
                        <!-- Basic Information -->
                        <div class="section-title">Basic Information</div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="typeSelect">Type <span class="required">*</span></label>
                                <select id="typeSelect" required>
                                    <option value="">Select Type</option>
                                    <option value="service" selected>Service</option>
                                    <option value="product">Product</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="code">SKU/Code <span class="required">*</span></label>
                                <input type="text" id="code" placeholder="e.g., CLEAN-001, PROD-123" required>
                                <div class="info-text">Unique identifier for this item</div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="name">Name <span class="required">*</span></label>
                            <input type="text" id="name" placeholder="e.g., Standard Home Cleaning" required>
                        </div>

                        <div class="form-group">
                            <label for="description">Description</label>
                            <textarea id="description" rows="3"
                                placeholder="Describe the service or product..."></textarea>
                        </div>

                        <!-- Package Model Section (Services only) -->
                        <div id="packageModelSection" style="display: block;">
                            <div class="section-title">Package Model</div>

                            <div class="form-group">
                                <label>Package Type <span class="required">*</span></label>
                                <div class="toggle-group">
                                    <div class="toggle-option active" data-value="subscription"
                                        onclick="selectPackageModel(this)">
                                        <input type="radio" name="packageModel" id="packageModel_subscription"
                                            value="subscription" checked style="display: none;">
                                        <span>Subscription</span>
                                    </div>
                                    <div class="toggle-option" data-value="course" onclick="selectPackageModel(this)">
                                        <input type="radio" name="packageModel" id="packageModel_course" value="course"
                                            style="display: none;">
                                        <span>Course</span>
                                    </div>
                                </div>
                                <div class="info-text">Choose whether this is a recurring subscription or a fixed-volume
                                    course</div>
                            </div>
                        </div>

                        <!-- Service Configuration (Services only) - MERGED & STREAMLINED -->
                        <div id="serviceFields" style="display: block;">
                            <div class="section-title">Service Configuration</div>

                            <div class="form-group">
                                <label>Service Type <span class="required">*</span></label>
                                <div class="toggle-group">
                                    <div class="toggle-option active" data-value="class"
                                        onclick="selectServiceType(this)">
                                        <input type="radio" name="serviceType" id="serviceType_class" value="class"
                                            checked style="display: none;">
                                        <span>Class</span>
                                    </div>
                                    <div class="toggle-option" data-value="group" onclick="selectServiceType(this)">
                                        <input type="radio" name="serviceType" id="serviceType_group" value="group"
                                            style="display: none;">
                                        <span>Group</span>
                                    </div>
                                    <div class="toggle-option" data-value="one-to-one"
                                        onclick="selectServiceType(this)">
                                        <input type="radio" name="serviceType" id="serviceType_onetoone"
                                            value="one-to-one" style="display: none;">
                                        <span>One-to-One</span>
                                    </div>
                                </div>
                            </div>

                            <div id="subscriptionFrequencyGroup"
                                style="display: block; background: #f8fafc; padding: 16px; border-radius: 8px; border: 1px solid #e2e8f0; margin-bottom: 20px;">
                                <h4 style="margin: 0 0 12px 0; font-size: 14px; color: #475569;">Recurring Frequency
                                </h4>
                                <div class="form-group" style="margin-bottom: 0;">
                                    <label>Session Frequency <span class="required">*</span></label>
                                    <div class="toggle-group">
                                        <div class="toggle-option active" data-value="weekly"
                                            onclick="selectFrequency(this)">
                                            <input type="radio" name="frequency" id="frequency_weekly" value="weekly"
                                                checked style="display: none;">
                                            <span>Weekly</span>
                                        </div>
                                        <div class="toggle-option" data-value="monthly" onclick="selectFrequency(this)">
                                            <input type="radio" name="frequency" id="frequency_monthly" value="monthly"
                                                style="display: none;">
                                            <span>Monthly</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="form-group" style="margin-top: 16px;">
                                    <label for="sessionDurationSubscription">Session Duration (Minutes) <span
                                            class="required">*</span></label>
                                    <input type="number" id="sessionDurationSubscription" min="15" step="15" value="60">
                                    <small id="sessionDurationSubscriptionHelp"
                                        style="display: block; color: #64748b; margin-top: 4px;">60 min (1 hour)</small>
                                </div>
                            </div>

                            <!-- Course Configuration Fields -->
                            <div id="courseConfigGroup"
                                style="display: none; background: #f8fafc; padding: 16px; border-radius: 8px; border: 1px solid #e2e8f0; margin-bottom: 20px;">
                                <h4 style="margin: 0 0 12px 0; font-size: 14px; color: #475569;">Course Schedule</h4>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Course Period</label>
                                        <select id="coursePeriodType" style="background: white;"
                                            onchange="updateCourseLabels()">
                                            <option value="week" selected>Week</option>
                                            <option value="month">Month</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="courseDaysPerPeriod">Days per Week</label>
                                        <input type="number" id="courseDaysPerPeriod" min="1" value="3"
                                            style="background: white;">
                                    </div>
                                    <div class="form-group">
                                        <label for="courseDuration">Duration (Weeks)</label>
                                        <input type="number" id="courseDuration" min="1" value="4"
                                            style="background: white;">
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Total Sessions (Calculated)</label>
                                        <input type="text" id="courseTotalSessions" value="12" disabled
                                            style="background: #e2e8f0; color: #475569; font-weight: 600;">
                                    </div>
                                    <div class="form-group">
                                        <label for="sessionDurationCourse">Session Duration (Minutes) <span
                                                class="required">*</span></label>
                                        <input type="number" id="sessionDurationCourse" min="15" step="15" value="60">
                                        <small id="sessionDurationCourseHelp"
                                            style="display: block; color: #64748b; margin-top: 4px;">60 min (1
                                            hour)</small>
                                    </div>
                                </div>
                            </div>

                            <!-- Service Configuration Fields (for all services) -->
                            <div id="serviceConfigFields" style="display: block;">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="minCapacity">Min Capacity <span class="required">*</span></label>
                                        <input type="number" id="minCapacity" min="1" value="1">
                                    </div>

                                    <div class="form-group">
                                        <label for="maxCapacity">Max Capacity <span class="required">*</span></label>
                                        <input type="number" id="maxCapacity" min="1" value="20">
                                    </div>



                                    <div class="form-group" style="max-width: 150px;">
                                        <label for="minStaffCount">Min Staff <span class="required">*</span></label>
                                        <input type="number" id="minStaffCount" min="1" value="1">
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label>Required Skills <span class="required">*</span></label>
                                    <input type="text" id="skillInput" placeholder="Type skill and press Enter"
                                        style="margin-bottom: 8px;">
                                    <div id="requiredSkillsContainer"
                                        style="display: flex; flex-wrap: wrap; gap: 8px; min-height: 32px; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; background: #f9fafb;">
                                        <!-- Skill tags will appear here -->
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label for="equipmentNeeded">Equipment Needed</label>
                                    <input type="text" id="equipmentNeeded"
                                        placeholder="e.g., Whiteboard, Projector, Calculators">
                                    <div class="info-text">Comma-separated list (optional)</div>
                                </div>
                            </div>
                        </div>

                        <!-- Product-Specific Fields -->
                        <div id="productFields" style="display: none;">
                            <div class="section-title">Product Details</div>

                            <div class="info-text"
                                style="background: #f0f9ff; padding: 12px; border-radius: 6px; border-left: 3px solid #3b82f6; margin-bottom: 16px;">
                                <i class="fas fa-info-circle" style="color: #3b82f6;"></i> Products are always
                                non-subscription items
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="productMOQ">MOQ (Minimum Order Quantity)</label>
                                    <input type="number" id="productMOQ" placeholder="1" min="0" step="0.5">
                                </div>
                                <div class="form-group">
                                    <label for="productUnit">Unit</label>
                                    <select id="productUnit">
                                        <option value="each">Each</option>
                                        <option value="piece">Piece</option>
                                        <option value="box">Box</option>
                                        <option value="kg">Kg</option>
                                        <option value="lb">Lb</option>
                                        <option value="liter">Liter</option>
                                        <option value="gallon">Gallon</option>
                                        <option value="custom">Add Custom Unit</option>
                                    </select>
                                </div>
                            </div>

                            <div class="form-group" id="productCustomUnitGroup" style="display: none;">
                                <label for="productCustomUnit">Custom Unit <span class="required">*</span></label>
                                <input type="text" id="productCustomUnit" placeholder="e.g., set, pair, case"
                                    style="text-transform: lowercase;">
                                <div class="info-text">Enter a custom unit name</div>
                            </div>
                        </div>

                        <!-- RECURRENCE SECTION REMOVED - Logic moved to Course Config Group -->



                        <!-- Pricing -->
                        <div class="section-title">Pricing</div>

                        <!-- MOQ & Unit (for non-subscription services) -->
                        <div id="moqUnitSection" style="display: none;">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="moq" id="moqLabel">MOQ (Minimum Order Quantity)</label>
                                    <input type="number" id="moq" placeholder="1" min="0" step="0.5">
                                </div>
                                <div class="form-group">
                                    <label for="unit">Unit</label>
                                    <select id="unit">
                                        <option value="hour">Hour</option>
                                        <option value="each">Each</option>
                                        <option value="sqft">Square Foot</option>
                                        <option value="sqm">Square Meter</option>
                                        <option value="custom">Add Custom Unit</option>
                                    </select>
                                </div>
                            </div>



                            <div class="form-group" id="serviceCustomUnitGroup" style="display: none;">
                                <label for="serviceCustomUnit">Custom Unit <span class="required">*</span></label>
                                <input type="text" id="serviceCustomUnit" placeholder="e.g., kg, liter, piece"
                                    style="text-transform: lowercase;">
                                <div class="info-text">Enter a custom unit name</div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="price" id="priceLabel">Price (per hour) <span class="required">*</span></label>
                            <div class="price-section">
                                <div class="currency-wrapper">
                                    <select id="currency" class="currency-select">
                                        <option value="AUD" selected>AUD</option>
                                        <option value="USD">USD</option>
                                        <option value="EUR">EUR</option>
                                        <option value="GBP">GBP</option>
                                        <option value="NZD">NZD</option>
                                    </select>
                                </div>
                                <div class="price-wrapper">
                                    <input type="number" id="price" class="price-input" step="0.01" min="0"
                                        placeholder="0.00" required>
                                </div>
                            </div>
                            <div class="info-text" id="priceInfo">Price will be calculated per hour</div>
                            <div id="calculatedCoursePriceLabel"
                                style="margin-top: 8px; font-weight: 600; color: #6366f1; display: none;"></div>
                        </div>

                        <div class="form-group">
                            <label for="tax">Tax Category (Australia) <span class="required">*</span></label>
                            <select id="tax" required>
                                <option value="">Select Tax Category</option>
                                <option value="taxable_gst">Taxable — GST applies (standard 10%)</option>
                                <option value="gst_free">GST-free — 0% (e.g., some health, basic food)</option>
                                <option value="input_taxed">Input-taxed — no GST charged but special reporting</option>
                            </select>
                        </div>



                        <!-- Preview Section -->
                        <div class="preview-section">
                            <h4>Preview</h4>
                            <div style="display: flex; gap: 16px; align-items: flex-start; margin-bottom: 16px;">
                                <div>
                                    <label
                                        style="display: block; font-size: 14px; font-weight: 500; margin-bottom: 6px; color: #374151;">Item
                                        Image</label>
                                    <div class="image-upload-section" id="imageUploadArea">
                                        <div id="imagePlaceholder">
                                            <i class="fas fa-image"
                                                style="font-size: 32px; color: #9ca3af; margin-bottom: 8px;"></i>
                                            <p style="color: #6b7280; margin: 0; font-size: 11px;">Click to upload</p>
                                            <p style="font-size: 10px; color: #9ca3af; margin: 4px 0 0 0;">PNG, JPG</p>
                                        </div>
                                        <img id="previewImage" src=""
                                            style="display: none; width: 100%; max-height: 150px; border-radius: 6px; object-fit: cover;"
                                            alt="Preview">
                                    </div>
                                    <input type="file" id="imageInput" class="file-input" accept="image/*">
                                    <div class="info-text">Optional</div>
                                </div>
                                <div style="flex: 1;">
                                    <div id="previewContent">
                                        <p style="color: #6b7280; margin: 0;">Start filling the form to see preview</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Form Actions -->
                        <div class="form-actions">
                            <button type="button" class="btn-secondary"
                                onclick="window.location.href='pricebook.html'">Cancel</button>
                            <button type="button" class="btn-secondary" id="saveDraftBtn">Save as Draft</button>
                            <button type="submit" class="btn-primary">Create Item</button>
                        </div>
                    </form>
                </div>
            </div>
        </main>
    </div>

    <script>
        // ============================================================================
        // COURSE CALCULATION LOGIC
        // ============================================================================
        function calculateCourseTotals() {
            const days = parseFloat(document.getElementById('courseDaysPerPeriod').value) || 0;
            const duration = parseFloat(document.getElementById('courseDuration').value) || 0;
            const totalSessions = days * duration;

            document.getElementById('courseTotalSessions').value = totalSessions;

            // Also trigger price calculation
            calculateCoursePrice();
        }

        function calculateCoursePrice() {
            const packageType = document.querySelector('input[name="packageModel"]:checked')?.value;
            if (packageType === 'course') {
                const pricePerSession = parseFloat(document.getElementById('price').value) || 0;
                const totalSessions = parseFloat(document.getElementById('courseTotalSessions').value) || 0;
                const totalCoursePrice = pricePerSession * totalSessions;

                const label = document.getElementById('calculatedCoursePriceLabel');
                if (label) label.textContent = `Total Course Price: $${totalCoursePrice.toFixed(2)}`;
            }
        }

        // ============================================================================
        // SERVICE CONFIGURATION: Skills Management
        // ============================================================================

        let requiredSkills = [];

        function initializeSkillsInput() {
            const skillInput = document.getElementById('skillInput');
            if (!skillInput) return;

            skillInput.addEventListener('keydown', function (e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const skill = skillInput.value.trim();
                    if (skill && !requiredSkills.includes(skill)) {
                        requiredSkills.push(skill);
                        renderSkillTags();
                        skillInput.value = '';
                    }
                }
            });
        }

        function renderSkillTags() {
            const container = document.getElementById('requiredSkillsContainer');
            if (!container) return;

            container.innerHTML = requiredSkills.map(skill => `
                <div style="display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px; background: #6366f1; color: white; border-radius: 16px; font-size: 13px;">
                    <span>${skill}</span>
                    <button type="button" onclick="removeSkill('${skill}')" style="background: none; border: none; color: white; cursor: pointer; font-size: 16px; line-height: 1; padding: 0;">×</button>
                </div>
            `).join('');
        }

        function removeSkill(skill) {
            requiredSkills = requiredSkills.filter(s => s !== skill);
            renderSkillTags();
        }

        // ============================================================================
        // EXISTING CODE: Radio button selection functions (single-select)
        // ============================================================================

        function selectPackageModel(element) {
            // Remove active from all package model options
            document.querySelectorAll('[name="packageModel"]').forEach(el => {
                el.closest('.toggle-option').classList.remove('active');
                el.checked = false;
            });

            // Set active on clicked element
            element.classList.add('active');
            const radio = element.querySelector('input[type="radio"]');
            radio.checked = true;

            // Update UI based on selection
            updatePackageModelUI();
            updatePreview();
        }

        function selectServiceType(element) {
            // Remove active from all service type options
            document.querySelectorAll('[name="serviceType"]').forEach(el => {
                el.closest('.toggle-option').classList.remove('active');
                el.checked = false;
            });

            // Set active on clicked element
            element.classList.add('active');
            const radio = element.querySelector('input[type="radio"]');
            radio.checked = true;

            updatePreview();
        }

        function selectFrequency(element) {
            // Remove active from all frequency options
            document.querySelectorAll('[name="frequency"]').forEach(el => {
                el.closest('.toggle-option').classList.remove('active');
                el.checked = false;
            });

            // Set active on clicked element
            element.classList.add('active');
            const radio = element.querySelector('input[type="radio"]');
            radio.checked = true;

            updatePreview();
        }

        function selectCommitmentType(element) {
            // Remove active from all commitment type options
            document.querySelectorAll('[name="commitmentType"]').forEach(el => {
                el.closest('.toggle-option').classList.remove('active');
                el.checked = false;
            });

            // Set active on clicked element
            element.classList.add('active');
            const radio = element.querySelector('input[type="radio"]');
            radio.checked = true;

            // Update UI
            const isCourse = radio.value === 'course';
            const termFields = document.getElementById('termBasedFields');
            const courseFields = document.getElementById('courseBasedFields');

            if (isCourse) {
                termFields.style.display = 'none';
                courseFields.style.display = 'flex';
            } else {
                termFields.style.display = 'flex';
                courseFields.style.display = 'none';
            }
        }

        function updatePackageModelUI() {
            const subscriptionRadio = document.getElementById('packageModel_subscription'); // Default
            const courseRadio = document.getElementById('packageModel_course');

            const frequencyGroup = document.getElementById('subscriptionFrequencyGroup');
            const courseConfigGroup = document.getElementById('courseConfigGroup');
            const unitSelect = document.getElementById('unit');
            const priceLabel = document.getElementById('priceLabel');
            const priceInfo = document.getElementById('priceInfo');
            const calculatedCoursePriceLabel = document.getElementById('calculatedCoursePriceLabel');

            // Service configuration fields are always shown for services
            const moqUnitSection = document.getElementById('moqUnitSection');

            if (courseRadio && courseRadio.checked) {
                // Course mode
                frequencyGroup.style.display = 'none';
                courseConfigGroup.style.display = 'block';

                // Unlock unit? No, typically courses are "per session" or "per course"
                if (unitSelect) {
                    unitSelect.value = 'each'; // Or keep it simple
                }

                priceLabel.innerHTML = 'Price (per session) <span class="required">*</span>';
                priceInfo.textContent = 'Enter the price for a single session.';
                if (calculatedCoursePriceLabel) calculatedCoursePriceLabel.style.display = 'block';

                if (moqUnitSection) moqUnitSection.style.display = 'none';

                // Initial calculation
                calculateCourseTotals();
                updateCourseLabels(); // Initialize labels
            } else {
                // Subscription mode (Default)
                frequencyGroup.style.display = 'block';
                courseConfigGroup.style.display = 'none';

                priceLabel.innerHTML = 'Price (per hour) <span class="required">*</span>';
                priceInfo.textContent = 'Price will be calculated per hour';
                if (calculatedCoursePriceLabel) calculatedCoursePriceLabel.style.display = 'none';
                if (moqUnitSection) moqUnitSection.style.display = 'none';
            }
        }

        function updateCourseLabels() {
            const periodType = document.getElementById('coursePeriodType').value;
            const daysLabel = document.querySelector('label[for="courseDaysPerPeriod"]');
            const durationLabel = document.querySelector('label[for="courseDuration"]');

            if (periodType === 'week') {
                if (daysLabel) daysLabel.textContent = 'Days per Week';
                if (durationLabel) durationLabel.textContent = 'Duration (Weeks)';
            } else if (periodType === 'month') {
                if (daysLabel) daysLabel.textContent = 'Days per Month';
                if (durationLabel) durationLabel.textContent = 'Duration (Months)';
            }

            // Recalculate totals as the meaning of duration might have changed conceptually
            calculateCourseTotals();
        }

        function updateDurationHelperText(inputId, helpId) {
            const input = document.getElementById(inputId);
            const helpText = document.getElementById(helpId);
            if (!input || !helpText) return;

            const minutes = parseFloat(input.value) || 0;
            const hours = (minutes / 60).toFixed(2);

            helpText.textContent = `${hours} hours`;
        }

        // Add event listeners for session duration
        document.getElementById('sessionDurationSubscription')?.addEventListener('input', () => updateDurationHelperText('sessionDurationSubscription', 'sessionDurationSubscriptionHelp'));
        document.getElementById('sessionDurationCourse')?.addEventListener('input', () => updateDurationHelperText('sessionDurationCourse', 'sessionDurationCourseHelp'));

        // Global updatePreview function (needs to be accessible from event handlers)
        function updatePreview() {
            const nameInput = document.getElementById('name');
            const codeInput = document.getElementById('code');
            const currencySelect = document.getElementById('currency');
            const priceInput = document.getElementById('price');
            const descriptionInput = document.getElementById('description');
            const typeSelect = document.getElementById('typeSelect');
            const previewContent = document.getElementById('previewContent');

            if (!nameInput || !previewContent) return;

            const name = nameInput.value || '[Item Name]';
            const code = codeInput.value || '[SKU/Code]';
            const currency = currencySelect.value;
            const price = priceInput.value ? `${Number(priceInput.value).toFixed(2)}` : '0.00';
            const displayPrice = `${currency} ${price}`;
            const description = descriptionInput.value || '[Description]';
            const type = typeSelect.value || 'item';

            // Get MOQ and unit
            let moq, unit, moqDisplay = '';
            if (type === 'service') {
                moq = document.getElementById('moq')?.value || '';
                const unitSelect = document.getElementById('unit');
                const customUnit = document.getElementById('serviceCustomUnit')?.value;
                unit = unitSelect?.value === 'custom' && customUnit ? customUnit : unitSelect?.value || 'hour';

                // Check if subscription
                const subscriptionRadio = document.getElementById('packageModel_subscription');
                if (subscriptionRadio && subscriptionRadio.checked) {
                    // Get selected frequency
                    const selectedFrequency = document.querySelector('[name="frequency"]:checked');
                    const frequency = selectedFrequency ? selectedFrequency.value : 'weekly';
                    moqDisplay = moq ? `MOQ: ${moq} ${unit}/${frequency}` : '';
                } else {
                    moqDisplay = moq ? `MOQ: ${moq} ${unit}` : '';
                }
            } else if (type === 'product') {
                moq = document.getElementById('productMOQ')?.value || '';
                const productUnitSelect = document.getElementById('productUnit');
                const customProductUnit = document.getElementById('productCustomUnit')?.value;
                unit = productUnitSelect?.value === 'custom' && customProductUnit ? customProductUnit : productUnitSelect?.value || 'each';
                moqDisplay = moq ? `MOQ: ${moq} ${unit}` : '';
            }

            // Get service type if applicable
            let serviceTypeDisplay = '';
            if (type === 'service') {
                const selectedServiceType = document.querySelector('[name="serviceType"]:checked');
                if (selectedServiceType) {
                    const serviceTypeValue = selectedServiceType.value;
                    const serviceTypeText = serviceTypeValue === 'one-to-one' ? 'One-to-One' :
                        serviceTypeValue.charAt(0).toUpperCase() + serviceTypeValue.slice(1);
                    serviceTypeDisplay = ` • ${serviceTypeText}`;
                }
            }

            const unitText = type === 'service' ? '/ hour' : type === 'product' ? '/ unit' : '';

            previewContent.innerHTML = `
                <div style="padding:12px;background:#fff;border-radius:6px;">
                    <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:8px;">
                        <div>
                            <div style="font-weight:600;font-size:16px;color:#111827;">${name}</div>
                            <div style="font-size:13px;color:#6b7280;">${code}${type ? ' • ' + (type === 'service' ? 'Service' : type === 'product' ? 'Product' : '') : ''}${serviceTypeDisplay}</div>
                            ${moqDisplay ? `<div style="font-size:12px;color:#8b5cf6;margin-top:4px;font-weight:500;">${moqDisplay}</div>` : ''}
                        </div>
                        <div style="text-align:right;">
                            <div style="font-weight:700;color:#6366f1;font-size:20px;">${displayPrice}</div>
                            <div style="font-size:11px;color:#9ca3af;">${unitText}</div>
                        </div>
                    </div>
                    <div style="color:#6b7280;font-size:14px;line-height:1.5;">${description}</div>
                </div>
            `;
        }

        document.addEventListener('DOMContentLoaded', function () {
            const typeSelect = document.getElementById('typeSelect');
            const serviceFields = document.getElementById('serviceFields');
            const productFields = document.getElementById('productFields');
            const packageModelSection = document.getElementById('packageModelSection');
            const imageUploadArea = document.getElementById('imageUploadArea');
            const imageInput = document.getElementById('imageInput');
            const previewImage = document.getElementById('previewImage');
            const imagePlaceholder = document.getElementById('imagePlaceholder');

            // Initialize new features
            initializeSkillsInput();

            // Initialize package model UI
            updatePackageModelUI();

            // Type selection toggle
            typeSelect.addEventListener('change', function () {
                const priceLabel = document.getElementById('priceLabel');
                const priceInfo = document.getElementById('priceInfo');

                if (typeSelect.value === 'service') {
                    serviceFields.style.display = 'block';
                    productFields.style.display = 'none';
                    packageModelSection.style.display = 'block';
                    toggleServiceSections(true); // Show new service sections
                    updatePackageModelUI();
                } else if (typeSelect.value === 'product') {
                    serviceFields.style.display = 'none';
                    productFields.style.display = 'block';
                    packageModelSection.style.display = 'none';
                    toggleServiceSections(false); // Hide new service sections
                    priceLabel.innerHTML = 'Price (per unit) <span class="required">*</span>';
                    priceInfo.textContent = 'Price will be per unit';
                } else {
                    serviceFields.style.display = 'none';
                    productFields.style.display = 'none';
                    packageModelSection.style.display = 'none';
                    toggleServiceSections(false); // Hide new service sections
                    priceLabel.innerHTML = 'Price <span class="required">*</span>';
                    priceInfo.textContent = 'Enter the price';
                }
                updatePreview();
            });

            // Service unit selection (including custom)
            const unitSelect = document.getElementById('unit');
            const serviceCustomUnitGroup = document.getElementById('serviceCustomUnitGroup');
            const serviceCustomUnitInput = document.getElementById('serviceCustomUnit');

            if (unitSelect) {
                unitSelect.addEventListener('change', function () {
                    if (unitSelect.value === 'custom') {
                        serviceCustomUnitGroup.style.display = 'block';
                        serviceCustomUnitInput.required = true;
                    } else {
                        serviceCustomUnitGroup.style.display = 'none';
                        serviceCustomUnitInput.required = false;
                        serviceCustomUnitInput.value = '';
                    }

                    // Update price label for non-subscription services
                    const subscriptionRadio = document.getElementById('packageModel_subscription');
                    if (!subscriptionRadio || !subscriptionRadio.checked) {
                        updatePackageModelUI();
                    }

                    updatePreview();
                });
            }

            // Product unit selection (including custom)
            const productUnitSelect = document.getElementById('productUnit');
            const productCustomUnitGroup = document.getElementById('productCustomUnitGroup');
            const productCustomUnitInput = document.getElementById('productCustomUnit');

            if (productUnitSelect) {
                productUnitSelect.addEventListener('change', function () {
                    if (productUnitSelect.value === 'custom') {
                        productCustomUnitGroup.style.display = 'block';
                        productCustomUnitInput.required = true;
                    } else {
                        productCustomUnitGroup.style.display = 'none';
                        productCustomUnitInput.required = false;
                        productCustomUnitInput.value = '';
                    }

                    // Update price label
                    const priceLabel = document.getElementById('priceLabel');
                    const priceInfo = document.getElementById('priceInfo');
                    const unit = productUnitSelect.value;
                    const unitText = unit === 'custom' ? 'unit' : unit;
                    priceLabel.innerHTML = `Price (per ${unitText}) <span class="required">*</span>`;
                    priceInfo.textContent = `Price will be per ${unitText}`;

                    updatePreview();
                });
            }

            // Image upload
            imageUploadArea.addEventListener('click', function () {
                imageInput.click();
            });

            imageInput.addEventListener('change', function (e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        previewImage.src = e.target.result;
                        previewImage.style.display = 'block';
                        imagePlaceholder.style.display = 'none';
                        updatePreview();
                    };
                    reader.readAsDataURL(file);
                }
            });

            // Update preview
            // This function is now global, so we don't need to define it here.
            // We just need to ensure the event listeners below correctly call the global one.

            // Add event listeners for preview updates
            document.getElementById('name').addEventListener('input', updatePreview);
            document.getElementById('code').addEventListener('input', updatePreview);
            document.getElementById('price').addEventListener('input', updatePreview);
            document.getElementById('currency').addEventListener('change', updatePreview);
            document.getElementById('description').addEventListener('input', updatePreview);

            // Add listeners for MOQ inputs
            const moqInput = document.getElementById('moq');
            const productMOQInput = document.getElementById('productMOQ');
            if (moqInput) moqInput.addEventListener('input', updatePreview);
            if (productMOQInput) productMOQInput.addEventListener('input', updatePreview);

            // Course Config Event Listeners
            const courseDaysInput = document.getElementById('courseDaysPerPeriod');
            const courseDurationInput = document.getElementById('courseDuration');
            const priceInputCourse = document.getElementById('price');

            if (courseDaysInput) courseDaysInput.addEventListener('input', calculateCourseTotals);
            if (courseDurationInput) courseDurationInput.addEventListener('input', calculateCourseTotals);
            if (priceInputCourse) priceInputCourse.addEventListener('input', calculateCoursePrice);

            // Form submission
            document.getElementById('pricebookForm').addEventListener('submit', function (e) {
                e.preventDefault();

                const formData = collectFormData();
                console.log('Pricebook Item Data:', formData);

                // Save to localStorage
                savePricebookItem(formData);

                alert('Item created successfully!');
                window.location.href = 'pricebook.html';
            });

            // Save draft
            document.getElementById('saveDraftBtn').addEventListener('click', function () {
                const formData = collectFormData();
                formData.status = 'draft';

                console.log('Draft Data:', formData);
                savePricebookItem(formData);

                alert('Draft saved successfully!');
            });
        });

        // ============================================================================
        // DATA COLLECTION & STORAGE
        // ============================================================================

        function collectFormData() {
            const typeSelect = document.getElementById('typeSelect');
            const type = typeSelect.value;

            // Basic fields
            const data = {
                id: Date.now().toString(),
                type: type,
                code: document.getElementById('code').value,
                name: document.getElementById('name').value,
                description: document.getElementById('description').value,
                currency: document.getElementById('currency').value,
                price: parseFloat(document.getElementById('price').value),
                taxCategory: document.getElementById('tax').value,
                status: 'active',
                createdAt: new Date().toISOString()
            };

            // Service-specific fields
            if (type === 'service') {
                const packageModel = document.querySelector('input[name="packageModel"]:checked')?.value || 'non-subscription';
                data.packageModel = packageModel;
                data.serviceType = document.querySelector('input[name="serviceType"]:checked')?.value || 'class';

                if (packageModel === 'subscription') {
                    // Subscription service fields
                    data.sessionFrequency = document.querySelector('input[name="frequency"]:checked')?.value || 'weekly';
                    data.capacity = {
                        minimum: parseInt(document.getElementById('minCapacity')?.value || 1),
                        maximum: parseInt(document.getElementById('maxCapacity')?.value || 20)
                    };
                    data.sessionDuration = parseInt(document.getElementById('sessionDuration')?.value || 60);
                    data.minStaffCount = parseInt(document.getElementById('minStaffCount')?.value || 1);
                    data.requiredSkills = typeof requiredSkills !== 'undefined' ? requiredSkills : [];
                    data.equipmentNeeded = document.getElementById('equipmentNeeded')?.value || '';
                    data.unit = 'hour'; // Fixed for subscription
                } else if (packageModel === 'course') {
                    // Course service fields
                    data.unit = 'session';
                    data.courseConfig = {
                        periodType: document.getElementById('coursePeriodType').value,
                        daysPerPeriod: parseInt(document.getElementById('courseDaysPerPeriod').value) || 0,
                        duration: parseInt(document.getElementById('courseDuration').value) || 0,
                        totalSessions: parseInt(document.getElementById('courseTotalSessions').value) || 0
                    };

                    // Common service fields
                    data.capacity = {
                        minimum: parseInt(document.getElementById('minCapacity')?.value || 1),
                        maximum: parseInt(document.getElementById('maxCapacity')?.value || 20)
                    };

                    // Get session duration based on package model
                    if (packageModel === 'course') {
                        data.sessionDuration = parseInt(document.getElementById('sessionDurationCourse')?.value || 60);
                    } else {
                        data.sessionDuration = parseInt(document.getElementById('sessionDurationSubscription')?.value || 60);
                    }

                    data.minStaffCount = parseInt(document.getElementById('minStaffCount')?.value || 1);
                    data.requiredSkills = typeof requiredSkills !== 'undefined' ? requiredSkills : [];
                    data.equipmentNeeded = document.getElementById('equipmentNeeded')?.value || '';
                }
            }
            // Product-specific fields
            else if (type === 'product') {
                data.moq = parseFloat(document.getElementById('productMOQ')?.value || 1);
                const productUnitSelect = document.getElementById('productUnit');
                const productCustomUnit = document.getElementById('productCustomUnit')?.value;
                data.unit = productUnitSelect?.value === 'custom' && productCustomUnit ? productCustomUnit : productUnitSelect?.value || 'each';
            }

            return data;
        }

        function savePricebookItem(itemData) {
            // Get existing pricebook items
            let pricebookItems = JSON.parse(localStorage.getItem('pricebookItems') || '[]');

            // Check if updating existing item
            const existingIndex = pricebookItems.findIndex(item => item.id === itemData.id);

            if (existingIndex >= 0) {
                // Update existing
                pricebookItems[existingIndex] = itemData;
            } else {
                // Add new
                pricebookItems.push(itemData);
            }

            // Save back to localStorage
            localStorage.setItem('pricebookItems', JSON.stringify(pricebookItems));

            return itemData;
        }
    </script>
</body>

</html>