<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Pricebook Item - Admin</title>
    <link rel="stylesheet" href="../home-styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .form-container {
            max-width: 900px;
            margin: 0 auto;
            background: #fff;
            border-radius: 8px;
            padding: 24px;
        }

        .form-row {
            display: flex;
            gap: 16px;
            margin-bottom: 20px;
        }

        .form-row .form-group {
            flex: 1;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 6px;
            color: #374151;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 15px;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .form-group input:disabled {
            background: #f3f4f6;
            color: #6b7280;
            cursor: not-allowed;
        }

        .price-section {
            display: flex;
            gap: 12px;
            align-items: flex-start;
        }

        .currency-wrapper {
            flex-shrink: 0;
        }

        .currency-select {
            min-width: 80px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            background: #fff;
            padding: 10px 12px;
            font-size: 14px;
            font-weight: 500;
            color: #374151;
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 8px center;
            background-repeat: no-repeat;
            background-size: 16px;
            padding-right: 32px;
        }

        .currency-select:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .price-wrapper {
            flex: 1;
        }

        .price-input {
            width: 100%;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            padding: 10px 16px;
            font-size: 15px;
        }

        .price-input:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .price-input::placeholder {
            color: #9ca3af;
        }

        .form-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            padding-top: 24px;
            border-top: 1px solid #e5e7eb;
            margin-top: 24px;
        }

        .btn-primary,
        .btn-secondary {
            font-family: inherit;
            font-size: 15px;
            border-radius: 6px;
            padding: 10px 20px;
            border: none;
            cursor: pointer;
        }

        .btn-primary {
            background: #6366f1;
            color: #fff;
        }

        .btn-secondary {
            background: #e5e7eb;
            color: #374151;
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            margin: 24px 0 16px 0;
            color: #374151;
            padding-bottom: 8px;
            border-bottom: 2px solid #e5e7eb;
        }

        .sidebar .nav-item.manage-team-link {
            background: #eef2ff;
            color: #6366f1;
            font-weight: 600;
        }

        .image-upload-section {
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            padding: 12px;
            text-align: center;
            background: #f9fafb;
            cursor: pointer;
            transition: all 0.3s;
            max-width: 200px;
        }

        .image-upload-section:hover {
            border-color: #6366f1;
            background: #f3f4f6;
        }

        .image-upload-section img {
            max-width: 100%;
            max-height: 150px;
            border-radius: 6px;
        }

        .file-input {
            display: none;
        }

        .info-text {
            font-size: 12px;
            color: #6b7280;
            margin-top: 4px;
        }

        .preview-section {
            background: #f9fafb;
            padding: 16px;
            border-radius: 8px;
            margin-top: 20px;
        }

        .preview-section h4 {
            margin: 0 0 12px 0;
            font-size: 16px;
            font-weight: 600;
        }

        .required {
            color: #dc2626;
        }

        /* Toggle Option Styles */
        .toggle-option {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 10px 20px;
            border: 2px solid #d1d5db;
            border-radius: 8px;
            background: #fff;
            color: #6b7280;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            user-select: none;
        }

        .toggle-option:hover {
            border-color: #9ca3af;
            background: #f9fafb;
        }

        .toggle-option.active {
            border-color: #6366f1;
            background: #eef2ff;
            color: #6366f1;
            font-weight: 600;
        }

        .toggle-option.active:hover {
            border-color: #4f46e5;
            background: #e0e7ff;
        }
    </style>
</head>

<body>
    <div class="app-container">
        <!-- Sidebar -->
        <nav class="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <i class="fas fa-store"></i>
                    <div class="logo-text-wrapper">
                        <span class="logo-text" id="storeName">My Store</span>
                    </div>
                </div>
            </div>
            <div class="sidebar-nav">
                <div class="nav-section-label">MAIN</div>
                <a href="../home.html" class="nav-item" style="text-decoration: none; color: inherit;"><i
                        class="fas fa-home"></i><span>Home</span></a>
                <a href="../quotes.html" class="nav-item" style="text-decoration: none; color: inherit;"><i
                        class="fas fa-file-contract"></i><span>Quotes</span></a>
                <a href="../tenant_schedule.html" class="nav-item" style="text-decoration: none; color: inherit;"><i
                        class="fas fa-calendar-alt"></i><span>Schedule</span></a>
                <a href="../manage-team/manage-team.html" class="nav-item"
                    style="text-decoration: none; color: inherit;"><i class="fas fa-users"></i><span>Manage
                        team</span></a>
                <a href="pricebook.html" class="nav-item" style="text-decoration: none; color: inherit;"><i
                        class="fas fa-book"></i><span>My pricebook</span></a>
                <a href="../Customer Management/customer-list.html" class="nav-item"
                    style="text-decoration: none; color: inherit;"><i
                        class="fas fa-user-friends"></i><span>Customers</span></a>
                <div class="sidebar-footer">
                    <a href="../manage-team/manage-team-roles.html" class="nav-item"
                        style="text-decoration: none; color: inherit;">
                        <i class="fas fa-shield-alt"></i>
                        <span>Manage roles</span>
                    </a>
                    <div class="nav-item">
                        <i class="fas fa-question-circle"></i>
                        <span>Get Set Up</span>
                    </div>
                    <div class="nav-item">
                        <i class="fas fa-cog"></i>
                        <span>Settings</span>
                    </div>
                </div>
        </nav>
        <!-- Main Content Area -->
        <main class="main-content">
            <header class="top-header">
                <div class="header-left">
                    <h1 class="page-title">Edit Pricebook Item</h1>
                    <p class="page-subtitle">Update an existing service or product</p>
                </div>
                <div class="header-right">
                    <a href="pricebook.html" style="text-decoration:none;"><button class="btn-secondary"><i
                                class="fas fa-arrow-left"></i> Back to Pricebook</button></a>
                </div>
            </header>
            <div class="content-wrapper">
                <div class="form-container">
                    <form id="pricebookForm">
                        <!-- Basic Information -->
                        <div class="section-title">Basic Information</div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="typeSelect">Type <span class="required">*</span></label>
                                <select id="typeSelect" required>
                                    <option value="">Select Type</option>
                                    <option value="service" selected>Service</option>
                                    <option value="product">Product</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="code">SKU/Code <span class="required">*</span></label>
                                <input type="text" id="code" value="CLEAN-001" disabled>
                                <div class="info-text">Unique identifier for this item</div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="name">Name <span class="required">*</span></label>
                            <input type="text" id="name" value="Standard Home Cleaning" required>
                        </div>

                        <div class="form-group">
                            <label for="description">Description</label>
                            <textarea id="description"
                                rows="3">A standard interior cleaning package for homes up to 2,000 sq ft. Includes vacuuming, dusting, mopping, and bathroom cleaning.</textarea>
                        </div>

                        <!-- Package Model Section (Services only) -->
                        <div id="packageModelSection" style="display: block;">
                            <div class="section-title">Package Model</div>

                            <div class="form-group">
                                <label>Package Type <span class="required">*</span></label>
                                <div style="display: flex; gap: 12px; flex-wrap: wrap; margin-top: 8px;">
                                    <div class="toggle-option" data-value="non-subscription"
                                        onclick="selectPackageModel(this)">
                                        <input type="radio" name="packageModel" id="packageModel_nonSubscription"
                                            value="non-subscription" style="display: none;">
                                        <span>Non-Subscription</span>
                                    </div>
                                    <div class="toggle-option active" data-value="subscription"
                                        onclick="selectPackageModel(this)">
                                        <input type="radio" name="packageModel" id="packageModel_subscription"
                                            value="subscription" checked style="display: none;">
                                        <span>Subscription</span>
                                    </div>
                                </div>
                                <div class="info-text">Choose whether this service is subscription-based or one-time
                                    purchase</div>
                            </div>
                        </div>

                        <!-- Service-Specific Fields -->
                        <div id="serviceFields" style="display: block;">
                            <div class="section-title">Service Details</div>

                            <div class="form-group">
                                <label>Service Type <span class="required">*</span></label>
                                <div style="display: flex; gap: 12px; flex-wrap: wrap; margin-top: 8px;">
                                    <div class="toggle-option active" data-value="class"
                                        onclick="selectServiceType(this)">
                                        <input type="radio" name="serviceType" id="serviceType_class" value="class"
                                            checked style="display: none;">
                                        <span>Class</span>
                                    </div>
                                    <div class="toggle-option" data-value="group" onclick="selectServiceType(this)">
                                        <input type="radio" name="serviceType" id="serviceType_group" value="group"
                                            style="display: none;">
                                        <span>Group</span>
                                    </div>
                                    <div class="toggle-option" data-value="one-to-one"
                                        onclick="selectServiceType(this)">
                                        <input type="radio" name="serviceType" id="serviceType_onetoone"
                                            value="one-to-one" style="display: none;">
                                        <span>One-to-One</span>
                                    </div>
                                </div>
                                <div class="info-text">Select the type of service delivery</div>
                            </div>

                            <div class="form-group" id="subscriptionFrequencyGroup" style="display: block;">
                                <label>Session Frequency <span class="required">*</span></label>
                                <div style="display: flex; gap: 12px; flex-wrap: wrap; margin-top: 8px;">
                                    <div class="toggle-option active" data-value="weekly"
                                        onclick="selectFrequency(this)">
                                        <input type="radio" name="frequency" id="frequency_weekly" value="weekly"
                                            checked style="display: none;">
                                        <span>Weekly</span>
                                    </div>
                                    <div class="toggle-option" data-value="monthly" onclick="selectFrequency(this)">
                                        <input type="radio" name="frequency" id="frequency_monthly" value="monthly"
                                            style="display: none;">
                                        <span>Monthly</span>
                                    </div>
                                    <div class="toggle-option" data-value="quarterly" onclick="selectFrequency(this)">
                                        <input type="radio" name="frequency" id="frequency_quarterly" value="quarterly"
                                            style="display: none;">
                                        <span>Quarterly</span>
                                    </div>
                                    <div class="toggle-option" data-value="annually" onclick="selectFrequency(this)">
                                        <input type="radio" name="frequency" id="frequency_annually" value="annually"
                                            style="display: none;">
                                        <span>Annually</span>
                                    </div>
                                </div>
                                <div class="info-text">Select billing frequency for subscription services</div>
                            </div>

                            <!-- Service Configuration Fields (for all services) -->
                            <div id="serviceConfigFields" style="display: block;">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="minCapacity">Min Capacity <span class="required">*</span></label>
                                        <input type="number" id="minCapacity" min="1" value="1">
                                    </div>

                                    <div class="form-group">
                                        <label for="maxCapacity">Max Capacity <span class="required">*</span></label>
                                        <input type="number" id="maxCapacity" min="1" value="20">
                                    </div>

                                    <div class="form-group">
                                        <label for="sessionDuration">Session Duration <span
                                                class="required">*</span></label>
                                        <input type="number" id="sessionDuration" min="15" step="15" value="60">
                                    </div>

                                    <div class="form-group" style="max-width: 150px;">
                                        <label for="minStaffCount">Min Staff <span class="required">*</span></label>
                                        <input type="number" id="minStaffCount" min="1" value="1">
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label>Required Skills <span class="required">*</span></label>
                                    <input type="text" id="skillInput" placeholder="Type skill and press Enter"
                                        style="margin-bottom: 8px;">
                                    <div id="requiredSkillsContainer"
                                        style="display: flex; flex-wrap: wrap; gap: 8px; min-height: 32px; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; background: #f9fafb;">
                                        <!-- Skill tags will appear here -->
                                    </div>
                                </div>

                                <label for="equipmentNeeded">Equipment Needed</label>
                                <input type="text" id="equipmentNeeded"
                                    placeholder="e.g., Whiteboard, Projector, Calculators">
                                <div class="info-text">Comma-separated list (optional)</div>
                            </div>
                        </div>

                        <!-- Recurrence Configuration (for non-subscription services) -->
                        <div id="recurrenceSection" style="display: none;">
                            <div class="section-title">Configure Recurrence</div>
                            <div class="info-text" style="margin-bottom: 16px;">Set up how often this service
                                repeats
                            </div>

                            <!-- Commitment Type Toggle -->
                            <div class="form-group">
                                <label>Commitment Type</label>
                                <div class="toggle-group">
                                    <div class="toggle-option active" data-value="term"
                                        onclick="selectCommitmentType(this)">
                                        <input type="radio" name="commitmentType" id="commitmentType_term" value="term"
                                            checked style="display: none;">
                                        <span>Term-based (Fixed Occurrences)</span>
                                    </div>
                                    <div class="toggle-option" data-value="course" onclick="selectCommitmentType(this)">
                                        <input type="radio" name="commitmentType" id="commitmentType_course"
                                            value="course" style="display: none;">
                                        <span>Course-based (Total Sessions)</span>
                                    </div>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="recurrenceFrequency">Repeat every</label>
                                    <select id="recurrenceFrequency"
                                        style="padding: 9px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
                                        <option value="week" selected>week</option>
                                        <option value="month">month</option>
                                    </select>
                                    <input type="hidden" id="recurrenceInterval" value="1">
                                </div>

                                <!-- Term-based: Occurrences -->
                                <div id="termBasedFields" style="display: flex; gap: 12px; align-items: center;">
                                    <input type="number" id="recurrenceOccurrences" min="1" value="12"
                                        style="width: 100px; padding: 9px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
                                    <span style="color: #6b7280;">occurrences</span>
                                </div>

                                <!-- Course-based: Total Slots -->
                                <div id="courseBasedFields" style="display: none; gap: 12px; align-items: center;">
                                    <input type="number" id="totalSessionSlots" min="1" value="36"
                                        style="width: 100px; padding: 9px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
                                    <span style="color: #6b7280;">total sessions</span>
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="recurrenceDaysRequired">Required Days</label>
                                <div style="display: flex; gap: 12px; align-items: center;">
                                    <span style="color: #6b7280;" id="recurrenceDaysLabel">day(s) / week</span>
                                </div>
                            </div>
                        </div>

                        <!-- MOQ & Unit (for non-subscription services) -->
                        <div id="moqUnitSection" style="display: none;">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="moq" id="moqLabel">MOQ (Minimum Order Quantity)</label>
                                    <input type="number" id="moq" placeholder="1" min="0" step="0.5">
                                </div>
                                <div class="form-group">
                                    <label for="unit">Unit</label>
                                    <select id="unit">
                                        <option value="hour">Hour</option>
                                        <option value="each">Each</option>
                                        <option value="sqft">Square Foot</option>
                                        <option value="sqm">Square Meter</option>
                                        <option value="custom">Add Custom Unit</option>
                                    </select>
                                </div>
                            </div>

                            <div class="form-group" id="serviceCustomUnitGroup" style="display: none;">
                                <label for="serviceCustomUnit">Custom Unit <span class="required">*</span></label>
                                <input type="text" id="serviceCustomUnit" placeholder="e.g., kg, liter, piece"
                                    style="text-transform: lowercase;">
                                <div class="info-text">Enter a custom unit name</div>
                            </div>
                        </div>


                        <!-- Product-Specific Fields -->
                        <div id="productFields" style="display: none;">
                            <div class="section-title">Product Details</div>

                            <div class="info-text"
                                style="background: #f0f9ff; padding: 12px; border-radius: 6px; border-left: 3px solid #3b82f6; margin-bottom: 16px;">
                                <i class="fas fa-info-circle" style="color: #3b82f6;"></i> Products are always
                                non-subscription items
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="productMOQ">MOQ (Minimum Order Quantity)</label>
                                    <input type="number" id="productMOQ" placeholder="1" min="0" step="0.5">
                                </div>
                                <div class="form-group">
                                    <label for="productUnit">Unit</label>
                                    <select id="productUnit">
                                        <option value="each">Each</option>
                                        <option value="piece">Piece</option>
                                        <option value="box">Box</option>
                                        <option value="kg">Kg</option>
                                        <option value="lb">Lb</option>
                                        <option value="liter">Liter</option>
                                        <option value="gallon">Gallon</option>
                                        <option value="custom">Add Custom Unit</option>
                                    </select>
                                </div>
                            </div>

                            <div class="form-group" id="productCustomUnitGroup" style="display: none;">
                                <label for="productCustomUnit">Custom Unit <span class="required">*</span></label>
                                <input type="text" id="productCustomUnit" placeholder="e.g., set, pair, case"
                                    style="text-transform: lowercase;">
                                <div class="info-text">Enter a custom unit name</div>
                            </div>
                        </div>

                        <!-- Pricing -->
                        <div class="section-title">Pricing</div>

                        <div class="form-group">
                            <label for="price" id="priceLabel">Price (per hour) <span class="required">*</span></label>
                            <div class="price-section">
                                <div class="currency-wrapper">
                                    <select id="currency" class="currency-select">
                                        <option value="AUD" selected>AUD</option>
                                        <option value="USD">USD</option>
                                        <option value="EUR">EUR</option>
                                        <option value="GBP">GBP</option>
                                        <option value="NZD">NZD</option>
                                    </select>
                                </div>
                                <div class="price-wrapper">
                                    <input type="number" id="price" class="price-input" step="0.01" value="79.00"
                                        min="0" placeholder="0.00" required>
                                </div>
                            </div>
                            <div class="info-text" id="priceInfo">Price will be calculated per hour</div>
                        </div>

                        <div class="form-group">
                            <label for="tax">Tax Category (Australia) <span class="required">*</span></label>
                            <select id="tax" required>
                                <option value="">Select Tax Category</option>
                                <option value="taxable_gst" selected>Taxable — GST applies (standard 10%)</option>
                                <option value="gst_free">GST-free — 0% (e.g., some health, basic food)</option>
                                <option value="input_taxed">Input-taxed — no GST charged but special reporting
                                </option>
                            </select>
                        </div>

                        <!-- Preview Section -->
                        <div class="preview-section">
                            <h4>Preview</h4>
                            <div style="display: flex; gap: 16px; align-items: flex-start; margin-bottom: 16px;">
                                <div>
                                    <label
                                        style="display: block; font-size: 14px; font-weight: 500; margin-bottom: 6px; color: #374151;">Item
                                        Image</label>
                                    <div class="image-upload-section" id="imageUploadArea">
                                        <div id="imagePlaceholder" style="display: none;">
                                            <i class="fas fa-image"
                                                style="font-size: 32px; color: #9ca3af; margin-bottom: 8px;"></i>
                                            <p style="color: #6b7280; margin: 0; font-size: 11px;">Click to upload
                                            </p>
                                            <p style="font-size: 10px; color: #9ca3af; margin: 4px 0 0 0;">PNG, JPG
                                            </p>
                                        </div>
                                        <img id="previewImage" src="https://placehold.co/400x250?text=Cleaning+Service"
                                            style="display: block; width: 100%; max-height: 150px; border-radius: 6px; object-fit: cover;"
                                            alt="Preview">
                                    </div>
                                    <input type="file" id="imageInput" class="file-input" accept="image/*">
                                    <div class="info-text">Optional</div>
                                </div>
                                <div style="flex: 1;">
                                    <div id="previewContent">
                                        <p style="color: #6b7280; margin: 0;">Changes will appear in the preview
                                            below
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Form Actions -->
                        <div class="form-actions">
                            <button type="button" class="btn-secondary"
                                onclick="window.location.href='pricebook.html'">Cancel</button>
                            <button type="button" class="btn-secondary" id="saveDraftBtn">Save as Draft</button>
                            <button type="submit" class="btn-primary">Update Item</button>
                        </div>
                    </form>
                </div>
            </div>
        </main>
    </div>

    <script>
        // ============================================================================
        // SERVICE CONFIGURATION: Skills Management
        // ============================================================================

        let requiredSkills = [];

        function initializeSkillsInput() {
            const skillInput = document.getElementById('skillInput');
            if (!skillInput) return;

            skillInput.addEventListener('keydown', function (e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const skill = skillInput.value.trim();
                    if (skill && !requiredSkills.includes(skill)) {
                        requiredSkills.push(skill);
                        renderSkillTags();
                        skillInput.value = '';
                    }
                }
            });
        }

        function renderSkillTags() {
            const container = document.getElementById('requiredSkillsContainer');
            if (!container) return;

            container.innerHTML = requiredSkills.map(skill => `
                <div style="display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px; background: #6366f1; color: white; border-radius: 16px; font-size: 13px;">
                    <span>${skill}</span>
                    <button type="button" onclick="removeSkill('${skill}')" style="background: none; border: none; color: white; cursor: pointer; font-size: 16px; line-height: 1; padding: 0;">×</button>
                </div>
            `).join('');
        }

        function removeSkill(skill) {
            requiredSkills = requiredSkills.filter(s => s !== skill);
            renderSkillTags();
        }

        // ============================================================================
        // Radio button selection functions (single-select)
        // ============================================================================

        function selectPackageModel(element) {
            // Remove active from all package model options
            document.querySelectorAll('[name="packageModel"]').forEach(el => {
                el.closest('.toggle-option').classList.remove('active');
                el.checked = false;
            });

            // Set active on clicked element
            element.classList.add('active');
            const radio = element.querySelector('input[type="radio"]');
            radio.checked = true;

            // Update UI based on selection
            updatePackageModelUI();
            updatePreview();
        }

        function selectServiceType(element) {
            // Remove active from all service type options
            document.querySelectorAll('[name="serviceType"]').forEach(el => {
                el.closest('.toggle-option').classList.remove('active');
                el.checked = false;
            });

            // Set active on clicked element
            element.classList.add('active');
            const radio = element.querySelector('input[type="radio"]');
            radio.checked = true;

            updatePreview();
        }

        function selectFrequency(element) {
            // Remove active from all frequency options
            document.querySelectorAll('[name="frequency"]').forEach(el => {
                el.closest('.toggle-option').classList.remove('active');
                el.checked = false;
            });

            // Set active on clicked element
            element.classList.add('active');
            const radio = element.querySelector('input[type="radio"]');
            radio.checked = true;

            updatePreview();
        }

        function updatePackageModelUI() {
            const subscriptionRadio = document.getElementById('packageModel_subscription');
            const frequencyGroup = document.getElementById('subscriptionFrequencyGroup');
            const unitSelect = document.getElementById('unit');
            const priceLabel = document.getElementById('priceLabel');
            const priceInfo = document.getElementById('priceInfo');

            // Service configuration fields are always shown for services
            const serviceConfigFields = document.getElementById('serviceConfigFields');
            const moqUnitSection = document.getElementById('moqUnitSection');
            const recurrenceSection = document.getElementById('recurrenceSection');

            if (subscriptionRadio && subscriptionRadio.checked) {
                // Subscription mode
                frequencyGroup.style.display = 'block';

                // Lock unit to "hour"
                if (unitSelect) {
                    unitSelect.value = 'hour';
                    unitSelect.disabled = true;
                }

                priceLabel.innerHTML = 'Price (per hour) <span class="required">*</span>';
                priceInfo.textContent = 'Price will be calculated per hour';

                // Hide MOQ/Unit section and recurrence for subscription
                if (moqUnitSection) moqUnitSection.style.display = 'none';
                if (recurrenceSection) recurrenceSection.style.display = 'none';
            } else {
                // Non-subscription mode
                frequencyGroup.style.display = 'none';

                // Enable unit selection
                if (unitSelect) {
                    unitSelect.disabled = false;
                }

                // Update price label based on selected unit
                const unit = unitSelect ? unitSelect.value : 'unit';
                const unitText = unit === 'custom' ? 'unit' : unit;
                priceLabel.innerHTML = `Price (per ${unitText}) <span class="required">*</span>`;
                priceInfo.textContent = `Price will be per ${unitText}`;

                // Show MOQ/Unit section and recurrence for non-subscription
                if (moqUnitSection) moqUnitSection.style.display = 'block';
                if (recurrenceSection) recurrenceSection.style.display = 'block';
            }

            // Service config fields are always visible for services
            if (serviceConfigFields) serviceConfigFields.style.display = 'block';
        }

        // Global updatePreview function (needs to be accessible from event handlers)
        function updatePreview() {
            const nameInput = document.getElementById('name');
            const codeInput = document.getElementById('code');
            const currencySelect = document.getElementById('currency');
            const priceInput = document.getElementById('price');
            const descriptionInput = document.getElementById('description');
            const typeSelect = document.getElementById('typeSelect');
            const previewContent = document.getElementById('previewContent');

            if (!nameInput || !previewContent) return;

            const name = nameInput.value || '[Item Name]';
            const code = codeInput.value || '[SKU/Code]';
            const currency = currencySelect.value;
            const price = priceInput.value ? `${Number(priceInput.value).toFixed(2)}` : '0.00';
            const displayPrice = `${currency} ${price}`;
            const description = descriptionInput.value || '[Description]';
            const type = typeSelect.value || 'service';

            // Get MOQ and unit
            let moq, unit, moqDisplay = '';
            if (type === 'service') {
                moq = document.getElementById('moq')?.value || '';
                const unitSelect = document.getElementById('unit');
                const customUnit = document.getElementById('serviceCustomUnit')?.value;
                unit = unitSelect?.value === 'custom' && customUnit ? customUnit : unitSelect?.value || 'hour';

                // Check if subscription
                const subscriptionRadio = document.getElementById('packageModel_subscription');
                if (subscriptionRadio && subscriptionRadio.checked) {
                    // Get selected frequency
                    const selectedFrequency = document.querySelector('[name="frequency"]:checked');
                    const frequency = selectedFrequency ? selectedFrequency.value : 'weekly';
                    moqDisplay = moq ? `MOQ: ${moq} ${unit}/${frequency}` : '';
                } else {
                    moqDisplay = moq ? `MOQ: ${moq} ${unit}` : '';
                }
            } else if (type === 'product') {
                moq = document.getElementById('productMOQ')?.value || '';
                const productUnitSelect = document.getElementById('productUnit');
                const customProductUnit = document.getElementById('productCustomUnit')?.value;
                unit = productUnitSelect?.value === 'custom' && customProductUnit ? customProductUnit : productUnitSelect?.value || 'each';
                moqDisplay = moq ? `MOQ: ${moq} ${unit}` : '';
            }

            // Get service type if applicable
            let serviceTypeDisplay = '';
            if (type === 'service') {
                const selectedServiceType = document.querySelector('[name="serviceType"]:checked');
                if (selectedServiceType) {
                    const serviceTypeValue = selectedServiceType.value;
                    const serviceTypeText = serviceTypeValue === 'one-to-one' ? 'One-to-One' :
                        serviceTypeValue.charAt(0).toUpperCase() + serviceTypeValue.slice(1);
                    serviceTypeDisplay = ` • ${serviceTypeText}`;
                }
            }

            const unitText = type === 'service' ? '/ hour' : '/ unit';

            previewContent.innerHTML = `
                <div style="padding:12px;background:#fff;border-radius:6px;">
                    <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:8px;">
                        <div>
                            <div style="font-weight:600;font-size:16px;color:#111827;">${name}</div>
                            <div style="font-size:13px;color:#6b7280;">${code} • ${type === 'service' ? 'Service' : 'Product'}${serviceTypeDisplay}</div>
                            ${moqDisplay ? `<div style="font-size:12px;color:#8b5cf6;margin-top:4px;font-weight:500;">${moqDisplay}</div>` : ''}
                        </div>
                        <div style="text-align:right;">
                            <div style="font-weight:700;color:#6366f1;font-size:20px;">${displayPrice}</div>
                            <div style="font-size:11px;color:#9ca3af;">${unitText}</div>
                        </div>
                    </div>
                    <div style="color:#6b7280;font-size:14px;line-height:1.5;">${description}</div>
                </div>
            `;
        }

        document.addEventListener('DOMContentLoaded', function () {
            // CONSTANTS
            const STORAGE_KEY = 'fms_pricebook';

            // DOM ELEMENTS
            const typeSelect = document.getElementById('typeSelect');
            const serviceFields = document.getElementById('serviceFields');
            const productFields = document.getElementById('productFields');
            const packageModelSection = document.getElementById('packageModelSection');
            const imageUploadArea = document.getElementById('imageUploadArea');
            const imageInput = document.getElementById('imageInput');
            const previewImage = document.getElementById('previewImage');
            const imagePlaceholder = document.getElementById('imagePlaceholder');
            const codeInput = document.getElementById('code');
            const nameInput = document.getElementById('name');
            const priceInput = document.getElementById('price');
            const currencySelect = document.getElementById('currency');
            const descriptionInput = document.getElementById('description');

            // Initialize new features
            initializeSkillsInput();

            // Load Data
            loadItemData();

            // Initialize UI state
            updatePackageModelUI(); // ensure UI matches loaded data

            // Type selection toggle
            typeSelect.addEventListener('change', function () {
                const priceLabel = document.getElementById('priceLabel');
                const priceInfo = document.getElementById('priceInfo');

                if (typeSelect.value === 'service') {
                    serviceFields.style.display = 'block';
                    productFields.style.display = 'none';
                    packageModelSection.style.display = 'block';
                    updatePackageModelUI();
                } else if (typeSelect.value === 'product') {
                    serviceFields.style.display = 'none';
                    productFields.style.display = 'block';
                    packageModelSection.style.display = 'none';
                    priceLabel.innerHTML = 'Price (per unit) <span class="required">*</span>';
                    priceInfo.textContent = 'Price will be per unit';
                } else {
                    serviceFields.style.display = 'none';
                    productFields.style.display = 'none';
                    packageModelSection.style.display = 'none';
                    priceLabel.innerHTML = 'Price <span class="required">*</span>';
                    priceInfo.textContent = 'Enter the price';
                }
                updatePreview();
            });

            // Service unit selection (including custom)
            const unitSelect = document.getElementById('unit');
            const serviceCustomUnitGroup = document.getElementById('serviceCustomUnitGroup');
            const serviceCustomUnitInput = document.getElementById('serviceCustomUnit');

            if (unitSelect) {
                unitSelect.addEventListener('change', function () {
                    if (unitSelect.value === 'custom') {
                        serviceCustomUnitGroup.style.display = 'block';
                        serviceCustomUnitInput.required = true;
                    } else {
                        serviceCustomUnitGroup.style.display = 'none';
                        serviceCustomUnitInput.required = false;
                        serviceCustomUnitInput.value = '';
                    }

                    // Update price label for non-subscription services
                    const subscriptionRadio = document.getElementById('packageModel_subscription');
                    if (!subscriptionRadio || !subscriptionRadio.checked) {
                        updatePackageModelUI();
                    }

                    updatePreview();
                });
            }

            // Product unit selection (including custom)
            const productUnitSelect = document.getElementById('productUnit');
            const productCustomUnitGroup = document.getElementById('productCustomUnitGroup');
            const productCustomUnitInput = document.getElementById('productCustomUnit');

            if (productUnitSelect) {
                productUnitSelect.addEventListener('change', function () {
                    if (productUnitSelect.value === 'custom') {
                        productCustomUnitGroup.style.display = 'block';
                        productCustomUnitInput.required = true;
                    } else {
                        productCustomUnitGroup.style.display = 'none';
                        productCustomUnitInput.required = false;
                        productCustomUnitInput.value = '';
                    }

                    // Update price label
                    const priceLabel = document.getElementById('priceLabel');
                    const priceInfo = document.getElementById('priceInfo');
                    const unit = productUnitSelect.value;
                    const unitText = unit === 'custom' ? 'unit' : unit;
                    priceLabel.innerHTML = `Price (per ${unitText}) <span class="required">*</span>`;
                    priceInfo.textContent = `Price will be per ${unitText}`;

                    updatePreview();
                });
            }

            // Image upload
            imageUploadArea.addEventListener('click', function () {
                imageInput.click();
            });

            imageInput.addEventListener('change', function (e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        previewImage.src = e.target.result;
                        previewImage.style.display = 'block';
                        imagePlaceholder.style.display = 'none';
                        updatePreview();
                    };
                    reader.readAsDataURL(file);
                }
            });

            // Add event listeners for preview updates
            document.getElementById('name').addEventListener('input', updatePreview);
            // code is disabled in edit mode
            document.getElementById('price').addEventListener('input', updatePreview);
            document.getElementById('currency').addEventListener('change', updatePreview);
            document.getElementById('description').addEventListener('input', updatePreview);

            // Add listeners for MOQ inputs
            const moqInput = document.getElementById('moq');
            const productMOQInput = document.getElementById('productMOQ');
            if (moqInput) moqInput.addEventListener('input', updatePreview);
            if (productMOQInput) productMOQInput.addEventListener('input', updatePreview);

            // Recurrence Label Update
            const recurrenceFreq = document.getElementById('recurrenceFrequency');
            if (recurrenceFreq) {
                recurrenceFreq.addEventListener('change', function () {
                    const label = document.getElementById('recurrenceDaysLabel');
                    if (label) label.textContent = `day(s) / ${this.value}`;
                });
            }

            // Form submission
            document.getElementById('pricebookForm').addEventListener('submit', function (e) {
                e.preventDefault();
                const formData = collectFormData();
                console.log('Update Data:', formData);

                // Save to localStorage
                savePricebookItem(formData);

                alert('Item updated successfully!');
                window.location.href = 'pricebook.html';
            });

            // Save draft
            document.getElementById('saveDraftBtn').addEventListener('click', function () {
                const formData = collectFormData();
                formData.status = 'draft';
                savePricebookItem(formData);
                alert('Draft saved!');
            });

            // ============================================================================
            // DATA LOADING & SAVING
            // ============================================================================

            function loadItemData() {
                const params = new URLSearchParams(window.location.search);
                const id = params.get('id');

                if (!id) {
                    alert('No item ID provided!');
                    window.location.href = 'pricebook.html';
                    return;
                }

                // Read from localStorage
                let pricebookItems = [];
                try {
                    const raw = localStorage.getItem(STORAGE_KEY);
                    pricebookItems = raw ? JSON.parse(raw) : [];
                } catch (e) {
                    console.error('Error reading pricebook data', e);
                }

                const item = pricebookItems.find(i => i.id === id);
                if (!item) {
                    alert('Item not found!');
                    window.location.href = 'pricebook.html';
                    return;
                }

                // Store ID for update
                document.getElementById('pricebookForm').dataset.itemId = id;

                // Populate Form
                populateForm(item);
                updatePreview();
            }

            function selectCommitmentType(element) {
                // Remove active from all commitment type options
                document.querySelectorAll('[name="commitmentType"]').forEach(el => {
                    el.closest('.toggle-option').classList.remove('active');
                    el.checked = false;
                });

                // Set active on clicked element
                element.classList.add('active');
                const radio = element.querySelector('input[type="radio"]');
                radio.checked = true;

                // Update UI
                const isCourse = radio.value === 'course';
                const termFields = document.getElementById('termBasedFields');
                const courseFields = document.getElementById('courseBasedFields');

                if (isCourse) {
                    termFields.style.display = 'none';
                    courseFields.style.display = 'flex';
                } else {
                    termFields.style.display = 'flex';
                    courseFields.style.display = 'none';
                }
            }

            function populateForm(data) {
                // Basic Fields
                document.getElementById('typeSelect').value = data.type || 'service';
                document.getElementById('code').value = data.code || data.sku || ''; // support both code and sku
                document.getElementById('name').value = data.name || '';
                document.getElementById('description').value = data.description || '';
                document.getElementById('currency').value = data.currency || 'AUD';
                document.getElementById('price').value = data.price || 0;
                document.getElementById('tax').value = data.taxCategory || '';

                // Trigger type change to show correct sections
                document.getElementById('typeSelect').dispatchEvent(new Event('change'));

                if (data.type === 'service') {
                    // Package Model
                    const packageModel = data.packageModel || 'non-subscription';
                    const modelOption = document.querySelector(`.toggle-option[data-value="${packageModel}"]`);
                    if (modelOption) selectPackageModel(modelOption);

                    // Service Type
                    const serviceType = data.serviceType || 'class';
                    const typeOption = document.querySelector(`.toggle-option[data-value="${serviceType}"]`);
                    if (typeOption) selectServiceType(typeOption);

                    // Subscription specific
                    if (packageModel === 'subscription') {
                        const frequency = data.sessionFrequency || 'weekly';
                        const wOption = document.querySelector(`.toggle-option[data-value="${frequency}"]`);
                        if (wOption) selectFrequency(wOption);
                    }
                    // Non-subscription specific
                    else {
                        document.getElementById('moq').value = data.moq || 1;

                        // Handle Unit
                        const unitSelect = document.getElementById('unit');
                        const customUnitInput = document.getElementById('serviceCustomUnit');
                        const knownUnits = Array.from(unitSelect.options).map(o => o.value);

                        if (knownUnits.includes(data.unit)) {
                            unitSelect.value = data.unit;
                            unitSelect.dispatchEvent(new Event('change'));
                        } else {
                            unitSelect.value = 'custom';
                            unitSelect.dispatchEvent(new Event('change'));
                            customUnitInput.value = data.unit || '';
                        }

                        // Recurrence configuration for non-subscription
                        if (data.recurrence) {
                            const recurrenceFreq = document.getElementById('recurrenceFrequency');
                            const recurrenceOccur = document.getElementById('recurrenceOccurrences');
                            const recurrenceDays = document.getElementById('recurrenceDaysRequired');
                            const totalSessionSlots = document.getElementById('totalSessionSlots');

                            if (recurrenceFreq) {
                                recurrenceFreq.value = data.recurrence.frequency || 'week';
                                recurrenceFreq.dispatchEvent(new Event('change')); // Update label
                            }

                            // Handle Commitment Type
                            const commitmentType = data.recurrence.commitmentType || (data.recurrence.totalSessionSlots ? 'course' : 'term');
                            const commitOption = document.querySelector(`.toggle-option input[value="${commitmentType}"]`)?.closest('.toggle-option');
                            if (commitOption) selectCommitmentType(commitOption);

                            if (recurrenceOccur) recurrenceOccur.value = data.recurrence.count || 12;
                            if (totalSessionSlots) totalSessionSlots.value = data.recurrence.totalSessionSlots || 36;
                            if (recurrenceDays) recurrenceDays.value = data.recurrence.daysRequired || 1;
                        }
                    }

                    // Common Service Config
                    if (data.capacity) {
                        document.getElementById('minCapacity').value = data.capacity.minimum || 1;
                        document.getElementById('maxCapacity').value = data.capacity.maximum || 20;
                    }
                    document.getElementById('sessionDuration').value = data.sessionDuration || 60;
                    document.getElementById('minStaffCount').value = data.minStaffCount || 1;
                    document.getElementById('equipmentNeeded').value = data.equipmentNeeded || '';

                    // Skills
                    if (data.requiredSkills && Array.isArray(data.requiredSkills)) {
                        requiredSkills = data.requiredSkills;
                        renderSkillTags();
                    }
                }
                else if (data.type === 'product') {
                    document.getElementById('productMOQ').value = data.moq || 1;

                    // Handle Unit
                    const unitSelect = document.getElementById('productUnit');
                    const customUnitInput = document.getElementById('productCustomUnit');
                    const knownUnits = Array.from(unitSelect.options).map(o => o.value);

                    if (knownUnits.includes(data.unit)) {
                        unitSelect.value = data.unit;
                        unitSelect.dispatchEvent(new Event('change'));
                    } else {
                        unitSelect.value = 'custom';
                        unitSelect.dispatchEvent(new Event('change'));
                        customUnitInput.value = data.unit || '';
                    }
                }
            }

            function collectFormData() {
                const typeSelect = document.getElementById('typeSelect');
                const type = typeSelect.value;
                const id = document.getElementById('pricebookForm').dataset.itemId;

                // Basic fields (same as create, but preserving ID)
                const data = {
                    id: id,
                    type: type,
                    code: document.getElementById('code').value,
                    name: document.getElementById('name').value,
                    description: document.getElementById('description').value,
                    currency: document.getElementById('currency').value,
                    price: parseFloat(document.getElementById('price').value),
                    taxCategory: document.getElementById('tax').value,
                    status: 'active', // or keep existing status if we loaded it? simplifying to active/draft
                    updatedAt: new Date().toISOString()
                };

                // Service-specific fields
                if (type === 'service') {
                    const packageModel = document.querySelector('input[name="packageModel"]:checked')?.value || 'non-subscription';
                    data.packageModel = packageModel;
                    data.serviceType = document.querySelector('input[name="serviceType"]:checked')?.value || 'class';

                    if (packageModel === 'subscription') {
                        // Subscription service fields
                        data.sessionFrequency = document.querySelector('input[name="frequency"]:checked')?.value || 'weekly';
                        data.capacity = {
                            minimum: parseInt(document.getElementById('minCapacity')?.value || 1),
                            maximum: parseInt(document.getElementById('maxCapacity')?.value || 20)
                        };
                        data.sessionDuration = parseInt(document.getElementById('sessionDuration')?.value || 60);
                        data.minStaffCount = parseInt(document.getElementById('minStaffCount')?.value || 1);
                        data.requiredSkills = requiredSkills; // From global variable
                        data.equipmentNeeded = document.getElementById('equipmentNeeded')?.value || '';
                        data.unit = 'hour'; // Fixed for subscription
                    } else {
                        // Non-subscription service fields
                        data.moq = parseFloat(document.getElementById('moq')?.value || 1);
                        const unitSelect = document.getElementById('unit');
                        const customUnit = document.getElementById('serviceCustomUnit')?.value;
                        data.unit = unitSelect?.value === 'custom' && customUnit ? customUnit : unitSelect?.value || 'hour';
                        // Include service config fields for non-subscription too
                        data.capacity = {
                            minimum: parseInt(document.getElementById('minCapacity')?.value || 1),
                            maximum: parseInt(document.getElementById('maxCapacity')?.value || 20)
                        };
                        data.sessionDuration = parseInt(document.getElementById('sessionDuration')?.value || 60);
                        data.minStaffCount = parseInt(document.getElementById('minStaffCount')?.value || 1);
                        data.requiredSkills = requiredSkills;
                        data.equipmentNeeded = document.getElementById('equipmentNeeded')?.value || '';

                        // Recurrence
                        const recurrenceFreq = document.getElementById('recurrenceFrequency');
                        const recurrenceOccur = document.getElementById('recurrenceOccurrences');
                        const recurrenceDays = document.getElementById('recurrenceDaysRequired');
                        const commitmentType = document.querySelector('input[name="commitmentType"]:checked')?.value || 'term';
                        const totalSessionSlots = document.getElementById('totalSessionSlots');

                        if (recurrenceFreq) {
                            data.recurrence = {
                                frequency: recurrenceFreq.value,
                                step: 1, // Defaulting to 1 as per create page
                                count: parseInt(recurrenceOccur?.value) || 12,
                                daysRequired: parseInt(recurrenceDays?.value) || 1,
                                commitmentType: commitmentType,
                                totalSessionSlots: commitmentType === 'course' ? parseInt(totalSessionSlots?.value) : null
                            };
                        }
                    }
                }
                // Product-specific fields
                else if (type === 'product') {
                    data.moq = parseFloat(document.getElementById('productMOQ')?.value || 1);
                    const productUnitSelect = document.getElementById('productUnit');
                    const productCustomUnit = document.getElementById('productCustomUnit')?.value;
                    data.unit = productUnitSelect?.value === 'custom' && productCustomUnit ? productCustomUnit : productUnitSelect?.value || 'each';
                }

                return data;
            }

            function savePricebookItem(itemData) {
                // Get existing pricebook items
                let pricebookItems = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');

                // Check if updating existing item
                const existingIndex = pricebookItems.findIndex(item => item.id === itemData.id);

                if (existingIndex >= 0) {
                    // Update existing, merge to keep any fields we don't touch
                    pricebookItems[existingIndex] = { ...pricebookItems[existingIndex], ...itemData };
                } else {
                    // Fail safe, shouldn't happen in edit
                    pricebookItems.push(itemData);
                }

                // Save back to localStorage
                localStorage.setItem(STORAGE_KEY, JSON.stringify(pricebookItems));
            }

        });
    </script>
</body>

</html>