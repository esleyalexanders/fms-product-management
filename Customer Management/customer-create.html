<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Customer</title>
    <link rel="stylesheet" href="../home-styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      /* Custom scrollbar */
      .custom-scrollbar::-webkit-scrollbar {
        width: 6px;
        height: 6px;
      }
      .custom-scrollbar::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
      }
      .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 10px;
      }
      .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background: #555;
      }
      
      /* Override home-styles.css to allow scrolling */
      .main-content {
        overflow: visible !important;
        overflow-y: auto !important;
        padding: 1.5rem;
      }
    </style>
</head>
<body class="bg-gray-50">
  <div class="app-container">
  <!-- Sidebar (same structure as home.html) -->
  <nav class="sidebar">
      <div class="sidebar-header">
        <div class="logo">
          <i class="fas fa-store"></i>
          <div class="logo-text-wrapper">
            <span class="logo-text" id="storeName">My Store</span>
            <button class="edit-store-btn" title="Edit store name">
              <i class="fas fa-pencil-alt"></i>
            </button>
          </div>
        </div>
      </div>

      <div class="sidebar-nav">
        <div class="nav-section-label">MAIN</div>
        <a href="../home.html" class="nav-item" style="text-decoration: none; color: inherit;"><i class="fas fa-home"></i><span>Home</span></a>
        <a href="../quotes.html" class="nav-item" style="text-decoration: none; color: inherit;"><i class="fas fa-file-contract"></i><span>Quotes</span></a>
        <a href="../tenant_schedule.html" class="nav-item" style="text-decoration: none; color: inherit;"><i class="fas fa-calendar-alt"></i><span>Schedule</span></a>
        <a href="../manage-team/manage-team.html" class="nav-item" style="text-decoration: none; color: inherit;"><i class="fas fa-users"></i><span>Manage team</span></a>
        <a href="../admin/pricebook.html" class="nav-item" style="text-decoration: none; color: inherit;"><i class="fas fa-book"></i><span>My pricebook</span></a>
        <a href="customer-list.html" class="nav-item customers-link" style="text-decoration: none; color: inherit;"><i class="fas fa-user-friends"></i><span>Customers</span></a>
      </div>

      <div class="sidebar-footer">
        <a href="../manage-team/manage-team-roles.html" class="nav-item" style="text-decoration: none; color: inherit;">
          <i class="fas fa-shield-alt"></i>
          <span>Manage roles</span>
        </a>
        <div class="nav-item">
          <i class="fas fa-question-circle"></i>
          <span>Get Set Up</span>
        </div>
        <div class="nav-item">
          <i class="fas fa-cog"></i>
          <span>Settings</span>
        </div>
      </div>
    </nav>

    <main class="main-content">
      <!-- Header -->
      <div class="bg-white rounded-lg shadow-sm p-4 mb-4">
        <div class="flex justify-between items-center">
          <div class="flex items-center gap-3">
            <a href="customer-list.html" class="text-gray-600 hover:text-gray-900">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
              </svg>
            </a>
            <div>
              <h1 class="text-2xl font-bold text-gray-900" id="pageTitle">Create Customer</h1>
              <p class="text-gray-600 text-sm mt-1">Add a new customer to your database</p>
            </div>
          </div>
          <div class="flex gap-2">
            <button id="discardBtn" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
              Discard
            </button>
            <button id="saveBtn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
              Save Customer
            </button>
          </div>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
        <div class="lg:col-span-2 space-y-4">
          <!-- Basic Information -->
          <div class="bg-white rounded-lg shadow-sm p-4">
            <h2 class="text-lg font-semibold text-gray-900 mb-4">Basic Information</h2>
            <div>
              <label for="fullName" class="block text-sm font-medium text-gray-700 mb-1">Full Name *</label>
              <input id="fullName" name="fullName" type="text" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="John Doe" required>
            </div>
          </div>

          <!-- Company -->
          <div class="bg-white rounded-lg shadow-sm p-4">
            <h2 class="text-lg font-semibold text-gray-900 mb-4">Company</h2>
            <div class="space-y-3">
              <div>
                <label for="company" class="block text-sm font-medium text-gray-700 mb-1">Company Name</label>
                <input id="company" type="text" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="ABC Corp">
              </div>
              <div>
                <label for="role" class="block text-sm font-medium text-gray-700 mb-1">Role</label>
                <input id="role" type="text" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., Manager, Owner, Contractor">
              </div>
            </div>
          </div>

          <!-- Contact Information -->
          <div class="bg-white rounded-lg shadow-sm p-4">
            <div class="flex justify-between items-center mb-4">
              <h2 class="text-lg font-semibold text-gray-900">Contact Information</h2>
              <button type="button" id="addSecondaryContactBtn" class="px-3 py-2 border border-blue-600 text-blue-600 text-sm font-medium rounded-lg hover:bg-blue-50 flex items-center gap-2 transition-colors">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                </svg>
                Add Secondary Contact
              </button>
            </div>
            
            <!-- Primary Contact -->
            <div class="space-y-3">
              <div class="text-xs font-medium text-gray-500 uppercase tracking-wide">Primary Contact</div>
              <div>
                <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Email *</label>
                <input id="email" type="email" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="john@example.com" required>
              </div>
              <div>
                <label for="phone" class="block text-sm font-medium text-gray-700 mb-1">Phone *</label>
                <input id="phone" type="text" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="+1 234 567 8900" required>
              </div>
              <div>
                <label for="address" class="block text-sm font-medium text-gray-700 mb-1">Address *</label>
                <input id="address" type="text" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="123 Main St, New York, NY 10001" required>
              </div>
              <div>
                <label for="preferredContactMethod" class="block text-sm font-medium text-gray-700 mb-1">Preferred Contact Method</label>
                <select id="preferredContactMethod" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                  <option value="email">Email</option>
                  <option value="phone">Phone</option>
                  <option value="whatsapp">WhatsApp</option>
                  <option value="none">None</option>
                </select>
              </div>
            </div>

            <!-- Secondary Contacts Container -->
            <div id="secondaryContactsContainer" class="mt-4 space-y-4">
              <!-- Default Secondary Contact -->
              <div class="border-t border-gray-200 pt-4" id="secondary-default">
                <div class="flex justify-between items-center mb-3">
                  <div class="text-xs font-medium text-gray-500 uppercase tracking-wide">Secondary Contact</div>
                  <button type="button" class="text-red-600 text-sm hover:text-red-800 flex items-center gap-1" onclick="window.removeSecondaryContact('secondary-default')">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                    </svg>
                    Remove
                  </button>
                </div>
                <div class="space-y-3">
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Contact Name</label>
                    <input type="text" class="secondary-contact-name w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Contact person name">
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                    <input type="email" class="secondary-contact-email w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="contact@example.com">
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Phone</label>
                    <input type="text" class="secondary-contact-phone w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="+1 234 567 8900">
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Role/Relationship</label>
                    <input type="text" class="secondary-contact-role w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., Spouse, Assistant, Manager">
                  </div>
                </div>
              </div>
            </div>
          </div>


          <!-- Notes -->
          <div class="bg-white rounded-lg shadow-sm p-4">
            <h2 class="text-lg font-semibold text-gray-900 mb-4">Notes</h2>
            <div>
              <label for="notes" class="block text-sm font-medium text-gray-700 mb-1">Additional Notes</label>
              <textarea id="notes" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Additional notes about the customer"></textarea>
            </div>
          </div>
        </div>

        <!-- Right Column - Preview -->
        <div class="space-y-4">
          <div class="bg-white rounded-lg shadow-sm p-4 sticky top-4">
            <h2 class="text-lg font-semibold text-gray-900 mb-4">Customer Preview</h2>
            <div class="space-y-3">
              <div>
                <div class="text-xl font-bold text-gray-900" id="previewName">John Doe</div>
              </div>
              <div class="border-t border-gray-200 pt-3 space-y-2 text-sm">
                <div class="flex justify-between gap-2">
                  <span class="text-gray-600 font-medium">Company:</span>
                  <span class="text-gray-900 text-right" id="previewCompany">ABC Corp</span>
                </div>
                <div class="flex justify-between gap-2">
                  <span class="text-gray-600 font-medium">Role:</span>
                  <span class="text-gray-900 text-right" id="previewRole">—</span>
                </div>
                <div class="flex justify-between gap-2">
                  <span class="text-gray-600 font-medium">Email:</span>
                  <span class="text-gray-900 text-right break-all" id="previewEmail">john@example.com</span>
                </div>
                <div class="flex justify-between gap-2">
                  <span class="text-gray-600 font-medium">Phone:</span>
                  <span class="text-gray-900 text-right" id="previewPhone">+1 234 567 8900</span>
                </div>
                <div class="flex justify-between gap-2">
                  <span class="text-gray-600 font-medium">Contact Method:</span>
                  <span class="text-gray-900 text-right" id="previewContactMethod">Email</span>
                </div>
              </div>
              <div class="border-t border-gray-200 pt-3">
                <div class="text-xs font-medium text-gray-600 mb-1">Address</div>
                <div class="text-sm text-gray-900" id="previewAddress">123 Main St, New York, NY 10001, USA</div>
              </div>
              <div class="border-t border-gray-200 pt-3">
                <div class="text-xs font-medium text-gray-600 mb-1">Notes</div>
                <div class="text-sm text-gray-900" id="previewNotes">Additional notes...</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script src="customers.js"></script>
  <script>
    let editingCustomerId = null;
    let secondaryContactCounter = 0;
    let secondaryContacts = ['secondary-default']; // Track the default form

    // Check for edit param
    const urlParams = new URLSearchParams(window.location.search);
    const editId = urlParams.get('edit');
    if (editId) {
      editingCustomerId = editId;
      document.getElementById('pageTitle').textContent = 'Edit Customer';
      document.querySelector('.text-gray-600.text-sm.mt-1').textContent = 'Update customer information';
    }

    // Secondary Contact Functions
    window.addSecondaryContact = function(data = {}) {
      console.log('Adding secondary contact...', data);
      const contactId = `secondary-${secondaryContactCounter++}`;
      const container = document.getElementById('secondaryContactsContainer');
      
      if (!container) {
        console.error('Secondary contacts container not found!');
        return;
      }
      
      const contactDiv = document.createElement('div');
      contactDiv.className = 'border-t border-gray-200 pt-4';
      contactDiv.id = contactId;
      contactDiv.innerHTML = `
        <div class="flex justify-between items-center mb-3">
          <div class="text-xs font-medium text-gray-500 uppercase tracking-wide">Secondary Contact ${secondaryContactCounter}</div>
          <button type="button" class="text-red-600 text-sm hover:text-red-800 flex items-center gap-1" onclick="removeSecondaryContact('${contactId}')">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
            </svg>
            Remove
          </button>
        </div>
        <div class="space-y-3">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Contact Name</label>
            <input type="text" class="secondary-contact-name w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Contact person name" value="${data.name || ''}">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
            <input type="email" class="secondary-contact-email w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="contact@example.com" value="${data.email || ''}">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Phone</label>
            <input type="text" class="secondary-contact-phone w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="+1 234 567 8900" value="${data.phone || ''}">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Role/Relationship</label>
            <input type="text" class="secondary-contact-role w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., Spouse, Assistant, Manager" value="${data.role || ''}">
          </div>
        </div>
      `;
      
      container.appendChild(contactDiv);
      secondaryContacts.push(contactId);
      console.log('Secondary contact added successfully!', contactId);
    }

    window.removeSecondaryContact = function(contactId) {
      console.log('Removing secondary contact...', contactId);
      const element = document.getElementById(contactId);
      if (element) {
        element.remove();
        secondaryContacts = secondaryContacts.filter(id => id !== contactId);
        console.log('Secondary contact removed!');
      }
    }

    function getSecondaryContactsData() {
      const contacts = [];
      secondaryContacts.forEach(contactId => {
        const element = document.getElementById(contactId);
        if (element) {
          contacts.push({
            name: element.querySelector('.secondary-contact-name').value.trim(),
            email: element.querySelector('.secondary-contact-email').value.trim(),
            phone: element.querySelector('.secondary-contact-phone').value.trim(),
            role: element.querySelector('.secondary-contact-role').value.trim()
          });
        }
      });
      return contacts;
    }

    // Update preview on input
    const fullNameInput = document.getElementById('fullName');
    const companyInput = document.getElementById('company');
    const roleInput = document.getElementById('role');
    const emailInput = document.getElementById('email');
    const phoneInput = document.getElementById('phone');
    const preferredContactMethodSelect = document.getElementById('preferredContactMethod');
    const addressInput = document.getElementById('address');
    const notesTextarea = document.getElementById('notes');

    const previewName = document.getElementById('previewName');
    const previewCompany = document.getElementById('previewCompany');
    const previewRole = document.getElementById('previewRole');
    const previewEmail = document.getElementById('previewEmail');
    const previewPhone = document.getElementById('previewPhone');
    const previewContactMethod = document.getElementById('previewContactMethod');
    const previewAddress = document.getElementById('previewAddress');
    const previewNotes = document.getElementById('previewNotes');

    function updatePreview() {
      previewName.textContent = fullNameInput.value || 'Customer Name';
      previewCompany.textContent = companyInput.value || '—';
      previewRole.textContent = roleInput.value || '—';
      previewEmail.textContent = emailInput.value || '—';
      previewPhone.textContent = phoneInput.value || '—';
      previewContactMethod.textContent = preferredContactMethodSelect.options[preferredContactMethodSelect.selectedIndex].text;
      previewAddress.textContent = addressInput.value || '—';
      previewNotes.textContent = notesTextarea.value || '—';
    }

    [fullNameInput, companyInput, roleInput, emailInput, phoneInput, preferredContactMethodSelect, addressInput, notesTextarea].forEach(el => {
      el.addEventListener('input', updatePreview);
      el.addEventListener('change', updatePreview);
    });

    // Load customer if editing
    if (editingCustomerId) {
      const { customersAPI } = window;
      if (!customersAPI) {
        alert('Error: customersAPI not loaded.');
        window.location.href = 'customer-list.html';
        return;
      }
      const customer = customersAPI.getCustomerById(editingCustomerId);
      if (customer) {
        // Handle legacy firstName/lastName or new fullName
        if (customer.fullName) {
          fullNameInput.value = customer.fullName;
        } else if (customer.firstName || customer.lastName) {
          fullNameInput.value = `${customer.firstName || ''} ${customer.lastName || ''}`.trim();
        }
        companyInput.value = customer.company || '';
        roleInput.value = customer.role || '';
        emailInput.value = customer.email || '';
        phoneInput.value = customer.phone || '';
        preferredContactMethodSelect.value = customer.preferredContactMethod || 'email';
        // Handle legacy address object or new single address field
        if (customer.address && typeof customer.address === 'object') {
          const addressParts = [customer.address.street, customer.address.city, customer.address.state, customer.address.postalCode, customer.address.country].filter(p => p);
          addressInput.value = addressParts.join(', ');
        } else {
          addressInput.value = customer.address || '';
        }
        notesTextarea.value = customer.notes || '';
        
        // Load secondary contacts if they exist
        if (customer.secondaryContacts && Array.isArray(customer.secondaryContacts)) {
          customer.secondaryContacts.forEach(contact => {
            addSecondaryContact(contact);
          });
        }
        
        updatePreview();
      } else {
        alert('Customer not found.');
        window.location.href = 'customer-list.html';
      }
    } else {
      // Initial preview
      updatePreview();
    }

    // Save button
    const saveBtn = document.getElementById('saveBtn');
    saveBtn.addEventListener('click', () => {
      const customerData = {
        fullName: fullNameInput.value.trim(),
        company: companyInput.value.trim(),
        role: roleInput.value.trim(),
        email: emailInput.value.trim(),
        phone: phoneInput.value.trim(),
        address: addressInput.value.trim(),
        preferredContactMethod: preferredContactMethodSelect.value,
        notes: notesTextarea.value.trim(),
        secondaryContacts: getSecondaryContactsData()
      };

      // Basic validation (HTML required handles most, but double-check)
      if (!customerData.fullName || !customerData.email || !customerData.phone || !customerData.address) {
        alert('Please fill in all required fields.');
        return;
      }

      const { customersAPI } = window;
      if (!customersAPI) {
        alert('Error: customersAPI not loaded.');
        return;
      }

      if (editingCustomerId) {
        customersAPI.updateCustomer(editingCustomerId, customerData);
        alert('Customer updated successfully!');
      } else {
        customersAPI.createCustomer(customerData);
        alert('Customer created successfully!');
      }
      window.location.href = 'customer-list.html';
    });

    // Discard button
    const discardBtn = document.getElementById('discardBtn');
    discardBtn.addEventListener('click', () => {
      if (confirm('Discard changes?')) {
        window.location.href = 'customer-list.html';
      }
    });

    // Add event listener for secondary contact button
    const addSecondaryContactBtn = document.getElementById('addSecondaryContactBtn');
    console.log('Secondary contact button:', addSecondaryContactBtn);
    if (addSecondaryContactBtn) {
      addSecondaryContactBtn.addEventListener('click', (e) => {
        e.preventDefault(); // Prevent any default behavior
        console.log('Add secondary contact button clicked!');
        window.addSecondaryContact();
      });
      console.log('Event listener attached successfully!');
    } else {
      console.error('Add secondary contact button not found!');
    }
  </script>
</body>
</html>